/* =====================================================================
 * app.js  髫????髯・闕ｳ讖ｸ・?・?霑壼遜??・?陞｢・?邵?驢搾??譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髴大???・?
 * ===================================================================== */
window.onerror=(m,s,l,c,e)=>{ console.error('JS驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?',m,s,l,c,e); /* 驛｢謨鳴驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?髯???・?・?驍ｵ・?髴域喚?驢搾??・?郢晢??*/ };
// ---- State ----
// 鬯?・??・?・?髯橸???・?・?驛｢譎??郢晢??驛｢・??・?・?鬯?諷戊ｷ晞??: currentTracks 驍ｵ・??・?・? [0]=驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??(髯?髮・・?雎ｬ・?髯具??郢晢??, [1]=髣費???・?・?髯槭???・?髯?・?郢?迺??郢晢??驍ｱ蟶敖蛹・??・?驍ｵ・??・?・?驍ｵ・?郢晢?? 驍ｵ・??・?・?髫???・?・?髯橸??郢晢??
let currentMidi=null,currentTracks=[];let melodyTrackIndex=0,accompTrackIndexes=[];
// 驛｢譎???・?・取刮・?譏ｶ?螢??､驛｢譎｢・?・?驛｢譏ｴ?・? Part1-4 驛｢・?陷・?・?・?隴・隰梧?・・?闔・?隰暦??: buffer,duration,notes,髯?蛹??・?郢晢??驛｢・??・?・?驛｢譏ｴ?・?鬮?・??・?・?鬩穂ｼ夲??・?/髯??陷?・?陷・??郢晢??郢晢??
let melodyParts = Array.from({length:4},()=>({
    buffer:null, duration:0, notes:[],
    origBytes:null, origName:null, origExt:null,
    showNotes:true, playAudio:true
}));
let currentMelodyPart = 0; // 鬩搾???・?・?鬯?・?郢晢???・?・??・?・?鬮?雜｣・?・?驛｢譏???・?郢晢??驛｢譏ｴ?・?
let melodySources = [];     // 髯??陷?・?陷・??髣????・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??BufferSource鬩玲慣・?・?
let trackInstrumentAssign = [];
let audioCtx=null,melodyGain=null,accompGain=null,masterGain=null,compressor=null,limiter=null;
let _keepAliveOsc=null,_keepAliveGain=null; // destination鬨?・??・?・?鬩搾??髣??・・?髯溷桁??・?髯・闕ｳ闌ｨ・?・??・?・?髯?・??・?・?(髣???闕ｳ・?隰?歓??蛹・??・?)
let _keepAliveHiOsc=null,_keepAliveHiGain=null; // destination鬨?・??・?・?鬩搾??髣??・・?髯溷桁??・?髯・闕ｳ闌ｨ・?・??・?・?髯?・??・?・?(鬯?・?闔ｨ諛域狭髮主桁??・?)
let _keepAliveConst=null,_keepAliveConstGain=null; // 驛｢譏ｶ?螢?笙るΔ譎｢・?・?驛｢譎｢・?・?髯??郢晢??郢晢??髯溷桁??・?髯・隲?・・
let audioActivated=false; // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髫?・?陜｣・??・?・?隲帷???菴・dioContext驛｢・?陷?蝓淞蜑ｰ諤・・?・?髯具??隰費???・??驍ｵ・?雋??会ｽ?
let micStream=null,micSource=null,micAnalyser=null,micData=null,analysisTimer=null;
// 鬯?・??・?・?鬩墓ｨ費??譁溽坩・?譎｢・?・?驛｢譏???螟ｲ・?・?騾趣??雎ｬ・?髮・髣??会ｽ?蟶晢??????・?驛｢・?陝ｲ・??・??驍ｵ・?陞｢・?・つ遶丞｣??・?驛｢・??・?・?驛｢・??・?・?驍ｵ・??・?・?驛｢譎??堤?晢??驛｢譏ｶ?螢??・?驍ｵ・??・?・?鬮?・?陋滂ｽ?????/鬮?・??・?・?鬩穂ｼ夲??・?郢晢??郢晢??
let isPitchOnlyMode=false;
// 驛｢譎???・?邵??驛｢・??・?・?鬯?蛹・??・?髫?螢??・? 鬯?蛹・??・?髫?螢?・?螂???・?陋ｹ・?遶擾??驍ｵ・??・?・? deviceId 驍ｵ・??・?・?髣???・つ鬮?蛹・??・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵?蜥擾??譎｢・?・?
let selectedMicDeviceId = null;
let _micDevicesCache = [];
// ---- Modular YIN tracker integration ----
let USE_YIN_TRACKER = true; // set false to fallback to legacy pipeline
let _yinTracker = null;     // instance of window.__PitchModules.YinPitchTracker
let _pitchSmootherMod = null; // instance of window.__PitchModules.PitchSmoother
let _micVoicedRecently=false; // 鬨?・??・?・?鬮?蜿?・?・?遶頑･?・?蟶?逕･?・?・??・?・?鬯?・??・?・?驛｢・?陷?闌ｨ・?・?隲・髯??
let _micFlatFrames=0;        // 鬯?・??・?・?鬩搾??陞｢・?郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??(驍ｵ・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?)驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?髫?・??・?・?
let _micLastReinitAt=0;      // 鬨?・??・?・?鬮?蜿?・?・?郢晢??髯??隶守ｿ??・?髫?蟶?・?・?陜滂ｽ?髫?蠑ｱ・・け??(ms)
let _micSilentFrames=0,_micReinitInFlight=false;
let _initMicInFlight=false, _lastPromptAt=0;
let _userExplicitMicInit=false; // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・?陟募?・・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?髫?荳橸??闌ｨ・?・??・?・?鬨?・?郢晢??遶???蝮・・?・?髯?・??・?・?鬮?陬懈桶?・?・?郢???・??驍ｵ・?雋??会ｽ?
let _firstInteractionArmed=false; // 髯具??隴惹?橸??讌｢・?・?陜｣・??・?・?隲帷???ｨ驛｢譏ｴ?・?邵?驢搾??・?霑ｹ螟ｲ・?・?郢晢??隰撰??髮九?迴?遶擾??驍ｵ・?郢晢??
let _insecureWarned=false; // 髣???隶主?・??・?霑壼??・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵?蜀暦??・??・?・?驛｢譎槭??・?・??・?・?髯?・?驗呻??郢晢??髯??陝雜｣・?・??・?・?鬩穂ｼ夲??・?髫?螟ゑ??・??・?・??・?・?
// 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?髯?・?闔会ｽ??・??: 髣???・つ髫?蠑ｱ・芽搦・?驍ｵ・??・?・?髫?蟶?逕･?・?・??・?・?鬯?・??・?・?驛｢譎擾??蜷??・?驛｢譎｢・?・?驛｢譎擾??・?遶??壽???・?・?髮・?・?・?鬯?・?霓｣蛛???・?髴域喚?・?鬨?蛹・??・?驍ｵ・??・?・?髴托ｽ??・?・?髫?・?郢晢??
let _mobileHoldRemain=0, _mobileHoldFreq=0;
let _mobilePitchPushToggle=false;
let _mobileLowDecim=0; // 髣???隲?・??・?・??・?・?鬯???・?・?驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?鬮???・?・?鬯?・?陷托ｽ??・?・?陋滂ｽ?????鬨?蛹・??・?驛｢譏ｴ?・?邵?蜥擾??譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??陋ｹ・?・守坩・?譎?蠕娯鴬驛｢譎｢・?・?髯・郢?閾?闊樒ｹ晢??郢晢??
let _mobileNoiseDb=-60; // 髯?閧??蜍???驛｢・??・?・?驛｢譎｢・?・?驛｢譎??騾?驢搾??・??・?・?驛｢譎擾??・?邵??驛｢・??・?・?驛｢譎???驥・??・?・??・?・?髫?證ｦ・?・?髯橸??郢晢??(dB)

async function getMicPermissionState(){
    try{
        if(navigator.permissions && navigator.permissions.query){
            const st = await navigator.permissions.query({name:'microphone'});
            return st.state; // 'granted' | 'denied' | 'prompt'
        }
    }catch(_){ }
    return null; // 髣???髢?・?郢晢??郢晢??郢晢??afari鬩???闔ｨ螟ｲ・?・?郢晢??
}

async function canInitMicWithoutPrompt(){
    const st = await getMicPermissionState();
    if(st==='granted') return true;
    // Permissions API 髫?蟷?・?・?髯・?・?・?髯滂ｽ?隲幢???・?・?郢晢??ull郢晢??陝ｲ・?郢晢??髯懶???・?・?髯?・?陋ｹ・?郢晢??驍ｵ・?遶擾??郢晢??鬩穂ｼ夲??・?驛｢譎?鯵邵?・?驛｢譎｢・?・?髫?・?陜｣・??・?・?隲?肩・?・?陋ｹ・?遶擾??驍ｵ・??・?・?驍ｵ・??・?・?鬮?・??・?・?髯?・??・?・?
    if(st===null && _userExplicitMicInit) return true;
    return false;
}
// 髯具??隴惹?橸??讌｢・?・?陜｣・??・?・?隲帷???螳壼初?つ髯溯??・?・?驍ｵ・??・?・?驍ｵ・?鬯伜ｾ・・?髯?閧??蜍???驍ｵ・??・?・?驛｢譎???・?邵??驛｢・??・?・?鬮?・??・?・?髯?・??・?・?驛｢・?陷・?・?・?郢晢??隨・郢晢??陋ｹ・?・主?・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髫?・?陜｣・??・?・?隲幢???・?・?郢晢???・?・?陋ｹ・?郢晢??驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?髯?・?闔会ｽ??・??驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?郢晢??郢晢??
function armFirstInteractionMicPrompt(){
    try{
        if(_firstInteractionArmed) return; _firstInteractionArmed=true;
        const handler = async()=>{
            try{ await initMic(true).catch(()=>{}); }finally{
                try{ window.removeEventListener('pointerdown', handler, true); }catch(_){ }
                try{ window.removeEventListener('keydown', handler, true); }catch(_){ }
                try{ window.removeEventListener('touchstart', handler, true); }catch(_){ }
            }
        };
        window.addEventListener('pointerdown', handler, {capture:true, once:true, passive:true});
        window.addEventListener('keydown', handler, {capture:true, once:true});
        window.addEventListener('touchstart', handler, {capture:true, once:true, passive:true});
    }catch(_){ }
}

// 髫?荳橸??闌ｨ・?・??・?・?鬨?・?郢晢??遶企?・?譎???・?邵??驛｢・??・?・?髯句??繩??・?・??・?・?郢晢??鬩・?・?・??・?・?髫?・?髣????蝣?・?譎?樟?主??・?譏ｴ?・?邵?驢搾??・?陷?闌ｨ・?・??・?・?驛｢・?遶丞仰遶擾??隲橸??髫?・?闕ｵ譎｢・?荳?FF驍ｵ・??・?・?郢晢??郢晢??
function stopMic(){
    try{
        if(analysisTimer){ try{ clearInterval(analysisTimer); }catch(_){ } analysisTimer=null; }
        if(micStream){ try{ micStream.getTracks().forEach(t=>{ try{ t.onended=null; t.onmute=null; t.onunmute=null; }catch(_){ } try{ t.stop(); }catch(_){ } }); }catch(_){ } }
        try{ if(micSource) micSource.disconnect(); }catch(_){ }
        try{ if(micHPF) micHPF.disconnect(); }catch(_){ }
        try{ if(micLPF) micLPF.disconnect(); }catch(_){ }
        micStream=null; micSource=null; micAnalyser=null; micHPF=null; micLPF=null; micData=null;
        try{ setMicStatus('OFF'); }catch(_){ }
    }catch(_){ }
}

// 髣???隶主?・??・?霑壼??・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵?蜀暦??・??・?・?驛｢譏ｴ?・?file:// 驍ｵ・??・?・?驍ｵ・??・?・?)驍ｵ・??・?・?驍ｵ・??・?・? getUserMedia 驍ｵ・?陟包???・?・??・?・?驍ｵ・?陋ｹ・?遶企?・?・?郢晢??隨??驛｢・?遶丞仰遶擾??郢晢??鬩穂ｼ夲??・?鬨?・?郢晢??遶???蝙?・?・?髯?・?郢晢??
function warnIfInsecureContext(){
    try{
        const insecure = (location.protocol==='file:') || (!window.isSecureContext && location.protocol!=='https:');
        if(!insecure || _insecureWarned) return;
        _insecureWarned = true;
        // 鬮?・??・?・?鬩穂ｼ夲??・?髣???驗呻??郢晢??髮主桁??・?髫?・?闕ｵ??讀?驛｢・?郢晢??郢晢??驛｢・??・?・?驛｢譎｢・?・?髴取ｻゑｽ?・?髯?莨夲??・?髯具??隰費??郢晢??鬮?・?陟暮?会ｽ?蜀暦??・??・?・?驍ｵ・?郢晢???・?・?陋ｹ・?・主?・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?鬮?陬懈桶隰秘??・?陝ｲ・?・つ郢晢??
        // 鬯?・?霑｢諤憺?馴???郢晢??鬯??驍ｵ・?闔会ｽ?遶企豪・?・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?髫?・?郢晢??髯懶???・?・?驛｢・?陷?闌ｨ・?・?闕ｵ譏ｶ??驍ｵ・?郢晢??
        try{ console.warn('Insecure context detected (file:// or non-secure). Microphone may not work due to browser policy.'); }catch(_){ }
    }catch(_){ }
}
let micHPF=null, micLPF=null; // 驛｢譎???・?邵??驛｢・??・?・?髯?鬘後??・?・??・?・?驛｢譎???譁絶襖驛｢譎｢・?・?驛｢・??・?・?郢晢??騾趣???・?・?闔ｨ諛茨??・?/髣???闕ｳ・?雎撰??驛｢譎擾??・?邵??驛｢・??・?・?驛｢・?陝ｶ譎乗ｱる匚・??・?・?郢晢??郢晢??
let playbackStartTime=0,playbackStartPos=0,playbackPosition=0,isPlaying=false,tempoFactor=1.0;
let schedTimer=null; // RAF驍ｵ・??・?・?髯?莨夲??・?驍ｵ・?陋ｹ・?隨??髯??鬩?・?髢?讓抵??・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?
let toleranceCents=20,gateThreshold=-40,analysisRate=120,A4Frequency=440,labelNotation='CDE';
// 髯?・??・?・?鬮?證ｮ鞫?陜滂ｽ?/鬮?・?陋滂ｽ?????驍ｵ・??・?・?鬨?蛹・??・?驍ｵ・?郢晢???・?迢暦??譎??堤?晢??驛｢譏ｶ謌?・?・??・?・?鬯???・?・?髯溯??・?・?驍ｵ・??・?・?髣???驕擾??陷第???・?郢晢??..1郢晢??郢晢??
const PITCH_CONF_MIN = 0.45;
const DRAW_CONF_MIN_MOBILE = 0.42; // 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?髫??陷諤懈?鬨?蛹・??・?驍ｵ・??・?・?髫????髣???隲?・??・?・??・?・?鬯???・?・?髯溯??・?・?郢晢??闔・??・?・??・?・?髮・?・?・?驍ｵ・??・?・?髫?證ｦ・?・?鬨?蛹・??・?驛｢・?陋ｹ・??・?鬘費??・?郢晢???・??鬩搾???・?・?驍ｵ・?隰?・??・?・?郢晢??
// 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?鬮?陬懈桶隰・: 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?驛｢・??・?闊?し???・?・?髯?・?陟募具??驛｢譏???・?邵??驛｢譎丞ｹ?・主??・?・??・?・?驛｢譎｢・?・?驛｢・?陷・?・?・??・?・?驍ｵ・?陋ｹ・??・?迢暦??・?陋ｹ・?遶???驍ｵ・??・?・?驍ｵ・?陷?・??・??門?慕ｹ晢??陝蟶・・?陜捺?・飴髯橸??陷夲??N郢晢??郢晢??
let USE_PC_PIPELINE_ON_MOBILE = true;
let verticalZoom=2.5,verticalOffset=0,pxPerSec=150,timelineOffsetSec=0,isPanning=false,panStartX=0,panStartOffset=0;
let isAdjustingVOffset=false; // 髯?・??・?・?髯句??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴髫?・?陜｣・??・?・?隲帑ｼ夲??・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?
let autoCenterFrozen=false; // 驛｢譎擾??・?郢晢??驛｢譏ｴ?・??・?・??・?・?鬯?・?郢晢???・?・??・?・?鬯?・?鬮?・?郢晢??鬮?・??・?・?髯??趣??譁絶落驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・?髮区??陬??搾??郢晢??
let pitchHistory=[],markers={A:null,B:null,C:null,D:null,E:null,F:null,G:null},stopStage=0;
let micRenderMode='graph'; // 'line' | 'dot' | 'graph'
// 髯?・??・?・?鬮?證ｮ鞫?陜滂ｽ?鬮?・?隲?肩・?・??・?・?驛｢譏???・?・主??・?譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??郢晢??I驍ｵ・??・?・?髯樊ｺ?蛻?陝ｲ・?髯?・??・?・?郢晢??郢晢??
let visTimeSnapMs = 180;           // 驛｢・??・?・?驛｢・??・?・?驛｢譎牙愛陷・??鬯?・?髦?蜷?笳矩Δ譎会ｽ?・?郢晢??驛｢譎∵??・?・??・?・?髯橸???・?・?郢晢??郢晢??s郢晢??郢晢??
let visBridgeGapMs = 150;          // 髣???・つ鬮?螂???・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??鬯?・??・?・?鬩搾??隰?・??・?・?郢晢??s郢晢??郢晢??
let visBridgeGapInNoteMs = 300;    // 髯?・?陟包???・?・?・つ驛｢譎擾??・?郢晢??驛｢譏???・?郢晢??驍ｵ・??・?・?髫????髯樊ｻゑｽ?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??鬯?・??・?・?鬩搾??隰?・??・?・?郢晢??s郢晢??郢晢??
let visChangeTolSemi = 0.65;       // 髯具??郢晢??霑夲??驍ｵ・?陷会ｽ?遯?・?驍ｵ・?郢晢??・つ?・?・?郢晢??闔・?雎ｼ?鬯?・??・?・?郢晢??郢晢??
let visEdgePadMs = 160;            // 鬩????・?・?髯?・??・?・?鬨?・?・つ驍ｵ・??・?・?鬮?・??・?・?髯橸???・?・?郢晢??郢晢??s郢晢??郢晢??
let guideLineWidth=4; // 驛｢・??・?・?驛｢・??・?・?驛｢譎?・??・?・?陞｢・??・?・??・?・?驍ｵ・?陋ｹ??・?・?陋ｹ・?邵?蟶?・?譎｢・?・?驛｢・??・?・?驛｢謨鳴髯?・?髢?・?闕ｳ闊?・?郢晢??
// Live pitch state
let lastMicFreq=0,lastMicMidi=0; const pitchSmoothBuf=[]; const PITCH_SMOOTH_WINDOW=7;
// 驛｢譎｢・?・?驛｢・??・?・?驛｢譏?????闊? 鬩墓得??・?鬯?霈?・??・?・??・?・?Viterbi驍ｵ・??・?・?髯区???・・?・?隲・?・?・??・?・?髯具??陷会ｽ?・ゑｽ?驛｢・?騾???隲?蜻?豌｣?・?・?驍ｵ・??・?・?f0驛｢・?陝ｶ譏ｶ?閧?・?・??・?・?郢晢??陋ｹ・?邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・??・?・?驍ｵ・?闕ｳ・??・?・?霑壼遜??・?陞｢・?陜滂ｽ?郢晢??郢晢??
const LIVE_VIT_LAG = 5;           // 驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?鬯?霈?・??・?・??・?・?郢晢??髢?・??・?・?郢晢??.1驍ｵ・?郢晢??.15s郢晢??郢晢??
const LIVE_VIT_MAX = 48;          // 驛｢譎?蠕湖暮Δ譎???譁撰?憺蘭・?隴・隰梧??蜿芽耳竏晏?・
let liveVitFrames = [];           // [{cands:number[], costs:number[], time:number}]
// ---- Diagnostics (lightweight, rate-limited) ----
let __diagEnabled = true; // 鬯?・?霑｢諤憺?馴??蛹・??・?: 鬮?證ｦ・?・?髫?・?郢晢??髫??陷諤懈?驍ｵ・??・?・?鬨?・??・?・?髯晢???・?・?髫??隲幢??郢晢??驛｢・?陋幢??邵?諷???譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯???・?・?驍ｵ・?陷?・??・?・?陜捺?薙◆鬨?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・? false 髫?證ｦ・?・?髯槭???・?郢晢??郢晢??
const __diagMarks = Object.create(null);
function __diagLog(kind, data, rateMs=2000){
    if(!__diagEnabled) return;
    try{
        const now = Date.now();
        const last = __diagMarks[kind] || 0;
        if(now - last < rateMs) return;
        __diagMarks[kind] = now;
        // 髣?侭?・? kind='c-only-visual'
        // 髯???・?・?髯?迚呻??蜷??・?髫?證ｦ・?・?驍ｵ・?陋ｹ・??・?竏ｫ・?・??・?・?郢晢??闔・??・?・?郢晢???・?・?遶擾??隲?蜻?豌｣陜謎ｸ?蠢憺し???・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・?郢晢??郢晢??
        console.warn('[Diag]', kind, data);
    }catch(_){ /* ignore diag logging failures */ }
}
// YIN驛｢譏???・?邵?蟷・??郢?閾?闊? f/2, f, 2f 驍ｵ・??・?・?3髯区???・・?・?隲帷???蟶晢?・・?・?髫?荳橸??・?iterbi郢晢??陋ｹ・?・守坩・?譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎樊束?・?・?霑壼遜??・?陞｢・?陜滂ｽ?郢晢??郢晢??
const YIN_VIT_LAG = 3;            // 鬯?霈?・??・?・??・?・?驛｢・?陋幢???・??驛｢・?陝ｲ・?遶???・??・?・?鬩搾???・?・?郢晢??髢?・??・?・?郢晢??5驍ｵ・?郢晢??5ms鬨?・??・?・?髯溷?懷???・?・?郢晢??
const YIN_VIT_MAX = 64;           // 驛｢譎?蠕湖暮Δ譎???譁撰?憺蘭・?隴・隰梧??蜿芽耳竏晏?・
let yinVitFrames = [];
// 鬮?蜍?・??・?・?陞｢・?陜滂ｽ?驛｢・??・?・?驛｢・??・?・?驛｢譎???菴?・?驛｢・??・?・?鬮?・?隲?肩・?・??・?・?郢晢??陜捺?ゑｽ?・?隲幢??郢晢??驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?鬯?霈?・??・?・??・?・?驛｢・?陞ｳ螟ｲ・?・?驍?私??・?驗呻???・??驍ｵ・??・?・?髯晢???・?・?驍ｵ・??・?・?髯・郢晢??隨?迢暦??・?霑｢證ｦ・?・?陷?閧??螢??・?郢晢??
const PITCH_TIME_OFFSET_SEC = 0.085; // 髯憺屮・?・?髫?蟷?・?・?驍ｵ・??・?・?髯?隨?・?迺??陋幢???・??郢晢??陋ｹ・?・守坩・?譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?鬮?遨ゑｽ?謨???驍ｵ・??・??遶???髯?慣・?・?驛｢・?陋幢???・?蜀暦??・?陞｢・?・ゑｽ?驍ｵ・??・?・?鬩墓得??・?鬩搾???・?・?郢晢??郢晢??
function getPitchVisOffsetSec(){
    // 髮九ｑ??・?髯橸??陞｢・??・??驛｢・?陟募??陞ｺ髯???・?・?髯?迚呻???遶???髯?慣・?・?驍ｵ・??・?・?髣???・つ鬯?蟷?・?・?驛｢・?髮区??・??鬮?證ｮ鞫?陜滂ｽ?驍ｵ・??・?・?驛｢・?郢??雋ょ????謫?・?・?郢晢??鬩・?・?・?陟募???・?鬯?蜍滂ｽ?・?驍?驍ｵ・??・?・?驍ｵ・?郢晢???・?閧?・?・?郢晢???・?・?闔ｨ竏晏???晢??郢晢??
    const extra = btLatencyEnabled? Math.min(0.15, (btLatencySec||0)*0.6) : 0;
    return PITCH_TIME_OFFSET_SEC + extra;
}
// 髯滓汚??・?髯具???・?・?髯?闌ｨ・?・?髯懈瑳・?骰狗ｲ??肴得??・?驛｢譎???驥・??・?・??・?・?郢晢??闔・?陝遏ｩ?・?・つ髯具???・?・?髯橸??陞｢・?邵?蝣?・?・??・?・?鬮?・??・?・?髯橸??陞｢・??・??驍ｵ・??・?・?驍ｵ・?郢晢??・つ郢???・?・?陞滓?螟ゑ??・??・?・?驛｢譎??・趣??驛｢譎???・??髯・郢晢??鬮?諛???螟ｲ・?・?髣比ｼ夲??・?驍ｵ・??・?・?鬨?蛹・??・?驍ｵ・?郢晢???・???????・?・?髯橸??陞滂ｽ??・?・?郢晢??
let _forceGlobalSearch=0;
// 鬮?????・?髯?莨夲??・?髴托ｽ??・?・?髫?・?郢晢??
let showNoteNames=true;
// 髫?證ｦ・?・?髴難???・?・?鬮?・??・?・?鬩穂ｼ夲??・?: 髯?・?陟包???・?・?・つ鬯?・??・?・?鬩墓ｩ?・?・?郢晢??郢晢??,D,...郢晢??陝ｲ・??・?蝣?・?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§遶企豪・?・??・?・?驍ｵ・?雋???・?驍ｵ・??・?・?驍ｵ・??・?・?髫俶誓??・?髴難???・?・?驍ｵ・??・?・?鬯?・?鬮?・?郢晢??髫??闕ｳ蟯??・?驍ｵ・?陷?・??・?迢暦??・??・?・?驛｢譎｢・?・?驛｢譎?蠕?・?驛｢譎｢・?・?驛｢・??・?・?
let scorePitchClassOverlay=true; // 鬮?陬懈桶隰泌調・?・??・?・?驛｢・?陋ｹ・??・?鬘假???会ｽ?・?髯橸??陷夲??N郢晢??陜捺?ゑｽ?・?隲幢??郢晢??驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?邵?驢搾??・??・?・?髯樊ｺ?蛻?陝ｲ・?驍ｵ・?陷会ｽ?遶企?・?・?郢晢???・?・?郢晢??
// 髫?證ｦ・?・?髴難???・?・?鬨?蛹・??・?髴托ｽ??・?・?髫?・?郢晢??
let scoreSessionId = 0;
let scoreStats = null; // { bins:[{count,sum,sumAbs,inTol,outTol,sharp,flat}], total }
let _pauseAdviceTimer = null; // 髯句??繩??・?・??・?・?髫?蠑ｱ・・?晢??驛｢・??・?・?驛｢譎擾??・?郢晢??驛｢・??・?・?驛｢・??・?・?鬯?霈?・??・?・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?
// 鬯?・??・?・?鬩墓ｩ?・?・??・??陷会ｽ?邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏???貊ゑ??・??・?・?鬮?・?郢晢??
let scoreDetailByOct = {}; // { [octaveString]: { [pc]: {in:0,out:0,count:0} } }
// 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?§・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?鬮?・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?髴托ｽ??・?・?髫?・?郢晢??
let isCalibrating=false; let _calibRAF=0; let calibPrevPos=0; let calibBasePos=0; let calibMoveStartPerf=0; let calibCountdownText=null; let _calibAbort=false;
// 鬯?霈?・??・?・??・?・?鬮?・?隲?肩・?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎??騾?驢搾??譎???驥・??・?・??・?・?/驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?
let isAssistMode=false; let _assistRAF=0; let _assistAbort=false;

function isAssistActive(){ return !!isAssistMode; }
let calibAnchorActive=false; let calibAnchorTime=0; let calibAnchorMidi=60;

// MIDI驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?髣比ｼ夲??・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・?陟?鬮?證ｮ鞫?陜滂ｽ?鬨?蛹・??・?
let midiGhostNotes = null; // [{midi,time,duration,role?}] | null
// 鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譏ｴ?・? 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・?隶吩??鬨馴辨・??・?・?驍ｵ・?陷?・?遶冗距??・?鬮?・?邵?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??(驛｢譎｢・?・?驛｢・??・?・?驛｢譎???・趣??驛｢・??・?・?)驛｢譎擾??・?郢晢??驛｢譏???蛹・??・?・つ鬮?蛹・??・?
// [{midi,time,duration}] 驛｢・?陷・?・?・?隴・隰梧??・?・?陷会ｽ?・つ?・?・?elody 驍ｵ・?隶吝ｯ???驍ｵ・?郢晢???・?・??・?・?髯?・?陋ｹ・?郢晢??髫?證ｦ・?・?髴難???・?・?髯?・?郢?蟲??・?驍ｵ・??・?・?髣????・?・?驍ｵ・?郢晢??
let practiceExpectedNotes = null;
let scheduledUntil=0; const SCHEDULE_AHEAD=0.6; // 驍ｵ・?髴???・?閾?・?・??・?・?鬩墓得??・?鬩搾???・?・?驍ｵ・?陷会ｽ?遯?・?鬮?蜈ｷ・?・?鬮?蛹・??・?驛｢・?陞ｳ螟ｲ・?・??・?・?髮九??・?
const MAX_DYNAMIC_LOOKAHEAD=30; // 髯具??隴・隰・驛｢譎擾??・?郢晢??驛｢譎乗ｲ?霎ｷ・?鬩肴得??・?驍ｵ・??・?・?髫????髯樊ｻゑｽ?・?髫?・??・?・?髯滓汚??・?鬩募??・?
let tempoSegments=[]; // 鬩榊･・??・?髯・郢晢??郢晢??驛｢譎｢・?・?驛｢譎???郢晢??驛｢譏ｴ?・?郢晢??
// 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?鬨?蛹・??・?髴托ｽ??・?・?髫?・?郢晢??
let activeVoices=[]; const MAX_POLYPHONY=48; let noiseBuffer=null; function getNoiseBuffer(){ if(noiseBuffer) return noiseBuffer; if(!audioCtx) return null; const len=Math.floor(audioCtx.sampleRate*0.03); const buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/len,2); } noiseBuffer=buf; return noiseBuffer; }
let scheduledCounter=0;
let useSamplePiano=true; // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取刮・?譎??郢晢??驛｢・??・?・?驛｢譎??堤???驛｢譎?・??・?・??・?・?鬨?蛹・??・?
const PIANO_SAMPLE_MIDIS=[36,40,43,48,52,55,60,64,67,72,76,79];
const pianoSampleBuffers={}; let pianoSamplesLoading=false,pianoSamplesLoaded=false;
// 鬩墓得??・?髫?蠑ｱ・玖?・?驍ｵ・??・?・?髯?・?隴?・?陷・??鬨?蜈ｷ・?・?鬯?・??・?・?髫?・??・?・?髫?證ｦ・?・?髯橸??陞溘ｉ闊樒ｹ晢??陋ｹ・?邵??驛｢・??・?・?驛｢譏ｴ?・?邵?驢搾??・??・?・?髯懶??郢晢???・?・?・つ驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?髯具???・?・?鬨?蛹・??・?郢晢??郢晢??
const RECENT_STARTS=[]; const POLY_WINDOW=0.025; // 25ms 鬩???郢晢??
async function loadPianoSamples(){
    // file:// 驍ｵ・??・?・?鬨?・??・?・?髫?證ｦ・?・?鬯?・?闕ｵ譎｢・?讓抵??・??・?・?驍ｵ・?郢晢???・??匁捗?・?・?髯?・?陋ｹ・?郢晢?? fetch 驍ｵ・?郢晢??CORS 驍ｵ・??・?・?髯樊ｻゑｽ?・?髫?・?陷会ｽ?隨・驛｢・?闕ｵ譏ｶ陞ｺ驛｢・?遶丞｣?窶?驛｢譏ｴ?・?
    if(location.protocol==='file:'){
        // 髫??会ｽ?・?髯樊ｺ?・?諷壼?ゑｽ?・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取刮・?・??・?・?髯?・?鬮???・?・?陷会ｽ?邵?蝣?・?・?鬮?・?遶企?・?・?郢晢??遯?・? ZIP/驛｢譎???蛟･?晞Δ譏???・?郢晢??驛｢・??・?・?髫???・?・?髯溷床??鄙ｫ?・?髯具???・?・?鬨?蛹・??・?髯?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?髯具??隰費???・??驍ｵ・??・?・?驍ｵ・?郢晢??・つ郢晢??
        console.warn('file:// 髴托ｽ??・?・?髯・郢晢?? 髯樊ｺ?・?諷・ fetch 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取刮・?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢?? (ZIP / 驛｢譎???蛟･?晞Δ譏???・?郢晢??驛｢・??・?・?驍ｵ・??・?・?髯具???・?・?鬨?蛹・??・?髯?・??・?・?鬮?・??・?・?)');
        return; // 驍ｵ・?髦?蜻?・??驍ｵ・??・?・?驍ｵ・??・?・?髣???髴???・?繧会ｽ?・?陷会ｽ?遶企?・?・?郢晢??(ZIP驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?櫨?・?・?郢晢??隨・)
    }
    if(pianoSamplesLoaded||pianoSamplesLoading||!useSamplePiano) return;
    if(!audioCtx) ensureAudio();
    pianoSamplesLoading=true;
    const root='assets/piano/';
    let errorOnce=false;
    const tasks=PIANO_SAMPLE_MIDIS.map(m=>fetch(root+`m${m}.mp3`).then(r=>{ if(!r.ok) throw 'missing sample '+m; return r.arrayBuffer(); }).then(ab=>new Promise((res,rej)=> audioCtx.decodeAudioData(ab,b=>res({m,b}),e=>rej(e)))).catch(e=>{ if(!errorOnce){ console.warn('sample load error (髣比ｼ夲??・?鬯?・?陷?・?隲?螳??・??・?・?) ->',e); errorOnce=true; } return null; }));
    const results=await Promise.all(tasks);
    results.forEach(o=>{ if(o) pianoSampleBuffers[o.m]=o.b; });
    const have=Object.keys(pianoSampleBuffers).length;
    pianoSamplesLoaded=have>0; pianoSamplesLoading=false;
    if(!pianoSamplesLoaded){
        console.warn('驛｢譎??堤???驛｢譎擾??・?邵?遉ｼ・?譎｢・?・?驛｢譎丞ｹ?・取刮・?・?郢晢??驍ｵ・??・?・?驛｢・?郢??陷?蜻??蜍溷??邵?蝣?・?・?鬮?・?遶擾??驍ｵ・?陝ｶ蜻?・?骰具??・??・?・?驍ｵ・?陷会ｽ?隨??驍ｵ・?郢??邵?遉ｼ・?譎｢・?・?驛｢譎丞ｹ?・取刮・?譎??堤???驛｢譎擾??驕ｺ莨?髯?莨夲??・?髯具??隰費??・つ郢晢??);
        useSamplePiano=false;
    } else {
        console.log('Piano samples loaded',have,'/'+PIANO_SAMPLE_MIDIS.length);
    }
}
function nearestSampleMidi(m){ let best=PIANO_SAMPLE_MIDIS[0],bd=999; for(const s of PIANO_SAMPLE_MIDIS){ if(!pianoSampleBuffers[s]) continue; const d=Math.abs(s-m); if(d<bd){ bd=d; best=s; } } return best; }
let activeSampleVoices=[]; function cleanupSampleVoices(now){ activeSampleVoices=activeSampleVoices.filter(v=>{ if(v.end<=now){ try{ v.g.disconnect(); }catch(_){ } return false;} return true; }); }
function sampleVoiceStealIfNeeded(){ const limit=Math.max(24, Math.min(64, MAX_POLYPHONY)); if(activeSampleVoices.length<limit) return; activeSampleVoices.sort((a,b)=>a.end-b.end); const v=activeSampleVoices.shift(); try{ if(v && v.g && v.g.gain){ v.g.gain.setTargetAtTime(0, audioCtx.currentTime, 0.02);} }catch(_){ } }
function createSamplePianoVoice(midi,when,dur,outGain){ if(!pianoSamplesLoaded) return false; const base=nearestSampleMidi(midi); const buf=pianoSampleBuffers[base]; if(!buf) return false; cleanupSampleVoices(audioCtx.currentTime); if(activeSampleVoices.length>MAX_POLYPHONY){ activeSampleVoices.sort((a,b)=>a.end-b.end); const v=activeSampleVoices.shift(); try{ v.g.gain.setTargetAtTime(0,audioCtx.currentTime,0.02);}catch(_){ } }
    const src=audioCtx.createBufferSource(); src.buffer=buf; const rate=Math.pow(2,(midi-base)/12); src.playbackRate.setValueAtTime(rate,when);
    const g=audioCtx.createGain(); g.gain.setValueAtTime(0.0001,when); g.gain.exponentialRampToValueAtTime(0.85,when+0.01);
    const raw=buf.duration/rate; const nd=Math.min(dur,10); const playDur=Math.min(raw, nd+0.3); const fadeStart=when+Math.min(nd, raw*0.85); g.gain.setTargetAtTime(0,fadeStart,0.25);
    src.connect(g); g.connect(outGain); src.start(when); src.stop(when+playDur+0.05); activeSampleVoices.push({end:when+playDur+0.4,g}); return true; }
let usePianoSynth=true; // 驛｢譏ｴ?・?郢晢??驛｢譏ｴ?・?邵?蟶敖蛹・??・?髯具??郢晢??陝?: false 驍ｵ・??・?・?驍ｵ・?陷?・??・?迢暦??・??・?・?髫??会ｽ?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・・ sine 鬨?蜈ｷ・?・?鬯?・??・?・?
// 髴托ｽ??・?・?髯・郢晢??郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?
function isIOS(){
    try{
        return /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);
    }catch(_){ return false; }
}
// LRU鬨?蛹・??・?驍ｵ・??・?・?鬩搾???・?・?鬮?・?陋ｹ・?遶??壼?・・?・?髯溷桁??・?
const SAMPLE_USE_STATS={};
let lastLruCheck=0; // performance.now()
const LRU_CHECK_INTERVAL=5000; // ms
const MAX_DECODED_SAMPLES_SOFT=180; // 驛｢譏ｴ?・?邵?諷???譎｢・?・?驛｢譎牙??・?・?陋ｹ・?遶擾??驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取刮・?・??・?・?驛｢・??・?・?驛｢譎???譁石夐藍・?闔ｨ竏晏?・
// ---- DOM ----
const $=id=>document.getElementById(id);
// 髫??会ｽ?・?: MIDI/MusicXML 鬨?蛹・??・?驍ｵ・??・?・?驛｢譎???譁撰?憺Δ???・?・?驛｢譎｢・?・?髯?闌ｨ・?・?髯?迚呻??蜷??・?髯晏??・??・?・??・?・?
// const fileInput=$('fileInput'),fileSelectBtn=$('fileSelectBtn'),fileNameLabel=$('fileNameLabel');
const chartCanvas=$('chartCanvas');const ctx=chartCanvas?chartCanvas.getContext('2d'):null;
const playBtn=$('playButton'),pauseBtn=$('pauseButton'),stopBtn=$('stopButton');
const rw5=$('rewind5'),rw10=$('rewind10'),fw5=$('forward5'),fw10=$('forward10');
const tolSlider=$('toleranceSlider'),tolVal=$('toleranceValue');
const gateSlider=$('gateSlider'),gateVal=$('gateValue');
const rateSlider=$('rateSlider'),rateVal=$('rateValue');
const labelSel=$('labelNotationSelect');
// 髫???・?・?鬮?霈?・? 驛｢譎???・?邵??驛｢・??・?・?髫??陷諤懈?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎擾??・?邵?譎会ｽ?譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?
const micRenderModeSel=document.getElementById('micRenderModeSelect');
const vZoom=$('verticalZoomSlider'),timeScale=$('timeScaleSlider'),timeScaleVal=$('timeScaleValue');
const vOffsetSliderRight=$('verticalOffsetSliderRight');
    if(vOffsetSliderRight){
        // 驛｢譎???邵??驛｢譎｢・?・?驛｢・??・?・?髫?・?陜｣・??・?・?郢晢?? 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴驛｢譎｢・?・?髫?・?陜｣・??・?・?隲帑ｼ夲??・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕娯雷驛｢譏???・?・趣??驛｢・?髮区??・?・?隰疲?・・?驛｢譎?§・取ｺ?・?譏ｴ?・?邵?莉｣?・?陜捺?・飴髯橸??陞｢・?郢晢??驛｢譎擾??・?・主??・?譏ｴ?・?邵?蝣?・?・??・?・?鬯?・??・?・?髯橸???・?・?驍ｵ・?陷会ｽ?遶企?・?・?郢晢???・?・?郢晢??
        vOffsetSliderRight.addEventListener('pointerdown',(e)=>{ isAdjustingVOffset=true; e.stopPropagation(); }, {capture:true});
        vOffsetSliderRight.addEventListener('pointermove',(e)=>{ if(!isAdjustingVOffset) return; e.stopPropagation(); }, {capture:true});
        vOffsetSliderRight.addEventListener('pointerup',(e)=>{ isAdjustingVOffset=false; e.stopPropagation(); }, {capture:true});
        vOffsetSliderRight.addEventListener('pointercancel',(e)=>{ isAdjustingVOffset=false; e.stopPropagation(); }, {capture:true});
        // 驛｢・??・?・?驛｢譏ｴ?・?郢晢??髫?・?陜｣・??・?・?郢晢?? 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髫?螟ゑ??・??・?・??・?・?驍ｵ・??・?・? CSS 驍ｵ・??・?・? touch-action 驍ｵ・??・?・?髣比ｼ夲??・?驍ｵ・?陝ｶ蜻?・?荵・・?陜捺?・飴髯橸??陞｢・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴髯?蜥?・?繧托ｽ?・?隲帷???・?鬩搾???・?・?髫?謔ｶ?・??・?・?郢晢??
        vOffsetSliderRight.addEventListener('touchstart',(e)=>{ isAdjustingVOffset=true; e.stopPropagation(); }, {capture:true, passive:false});
        vOffsetSliderRight.addEventListener('touchmove',(e)=>{ if(!isAdjustingVOffset) return; e.stopPropagation(); }, {capture:true, passive:false});
        vOffsetSliderRight.addEventListener('touchend',(e)=>{ isAdjustingVOffset=false; e.stopPropagation(); }, {capture:true});
        vOffsetSliderRight.addEventListener('touchcancel',(e)=>{ isAdjustingVOffset=false; e.stopPropagation(); }, {capture:true});
        // 髯区?ゑｽ?・?髯樊ｺ?蛻?陝ｲ・?
        const applyVOffset = ()=>{ verticalOffset=parseInt(vOffsetSliderRight.value); syncVerticalOffsetSliders(); drawChart(); };
        vOffsetSliderRight.addEventListener('input', applyVOffset);
        vOffsetSliderRight.addEventListener('change', applyVOffset);
    }
const editToolbar=document.getElementById('editToolbar');
// 驛｢・??・?・?驛｢譏ｴ?・?邵?蜥擾??譎｢・?・?驛｢譎｢・?・?髣???隴取得??・?郢晢??鬮?・??・?・?鬮?雜｣・?・? UI
const sessionSaveBtn=document.getElementById('sessionSaveBtn');
const sessionLoadBtn=document.getElementById('sessionLoadBtn');
const sessionLoadInput=document.getElementById('sessionLoadInput');
// 鬮?????・?髯?莨夲??・?: 驛｢譎?樟?主??・?譎｢・?・?驛｢・??・?・?驛｢譎???郢晢??驛｢譏???・?隰・??髯句??・?・?驍ｵ・??・?・?髯??陷?・?陷・??驛｢譎???菴?遉ｼ・?譎｢・?・?驛｢譏???・?郢晢??髫?蜴・??・?
const melodyPlayToggle=document.getElementById('melodyPlayToggle'); // 髣・陷?逎ｯ蜈ｱ: HTML驍ｵ・?闕ｵ譎｢・?閾?・?・??・?・?髯?蜿?・?竏晄?る寞繧・樟?擾??

// ========================
// 驛｢譎∽??・取刮・?譎牙愛陷・??髯具???・?・?驛｢譎?樟郢晢??驛｢・??・?・?驛｢譎槭??・?・??・?・?鬩穂ｼ夲??・?
// ========================
(function(){
    async function getLastModifiedFrom(url){
        // file:// 驛｢・?郢晢??隰費??鬩墓得??・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・? CORS/驛｢譎???・取㏍・?・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯樊ｻゑｽ?・?髫?・?陷会ｽ?隨・驛｢・?闕ｵ譏ｶ陞ｺ驛｢・?郢晢??fetch 驛｢・?陞ｳ螟ｲ・?・?陟暮?会ｽ?蜀暦??・??・?・?驍ｵ・?郢晢??
        try{
            const proto = (location && location.protocol || '').toLowerCase();
            if(proto !== 'http:' && proto !== 'https:'){
                return null; // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎擾??・?郢晢??髣????・?・?髫?蠑ｱ・・?晢??驍ｵ・??・?・?髯?・?鬮???・?・?陷会ｽ?遶企豪・?譎?樟?主??・?・??・?・?
            }
        }catch(_){ /* location髫?蟷?・?・?髯橸??陞溘ｑ??・??・?・?鬩???陝ｲ・?郢晢??髴取ｻゑｽ?・?鬮?霈?・?*/ }
        try{
            // 1) HEAD 驍ｵ・??・?・? Last-Modified 驛｢・?髮区??蠕宣辧?灘惧?・?・?闔・??・?・??・?・?髯滂ｽ?隲帷??・?驛｢譎｢・?・?驛｢譏???蜥趣???驍ｵ・?隰・∞??・?郢晢??
            const headRes = await fetch(url, { method:'HEAD', cache:'no-store' });
            const lm = headRes.headers.get('last-modified');
            if(lm){ return new Date(lm); }
        }catch(_){/* 髫?・??・?・?驍ｵ・??・?・?髫??陋ｹ・??・?・??・?・?驍ｵ・??・?・? */}
        try{
            // 2) GET 驍ｵ・??・?・?驛｢譎渉・?郢晢??驛｢謨鳴驛｢・?陜｣・??・?・??・?・?鬮?・?隰?・??・?・?郢晢??o-store郢晢??陝ｲ・?・つ郢?蝓溘◆髫?竏?・?郢晢??鬩墓?・?・?髫?・?郢晢??
            const res = await fetch(url, { cache:'no-store' });
            const lm = res.headers.get('last-modified');
            if(lm){ return new Date(lm); }
        }catch(_){/* 髫?・??・?・?驍ｵ・??・?・?髫??陋ｹ・??・?・??・?・?驍ｵ・??・?・? */}
        return null;
    }

    function formatYYMMDDHHMM(d){
        if(!d) return '';
        const yy = String(d.getFullYear()).slice(-2);
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        return `${yy}${mm}${dd}${hh}${mi}`;
    }

    function ensureToastEl(){
        let el = document.getElementById('buildToast');
        if(!el){
            el = document.createElement('div');
            el.id = 'buildToast';
            el.setAttribute('aria-live','polite');
            el.style.position='fixed'; el.style.top='8px'; el.style.right='8px';
            el.style.background='rgba(0,0,0,0.75)'; el.style.color='#e6eaf2';
            el.style.border='1px solid #2b3244'; el.style.padding='6px 10px';
            el.style.borderRadius='8px'; el.style.fontFamily="ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace";
            el.style.fontSize='12px'; el.style.zIndex='3000'; el.style.display='none';
            el.style.pointerEvents='none';
            document.body.appendChild(el);
        }
        return el;
    }

    function showToast(text, durationMs=2000){
        const el = ensureToastEl();
        el.textContent = text;
        el.style.display = 'block';
        el.style.opacity = '1';
        el.style.transition = 'opacity 0.35s ease';
        // 髯・闔会ｽ??・??髣???驗呻??遶頑･?豎樒ｹ晢??隨?迢暦??・?陷茨???・?・?騾趣??郤・??驍ｵ・??・?・?驛｢・?鬮?竏晢??鬥?・?蛹・??・?郢晢??郢晢??
        el.style.top = '8px'; el.style.right = '8px';
        window.setTimeout(()=>{
            try{
                el.style.opacity = '0';
                const onEnd = ()=>{ el.style.display='none'; el.removeEventListener('transitionend', onEnd); };
                el.addEventListener('transitionend', onEnd);
            }catch(_){ el.style.display='none'; }
        }, Math.max(800, durationMs|0));
    }

    async function showBuildStamp(){
        try{
            // app.js 驍ｵ・??・?・?髫?蜴・??・?髫???・?・?髫?蠑ｱ・・け??驛｢・?髮区?樒?髯???豐ｺ雎撰??鬨?蛹・??・?驍ｵ・?郢??鬩溽?大初?つ驛｢譎???譁撰?憺Δ???・?・?驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・?雋?∞??竏ｬ・????驛｢・?郢?莨夲??・??・?・?髯橸??雋??可郢晢??
            let dt = await getLastModifiedFrom('app.js');
            if(!dt){
                // 髫?・??・?・?髴難???・?・?: styles.css
                dt = await getLastModifiedFrom('styles.css');
            }
            if(!dt){
                // 髫????髯溷供??蠕?・?驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?: document.lastModified郢晢??陜捺?捺??髯・隲?諛?・?, 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?髮・陋ｹ竏ｽ・??郢晢??郢晢??
                try{ dt = new Date(document.lastModified); }catch(_){ dt = new Date(); }
            }
            const stamp = formatYYMMDDHHMM(dt);
            if(stamp){ showToast(stamp, 2000); }
        }catch(e){
            // 髯樊ｻゑｽ?・?髫?・?陷会ｽ??・??驍ｵ・??・?・?驛｢・?郢??邵??驛｢譎丞ｹ?・取㊥・?蛹・??・?郢晢??驍ｵ・??・?・?髯溷私??・?鬯?・??・?・?驍ｵ・?髴域喚髮?驍ｵ・??・?・?驍ｵ・?郢晢??
            try{ console.warn('build stamp toast failed:', e); }catch(_){ }
        }
    }

    if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded', showBuildStamp, { once:true });
    }else{
        // 髫??会ｽ?・?驍ｵ・??・?・?髫?蝣?霍?・?・?騾????・?・?陋ｹ・?遶擾??驍ｵ・??・?・?驛｢・?霑壼雀蛻晞垓蠑ｱ?・?
        showBuildStamp();
    }
})();

// ========================
// 驛｢譏ｴ?・?郢晢??驛｢譎｢・?・?驛｢譏ｶ?螢??暮Δ譏ｴ?・? .help-text 驛｢・?陋幢??・主??・?譎??・取?・?髮?・?・?驍ｵ・??・?・? i 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?鬩募???・?鬮?・?郢晢??
// ========================
(function(){
    function createTipBubble(){
        let tip = document.getElementById('globalTooltipBubble');
        if(!tip){
            tip = document.createElement('div');
            tip.id = 'globalTooltipBubble';
            tip.className = 'tooltip-bubble';
            tip.style.display = 'none';
            document.body.appendChild(tip);
        }
        return tip;
    }
    function showTip(targetEl, text){
        const tip = createTipBubble();
        tip.textContent = text || '';
        if(!text){ tip.style.display='none'; return; }
        const rect = targetEl.getBoundingClientRect();
        const top = rect.top + window.scrollY - 8; // 驍ｵ・??・?・?驛｢・?郢晢???・?讚??郢晢??
        const left = rect.left + window.scrollX + rect.width + 8; // 髯?・??・?・?髫?髮?・?・?
        tip.style.top = top + 'px';
        tip.style.left = left + 'px';
        tip.style.display = 'block';
        // 髯滓汚??・?髯具???・?・?reflow髯溷供??螽??骰具??・??・?・?驛｢譏???譁?
        void tip.offsetHeight; tip.classList.add('show');
        // 鬮?・??・?・?髯??趣??譁絶蔓驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎∬??・?・?陋ｹ・?・守坩・?譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??鬮?・??・?・?鬩穂ｼ夲??・?髯?・?闔会ｽ??・??郢晢??郢晢??
        clearTimeout(showTip._to);
        showTip._to = setTimeout(()=>{ hideTip(); }, 3000);
    }
    function hideTip(){
        const tip = document.getElementById('globalTooltipBubble');
        if(!tip) return;
        tip.classList.remove('show');
        // 驛｢・??・?・?驛｢譏???譁滓･??蜍滂ｽ?螽??鬥?・?・?隶・?・?・??・?・?鬩穂ｼ夲??・?
        setTimeout(()=>{ if(tip && !tip.classList.contains('show')) tip.style.display='none'; }, 150);
    }
    function attachInfoIcon(labelEl, helpText){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'info-tip';
        btn.textContent = 'i';
        btn.setAttribute('aria-label','鬮?・??・?・?髫?荳・・?);
        btn.addEventListener('mouseenter', ()=> showTip(btn, helpText));
        btn.addEventListener('focus', ()=> showTip(btn, helpText));
        btn.addEventListener('mouseleave', hideTip);
        btn.addEventListener('blur', hideTip);
        btn.addEventListener('click', (e)=>{ e.stopPropagation(); showTip(btn, helpText); }); // 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?: 驛｢・??・?・?驛｢譏ｴ?・?郢晢??驍ｵ・??・?・?3鬩穂ｼ懶??螟ｲ・?・??・?・?鬩穂ｼ夲??・?
        labelEl.appendChild(btn);
    }
    function initTooltips(){
        try{
            const groups = document.querySelectorAll('#controls .control-group');
            groups.forEach(g=>{
                const help = g.querySelector('.help-text');
                if(!help) return;
                const text = help.textContent.trim();
                if(!text) return;
                // 驛｢譎｢・?・?驛｢譎??・取亢?・?陋ｹ・?遶擾??驍ｵ・?雋???・?髫????髯具??隴擾??郢晢??鬮?蜍溷罰郢晢??驍ｵ・?髣埼屮・?・?遶擾???・?・??・?・?郢晢??陝ｲ・??・?螳夲??證ｦ・?・?驍ｵ・?郢晢??
                let labelEl = g.querySelector('label');
                if(!labelEl){
                    // 驛｢譎｢・?・?驛｢譎??・取刮・?・?隶吝ｯ???驍ｵ・?郢晢???・?・??・?・?髯?・?陋ｹ・?郢晢??髯?閧?・?・??・?・??・?・?驍ｵ・??・?・?驛｢謨鳴驛｢譎???蛟･?・?驛｢譎｢・?・?驛｢譎??・取刮・?・?陷・?・?・?隲帛現?・?
                    labelEl = document.createElement('label');
                    labelEl.textContent = '鬮?・??・?・?髯橸??郢晢??;
                    g.insertBefore(labelEl, g.firstChild);
                }
                attachInfoIcon(labelEl, text);
            });
            // 鬨?蛹・??・?鬯?・??・?・?髯樊ｺ?謌溯??・?驍ｵ・?陷会ｽ?邵?蝣?・?譏ｴ?・?郢晢??驛｢譎｢・?・?驛｢譏ｶ?螢??暮Δ譎樊味陷?・?驍ｵ・?陋滂ｽ??・?荵・・?陋ｹ・?・守坩・?譎?蠕娯鴬驛｢譎｢・?・?髫???・?・?髯橸??陞滂ｽ??・?・?郢晢??
            document.addEventListener('touchstart', (e)=>{
                const tip = document.getElementById('globalTooltipBubble');
                if(!tip) return;
                if(e.target.closest('.info-tip')) return;
                hideTip();
            }, {passive:true});
            window.addEventListener('scroll', hideTip, {passive:true});
            window.addEventListener('resize', hideTip);
        }catch(e){ console.warn('initTooltips failed', e); }
    }
    if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded', initTooltips, {once:true});
    }else{
        initTooltips();
    }
})();
const accompPlayToggle=document.getElementById('accompPlayToggle'); // 髣・陷?逎ｯ蜈ｱ: HTML驍ｵ・?闕ｵ譎｢・?閾?・?・??・?・?髯?蜿?・?竏晄?る寞繧・樟?擾??
// Bluetooth驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?・趣??驛｢・??・?・?鬮?・?隲?肩・?・??・?・?郢晢??郢晢??I鬯?・??・?・?髯?讎?｡・・?・?郢晢??
let btLatencyEnabled=false; // 髫??会ｽ?・?髯橸??陷夲??FF
let btLatencySec=0.08;      // 髫?證ｦ・?・?髯橸??陞｢・?邵?螳壼初鬯・??・?讙趣??・?郢晢??
const engineSelect=null; // 鬯?・??・?・?髮・陞ｳ・?遶城メ・?螢?諢オ驍ｵ・??・?・?髯?蜿?・?竏晄?・
// BT鬮?・?隲?肩・?・??・?・?UI郢晢??郢晢??ndex.html髯晢???・?・?鬮?・??・?・?郢晢??郢晢??
const btLatencyToggle=$('btLatencyToggle');
const btLatencySlider=$('btLatencySlider');
const btLatencyValue=$('btLatencyValue');
const btLatencyCalibBtn=$('btLatencyCalibBtn');
const btCalibStatus=$('btCalibStatus');
const guideVol=$('guideVolumeSlider'),accompVol=$('accompVolumeSlider');
const guideLineWidthSlider=$('guideLineWidthSlider');
// 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髮朱?会ｽ?・?髯晢???・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?
const timelineScroll = document.getElementById('timelineScroll');
// --- 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?鬯?・?陋滂ｽ??・?? 70% 髯滓汚??・?髯具???・?・? (髣皮甥蝪?I鬯?・?陋滂ｽ??・??驍ｵ・?隰疲?ゑｽ?・?陷会ｽ?遶擾??驍ｵ・??・?・?驛｢・?郢?莨夲??・??・?・?髣???郢晢?? ---
function enforceTimelineHeight(){
    try{
        const cc=document.getElementById('chartContainer');
        if(!cc) return;
        const vh = window.innerHeight || document.documentElement.clientHeight || 0;
        if(!vh) return;
        const target=Math.round(vh*0.70);
        // 驛｢・??・?・?驛｢譎｢・?・?驍ｵ・?隰疲?ゑｽ?・??・?・?驍ｵ・?鬮?・??・?讚∵??・?・?髯?・?陋ｹ・?郢晢??驍ｵ・??・?・?髯??陝雜｣・?・??・?・?髯橸??郢晢??
        const curH = cc.getBoundingClientRect().height||0;
        if(Math.abs(curH-target)>4){
            cc.style.height=cc.style.maxHeight=cc.style.minHeight=target+'px';
        }
    }catch(_){ }
}
window.addEventListener('resize', ()=>enforceTimelineHeight());
window.addEventListener('orientationchange', ()=>setTimeout(enforceTimelineHeight,180));
setTimeout(enforceTimelineHeight,120);
const guideToggle=$('guideToggle'),accompToggle=$('accompToggle');
const pedalToggle=null; // 驛｢譎擾??・?郢・驛｢譎｢・?・?UI驍ｵ・??・?・?髯?蜿?・?竏晄?・
// 髫??会ｽ?・?鬮?・?隲帷???・?鬮?髦??・?霎溷?ゑｽ?譎?樟?主??・?譏ｴ?・?邵?郢肘驍ｵ・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?髯具??郢晢??
const trackToggle=null,trackPanel=null;
const melodySel=null,accompSel=null,trackApply=null;
const trackInstrumentGrid=null;
const micBtn=$('micPermissionBtn');
const micDisconnectBtn=$('micDisconnectBtn');
const pitchOnlyModeBtn=$('pitchOnlyModeBtn');
const markerCfg={A:['markerA_set','markerA_play'],B:['markerB_set','markerB_play'],C:['markerC_set','markerC_play'],D:['markerD_set','markerD_play'],E:['markerE_set','markerE_play'],F:['markerF_set','markerF_play'],G:['markerG_set','markerG_play']};
// 鬮?????・?髯?莨夲??・?
const showNoteNamesToggle=$('showNoteNamesToggle');
const micLevelBar=$('micLevelBar'),micDbText=$('micDbText');
const micGateLine=$('micGateLine');
const resonanceMixSlider=$('resonanceMixSlider');
// 驛｢・??・?・?驛｢譎擾??・?郢晢??驛｢・??・?・?驛｢・??・?・?UI
const adviceBtn=$('adviceBtn');
// 髯憺屮・?・?鬩慕甥・?闌ｨ・?・??・?・?鬩怜綜邇⑩
const practiceModeOn=$('practiceModeOn');
const practiceModeOff=$('practiceModeOff');
const practicePatternSelect=$('practicePatternSelect');
const practicePauseBtn=$('practicePauseBtn');
const practiceStopBtn=$('practiceStopBtn');
const practiceStartBtn=$('practiceStartBtn');
const practiceRangeWrap=$('practiceRangeWrap');
const practiceRootSel=$('practiceRootSel');
const practiceKeyModeSel=$('practiceKeyMode');
const practiceSeventhChk=$('practiceSeventh');
const practiceFromSel=$('practiceFromSel');
const practiceToSel=$('practiceToSel');
const practiceBpmEl=$('practiceBpm');
const practiceVolWrap=$('practiceVolWrap');
const practiceCallVolEl=$('practiceCallVol');
const practiceChordOptsWrap=$('practiceChordOptsWrap');
const practiceSixthChk=$('practiceSixth');
const practiceToolbar=document.getElementById('practiceToolbar');
const practiceCloseBtn=document.getElementById('practiceCloseBtn');
// 髯?蛹??・?郢晢??鬯???隱??・?・??・?・?髯?驛∬??・?・?陋ｹ・?郢晢??驛｢譏ｴ?・?郢晢??驛｢譎?蠕?・?髯??郢晢??郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?惧?・?・?陝ｲ・??・?螳壼?・?・隰梧??・?・?陷会ｽ?遯?・?驍ｵ・?驗呻???・?・?
const practiceTopGroup = practiceModeOn ? practiceModeOn.parentElement : null;
// --- 驛｢譎???・?・取刮・?譏ｶ?螢??､驛｢譎｢・?・?驛｢譏ｴ?・?UI 髯具??隴・隰・髯具??郢晢??---
try{
    if(melodyPartSelect){ melodyPartSelect.value=String(currentMelodyPart); melodyPartSelect.addEventListener('change',()=>{
        const v = parseInt(melodyPartSelect.value)||0; currentMelodyPart = Math.max(0, Math.min(3, v));
        const p = melodyParts[currentMelodyPart]||{};
        if(partNotesToggle) partNotesToggle.checked = !!p.showNotes;
        if(partPlaybackToggle) partPlaybackToggle.checked = !!p.playAudio;
        currentTracks = [{name:`Melody P${currentMelodyPart+1}`, notes: (p.notes||[])}]; melodyTrackIndex = 0; melodyNotesExtracted = true;
        autoCenterFrozen=false; autoCenterMelodyTrack(); drawChart();
    }); }
    if(partNotesToggle){ partNotesToggle.checked = !!(melodyParts[currentMelodyPart]?.showNotes); partNotesToggle.addEventListener('change',()=>{ const p=melodyParts[currentMelodyPart]; if(p) p.showNotes=!!partNotesToggle.checked; drawChart(); }); }
    if(partPlaybackToggle){ partPlaybackToggle.checked = !!(melodyParts[currentMelodyPart]?.playAudio); partPlaybackToggle.addEventListener('change',()=>{ const p=melodyParts[currentMelodyPart]; if(p) p.playAudio=!!partPlaybackToggle.checked; }); }
}catch(_){ }
// ---- 髯憺屮・?・?鬩慕甥・?闌ｨ・?・??・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譏ｴ?・?state ----
// 驛｢譏???・?邵?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?驛｢・?陋ｹ・??・?蛛ｽI鬮?・??・?・?鬩穂ｼ夲??・?髯具??郢晢??陝蟶・・?陋ｹ・?・主??・?譎｢・?・?驛｢謨鳴驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎牙愛陷・??驍ｵ・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?/7th/6th驛｢・?陞ｳ螟ｲ・?・??・?・?鬩穂ｼ夲??・?郢晢??郢晢??
try{
    if(practicePatternSelect){
        practicePatternSelect.addEventListener('change', ()=>{
            const v = practicePatternSelect.value;
            const show = (v==='chordPractice' || v==='chordPracticeRandOrder');
            if(practiceChordOptsWrap){ practiceChordOptsWrap.style.display = show? 'inline-flex': 'none'; }
        });
        // 髯具??隴・隰・髯?・?髢?・?闕ｳ?
        (function(){ const v=practicePatternSelect.value; const show=(v==='chordPractice' || v==='chordPracticeRandOrder'); if(practiceChordOptsWrap) practiceChordOptsWrap.style.display = show? 'inline-flex':'none'; })();
    }
}catch(_){ }

// 驛｢譎???・?邵??驛｢・??・?・?鬮?・??・?・?髯?・??・?・?/髯句??繩??・?・??・?・?驛｢譎?鯵邵?・?驛｢譎｢・?・?驍ｵ・??・?・?鬩搾??陷・?・?・?郢晢??
try{
    if(micBtn){
        micBtn.addEventListener('click', async ()=>{
            try{ activateAudioOnce(); }catch(_){ }
            if(IS_MOBILE){
                try{ _micDevicesCache = await enumerateMicInputs(); }catch(_){ }
                openMicPicker();
            } else {
                // PC驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?隴擾??郢晢??驍ｵ・??・?・?驍ｵ・??・?・?髯具??隴・隰・髯具??陷???・?・?陋ｹ・?郢晢??驛｢譎?蠕娯鴬驛｢・??・?・?鬯?蛹・??・?髫?螢?・?・?郢晢??髣???陝雜｣・?・?郢晢???・?・?郢晢??
                _userExplicitMicInit=true;
                await initMic(true);
            }
        });
    }
    if(micDisconnectBtn){ micDisconnectBtn.addEventListener('click', ()=>{ try{ stopMic(); }catch(_){ } }); }
    if(pitchOnlyModeBtn){
        pitchOnlyModeBtn.addEventListener('click', async ()=>{
            try{ activateAudioOnce(); }catch(_){ }
            // 驛｢譎?樟邵?蝣?・?譎｢・?・?: ON驕ｶ雍???・?FF驕ｶ雍???・?N ...
            isPitchOnlyMode = !isPitchOnlyMode;
            // UI髯?・?髢?・?闕ｳ?
            try{
                pitchOnlyModeBtn.classList.toggle('active', isPitchOnlyMode);
                pitchOnlyModeBtn.title = isPitchOnlyMode? '鬯?・??・?・?鬩墓ｨ費??譁溽坩・?譎｢・?・?驛｢譎?????・??・?・?郢晢??陋ｹ・?邵?驢搾??譎｢・?・?驛｢譏ｴ?・?邵?驢搾??・??・?・?鬩搾??郢???・?・?郢晢???・?・?郢晢?? : '鬯?・??・?・?髮・髣??会ｽ?螳壽割?・?・?驛｢・?闕ｳ蟯???驍ｵ・?遶丞｣??・?驛｢・??・?・?驛｢・??・?・?驍ｵ・??・?・?鬯?・??・?・?鬩墓ｨ費??譏ｶ蜻?驍ｵ・?闔会ｽ??・?蟶晏搦陋滂ｽ?????驛｢譎｢・?・?鬮?・??・?・?鬩穂ｼ夲??・?驍ｵ・?陷会ｽ?遶擾??驍ｵ・?陷?・??・?・?闔・?郢晢??鬨??難??蛟･?・?髴取ｻゑｽ?・?鬯?・??・?・?郢晢??郢晢??;
            }catch(_){ }
            // 鬩搾???・?・?鬯?・?郢晢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕?・?驍ｵ・??・?・?髫?諤懷???・?・?隰費??郢晢??驍ｵ・?雋?∞???鬯?・??・?・?驍ｵ・?郢晢??
            try{ if(editToolbar){ editToolbar.classList.add('hidden'); editToolbar.style.display='none'; } }catch(_){ }
            // 鬯?・??・?・?鬩墓ｨ費??譁溽坩・?譎｢・?・?驛｢譎会ｽ?蜩?髫?蠑ｱ・・?晢??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎???・??鬩搾???・?・?鬩怜綜邇⑩驍ｵ・??・?・?髮趣??陋ｹ・??・??驍ｵ・??・?・?驍ｵ・?郢晢???・?・?闔・?郢晢??髯・闔ｨ諛ｷ・??郢晢??郢晢??
            // 髯??陷?・?陷・??髴托ｽ??・?・?髫?・?闕ｵ譎｢・?螳壽・陋ｹ・??・?蜀暦??・?陝ｶ蜻?・??: ON驍ｵ・??・?・?驛｢・?髣・??郢晢??髯??趣???青螳壽呵悋??陷・??驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟?つ?・?・?FF驍ｵ・??・?・?驛｢・?霑壼整驟ｪ髮・?・?・?
            if(isPitchOnlyMode){
                // 驛｢譎???・?邵??驛｢・??・?・?驍ｵ・?隴?・?隰費??髯具??隴・隰・髯具??隰費??遶企?・?・?陝ｲ・?郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ?郢晢??驍ｵ・??・?・?驍ｵ・?陷会ｽ?邵?蟶晏惡?・?・?鬮?・?鬲・?夲??・?鬩・?・?・??・?・?髯?・??・?・?髮九?迴?遶擾??驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?鬮?・?郢晢??驍ｵ・??・?・?郢晢??郢晢??
                try{ if(!micAnalyser || !micData){ const ok=await canInitMicWithoutPrompt(); if(ok){ await initMic(false).catch(()=>{}); } } }catch(_){ }
                if(!isPlaying){ startPlayback(); }
            } else {
                // 鬯?・?陞｢・??・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎擾??・?遶城メ・??会ｽ?・?驍ｵ・?陷?・??・?・?鬩帚??・?髯??趣???青蝣?・?・??・?・?鬯?・??・?・?髯橸???・?・?驍ｵ・??・?・?鬯?????・?驛｢・?陝ｲ・??・??驍ｵ・??・?・?驍ｵ・?郢晢???・?・?郢晢??
                if(isPlaying){ pausePlayback(); }
                drawChart();
            }
        });
    }
}catch(_){ }
let practiceMode='off'; // 'off' | 'basic'
let isPracticing=false;
// 髯憺屮・?・?鬩慕甥・?闌ｨ・?・??・?・?鬩怜生?・? 髫俶誓??・?鬩墓?・?・?鬩搾??郢晢??call)驍ｵ・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§邵?蜥擾??譎???譁石夂ｹ晢??鬩・?・?・?闕ｵ譏ｶ陞ｺ鬨?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?郢晢??雎ｬ・?驍ｵ・??・?・?髯樊ｺ?・?・?遶擾??驍ｵ・??・?・?驍ｵ・?郢晢???・?・?郢晢??
let practiceCallDisplayOctShift = 0; // 髯?髮・??・?・?郢晢?? 髯?雍???竏ｵ・?・?郢晢??騾趣??・つ陞｢・??・?・??・?・?驍ｵ・??・?・??・?繧托ｽ?・?12驍ｵ・??・?・?髯区??縺冶?溷???・?郢晢??
let practiceRAF=0;
let practiceStartPerf=0;
let practiceBaseSongTime=0;
let practiceTempoBpm=80;
let practiceLoopTimer=null;
let practicePaused=false;
let practicePauseAt=0; // song time when paused
let practiceCallGain=null; // dedicated gain for call playback
let practiceScheduledNotes=[]; // {when, stopAt, src?, gain?}
let practicePlan=[]; // [{idx,midi,timeSong,duration,role}]
let practiceEndSongTime=0; // absolute song time of practice end
let practiceBaseAudioTime=0; // AudioContext.currentTime corresponding to practiceBaseSongTime
let practiceCallSchedTimer=null; // interval id for rolling scheduler
const PRACTICE_SCHED_AHEAD=0.6; // seconds ahead to schedule call notes
let practiceScheduledSet=new Set(); // keys of scheduled plan items (idx)
let practiceMutedUntil=0; // audio time until which call gain is held at 0 (for pause masking)

// =============================
// UI: 驛｢譎?鯵邵?・?驛｢譎｢・?・?髫?竏?・??・?・?陷会ｽ?郢晢??鬮?・??・?・?髯??趣??譁石?驛｢・??・?・?驛｢譏ｴ?・?郢晢??
// - 髯?・?郢晢??郢晢??驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏???・??・?・?郢晢??鬯?・?陋滂ｽ??・??驍ｵ・??・?・?髯?・?陟托??遶擾??驛｢・?闕ｵ譎｢・?閧?・?・?郢晢??遶企豪・?譎????青ｰ驛｢譎｢・?・?驛｢譎?樟邵?遉ｼ・?・??・?・?驛｢・??・?・?驛｢・?陜｣・??・?・??・?・?髯・郢晢??
// - 驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・?郢晢??郢晢??驛｢・??・?・?驛｢・??・?・?驛｢譏???・??・?・?騾???陝ｲ・?驍ｵ・??・?・?驛｢・?郢?螂???・??・?・?髯溯?・・?
// =============================
(function initAutoFitButtons(){
    try{
    const vw = Math.max(320, Math.min(1200, (window.innerWidth||360)));
    const MIN_PX = vw <= 360 ? 7 : 8; // 鬮?諛?・??・?・?陷諤懈?鬯?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?7px驍ｵ・??・?・?驍ｵ・??・?・?鬮?・??・?・?髯橸???・?・?
        const MAX_ITER = 9; // 髣・隰疲?・・?髫?證ｦ・?・?鬩肴得??・?驍ｵ・??・?・?鬩幢???・?・?驛｢・?鬯伜???・?隴∵腸・??髯?軸・?鬘??
    const FIT_SELECTOR = 'button:not([data-no-autofit="true"])';
        const buttons = Array.from(document.querySelectorAll(FIT_SELECTOR));

        // 1. 髯具??隴・隰・驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?髣皮甥???・?・?髮懶???・?・?陋ｹ・?邵?讙趣??譎｢・?・?驛｢譎?蠕?・?驛｢譎???驥・??・?譎｢・?・?髫?螟ゑ??・??・?・??・?・?郢晢??郢晢??
        for(const btn of buttons){
            // 髫??会ｽ?・?髯・陋滂ｽ?郢晢??UI驛｢譏ｴ?・?邵?蛟｡・?・??・?・?驛｢譎｢・?・?驛｢・?髮区??・?・??・?・?驍ｵ・?髴域喚?驢搾??・?郢晢???・?・?郢晢??陝ｲ?驍ｵ・??・?・?髯橸??霑壼??・?驍ｵ・??・?・?髫?謔ｶ?・??・?・?郢晢??
            btn.style.overflow = btn.style.overflow || 'hidden';
            // 鬯?・?陋滂ｽ??・??髯懈圜・?・?髯橸??陞溘ｑ??・??・?・?驍ｵ・??・?・?驛｢譎?鯵邵?・?驛｢譎｢・?・?驍ｵ・??・?・?髫?・??・?・?鬮?・?陟募?個蟶晢??・?陋滂ｽ??・??驍ｵ・?隰疲?ゑｽ?・?陷会ｽ?遶擾??驛｢・?闕ｵ譏ｶ?螳壽?・・?・?驛｢・?陟暮?会ｽ?迢暦??・?雋?∞??? nowrap 髯???・?・?髯?蛹??・?
            if(!btn.style.whiteSpace) btn.style.whiteSpace = 'nowrap';
            if(!btn.style.textOverflow) btn.style.textOverflow = 'ellipsis';
            if(!btn.style.alignItems) btn.style.alignItems = 'center';
            if(!btn.style.justifyContent) btn.style.justifyContent = 'center';
            if(!btn.style.display){
                // 髫??会ｽ?・?髯・陷?・粘驍ｵ・??・?・? inline-flex 髫?謔ｶ?・??・?・?陞｢・??・?・?陋ｹ・?遶擾??驍ｵ・??・?・?鬩阪???・?陜ｨ蝣?・?・?隰疲?ゑｽ?・?陞｢・??・?讓抵??・?陟募仰遶擾??隰費??髫?謔ｶ?・??・?・?陞｢・?陷・??驍ｵ・??・?・?驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?
                btn.style.display = 'inline-flex';
            }
            ensureInnerWrapper(btn);
        }

        function fits(btn, inner){
            // 髯??郢晢??郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・?霑ｹ螢??・?髴取ｻゑｽ?・?髯晢??郢晢??max-content)驍ｵ・?鬮?・?遶???・?譎?鯵邵?・?驛｢譎｢・?・?髯??郢晢???・?・??・?・?驛｢・?陷?闌ｨ・?・?驕呈汚??・?郢晢??
            const EPS = 0.5;
            const cs = getComputedStyle(btn);
            const padX = parseFloat(cs.paddingLeft||0) + parseFloat(cs.paddingRight||0) + parseFloat(cs.borderLeftWidth||0) + parseFloat(cs.borderRightWidth||0);
            const padY = parseFloat(cs.paddingTop||0) + parseFloat(cs.paddingBottom||0) + parseFloat(cs.borderTopWidth||0) + parseFloat(cs.borderBottomWidth||0);
            const availW = Math.max(1, btn.clientWidth - padX);
            const availH = Math.max(1, btn.clientHeight - padY);
            // max-content 驍ｵ・??・?・?鬮?・??・?・?髴取ｻゑｽ?・?髯晢??郢晢???・?螳・蜍溷???・??
            const prevWidth = inner.style.width;
            inner.style.width = 'max-content';
            const needW = inner.scrollWidth;
            const needH = inner.scrollHeight;
            inner.style.width = prevWidth || '';
            return (needW <= availW + EPS) && (needH <= availH + EPS);
        }

        function ensureInnerWrapper(btn){
            // 驛｢譎?鯵邵?・?驛｢譎｢・?・?髯??郢晢???・?・??・?・?驛｢・?陋幢??邵?蟶?・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?髯具???・?・?髯溷桁??・?鬨?蛹・??・?驍ｵ・??・?・?髯??郢晢??郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??驛｢譎｢・?・?驍ｵ・??・?・?髯具??郢晢??郢晢??郢晢??陜捺?・飴髯・陷?・粘驍ｵ・??・?・?驍ｵ・??・?・?髣・陷?逎ｯ蜈ｱ鬩搾???・?・?髫?謔ｶ?・??・?・?郢晢??
            if(btn.__afInner) return btn.__afInner;
            const inner = document.createElement('span');
            inner.className = '__af-inner';
            inner.style.display = 'inline-flex';
            inner.style.alignItems = 'center';
            inner.style.gap = '6px';
            inner.style.whiteSpace = 'nowrap';
            inner.style.lineHeight = 'inherit';
            inner.style.transformOrigin = 'center center';
            inner.style.willChange = 'transform';
            inner.style.width = '100%';
            inner.style.maxWidth = '100%';
            inner.style.overflow = 'visible';
            // 髫??会ｽ?・?髯・陋滂ｽ?郢晢??髯・髣??湖驛｢譎｢・?・?驛｢譎擾??・??・?蝣?・?・?陷?・?遶冗距??・??・?・?鬩募???・?髯?髦??・?
            while(btn.firstChild){ inner.appendChild(btn.firstChild); }
            btn.appendChild(inner);
            btn.__afInner = inner;
            return inner;
        }

        function fitOne(btn){
            // 鬯?・?隶・?・?・??・?・?鬩穂ｼ夲??・?郢晢??郢晢??isplay:none 鬩???闔ｨ螟ｲ・?・?陝ｲ・?隨・??驍ｵ・??・?・?髮九ｑ??・?驛｢・?陟募???驢搾??・?郢晢??隨??驛｢・?遶丞｣?笳矩Δ???・?・?驛｢譏ｴ?・?郢晢??
            const cs = getComputedStyle(btn);
            if(cs.display === 'none' || btn.clientWidth === 0 || btn.clientHeight === 0){
                return; // 髫?・??・?・?髯?軸・?・?郢晢??Resize驍ｵ・??・?・?髯??陝雜｣・?・??・?・?鬮?・?郢晢??
            }
            const inner = ensureInnerWrapper(btn);
            // 髯?蛹??・?郢晢??驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎?樟邵?遉ｼ・?・??・?・?驛｢・??・?・?郢晢??闔蛹・??・?闔ｨ竏晏???晢??陝ｲ・??・?螳壽╂鬮???・?・?郢晢??
            const basePx = parseFloat(cs.fontSize) || 12;
            // 鬩????・?・?髫?蟷?・?・?驍ｵ・??・?・?驛｢・?陋ｹ・??・?鬘伜ｴ戊ｭ・隰・驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎?樟??・?鬯?遨ゑｽ?・??・?・??・?・?驍ｵ・??・?・?髯懶???・?・?髯?・?陋ｹ・?遯?・?驍ｵ・?郢???・?迢暦??・?雋?∞??竏ｫ・?・?遶擾??隶捺??讌懆?・??陜趣??驍ｵ・??・?・?髣???闔ｨ竏晏?憺Δ??陋幢??邵?驢搾??譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?
            const maxPx = Math.min(basePx, 14);
            let low = MIN_PX, high = Math.max(MIN_PX, Math.min(64, maxPx));

            // 髣???・つ髫??会ｽ?・?髣???闔ｨ竏晏?憺し???・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??
            btn.style.fontSize = high + 'px';
            inner.style.transform = 'scale(1)'; // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・?郢??・取㏍・?・??・?・?驛｢譏ｴ?・?郢晢??
            // 驍ｵ・?陷?・?邵?蝣?・?・??・?・?髯?・?陟托??遶擾??驛｢・?陷?・??・?・??・?・?髯?・?陋ｹ・?郢晢??鬩搾??郢???・?・?郢晢???・?・?陋ｹ・?邵?蝣?・?・?鬮?・??・?迢暦??・??・?・?驍ｵ・?陞滂ｽ??・?・??・?・?驍ｵ・?鬮?・??・?・?郢晢??郢晢??
            if(fits(btn, inner)) return;

            // 髣・隰疲?・・?髫?證ｦ・?・?鬩肴得??・?驍ｵ・??・?・?髫????髯樊ｻゑｽ?・?驍ｵ・??・?・?髯?・?陟托??遶擾??驛｢・?闕ｵ譏ｴ・?驛｢・??・?・?驛｢・??・?・?驛｢・?陷?閧?邊?し??郢晢??
            let best = MIN_PX;
            for(let i=0;i<MAX_ITER;i++){
                const mid = Math.floor((low + high) / 2);
                btn.style.fontSize = mid + 'px';
                if(fits(btn, inner)){
                    best = mid;
                    low = mid + 1; // 驍ｵ・?髴???・?閾?・?・??・?・?髯樊ｻゑｽ?・?驍ｵ・?鬮?・??・?・?驍ｵ・??・?・?驍ｵ・?鬮?・??・?迢暦??・?陋ｹ・?霎ｷ・?驛｢・?郢晢??
                } else {
                    high = mid - 1; // 髯・闕ｳ螂????驍ｵ・?闕ｳ蟯???驛｢・?郢晢??
                }
            }
            btn.style.fontSize = Math.max(MIN_PX, Math.min(best, maxPx)) + 'px';

            // 驍ｵ・?隴擾???・?讙趣??・??・?・?驛｢・?郢???・?・?郢晢??鬯?・?陋滂ｽ??・??驍ｵ・?隰疲?佩鈴し??闕ｵ譏ｶ?讌｢・???・?・?驛｢・?陟暮?会ｽ??匁捗?・?・?髯?・?郢晢??
            // 驛｢譏???・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?/驛｢譎?鯵郢晢??驛｢謨鳴驛｢譎｢・?・?驛｢・?陞ｳ蝣仰郢晢??郢晢??驍ｵ・?陷会ｽ?遯?・?髯??郢晢???・?・??・?・?驛｢・?陞ｳ螟ｲ・?・?霑｢證ｦ・?・?鬮?・??・?繧会ｽ?・?郢晢??
            const padX = parseFloat(cs.paddingLeft||0) + parseFloat(cs.paddingRight||0) + parseFloat(cs.borderLeftWidth||0) + parseFloat(cs.borderRightWidth||0);
            const padY = parseFloat(cs.paddingTop||0) + parseFloat(cs.paddingBottom||0) + parseFloat(cs.borderTopWidth||0) + parseFloat(cs.borderBottomWidth||0);
            // 髣???・つ髫??会ｽ?・?髫????髯樊ｻゑｽ?・?髯具??隰費???・??驍ｵ・??・?・?髯橸??雋????・?・??・?・?驛｢・?陷?闌ｨ・?・??・?・?驛｢・?郢晢??
            inner.style.transform = 'scale(1)';
            inner.style.width = 'max-content';
            const availW = Math.max(1, btn.clientWidth - padX);
            const availH = Math.max(1, btn.clientHeight - padY);
            const needW = inner.scrollWidth;
            const needH = inner.scrollHeight;
            const scale = Math.min(1, availW / needW, availH / needH);
            // 驛｢譎?樟郢晢??驛｢譎丞ｹ?郢晢??驛｢譎｢・?・?髯??郢晢??郢晢??髣????・?・?鬮?陬・螢??・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯?・??・?・?鬮?・??・?・?髫?・??・?・?髯???・?・?髯?蛹??・? scale 驍ｵ・??・?・?髣????・?・?驛｢・?闕ｳ蟯???驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎???・?・??・?・?髯・闕ｳ鄙ｫ?・?鬩???郢晢??陝ｲ?驍ｵ・??・?・?髮・?・?・?驛｢・?遶丞､?・??
            const inTopBar = btn.closest('#top-bar') != null;
            if(!inTopBar && scale < 1){
                // 髯晢???・?・?髫俶誓??・?髴難???・?・?驍ｵ・??・?・?鬩搾???・?・?髯・闕ｳ螂????驍ｵ・?遶乗?萓?髯句??・?・?驍ｵ・??・?・?驛｢譏ｴ?・?邵?蜀暦??・??・?・?驛｢譎?樟??・?鬮?蜍溷罰郢晢??驛｢・?陟募???驢搾??・?郢晢???・?閧?・?・?郢晢??遶・
                inner.style.width = '100%';
                inner.style.transformOrigin = 'left center';
                inner.style.transform = `scale(${Math.max(0.6, scale)})`;
            } else {
                inner.style.width = '100%';
                inner.style.transform = 'scale(1)';
            }
        }

        // 髯具??隴惹?橸??骰具??譎???譁絶襖驛｢譏ｴ?・?郢晢??
        function fitAll(){
            for(const btn of buttons){
                fitOne(btn);
            }
        }
        fitAll();

        // 2. 驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驍ｵ・??・?・?髯??鬮?・?郢晢??驛｢・??・?・?驛｢譏ｴ?・?郢晢??郢晢??陋ｹ・?郢晢??驛｢譎?蠕娯斡驛｢譎｢・?・?驛｢・??・?・?郢晢??郢晢??
        let resizeTimer = 0;
        window.addEventListener('resize', ()=>{
            if(resizeTimer) cancelAnimationFrame(resizeTimer);
            resizeTimer = requestAnimationFrame(()=>{
                fitAll();
                resizeTimer = 0;
            });
        }, { passive: true });

        // 3. 髯?・?郢晢??郢晢??驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?髯樊ｺ?逕･陜滂ｽ?鬨?・??・?・?鬮?蜍溽?・・?・?闔・?・つ陷?・?隰???驍ｵ・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏???・??・?・?霑壼雀?・し???・?・?驛｢・?郢?螂???・??・?・?髯滓坩螻??・?・?郢晢??
        // ResizeObserver: 鬨?・??・?・?髫?證ｦ・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?髫?蜴・??・?髫???・?・?驍ｵ・?陷?・??・?迢暦??・??・?・?髯??鬮?・?・取ｨ抵??・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎???・?螳壽・隴?・?隰・鬮?・?陋滂ｽ?陋ｹ・?驍ｵ・?隲?諛ｶ・?・?陷会ｽ??・?迢暦??・?雋?∞??竏ｫ・?・?邵?髯?F驍ｵ・??・?・?鬯?霈?・??・?・??・?・?髯橸??雋????・?・?郢晢??
        let roPending=false; const roQueue=new Set();
        const ro = new ResizeObserver(entries => {
            for(const entry of entries){
                const btn = entry.target;
                roQueue.add(btn);
            }
            if(!roPending){
                roPending=true;
                requestAnimationFrame(()=>{
                    try{ roQueue.forEach(el=>fitOne(el)); }finally{ roQueue.clear(); roPending=false; }
                });
            }
        });
    for(const btn of buttons){ ro.observe(btn); }

        // 4. 驛｢譎?鯵邵?・?驛｢譎｢・?・?鬯????・??・?・?闕ｵ譏ｴ?・?驛｢譏ｴ?・?邵?蜀暦??・??・?・?驛｢譎???・??髯・驛｢蠢?M驍ｵ・??・?・?髯樊ｺ?蛻?陝ｲ・?驛｢・?陜｣・?陞ｻ・?鬮??薙§?・??驍ｵ・??・?・?髯??鬮?・?郢晢??驛｢・??・?・?驛｢譏ｴ?・?郢晢??
        const mo = new MutationObserver(mutations => {
            let need = false;
            for(const m of mutations){
                if(m.type === 'characterData' || m.type === 'childList'){
                    need = true; break;
                }
            }
            if(need){ requestAnimationFrame(fitAll); }
        });
        for(const btn of buttons){
            mo.observe(btn, { subtree: true, characterData: true, childList: true });
        }

        // 5. 鬯?霈?・??・?・??・?・?驍ｵ・??・?・?鬮?????・?髯?莨夲??・?驍ｵ・?髴???・?讙趣??・?闕ｵ譏ｴ?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?驛｢・?郢???・?・??・?・?髯滂ｽ?隲幢???・?・?陜捺?督蜻?豌｣陜謎ｸ?蠢憺し???・?・?髯???・?・?鬨??郢晢???・?・?郢晢??
        const addMo = new MutationObserver(muts => {
            let added = [];
            for(const m of muts){
                m.addedNodes && m.addedNodes.forEach(node=>{
                    if(node.nodeType !== 1) return; // ELEMENT_NODE驍ｵ・??・?・?驍ｵ・??・?・?
                    if(node.matches && node.matches(FIT_SELECTOR)){
                        added.push(node);
                    }
                    // 髯・闔牙遜??・??・?・?驛｢・?郢?闌ｨ・?・?隲・?・?・??・?・?
                    const found = node.querySelectorAll ? node.querySelectorAll(FIT_SELECTOR) : [];
                    if(found && found.length){ added.push(...found); }
                });
            }
            if(added.length){
                for(const btn of added){
                    // 髯具??隴・隰・驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?
                    btn.style.overflow = btn.style.overflow || 'hidden';
                    if(!btn.style.whiteSpace) btn.style.whiteSpace = 'nowrap';
                    if(!btn.style.alignItems) btn.style.alignItems = 'center';
                    if(!btn.style.justifyContent) btn.style.justifyContent = 'center';
                    if(!btn.style.display) btn.style.display = 'inline-flex';
                    ensureInnerWrapper(btn);
                    ro.observe(btn);
                    mo.observe(btn, { subtree: true, characterData: true, childList: true });
                    fitOne(btn);
                }
            }
        });
        addMo.observe(document.body, { childList: true, subtree: true });
    }catch(e){ console.warn('AutoFitButtons init error', e); }
})();

// =============================
// UI: 驛｢譎?鯵邵?・?驛｢譎｢・?・?髣比ｼ夲??・?髯樊ｻ薙§郢晢??驛｢譎｢・?・?驛｢譎??・・/鬮?蜍溷罰郢晢??驍ｵ・?陷会ｽ?郢晢??鬮?・??・?・?髯??趣??譁石?驛｢・??・?・?驛｢譏ｴ?・?郢晢??
// - 髯・陷諤懈?鬯?・??・?・?驍ｵ・??・?・? summary 驛｢・?郢晢??label 髫?竏?・??・?・?・つ驍ｵ・?隶呵??・?・??・?・?驍ｵ・??・?・?髯?????・?驛｢・?陟募???驢搾??・?郢晢???・?閧?・?・?郢晢??1 鬮?・?陟募???讌｢諢?陟托???・?竏ｫ・?・?郢晢??
// =============================
(function initAutoFitText(){
    try{
        // 髯・?・?・?鬮?雜｣・?・?: 驛｢譎?樟郢晢??驛｢譎丞ｹ?郢晢??驛｢譎｢・?・?髯??郢晢??郢晢??驛｢譎｢・?・?驛｢譎??・取?・?竏?・??・?・?陷会ｽ?・つ遶丞｣??夐Δ譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎???郢晢??驛｢譏???・?隰・??髯句??・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎??・取刮・?・?遶擾???・?・??・?・?髯橸??陞｢・?邵?譎会ｽ?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?鬮?蜍溷罰郢晢??驍ｵ・?郢晢??驛｢譎｢・?・?驛｢譎??・・
        const FIT_TEXT_SELECTOR = [
            '#top-bar label .txt',
            '#transportBar .transport-right > div > span',
            '#controls .controls-section > summary',
            '#controls .control-group > label'
        ].join(',');

        const MIN_PX_BASE = 9; // 驍ｵ・?髦?蜻?・?迹夊р?・?・?髣???闕ｵ譏ｴ?・?髯?・??・?・?鬮?・??・?・?髫?・??・?・?髣???隲?・??・?・?郢晢??
        const vw = Math.max(320, Math.min(1200, (window.innerWidth||360)));
        const MIN_PX = vw <= 360 ? 8 : MIN_PX_BASE;
        const MAX_ITER = 9;
        const els = Array.from(document.querySelectorAll(FIT_TEXT_SELECTOR));

        // 髯具??隴・隰・驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?郢晢??郢晢??鬮?・?隰疲??・?????棔???・?・?郢晢???・?・??・?・?髯晢??郢晢??遶頑･?諢?陟托???・?竏ｫ・?・?陷茨???・?・?郢晢??
        for(const el of els){
            const cs = getComputedStyle(el);
            if(cs.whiteSpace !== 'nowrap') el.style.whiteSpace = 'nowrap';
            if(cs.overflow !== 'hidden') el.style.overflow = 'hidden';
            if(cs.textOverflow !== 'ellipsis') el.style.textOverflow = 'clip';
            // 鬮?蛹・??・?髯晢??郢晢???・?螳夲??繧托ｽ?・?驛｢・?陟暮?会ｽ?迢暦??・?陋ｹ・?遶???驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?鬮?陬懈が?・?・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§・取ｺ?・?譏ｴ?・?邵?鬘悟??郢晢??
            if(cs.display === 'inline') el.style.display = 'inline-block';
            // 100% 驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?髯晢??郢晢??遶頑･??・・?・?鬯?・?隰?・??・?・?騾趣??驍?髯?????・?髫?・??・?・?髯滓汚??・?鬯?・??・?・?髮・?・?・?郢晢??郢晢??
            if(!el.style.maxWidth) el.style.maxWidth = '100%';
        }

        function fits(el){
            // 1px 髣???陷?荳樣?・し???・?・?髯具???・?・?髯橸??陞｢・?郢晢??驛｢譎?§・取ｨ抵??・?陷?蝓滂ｽ?蟷・?・・?・?
            const EPS = 0.5;
            return (el.scrollWidth <= el.clientWidth + EPS);
        }

        function fitOne(el){
            const cs = getComputedStyle(el);
            // 鬯?・?隶・?・?・??・?・?鬩穂ｼ夲??・?驛｢・?郢晢??隨冗霜豎?・?・?髮取?・?譁?・?驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??
            if(cs.display === 'none' || el.clientWidth === 0){ return; }
            const basePx = parseFloat(cs.fontSize) || 13;
            let low = MIN_PX, high = Math.max(MIN_PX, Math.min(64, basePx));
            // 驍ｵ・??・?・?驍ｵ・?陞｢・??・?・?闔ｨ竏晏?憺し???・?・?髫??会ｽ?・?驍ｵ・?郢晢??
            el.style.fontSize = high + 'px';
            if(fits(el)) return;
            let best = MIN_PX;
            for(let i=0;i<MAX_ITER;i++){
                const mid = Math.floor((low + high)/2);
                el.style.fontSize = mid + 'px';
                if(fits(el)){ best = mid; low = mid + 1; }
                else { high = mid - 1; }
            }
            el.style.fontSize = Math.max(MIN_PX, Math.min(best, high)) + 'px';
        }

        function fitAll(){ els.forEach(fitOne); }
        fitAll();

        // 驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驍ｵ・??・?・?髯??鬮?・?郢晢??驛｢・??・?・?驛｢譏ｴ?・?郢晢??
        let resizeId=0; window.addEventListener('resize',()=>{
            if(resizeId) cancelAnimationFrame(resizeId);
            resizeId = requestAnimationFrame(()=>{ fitAll(); resizeId=0; });
        }, {passive:true});

        // 鬮?蛹・??・?驛｢・?郢晢??郢晢??鬮???・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?髯樊ｺ?逕･陜滂ｽ?驛｢・?陜｣・?陞ｻ・?鬮?霈?・?
        const ro = new ResizeObserver(()=>{ requestAnimationFrame(fitAll); });
        els.forEach(el=>{ ro.observe(el); if(el.parentElement) ro.observe(el.parentElement); });

        // 髫?竏?・??・?・?隲?諛ｶ・?・?騾???陝ｲ・?驍ｵ・??・?・?驛｢・?郢?螂???・??・?・?髯溯?・・?
        const mo = new MutationObserver(()=>{ requestAnimationFrame(fitAll); });
        els.forEach(el=> mo.observe(el, {characterData:true, childList:true, subtree:true}));

        // 髯溷供??蛟???驛｢・?髣・???・?・??・?・?髯?莨夲??・?驍ｵ・?髴???・?讙趣??・?陷?・??・?・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?驛｢・?郢?驫?螳??蛹・??・?
        const addMo = new MutationObserver(muts=>{
            let added=[];
            for(const m of muts){
                m.addedNodes && m.addedNodes.forEach(node=>{
                    if(node.nodeType!==1) return;
                    const q = node.matches && node.matches(FIT_TEXT_SELECTOR) ? [node] : [];
                    const found = node.querySelectorAll ? node.querySelectorAll(FIT_TEXT_SELECTOR) : [];
                    if(q.length) added.push(...q);
                    if(found && found.length) added.push(...found);
                });
            }
            if(added.length){
                for(const el of added){
                    const cs = getComputedStyle(el);
                    if(cs.whiteSpace !== 'nowrap') el.style.whiteSpace = 'nowrap';
                    if(cs.overflow !== 'hidden') el.style.overflow = 'hidden';
                    if(cs.textOverflow !== 'ellipsis') el.style.textOverflow = 'clip';
                    if(cs.display === 'inline') el.style.display = 'inline-block';
                    if(!el.style.maxWidth) el.style.maxWidth = '100%';
                    ro.observe(el); if(el.parentElement) ro.observe(el.parentElement);
                    mo.observe(el, {characterData:true, childList:true, subtree:true});
                    fitOne(el);
                }
            }
        });
        addMo.observe(document.body, {childList:true, subtree:true});
    }catch(e){ console.warn('AutoFitText init error', e); }
})();

function parseNoteNameToMidi(s){
    try{
        if(typeof s==='number') return Math.max(0,Math.min(127, s|0));
        const m=String(s||'').trim().match(/^([A-Ga-g])([#bB]?)(-?\d+)$/);
        if(!m) return 60;
        const step=m[1].toUpperCase(); const base={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[step];
        const acc=m[2]==='#'?1: (m[2]==='b'||m[2]==='B'?-1:0);
        const oct=parseInt(m[3]); return Math.max(0,Math.min(127,(oct+1)*12+base+acc));
    }catch(_){ return 60; }
}

function makePracticePattern(pattern, rootMidi, span){
    const notes=[];
    const push=(m)=>notes.push(m);
    if(pattern==='ascMajor'){
        // 驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?: 0,2,4,5,7,9,11,12 ... 驛｢・?髮区??・?・?郢晢???・?・?遶擾??霎溷?ゑｽ?・??・?・?驍ｵ・?郢晢??
        const deg=[0,2,4,5,7,9,11,12];
        for(let i=0;i<span;i++){
            const off = deg[i%deg.length] + 12*Math.floor(i/deg.length);
            push(rootMidi + off);
        }
    } else if(pattern==='descMajor'){
        // 驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?髣???驕擾??陷・: 12,11,9,7,5,4,2,0 ... 驛｢・?髮区??・?・?郢晢???・?・?遶擾??霎溷?ゑｽ?・??・?・?驍ｵ・?郢晢??
        const deg=[12,11,9,7,5,4,2,0];
        for(let i=0;i<span;i++){
            const off = deg[i%deg.length] - 12*Math.floor(i/deg.length);
            push(rootMidi + off);
        }
    } else if(pattern==='chromaticAsc'){
        for(let i=0;i<span;i++){ push(rootMidi + i); }
    } else if(pattern==='chromaticDesc'){
        for(let i=span-1;i>=0;i--){ push(rootMidi + i); }
    } else if(pattern==='majorTriadBroken'){
        const third=4, fifth=7; [0,third,fifth].forEach(d=>push(rootMidi+d));
    } else if(pattern==='majorArpAsc'){
        // 髯憺屮・?・?髮・隰費??邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§郢晢??髣???・つ驍ｵ・??・?・?髣???驗呻??邵?蟶昴???・?・?鬩怜綜諷??・?・?郢晢??oot+12郢晢??郢晢??
        const base=rootMidi+12; const third=4, fifth=7, oct=12; [0,third,fifth,oct].forEach(d=>push(base+d));
    } else if(pattern==='majorArpDesc'){
        // 髯憺屮・?・?髮・隰費??邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§郢晢??髣???・つ驍ｵ・??・?・?髣???驗呻??邵?蟶昴???・?・?鬩怜綜諷??・?・?郢晢??oot+12郢晢??郢晢??
        const base=rootMidi+12; const third=4, fifth=7; [0,fifth,third,0].forEach(d=>push(base+d));
    } else if(pattern==='chordPractice'){
        // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・??・?・?鬩怜雀?・?郢晢??驍ｵ・?髦?蜻?・??驍ｵ・??・?・?驍ｵ・??・?・?鬩????・?・?鬯?貊難??鄙ｫ?・?驛｢・?陞ｳ螟ｲ・?・?隴∫????郢晢??闔・??・?・?雋?陜ｨ?驍ｵ・??・?・?鬨??難??阮・・?驍ｵ・??・?・? startBasicPractice 髯??郢晢??邵?蟶晏距陟募ｨ?魘ｬ郢晢??郢晢??
        // 髯?・??・?・?驍ｵ・??・?・?髯???・?・?驍ｵ・?隲?諛?・?驍ｵ・??・?・?髴大??・?・?髯具???・?・?髫???・?・?驍ｵ・?郢晢??隨・驛｢・?闕ｵ譏ｶ陞ｺ驛｢・?遶丞｣??・?驛｢譎丞ｹ?・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎擾??蜴?譎会ｽ?謨鳴
        return [];
    } else {
        for(let i=0;i<8;i++) push(rootMidi+i);
    }
    return notes;
}

function parseFromTo(){
    try{ const a=practiceFromSel?.value||'C5'; const b=practiceToSel?.value||'B5';
        let low = parseNoteNameToMidi(a), high = parseNoteNameToMidi(b);
        if(high<low){ const t=low; low=high; high=t; }
        return [low, high];
    }catch(_){ return [parseNoteNameToMidi('C5'), parseNoteNameToMidi('C6')]; }
}

function startBasicPractice(){
    if(isPracticing) return;
    ensureAudio();
    // 鬮?・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?: 髫俶誓??・?鬩墓?・?・?鬩搾??郢晢??call)驛｢・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎会ｽ?蜈ｷ・?・?驗呻??遶???蝗手嵯譏ｶ髮?驛｢・?陷茨???・?・?騾趣??雎ｬ・?驍ｵ・??・?・?驍ｵ・?隴擾??郢晢??驍ｵ・??・?・?驍ｵ・??・?・?郢晢??郢晢??
    practiceCallDisplayOctShift = 12;
    // 髫?證ｦ・?・?髴難???・?・?鬯?・?陷?・??・?・?郢晢?? 鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎擾??・?邵?蝣?・?・?郢?莨夲??・??・?・?鬮?・?陋ｹ・??・?蝣?・?譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??驍ｵ・?陷会ｽ?・つ郢晢??陝??伜搦陋ｹ・??・?螳夲??蟶?逕･隴??悟ｳ?郢晢??
    try{
        scoreSessionId++;
        scoreStats = { total:0, bins: Array.from({length:12},()=>({count:0,sum:0,sumAbs:0,inTol:0,outTol:0,sharp:0,flat:0})) };
        scoreDetailByOct = {};
    }catch(_){ scoreStats=null; scoreDetailByOct={}; }
    const bpm = Math.max(40, Math.min(200, parseInt(practiceBpmEl?.value||practiceTempoBpm)));
    practiceTempoBpm=bpm; const beatSec = 60 / bpm; const noteDur = beatSec;
    const rootMidi = parseNoteNameToMidi(practiceRootSel?.value||'C5');
    let keyMode = (practiceKeyModeSel?.value||'major'); // 'major' | 'minor' | 'random'
    const use7th = !!(practiceSeventhChk && practiceSeventhChk.checked);
    const use6th = !!(practiceSixthChk && practiceSixthChk.checked);
    const [low, high] = parseFromTo();
    const span = Math.max(3, Math.min(48, (high - low + 1)));
    const pat = (practicePatternSelect?.value)||'ascMajor';
    // 鬩堺?・・?髯具??郢晢???・?蟶敖・??・?・?髯橸??闔ｨ螟ｲ・?・?陞｢・?邵?諷???譎｢・?・?驛｢譎｢・?・?郢晢??郢晢??・取ｨ抵??・??・?・?驛｢譎???・趣??驛｢・??・?・?郢晢??陋ｹ・?邵??驛｢譎丞ｹ?・取㏍・?髮・・?・主?・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?郢晢??陝ｲ・??・?蟶斟?・?・?驛｢・?鬯伜???・?隴∵腸・??
    const targetSeconds = 60; const cycleBeats = 8; // 8鬯?・??・?・?=2髯・陷證ｦ・?・?・つ郢晢??郢晢??髫?・?隶主?・??・?陷亥??・?髯橸??陞滂ｽ??・?・?郢晢??
    const cycles = Math.max(1, Math.floor(targetSeconds / (cycleBeats*beatSec*2))); // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?+驛｢譎｢・?・?驛｢・??・?・?驛｢譎???・趣??驛｢・??・?・?驍ｵ・??・?・??・??郢晢??
    const sequences=[]; let startDegree=0; // 髫?・??・?・?鬯?・?陞ｳ??鬟ｭ驍ｵ・??・?・?鬯?・?陷?・??・?・?驕擾??雎ｬ・?驛｢・?陋幢??隨・驛｢・?陝ｲ・?隨・
    for(let c=0;c<cycles;c++){
        // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?: 驛｢・??・?・?驛｢譎丞ｹ?・取㏍・?・?隴?・??・?・?雎暮?会ｽ?・?郢晢??
    if(pat==='chordPractice' || pat==='chordPracticeRandOrder' || pat==='chordAllMajor' || pat==='chordAllMinor'){
            // 驛｢・??・?・?驛｢譎｢・?・?郢晢??陋ｹ・?・朱豪・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?/驛｢譎???・?邵??驛｢譎会ｽ?・?郢晢??/驛｢譎｢・?・?驛｢譎｢・?・?驛｢謨鳴驛｢譎｢・?・?郢晢??陝ｲ・?遶・7th/6th髫?蟷・・?隨乗ｪ趣??・??・?・?髯滂ｽ?隲帷腸・?驍ｵ・?雋???帝Δ???・?・?驛｢・??・?・?驛｢譎?樟郢晢??驛｢譏ｴ?・?邵???・?・??・?・?鬮?・?鬲・?夲??・?髢?・??・?・??・?・?髯・?・?・?鬮?・??・?・?鬮?・?陋??・?・?郢晢??
            const keyRootPC = (rootMidi%12+12)%12;
            const namesCDE=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
            // 髯溯??・?・?髫?・??・?・?驕ｶ鬘假??讓?ｵ?鬯?・??・?・?郢晢??郢晢??C鬯?貊難??鄙ｫ?・?郢晢??陝ｲ・?遶??晏??・?・?鬮?・?陋滂ｽ?隴幢??髫?・??・?・?
            function chordForDegree(deg){
                // deg: 0..6
                const scaleMaj=[0,2,4,5,7,9,11];
                const scaleMin=[0,2,3,5,7,8,10];
                const modeEff = (keyMode==='random') ? (Math.random()<0.5? 'major':'minor') : keyMode;
                const scale = modeEff==='minor'? scaleMin: scaleMaj;
                const rootPc = (keyRootPC + scale[deg]) % 12;
                let third = (modeEff==='minor' && (deg===0||deg===3||deg===4))? 3 : // i, iv, v in natural minor
                             (modeEff==='minor' && (deg===2||deg===5))? 4 :
                             (modeEff==='minor' && deg===6)? 3 :
                             // major key
                             (deg===1||deg===2||deg===5)? 3 : 4; // ii, iii, vi minor triads in major
                let fifth = 7;
                let quality = '';
                // diminished in major: vii?・?繧托ｽ?・?; in minor: ii?・?繧托ｽ?・? (natural)
                if((modeEff==='major' && deg===6) || (modeEff==='minor' && deg===1)){
                    fifth = 6; quality = 'dim';
                } else if((modeEff==='major' && (deg===1||deg===2||deg===5)) || (modeEff==='minor' && (deg===0||deg===3||deg===4||deg===6))){
                    quality = 'm';
                } else {
                    quality = '';
                }
                // seventh
                let seventh = null; let extLabel='';
                // 7th / 6th 髫?・??・?・?髯滓汚??・?
                if(use7th){
                    let seventhInt = (quality==='dim')? 10 : // diminished triad + m7 => m7b5 label
                                      (quality==='m')? 10 : // minor triad + m7 => m7
                                      (deg===4 && modeEff==='major')? 10 : // V7 in major
                                      (modeEff==='minor' && deg===4)? 10 : // v7 (natural minor)
                                      11; // maj7 default
                    seventh = seventhInt;
                    if(quality==='dim') extLabel = 'm7b5';
                    else if(quality==='m') extLabel = 'm7';
                    else if(seventhInt===10) extLabel = '7';
                    else extLabel = 'maj7';
                } else if(use6th){
                    // 6th: 驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?6驍ｵ・?遶丞｣??・?驛｢・??・?・?驛｢譎会ｽ?・?郢晢??驍ｵ・??・?・?m6驍ｵ・??・?・?im驍ｵ・??・?・?驍ｵ・??・?・?髣皮甥???・?・?陟托???・??驍ｵ・??・?・?驍ｵ・?郢晢??
                    if(quality!=='dim'){
                        const sixthInt = 9; // +9 semitones from root
                        seventh = null; // 7th 驛｢・?陋ｹ・??・?? 6th 驛｢・?髮区?樒?髯?蛹??・?
                        extLabel = (quality==='m') ? 'm6' : '6';
                        // pcs 驍ｵ・??・?・? later 驍ｵ・??・?・? sixth 驛｢・?髮区???・?驛｢・?陟暮?会ｽ?迢暦??・?雋?∞??竏ｫ・?・?邵?蜷ёenth 驛｢・?陷・?・?・??・?・?驛｢・?闕ｳ蟯???6th驛｢・?郢晢??push 驍ｵ・?陷?・??・??
                    }
                }
                const pcs = [rootPc, (rootPc+third)%12, (rootPc+fifth)%12];
                if(use6th && extLabel.endsWith('6')){ pcs.push((rootPc+9)%12); }
                else if(seventh!=null) pcs.push((rootPc+seventh)%12);
                // 驛｢譎｢・?・?驛｢譎??・取亢?・?髢?・??・?・??・?・?髯・?・?・?鬮?・??・?・?鬮?・?陋??・?・?郢晢??
                let label = namesCDE[rootPc] + (extLabel|| (quality==='m'? 'm': (quality==='dim'? '?・?繧托ｽ?・?': '')));
                if(use7th && quality==='dim') label = namesCDE[rootPc] + 'm7b5';
                return { pcs, label };
            }
                                    let degreeSequences=[];
                                    if(pat==='chordAllMajor' || pat==='chordAllMinor'){
                                            // 12驛｢・??・?・?驛｢譎｢・?・?髯?闌ｨ・?・?髯・?・?・?髯滂ｽ?郢晢?? 髯憺屮・?・?髮・隰費??邵?蜀暦??譎｢・?・?驍ｵ・?闕ｵ譎｢・???諤?闔ｨ竏ｵ・?・?驍ｵ・?陞｢・?隨・??髣???驗呻??遶冗｣??ｧ?・?・?髯??趣??雋ｻ・??驍ｵ・?遶乗?閠?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・? I驕ｯ・?騾??･驕ｯ・?陞滂ｽ?驕ｯ・?騾??郢晢??陋ｹ・?遶擾??驍ｵ・?雋???・? i驕ｯ・?陞ｯ・?v驕ｯ・?驕撰??驕ｯ・?陞ｯ・?郢晢??陝ｲ・??・??1驛｢・??・?・?驛｢譏ｴ?・?郢晢??
                                            const allPC=[0,1,2,3,4,5,6,7,8,9,10,11];
                                            const startIndex = keyRootPC; // 髯憺屮・?・?髮・隰費??邵?蜀暦??譎｢・?・?驍ｵ・?闕ｵ譎｢・?陋ｾ・?・?陷?・??・?・?郢晢??
                                            const order=[]; for(let i=0;i<12;i++){ order.push(allPC[(startIndex+i)%12]); }
                                            for(const pcRoot of order){
                                                    // 髣???・つ髫?蠑ｱ・芽搦・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎???・?螳壼初鬯・??・?讙趣??・?鬮?・??・??驍ｵ・??・?・?髯?・?郢晢??邵?蜀暦??譎｢・?・?驍ｵ・??・?・?鬯?・??・?・?鬮?・?陟暮?会ｽ?蟶昴♀郢晢??郢晢??
                                                    const saveRoot = keyRootPC; // 髯?・?郢?蟲??・?
                                                    const degSeq = [0,3,4,0]; // I/ i, IV/iv, V/v, I/i
                                                    // chordForDegree 驍ｵ・??・?・? keyRootPC 驛｢・?髮区?貞ｴ?恷・??・?・?驍ｵ・?陷会ｽ?遯?・?驍ｵ・?郢晢???・?迢暦??・?雋?∞??竏ｫ・?・?遶丞｣??帝Δ譎???蛟･?・?驍ｵ・??・?・?鬯?・??・?・?髫?・??・?・?髯具??隰費??邵?蜊呂髯晢???・?・?髯具??郢晢???・?蟶晢??蛹・??・?鬨?蛹・??・?
                                                    // 驍ｵ・?髦?蜻?・??驍ｵ・??・?・?驍ｵ・??・?・? degreeSequences 驍ｵ・??・?・? (pcRoot, degSeq) 驛｢・?陞ｳ螢?・?蛟ｬ竊帝ｫ?・??・??驍ｵ・?遶乗劼・?・?隴?・??・?・??・?・?驍ｵ・??・?・? pcs 驛｢・?陷・?・?・?隲帛･・??遏ｩ・?・?陝ｶ蜷??? pcRoot 驛｢・?陷・?・?・??・?・?驍ｵ・?郢晢??
                                                    degreeSequences.push({ pcRoot, degSeq });
                                            }
                                    } else {
                                            // 鬯?・??・?・?鬮?・?陟募?湖倬Δ譎｢・?・?驛｢譎丞ｹ?・取ｨ抵??譎｢・?・?驛｢譎∬??・?・?闔・??・?・??・?・?髫?・??・?・?郢晢??郢晢?? 驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?/驛｢譎???・?邵??驛｢譎会ｽ?・?郢晢??驍ｵ・??・?・?髫?・??・?・?髯?蛹??・?
                                            const templates = keyMode==='major'
                                                    ? [
                                                            [0,5,1,4], [0,3,4,0], [2,5,1,4], [0,2,5,1], [5,4,3,2],
                                                            [0,6,5,4], [3,0,4,5], [1,4,0,5], [6,2,5,1], [4,3,2,1]
                                                        ]
                                                    : [
                                                            [0,5,1,4], [0,3,4,0], [2,5,1,4], [0,2,5,1], [5,4,3,2],
                                                            [6,0,5,4], [3,0,4,5], [1,4,0,5], [6,2,5,1], [4,3,2,1]
                                                        ];
                                            degreeSequences.push({ pcRoot: keyRootPC, degSeq: templates[c % templates.length] });
                                    }
            // PC驕ｶ?托ｽ?・?IDI 髯樊ｺ?蛻?鬩?・?郢晢??髢?・??・?・?郢晢??陝ｲ?髯??郢晢??邵?螳壽╂郢?蟲??・?驍ｵ・??・?・?鬮?蜿?・?・??・?讚?ｱ?惱・??・?・?隲帛･・??螳壽・?・?・?髯・郢晢??遶城メ・?螢?・?・??・?・?郢晢??
            function nearestMidiFromPc(pc, low, high, ref){
                const center = (typeof ref==='number' && isFinite(ref)) ? ref : ((low+high)/2);
                // 鬩???郢晢??陝ｲ?髯??郢晢??郢晢??驍ｵ・?隴擾??郢晢??PC驛｢・?髮区???・?髯具??驍???髮??趣??・?陷会ｽ?遯?・?髫????驛｢・?郢晢??center 驍ｵ・??・?・?鬮?蜿?・?・??・?讓抵??・?郢??郢晢??驛｢・?陝ｶ譏ｶ?閧?・?・??・?・?
                const list=[];
                // 鬯?・?陷?・??・?・?霑｢蜉ｱ笳・ low 髣比ｼ夲??・?髣???驗呻??邵?螳夲??謔ｶ?・??・?・?陜?C驍ｵ・??・?・?驍ｵ・??・?・?驛｢・?陋ｹ・?隲?蜻??戊ｭ擾??郢晢??MIDI
                let first = low + ((pc - (low%12) + 12) % 12);
                for(let m=first; m<=high; m+=12){ list.push(m); }
                if(!list.length){
                    // 髯橸??霑壼??・?鬩???郢晢?? center 鬮?螟ｧ・?・??・?蜥?・?・?闕ｵ譎｢・?莨夲??繧托ｽ?・?髫?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎乗亜霎?・?鬩肴得??・?
                    const base=Math.round(center);
                    for(let k=-8;k<=8;k++){
                        const m=base+12*k; if(m<low-24||m>high+24) continue; if(((m%12)+12)%12===pc) list.push(m);
                    }
                }
                if(!list.length){ return Math.max(low, Math.min(high, Math.round(center))); }
                let best=list[0], bd=1e9; for(const m of list){ const d=Math.abs(m-center); if(d<bd){ bd=d; best=m; } }
                return best;
            }
            // 髫?謔ｶ?・??・?・?陜?C驍ｵ・??・?・?鬯?・??・?・?驛｢・?陋幢??・つ隰疲??竏夐ｬ?・??・?・?髣比ｼ夲??・?髣???驗呻??・つ鬮?・?邵?螳夲?????驛｢・?郢?螂???・?闔会ｽ??・?讚∵割陷?・??・?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驛｢・?陷茨???・?・?闔蛹・??・?鬯伜???・?陟募?鯉ｼ樣Δ譎｢・?・?驛｢譎擾??・?邵?螟ゑ??・??・?・?鬨?蛹・??・?郢晢??郢晢??
            function midiAtOrAbove(pc, minM, low, high){
                let m = minM + ((pc - (minM%12) + 12) % 12); // minM髣比ｼ夲??・?髣???驗呻??邵?蝣?・?・?隴擾??郢晢??PC驍ｵ・??・?・?驍ｵ・??・?・?驛｢・?陋ｹ・?隲?蜻??慕ｹ晢??
                // 鬩???郢晢??陝ｲ?驍ｵ・??・?・?髯?闌ｨ・?・?驛｢・?闕ｵ譏ｶ遨宣し???・?・?+12
                while(m<low) m+=12;
                if(m>high) return null;
                return m;
            }
            function chordForDegreeWithPcRoot(deg, pcRootOverride){
                // chordForDegree 驛｢・?郢晢??pcRootOverride 驍ｵ・??・?・?髯憺屮・?・?驍ｵ・??・?・?驍ｵ・?郢晢??遯?・?髯??陝雜｣・?・?髢?・??・?・?郢晢??
                const scaleMaj=[0,2,4,5,7,9,11];
                const scaleMin=[0,2,3,5,7,8,10];
                const modeEff = (keyMode==='random') ? (Math.random()<0.5? 'major':'minor') : keyMode;
                const scale = modeEff==='minor'? scaleMin: scaleMaj;
                const rootPc = (pcRootOverride + scale[deg]) % 12;
                // 髣比ｼ夲??・?髣???闕ｵ譏ｴ?・? chordForDegree 驍ｵ・??・?・?髯?・?隴?・??・?・?郢晢??
                let third = (modeEff==='minor' && (deg===0||deg===3||deg===4))? 3 :
                             (modeEff==='minor' && (deg===2||deg===5))? 4 :
                             (modeEff==='minor' && deg===6)? 3 :
                             (deg===1||deg===2||deg===5)? 3 : 4;
                let fifth = 7; let quality='';
                if((modeEff==='major' && deg===6) || (modeEff==='minor' && deg===1)){ fifth=6; quality='dim'; }
                else if((modeEff==='major' && (deg===1||deg===2||deg===5)) || (modeEff==='minor' && (deg===0||deg===3||deg===4||deg===6))){ quality='m'; }
                let seventh=null, extLabel='';
                if(use7th){
                    let seventhInt = (quality==='dim')? 10 : (quality==='m')? 10 : (deg===4? 10: 11);
                    seventh = seventhInt;
                    if(quality==='dim') extLabel='m7b5'; else if(quality==='m') extLabel='m7'; else if(seventhInt===10) extLabel='7'; else extLabel='maj7';
                } else if(use6th){
                    if(quality!=='dim'){
                        extLabel = (quality==='m')? 'm6' : '6';
                    }
                }
                const pcs=[rootPc,(rootPc+third)%12,(rootPc+fifth)%12];
                if(use6th && extLabel.endsWith('6')){ pcs.push((rootPc+9)%12); }
                else if(seventh!=null) pcs.push((rootPc+seventh)%12);
                let label = namesCDE[rootPc] + (extLabel|| (quality==='m'? 'm': (quality==='dim'? '?・?繧托ｽ?・?': '')));
                if(use7th && quality==='dim') label = namesCDE[rootPc] + 'm7b5';
                return { pcs, label };
            }
            // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢譎｢・?・?驛｢譏ｴ?・?邵??: 鬯?貊難??鄙ｫ?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??驛｢譎｢・?・?
            function shuffleInPlace(arr){ for(let i=arr.length-1;i>0;i--){ const j=(Math.random()* (i+1))|0; const t=arr[i]; arr[i]=arr[j]; arr[j]=t; } return arr; }
            for(const entry of degreeSequences){
                const { pcRoot, degSeq } = entry;
                for(const deg of degSeq){
                    const ch = chordForDegreeWithPcRoot(deg, pcRoot);
                // 鬮?驢搾??・?騾寂悪・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎擾??・?郢晢??驛｢譎?鯵邵??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??髢?・??・?・?郢晢??陝ｲ?髣????・?・?髯滂ｽ?郢晢???・?・?陋滂ｽ??・?・?隰・∞??・?陝ｲ・?・ゑｽ?驛｢・?髯具??陝ｷ謌?ｲり嵯譎｢・??驍ｵ・?遶擾???・?・?鬯伜???・?陟募???讌｢?慕ｹ晢??雎ｺ・?郢晢??郢晢??oot驕ｶ鄙ｫ?・?驕ｶ鄙ｫ?・?驕ｶ鄙ｫ?・?7)郢晢??郢晢??
                const center = (low+high)/2;
                const rootM = nearestMidiFromPc(ch.pcs[0], low, high, center);
                const mids=[rootM];
                for(let i=1;i<ch.pcs.length;i++){
                    const m = midiAtOrAbove(ch.pcs[i], mids[mids.length-1]+1, low, high);
                    if(m==null){
                        // 髯?・?陟托??遶擾??驛｢・?陝ｲ・?遶企?・?・?郢晢???・?・??・?・?髯?・?陋ｹ・?郢晢?? root 驛｢・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎会ｽ?蜈ｷ・?・?闕ｵ譎｢・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎?樟?主??・?・??・?・?郢晢??陜捺?ゑｽ?・??・?・?髴托ｽ??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?髯・?・?・?鬩???陷???・?・?郢晢??
                        const altRoot = nearestMidiFromPc(ch.pcs[0], low, high, rootM-12);
                        mids.length=0; mids.push(altRoot);
                        for(let j=1;j<ch.pcs.length;j++){
                            const mm = midiAtOrAbove(ch.pcs[j], mids[mids.length-1]+1, low, high);
                            if(mm==null) break; mids.push(mm);
                        }
                        break;
                    } else {
                        mids.push(m);
                    }
                }
                // 髫????髣???郢晢??鬯?・??・?・?郢晢??陋ｹ・?・取刮・?譎｢・?・?驛｢譎?樟郢晢??3髯溯??・?・?驛｢譎｢・?・?5髯溯??・?・?郢晢??陝ｲ・?郢晢??髣???隴・?・?・??・?・?
                while(mids.length<3){
                    const last = mids[mids.length-1]||rootM; const pc = ch.pcs[Math.min(mids.length, ch.pcs.length-1)];
                    const mm = midiAtOrAbove(pc, last+1, low, high); if(mm==null) break; mids.push(mm);
                }
                let seq = mids.slice(0, use7th? 4: 3); // 7th ON驍ｵ・??・?・?驛｢・?郢晢??鬯?・??・?・?
                // 髫???・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・? 驛｢譎｢・?・?驛｢譎｢・?・?驛｢謨鳴驛｢譎｢・?・?髣????・?・?驍ｵ・??・?・?
                if(pat==='chordPracticeRandOrder'){
                    // 髯?閧?・?・??・?・??・?・?鬯?・??・?・?郢晢??陋ｹ・?・取刮・?譎｢・?・?驛｢譎∬??・?・?陝ｲ・??・?螳・・?郢晢??隨・髯?・??・?・?驛｢・?・つ髯?鬘後＊驗ゑ??驍ｵ・??・?・?驍ｵ・?遶丞｢・刮・?譎｢・?・?驛｢譎???・?螳壽・?・?・?驛｢・?遶丞｣?陞ｺ驍ｵ・??・?・?驍ｵ・??・?・?鬯??郢晢???・?・?闕ｳ螂???蝣?・?・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??驛｢譎｢・?・?
                    // 驍ｵ・?雋??蜻?驍ｵ・?陷会ｽ?・つ郢晢??雎ｬ・?髯懈瑳・?蛟･?・?鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?驛｢・?陋幢??遶企?・?・?闕ｵ譏ｶ?迢暦??・?闕ｳ闌ｨ・?・?隴擾??隨・??驍ｵ・?雋?∞??竏ｫ・?・?遶丞｣?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎擾??・?郢晢??驛｢譎?鯵邵??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?髯??郢晢??邵?蝣?・?・??・?・?髣????・?・?驍ｵ・??・?・?髫?蜴・??・?驍ｵ・?陋ｹ・?郢晢??驍ｵ・??・?・?
                    // 驍ｵ・?髦?蜻?・??驍ｵ・??・?・?驍ｵ・??・?・?髯?髮・・??・?・?隴∫???鬘梧??・?・?髣???髦?蜷?笘?Δ譎｢・?・?驛｢譏ｴ?・?郢晢??驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・?陷会ｽ?・つ遶擾???・?・?雎暮?会ｽ?・?闕ｵ蜀?讌ｳ驍ｵ・??・?・?髯樊ｺ?逕･陜滂ｽ?驛｢・?陜｣・?雋坂悪・?・?郢晢??
                    seq = shuffleInPlace(seq.slice());
                }
                sequences.push({ type:'call', seq, labelName: ch.label });
                sequences.push({ type:'resp', seq });
                }
            }
        } else if(pat==='scaleUp' || pat==='scaleDown' || pat==='scaleUpDown'){
            // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?鬩搾???・?・?鬩怜綜諷??・?・?陋ｹ・?邵?遉ｼ・?・??・?・?驛｢譎?樟郢晢??髣???・つ鬮?螂???・?鬨?・?郢晢??遶???・?蜍溽?隹??鬩搾???・?・?鬩怜雀?・?遶頑･?・??陋ｹ竏ｽ・??驍ｵ・?陷?・??・?????・?・?髫?蟷?・?・?髴大?願か?・?・?郢晢??
            // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・? 驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?/驛｢譎会ｽ?・?郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎???・?邵??驛｢譎会ｽ?・?郢晢??郢晢??郢晢??andom髫?蠑ｱ・・?晢??鬯?蟷?・?・?髯溯??・?・?髫?螟ｲ・?・?鬯?蛹・??・?郢晢??郢晢??
            const scaleMaj=[0,2,4,5,7,9,11,12];
            const scaleMinNat=[0,2,3,5,7,8,10,12];
            const modeEff = (keyMode==='random') ? (Math.random()<0.5? 'major':'minor') : keyMode;
            const scale = (modeEff==='minor')? scaleMinNat: scaleMaj;
            // 髯憺屮・?・?髮・隰費??邵?蜀暦??譎｢・?・?郢晢??郢晢??ootMidi郢晢??陝ｲ・?・ゑｽ?驛｢・?陝ｲ・?邵?蟶?・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?樟郢晢??驛｢譎｢・?・?驛｢・?陜｣・??・?・?郢晢??陝ｲ?驍ｵ・?郢晢??隨・??驍ｵ・??・?・?驍ｵ・?郢晢??遶城メ讀?隴会ｽ?陝ｷ?
            const tones=[];
            // 髣???闕ｳ・?雎撰??髯句??・?・?驍ｵ・??・?・?髯橸??隴会ｽ?陝ｷ?
            for(let k=0;k>=-8;k--){ for(const d of scale){ const m=rootMidi + d + 12*k; if(m<low) continue; if(m>high) continue; tones.push(m); } }
            // 髯憺屮・?・?髮・隰費??邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎会ｽ?蜈ｷ・?・??・?・?髣???驗呻???・?繧頑､?隴会ｽ?陝ｷ?
            for(let k=1;k<=8;k++){ for(const d of scale){ const m=rootMidi + d + 12*k; if(m<low) continue; if(m>high) continue; tones.push(m); } }
            // 鬯?・?陝雜｣・?・?郢晢??郢晢??鬯??郢晢???・?・?闕ｳ螂???螳夲??・??・?・?驍ｵ・?陋ｹ・??・??
            const uniq = Array.from(new Set(tones)).sort((a,b)=>a-b);
            function mkCallSeq(){
                if(!uniq.length) return [rootMidi];
                if(pat==='scaleUp'){ return uniq.slice(); }
                if(pat==='scaleDown'){ return uniq.slice().reverse(); }
                // 髯?哩?髯溷桁??・?: 鬩????・?・?驛｢・?陝ｶ譏ｴ陬?し???・?・?驍ｵ・??・?・?驍ｵ・?郢晢??[髣???鬯伜???・?霑ｴ・? + [髣???驍?私??・?郢晢??鬩????・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??)]
                const up = uniq.slice();
                const dn = uniq.slice(0, -1).reverse();
                return up.concat(dn);
            }
            const callSeq = mkCallSeq();
            sequences.push({type:'call', seq:callSeq});
            sequences.push({type:'resp', seq:callSeq.slice()});
        } else {
            let callSeq = makePracticePattern(pat, rootMidi + startDegree, Math.min(span, cycleBeats));
            // 鬩???郢晢??陝ｲ?驍ｵ・??・?・?髯・郢晢??隨?迢暦??・?闕ｵ謨鳴郢??隨??驍ｵ・??・?・?驍ｵ・?陷会ｽ?・朱豪・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髫????鬩搾??郢??郢晢??(root+12)驍ｵ・??・?・?髣???闕ｵ譏ｶ?逎ｯ?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?驍ｵ・?陞｢・?遶頑･?・?・?闕ｵ譏ｶ??驍ｵ・?郢晢??
            callSeq = callSeq.map((n, i, arr)=>{
                let v = n;
                const isTopDo = (pat==='ascMajor' && i===arr.length-1 && Math.abs(n - (rootMidi + 12))<=0.001);
                if(!isTopDo){ while(v < low) v += 12; while(v > high) v -= 12; }
                return v;
            });
            sequences.push({type:'call', seq:callSeq});
            const respSeq = callSeq.slice();
            sequences.push({type:'resp', seq:respSeq});
            startDegree = (startDegree+1) % Math.min(span, 12);
        }
    }
    const startSong = (playbackPosition||0) + 1.0;
    const ghost=[]; const now=audioCtx.currentTime; let tCursorSong=startSong; let tCursorAudio=now+0.1;
    practicePlan.length=0; practiceScheduledSet.clear();
    // 驍ｵ・?鬯・・?遒托??蟷?・?・?鬨?蛹・??・?驍ｵ・??・?・?髯・郢?閾?闊樣Δ???・?・?驛｢・??・?・?驛｢譎｢・?・?郢晢??闔・?郢晢??髣???鬯?・?雎ｬ・?鬯?・?闕ｳ蟯??螳夲??・??・?・?鬩???陷茨???・?・?郢晢??
    if(!practiceCallGain){ try{ practiceCallGain = audioCtx.createGain(); practiceCallGain.gain.value = Math.max(0, Math.min(1, parseFloat(practiceCallVolEl?.value||'0.85'))); (masterGain||audioCtx.destination)&&practiceCallGain.connect(masterGain||audioCtx.destination); }catch(_){ } }
    let planIdx=0;
    const isScalePat = (pat==='scaleUp' || pat==='scaleDown' || pat==='scaleUpDown');
    for(const block of sequences){
        const isCall = (block.type==='call');
        // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎擾??・?・主??・?譎??・取亢?・?陋ｹ・?邵?諷???譎｢・?・?驛｢譎｢・?・?髫?蠑ｱ・・?晢??驍ｵ・??・?・?郢晢??陝ｲ・?・つ?・?・?hordPractice 驍ｵ・??・?・?髯懶???・?・?髯?・?陋ｹ・?郢晢?? block.labelName 驛｢・?髮区?樒?髯?蛹??・?
        const blockLabels = (isCall && block.labels)? block.labels : [];
        for(let i=0;i<block.seq.length;i++){
            const m=block.seq[i];
            // 鬮?・??・?・?鬩穂ｼ夲??・?驍ｵ・??・?・?髯橸??雋?陜ｨ?驍ｵ・??・?・?MIDI驛｢・?陷・?・?・??・?・?鬨?蛹・??・?郢晢??闔・??・?・??・?・?髯具???・?・?鬨?・?郢晢??遶願?5..C6驍ｵ・??・?・?驍ｵ・??・?・?髫?螢??・?驍画?抵??・??・?・?驛｢・?髮区??・?・?郢晢???・?・??・?・?郢晢??郢晢??
            let dispM = m;
            let label = null;
            // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?髣????・?・?驍ｵ・??・?・?驛｢譎?§・取ｺ?・?譏ｴ?・?邵?鬘梧??・?・?髣???髦?蜷??螳壽・陟包???・?・?・つ驛｢譎｢・?・?驛｢譎??・取刮・?・?陞ｳ螟ｲ・?・??・?・?鬩穂ｼ夲??・?郢晢??闔・?郢晢??鬯???・?・?鬯?・??・?・?驍ｵ・??・?・?驍ｵ・?闔会ｽ?邵?螳壼?慕ｹ晢???・?讙趣??・??・?・?驍ｵ・?郢晢???・?閧?・?・?郢晢??遶願侭?・?郢晢??
            if(isCall && block.labelName){ label = { name: block.labelName }; }
            else if(blockLabels && blockLabels.length){ label = blockLabels.find(lb=> Math.abs((lb.at||0) - tCursorSong) < 1e-6); }
            // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?鬩搾???・?・?鬩怜生?・? 驍ｵ・?鬯・・?遒托??蟷?・?・?驍ｵ・??・?・?2髯区??豸?・つ雋翫???・?闔・?雎ｼ?髯具??郢晢??郢晢??鬯?貊ゑ??・?驍ｵ・?陋ｹ??・?・?陝ｲ・?・つ遶丞｢・?抵??・??・?・?驛｢譎???・趣??驛｢・??・?・?驍ｵ・??・?・?鬩???髯具??・つ郢晢??
            const durLocal = isScalePat ? (isCall ? (beatSec*0.5) : beatSec) : noteDur;
            const stepLocal = durLocal; // 驛｢譎擾??・?郢晢??驛｢譎会ｽ?・?闖ｫ・?鬯?・?郢晢??
            const g = {midi:dispM, time:tCursorSong, duration: durLocal, role: isCall? 'call':'resp'};
            if(label){ g.label = label.name; }
            ghost.push(g);
            practicePlan.push({ idx: planIdx++, midi:m, timeSong:tCursorSong, duration:durLocal, role: isCall? 'call':'resp' });
            tCursorSong += stepLocal; tCursorAudio += stepLocal;
        }
        // 髯?・?郢晢??郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?邵?驢搾??・??・?・?驍ｵ・?郢??遶???・?・??・?・?1髫?・?陜｣・??・?・?鬩?謳?・?・??・?・?
        tCursorSong += beatSec*1.0; tCursorAudio += beatSec*1.0;
    }
    midiGhostNotes = ghost; drawChart();
    // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・?隴?・??・?・?陟募??魘ｬ驍ｵ・??・?・?驍ｵ・?鬮?・?・取ｨ抵??・??・?・?驛｢譎???・趣??驛｢・??・?・?(role==='resp')驛｢譎擾??・?郢晢??驛｢譎?樟郢晢??驍ｵ・??・?・?髫?螟ｲ・?・?髯???・?・?驍ｵ・?驍???雎撰??髴難???・?・?鬨?蛹・??・?驍ｵ・??・?・?髣???隴・隰・
    try{
        practiceExpectedNotes = ghost.filter(g=> g.role==='resp').map(g=>({midi:g.midi,time:g.time,duration:g.duration||beatSec}));
    }catch(_){ practiceExpectedNotes=null; }
    practiceEndSongTime = ghost.length? Math.max(...ghost.map(n=> n.time + n.duration)) : (startSong + 60);
    practiceBaseSongTime = startSong; practiceBaseAudioTime = now + 0.1;
    // 鬮?蜍?・??・?・?陞｢・??・?・?陷?・??・?・??・?・?驛｢・?郢?蛹?・?・?髯橸???・?・?驛｢譎???・?郢晢??驛｢譎??抵?趣??驛｢・??・?・?驍ｵ・??・?・?髯?・?陟募具??髯憺屮・?・?髮・隰費??遶頑･???陋ｹ・??・?蜀暦??・?陝ｶ蜷??・?髯?・?隴?・?隰・
    playbackPosition = practiceBaseSongTime;
    // 鬩搾???・?・?鬩怜雀・?譎擾??謌?ｲり峪・?陷・??驍ｵ・??・?・?髴托ｽ??・?・?髯懶???・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎∬??・?・?陋ｹ・?遶擾??驍ｵ・?雋???・?FROM/TO郢晢??髢?・??・?・?郢晢??陝ｲ?驍ｵ・?霑ｹ螟ｲ・?・?闕ｵ譏ｶ??驛｢・?闕ｵ譎｢・?閧?・?・?郢晢??遶???譏?・?・?髯?閧??蛹・??・??・?・?驛｢・??・?・?驛｢譎???譁絶落驛｢譏ｴ?・?郢晢??鬮?・??・?・?髫?・??・?・?
    try{
        if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
            let gMin=Infinity, gMax=-Infinity;
            for(const n of midiGhostNotes){
                // 鬮?・??・?・?鬩穂ｼ夲??・?髫?蠑ｱ・・?晢?? call 驍ｵ・??・?・?驍ｵ・??・?・?鬮?蜍?・??・?・?陞｢・?邵?蜥擾??譎???譁石夐Δ??陞ｳ蝣仰郢晢??郢晢??
                const mm = (n.role==='call') ? (n.midi + (practiceCallDisplayOctShift|0)) : n.midi;
                if(mm<gMin) gMin=mm; if(mm>gMax) gMax=mm;
            }
            if(isFinite(gMin) && isFinite(gMax)) setVerticalOffsetToRange(gMin, gMax);
        } else {
            setVerticalOffsetToRange(low + (practiceCallDisplayOctShift|0), high + (practiceCallDisplayOctShift|0));
        }
    }catch(_){ }
    startPracticeScheduler();
    isPracticing=true; practicePaused=false;
    const step=()=>{
        if(!isPracticing) return;
        try{
            const songNow = practiceBaseSongTime + ((audioCtx?.currentTime||0) - practiceBaseAudioTime);
            playbackPosition = songNow;
        }catch(_){ }
        drawChart(); practiceRAF = requestAnimationFrame(step);
    };
    if(practiceRAF) cancelAnimationFrame(practiceRAF); practiceRAF=requestAnimationFrame(step);
    const totalDur = (practiceEndSongTime - startSong) + 0.5; if(practiceLoopTimer) clearTimeout(practiceLoopTimer);
    practiceLoopTimer = setTimeout(()=>{ stopBasicPractice(true); openAdvice(); }, Math.ceil(totalDur*1000));
}

function stopBasicPractice(clearGhost){
    isPracticing=false; if(practiceRAF){ try{ cancelAnimationFrame(practiceRAF); }catch(_){ } practiceRAF=0; }
    if(practiceLoopTimer){ clearTimeout(practiceLoopTimer); practiceLoopTimer=null; }
    if(practiceCallSchedTimer){ try{ clearInterval(practiceCallSchedTimer); }catch(_){ } practiceCallSchedTimer=null; }
    // 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髮九?迴?遶擾??驛｢譎擾??・?郢晢??驛｢譎?樟郢晢??髯句??繩??・?・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??
    try{
        practiceScheduledNotes.forEach(n=>{ try{ if(n.gain){ n.gain.gain.cancelScheduledValues(0); n.gain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.03); } if(n.src){ try{ n.src.stop(); }catch(_){ } } }catch(_){ } });
    }catch(_){ }
    practiceScheduledNotes.length=0;
    practiceScheduledSet && practiceScheduledSet.clear && practiceScheduledSet.clear();
    practicePlan.length=0;
    // 鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎擾??・?邵?蝣?・?・??・?・?髯句??繩??・?・??・?・?髫?蠑ｱ・・?頑･?・?謳?・?・?髴難???・?・?驛｢・?陋幢??邵?驢搾??譎｢・?・?驛｢・??・?・?
    try{ if(pitchHistory && pitchHistory.length){ pitchHistory.length=0; } }catch(_){ }
    if(clearGhost){ midiGhostNotes=null; drawChart(); }
    practiceExpectedNotes = null;
    try{ seekTo(0); }catch(_){ playbackPosition=0; playbackStartPos=0; drawChart(); }
}

// ---- 髯憺屮・?・?鬩慕甥・?闌ｨ・?・??・?・?鬩怜生?・? 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?鬯?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?髣???・つ髫?蠑ｱ・・??蜑ｰ・???・?・?/髯??陜難??陝ｷ? ----
// 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?: 鬩搾???・?・?鬩怜雀?・?騾?驢搾??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎擾??・?郢晢??驛｢譎???・?螳壽??郢?閾?闊樣Δ???・?・?驛｢・??・?・?驛｢譎｢・?・?鬩搾??隶吝ｮ茨??・?驍ｵ・??・?・?髯??陷?・?陷・??郢晢??闔・?隨?蜑ｰ・???・?・?鬮?????・?髯滓坩螻??・?・?郢晢??
function schedulePracticeNote(midi, when, dur){
    try{
        ensureAudio();
        if(!practiceCallGain){
            practiceCallGain = audioCtx.createGain();
            practiceCallGain.gain.value = Math.max(0, Math.min(1, parseFloat(practiceCallVolEl?.value||'0.85')));
            try{ (masterGain||audioCtx.destination) && practiceCallGain.connect(masterGain||audioCtx.destination); }catch(_){ practiceCallGain.connect(audioCtx.destination); }
        }
        let at = when;
        // 髯???・?・?髯?迚呻??蜴?讓抵??・??・?・?驛｢譏ｴ?・?・趣??驛｢・??・?・?驛｢・?髮区??・?・??・?・?驍ｵ・??・?・?鬮?諷穂ｺ・・?・?驗呻???・??驍ｵ・??・?・?髯?隨?・?迺??陋幢???・??郢晢??郢晢??T髫?蟶?逕･隴??鯉ｽ?蠑ｱ・・?晢??髮九ｑ??・?髯橸??陞｢・?・つ?・?・?驍ｵ・?遶擾??隨冗霜諤・・?・?髫?蠑ｱ・・?晢??髫?證ｦ・?・?髯橸??陞｢・?・つ?・?・?郢晢??郢晢??
        const outLat = btLatencyEnabled ? (btLatencySec||0) : (estimateOutputLatency()||0);
        if(outLat>0) at = at - outLat;
        const ok = simplePlaySfz(midi, at, dur, practiceCallGain);
        if(!ok){
            // 驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?: 鬩・?・?・?髫?蜑ｰ萓ｭ邵?讙趣??・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            const f = 440 * Math.pow(2, (midi-69)/12);
            osc.type='sine'; osc.frequency.setValueAtTime(f, Math.max(audioCtx.currentTime+0.002, at));
            const startAt = Math.max(audioCtx.currentTime+0.002, at);
            const stopAt = startAt + Math.max(0.05, dur||0.2);
            g.gain.setValueAtTime(0.0001, startAt); g.gain.exponentialRampToValueAtTime(0.5, startAt+0.01);
            g.gain.setTargetAtTime(0.0001, stopAt, 0.2);
            osc.connect(g); g.connect(practiceCallGain);
            osc.start(startAt); osc.stop(stopAt+0.05);
        }
        practiceScheduledNotes.push({ when: at, stopAt: at + (dur||0.2) });
    }catch(_){ }
}

function startPracticeScheduler(){
    try{ ensureAudio(); }catch(_){ }
    // clear existing
    if(practiceCallSchedTimer){ try{ clearInterval(practiceCallSchedTimer); }catch(_){ } practiceCallSchedTimer=null; }
    // ensure gain
    try{
        if(!practiceCallGain){
            practiceCallGain = audioCtx.createGain();
            practiceCallGain.gain.value = Math.max(0, Math.min(1, parseFloat(practiceCallVolEl?.value||'0.85')));
            try{ (masterGain||audioCtx.destination) && practiceCallGain.connect(masterGain||audioCtx.destination); }catch(_){ practiceCallGain.connect(audioCtx.destination); }
        }
        // 鬮?證ｦ・?・?鬯?・??・?・?郢晢??闔・?郢晢??鬯?・?陋ｹ・?陷・??驍ｵ・??・?・?驛｢譎???菴?遉ｼ・?譎｢・?・?驛｢譎???・?蟶晏??・?・?鬯?・??・?・?郢晢??郢晢??
        if(practiceMutedUntil>0){ practiceCallGain.gain.setTargetAtTime(Math.max(0, Math.min(1, parseFloat(practiceCallVolEl?.value||'0.85'))), Math.max(audioCtx.currentTime, practiceMutedUntil+0.02), 0.02); }
    }catch(_){ }
    practiceCallSchedTimer = setInterval(()=>{
        try{
            if(!audioCtx) return;
            const songNow = practiceBaseSongTime + (audioCtx.currentTime - practiceBaseAudioTime);
            const songEnd = songNow + PRACTICE_SCHED_AHEAD;
            for(const it of practicePlan){
                if(it.role!=='call') continue;
                if(it.timeSong < songNow - 1e-3 || it.timeSong > songEnd + 1e-3) continue;
                const key = it.idx;
                if(practiceScheduledSet.has(key)) continue;
                const whenAudio = audioCtx.currentTime + Math.max(0.001, (it.timeSong - songNow));
                schedulePracticeNote(it.midi, whenAudio, it.duration);
                practiceScheduledSet.add(key);
            }
        }catch(_){ }
    }, 60);
}

function pauseBasicPractice(){
    if(!isPracticing || practicePaused) return; practicePaused=true; practicePauseAt = playbackPosition;
    if(practiceRAF){ try{ cancelAnimationFrame(practiceRAF); }catch(_){ } practiceRAF=0; }
    if(practiceLoopTimer){ clearTimeout(practiceLoopTimer); practiceLoopTimer=null; }
    // 鬯?・??・?・?鬮?・?陟包???・?・??・?・?驍ｵ・??・?・?鬯?・??・?・?驍ｵ・??・?・?髮・?・?・?驛｢・?遶丞､?・??
    try{ practiceScheduledNotes.forEach(n=>{ if(n.stopAt > (audioCtx?.currentTime||0)){ try{ /* cannot unschedule, but gate */ if(practiceCallGain){ practiceCallGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.03); practiceMutedUntil = (audioCtx?.currentTime||0) + 0.05; } }catch(_){ } } }); }catch(_){ }
    if(practiceCallSchedTimer){ try{ clearInterval(practiceCallSchedTimer); }catch(_){ } practiceCallSchedTimer=null; }
}

function resumeBasicPractice(){
    if(!practicePaused) return; ensureAudio();
    // 驛｢譎???・?郢晢??驛｢譎??抵?趣??驛｢・??・?・?驛｢・?陷???・?・?髫???・?・?驍ｵ・?陷会ｽ?遯?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髯??陜難??陝ｷ?
    practiceBaseSongTime = practicePauseAt;
    practiceBaseAudioTime = audioCtx.currentTime + 0.06;
    // 鬨?・??・?・?髯溷供??蠕?・?鬮?・??・?・?鬨?蜈ｷ・?・?鬯?・??・?・?驛｢・?陝ｶ譏ｶ闌?し??闔会ｽ??・?迢暦??・?雋?∞??竏ｬ・?・??・?・?鬯?・?髦?蜴?驢搾??譎｢・?・?驛｢譎｢・?・?驛｢譎???・?蟶晏??・?・?鬯?・??・?・?髣・闔・??・?・?郢晢??
    if(practiceCallGain){ try{ practiceCallGain.gain.setTargetAtTime(Math.max(0, Math.min(1, parseFloat(practiceCallVolEl?.value||'0.85'))), practiceBaseAudioTime+0.02, 0.02); }catch(_){ } }
    // 髫??会ｽ?・?髯・陋滂ｽ?邵?蟶?・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髮九?迴?遶擾??驛｢譎???・?郢晢??驛｢・??・?・?驛｢・?陋幢??邵?驢搾??譎｢・?・?驛｢・??・?・?郢晢??闔蛹・??・??・?・?鬯?・?鬮?・?郢晢??鬩???郢晢??陝ｲ?驍ｵ・??・?・?驍ｵ・??・?・?髯??鬮?・?邵?蟶?・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?郢晢??郢晢??
    practiceScheduledSet && practiceScheduledSet.clear && practiceScheduledSet.clear();
    startPracticeScheduler();
    // 驛｢・??・?・?驛｢譏???譁滓･?諤呵搏??陝ｷ霈?・?騾趣??雎ｬ・?髯橸???・?・?髫?蠑ｱ・玖?・?驕ｶ髮∽?芽??髫?蠑ｱ・玖?・?驍ｵ・??・?・?驛｢譎???・?郢晢??驛｢譎??抵?趣??驛｢・??・?・?驍ｵ・??・?・?髯?・?隴?・?隰・郢晢??郢晢??
    isPracticing=true; practicePaused=false;
    const step=()=>{
        if(!isPracticing) return;
        try{
            const songNow = practiceBaseSongTime + ((audioCtx?.currentTime||0) - practiceBaseAudioTime);
            playbackPosition = songNow;
        }catch(_){ }
        drawChart(); practiceRAF = requestAnimationFrame(step);
    };
    if(practiceRAF) cancelAnimationFrame(practiceRAF); practiceRAF=requestAnimationFrame(step);
    // 髫?・?闕ｵ譎｢・?鬘假??蠑ｱ・玖?・?驍ｵ・??・?・?鬩搾??郢???・?・?郢晢??邵?・?驛｢・??・?・?驛｢譎???・?郢晢??
    const remaining = Math.max(0, practiceEndSongTime - practicePauseAt) + 0.5;
    if(practiceLoopTimer) clearTimeout(practiceLoopTimer);
    practiceLoopTimer = setTimeout(()=>{ stopBasicPractice(true); openAdvice(); }, Math.ceil(remaining*1000));
    // 髯??陜難??陝ｷ謌???蠑ｱ・・・?繧句寰闕ｵ譏ｶ??驛｢・?陋滂ｽ??・?・?陷?・??・?・??・?・?驍ｵ・??・?・?鬮?・??・?・?髯?閧??螂???・??・?・?髫?・??・?・?郢晢??陋ｹ・?邵?荵滂ｽ?譎｢・?・?驛｢・??・?・?驛｢譎???・?・?郢晢??陝ｲ?髯???・?・?髯?驛∬??・?・?郢晢??
    try{
        if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
            let gMin=Infinity, gMax=-Infinity; for(const n of midiGhostNotes){ if(n.midi<gMin) gMin=n.midi; if(n.midi>gMax) gMax=n.midi; }
            if(isFinite(gMin) && isFinite(gMax)) setVerticalOffsetToRange(gMin, gMax);
        }
    }catch(_){ }
}
const advicePanel=document.getElementById('advicePanel');
const adviceTextEl=document.getElementById('adviceText');
const adviceCloseBtn=$('adviceClose');
const adviceCanvas=/** @type {HTMLCanvasElement|null} */(document.getElementById('adviceCanvas'));
let _adviceCtx = adviceCanvas? adviceCanvas.getContext('2d') : null;
// 髯??陷?・?陷・??鬩搾??陞｢・?郢晢??X髣???陷?・??・?・??・?・?郢晢??陋ｹ・?邵?蜀暦??譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕娯雷髯晢??郢晢??郢晢??鬩堺?・・?/3郢晢??郢晢??
function getPlayX(width){
    try{
        const w = Math.max(0, width|0);
        // 髯晢???・?・?鬩????・?・?驍ｵ・??・?・?鬨?・?雋?∞??讌｢蜿・・?・?驍ｵ・??・?・?鬯?・?髦?蜻?・?・?驛｢・?陝ｲ・??・?讒ｭ?・?郢晢??33%郢晢??陝ｲ・?・つ郢?闌ｨ・?・??・?・?鬩????・?・?驍ｵ・??・?・?髯・陷諤懈?鬯?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?髫????髣???郢晢??0px驛｢・?陜｣・??・?・??・?・?髣???隴擾??・つ郢晢??
        return Math.round(Math.max(60, Math.min(w - 80, w * 0.33)));
    }catch(_){ return 70; }
}
// 鬩搾???・?・?鬯?・?郢晢??I鬮?陬懈が?・?・??・?・?髯?・?鬮???・?・?郢晢??
const rangeSelectToggle=document.getElementById('rangeSelectToggle');
const clearSelectionBtn=document.getElementById('clearSelectionBtn');
const octDownBtn=document.getElementById('octDownBtn');
const octUpBtn=document.getElementById('octUpBtn');
const applyForwardToggle=document.getElementById('applyForwardToggle');
const undoBtn=document.getElementById('undoBtn');
const redoBtn=document.getElementById('redoBtn');
// 鬩搾???・?・?鬯?・?郢晢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕?・?髯??郢晢??郢晢??髣???隴取得??・?郢晢??髯溷桁??・?髯?蛹??・?郢晢??髫?蛹・??・?郢晢??鬯?・?陝雜｣・?・?郢晢??郢晢??驍ｵ・?雋?∞??竏ｬ諱・耳竏晄?らｹ晢??郢晢??I驛｢・?郢??霓､譛ｱ・?・??・?・?髮九?迴?遶擾??郢晢??郢晢??
const midiRefBtn=document.getElementById('midiRefSelectBtn');
// const midiAlignInfo 鬯?・?陝雜｣・?・?郢晢???・?・??・?・?鬮?・?・つ驛｢・?髮区??・?鬥?・?蛹・??・?郢晢??闔蛹・??・?驗呻??邵?螳壽╂鬮???・?・?驍????・?・?陋ｹ・?遶擾??郢晢??郢晢??
// 驛｢譎擾??・?郢晢??驛｢譎??隲橸??髫?・?闕ｵ譏ｴ?・?髣???・つ髫?蠑ｱ・・・?・?隴取得??・?郢晢??髯溷桁??・?髯晢???・?・?郢晢??陋ｹ・?邵?譎会ｽ?譎｢・?・?驛｢譎?§郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎∬??・?・?郢晢??
const noteSnapSaveBtn=document.getElementById('noteSnapSaveBtn');
const noteSnapRestoreBtn=document.getElementById('noteSnapRestoreBtn');
let _noteSnapshot=null;
// 髯?・??・?・?髯・郢晢??邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・?隲?肩・?・??・?・?郢晢??鬩・?・?・??・?・?鬯?・?鬮?・??・?・?陝ｲ・?郢晢??驛｢譎｢・?・?驛｢・??・?・?郢晢??郢晢??I驛｢譎?樟邵?蝣?・?譎｢・?・?驍ｵ・??・?・?髫?蜴・??・?髫???・?・?郢晢??郢晢??
let strictOctaveMode=false;
const strictOctaveToggle=null; // UI髯?蜿?・?竏晄?・
const midiRefInput=document.getElementById('midiRefInput');
const midiTrackSelect=document.getElementById('midiTrackSelect');
const midiApplyBtn=document.getElementById('midiApplyBtn');
const midiGenerateBtn=document.getElementById('midiGenerateBtn');
// 髯・?・?・?髯滂ｽ?隲・?・?・??・?・?髫?・??・?・?UI
const midiAlignPanel=document.getElementById('midiAlignPanel');
const midiAlignDetStart=document.getElementById('midiAlignDetStart');
const midiAlignRefStart=document.getElementById('midiAlignRefStart');
const midiAlignScale=document.getElementById('midiAlignScale');
const midiAlignFitEnds=document.getElementById('midiAlignFitEnds');
const midiAlignInfo=document.getElementById('midiAlignInfo');

// 髫???・?・?: 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??/髣費???・?・?髯槭??・?鄙ｫ?・?鬯?・??・?・?髯橸???・?・?髯?闌ｨ・?・?髯?蟲??・?UI郢晢??郢晢??ndex.html 驍ｵ・??・?・?髯?・?陋ｹ・??・?蜀暦??・?陝ｶ蜷?陞ｺID郢晢??郢晢??
const melodyAudioBtn=$('melodyAudioSelectBtn');
const melodyAudioInput=$('melodyAudioInput');
const melodyAudioLabel=$('melodyAudioLabel');
const accompAudioBtn=$('accompAudioSelectBtn');
const accompAudioInput=$('accompAudioInput');
const accompAudioLabel=$('accompAudioLabel');

// Stop驛｢譎?鯵邵?・?驛｢譎｢・?・?驍ｵ・??・?・?髫?・?闕ｳ讒ｫ・?蜥擾??・?陷会ｽ?遶企?・?・?郢晢??陋ｹ・?髴難???・?・?郢晢??陋ｹ・?郢晢??驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?髫俶誓??・?髯懈圜・?・?郢晢??陝ｲ・??・?蟶晢??・??・?・?驍ｵ・?髣??娯?驛｢譎｢・?・?驛｢譏ｴ?・?
let STOP_TRUSTED_ONLY = true; // 髫??会ｽ?・?髯橸??郢晢?? 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髫?・?陜｣・??・?・?隲帷???・?驍ｵ・??・?・?鬮?・??・?・?髯?・??・?・?
window.protectStop = function(on=true){ STOP_TRUSTED_ONLY = !!on; console.warn('STOP_TRUSTED_ONLY=', STOP_TRUSTED_ONLY); };
// (ZIP驛｢譎??堤???驛｢譏ｴ?・? 鬮?????・?髯?莨夲??・?UI鬮?陬懈が?・?・??・?・?髯?・?鬮???・?・?隴会ｽ??・?・?闔・??・?・?陟募?個? index.html 驍ｵ・??・?・?驛｢譎?鯵邵?・?驛｢譎｢・?・?鬮?????・?髯?莨夲??・?髫???・?・?髯橸??陞滂ｽ??・?・?郢晢??
const pianoZipInput=document.getElementById('pianoZipInput');
const pianoZipBtn=document.getElementById('pianoZipLoadBtn');
const pianoZipStatus=document.getElementById('pianoZipStatus');
const sfzDirBtn=document.getElementById('sfzDirLoadBtn');
const sfzDirInput=document.getElementById('sfzDirInput');
const sfzStatus=document.getElementById('sfzStatus');
// 鬨??難??阮・・?驛｢譎?鯵邵?・?驛｢譎｢・?・?驍ｵ・??・?・?髯?蜿?・?竏晄?る寞繧・樟?擾??
let pianoZipManifest=null; // 鬮?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驛｢・?髦?蜷?蜻? manifest
let pianoZipFiles=null;    // { filename: Uint8Array }
let pianoZipDecodeQueue=[]; // 驛｢譏ｴ?・?邵?諷???譎｢・?・?驛｢譎?櫨隨鞘握諤?陋ｹ・?邵?蜀暦??譎｢・?・?驛｢譎｢・?・?
let pianoZipDecoding=false;
let pianoZipDecodePaused=false; // 髯??陷?・?陷・??髣????・?・?驍ｵ・??・?・?髣???・つ髫?蠑ｱ・・??蜑ｰ・???・?・?
let pianoIRBuffer=null; // 驛｢・??・?・?驛｢譎｢・?・?驛｢譏???・?・取刮・?・??・?・?髯滂ｽ?隲・?・?・?郢晢??
let pianoIRConvolver=null; // ConvolverNode
let resonanceWetGain=null; // IR驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??鬨?蛹・??・?
let preOutMergeGain=null; // 驛｢譎擾??・?・主??・?・??・?・?/驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??髯?・?陜捺?ゑｽ?・?郢晢??
let resonanceMix=0.15; // 髯?闌ｨ・?・?鬯?????・?驛｢譎???蛟･?暮Δ???・?・?驛｢・??・?・?(0..0.6)
let pianoSampleMap={};// key: midi -> { layers:{pp:AudioBuffer,...}, release:AudioBuffer|null, gains:{pp:db,...} }
// 鬮?髦??・?霎溷?????会ｽ?・?髯???・?・?髯・?・?・?髯滂ｽ?郢晢?? Piano / Flute 鬨?蛹・??・?驛｢譎???・?郢晢??驛｢譏ｴ?・?
const instrumentMaps={ Piano:null, Flute:null };

// 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?貉?: 驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?邵??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎擾??・?郢・驛｢譎｢・?・?髴托ｽ??・?・?髫?・?陷茨???・?・?郢晢??I驍ｵ・??・?・?髫?蜴・??・?髫???・?・?郢晢??郢晢??
let sustainPedal=false; // 驛｢譎擾??・?郢・驛｢譎｢・?・?髫?蛹・??・?郢晢??驍ｵ・??・?・?髯懈圜・?・?髯橸??陷夲??FF

// 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取鞄FZ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏???螟ｲ・?・?闔・?隹?・?髯懈圜・?・?髯具??郢晢???・?鬘伜ｴ慕ｹ晢???・??鬨?蛹・??・?驍ｵ・??・?・?髫????髯・陷證ｦ・?・?霑ｹ螟ｲ・?・??・?・?郢晢??郢晢??
let SIMPLE_SFZ_MODE=false; // 髫??会ｽ?・?髯橸??陷夲??FF
window.setSimpleSfzMode=function(on=true){ SIMPLE_SFZ_MODE=!!on; console.warn('SIMPLE_SFZ_MODE=',SIMPLE_SFZ_MODE); };

// ==============================
// UI: 髯?・??・?・?髯・郢晢??邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・?隲?肩・?・??・?・?/驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎会ｽ?・?郢晢??鬩搾??郢晢??
// ==============================
(function wireDevToggles(){
    try{
        // strictOctaveToggle 驍ｵ・??・?・? UI髯?蜿?・?竏晄?るし・??・?・?驍ｵ・?雋?∞??竏ｬ・?蟷?・?・?鬯???隱??・?・?郢晢??
        if(noteSnapSaveBtn){
            noteSnapSaveBtn.addEventListener('click', ()=>{
                try{ _noteSnapshot = snapshotNotes(); if(noteSnapRestoreBtn) noteSnapRestoreBtn.disabled = !_noteSnapshot; }catch(_){ _noteSnapshot=null; }
            });
        }
        if(noteSnapRestoreBtn){
            noteSnapRestoreBtn.addEventListener('click', ()=>{
                if(_noteSnapshot){ restoreFromSnap(_noteSnapshot); }
            });
        }
    }catch(e){ console.warn('wireDevToggles failed', e); }
})();

// 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取?・?・??・?・?髯滓汚??・?髯・髣??・・?髯???・?・?髯?閧?・?・??・?・?郢晢???・?・??・?・?鬨??郢晢???・?・?郢晢??I驍ｵ・??・?・?驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎???・?郢晢??驛｢譎会ｽ?・?遶城メ・?螢?・?・?遶??・・??・?・?髫?蟷?・?・?驍ｵ・??・?・?驛｢譏ｴ?・?邵?諷???譎｢・?・?驛｢譎?櫨陟?髯?・??・?・?驛｢・?陞ｳ蝣仰郢晢??郢晢??郢晢??郢晢??
let PREFERRED_SAMPLE_EXTS = null; // 髫?荳橸??闌ｨ・?・??・?・?髫?謔ｶ?・??・?・?陞｢・?遯?・?驍ｵ・?郢???・?讙趣??・??・?・?驍ｵ・?髦?蜻?・??驍ｵ・??・?・?鬯?貊難??鄙ｫ?・?驍ｵ・??・?・?髯?闌ｨ・?・?驛｢・?郢晢??
let SELECTED_SAMPLE_PRIMARY = null; // 髯橸??雋?陜ｨ?驍ｵ・??・?・?鬯?蛹・??・?驍ｵ・??・?・?驛｢・?陟募??陞ｺ鬮?・??・?・?髣???・つ髯区???・・?・?隲幢???・?・?鬩・?・?・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?郢晢??郢晢??
function getAltSampleExts(){
    try{
        // 髫?荳橸??闌ｨ・?・??・?・?驍ｵ・??・?・?髯???・?・?髯?閧?・?・??・?・?郢晢??遯?・?髫?謔ｶ?・??・?・?陞｢・??・??驛｢・?陟募???・?驍ｵ・?郢晢???・?讙趣??・??・?・?驍ｵ・?隴擾???・?讙趣??・?陷?蝓滂ｽ?・?鬨?蛹・??・?
        if(Array.isArray(PREFERRED_SAMPLE_EXTS) && PREFERRED_SAMPLE_EXTS.length){
            SELECTED_SAMPLE_PRIMARY = PREFERRED_SAMPLE_EXTS[0]||null;
            return PREFERRED_SAMPLE_EXTS.slice();
        }
        // 驛｢譎?§・主??・?・??・?・?驛｢・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎???郢晢??驛｢譎槭Γ郢晢??髯?迚呻??蜻?・?螳夲???隲幢??郢晢??
        const a=document.createElement('audio');
        const support={
            wav: true, // PCM WAV 驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?髯晢???・?・?驍ｵ・??・?・?髯?・??・?・?
            ogg: !!a.canPlayType && (a.canPlayType('audio/ogg; codecs=vorbis')||'').length>0,
            mp3: !!a.canPlayType && (a.canPlayType('audio/mpeg')||'').length>0,
            m4a: !!a.canPlayType && ((a.canPlayType('audio/mp4')||a.canPlayType('audio/aac'))||'').length>0
        };
        // UI驍ｵ・??・?・?鬯?蛹・??・?髫?螢?・?・??・?螳壽╂郢?蟲??・?郢晢??陋ｹ・?遶・驛｢・?陟募?・・?郢晢??郢晢?? auto | wav | ogg | mp3 | m4a
        const pref = (typeof formatSelect!=="undefined" && formatSelect && formatSelect.value)? String(formatSelect.value): 'auto';
        const all=['wav','ogg','m4a','mp3'];
        let order=[];
        if(pref && pref!=='auto'){
            // 髫?謔ｶ?・??・?・?陞｢・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎???・?郢晢??驛｢譎???・?螳壽?騾趣???・?・??・?・?驍ｵ・??・?・?驍ｵ・?遶擾???・?・?闕ｵ譎｢・?鬘費??・??・?・?驛｢・??・?・?驛｢譎???郢晢??驛｢譎??隲橸??髮手ｼ・・??・?・?郢晢??
            if(all.includes(pref)) order.push(pref);
        }
        // 髫?・?闕ｵ譎｢・?鬘費??・?陋幢??邵?遉ｼ・?譎???郢晢??驛｢譎会ｽ?・??・?・?郢晢??邵?螳壼??・?・?驍ｵ・??・?・?驛｢・?陷茨???・?・?髢?・??・?・??・?・?髫?荳・・? wav > ogg > m4a > mp3郢晢??郢晢??
        const byPrio=['wav','ogg','m4a','mp3'];
        for(const ext of byPrio){ if(!order.includes(ext) && support[ext]) order.push(ext); }
        // 髫????髣???陟托??邵?蝣?・?・?郢??郢晢??髯区???・・?・?隲帛･・??螳壽・?・?・?驛｢・?遶丞､?・?荵・・?闔・??・?・?郢晢??隰?繧会ｽ?・??・?・?髫?・??・?・?髯滓汚??・?鬨?蛹・??・?驍ｵ・??・?・?郢晢??郢晢??
        for(const ext of all){ if(!order.includes(ext)) order.push(ext); }
        SELECTED_SAMPLE_PRIMARY = order[0]||null;
        return order;
    }catch(_){ SELECTED_SAMPLE_PRIMARY=null; return ['wav','ogg','m4a','mp3']; }
}

// 髫?・?驕擾??雎ｸ・?(Convolver)驍ｵ・??・?・?驛｢譎擾??・?・主??・?・??・?・?/驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??髯?・?陜捺?ゑｽ?・?遶丞｣??驛｢譎｢・?・?驛｢譎擾??・?郢晢??髯具??隴・隰・髯具??隰費??遶??晢????隱??・?・?郢晢??
function ensureConvolver(){
    if(!audioCtx || !masterGain) return;
    try{
        // 髯?・?陜捺?ゑｽ?・?遶丞｣??驛｢譎｢・?・?驛｢譏ｴ?・?
        if(!preOutMergeGain){ preOutMergeGain = audioCtx.createGain(); preOutMergeGain.gain.value = 1; }
        // 髫??会ｽ?・?髯・陋滂ｽ?郢晢?? masterGain -> compressor 鬨?・??・?・?鬩搾??髣??会ｽ?螳壽?碑ｬ費???・??驍ｵ・?遯?・?ry 驛｢・?郢晢??preOutMergeGain 驍ｵ・??・?・?
        try{ masterGain.disconnect(); }catch(_){ }
        try{ masterGain.connect(preOutMergeGain); }catch(_){ }
        // 髣???陋ｹ・??・?・?遶丞｣??驛???證ｦ・?・?鬩搾??郢晢??
        try{ preOutMergeGain.disconnect(); }catch(_){ }
        if(compressor){
            try{ preOutMergeGain.connect(compressor); }catch(_){ }
        }else if(limiter){
            try{ preOutMergeGain.connect(limiter); }catch(_){ }
        }else{
            try{ preOutMergeGain.connect(audioCtx.destination); }catch(_){ }
        }
        // IR 驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?
        if(pianoIRBuffer){
            if(!pianoIRConvolver) pianoIRConvolver = audioCtx.createConvolver();
            try{ pianoIRConvolver.buffer = pianoIRBuffer; }catch(_){ }
            if(!resonanceWetGain) resonanceWetGain = audioCtx.createGain();
            try{ resonanceWetGain.gain.setValueAtTime(resonanceMix, audioCtx.currentTime); }catch(_){ resonanceWetGain.gain.value = resonanceMix; }
            try{ pianoIRConvolver.disconnect(); }catch(_){ }
            try{ masterGain.connect(pianoIRConvolver); }catch(_){ }
            try{ pianoIRConvolver.connect(resonanceWetGain); }catch(_){ }
            try{ resonanceWetGain.connect(preOutMergeGain); }catch(_){ }
        } else {
            try{ if(pianoIRConvolver) pianoIRConvolver.disconnect(); }catch(_){ }
        }
    }catch(e){ console.warn('ensureConvolver failed', e); }
}

// AudioContext驍ｵ・?隶吝ｯ???鬯?・??・?・?驍ｵ・??・?・?鬮?・??・?・?髯?蝣?・?隰孕pend驍ｵ・?髴???・?讙趣??・?闕ｵ譏ｴ?・?驛｢・?陝ｶ譏ｶ闌?し??闔会ｽ??・?迢暦??・?雋?∞??竏ｫ・?・??・?・?髯溷桁??・?髯・闕ｳ闌ｨ・?・??・?・?髯?・??・?・?驛｢・?髮区??・?・??・?・?髫?蠑ｱ・・・?・?遶丞｣???

// AudioContext驍ｵ・?隶吝ｯ???鬯?・??・?・?驍ｵ・??・?・?鬮?・??・?・?髯?蝣?・?隰孕pend驍ｵ・?髴???・?讙趣??・?闕ｵ譏ｴ?・?驛｢・?陝ｶ譏ｶ闌?し??闔会ｽ??・?迢暦??・?雋?∞??竏ｫ・?・??・?・?髯溷桁??・?髯・闕ｳ闌ｨ・?・??・?・?髯?・??・?・?驛｢・?髮区??・?・??・?・?髫?蠑ｱ・・・?・?遶丞｣???
function ensureKeepAlive(){
    if(!audioCtx) return;
    // destination鬨?・??・?・?鬩搾??髣??・・?髯溷桁??・?髯・闕ｳ鄙ｫ・?驛｢・??・?・?驛｢譎｢・?・?郢晢??闔蛹・??・?闕ｳ・?隰?歓??蛹・??・?郢晢??郢晢??
    if(!_keepAliveOsc) try{
        const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
        osc.type='sine'; osc.frequency.setValueAtTime(25, audioCtx.currentTime);
        g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); _keepAliveOsc=osc; _keepAliveGain=g;
    }catch(_){ }
    // 鬮?・?隲幢??陷搾??: 驍ｵ・?隴∵腸・?・?鬯?・?闔ｨ諛茨??・?驍ｵ・??・?・?髯溷桁??・?髯・闕ｳ鄙ｫ・?驛｢・??・?・?驛｢譎｢・?・?驛｢・?郢?闌ｨ・?・?遶丞､?・??驍ｵ・??・?・?驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢・??・?・?驍ｵ・??・?・?鬮?・??・?・?髯??趣??譁撰??驛｢・??・?・?驛｢譎擾??・?・趣??驛｢譎擾??・??・?蟶晢??蛹・??・?驍ｵ・?闔会ｽ??・??
    if(!_keepAliveHiOsc) try{
        const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
        osc.type='sine'; osc.frequency.setValueAtTime(12000, audioCtx.currentTime);
        g.gain.setValueAtTime(0.00003, audioCtx.currentTime);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); _keepAliveHiOsc=osc; _keepAliveHiGain=g;
    }catch(_){ }
    // 驛｢譏ｶ?螢?笙るΔ譎｢・?・?驛｢譎｢・?・?髯??郢晢??郢晢?? DC 髯溷桁??・?髯・闕ｳ闌ｨ・?・??・?・?髯?・??・?・?郢晢??髢?・?隨冗｢・??・??・?・?髫?蠑ｱ・・?晢??suspend髯?軸・?・?遶擾??郢晢??郢晢??
    if(!_keepAliveConst) try{
        const cs=audioCtx.createConstantSource(); const g=audioCtx.createGain();
        cs.offset.setValueAtTime(0.00001, audioCtx.currentTime);
        g.gain.setValueAtTime(1, audioCtx.currentTime);
        cs.connect(g); g.connect(masterGain||audioCtx.destination);
        cs.start(); _keepAliveConst=cs; _keepAliveConstGain=g;
    }catch(_){ }
}
// 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取ｨ抵??譏ｴ?・?邵?驤?蝮・・?・?髯橸??陞｢・??・?・??・?・?鬮?・??・?・?髫?・??・?・?郢晢??闔・??・?・?陞溯・陬???蜈ｷ・?・?鬯?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?鬯?貊ゑ??・?髯?・?隴?・?隶蟷・?・・?・?郢晢??郢晢??
function tuneCompressor(){ if(!compressor) return; try{ compressor.threshold.value=-28; compressor.knee.value=12; compressor.ratio.value=4.5; compressor.attack.value=0.004; compressor.release.value=0.12; }catch(_){ } }
// 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取刮・?譎｢・?・?驛｢譎｢・?・?驛｢譎???蛟･?暮Δ???・?・?郢晢??陜捺?督蜥弱♀郢?闌ｨ・?・??・?・?郢晢??郢晢??
function tuneLimiter(){ if(!limiter) return; try{ limiter.threshold.value=-6; limiter.knee.value=1; limiter.ratio.value=20; limiter.attack.value=0.003; limiter.release.value=0.08; }catch(_){ } }
// 驛｢・?郢??遶???髯・闔会ｽ??・??髯滓汚??・?驛｢・?遶丞｣??・?驛｢譎??堤?晢??驛｢・??・?・?髫?螢?・?・?陞ｳ蟶・・?闔・??・?・?郢晢???・?・?遶丞｣??讌｢?・?隲帷腸・?髯具??郢晢??陝蟶・・?陝ｲ・?・つ郢??郢晢??髫?蟶?・?・?陜滂ｽ?髫?蠑ｱ・・?頑･??・・?・?鬯?・?雎募??・?荵滂ｽ?・??・?・?髯???・?・?驍ｵ・?隲?諛ｷ・??驍ｵ・?郢晢??
function tuneLimiterStrong(){ if(!limiter) return; try{ limiter.threshold.value=-8; limiter.knee.value=1; limiter.ratio.value=20; limiter.attack.value=0.003; limiter.release.value=0.12; }catch(_){ } }

// 驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢・??・?・?髯具??隴・隰・髯具??陷???・?・?闔・??・?・?闔ｨ諛夷帝し・?陷会ｽ?遶企?・?・?郢晢???・?・??・?・?髯?・?陋ｹ・?郢晢??驍ｵ・??・?・?鬨??難??阮・・?驛｢譎｢・?・?鬯???隱??・?・?陞｢・??・??驍ｵ・?遶乗劼・?・?郢晢???・?・?遶丞｣??鬘梧??・?・?髯?・?陋ｹ・?郢晢??髯??陜難??郢晢??鬩搾??陞滂ｽ??・?・?郢晢??
function ensureAudio(){
    try{
        if(!audioCtx){
            const Ctx = window.AudioContext || window.webkitAudioContext;
            audioCtx = new Ctx({ latencyHint: 'interactive' });
        }
        // 髣????・?・?鬮?陬・螢??驛｢譎｢・?・?驛｢譎擾??・?郢晢??鬨??難??阮・・?
        if(!masterGain) masterGain = audioCtx.createGain();
        if(!melodyGain) melodyGain = audioCtx.createGain();
        if(!accompGain) accompGain = audioCtx.createGain();
        if(!compressor) compressor = audioCtx.createDynamicsCompressor();
        if(!limiter) limiter = audioCtx.createDynamicsCompressor();
        // 髯具??隴・隰・髯区?ゑｽ?・?
        try{ masterGain.gain.setValueAtTime(1, audioCtx.currentTime); }catch(_){ masterGain.gain.value=1; }
        try{ melodyGain.gain.setValueAtTime(1, audioCtx.currentTime); }catch(_){ melodyGain.gain.value=1; }
        try{ accompGain.gain.setValueAtTime(1, audioCtx.currentTime); }catch(_){ accompGain.gain.value=1; }
        // 髫??会ｽ?・?髯・陋滂ｽ?郢晢??鬩搾??陞｢・??・?蝣?・?・??・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・?陷会ｽ?遯?・?驍ｵ・?闕ｵ譎｢・?陋ｾ・???隱??・?・?郢晢??
        try{ melodyGain.disconnect(); }catch(_){ }
        try{ accompGain.disconnect(); }catch(_){ }
        try{ masterGain.disconnect(); }catch(_){ }
        try{ compressor.disconnect(); }catch(_){ }
        try{ limiter.disconnect(); }catch(_){ }
        // melody/accomp -> master -> compressor -> limiter -> destination
        try{ melodyGain.connect(masterGain); }catch(_){ }
        try{ accompGain.connect(masterGain); }catch(_){ }
        try{ masterGain.connect(compressor); }catch(_){ }
        try{ compressor.connect(limiter); }catch(_){ }
        try{ limiter.connect(audioCtx.destination); }catch(_){ }
        // 髯?・?郢晢???・?・??・?・?驛｢譏ｶ??・??・?譎｢・?・?驛｢譏???譁滂ｽ?驛｢・??・?・?
        try{ tuneCompressor(); }catch(_){ }
        try{ tuneLimiter(); }catch(_){ }
        // 髫?・?驕擾??雎ｸ・?鬩???陝ｲ・?郢晢??髯?・?陜捺?ゑｽ?・?遶乗亢?・?鬯???隱??・?・?陞滂ｽ??・?・?郢晢??reOutMergeGain鬩搾??隶吝ｮ茨??・?郢晢??郢晢??
        try{ ensureConvolver(); }catch(_){ }
        // UI驍ｵ・??・?・?髯?・?陋ｹ・??・?蜀暦??・?陝ｶ蜷?陞ｺ驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?鬮?・??・?・?髯橸??陞滂ｽ??・?・?闔・??・?・?闔ｨ諛夷帝し・?陷?・??・?讙趣??・??・?・?郢晢??郢晢??
        try{
            if(guideVol){ const v=Math.max(0, Math.min(1, parseFloat(guideVol.value)||1)); melodyGain.gain.setValueAtTime(v, audioCtx.currentTime); }
            if(accompVol){ const v=Math.max(0, Math.min(1, parseFloat(accompVol.value)||1)); accompGain.gain.setValueAtTime(v, audioCtx.currentTime); }
        }catch(_){ }
        // 鬮?・??・?・?髯??趣??譁撰??驛｢・??・?・?驛｢譎擾??・?・趣??驛｢譎?櫨陞ｻ鬥?・?蛹・??・?郢晢??陋ｹ・?・主?・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髫?・?陜｣・??・?・?隲幢???・?・?陟募?・・?驍ｵ・??・?・?郢晢??郢晢??
        if(audioActivated){ try{ ensureKeepAlive(); }catch(_){ }
            // 髯??陜難??陝ｷ?
            try{ if(audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{}); } }catch(_){ }
        }
        return audioCtx;
    }catch(e){ console.warn('ensureAudio failed', e); return null; }
}
// 髯具??隴惹?橸??骰具??譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髫?・?陜｣・??・?・?隲帷???蝣?・?・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢・??・?・?驛｢・?陋幢??邵??驛｢・??・?・?驛｢譏ｴ?・?邵??驛｢譎樊束陜滂ｽ?
function activateAudioOnce(){
    try{
        ensureAudio(); audioActivated=true;
        try{ if(audioCtx && audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{}); } }catch(_){ }
        try{ ensureKeepAlive(); }catch(_){ }
    }catch(_){ }
}

// 驛｢譎???・?邵??驛｢・??・?・?髯?闌ｨ・?・?髯?迚呻??蜷??・?髯具??隴・隰・髯具??陷???・?・?鬩・?・?・??・?・?髫?・?髣??湖馴Δ???・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?郢??邵?蟶?・?譎??堤?晢??驛｢・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?髯???・?・?驍ｵ・?髴域喚?驢搾??・?郢晢???・?・?郢晢??
async function initMic(allowPrompt=false){
    ensureAudio();
    // ---- 髯樊ｺ?・?闊瑚?・鬯???・?・?鬨?蜈ｷ・?・?髯具??隴・隰・髯具??隰費??邵?螳茨??譎｢・?・?驛｢譏ｴ?・?(鬩・?・?・?髫?蜑ｰ萓ｭ郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・? ----
    if(typeof window.__micInitInFlight==='undefined') window.__micInitInFlight=false;
    if(typeof window.__lastMicInitAt==='undefined') window.__lastMicInitAt=0;
    const _guardNow = performance.now? performance.now(): Date.now();
    if(window.__micInitInFlight){ return false; }
    if(!allowPrompt && (_guardNow - window.__lastMicInitAt) < 2000){ return false; }
    window.__micInitInFlight = true;
    try{
        if(_initMicInFlight) return false;
        _initMicInFlight = true;
        // 髫?髮?・?・?鬯?・?陷・隲橸??髫?・?闕ｵ譏ｶ?骰具??・?陋ｹ・??・?鬘費??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏???・?郢晢??髫?蟶?・?・?陜滂ｽ?驛｢・?髮区?・蟷・??椶・?・つ郢?蛹??・?鬩穂ｼ夲??・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵?鬘鯉ｽ?蠑ｱ・・?晢??髯晢???・?・?驍ｵ・??・?・? getUserMedia 驛｢・?髮区??・?・?雋????・?・?陟暮?会ｽ??驍ｵ・?郢晢??
        // 驛｢譎?§・主??・?・??・?・?驛｢・??・?・?髫?轣倡?・・?・?隰費??郢晢??髫?髮?・?・?鬯?・?髣??・・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ?郢晢??驛｢・?陞ｳ螟ｲ・?・??・?・?驍ｵ・?陷?・??・?・?陋ｹ・?邵?驢搾??譎｢・?・?驛｢譎｢・?・?驛｢謨鳴驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?驛｢譎?§・取ｺ?・?譏ｴ?・?邵?驢搾??・?陷会ｽ?遶企?・?・?郢晢???・?・?陝ｲ・?・つ郢晢??
        let state = await getMicPermissionState();
        const nowMs = (performance.now? performance.now(): Date.now());
        if(!allowPrompt){
            const canProceedSilently = (state==='granted') || (state===null && _userExplicitMicInit);
            if(!canProceedSilently){
                // 鬮?・??・?・?髯?髦??・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏???・?闔?ｹ滂ｽ?・??・?・?髯???・?・?驍ｵ・?陷会ｽ?邵?蝣?・?・??・?・?驛｢譎丞ｹ?・取ｺ?・?譎｢・?・?驛｢譎丞ｹ?郢晢??驛｢・?髮区???・?驍ｵ・?髴域喚?驢搾??・?郢晢??
                return false;
            }
        } else {
            // 髫?荳橸??闌ｨ・?・??・?・?髫?・?陜｣・??・?・?隲帑ｺ??・?驍ｵ・??・?・?驛｢譎丞ｹ?・取ｺ?・?譎｢・?・?驛｢譎丞ｹ?郢晢??鬮?・??・?・?髯?・??・?・?郢晢??騾趣??・つ?・?・?髫??霓｣蛛???・??・?・?鬩???隰費??遶???・?・?陷会ｽ?遯?・?髫?蠑ｱ・・け??驍ｵ・??・?・?驍ｵ・?鬯倬?会ｽ?・?陋滂ｽ?????郢晢??郢晢??
            _lastPromptAt = nowMs;
        }
        // 髯滂ｽ??・?・?驍ｵ・??・?・?驍ｵ・?雋?∞??? AudioContext 驛｢・?髮区???・?鬯?・?陷茨???・?・?陋ｹ・?・主?・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髫?・?陜｣・??・?・?隲・驗ゑ??髫?螟ｲ・?・?驍ｵ・??・?・?髯?・??・?・?驍ｵ・??・?・?髯???・?・?驍ｵ・?陷会ｽ?邵?螳夲??蠕｡・?蜥擾??・?驍ｵ・?陷会ｽ??・??驍ｵ・?陷?・??・?讒ｭ?・?郢晢??
        try{ if(audioCtx && audioCtx.state==='suspended'){ await audioCtx.resume().catch(()=>{}); } }catch(_){ }
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ throw new Error('getUserMedia not available'); }
        // 髫??会ｽ?・?髯・陋滂ｽ?郢晢??髯句??繩??・?・??・?・?
        try{ if(micStream){ micStream.getTracks().forEach(t=>t.stop()); } }catch(_){ }
        // 髯?・??・?・?鬮?・??・?・?驍ｵ・??・?・?鬯?・?髣??会ｽ?鬘費??・?隲・陷・??驕ｯ・?隴擾??郢晢??驛｢譎???・?邵??驛｢・??・?・?驛｢・?髮区??蠕宣辧?灘惧?・?・?闔・?隰暦??OS/驛｢譎?§・主??・?・??・?・?驛｢・??・?・?驍ｵ・??・?・?VAD/NS/AGC驛｢・?陷?蝓滂ｽ?蟷・????・?・?郢晢??郢晢??
        const rawAudio = {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false,
            voiceIsolation: false,
            channelCount: { ideal: 1 },
            sampleRate: { ideal: 48000 },
            latency: { ideal: 0 },
            // Chromium鬩堺?夲??・?髯?・?闔会ｽ??・??驍ｵ・??・?・?髫?・??・?・?髯滓汚??・?驛｢譎丞ｹ?・取ｺ?・?譏???・?郢晢??驛｢・??・?・?郢晢??闔・??・?・?郢晢??隰?繧頑≧闔ｨ竏晄?るし・?髴???・?讙趣??・??・?・?驛｢・?郢?菫・??髯橸???・?・?郢晢??郢晢??
            advanced: [
                { googEchoCancellation: false },
                { googExperimentalEchoCancellation: false },
                { googNoiseSuppression: false },
                { googNoiseSuppression2: false },
                { googAutoGainControl: false },
                { googAutoGainControl2: false },
                { googHighpassFilter: false },
                { googAudioMirroring: false }
            ]
        };
        // deviceId髫?謔ｶ?・??・?・?陞｢・??・?螳夊р陋??・?・?髮懶???・?・?騾趣??遶城メ・?螢?・?・?遯?・?驍ｵ・?郢???・??匁捗?・?・?髯?・?髣鯉ｽ??・?・?郢晢??
        const withDevice = Object.assign({}, rawAudio);
        if(selectedMicDeviceId){
            try{ withDevice.deviceId = { exact: selectedMicDeviceId }; }catch(_){ }
        }
        let stream = null;
        try{
            // 驍ｵ・??・?・?驍ｵ・?陞｢・?郢晢??鬯?蛹・??・?髫?螢?・?・?郢晢??驛｢譎?蠕娯鴬驛｢・??・?・?驍ｵ・??・?・?鬮?・??・?・?鬮?・?郢晢??
            stream = await navigator.mediaDevices.getUserMedia({ audio: withDevice, video:false });
        }catch(e1){
            // 髣・陷?逎ｯ蜈ｱ髫?・??・?・?驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?郢晢??闔・?髢?・?鬩榊?螟｢隹??髯橸??陞滂ｽ??・?・?郢晢??
            try{ stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:false, noiseSuppression:false, autoGainControl:false }, video:false }); }
            catch(e2){
                // 髫????鬩搾??郢??郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?郢晢??陋ｹ・?郢晢??驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?髣比ｼ夲??・?驍ｵ・?陝ｷ・??・?・?郢晢??
                stream = await navigator.mediaDevices.getUserMedia({ audio: true, video:false });
            }
        }
        micStream = stream;
        // 髯橸??雋?陜ｨ?驍ｵ・??・?・?髣????・?・?鬨?蛹・??・?驍ｵ・?髴???・?讙趣??・?雋???咎Δ譎?蠕娯鴬驛｢・??・?・?ID驛｢・?陷・?・?・?隴取得??・?陋??・?・?鬩・?・?・??・?・?驍ｵ・?髴???・?讙趣??・?霑｢闍?・?髯・郢晢??郢晢??驍ｵ・??・?・?郢晢??郢晢??
        try{
            const tr = (stream.getAudioTracks && stream.getAudioTracks()[0]) || null;
            const st = tr && tr.getSettings ? tr.getSettings() : null;
            if(st && st.deviceId){ selectedMicDeviceId = st.deviceId; }
        }catch(_){ }
        micSource = audioCtx.createMediaStreamSource(stream);
        // 髯?鬘後??・?・??・?・?驛｢譎???譁絶襖驛｢譎｢・?・?驛｢・??・?・?
        micHPF = audioCtx.createBiquadFilter(); micHPF.type='highpass'; micHPF.frequency.setValueAtTime(70, audioCtx.currentTime);
        micLPF = audioCtx.createBiquadFilter(); micLPF.type='lowpass';
        // 鬯?・?闔ｨ諛茨??・?驍ｵ・??・?・?驍ｵ・??・?・?髫??隲幢??郢晢??驍ｵ・??・?・?驍ｵ・?鬮?・??・?迢暦??・?陋ｹ・?遶???驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏???・?邵?蟶?・?・?陜｣・??・?・??・?・?驛｢・?遶丞､?・?荵・・?郢晢??8驕ｶ霈?・?699Hz 驛｢・?陜｣・??・?・??・?・?髯橸??雋???鬥?・?・?陞｢・?隨・郢晢??郢晢??
        try{
            const sr = audioCtx.sampleRate || 48000;
            const cutoff = Math.min(14000, Math.max(6000, sr * 0.45)); // 6k驍ｵ・?郢晢??4kHz驍ｵ・??・?・?鬩???郢晢??陝ｲ?驍ｵ・??・?・?鬮?・??・?・?髯?閧??螂???・??・?・?髯橸??郢晢??
            micLPF.frequency.setValueAtTime(cutoff, audioCtx.currentTime);
        }catch(_){ micLPF.frequency.value = 8000; }
        // 驛｢・??・?・?驛｢譎会ｽ?・?・主??・?・??・?・?驛｢・??・?・?郢晢??陋ｹ・?・守坩・?譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?驛｢・??・?闊?匚??隶呵??・?・?陝ｲ・?郢晢??髯具??郢晢???・?・??・?・?鬮?・??・?・?驍ｵ・??・?・?髫??会ｽ?・?驍ｵ・?陷?・??・?・?郢晢??
        micAnalyser = audioCtx.createAnalyser();
        micAnalyser.fftSize = 2048;
        micAnalyser.smoothingTimeConstant = 0.0;
        micData = new Float32Array(micAnalyser.fftSize);
        // 鬯???隱??・?・?郢晢?? mic -> HPF -> LPF -> analyser 郢晢??郢晢??estination 驍ｵ・??・?・?驍ｵ・??・?・?鬩幢??闕ｵ譏ｶ?・?驍ｵ・??・?・?驍ｵ・?郢晢???・?・?郢晢??
        try{ micSource.disconnect(); }catch(_){ }
        micSource.connect(micHPF); micHPF.connect(micLPF); micLPF.connect(micAnalyser);
        // YIN/CMNDF tracker modules (if available)
        try{
            const M = window.__PitchModules;
            if(M){
                _yinTracker = new M.YinPitchTracker({ sampleRate: audioCtx.sampleRate, frameSize: micAnalyser.fftSize, fmin: 55, fmax: 2000, threshold: 0.12 });
                // hop = frame/2 驍ｵ・??・?・?鬮?蜿?・?・??・?讓｣蝗?・?・?髫?・?髣頑ｹ??抵??譎｢・?・?驛｢譎?樟?丞現?・?髢?・?陝ｯ・?髯橸??闔ｨ螟ｲ・?・?陝ｲ・?・つ?・?陷るし・??・?・?髯区?ゑｽ?・?驛｢・?陋ｹ・??・?鬘俶割陟托??隨・驍ｵ・?陟托???・??匁捗?・?・?髯?・?陋ｹ・?遶頑･??鬘鯉ｽ?謚ｫ?・?髣???驗呻???・?・?驍ｵ・?郢晢??
                try{
                    const sr = audioCtx.sampleRate || 48000;
                    const hop = Math.max(1, Math.floor(micAnalyser.fftSize/2));
                    // 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?髣???闔ｨ竏晏?憺Δ??髮区??・?・?髴域喚?・?髣???驗呻???・?・?郢晢??闔・??・?・?隲・?・?・?騾搾??・つ?・?・?郢晢??郢晢?? 90 驕ｶ鄙ｫ?・?110驍ｵ・??・?闊?し???・?・?髯溷?鍋袖隰?繧具??・?陞｢・??・?鬘假?????髯樊ｻゑｽ?・?120驍ｵ・?郢晢??
                    const hopRate = Math.max(10, Math.min(IS_MOBILE? 110: 120, Math.round(sr / hop)));
                    analysisRate = Math.max(analysisRate||0, hopRate);
                }catch(_){ }
                // 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?驛｢・?闕ｳ蟯???驍ｵ・?闕ｵ譏ｶ?讌｢?????・?驛｢・?遶丞｣??・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??闔・??・?・??・?・?鬩肴得??・?驍ｵ・??・?・?髫???・?・?驛｢・?陟暮?会ｽ?螳夲??螢?・?・?陞ｳ蟶・・?陝ｲ・?・つ?・?闊?し???・?・?髯溷?鍋袖隰?繧??・・?・?驍ｵ・?郢晢??
                _pitchSmootherMod = new M.PitchSmoother(
                    IS_MOBILE
                        ? { windowSize: 7, deadbandCents: 6, riseCents: 30, fallCents: 38 }
                        : { windowSize: 7, deadbandCents: 8, riseCents: 35, fallCents: 45 }
                );
            }
        }catch(_){ /* ignore */ }
        // 鬮?證ｦ・?・?髫?・?髣??娯蔓驛｢・??・?・?驛｢譎???・?郢晢??郢晢??陋ｹ・?・守坩・?譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?髯??陝雜｣・?・??・?・?髯橸??陞｢・?邵?? cadence 驛｢・?陷?閧?・?逧?・?・?陋ｹ・??・?荵・・?郢晢??
        if(analysisTimer){ try{ clearInterval(analysisTimer); }catch(_){ } analysisTimer=null; }
        analysisTimer = setInterval(analyzePitch, 1000/analysisRate);
        // MIC 驛｢・??・?・?驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?
        try{ setMicStatus('ON'); }catch(_){ }
        // 鬮?・??・?・?髯?・??・?・?髯溷供??蠕?・?髣???・つ鬮?蛹・??・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎??・取刮・?・?隰疲??蠕宣辧蜍溷??邵?蝣?・?・?鬮?・??・?迢暦??・?雋?∞??竏ｬ・?蜴・??・?髫???・?・?
        try{
            if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices){
                const devs = await navigator.mediaDevices.enumerateDevices();
                _micDevicesCache = devs.filter(d=>d.kind==='audioinput');
                refreshMicPickerList();
            }
        }catch(_){ }
        try{
            const tracks = (micStream.getAudioTracks? micStream.getAudioTracks(): micStream.getTracks());
            tracks.forEach(async t=>{
                if(!t) return;
                // 髯?・??・?・?鬮?・??・?・?驍ｵ・??・?・?驛｢・?陝ｲ・?郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?邵?鬘悟?・・?・?驍ｵ・??・?・?驛｢・?郢??・つ隲・陷・??驕ｯ・?隴・?・?・??・?・?髯橸??陞｢・??・?蟶晢??蛹・??・?鬨?蛹・??・?
                try{ await t.applyConstraints({ echoCancellation:false, noiseSuppression:false, autoGainControl:false, advanced:[{ echoCancellation:false, noiseSuppression:false, autoGainControl:false }] }).catch(()=>{}); }catch(_){ }
                if(!t._onteiBound){
                    t._onteiBound=true;
                    t.onended = ()=>{ try{ setMicStatus('OFF'); }catch(_){} };
                    t.onmute = ()=>{ // 髣???・つ髫?蠑ｱ・芽搦・?驛｢譎???菴?遉ｼ・?譎｢・?・?驛｢譎乗ｲ??・?・?隲幢??郢晢??
                        const now=performance.now?performance.now():Date.now();
                        if(now - _micLastReinitAt > 1500){ _micLastReinitAt=now; setTimeout(()=>{ try{ initMic(false).catch(()=>{}); }catch(_){ } }, 50); }
                    };
                    t.onunmute = ()=>{ try{ setMicStatus('ON'); }catch(_){} };
                }
            });
        }catch(_){ }
        _micVoicedRecently=false; _micFlatFrames=0;
        window.__lastMicInitAt = performance.now? performance.now(): Date.now();
        return true;
    }catch(e){ console.warn('initMic failed', e); try{ setMicStatus('OFF'); }catch(_){ } return false; }
    finally{ _initMicInFlight = false; window.__micInitInFlight=false; }
}

// 驛｢譎???・?邵??驛｢・??・?・?髣???・つ鬮?蛹・??・?驍ｵ・??・?・?髯?・?鬮???・?・?郢晢??
async function enumerateMicInputs(){
    try{
        if(!(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices)) return [];
        const list = await navigator.mediaDevices.enumerateDevices();
        return list.filter(d=>d.kind==='audioinput');
    }catch(_){ return []; }
}

// 驛｢譎???・?邵??驛｢・??・?・?鬯?蛹・??・?髫?螢?諢オ
function openMicPicker(){
    try{
        let ov = document.getElementById('micPickerOverlay');
        if(!ov){
            ov = document.createElement('div'); ov.id='micPickerOverlay';
            ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:5000;';
            const card = document.createElement('div'); card.id='micPickerCard';
            card.style.cssText='min-width:260px;max-width:92vw;background:#222;color:#eee;border:1px solid #4e8cff;border-radius:8px;padding:14px;font-family:sans-serif;box-shadow:0 8px 28px rgba(0,0,0,0.4);';
            card.innerHTML = `
                <div style="font-size:16px;font-weight:600;margin-bottom:8px;">驛｢譎???・?邵??驛｢・??・?・?驍ｵ・??・?・?鬯?蛹・??・?髫?螢??・?/div>
                <div id="micPickerInfo" style="font-size:12px;opacity:0.85;margin-bottom:8px;">鬮?・??・?・?髯?・??・?・?髯溷供??螽??讌｢蜿会ｾつ鬮?蛹・??・?驍ｵ・?霑ｹ螟ｲ・?・??・?・?鬩穂ｼ夲??・?驍ｵ・?髴???・?讙趣??・??・?・?驍ｵ・?陷?・?・つ郢??遶擾??驍ｵ・?陞｢・?郢晢??驍ｵ・?隴?・??・?・??・?・?鬯?・?髣??会ｽ?蟶晏搦?・?・?髯?・??・?・?驍ｵ・?鬮?・??・?螳夲??螟ｲ・?・?驍ｵ・?陷会ｽ?遯?・?驍ｵ・?闕ｳ蟯?蜻?驍ｵ・?髴???・?讓抵??・?郢晢??/div>
                <select id="micDeviceSelect" style="width:100%;margin-bottom:10px;padding:6px;border-radius:4px;border:1px solid #555;background:#111;color:#eee"></select>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button id="micPickerPermBtn" style="padding:6px 10px;border:1px solid #777;background:#333;color:#eee;border-radius:4px">髫?髮?・?・?鬯?・?髣??会ｽ?蟶晏搦?・?・?髯?・??・?・?</button>
                    <button id="micPickerStartBtn" style="padding:6px 10px;border:1px solid #4e8cff;background:#2a4d8f;color:#fff;border-radius:4px">驍ｵ・?髦?蜷??・?驛｢譎???・?邵??驛｢・??・?・?驍ｵ・??・?・?鬯?・?陷?・??・?・?郢晢??/button>
                    <button id="micPickerCancelBtn" style="padding:6px 10px;border:1px solid #777;background:#444;color:#eee;border-radius:4px">驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?</button>
                </div>`;
            ov.appendChild(card); document.body.appendChild(ov);
            // events
            card.querySelector('#micPickerCancelBtn').onclick = ()=> closeMicPicker();
            card.querySelector('#micPickerPermBtn').onclick = async()=>{
                _userExplicitMicInit=true; await initMic(true);
                const list = await enumerateMicInputs(); _micDevicesCache = list; refreshMicPickerList();
            };
            card.querySelector('#micPickerStartBtn').onclick = async()=>{
                const sel = card.querySelector('#micDeviceSelect'); const val = sel && sel.value;
                selectedMicDeviceId = (val && val!=='default') ? val : null;
                _userExplicitMicInit=true; await initMic(true); closeMicPicker();
            };
        }
        refreshMicPickerList(); ov.style.display='flex';
    }catch(e){ console.warn('openMicPicker failed',e); }
}
function refreshMicPickerList(){
    const ov = document.getElementById('micPickerOverlay');
    const sel = ov && ov.querySelector('#micDeviceSelect');
    const info = ov && ov.querySelector('#micPickerInfo');
    const startBtn = ov && ov.querySelector('#micPickerStartBtn');
    if(!sel || !info || !startBtn) return;
    sel.innerHTML='';
    const list = _micDevicesCache||[]; const hasList = Array.isArray(list) && list.length>0;
    if(!hasList){
        const opt=document.createElement('option'); opt.value='default'; opt.textContent='(髣???・つ鬮?蛹・??・?驍ｵ・??・?・?髫?髮?・?・?鬯?・?陷・?・?・??・?・?髯?・??・?・?髯溷供??螽??鬥?蜍?・?・?鬩穂ｼ夲??・?)'; sel.appendChild(opt);
        info.textContent='驍ｵ・?隴?・??・?・??・?・?鬯?・?髣??会ｽ?蟶晏搦?・?・?髯?・??・?・?驍ｵ・?鬮?・??・?螳夲??螟ｲ・?・?驍ｵ・?陷?・?遶???・?譎???・?邵??驛｢・??・?・?髣???・つ鬮?蛹・??・?驍ｵ・?霑ｹ螟ｲ・?・??・?・?鬩穂ｼ夲??・?驍ｵ・?髴???・?讙趣??・??・?・?驍ｵ・?陷?・?・つ郢晢??; startBtn.disabled=false; return;
    }
    const mk=(id,label)=>{ const o=document.createElement('option'); o.value=id||'default'; o.textContent=label||id||'default'; return o; };
    sel.appendChild(mk('default','(驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?'));
    list.forEach((d,i)=>{ sel.appendChild(mk(d.deviceId, (d.label&&d.label.trim())?d.label:(`驛｢譎???・?邵??驛｢・??・?・?${i+1}`))); });
    sel.value = selectedMicDeviceId || 'default';
    info.textContent='髣????・?・?鬨?蛹・??・?驍ｵ・?陷?・??・?迢暦??譎???・?邵??驛｢・??・?・?驛｢・?陝ｶ譏ｶ?閧?・?・?髦?蜷??蝣?・?・?陟暮?会ｽ??驍ｵ・??・?・?驛｢譎???・?邵??驛｢・??・?・?驍ｵ・??・?・?鬯?・?陷?・??・?・?闕ｵ謨鳴鬮?・??・?螳夲??螟ｲ・?・?驍ｵ・?陷会ｽ?遯?・?驍ｵ・?闕ｳ蟯?蜻?驍ｵ・?髴???・?讓抵??・?郢晢??; startBtn.disabled=false;
}
function closeMicPicker(){ const ov=document.getElementById('micPickerOverlay'); if(ov) ov.style.display='none'; }


// 髯???・?・?髯?迚呻??蜴?讓抵??・??・?・?驛｢譏ｴ?・?・趣??驛｢・??・?・?髫?證ｦ・?・?髯橸??陞滂ｽ??・?・?髢?・??・?・??・?・?髫?蟷?・?・?髣懈瑳蜑?・?・?陋??・?・?郢晢??
function estimateOutputLatency(){
    let est=0;
    try{
        if(audioCtx){
            if(typeof audioCtx.outputLatency==='number') est+=audioCtx.outputLatency||0;
            if(typeof audioCtx.baseLatency==='number') est+=audioCtx.baseLatency||0;
        }
    }catch(_){ }
    if(!est || !isFinite(est) || est<0.005){
        // 驍ｵ・?驗呻??隨卍驍ｵ・??・?・?驍ｵ・?闕ｵ譏ｶ?鬘鯉ｽ??会ｽ?・?髯橸??陞｢・?・つ?・?・?: iOS 驍ｵ・??・?・?驛｢・?郢晢???・??髯樊ｻゑｽ?・?驍ｵ・?鬮?・??・??
        est = isIOS()? 0.12 : 0.08;
    }
    return Math.max(0.03, Math.min(0.3, est));
}

// ---- 鬮?・??・?・?髯??趣??驥・?抵??・??・?・?驛｢譏ｴ?・?・趣??驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?§・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・? ----
async function runLatencyCalibration(){
    try{
        ensureAudio();
        // 髫??会ｽ?・?驍ｵ・??・?・?髯具??隴・隰・髯具??陋ｹ??・?・?陋ｹ・?遶擾??驍ｵ・??・?・?驛｢・?霑壼??・?鬮?陬懈桶?・?・?郢???・??驍ｵ・??・?・?驍ｵ・?郢晢???・?・?鬩・?・?・??・?・?髯?・??・?・?驛｢謨鳴驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・?陷・?・?・?隰疲?ゑｽ?・??・?・?髯???・?・?驍ｵ・?髴域喚?驢搾??・?郢晢???・?・?郢晢??
        if(!micAnalyser){
            await initMic(false).catch(()=>{});
        }
        // 髯??陷?・?陷・??髣????・?・?驍ｵ・??・?・?驛｢・?隰梧汚??・?・つ髫?蠑ｱ・・??蜑ｰ・???・?・?郢晢??鬩・?・?・?陜捺?ゑｽ?・??・?・?驍ｵ・??・?・?鬯?謳?・?・?鬯?・?隴∵腸・?蟶晢??蛹・??・?驍ｵ・?闔会ｽ??・?荵・・?郢晢??
        if(isPlaying){ try{ pausePlayback(); }catch(_){ } }
    // 鬮?・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??驛｢譎｢・?・?驛｢譏ｴ?・??・??4髯区??霍晁怎??髫?譴?閻??・?・?陋ｹ・?邵?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髣???郢晢?? 髴托ｽ??・?・?髯懶???・?・?髣???陷?・??・?・??・?・?驍ｵ・??・?・?髯・闔会ｽ??・??髯?・??・?・?驍ｵ・?闕ｵ譎｢・?陋ｾ・?・?陷?・??・?・?陷茨???・?・?郢晢??
        const startLeadSec = 0.0; // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟郢・驛｢・??・?・?驛｢譎｢・?・?0髫?蠑ｱ・臥??蟶?・?・??・?・?髯??趣??譚ｿ・?驍ｵ・?郢晢??
        const spacingSec = 0.9;   // 驛｢譎擾??・?郢晢??驛｢譏ｴ?・?闖ｫ・?鬯?・?隴∵腸・?螳・蠑ｱ?・??・?・?驛｢・?郢晢??
        const noteDurSec = 0.45;  // 驛｢譎擾??・?郢晢??驛｢譏ｴ?・?髢??
    const count = 4;
        const baseMidi = 60; // C4 驛｢・?陋幢??郢晢??驛｢譎????青ｰ驛｢譎｢・?・?驛｢譏ｴ?・?
        const startSong = (playbackPosition||0) + 0.8; // 鬨?蛹・??・?鬯?・??・?・?髣???驗呻??邵?蝣?・?・?陋ｹ・??・?鬘俶??・?・?髯句??・?・?驍ｵ・?闕ｵ譎｢・?陋ｾ・?・?陷?・??・?・?郢晢??
        const ghost=[]; const targetTimes=[];
        for(let i=0;i<count;i++){
            ghost.push({midi:baseMidi, time:startSong + i*spacingSec, duration:noteDurSec, role:'calib'});
        }
    // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟郢・驛｢・??・?・?驛｢譎｢・?・?髯????らｫ企豪・?・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎???・?蟶晏??・?・?鬩穂ｼ夲??・?郢晢??騾趣??隰?謌?????・?・?郢晢??陝ｲ・??・??驍ｵ・?遶丞｣?・樣Δ譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・?陞ｳ螟ｲ・?・??・?・?髯橸??陞｢・??・??驍ｵ・??・?・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・??・?・?陞滂ｽ??・?蜥?・?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎???・?螳夲???闕ｳ螂???・?
    _calibAbort = false; // 髣????・?・?髫???・?・?驛｢譎???驥・??・?・??・?・?髯具??隴・隰・髯具??郢晢??
        isCalibrating = true;
        midiGhostNotes = ghost; calibPrevPos = playbackPosition; calibBasePos = startSong;
        calibAnchorActive = true; calibAnchorTime = ghost[0].time; calibAnchorMidi = ghost[0].midi; drawChart();
        // 3,2,1 驛｢・?陋幢??邵?蜀暦??譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕娯雷驍ｵ・??・?・?髯樊ｻゑｽ?・?驍ｵ・?鬮?・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?郢晢??陋ｹ・?邵?讓抵??譎｢・?・?驍ｵ・??・?・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・?陝ｷ謌?ｲり怦・??・?・?郢晢??
    calibCountdownText='3'; drawChart(); setTimeout(()=>drawChart(), 0); if(btCalibStatus) btCalibStatus.textContent='髮・鬮???・?蜥擾??・??・?・? 3';
    await new Promise(r=>setTimeout(r,600)); calibCountdownText='2'; drawChart(); setTimeout(()=>drawChart(), 0); if(btCalibStatus) btCalibStatus.textContent='髮・鬮???・?蜥擾??・??・?・? 2';
    await new Promise(r=>setTimeout(r,600)); calibCountdownText='1'; drawChart(); setTimeout(()=>drawChart(), 0); if(btCalibStatus) btCalibStatus.textContent='髮・鬮???・?蜥擾??・??・?・? 1';
    await new Promise(r=>setTimeout(r,500)); calibCountdownText=null; drawChart(); if(btCalibStatus) btCalibStatus.textContent='髮九ｑ??・?髯橸??陞｢・??・?・??・?・?驕ｯ・??・?・?郢晢??鬩・?・?・??・?・?鬩穂ｼ夲??・?驍ｵ・?髴???・?讙趣??・?郢晢??驍ｵ・??・?・?驍ｵ・??・?・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・?遶頑･???陋ｹ・??・?蜀暦??・?陝ｶ蜷??・?鬨?蜈ｷ・?・?髯橸???・?・?郢晢??郢晢??;
        // 鬩・?・?・?髫?蜑ｰ萓ｭ邵??驛｢譏???譁?豪・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?惧?・?・?闔・?郢晢??鬨??難??・?隲橸??髫?・?闕ｵ譎｢・?螳壽割?・?・?驛｢・?闕ｳ蟯???驍ｵ・??・?・? timelineOffsetSec 鬨?・??・?・?髯溷・萓ｭ?・?螳壽↑髴域攸・?驍ｵ・?陷?・??・?・?郢晢??
        // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟邵?讓抵??譎｢・?・?髫?蠑ｱ・臥??蟶?・?・?髮区????謌????隰費??遶頑･?諱?髴域攸・?驍ｵ・?陷?・??・?・?闔蛹・??・?陷?・?霎ｯ諷???・??・?・?startPerf驛｢・?陞ｳ螟ｲ・?・??・?・?髯橸??陞｢・??・??驍ｵ・??・?・?驍ｵ・?郢晢???・?・?郢晢??
        calibMoveStartPerf = performance.now()/1000;
        calibPrevPos = playbackPosition;
        const animate = ()=>{
            if(!isCalibrating || _calibAbort) return;
            try{
                const nowP = performance.now()/1000;
                const dt = Math.max(0, nowP - calibMoveStartPerf);
                // 鬮?遨ゑｽ?謨???驍ｵ・?陷?・??・?・?驗呻??・つ遶乗亢?・?鬨??難??・??・?・?陞｢・?遶頑･???闔会ｽ?・ゑｽ?驍ｵ・??・?・?驍ｵ・??・?・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・?遯?・?髯?・??・?・?驕ｶ鬘假??讖ｸ・?・??・?・?驍ｵ・??・?・?髯??趣??雋ｻ・?・?驛｢・?陋ｹ・?遶???驍ｵ・??・?・?鬮?遨ゑｽ?譏ｶ髮?驛｢・?郢晢??
                // 髯??陷?・?陷・??髣????・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?邵?驢搾??・?陷・?・?・??・?・?驛｢・?闕ｳ蟯??驢搾??・?郢晢??隨??驛｢・?遶丞仰遯??? 驛｢・?髮区??・?・?陷会ｽ??・??驍ｵ・?陷?・?隨??驛｢・?遶丞｣??? playbackPosition 驛｢・?陝ｶ謨鳴?・?・?驛｢・?遶丞､?・??
                playbackPosition = calibPrevPos + dt; // 1x 驍ｵ・??・?・?鬯?・??・?・?鬮?・?郢晢??
                drawChart();
                _calibRAF = requestAnimationFrame(animate);
            }catch(_){ _calibRAF = requestAnimationFrame(animate); }
        };
        if(_calibRAF) cancelAnimationFrame(_calibRAF); _calibRAF = requestAnimationFrame(animate);
        // 鬯?・??・?・?驍ｵ・??・?・?鬯?????・?驛｢・?陝ｲ・??・??驍ｵ・??・?・?驍ｵ・?郢晢???・?・?闔・?陟?鬮??薙§邵?荵滂ｽ?譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??驍ｵ・??・?・?郢晢??陝ｲ・?・つ郢?蜿?・?謌?ｲり峪・?陷・??髯具???・?・?髯具??陷会ｽ??・?螳壽割隲帛現?・?驍ｵ・?郢晢??
        const t0 = (audioCtx?.currentTime||0) + startLeadSec + 0.02;
        for(let i=0;i<count;i++){ const when = t0 + i*spacingSec; targetTimes.push(when); }
        const sr = audioCtx.sampleRate||48000; const win=2048; const tmp=new Float32Array(win);
        const onsetTimes=[];
        const deadline = t0 + count*spacingSec + 1.2; // AudioContext 髫?蠑ｱ・玖?・?驛｢譎??郢晢??驛｢・??・?・?
        const wallDeadline = (performance.now()/1000) + (count*spacingSec + 2.0); // 髯橸??遶擾??陷・??鬮?・?陋ｹ・?郢晢??驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?髣???隴取ｧ?鬨・
        // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ??・??驍ｵ・??・?・?鬯?・??・?・?髯区?ゑｽ?・?鬮?諛?・?遶擾??驛｢・?陷????・?髯具???・?・?髯具??郢晢??
        let lastDb=-120; const threshUp=8; // dB 髣???鬯・???・?鬯?・?闕ｳ鄙ｫ?螳夲???隲幢??郢晢??
        while(true){
            if(_calibAbort) break;
            const nowCtx = (audioCtx?.currentTime)||0;
            const nowPerf = performance.now()/1000;
            if(nowCtx >= deadline || nowPerf >= wallDeadline) break;
            if(!micAnalyser){ await new Promise(r=>setTimeout(r,10)); continue; }
            micAnalyser.getFloatTimeDomainData(tmp);
            // 鬩・?・?・?髫?蜑ｰ・?・?MS->dB
            let rms=0; for(let i=0;i<tmp.length;i++){ rms+=tmp[i]*tmp[i]; } rms=Math.sqrt(rms/tmp.length); const db=20*Math.log10(Math.max(1e-9,rms));
            // 髣???鬯・???・?髫??隲幢??郢晢??
            if(db - lastDb > threshUp && db>-50){
                // 鬮?證ｦ・?・?髫?・?髣??湖ｨ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髣????・?・?髯滂ｽ?郢晢??遶???髯?慣・?・?驍ｵ・??・?・?驛｢譎???郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?邵?・?驛｢・?陷?驛?遒???・??・?・?驍ｵ・?陷会ｽ?遯?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??驛｢・?髮区?停?髯区???・??・??鬮?・?隲?肩・?・??・?・?
                const srLoc = (audioCtx?.sampleRate)||48000;
                const frameCenter = ((micAnalyser?.fftSize)||2048) / (2*srLoc); // 鬩堺?・・?1ms@48k
                const pollJitter = 0.005; // 5ms 髣比ｼ夲??・?髯橸??郢晢??
                const onset = Math.max(0, audioCtx.currentTime - frameCenter - pollJitter);
                onsetTimes.push(onset);
            }
            lastDb = db*0.8 + lastDb*0.2; // 髯・闔会ｽ??・??驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?
            await new Promise(r=>setTimeout(r, 10));
        }
        if(_calibAbort){
            // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髣????・?・?髫???・?・?: 髯溷?難??蜿匁割髣皮甥?・??・??驍ｵ・?陷会ｽ?遯?・?鬩搾??郢???・?・?郢晢??
            try{ if(_calibRAF) cancelAnimationFrame(_calibRAF); }catch(_){ }
            _calibRAF = 0; isCalibrating=false; calibAnchorActive=false; midiGhostNotes=null; drawChart();
            if(btCalibStatus) btCalibStatus.textContent='髮九ｑ??・?髯橸??陞｢・?郢晢??髣????・?・?髫???・?・?驍ｵ・?髴???・?讙趣??・??・?・?驍ｵ・?陷会ｽ?隨??';
            try{ seekTo(0); }catch(_){ playbackPosition=0; playbackStartPos=0; drawChart(); }
            return;
        }
        // 驛｢譎???・?郢晢??驛｢譏ｶ??・??驛｢・??・?・?: 驍ｵ・?隴擾???・?讙趣??・?隶抵???・?迹夲?????驛｢・?郢?螂???・?闔会ｽ??・?? onset 驍ｵ・??・?・?髯・?・?・?髯滂ｽ?隲帑ｼ夲??・?陋滂ｽ??・??
        const deltas=[];
        for(const tt of targetTimes){
            let best=null,bd=1e9; for(const ot of onsetTimes){ const d=Math.abs(ot-tt); if(d<bd){ bd=d; best=ot; } }
            if(best!=null) deltas.push(best-tt);
        }
    // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?遶???・?・??・?・?驛｢譏???譁?豪・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯溷?薙??・?・?陋ｹ・?陟｢・?
    isCalibrating=false; if(_calibRAF){ try{ cancelAnimationFrame(_calibRAF); }catch(_){ } _calibRAF=0; }
    calibAnchorActive=false;
    midiGhostNotes = null; drawChart(); // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??鬮?・??・?・?鬩穂ｼ夲??・?驛｢・?髮区??・?・??・?・?髯晢???・?・?
        if(deltas.length>=4){
            // 髯樊ｻ薙§?・?迹壼?・・?・?鬯?・??・?・?髯?・??・?・?驍ｵ・??・?・?髣????・?・?髯樊ｻゑｽ?・?髯区?ゑｽ?・?
            deltas.sort((a,b)=>a-b); const med=deltas[Math.floor(deltas.length/2)];
            // 髯?闌ｨ・?・?髯?迚呻??蟶・・?驍ｵ・??・?・?鬩堺?夲??・?鬩搾???・?・?鬯?霈?・??・?・??・?・?郢晢??鬩・?・?・??・?・?髫?・?陷・?・?・?髫?雜｣・?・??・?・?髯滂ｽ?郢晢???・?・?闕ｵ譏ｴ?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??陋ｹ・??・?・?隲幢??郢晢??驛｢譎?蠕娯鴬驛｢・??・?・?驛｢・??・?・? ~ 髫?・??・?・?ms郢晢??陝ｲ・??・?螳夲??證ｦ・?・?鬯?・??・?・?驍ｵ・?陷会ｽ?・つ遶乗亢?・?髯?迚呻???遶???髯?慣・?・?驍ｵ・??・?・?鬮?蜿?・?・?隨・??驍ｵ・?闔会ｽ??・??
            const srLoc = (audioCtx?.sampleRate)||48000;
            const frameCenter = ((micAnalyser?.fftSize)||2048) / (2*srLoc);
            const detectBias = 0.015; // 鬯?・??・?・?髯区?ゑｽ?・?驛｢譎｢・?・?髯具??郢晢???・?・??・?・?鬩???陋滂ｽ??・?・?驗呻???・?莨・・?陝ｲ・?郢晢??驛｢譎?蠕娯鴬驛｢・??・?・?驛｢・??・?・?髫?證ｦ・?・?髯橸??郢晢??15ms)
            const inputBiasSec = frameCenter + 0.005 + detectBias; // 驕ｶ霈?・?21ms + 5ms + 15ms = ~41ms @48k
            const medOut = Math.max(0, med - inputBiasSec);
            const ms=Math.round(Math.max(0, Math.min(0.5, medOut))*1000);
            const oldMs = Math.round((btLatencySec||0)*1000);
            btLatencySec = ms/1000;
            btLatencyEnabled = true;
            if(btLatencyToggle) btLatencyToggle.checked=true;
            if(btLatencySlider){ btLatencySlider.value=String(ms); btLatencySlider.disabled=false; }
            if(btLatencyValue) btLatencyValue.textContent = `${ms} ms`;
            if(btCalibStatus) btCalibStatus.textContent = `髮九ｑ??・?髯橸??陞溘ｑ??・?陷亥沺・?・?: 鬩堺?・・?${ms} ms郢晢??鬩帚??・?髯?閧?蝮?遶????蛹・??・?郢晢??髣・;
            try{
                // 髮九ｑ??・?髯橸??陞溘ｑ??・?陷亥沺・?・?驍ｵ・??・?・?驛｢謨鳴驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・?陞ｳ螟ｲ・?・??・?・?鬩穂ｼ夲??・?郢晢??陋ｹ・?・主?・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?鬮?陬懈桶隰泌調・?・??・?・?驛｢・?陋ｹ・??・?鬘?蛹・??・?髮趣???・?・?郢晢??郢晢??
                setTimeout(()=>{ try{ alert(`鬮?・??・?・?髯?閧?蝮?遶???髯?慣・?・?鬮?・?隲?肩・?・??・?・?驍ｵ・??・?・?鬩搾??陷亥沺・?・?驛｢・?陝ｶ譏ｶ?螳??蛹・??・?驍ｵ・?陷会ｽ?遶擾??驍ｵ・?陷会ｽ?隨??:\n\n髫?證ｦ・?・?髯橸??陞｢・?郢晢??髯?迚呻???遶???髯?慣・?・?: 鬩堺?・・?${ms} ms\n(髣比ｼ夲??・?髯?莉｣?・? ${oldMs} ms)`); }catch(_){ } }, 0);
            }catch(_){ }
            // UI髯?・?髢?・?闕ｳ蜊?蜍滂ｽ?螽??讌｢諤咎?・?驍ｱ蟶敖蛹・??・?郢晢??騾趣??遶????蛹・??・?鬩搾??陷亥沺・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢・?陞ｳ螟ｲ・?・??・?・?鬩穂ｼ夲??・?郢晢??郢晢??
            drawChart();
        }else{
            if(btCalibStatus) btCalibStatus.textContent = '髮九ｑ??・?髯橸??陞｢・?邵?蝣?・?・?鬮?・?遶擾??驍ｵ・?陝ｶ蜻?・?骰具??・??・?・?驍ｵ・?陷会ｽ?隨??驍ｵ・?郢??郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?遶頑･???陋ｹ・??・?蜀暦??・?陝ｶ蜷??・?驛｢・?郢??遶???髣???・つ髯溯??・?・?驍ｵ・?鬯伜???・??・?・?驍ｵ・?陷会ｽ??・?・?驍ｵ・??・?・?驍ｵ・?髴???・?讓抵??・?郢晢??;
            try{ setTimeout(()=>{ try{ alert('鬮?・??・?・?髯?閧?蝮?遶???髯?慣・?・?鬮?・?隲?肩・?・??・?・?: 髮九ｑ??・?髯橸??陞｢・?邵?蝣?・?・?鬮?・?遶擾??驍ｵ・?陝ｶ蜻?・?骰具??・??・?・?驍ｵ・?陷会ｽ?隨??驍ｵ・?郢晢??n\n髯?・??・?・?髯懈圜・?・?驍ｵ・??・?・?驛｢譎擾??・?邵??驛｢・??・?・?驛｢・?陷?闌ｨ・?・?陝ｶ蜻?・?閾?・?・?陷会ｽ?・つ遶丞｣??驛｢譎｢・?・?驛｢譏ｴ?・?遶頑･???陋ｹ・??・?蜀暦??・?陝ｶ蜷??・?鬩墓得??・?驍ｵ・?陷諤憺?馴辨・??・?・?驍ｵ・?陷会ｽ?遯?・?驍ｵ・?闕ｳ蟯?蜻?驍ｵ・?髴???・?讓抵??・?郢晢??); }catch(_){ } }, 0); }catch(_){ }
            // 髯樊ｻゑｽ?・?髫?・?驍???陷・??驛｢・?郢??郢・驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?髯???・?・?驍ｵ・?髴域喚?驢搾??・?郢晢???・?・?郢晢??I髣???驗呻??郢晢??鬮?・??・?・?鬩穂ｼ夲??・?驍ｵ・??・?・?髯晏玄魍??晢??驛｢・?陷茨???・?・?郢晢??
        }
        // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?§・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?鬩搾??郢???・?・?郢晢???・?・?陟募?・・?鬯???・?・?驍ｵ・??・?・?髫??会ｽ?・?驛｢・?郢晢??
        try{ seekTo(0); }catch(_){ playbackPosition=0; playbackStartPos=0; drawChart(); }
    }catch(e){
        console.warn('calibration failed',e);
        if(btCalibStatus) btCalibStatus.textContent='髮九ｑ??・?髯橸??陞｢・?邵?鬘費??譎｢・?・?驛｢譎｢・?・?';
    } finally {
        // 驍ｵ・??・?・?驛｢・?髦?蜷????縺願ｿ?螟ｲ・?・??・?・?驍ｵ・??・?・?驛｢・?郢??・取㏍・?・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・?陜｣・??・?・??・?・?髯橸??雋???鬥?蝗?・?・?髫?・??・?・?驍ｵ・?陷会ｽ?・つ遶擾???・?・??・?・?鬩穂ｼ夲??・?驛｢・?髮区??・?・??・?・?髯晢???・?・?
        try{ if(_calibRAF) cancelAnimationFrame(_calibRAF); }catch(_){ }
        _calibRAF = 0;
        if(isCalibrating || midiGhostNotes){
            isCalibrating=false; calibAnchorActive=false; midiGhostNotes=null;
            drawChart();
        }
    }
}

// ---- 鬯?霈?・??・?・??・?・?鬮?・?隲?肩・?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎∬??・?・?髢?・?隨冗｢・??・?髣頑ｹ匁刮・?譎｢・?・?驛｢譎?惧?・?・?郢晢??----
async function runLatencyAssist(){
    try{
        ensureAudio();
        if(!micAnalyser){ await initMic(false).catch(()=>{}); }
        if(isPlaying){ try{ pausePlayback(); }catch(_){ } }
        // 髫??会ｽ?・?髯・陋滂ｽ?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?§・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?鬮?・??・?・?鬩穂ｼ夲??・?髯樊ｺ?蛻?霎溷?ゑｽ?・?陷?闌ｨ・?・?遶擾??騾??
        _assistAbort = false; isAssistMode = true; isCalibrating = true; // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟郢・驛｢・??・?・?驛｢譎｢・?・?鬮?・??・?・?鬩穂ｼ夲??・?驍ｵ・??・?・?驍ｵ・?雋?∞??? calibrating 驛｢譎???驥・??・?・??・?・?驛｢・?郢???・?・??・?・?驍ｵ・?郢晢??
        // 驛｢譎擾??・?郢晢??驛｢譏ｴ?・?陷・??髫?蠕?・? 髴托ｽ??・?・?髯懶???・?・?髣???陷?・??・?・??・?・?驍ｵ・??・?・?髯・闔会ｽ??・??髯?・??・?・?驍ｵ・?闕ｵ譎｢・?陋ｾ・?・?陷?・??・?・?闕ｵ譎｢・??驍ｵ・?遶擾???・?・?・つ髯橸??陞溯?・?・?鬯?・?隴∬・?螳夲??・?遶丞､?・??鬩搾??陞｢・??・??驛｢・?郢晢??
        const baseMidi = 60; // C4
        const spacingSec = 0.8; // 髣???・つ髯橸??陞溯?・?・?鬯?・?郢晢??
        const noteDurSec = 0.45;
        const startSong = (playbackPosition||0) + 0.8;
        midiGhostNotes = [];
        calibPrevPos = playbackPosition; calibBasePos = startSong;
        calibAnchorActive = true; calibAnchorTime = startSong; calibAnchorMidi = baseMidi;
        // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟郢・驛｢・??・?・?驛｢譎｢・?・?
        calibCountdownText='3'; drawChart(); setTimeout(()=>drawChart(), 0); if(btCalibStatus) btCalibStatus.textContent='髮・鬮???・?蜥擾??・??・?・? 3';
        await new Promise(r=>setTimeout(r,600)); calibCountdownText='2'; drawChart(); setTimeout(()=>drawChart(), 0); if(btCalibStatus) btCalibStatus.textContent='髮・鬮???・?蜥擾??・??・?・? 2';
        await new Promise(r=>setTimeout(r,600)); calibCountdownText='1'; drawChart(); setTimeout(()=>drawChart(), 0); if(btCalibStatus) btCalibStatus.textContent='髮・鬮???・?蜥擾??・??・?・? 1';
    await new Promise(r=>setTimeout(r,500)); calibCountdownText=null; drawChart(); if(btCalibStatus) btCalibStatus.textContent='驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏???蛹・??・??・?・?驕ｯ・??・?・? 髯句??繩??・?・??・?・?驛｢譎?鯵邵?・?驛｢譎｢・?・?驍ｵ・??・?・?鬩搾??郢???・?・?郢晢??邵?蝣?・?・?鬮?・?遶擾??驍ｵ・?郢晢??;
    // 鬯?霈?・??・?・??・?・?鬮?・?隲?肩・?・??・?・?驛｢・?陷?蝓淞蜑ｰ諤・・?・?髯具??陷???・?・?闔・?陷???・?蠑ｱ・・??????謫?・?・?鬨?蛹・??・?郢晢??郢晢??
    btLatencyEnabled = true; if(btLatencyToggle){ btLatencyToggle.checked = true; }
    if(btLatencySlider){ btLatencySlider.disabled = false; }
    // 髣比ｼ夲??・?鬯?・?鬮?・?郢晢??鬮?・?陋滂ｽ?????驛｢・?陞ｳ螟ｲ・?・??・?・?髯?・??・?・?驍ｵ・?陷?・??・?迢暦??・?雋?∞??? calibrating 驍ｵ・??・?・?鬮?證ｦ・?・?鬯?・??・?・?
    isCalibrating = false;
    // 鬮?證ｦ・?・?髫?・?髣??娯蔓驛｢・??・?・?驛｢譎???・?郢晢??驛｢・?陞ｳ螟ｲ・?・??・?・?髯?髦??・?
    if(!analysisTimer){ analysisTimer = setInterval(analyzePitch, 1000/analysisRate); }
    // 髫??会ｽ?・?髯・陋滂ｽ?郢晢??髫俶誓??・?髴難???・?・?髯橸???・?・?髮・?・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??鬩・?・?・??・?・?髫?・??・?・?驛｢・?陞ｳ螟ｲ・?・?闕ｵ譎｢・??驍ｵ・?陷?・??・?・?郢晢??郢晢??
    pitchHistory = []; scoreSessionId++;
    // 驛｢・??・?・?驛｢譏???譁?豪・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?鬯?・?陷?・??・?・?郢晢??
        calibMoveStartPerf = performance.now()/1000; calibPrevPos = playbackPosition;
        const animate = ()=>{
            if(!isAssistMode || _assistAbort) return;
            try{
                const nowP = performance.now()/1000; const dt = Math.max(0, nowP - calibMoveStartPerf);
                playbackPosition = calibPrevPos + dt; // 1x鬯?・?雋????・?・??・?・?
                // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??驛｢譎｢・?・?驛｢譏ｴ?・??・?螳・・?郢晢???・?・?遶乗亢?・?驍ｵ・??・?・?驍ｵ・?鬯倬?会ｽ?・?隲幢??郢晢??
                const tNow = playbackPosition;
                const wantAhead = 8; // 髯?逎ｯ繝｡?・?・??・?・?驍ｵ・??・?・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・?霎?
                let lastTime = (midiGhostNotes.length? (midiGhostNotes[midiGhostNotes.length-1].time + midiGhostNotes[midiGhostNotes.length-1].duration) : startSong - spacingSec);
                // 髯?・??・?・?鬮?蜍滂ｽ?諛ｶ・?・?闔ｨ諛茨??・?驍ｵ・?闕ｵ譎｢・?閾?・?・??・?・?驍ｵ・?郢晢??郢晢??髯晢???・?・?驍ｵ・??・?・?髯?・??・?・?驍ｵ・?郢晢??邵?荵滂ｽ?譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??鬯?・?霓｣蛛???・?髴???・?・?
                const keepAfter = tNow - 5;
                if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                    while(midiGhostNotes.length && (midiGhostNotes[0].time + midiGhostNotes[0].duration) < keepAfter){ midiGhostNotes.shift(); }
                }
                // 髫?蟷?・?・?髫?螟ｲ・?・?髯句??・?・?驛｢・?髮区????繧会ｽ?・?遶丞､?・??
                while(true){
                    const futureCount = midiGhostNotes.filter(n=> n.time >= tNow - 0.1).length;
                    if(futureCount >= wantAhead) break;
                    const nextStart = (midiGhostNotes.length? (midiGhostNotes[midiGhostNotes.length-1].time + spacingSec) : (startSong));
                    midiGhostNotes.push({midi:baseMidi, time: nextStart, duration: noteDurSec, role:'calib'});
                }
                drawChart();
                _assistRAF = requestAnimationFrame(animate);
            }catch(_){ _assistRAF = requestAnimationFrame(animate); }
        };
        if(_assistRAF) cancelAnimationFrame(_assistRAF); _assistRAF = requestAnimationFrame(animate);
    }catch(e){
        console.warn('assist start failed', e);
        // 髯樊ｻゑｽ?・?髫?・?驍???陷・??驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??
        try{ if(_assistRAF) cancelAnimationFrame(_assistRAF); }catch(_){ }
        _assistRAF=0; isAssistMode=false; isCalibrating=false; calibAnchorActive=false; midiGhostNotes=null; drawChart();
        if(btCalibStatus) btCalibStatus.textContent='驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎会ｽ?・?陝ｷ謌?ｲり嵯譏ｶ?讌｢譽・・?・?髫?・?陷会ｽ??・??驍ｵ・??・?・?驍ｵ・?陷会ｽ?隨??';
    }
}

function stopLatencyAssist(){
    try{ _assistAbort = true; if(_assistRAF){ cancelAnimationFrame(_assistRAF); } }catch(_){ }
    _assistRAF = 0; isAssistMode=false; isCalibrating=false; calibAnchorActive=false; midiGhostNotes=null; drawChart();
    if(btCalibStatus) btCalibStatus.textContent='驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎???・?・?郢???・?・?郢晢??;
}
// 髫??会ｽ?・?驛｢譎｢・?・?髣???驕擾??・主?頑??・?・?髯橸??陞｢・?郢晢??驛｢譏ｴ?・?邵?螟ゑ??・??・?・?髯晏??・??・?・??・?・?郢晢??郢晢??ndex.html驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟?取ｺ?・?譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?鬯?・?郢晢???・?・?郢晢???・?・?郢晢??

// 驛｢譎?蠕湖暮Δ譎???譁撰?憺匚閧?・?・??・?・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?鬮?螟ｧ・?・??・?蜥?・?・?陷?闌ｨ・?・?隲・?・?・??・?・?郢晢??陜捺?督蜻?譽・・?・? maxMs 髯??郢晢???・?・?陝ｲ・?・つ郢?螂???・?闕ｵ譏ｶ蜻?驍ｵ・?闕ｵ譎｢・?閾?・?・??・?・?驍ｵ・?闔会ｽ??・?讙趣??・??・?・? 0 驛｢・?陞ｳ螟ｲ・?・?隴∫????驍ｵ・?郢晢??
function findZeroCrossOffsetSec(buf, maxMs){
    try{
        const sr = buf.sampleRate||48000;
        const chL = buf.numberOfChannels>0? buf.getChannelData(0): null;
        const chR = buf.numberOfChannels>1? buf.getChannelData(1): null;
        if(!chL) return 0;
        const maxS = Math.min(chL.length, Math.floor(sr * (maxMs||0.005)));
        // 1) 鬨?・?雋???・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??髢?・??・?・??・?・?髯?・??・?・?髯?・?陝雜｣・?・??・?・?郢晢??陝ｲ・??・?螳壽・・?・?髯???迴?・つ郢???・?・??・?・?髯?・??・?・?驍ｵ・??・?・?髯晢???・?・?髯懶??郢晢??邵?螳壼?・・?・?髯橸??陞｢・?・つ郢晢??
        let prev = (chL[0] + (chR? chR[0]: 0)) * (chR? 0.5: 1);
        for(let i=1;i<maxS;i++){
            const cur = (chL[i] + (chR? chR[i]: 0)) * (chR? 0.5: 1);
            if((prev<=0 && cur>0) || (prev>=0 && cur<0)){
                // 鬩搾??陞｢・??・?・??・?・?鬮?・?隲橸??闖ｫ・?驍ｵ・??・?・?髮・?・?・?鬩墓?・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?髣・?・?・?髯晢???・?・?髴難???・?・?驛｢・?陷?驛?・?髯橸??郢晢??
                const frac = Math.abs(cur - prev) > 1e-12 ? (Math.abs(prev) / Math.abs(cur - prev)) : 0;
                const pos = (i-1) + frac; // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取辨・・・?・?髯溯??・?・?
                return pos / sr;
            }
            prev = cur;
        }
        // 2) 鬮?・??・?・?髯?・??・?・?髯?・?陝雜｣・?・??・?・?驍ｵ・?隶吝ｯ???驍ｵ・?闔会ｽ??・?讙趣??・??・?・?驍ｵ・?遶擾???・?・??・?・?髯・?・?・?髯区?ゑｽ?・?髫????髯・陷蜉ｱ笳矩Δ??陝ｶ譏ｶ?閧?・?・??・?・?郢晢??闔・??・?・??・?・?髯?・??・?・?髯晢???・?・?髯懶??郢晢???・?・?郢晢??
        let bestI=0; let bestAbs=1e9;
        for(let i=0;i<maxS;i++){
            const vL = Math.abs(chL[i]); const vR = chR? Math.abs(chR[i]) : vL; const v = (vL + vR) * (chR? 0.5: 1);
            if(v<bestAbs){ bestAbs=v; bestI=i; if(v<1e-5) break; }
        }
        return bestI / sr;
    }catch(_){ return 0; }
}

// WAV驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??驛｢・??・?・?鬮?證ｦ・?・?髫?・?隰?・??・?・?郢晢??ampleRate 驍ｵ・??・?・? smpl 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟郢晢??髫?螟ｲ・?・?髯???・?・?郢晢??郢晢??
function readWavMeta(arrayBuffer){
    // RIFF/WAVE 驍ｵ・??・?・? "fmt " 驍ｵ・??・?・? "smpl" 驛｢・?陞ｳ螟ｲ・?・??・?・?驍ｵ・??・?・?驍ｵ・?邵?陋士pleRate 驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取?諤?陋??・?・?郢晢??驛｢・?陞ｳ螟ｲ・?・?隴∫????
    const dv=new DataView(arrayBuffer);
    function readStr(off,len){ let s=''; for(let i=0;i<len;i++){ s+=String.fromCharCode(dv.getUint8(off+i)); } return s; }
    let meta={ sampleRate:0, loopStart:null, loopEnd:null };
    try{
        if(readStr(0,4)!=='RIFF' || readStr(8,4)!=='WAVE') return meta;
        let p=12; // chunk start
        const len=dv.byteLength;
        while(p+8<=len){
            const id=readStr(p,4); const size=dv.getUint32(p+4,true); const body=p+8; const next=body+size + (size%2);
            if(id==='fmt '){
                if(size>=16){ meta.sampleRate = dv.getUint32(body+4,true); }
            } else if(id==='smpl'){
                // https://sites.google.com/site/musicgapi/technical-documents/wav-file-format#smpl
                if(size>=36){
                    const numLoops = dv.getUint32(body+28,true);
                    let lpOff = body+36;
                    for(let i=0;i<numLoops;i++){
                        if(lpOff+24>len) break;
                        const start = dv.getUint32(lpOff+8,true);
                        const end   = dv.getUint32(lpOff+12,true);
                        // 髫????髯具??隴擾??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ??・?螳夲??證ｦ・?・?鬨?蛹・??・?
                        meta.loopStart = start; meta.loopEnd = end; break;
                    }
                }
            }
            p = next;
        }
    }catch(_){ }
    return meta;
}
// ---- Audio file loader (melody/accompaniment) ----
let melodyBuffer=null, accompBuffer=null;
let melodySource=null, accompSource=null;
let melodyDuration=0, accompDuration=0;
let melodyNotesExtracted=false;
// 驛｢・??・?・?驛｢譏ｴ?・?邵?蜥擾??譎｢・?・?驛｢譎｢・?・?髣???隴取得??・?陋滂ｽ?騾?驢搾??・??・?・?髯?蛹??・?郢晢??鬯?・??・?・?髯橸???・?・?驛｢譎?蠕娯鴬驛｢譎???・?繧??・?・隰・
let melodyOrigBytes=null, melodyOrigName=null, melodyOrigExt=null;
let accompOrigBytes=null, accompOrigName=null, accompOrigExt=null;

async function decodeAudioFile(file){
    ensureAudio();
    const ab=await file.arrayBuffer();
    return await new Promise((res,rej)=> audioCtx.decodeAudioData(ab, b=>res(b), e=>rej(e)));
}

function stopAllSources(){
    try{ if(melodySource){ melodySource.stop(); melodySource.disconnect(); } }catch(_){ }
    try{ if(accompSource){ accompSource.stop(); accompSource.disconnect(); } }catch(_){ }
    try{ melodySources.forEach(s=>{ try{s.stop(0);}catch(_){ } try{s.disconnect();}catch(_){ } }); }catch(_){ }
    melodySources=[];
    melodySource=null; accompSource=null;
}

function createAndStartSource(buf, when, offset, destGain){
    const src=audioCtx.createBufferSource(); src.buffer=buf; src.connect(destGain);
    try{ src.start(when, Math.max(0, offset)); }catch(_){ src.start(); }
    return src;
}

// 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??髮主桁??・?髯溷私??・?驍ｵ・?闕ｵ譎｢・???諤?陋滂ｽ?雎ｬ・?髯具??陷会ｽ??・?蟶晢??・?陋滂ｽ??・?・??・?・?髯溯??・?・?髫?螟ｲ・?・?髯???・?・?
// 髫??陋ｹ・??・?・?郢晢?? 髮・?・?・?鬮?遨ゑｽ?讒ｫ?・??・??・?・?髯晢???・?・?鬨?・??・?・?鬯?・??・?・?(NACF) + 驛｢譏???・?・主??・?譎?鯵・取㏍・?譏ｴ?・?邵???蜍ｳ隲橸??闖ｫ・? + 鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?髯具???・?・?鬩堺?・・??・?繧托ｽ?・?2髯?雍???竏ｵ・?・?) + 驛｢譎?・?邵?蟶?・?譏ｴ?・?・取㏍・?・??・?・?驛｢・??・?・?髯具??郢晢???・?・?・つ + 鬩墓得??・?鬯?・??・?・?驛｢譎???・?郢晢??驛｢・??・?・?
async function extractMelodyNotesFromBuffer(buf){
    // 鬮?證ｦ・?・?髫?・?髯應ｼ夲??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?蠕?・?驛｢譎｢・?・?驛｢・??・?・?
    const overlay=document.getElementById('analyzingOverlay');
    if(overlay){ overlay.classList.remove('hidden'); }
    const sr = buf.sampleRate;
    const ch0 = buf.getChannelData(0);
    // 驛｢・??・?・?驛｢譏ｴ?・?・取ｨ抵??・??・?・?驍ｵ・??・?・?鬩・?・?・?髫?蜀猟ｧ?・?・??・?・?髯懶??郢晢??邵?蝣?・?譎｢・?・?驛｢譎擾??・?・主??・?譎｢・?・?髯具??郢晢??
    const ch1 = buf.numberOfChannels>1 ? buf.getChannelData(1) : null;
    const mono = new Float32Array(ch0.length);
    for(let i=0;i<mono.length;i++) mono[i] = ch0[i] * (ch1? 0.5: 1) + (ch1? ch1[i]*0.5 : 0);
    // 驛｢譎丞ｹ?・取㏍・?・??・?・?驛｢譎｢・?・?驛｢譎???譁撰?憺Δ???・?・?驛｢・??・?・?郢晢??陋ｹ・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎???・?・趣??驛｢譏???・??・?・??・?・?鬯?・??・?・?驍ｵ・??・?・?鬮???・?・?髮九?・?・??・?・?郢晢??y[n]=x[n]-a*x[n-1]
    try{
        const a = 0.97;
        let prev = 0;
        for(let i=0;i<mono.length;i++){
            const x = mono[i];
            mono[i] = x - a*prev;
            prev = x;
        }
    }catch(_){ }

    // 驛｢譏???・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎???・?・趣??驛｢・??・?・?髫?・??・?・?髯懈ｺ・・? 鬩埼宦蟷?・取㏍・?・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取亢?・?郢晢??11.025kHz郢晢??陝ｲ・??・??驍ｵ・??・?・?鬮?・?髢?・??・?・?鬩?・?郤・??驛｢・?髮区??・?・??・?・?髯晢??郢晢??遶頑･?諱・?・汚??・?郢晢??
    const targetSR = 11025;
    const dsFactor = Math.max(1, Math.floor(sr/targetSR));
    const srd = sr / dsFactor; // 髯橸??雋?陜ｨ?驍ｵ・??・?・?驛｢謨鳴驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取鞄R
    const dsLen = Math.floor(mono.length / dsFactor);
    const ds = new Float32Array(dsLen);
    // 鬩・?・?・?髫?蜑ｰ萓ｭ郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?邵?鬘梧???・?・?髯懶??郢晢??邵?蝣?・?謨鳴驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取㏍・?譎｢・?・?驛｢・??・?・?
    for(let i=0, j=0; i<dsLen; i++, j+=dsFactor){
        let sum=0; let cnt=0; for(let k=0;k<dsFactor && (j+k)<mono.length; k++){ sum+=mono[j+k]; cnt++; }
        ds[i] = sum/Math.max(1,cnt);
    }

    // 鬮?證ｦ・?・?髫?・?陷・?・?・??・?・?髯橸??陞滂ｽ??・?・?陋ｹ・?郢・驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取??蜍滂ｽ?蠕?・?髯晢???・?・?髯懈瑳・?蛟ｪ?讌｢??陋ｹ・??・?蜀暦??・?陝ｶ蜻?・?荵・・?郢晢??
    const fmin = 65;   // Hz
    const fmax = 1200; // Hz
    const desiredRate = Math.max(28, Math.min(60, (analysisRate||20)+25)); // 鬯?・?陋滂ｽ??・?・??・?・?髯溯??・?・?髯具??陷???・?・?郢晢??60fps髣???闔ｨ竏晏???晢??郢晢??
    // 鬩???鬯?・?髢?讓抵??・??・?・? ~90ms 鬨?・??・?・?髯橸??陝ｲ・?・つ郢晢??1024,2048]驍ｵ・??・?・?2髯???・?・?驍ｵ・??・?・?髣????・?・?驛｢・?郢晢??
    const targetWinSec = 0.09; const targetW = Math.floor(srd*targetWinSec);
    const pow2 = (x)=> 1<<Math.round(Math.log2(Math.max(1,x)));
    const W = Math.max(1024, Math.min(2048, pow2(targetW)));
    const H = Math.max(1, Math.floor(srd/Math.max(28, desiredRate))); // 鬮?證ｦ・?・?髫?・?髫?・?ps驛｢・?髮区??・?・?髴域喚?・?髣???驗呻???・?・?
    const tauMin = Math.max(2, Math.floor(srd / fmax));
    const tauMax = Math.max(tauMin+2, Math.min(Math.floor(srd / fmin), Math.floor(W*0.9)));
    // 鬩???鬯?・?隴幢??髫?・??・?・?郢晢??郢晢??ann郢晢??郢晢??
    const hann = new Float32Array(W);
    for(let n=0;n<W;n++) hann[n] = 0.5*(1-Math.cos(2*Math.PI*n/(W-1)));

    // 鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?髯具???・?・?鬩堺?・・? 髯?隨?・?髮・??讌｢・?證ｦ・?・?髯橸??陞｢・??・?螳壼?・・?・?鬨?蛹・??・?驍ｵ・?陷会ｽ?遯?・?髫?證ｦ・?・?鬩肴得??・?鬩???郢晢??陝ｲ?驛｢・?鬮?・??・?・?2髯?雍???竏ｵ・?・?驍ｵ・??・?・?鬩搾??隶抵???・?荵・・?闔・?郢晢??髯?軸・?・?郢晢??髯?闌ｨ・?・?髯懈瑳・?繧托ｽ?・?郢晢??
    const SEMI_NARROW = Math.pow(2, 2/12); // 鬩堺?・・??・?・?2髯?雍???竏ｵ・?・?
    let prevFreq = 0; let prevTau = 0;

    // YIN (CMND) 驍ｵ・??・?・?驛｢・?陋ｹ・??・??門??惱・??・?・?隲?メ?・?髯橸??郢晢?? 驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯?・?陟包???・?・?・つ驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?鬩搾???・?・?髣???・つ
    // 驍ｵ・?髦?蜻?・??驍ｵ・??・?・?驍ｵ・??・?・? frameArr 驛｢・?郢晢??YinPitchTracker 驍ｵ・??・?・?髫?螢?萓帷?晢??驍ｵ・?陷会ｽ?・つ邵?陝ｻu 驍ｵ・??・?・? conf 驛｢・?陞ｳ螟ｲ・?・?隴∫????
    const yinTrackerOffline = (function(){
        try{
            const M = (window && window.__PitchModules) ? window.__PitchModules : null;
            if(M && M.YinPitchTracker){
                const yt = new M.YinPitchTracker({ sampleRate: srd, frameSize: W, fmin, fmax, threshold: 0.15 });
                return yt;
            }
        }catch(_){ }
        return null;
    })();
    function yinBestTauCMND(frameArr){
        try{
            if(yinTrackerOffline){
                const r = yinTrackerOffline.process(frameArr);
                // process 驍ｵ・??・?・? {freq, tau, conf}
                if(r && r.tau && isFinite(r.tau)){
                    return { tau: r.tau, conf: Math.max(0, Math.min(1, r.conf||0)) };
                }
                return { tau: -1, conf: 0 };
            }
        }catch(_){ }
        // 驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?: 髯樊ｻゑｽ?・?髫?・?驍???陷・??驍ｵ・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?髯区?ゑｽ?・?
        return { tau: -1, conf: 0 };
    }

    // Goertzel: 髣比ｼ夲??・?髫?・?闕ｳ讓?狭髮主桁??・?髫?・??・?・?驍ｵ・??・?・?驛｢譏???・?・趣??驛｢譎｢・?・?驛｢・?陝ｶ譎｢・?・?陋滂ｽ?・つ雋????・?・?隲?諛?・?郢晢??郢晢??FT髣???陝雜｣・?・?郢晢???・?・?郢晢??
    function goertzelPower(frameArr, sr, freq){
        if(!(freq>0) || freq>=sr*0.5) return 0;
        const w = 2*Math.PI*freq/sr;
        const c = Math.cos(w);
        const coeff = 2*c;
        let s0=0, s1=0, s2=0;
        for(let n=0;n<frameArr.length;n++){
            s0 = frameArr[n] + coeff*s1 - s2;
            s2 = s1; s1 = s0;
        }
        const power = s1*s1 + s2*s2 - coeff*s1*s2; // magnitude^2
        return Math.max(0, power);
    }
    // SHS: f0 驍ｵ・??・?・?髫?・??・?・?髫?・??・?・?髯区?・・?1..K)驍ｵ・??・?・?驛｢譏???・?・趣??驛｢譎｢・?・?驛｢・?陷?闌ｨ・?・?陝ｷ??・?・??・?・?鬯?・?鬮?・?遶擾??驍ｵ・??・?・?髯?・?髢?・??・?・?郢晢??
    function shsScore(frameArr, sr, f0, K){
        if(!(f0>0)) return 0;
        const maxH = Math.max(1, K|0);
        let sum=0; let used=0;
        for(let k=1;k<=maxH;k++){
            const fk = f0*k; if(fk>=sr*0.5) break;
            const p = goertzelPower(frameArr, sr, fk);
            // 鬯?・?鬮?・?遶擾?? 1/k郢晢??騾趣???・?・?闖ｫ・??・?・??・?・?驍ｵ・??・?・?髯滓汚??・?驛｢・?郢晢???・?・?郢晢??
            sum += (p>0? Math.sqrt(p): 0) * (1/k);
            used++;
        }
        return used? sum/used : 0;
    }

    // 驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?髮惹??・?・?郢晢??髫?證ｦ・?・?髯橸??郢晢??-> 髯?・??・?・?髮主桁??・?髫?・??・?・?髯具??郢晢??
    const freqs = [];
    const octHints = []; // true: 驍ｵ・?髦?蜷??・?驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?髫?證ｦ・?・?髯橸??陞｢・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・?陞滂ｽ??・?髦??・?郢晢??au0/2 or tau0*2郢晢??陝ｲ・?・ゑｽ?驛｢・?髯具??遶剰ご??・??・?・?驛｢・?陟募??陞ｺ
    const amps = [];
    const frame = new Float32Array(W);
    const NACF_BASE = 0.28; // 驛｢譎??郢晢??驛｢・??・?・?髯区?ゑｽ?・?郢晢??郢晢??MS驍ｵ・??・?・?髯?閧??蜍???驍ｵ・??・?・?髯樊ｺ?逕･陜滂ｽ?驍ｵ・?髴域喚髮?驛｢・?陷茨???・?・?郢晢??
    const NACF_HOLD   = 1;    // 髫?蟶?逕･?・?・??・?・?/髴取ｻゑｽ?・?髯橸???・?・?鬯?・??・?・?驍ｵ・??・?・?驛｢譎?・?邵?蟶?・?譏ｴ?・?・取㏍・?・??・?・?驛｢・??・?・?鬨?蛹・??・?驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?髣???隴・隰・
    let voicedHold = 0;
    let yieldCounter=0;
    const candFreqsPerFrame=[]; // Viterbi鬨?蛹・??・?: 髯?・?郢晢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯区???・・?・?隲幢??隰?歓??蛹・??・?髫?・??・?・?
    const candCostsPerFrame=[]; // Viterbi鬨?蛹・??・?: 髯?・?郢晢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯区???・・?・?隲帷??・・Δ???・?・?驛｢譎∬??・?・?闔蛹・??・?陟托???・?讓抵??・??・?・?驍ｵ・??・?・?雎ｼ・??・?・?驍ｵ・?郢晢???・?・?郢晢??
    // 鬮?・??・?・?髯??趣??譁撰??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?§・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?: 髯??陝ｶ譎｢・?・??・?・?鬩堺?・・?.5鬩穂ｼ・・?邵?? f/2 驍ｵ・?郢晢??f 驛｢・?陋ｹ・??・?鬘?????・?驍ｵ・?郢晢??邵??髯?・?闔会ｽ?・ゑｽ?驛｢・?陷?驛?・?髯橸??郢晢??
    let preferLowerOct=false; let calLowSum=0, calCurSum=0, calFrames=0; const CAL_FRAMES=Math.max(8, Math.min(64, Math.round(1.5*srd/H)));
    for(let i=0;i+W<=ds.length; i+=H){
        // 驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?髫?螟ｲ・?・?髯???・?・? + DC鬯?・??・?・?髯?・??・?・? + 鬩???隰撰??陝???驍ｵ・?郢晢??
        let mean=0; for(let k=0;k<W;k++){ mean+=ds[i+k]; }
        mean/=W;
        let energy=0; for(let k=0;k<W;k++){ const v=(ds[i+k]-mean)*hann[k]; frame[k]=v; energy+=v*v; }
        const rms=Math.sqrt(energy/W);
        if(rms<1e-4){
            // 髴取ｻゑｽ?・?鬯?・??・?・?驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?: 髫?蠑ｱ・玖?・?髯懶???・?・?鬩搾???・?・?驛｢・?陝ｶ譏ｶ闌?し??闔会ｽ??・?迢暦??・?雋?∞??? Viterbi 髯区???・・?・?隲帛ｲ??骰具??・?郢?菫・??髯橸???・?・?鬯?・??・?・?驛｢・?髮区???・?驛｢・?陟募???・?髯晢??郢晢???・?・??・?・?
            freqs.push(0); octHints.push(false); amps.push(rms);
            candFreqsPerFrame.push([0]);
            candCostsPerFrame.push([0.05]); // 髮趣???・?・?驍ｵ・?郢晢??隨冗｢・??・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?髴取ｻゑｽ?・?髯橸???・?・?鬯?・??・?・?
            if((++yieldCounter % 200)===0){ await new Promise(r=>setTimeout(r,0)); }
            continue;
        }

        // 髫?證ｦ・?・?鬩肴得??・?鬩???郢晢??陝ｲ?驍ｵ・??・?・?髮手ｶ?・?・?髯橸??陞滂ｽ??・?・?髢?・?陝ｲ・?鬮?螟ｧ・?貂?0驛｢・?陷?蝓淞蜻?諤・・?・?髯???迴?・つ遶乗劼・?・?郢晢???・?・?遶擾??陷・??驍ｵ・??・?・?驍ｵ・??・?・??・?繧托ｽ?・?1驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§?・?繧????隲・?・?・?髮懶???・?・?郢晢??
        let searchRanges;
        if(prevFreq>0){
            const tau0 = srd/prevFreq;
            const pad=2;
            const mkRange=(center,type)=>{
                if(!(center>tauMin && center<tauMax)) return null;
                const mn=Math.max(tauMin, Math.floor(center/SEMI_NARROW) - pad);
                const mx=Math.min(tauMax, Math.ceil(center*SEMI_NARROW) + pad);
                if(mx>mn) return {min:mn, max:mx, type};
                return null;
            };
            // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驕ｶ髮∝ｮ??・?・?驗呻??邵?讙趣??・??・?・?驕ｶ髮∝ｮ??・?・?闕ｵ譏ｴ窶?驛｢・??・?・?驍ｵ・??・?・?鬯??郢晢??邵?蝣?・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?郢晢??陋ｹ・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?髣皮甥???・?・?髮懶???・?・?郢晢??
            searchRanges = [
                mkRange(tau0, 'local'),
                mkRange(tau0*0.5, 'oct0_5'),
                mkRange(tau0*2, 'oct2')
            ].filter(Boolean);
        } else {
            searchRanges = [{min:tauMin, max:tauMax, type:'local'}];
        }

        // 髮・?・?・?鬮?遨ゑｽ?讒ｫ?・??・??・?・?髯晢???・?・?鬨?・??・?・?鬯?・??・?・?: R(?・?荳・・?/sqrt(E0*E?・?荳・・?
    let bestTau=-1, bestR=-1, bestType='local';
    let bestScore=-1; // 驛｢譎?蠕娯鴬驛｢・??・?・?驛｢・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?驍ｵ・??・?・?髮手ご・?????・?郢晢??騾?驢搾??・??・?・?驛｢・??・?・?驛｢・??・?・?
        // E0郢晢??闔・?郢晢??鬯???・?・?髯具???・?・?鬯?・?髦?蜷?笙驛｢譎樔ｺゑｾ取刮・?・??・?・?驛｢譎｢・?・?郢晢??陝ｲ・?遶願┳?・?荳・・?郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?髫?蜴・??・?髫???・?・?
        // 驍ｵ・?雋??蜻?驍ｵ・?驕会ｽ??・?・??・?・?鬩肴得??・?髯具??隰費??郢晢??驍ｵ・?雋?∞??竏ｬ・?????・?陞ｻ鬥?蝮朱?・??・?・?隴会ｽ??・?・?郢晢??驍ｵ・?陟包???・?・??・?・?鬩墓ｧ?蜚ｱ?・?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?髯?蟯??譏ｴ?・?鬯?・?陋滂ｽ?・つ雋翫???・?郢晢??
        // 驍ｵ・??・?・?驍ｵ・?陞溘ｑ??・?驍???霎ｷ・?鬩肴得??・?郢晢??郢晢??tep=2郢晢??郢晢?? 髫??隲・?・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譏???譏ｴ窶?驛｢譎｢・?・?驛｢・?陋幢??遶企?・?・?遶丞､?・??
        const coarseStep=2;
        for(const rng of searchRanges){
            const bias = (rng.type==='local')? 1.0 : 0.94; // 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎樊束・つ陷?・??・?・?隲帷???・?驛｢・?闕ｳ蟯???驍ｵ・?闕ｵ譏ｶ?讌｢・?繧・??・?邵??
            for(let tau=rng.min; tau<=rng.max; tau+=coarseStep){
                let r=0, e0=0, e1=0;
                const N=W-tau;
                for(let n=0;n<N;n++){
                    const a=frame[n];
                    const b=frame[n+tau];
                    r += a*b; e0 += a*a; e1 += b*b;
                }
                const den = Math.sqrt(e0*e1) + 1e-12;
                const nacf = r/den;
                const score = nacf * bias;
                if(score>bestScore){ bestScore=score; bestR=nacf; bestTau=tau; bestType=rng.type; }
            }
        }
        // 鬩埼?碑ｻ?霎ｷ・?鬩肴得??・?鬩搾??陷亥沺・?・?驍ｵ・??・?・?鬮?螟ｧ・?・??・?蜥?・?・?髮区??・?・??・?・?髫?證ｦ・?・?鬩肴得??・?郢晢??隰紋ｼ夲??・?3 驍ｵ・??・?・?驍ｵ・??・?・?髯溷???・??・?・?驛｢・?郢晢?? 髫??会ｽ?・?驍ｵ・?郢晢??郢晢??驛｢譏ｴ?・?邵?譎会ｽ?譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?髯樊ｺ?逕･髯悟､ゑｽ?・??・?・?鬮?????・?髯滓坩螻??・?・?郢晢??
        if(bestTau>0){
            const t0=Math.max(tauMin, bestTau-3), t1=Math.min(tauMax, bestTau+3);
            for(let tau=t0; tau<=t1; tau++){
                let r=0,e0=0,e1=0; const N=W-tau;
                for(let n=0;n<N;n++){ const a=frame[n], b=frame[n+tau]; r+=a*b; e0+=a*a; e1+=b*b; }
                const den=Math.sqrt(e0*e1)+1e-12; const nacf=r/den; if(nacf>bestR){ bestR=nacf; bestTau=tau; }
            }
        }

        // 驛｢譏???・?・主??・?譎?鯵・取㏍・?譏ｴ?・?邵???蜍ｳ隲橸??闖ｫ・?郢晢??騾趣??陜ｨ蛟ｩ・?證ｦ・?・?髴難???・?・?驍ｵ・??・?・?鬮?・?隲?肩・?・??・?・?郢晢??郢晢??
        let estTau=bestTau;
        if(bestTau>tauMin && bestTau<tauMax){
            // f(tau-1), f(tau), f(tau+1)
            const fAt = (t)=>{
                let r=0,e0=0,e1=0; const N=W-t;
                for(let n=0;n<N;n++){ const a=frame[n]; const b=frame[n+t]; r+=a*b; e0+=a*a; e1+=b*b; }
                return r/(Math.sqrt(e0*e1)+1e-12);
            };
            const ym1=fAt(bestTau-1), y0=bestR, yp1=fAt(bestTau+1);
            const denom = (ym1 - 2*y0 + yp1);
            if(Math.abs(denom)>1e-9){
                const delta = 0.5*(ym1 - yp1)/denom; // 鬯??郢?蟲?笳矩し???・?・?驍ｵ・?陞｢・??・?蠕?・?郢晢??1..+1郢晢??郢晢??
                if(Math.abs(delta)<=1) estTau = bestTau + delta;
            }
        }

        const estR = bestR;
        // 髯?閧??蜍???驍ｵ・?陷会ｽ?遯?・?驍ｵ・?郢晢??・つ?・?・?: 髯滓汚??・?鬯?・??・?・?髫?蠑ｱ・・?晢??驍ｵ・?陷会ｽ?遯?・?驍ｵ・?郢晢??・つ?・?・?驛｢・?陷・?・?・?驗呻???・?・?驍ｵ・?遶乗劼・?・??・?・?鬯?・??・?・?髫?蠑ｱ・・?晢??髯・闔会ｽ??・??髣???闕ｵ譎｢・?・?驛｢・?郢晢??
        let nacfThresh = NACF_BASE;
        if(rms<0.008){
            nacfThresh = 0.34;
        } else if(rms>0.06){
            nacfThresh = 0.24;
        } else {
            // 0.008..0.06 驍ｵ・??・?・?鬯?・?髦?蜷??蟶昴??陞｢・??・?・??・?・?鬮?・?隲橸??闖ｫ・?郢晢??郢晢??.34驕ｶ鄙ｫ?・?.24郢晢??郢晢??
            const t=(rms-0.008)/(0.06-0.008);
            nacfThresh = 0.34*(1-t) + 0.24*t;
        }
        let freq = (estR>=nacfThresh && estTau>0)? (srd/estTau) : 0;
        if(freq>0){ voicedHold = NACF_HOLD; }
        else if(voicedHold>0){ voicedHold--; freq = (prevFreq>0? prevFreq: 0); } // 鬩墓得??・?驍ｵ・?郢晢??・つ雎募?・・?驛｢・?陟暮?会ｽ?蟶晏教隲幢???・?・?郢晢??
        const fOK = (freq>0 && isFinite(freq))? freq: 0;
        freqs.push(fOK);
        octHints.push(bestType!=='local');
        amps.push(rms);
        if(fOK>0) { prevFreq=fOK; prevTau=estTau; } else { /* 髣???隴・隰梧??・?・?陷会ｽ?遶企?・?・?郢晢??*/ }
        // 髯??陝ｶ譎｢・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?§・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?: f 驍ｵ・??・?・? f/2 驍ｵ・??・?・?SHS髮手ご・?????・?郢晢??
        if(calFrames<CAL_FRAMES){
            const fC=fOK; if(fC>0){
                // 髫??会ｽ?・?驍ｵ・??・?・?鬩???隰撰??陝???驍ｵ・?髫?・??・?・?陋ｹ・?遶擾?? frame 驛｢・?髮区?∵・鬨?蛹・??・?
                const shF = shsScore(frame, srd, fC, 8);
                const shL = shsScore(frame, srd, fC*0.5, 8);
                calCurSum += shF; calLowSum += shL; calFrames++;
            }
        }

        // 髯区???・・?・?隲・陷・??髫?譴?閻??・?・?郢晢??ACF + 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎乗??・?・??・?・?鬨?霈?・?+ YIN + 髴取ｻゑｽ?・?髯橸???・?・?鬯?・??・?・?郢晢??郢晢??
        const cFreqs=[]; const cCosts=[];
        if(fOK>0){
            const tauBase = Math.max(tauMin, Math.min(tauMax, estTau));
            const bRound=Math.round(tauBase);
            const tauCand = [];
            const pushTau=(t)=>{ const ti=Math.round(t); if(ti>=tauMin && ti<=tauMax) tauCand.push(ti); };
            pushTau(bRound); pushTau(bRound-1); pushTau(bRound+1);
            pushTau(tauBase/2); pushTau(tauBase*2);
            // 髯区???・・?・?隲帛･・???驍ｵ・??・?・?驍ｵ・??・?・? NACF 驍ｵ・??・?・? SHS 驛｢・?陞ｳ螟ｲ・?・?驕ｨ繧托ｽ?・??・?・?驍ｵ・?陷会ｽ?・つ遶乗劼・?・?陟募?個螳夲????・?・?鬮?遨ゑｽ?讒ｫ?・し??陷会ｽ?遯?・?髯?・?陜捺?・・?驛｢・??・?・?驛｢・??・?・?驛｢譎?樟?・
            const tmpCand=[]; // {f, nacf, shs, isOct, shsNorm}
            for(const t of tauCand){
                let r=0,e0=0,e1=0; const N=W-t;
                for(let n=0;n<N;n++){ const a=frame[n], b=frame[n+t]; r+=a*b; e0+=a*a; e1+=b*b; }
                const den=Math.sqrt(e0*e1)+1e-12; const nacf=Math.max(0, Math.min(1, r/den));
                const f = srd/Math.max(1, t);
                const shs = shsScore(frame, srd, f, 8);
                const isOct = (Math.abs(t - Math.round(tauBase/2))<=1) || (Math.abs(t - Math.round(tauBase*2))<=1);
                tmpCand.push({f, nacf, shs, isOct, shsNorm:0});
            }
            // SHS 驍ｵ・??・?・?驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?髯??郢晢???・?・??・?・?鬮?遨ゑｽ?讒ｫ?・
            let maxShs=0; for(const c of tmpCand) if(c.shs>maxShs) maxShs=c.shs;
            const a=0.75, b=0.25; // NACF驛｢・?陋幢???・??驛｢・?陝ｲ・?遶???・?・?陝雜｣・?・?陷???・?・?陋ｹ・?邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・??・?・?鬮?・?鬮?・??・?螳夲??螢?・?・?陞ｳ蟶・・?郢晢??
            const tmpCost=new Array(tmpCand.length).fill(0);
            for(let i=0;i<tmpCand.length;i++){
                const ci=tmpCand[i]; ci.shsNorm = maxShs>0? (ci.shs/maxShs) : 0;
                let cost = a*(1-ci.nacf) + b*(1-ci.shsNorm);
                if(ci.isOct) cost += 0.06;
                tmpCost[i]=cost;
            }
            // f 驍ｵ・??・?・? 2f 驍ｵ・??・?・?驛｢譎擾??・?邵??髮手ご・?????・?郢晢???・?・?郢晢??ower驕ｶ諷???・?pper/2 驛｢・?陷?闌ｨ・?・?隲幢??郢晢??郢晢??陝ｲ・?・つ?・?・?ower驍ｵ・?隰疲?・遘?・?隰梧汚??・??・?・?髣???驗呻??遶企?・?・?郢晢??upper 驛｢・?髮区??・?・??・?・?驍ｵ・?闕ｵ證ｦ・?・?陝ｶ・?邵?蟶?・?・?邵?雉努er驛｢・?髮区??・?・??・?・?髯???・?・?鬯?霈?・?
            for(let i=0;i<tmpCand.length;i++){
                for(let j=0;j<tmpCand.length;j++){
                    if(i===j) continue;
                    const fi=tmpCand[i].f, fj=tmpCand[j].f;
                    // i 驛｢・?郢晢??upper, j 驛｢・?郢晢??lower 髯区???・・?・?隲帛ｲ??蝣?・?・?陷会ｽ?遯?・?驛｢譏ｶ?螢?笙るΔ譏ｴ?・?邵??
                    if(fi>fj){
                        const rel = Math.abs(fi - 2*fj) / Math.max(1,fi);
                        const tol = preferLowerOct? 0.03 : 0.025;
                        if(rel<tol){
                            const confLower = 0.5*(tmpCand[j].nacf + tmpCand[j].shsNorm);
                            const confUpper = 0.5*(tmpCand[i].nacf + tmpCand[i].shsNorm);
                            const gap = preferLowerOct? 0.2 : 0.15;
                            const penalty = preferLowerOct? 0.32 : 0.25;
                            const reward = preferLowerOct? 0.03 : 0.02;
                            if(confLower >= confUpper - gap){ tmpCost[i]+=penalty; tmpCost[j]=Math.max(0, tmpCost[j]-reward); }
                        }
                    }
                }
            }
            for(let i=0;i<tmpCand.length;i++){ cFreqs.push(tmpCand[i].f); cCosts.push(tmpCost[i]); }
            // YIN 髯区???・・?・?郢晢??
            const yb = yinBestTauCMND(frame);
            if(yb && yb.tau && isFinite(yb.tau)){
                const fy = srd/Math.max(1, yb.tau);
                // YIN驛｢・??・?遖ｰS驍ｵ・??・?・?鬮?・?隲幢???・?・??・?・?郢晢??陜捺?ゑｽ?・??・?・?鬮?遨ゑｽ?讒ｫ?・し??陷会ｽ?遯?・?驍ｵ・?闕ｵ譎｢・?????陜捺?・・?郢晢??郢晢??
                const yShsRaw = shsScore(frame, srd, fy, 8);
                const yShs = (maxShs>0)? Math.max(0, Math.min(1, yShsRaw/maxShs)) : 0;
                const yNacf = Math.max(0, Math.min(1, yb.conf));
                const cy = a*(1 - yNacf) + b*(1 - yShs);
                cFreqs.push(fy); cCosts.push(cy);
            }
            // 驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?髯??郢晢??郢晢??髯区???・・?・?隲橸??闖ｫ・?驍ｵ・??・?・? 2f 驕ｶ霈?・?f 驍ｵ・??・?・?鬯?・??・?・?髣???郢??遯?・?驍ｵ・?郢???・??匁捗?・?・?髯?・?陋ｹ・?・つ遶擾???・?・?鬮?竏?・?(2f)驛｢・?髮区??・?・??・?・?驍ｵ・?闕ｵ證ｦ・?・?陝ｶ・?邵?蟶?・?譎｢・?・?髣???陷?・?郢晢??(f)驛｢・?髮区??・?・??・?・?髯???・?・?鬯?霈?・?
            for(let i=0;i<cFreqs.length;i++){
                for(let j=0;j<cFreqs.length;j++){
                    if(i===j) continue; const fi=cFreqs[i], fj=cFreqs[j];
                    if(fi>fj){ const rel=Math.abs(fi - 2*fj)/Math.max(1,fi); if(rel<0.03){ cCosts[i]+=0.12; cCosts[j]=Math.max(0, cCosts[j]-0.02); } }
                }
            }
        }
        // 髴取ｻゑｽ?・?髯橸???・?・?鬯?・??・?・?髯区???・・?・?隲帷???・?髯晢???・?・?驍ｵ・??・?・?鬨?蛹・??・?髫?・?隰?・??・?・?陋ｹ・?邵?鬘費??譎樔ｺゑｾ取刮・?・??・?・?驍ｵ・??・?・?髯滂ｽ?隲帷腸・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏???・??・?・?霑壼雀?・?晢??郢晢??
        const uCost = rms<0.002? 0.05 : (rms<0.01? 0.18 : 0.35);
        cFreqs.push(0); cCosts.push(uCost);
        candFreqsPerFrame.push(cFreqs);
        candCostsPerFrame.push(cCosts);
        // 200驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?驍ｵ・?隴∫???蝣?・?・??・?・?UI驍ｵ・??・?・?髯具???・?・?髯溷桁??・?驛｢・?陞ｳ螟ｲ・?・?隴∵腸・??驍ｵ・??・?・?驛｢譎???驥・㏍??譎｢・?・?驛｢・??・?・?鬮?遨ゑｽ?譏ｶ??驛｢・?髮区??・?鬥?・?蛹・??・?
        if((++yieldCounter % 200)===0){ await new Promise(r=>setTimeout(r,0)); }
    }

    // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏???貊ゑ??・?陷亥沺・?・?驛｢・?髮区????螟???謫?・?・?
    if(calFrames>=8 && calLowSum > calCurSum*1.18){ preferLowerOct=true; }

    // Viterbi 驍ｵ・??・?・?驛｢・?陋ｹ・??・?迢暦??譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?鬩堺?夲??・?髯具??陷会ｽ?郢晢??髫????髯・?・?・?驛｢譏???・?邵??
    const M=candFreqsPerFrame.length; const dp=new Array(M); const prv=new Array(M);
    for(let i=0;i<M;i++){ dp[i]=new Array(candFreqsPerFrame[i].length).fill(Infinity); prv[i]=new Array(candFreqsPerFrame[i].length).fill(-1); }
    for(let j=0;j<dp[0].length;j++){ dp[0][j]=candCostsPerFrame[0][j]; }
    const beta=0.12; // 髯?雍???竏ｵ・?・?鬮?閧?霎ｨ陞ｻ・?驛｢・?陋幢???・??驛｢・?郢晢???・?・??・?・?驍ｵ・?隰?・??・?・?闔・??・?・??・?・?髯・陷会ｽ??・??驍ｵ・??・?・?鬮?謳?・?・?鬮??髢?・?隶蟷・?・・?・?郢晢??郢晢??
    const octPenalty=1.25; // ?・?繧托ｽ?・?12鬮?螟ｧ・?・??・?蜥?・?・??・?・?髫?螢?・?・?陞ｳ蟶?・?・?陷???・?・?驍ｵ・??・?・?髯滓汚??・?髯具??郢晢??
    for(let i=1;i<M;i++){
        const cf=candFreqsPerFrame[i], cc=candCostsPerFrame[i];
        for(let j=0;j<cf.length;j++){
            const f2=cf[j]; let best=Infinity, bestp=-1;
            for(let k=0;k<candFreqsPerFrame[i-1].length;k++){
                const f1=candFreqsPerFrame[i-1][k];
                let trans=0;
                if(f1===0 || f2===0){
                    // 髴取ｻゑｽ?・?髯橸???・?・?驕ｶ鬘泌､?隲?蜑ｰ讀??・?・?驍ｵ・??・?・?鬯?蛹・??・?鬩募???・?鬩励???・?驛｢・?陜ｮ・?MS髣懈瑳蜑?・?・?陋滂ｽ?遶願侭?・?闔・??・?・??・?・?鬯?・??・?・?驍ｵ・??・?・?鬯?蛹・??・?鬩募???・?驍ｵ・?陷会ｽ??・??驍ｵ・?陷?・??・?・?驍ｵ・?遶乗劼・?・??・?・?鬯?・??・?・?驍ｵ・??・?・?鬯?蛹・??・?鬩募???・?驍ｵ・?陷会ｽ?遶企豪・?・?闕ｳ螂???讒ｭ?・?郢晢??
                    const aPrev = (amps[i-1]||0), aCur=(amps[i]||0);
                    const aMax = Math.max(aPrev, aCur);
                    const aMin = Math.min(aPrev, aCur);
                    if(aMax<0.008){ trans=0.08; }
                    else if(aMin<0.006){ trans=0.14; }
                    else { trans=0.28; }
                }
                else{
                    const dSemi = Math.abs(12*Math.log2(f2/f1));
                    const nearOct = Math.min(Math.abs(dSemi-12), Math.abs(dSemi-24));
                    trans = beta*dSemi + (nearOct<0.7? octPenalty: 0);
                    // 髯?・?陟包???・?・?・つ驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏???貊ゑ??・??・?・?郢晢??隰紋ｼ夲??・?6髯?雍???竏ｵ・?・?髯??郢晢???・?・?陝ｲ・?郢晢??髯溷桁??・?髯???・?・?鬯?霈?・?・つ遶擾???・?・?驗呻??遶擾??驛｢・?陷?・??・?・??・?・?髯?・?陋ｹ・?郢晢??髯溷桁??・?髮九?・?・?邵??
                    if(dSemi<=6) trans -= 0.03; else if(dSemi<12) trans += 0.03;
                }
                const cost = dp[i-1][k] + cc[j] + trans;
                if(cost<best){ best=cost; bestp=k; }
            }
            dp[i][j]=best; prv[i][j]=bestp;
        }
    }
    // 髯溷桁??・?髯?蛹??・?
    let last=0; { let minv=Infinity; for(let j=0;j<dp[M-1].length;j++){ if(dp[M-1][j]<minv){ minv=dp[M-1][j]; last=j; } } }
    const vF=new Array(M).fill(0); for(let i=M-1;i>=0;i--){ vF[i]=candFreqsPerFrame[i][last]; last=prv[i][last]>=0? prv[i][last]: 0; }
    let ftrack = vF;
    // 驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎??・取刮・?譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??郢晢??髢?・?雎｢蝣?・?・?郢晢???・?・?12鬮?謳?・?・?鬮??鬮?・??・?螳壽??・?・?鬯?・??・?・?髯句??・?・?驍ｵ・??・?・?鬨?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驛｢・?・つ郢晢??郢晢??
    (function(){
        const L=ftrack.length; if(L<3) return;
        const midis=new Array(L).fill(null);
        for(let i=0;i<L;i++){ const f=ftrack[i]; midis[i]=(f>0&&isFinite(f))? 69+12*Math.log2(f/A4Frequency) : null; }
        const base=new Array(L).fill(null);
        const win=2; // 5髴難???・?・?髣????・?・?髯樊ｻゑｽ?・?髯区?ゑｽ?・?
        for(let i=0;i<L;i++){
            const vals=[]; for(let k=-win;k<=win;k++){ const j=i+k; if(j>=0&&j<L){ const m=midis[j]; if(m!=null) vals.push(m); } }
            if(vals.length){ vals.sort((a,b)=>a-b); base[i]=vals[(vals.length-1)>>1]; }
        }
    const maxRun=4; // 驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?髫?・??・?・?郢晢??髢?・?雎｢蝣?・?・?遶丞｣??骰具??・?陷会ｽ?遯?・?16髯具??郢晢???・?螳夲??雜｣・?・?驍ｵ・?髴域喚?驢搾??・?郢晢???・?・?郢晢??
        let s=0; while(s<L){
            // 鬯?・??・?・?鬮?・??・?・?髯具???・?・?髯橸??郢晢?? 髯憺屮・?・?髮・隰費??・ゑｽ?驛｢・?陷?・??・?・?9髯?雍???竏ｵ・?・?髣比ｼ夲??・?髣???郢晢??
            while(s<L){ const b=base[s]; const m=midis[s]; if(b!=null&&m!=null&&Math.abs(m-b)>=9) break; s++; }
            if(s>=L) break; let e=s; while(e<L){ const b=base[e]; const m=midis[e]; if(!(b!=null&&m!=null&&Math.abs(m-b)>=9)) break; e++; }
            const runLen=e-s; if(runLen>1 && runLen<=maxRun){
                // 鬩????・?・?驍ｵ・??・?・?髯憺屮・?・?髮・隰費??遶頑･???陋ｹ・??・?蜀暦??・?陝ｶ蜷??・??・?繧托ｽ?・?12驛｢・?陝ｶ譏ｶ?驛???螢??・?
                const ref = base[s>0? s-1: (e<L? e: s)];
                if(ref!=null){
                    for(let i=s;i<e;i++){
                        if(midis[i]==null) continue; let mi=midis[i];
                        while(mi - ref > 6) mi -= 12; while(ref - mi > 6) mi += 12; midis[i]=mi;
                    }
                }
            }
            s=e+1;
        }
        // 髯?・?髢?・?闕ｳ?
        for(let i=0;i<L;i++){ const m=midis[i]; if(m!=null){ ftrack[i]=A4Frequency*Math.pow(2,(m-69)/12); } }
    })();

    // SHS 驍ｵ・??・?・?驛｢・?陋ｹ・??・?迢暦??・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?邵??驛｢譎｢・?・?驛｢・??・?・?鬩???髦?蜷??・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・?隲?肩・?・??・?・?郢晢??郢晢??/2 驍ｵ・?郢晢??f 驛｢・?陋ｹ・??・?鬘伜??つ鬮?蜈ｷ・?・?驍ｵ・?陷会ｽ?遯?・?髯滓汚??・?驍ｵ・?郢晢???・?・??・?・?髯?・?陋ｹ・?郢晢??髣???闕ｵ譎｢・?・?驛｢・?陷茨???・?・?郢晢??
    (function(){
        const L=ftrack.length; if(L<4) return;
        const winMs = preferLowerOct? 300 : 260;
        const winFrames=Math.max(4, Math.min(28, Math.round((winMs/1000)*srd/H)));
        const threshRatio = preferLowerOct? 1.15 : 1.25; // 驛｢譎???驥・刮・?譎｢・?・?驛｢譎??陜趣??鬩肴得??・?髫?螟?蠕?・?髣???陷?・?郢晢??髯???・?・?髯?謳?・?・?髯具???・?・?髯橸??陞｢・??・?蝣?・?・?郢晢???・??鬩搾???・?・?驛｢・?郢晢??
        const minRun = preferLowerOct? 4 : 5; // 鬯?・??・?・?鬩搾??陞｢・?郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髫?・??・?・?
        const indicesDown=new Array(L).fill(false);
        let lowSum=0, curSum=0; const bufFrame=new Float32Array(W);
        const getFrame=(idx)=>{
            const start = idx*H; if(start+W>ds.length) return null;
            // DC鬯?・??・?・?髯?・??・?・? + 鬩???郢晢??
            let mean=0; for(let k=0;k<W;k++){ mean+=ds[start+k]; }
            mean/=W; let e=0; for(let k=0;k<W;k++){ const v=(ds[start+k]-mean)*hann[k]; bufFrame[k]=v; e+=v*v; }
            return Math.sqrt(e/W);
        };
        const shsAt=(idx, f)=>{ if(!(f>0)&&isFinite(f)) return 0; const rms=getFrame(idx); if(!rms || rms<1e-5) return 0; return shsScore(bufFrame, srd, f, 8); };
        // 髯?逎ｯ繝｡?・?・?陟募?娯斡驛｢・??・?・?驛｢譎｢・?・?驛｢譎擾??・?邵?驛?ｴ戊ｭ・隰・髯具??郢晢??
        for(let i=0;i<Math.min(L,winFrames);i++){ const f=ftrack[i]; if(f>0){ curSum += shsAt(i, f); if(f*0.5>0) lowSum += shsAt(i, f*0.5); } }
        let run=0; const mark=(i)=>{ indicesDown[i]=true; };
        for(let i=0;i<L;i++){
            // 髯具???・?・?髯橸??郢晢??
            if(curSum>0 && lowSum > curSum*threshRatio){ run++; if(run>=minRun) mark(i); } else { run=0; }
            // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?
            const outIdx=i; const inIdx=i+winFrames; // out=髯?・??・?・?驛｢・?郢晢?? in=髫?螟ｲ・?・?驛｢・?郢晢??
            if(outIdx<L){ const f=ftrack[outIdx]; if(f>0){ const sCur=shsAt(outIdx,f); const sLow=shsAt(outIdx,f*0.5); curSum-=sCur; lowSum-=sLow; } }
            if(inIdx<L){ const f=ftrack[inIdx]; if(f>0){ const sCur=shsAt(inIdx,f); const sLow=shsAt(inIdx,f*0.5); curSum+=sCur; lowSum+=sLow; } }
        }
        // 鬯?蛹・??・?鬨?蛹・??・?郢晢??髢?・?雎｢蝣?・?・?郢晢???・?・??・?・?鬩???闕ｵ譏ｴ?・?髴取ｻゑｽ?・?鬮?蜍溽?・・?・?郢晢??
        let s=0; while(s<L){ while(s<L && !indicesDown[s]) s++; if(s>=L) break; let e=s; while(e<L && indicesDown[e]) e++; if(e-s>=minRun){ for(let i=s;i<e;i++){ ftrack[i]/=2; } } s=e; }
    })();

    // 髫????鬩搾??郢晢?? 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎樊束?・?・??・?・?髯懈瑳・?蛟･笳矩Δ譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??隰紋ｼ夲??・?12驍ｵ・??・?・?驍ｵ・?闔会ｽ??・?蟶晏擅?・?・?髫?・??・?・?驍ｵ・?陷会ｽ?遯?・?驍ｵ・?遶丞､?・??驍ｵ・??・?・?驍ｵ・?闕ｳ螂???鬘俶↑髴???・?・?髯憺屮・?・?髮・鬮???・?・??・?・?驍ｵ・?闕ｵ譎｢・?莨夲??繧托ｽ?・?7髯?雍???竏ｵ・?・?驍ｵ・??・?・?髯?・?陟托???・?竏ｫ・?・?陷茨???・?・?郢晢??
    (function(){
        const L=ftrack.length; if(L<3) return;
        const midi = new Array(L).fill(null);
        for(let i=0;i<L;i++){ const f=ftrack[i]; midi[i]=(f>0&&isFinite(f))? 69+12*Math.log2(f/A4Frequency) : null; }
        const base=new Array(L).fill(null);
        const win = Math.max(6, Math.min(14, Math.round((0.22*srd)/H))); // ~220ms 鬮?螟ｧ・?・??・??主??・?・?髯樊ｻゑｽ?・?髯区?ゑｽ?・?
        const getMed=(arr)=>{ const v=arr.slice().sort((a,b)=>a-b); const n=v.length; return n? v[(n-1)>>1]: null; };
        for(let i=0;i<L;i++){
            const vals=[]; for(let k=-win;k<=win;k++){ const j=i+k; if(j>=0&&j<L){ const m=midi[j]; if(m!=null) vals.push(m); } }
            base[i]=vals.length? getMed(vals): null;
        }
        for(let i=0;i<L;i++){
            if(midi[i]==null || base[i]==null) continue; let m=midi[i], b=base[i];
            while(m - b > 7.0) m-=12; while(b - m > 7.0) m+=12; midi[i]=m;
        }
        for(let i=0;i<L;i++){ const m=midi[i]; if(m!=null){ ftrack[i]=A4Frequency*Math.pow(2,(m-69)/12); } }
    })();

    // 髣碑?・?繧托ｽ?・?驗呻???・?・?: 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏???譁滂ｽ?驛｢・??・?・?髯憺屮・?・?髮・陷???・?・?郢晢??MA郢晢??陝ｲ・?遶企豪・?・?陋ｹ・??・?迢暦??・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎樊束陝????棔???・?・?髢?・?隰・驍ｵ・??・?・?髯樊ｻゑｽ?・?鬮?謳?・?・?鬮??鬮?・?郢晢??鬮?・??・?・?髯橸???・?・?郢晢??郢晢??
    (function(){
        const L=ftrack.length; if(L<3) return;
        let mRef=null; const alpha=0.12; // 鬮?????・?髯滓坩・?・?・つ雋????・?・??・?・?
        const allowJump=8.5; // 髯?雍???竏ｵ・?・?驍ｵ・?郢???・??驛｢・?陟暮?会ｽ?蟶晏ｱ・?晢??遶擾??驛｢・?陷?・??・?・??・?・?髯?・?陋ｹ・?郢晢???・?繧托ｽ?・?12鬮?・??・?・?髫?・??・?・?驛｢・?陞ｳ螟ｲ・?・??・?・?驍ｵ・?郢晢??
        for(let i=0;i<L;i++){
            const f=ftrack[i]; if(!(f>0)&&isFinite(f)) continue;
            let m = 69+12*Math.log2(f/A4Frequency);
            if(mRef==null){ mRef=m; continue; }
            // 驍ｵ・??・?・?驍ｵ・?陜｣蜈ｷ・?・?12驍ｵ・??・?・? mRef 驍ｵ・??・?・?髫????驛｢・?郢?螂???・?闔会ｽ??・?讓抵??・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§遶城メ豎樒ｹ晢??隨?迢暦??・?郢晢??
            while(m - mRef > 6) m -= 12; while(mRef - m > 6) m += 12;
            // 驍ｵ・?隴擾???・?讙趣??・??・?・?驛｢・?郢???・?・??・?・?驍ｵ・?隰疲?ゑｽ?・??・?・?驍ｵ・?鬮?・??・?讚∵??・?・?髯?・?髣鯉ｽ??・?・?髢?・?隰・驍ｵ・??・?・?鬮?謳?・?・?鬮??隰?・??・?・?陝ｲ・?遶企豪・?・??・?・??・?繧托ｽ?・?12驍ｵ・??・?・?驛｢・?郢??遶???髣???・つ髫?・??・?・?鬮?・??・?・?髫?・??・?・?驍ｵ・?陷会ｽ?遯?・?鬮?・??・?・?髯橸???・?・?
            if(Math.abs(m - mRef) > allowJump){ if(m > mRef) m -= 12; else m += 12; }
            // 髯?・?髢?・?闕ｳ?
            ftrack[i] = A4Frequency*Math.pow(2,(m-69)/12);
            // EMA 髫?蜴・??・?髫???・?・?郢晢??陜捺?督蜑ｰ讀??・?・?鬯?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?郢晢??郢晢??
            mRef = (1-alpha)*mRef + alpha*m;
        }
    })();

    // 驛｢譎???邵?蟶?・?譏ｴ?・?iterbi: 髯・闕ｳ螂????驍ｵ・??・?・?驛｢・??・?・?驛｢譏ｴ?・?邵?・?驛｢・?陷?蝓滂ｽ?蟶?・?・?陋ｹ・??・??5髴難???・?・?髣????・?・?髯樊ｻゑｽ?・?髯区?ゑｽ?・?郢晢??闔・??・?・??・?・?鬮?謳?・?・?鬮??鬮?・?郢晢??髣???隴・隰梧?・・?郢晢??
    (function(){
        const L=ftrack.length; if(L<5) return;
        const midi=new Array(L).fill(null);
        for(let i=0;i<L;i++){ const f=ftrack[i]; midi[i]=(f>0&&isFinite(f))? 69+12*Math.log2(f/A4Frequency) : null; }
        const out=midi.slice();
        for(let i=2;i<L-2;i++){
            if(midi[i]==null) continue;
            const win=[]; for(let k=-2;k<=2;k++){ const v=midi[i+k]; if(v!=null) win.push(v); }
            if(win.length<3) continue;
            win.sort((a,b)=>a-b);
            const med = win[(win.length-1)>>1];
            if(Math.abs(med - midi[i]) <= 1.2){ out[i]=med; }
        }
        for(let i=0;i<L;i++){ const m=out[i]; if(m!=null){ ftrack[i]=A4Frequency*Math.pow(2,(m-69)/12); } }
    })();

    // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?: 驛｢譎?・?邵?蟶?・?譏ｴ?・?・取㏍・?・??・?・?驛｢・??・?・?驍ｵ・??・?・?髫??乗が?・?・?陞｢・?陷・??鬯?・?髦?蜷??蝣?・?譎擾??・?郢晢??驛｢譎???・?・??・?・?髯橸??郢晢??
    const notes=[];
    const idxToTime = (idx)=> idx*H/srd;
    const MIN_NOTE_SEC = 0.07; // 64髯具??郢晢??雎ｬ・?鬮?・??・?・?鬨?・??・?・?髯溷・萓ｭ郢晢??驛｢・??・?・?驛｢譏???・?邵??驛｢・??・?・?驛｢・?陷?蝓滂ｽ?蟷・?・・?・?郢晢??闔・??・?・?雋???倬Δ譎｢・?・?驛｢譎???遶頑･?蠏ｩ隴擾???・?迢暦??・?隶呵??・?・?郢晢??0ms郢晢??郢晢??
    const HOLD_FRAMES = 2;     // 2驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?鬯?・??・?・?鬩搾??陞｢・?邵?螳壽?碑ｿ壼雀?・し??陷会ｽ?遯?・?髯具??隴擾???・?竏ｫ・?・??・?・?髯具??郢晢??陝蟶・・?陋ｹ・?邵?蝣?・?譎｢・?・?驛｢譏ｴ?・?郢晢??髫?螢?・?・?陞ｳ蟶・・?郢晢??
    let curMidi=null, curStart=0; let changeStreak=0; let lastMidiRounded=null;
    for(let i=0;i<ftrack.length;i++){
        const f=ftrack[i]; const t=idxToTime(i);
        if(f<=0){
            // 髴取ｻゑｽ?・?髯橸???・?・?鬯?・??・?・?: 髴托ｽ??・?・?驛｢譎擾??・?郢晢??驛｢譎???・?・??・?・?髯橸??郢晢??
            if(curMidi!=null){ const dur=t-curStart; if(dur>0){ notes.push({midi:curMidi, time:curStart, duration:dur}); } curMidi=null; }
            changeStreak=0; lastMidiRounded=null; continue;
        }
        // MIDI鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?郢晢??隰紋ｼ夲??・?6髯?雍???竏ｵ・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・?隲?肩・?・??・?・?郢晢??郢晢??
        let midiFloat=69+12*Math.log2(f/A4Frequency);
        if(curMidi!=null){
            while(midiFloat - curMidi > 6) midiFloat -= 12;
            while(curMidi - midiFloat > 6) midiFloat += 12;
        }
        const rounded = Math.round(midiFloat);
        if(curMidi==null){
            curMidi=rounded; curStart=t; changeStreak=0; lastMidiRounded=rounded;
        } else {
            if(rounded!==curMidi){
                if(lastMidiRounded===rounded){ changeStreak++; } else { changeStreak=1; lastMidiRounded=rounded; }
                if(changeStreak>=HOLD_FRAMES){
                    // 驛｢譎擾??・?郢晢??驛｢譏???・?郢晢??髫?蜴・??・?鬩墓?・?・?髯橸??郢晢??
                    const dur=t-curStart; if(dur>0){ notes.push({midi:curMidi, time:curStart, duration:dur}); }
                    curMidi=rounded; curStart=t; changeStreak=0;
                }
            } else {
                changeStreak=0; lastMidiRounded=rounded;
            }
        }
    }
    // 鬩搾??郢?莨夲??・??・?・?驛｢譎擾??・?郢晢??驛｢譎???・?・??・?・?髯橸??郢晢??
    if(curMidi!=null){ const endT = idxToTime(ftrack.length); const dur=endT-curStart; if(dur>0){ notes.push({midi:curMidi, time:curStart, duration:dur}); } }

    // 鬩墓得??・?鬯?・??・?・?驛｢譎???・?郢晢??驛｢・??・?・?郢晢??騾趣??陜ｨ蛟ｩ・?證ｦ・?・?驍ｵ・?鬩?・?雎ｬ・?鬩墓ｨ費??譏ｶ?・?髯?・?陟募具??驍ｵ・?遶丞｣?遨宣し??雋???・?鬯?・??・?・?驛｢譎擾??・?郢晢??驛｢譎?樟????≧髫?・?騾寂悪・?・?闕ｵ譏ｶ蜻?鬩墓得??・?驍ｵ・?陷?・?驍?驛｢・?陷?・??・?・??・?・?髯?・?髣鯉ｽ??・?・?郢晢??
    const merged=[];
    for(const n of notes){
        if(!merged.length){ merged.push(n); continue; }
        const prev=merged[merged.length-1];
        if(n.midi===prev.midi && (n.time - (prev.time+prev.duration))<0.02){
            // 驍ｵ・??・?・?驍ｵ・??・?・?鬯?・??・?・?鬩搾??陞｢・?遶企?・?・?髢?・??・?・?闔牙衷・??
            prev.duration = (n.time + n.duration) - prev.time;
        } else if(n.duration<MIN_NOTE_SEC && Math.abs(n.midi - prev.midi)<=1 && (n.time - (prev.time+prev.duration))<0.03){
            // 髫??会ｽ?・?鬩墓得??・?驛｢・?髮区?停?驍ｵ・??・?・?髯?・??・?・?髯?・?郢晢??
            prev.duration = (n.time + n.duration) - prev.time;
        } else {
            merged.push(n);
        }
    }

    // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎擾??・?邵??驛｢譏ｴ?・?郢晢??鬩墓得??・?鬯?・??・?・?郢晢??郢晢??-鬩墓得??・?驍ｵ・?・・-A郢晢??陝ｲ・??・?螳壽・?・?・?髯?・?陟托???・??驍ｵ・??・?・?鬯?・??・?・?鬩搾??郢晢??
    const cleaned=[];
    for(let i=0;i<merged.length;i++){
        if(i>0 && i<merged.length-1){
            const a=merged[i-1], b=merged[i], c=merged[i+1];
            const gapAB = b.time - (a.time + a.duration);
            const gapBC = c.time - (b.time + b.duration);
            if(b.duration < Math.min(0.06, MIN_NOTE_SEC) && a.midi===c.midi && Math.abs(b.midi - a.midi) <= 1 && gapAB < 0.03 && gapBC < 0.03){
                // a 驛｢・?郢晢??c 驍ｵ・??・?・?驍ｵ・??・?・?髯?慣・?・?鬯?貊ゑ??・?驍ｵ・?陷会ｽ?・つ?・?? 驍ｵ・??・?・? c 驛｢・?陋幢??邵?蟶?・?・??・?・?驛｢譏ｴ?・?郢晢??
                a.duration = (c.time + c.duration) - a.time;
                i++; // c 驛｢・?陝ｶ譎｢・?・?陝ｶ蜷??・?驍ｵ・?郢晢??
                continue; // b 驍ｵ・??・?・?鬮?????・?髯?莨夲??・?驍ｵ・?陷会ｽ?遶企?・?・?郢晢??
            }
        }
        cleaned.push(merged[i]);
    }

    // ---- 驛｢譎擾??・?郢晢??驛｢譏???・?髢?・?髣???鬮?・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎樊束?・?・?霑壼遜??・?陞｢・?陜滂ｽ?郢晢??闔・??・?・?郢晢??隹?・?驛｢譎｢・?・?鬯?・?陋滂ｽ?・つ雋??????・・?・?髫?・??・?・?髮主供譯・・?・?郢晢??----
    // 髯?・?郢晢??郢晢??驛｢譎｢・?・?驛｢譏???・?驍?鬯?・?髦?蜷??・?髯?・??・?・?髮主桁??・?髫?・??・?・?髣????・?・?髯樊ｻゑｽ?・?髯区?ゑｽ?・?驛｢・?髮区??蠕宣Δ??驗呻??・つ?・??IDI髯具??隰費???・??驍ｵ・??・?・?驍ｵ・?闕ｵ譎｢・???諱・??・?郢晢??驛｢譎｢・?・?驛｢譎?樟?頑?・?繧托ｽ?・?6髯?雍???竏ｵ・?・?驍ｵ・??・?・?髯?・?陟托??遶擾??驛｢・?闕ｵ譎｢・?閧?・?・?郢晢??遶企屮・?繧托ｽ?・?12驛｢・?陞ｳ螟ｲ・?・??・?・?髫?・??・?・?驍ｵ・??・?・?鬮?・??・?・?髫?・??・?・?驍ｵ・?郢晢??
    // 驍ｵ・?雋??蜻?驍ｵ・?鬩?・?陜ｨ蛟ｩ・?證ｦ・?・?髯具???・?・?鬯?・?髦?蜷??・?髣????・?・?髯樊ｻゑｽ?・?髯区?ゑｽ?・?髮主沺魍???・?髫?荳橸??闌ｨ・?・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎乗??・?・?髮具???・?・?郢晢??1.8 or <0.55郢晢??陝ｲ・?遶企?・?・?髢?・?隰・驍ｵ・??・?・?鬮?謳?・?・?鬮??鬮?・?遶???・?・?陷会ｽ?遯?・?驍ｵ・?隴擾??郢晢??驍ｵ・??・?・?驍ｵ・??・?・?鬮?・??・?・?髯橸???・?・?驍ｵ・?郢晢??
    const clampMidiMin=36, clampMidiMax=127;
    const timeToIdx=(t)=> Math.max(0, Math.min(ftrack.length-1, Math.round(t*srd/H)));
    const safeMidi=(m)=> Math.max(clampMidiMin, Math.min(clampMidiMax, m));
    const med = (arr)=>{ const v=arr.slice().sort((a,b)=>a-b); const L=v.length; if(!L) return 0; return (L%2)? v[(L-1)>>1] : 0.5*(v[L/2-1]+v[L/2]); };
    const noteMedFreq=[]; const noteMedMidi=[];
    for(const n of cleaned){
        const i0=timeToIdx(n.time), i1=timeToIdx(n.time+n.duration);
        const vals=[]; for(let i=i0;i<=i1;i++){ const f=ftrack[i]; if(f>0&&isFinite(f)) vals.push(f); }
        const mf = vals.length? med(vals): (A4Frequency*Math.pow(2,(n.midi-69)/12));
        noteMedFreq.push(mf);
        noteMedMidi.push(69+12*Math.log2(mf/A4Frequency));
    }
    // ---- 驛｢譎擾??・?郢晢??驛｢譏???・?髢?・?髣???隰?・??・?・?陷夲??HS驍ｵ・??・?・?驛｢・?陋ｹ・??・?迢暦??・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎擾??諛?驛???螢?・?・??・?・?郢晢??/2, f, 2f 驍ｵ・??・?・?髣????・?・?驍ｵ・?闕ｵ譎｢・?陋ｾ縺馴怦・?HS髫????髯樊ｻゑｽ?・?驛｢・?陝ｶ譏ｶ?閧?・?・??・?・?郢晢??郢晢??---
    (function(){
        const bufFrame=new Float32Array(W);
        const buildFrame=(fi)=>{
            const start=fi*H; if(start+W>ds.length) return null;
            let mean=0; for(let k=0;k<W;k++){ mean+=ds[start+k]; }
            mean/=W; let e=0; for(let k=0;k<W;k++){ const v=(ds[start+k]-mean)*hann[k]; bufFrame[k]=v; e+=v*v; }
            return Math.sqrt(e/W);
        };
        const shsAt=(fi, f0)=>{ if(!(f0>0)&&isFinite(f0)) return 0; const rms = buildFrame(fi); if(!rms || rms<1e-5) return 0; return shsScore(bufFrame, srd, f0, 8); };
        for(let ni=0; ni<cleaned.length; ni++){
            const m0 = noteMedMidi[ni]; const f0 = noteMedFreq[ni]; if(!(f0>0)&&isFinite(f0)) continue;
            const i0=timeToIdx(cleaned[ni].time), i1=timeToIdx(cleaned[ni].time+cleaned[ni].duration);
            // 鬯?・?霓｣蛛???・?髴域喚?・?郢晢??鬩・?・?・?髢?・??・?・?髣埼屮・?・??・?・?鬮?蛹・??・?髯・?・?・?鬩???陷???・?・?郢晢??
            let sHalf=0, sBase=0, sDouble=0; const step=Math.max(1, Math.floor((i1-i0+1)/24));
            for(let fi=i0; fi<=i1; fi+=step){ sBase += shsAt(fi, f0); sHalf += shsAt(fi, f0*0.5); sDouble += shsAt(fi, f0*2); }
            const best = (sHalf>=sBase && sHalf>=sDouble)? -12 : ((sDouble>=sBase && sDouble>=sHalf)? +12 : 0);
            if(best!==0){ noteMedMidi[ni] = m0 + best; }
        }
    })();

    // 鬯?・??・?・?鬩堺?橸??・??・?・?郢晢??itch class郢晢??陝ｲ・?郢晢??髯???・?・?髯?謳?・?・?髯溯??・?・?驍ｵ・??・?・?髯憺屮・?・?驍ｵ・??・?・?驍ｵ・?闕ｳ闌ｨ・?・??・?・?驛｢・?遶丞｣??｣驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?
    (function(){
        const hist=new Array(12).fill(0);
        for(const m of noteMedMidi){ if(isFinite(m)){ const pc=((Math.round(m)%12)+12)%12; hist[pc]++; } }
        const order=[...hist.keys()].sort((a,b)=>hist[b]-hist[a]);
        const topPCs=order.slice(0,3);
        // 髯区???・・?・?郢晢??{floor, round, ceil} 驍ｵ・??・?・?髣????・?・?驍ｵ・?闕ｵ譎｢・?閾?・?・??・?閧?-cand| - bias 驛｢・?陷?蝓淞蜻?豌｣闕ｳ蟯???
        function pickWithBias(m){
            const cands=[Math.floor(m), Math.round(m), Math.ceil(m)];
            let best=cands[0], bestScore=1e9;
            for(const c of cands){
                const pc=((c%12)+12)%12;
                let bias=0; // 髮・?・?・?驍ｵ・??・?・?驛｢譎?蠕娯鴬驛｢・??・?・?驛｢・??・?・?驍ｵ・??・?・?髯???・?・?鬯?霈?・?
                if(pc===topPCs[0]) bias=0.10; else if(pc===topPCs[1]) bias=0.06; else if(pc===topPCs[2]) bias=0.03;
                const score=Math.abs(m - c) - bias;
                if(score<bestScore){ bestScore=score; best=c; }
            }
            return best;
        }
        for(let i=0;i<noteMedMidi.length;i++){ noteMedMidi[i]=pickWithBias(noteMedMidi[i]); }
    })();
    const outM=[]; for(let i=0;i<cleaned.length;i++){ outM.push(Math.round(noteMedMidi[i])); }
    // 髯?・??・?・?髯・郢晢??邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・?隲?肩・?・??・?・?郢晢??鬩・?・?・??・?・?鬯?・?鬮?・??・?・?郢晢?? 驛｢譎擾??・?郢晢??驛｢譏???・?郢晢??驍ｵ・??・?・?髯・?・?・?驍ｵ・?陷会ｽ?遯?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§邵?讙趣??譎???譁絶落驛｢譏ｴ?・?郢晢??DP驛｢・?陝ｶ譏ｶ?螳??蛹・??・?
    if(strictOctaveMode && outM.length>=2){
        // 髯区???・・?・?隲橸??陝??第・郢晢??K 驕ｶ荳・・?{-24, -12, 0, +12, +24}
        const Kcands=[-24,-12,0,12,24];
        const N=outM.length; const M=Kcands.length;
        // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・? 鬮?螟ｧ・?・??・?蜥?・?譎擾??・?郢晢??驛｢譎?樟郢晢??髣????・?・?髯樊ｻゑｽ?・?髯区?ゑｽ?・?髮主沺魍抵?ゑｽ?驛｢・?髣・???・?・??・?・?鬮??隶主?・??・?郢晢??隨擾??髯溯??・?・?驛｢・?陷?驛?・?髯橸??陞｢・??・??驍ｵ・?遶丞｣?窶?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§隨・驛｢・?陟募???鬥???・?・?驛｢・?陷・?・?・?陟托??遶擾??驛｢・?郢晢??
        // 鬯?蛹・??・?鬩募???・?驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・? 髯?雍???竏ｵ・?・?髯晢???・?・?驍ｵ・??・?・?髮主沺・?雋ｻ・?・?郢晢??+ ?・?繧托ｽ?・?12鬮?螟ｧ・?・??・?蜥?・?・??・?・?鬮?????・?髯?莨夲??・?驛｢譎擾??・?郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?邵??驍ｵ・?郢??隨??驍ｵ・??・?・?驍ｵ・?驕会ｽ?隰・驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・??・?・?鬮??鬮?・?隨・??驍ｵ・??・?・?驍ｵ・?郢晢??遶???・?・?鬮?・?郢晢??鬩搾???・?・?髯?・?郢晢??
        const dp=new Array(N); const prv=new Array(N);
        for(let i=0;i<N;i++){ dp[i]=new Array(M).fill(Infinity); prv[i]=new Array(M).fill(-1); }
        // 髯?隨?・?鄙ｫ?・?鬨??郢晢?? 鬯?・??・?・?髫?證ｦ・?・?驛｢譎擾??・?郢晢??驛｢譎?樟郢晢??髯?・??・?・?髮主桁??・?髫?・??・?・?髮主現?・?
        const ratios=new Array(N).fill(1);
        for(let i=1;i<N;i++){
            const r = (noteMedFreq[i-1]>0 && noteMedFreq[i]>0)? (noteMedFreq[i]/noteMedFreq[i-1]) : 1;
            ratios[i] = r;
        }
        // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎会ｽ?・?隴幢??髫?・??・?・?
        function localCost(i, kIdx){
            const K = Kcands[kIdx];
            // 鬮?螟ｧ・?・??・?蜥?・?・??・?・?f/2 or 2f髯???・?・?髯?謳?・?・?驍ｵ・?隰疲?ゑｽ?・??・?・?驍ｵ・?郢晢???・?・??・?・?髯?・?陋ｹ・?郢晢??驍ｵ・?遶丞｣?關ｽ驍ｵ・??・?・?髫???・?・?髯?・?闔会ｽ?遶城メ豎樒ｹ晢??隨?迢暦??・?闕ｵ謨鳴郢???・?・??・?・?驍ｵ・?郢晢???・?・??・?・?髯?・?陋ｹ・?郢晢??0髯???・?・?髯???迴?・つ郢晢??
            // noteMedFreq[i] 鬮?・??・?・?髣???髦?蜷??・?髣????・?・?髯懈瑳・?蛟･?・?髣????・?・?髯樊ｻゑｽ?・?髯区?ゑｽ?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?遶乗??・?鬩堺?鈴?堤?・ K驕ｶ蛹・??・?0 驍ｵ・??・?・?鬮???・?・?驍ｵ・?郢晢???・?・??・?・?驍ｵ・?郢晢??
            let cost = 0;
            if(K!==0) cost += 0.12; // 驛｢・??・?・?驛｢譎???譁絶落驛｢譏ｴ?・?郢晢??髣????・?・?鬨?蛹・??・?驍ｵ・??・?・?髯憺屮・?・?髫?蟷?・?・?鬩励???・?
            return cost;
        }
        // 鬯?蛹・??・?鬩募???・?驛｢・??・?・?驛｢・??・?・?驛｢譎会ｽ?・?隴幢??髫?・??・?・?
        function transCost(i, kFrom, kTo){
            const K1=Kcands[kFrom], K2=Kcands[kTo];
            const m1=outM[i-1]+K1, m2=outM[i]+K2;
            const dSemi = Math.abs(m2 - m1);
            // 髯?・??・?・?髮主桁??・?髫?・??・?・?髮主沺魍抵?ゑｽ?驛｢・?髢?・?隰・驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・??・?・?鬮??鬮?・??・?閾?・?・?陷会ｽ??・??
            const r = ratios[i]; const allowOct = (r>1.8 || r<0.55);
            let cost = 0.10 * dSemi; // 髯憺屮・?・?髫?蟷?・?・?: 髯?雍???竏ｵ・?・?髯晢???・?・?驍ｵ・??・?・?髮主沺・?雋ｻ・?・?郢晢??
            // ?・?繧托ｽ?・?12鬮?螟ｧ・?・??・?蜥?・?・??・?・?驛｢・?郢晢???・??髮九?・?・?邵?蟶?・?・?遶丞｣?陞ｺ驍ｵ・??・?・?驍ｵ・?郢晢??allowOct 驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?陷?・??・?・??・?・?髯?・?郢晢??
            const nearOct = Math.min(Math.abs(dSemi-12), Math.abs(dSemi-24));
            if(nearOct<0.6){ cost += allowOct? 0.05 : 1.1; }
            // 髯・闕ｳ螂????驍ｵ・??・?・?鬯?蛹・??・?鬩募???・?驛｢・?髮区??・?・??・?・?髯???・?・?鬯?霈?・?
            if(dSemi<=6) cost -= 0.03;
            return cost;
        }
        // 髯具??隴・隰・髯具??郢晢??
        for(let k=0;k<M;k++){ dp[0][k] = localCost(0,k); prv[0][k]=-1; }
        // 髮区誓??・?髯具??鬮???・?・?郢晢??
        for(let i=1;i<N;i++){
            for(let k2=0;k2<M;k2++){
                let best=Infinity, bestp=-1; const lc=localCost(i,k2);
                for(let k1=0;k1<M;k1++){
                    const tc=transCost(i,k1,k2);
                    const c = dp[i-1][k1] + lc + tc;
                    if(c<best){ best=c; bestp=k1; }
                }
                dp[i][k2]=best; prv[i][k2]=bestp;
            }
        }
        // 髯溷桁??・?髯?蛹??・?
        let last=0; { let minv=Infinity; for(let k=0;k<M;k++){ if(dp[N-1][k]<minv){ minv=dp[N-1][k]; last=k; } } }
        const Ksel=new Array(N).fill(0);
        for(let i=N-1;i>=0;i--){ Ksel[i]=Kcands[last]; last = (prv[i][last]>=0)? prv[i][last] : 0; }
        // 鬯?蛹・??・?鬨?蛹・??・?
        for(let i=0;i<N;i++){ outM[i] = safeMidi(outM[i] + Ksel[i]); }
    } else {
        // 髫??会ｽ?・?髯・陋滂ｽ?郢晢??鬮?螟ｧ・?・??・?蝓ｼ・?・??・?・?鬩搾??陞｢・?・つ?・?・?驛｢譎??郢晢??驛｢・??・?・?驍ｵ・??・?・??・?繧托ｽ?・?12鬮?・??・?・?髫?・??・?・?郢晢??闔・??・?・?隰撰??隰?繧???髢髮髯悟｣??・?郢晢??
        for(let i=1;i<outM.length;i++){
            const r = noteMedFreq[i-1]>0? (noteMedFreq[i]/noteMedFreq[i-1]) : 1;
            const allowOct = (r>1.8 || r<0.55);
            if(!allowOct){
                // ?・?繧托ｽ?・?6 髯?雍???竏ｵ・?・?髯??郢晢??遶頑･?諢?陟托???・?竏ｫ・?・?闕ｵ譏ｶ陞ｺ驛｢・?郢晢???・?・?12驍ｵ・??・?・?鬮?・??・?・?髫?・??・?・?
                while(outM[i] - outM[i-1] > 6) outM[i]-=12;
                while(outM[i-1] - outM[i] > 6) outM[i]+=12;
            }
            outM[i]=safeMidi(outM[i]);
        }
    }
    // 驛｢譎???驥・?抵??譎｢・?・?驛｢・??・?・?鬮?謳?・?・?驍ｵ・?陷?荵滂ｽ?蟷・・郢晢?? 髣費??鬩?謳?・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??驍ｵ・??・?・?驛｢譎???驥・?抵??譎｢・?・?驛｢・??・?・?驛｢・?髮区???・?驛｢・?驗呻??・つ遶乗刮竏夐Δ譎???驥・?抵??譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?髯・?・?・?驍ｵ・?陷会ｽ?遯?・? ?・?繧托ｽ?・?12 驍ｵ・??・?・?髫????驛｢・?郢?莉ｰ??・?・?鬩搾??陞溘?鬟ｭ驍ｵ・??・?・?驍ｵ・??・?・?驛｢・?闕ｵ譎｢・?閧?・?・?郢晢??驍丞ｹ・?慕ｹ晢??
    (function(){
        if(cleaned.length<=1) return;
        const PHRASE_GAP_SEC = 0.26; // 驍ｵ・?髦?蜷??・?髴取ｻゑｽ?・?鬯?・??・?・?髣比ｼ夲??・?髣???驗呻??邵?蝣?・?譎???驥・?抵??譎｢・?・?驛｢・??・?・?髯・郢晢??鬮??
        const phrases=[]; let sIdx=0;
        for(let i=1;i<cleaned.length;i++){
            const prev=cleaned[i-1]; const cur=cleaned[i];
            const gap = cur.time - (prev.time + prev.duration);
            if(gap >= PHRASE_GAP_SEC){ phrases.push({s:sIdx, e:i-1}); sIdx=i; }
        }
        phrases.push({s:sIdx, e:cleaned.length-1});
        if(phrases.length<=1) return;
        const medInt=(arr)=>{ const v=arr.slice().sort((a,b)=>a-b); const n=v.length; return n? v[(n-1)>>1] : 0; };
        const Kcands=[-24,-12,0,12,24];
        const p0=phrases[0]; let prevAnchor=medInt(outM.slice(p0.s,p0.e+1)); let prevLast=outM[p0.e];
        for(let pi=1; pi<phrases.length; pi++){
            const ph=phrases[pi]; const seg=outM.slice(ph.s, ph.e+1); if(!seg.length) continue;
            const mFirst=seg[0]; const mMed=medInt(seg);
            let bestK=0, bestCost=1e9;
            for(const K of Kcands){
                const d1=Math.abs((mFirst+K) - prevLast);
                const d2=Math.abs((mMed+K) - prevAnchor);
                const cost=1.2*d1 + 1.0*d2; // 髯?闌ｨ・?・?髯?・??・?・?鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?驛｢・?髮区??・?・??・?・?髯???・?・?髯?蛹??・?
                if(cost<bestCost){ bestCost=cost; bestK=K; }
            }
            if(bestK!==0){ for(let i=ph.s;i<=ph.e;i++){ outM[i]=safeMidi(outM[i]+bestK); } }
            prevAnchor=medInt(outM.slice(ph.s, ph.e+1)); prevLast=outM[ph.e];
        }
    })();
    for(let i=0;i<cleaned.length;i++){ cleaned[i].midi = outM[i]; }
    // 髯?・?驕停扱・?・?鬯?・??・?・?鬩搾??髣??・・?髫????鬩搾??郢??郢晢??驛｢譎｢・?・?驛｢・??・?・?
    const finalNotes=[]; for(const n of cleaned){ if(!finalNotes.length){ finalNotes.push(n); continue; } const p=finalNotes[finalNotes.length-1]; if(n.midi===p.midi && n.time <= p.time+p.duration+0.03){ p.duration = Math.max(p.duration, (n.time+n.duration) - p.time); } else { finalNotes.push(n); } }

    currentTracks=[{name:'Melody', notes: finalNotes}];
    melodyTrackIndex=0; accompTrackIndexes=[]; melodyNotesExtracted=true;
    // 驛｢譎擾??・?郢晢??驛｢譏ｴ?・??・?螳壽??・?・?鬩励???・?髫??陝ｶ蜻?・??驍ｵ・?雋??陞ｺ驛｢・?遶擾??郢晢??髯??趣??譁絶落驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・?髮区???・?髫?蟶?逕･隴??悟ｳ?隰費???・??驍ｵ・??・?・?髯橸??雋????・?・?郢晢??
    autoCenterFrozen = false;
    autoCenterMelodyTrack();
    drawChart();
    if(overlay){ overlay.classList.add('hidden'); }
}

// 驛｢譎擾??・?郢晢??驛｢譎??隲橸??髮手｣・螢??咎Δ譎?蠕湖暮Δ???・?・? / 髯具??郢晢??陝蟶?・?譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢・?陋幢??邵?蝣?・?譎｢・?・?驛｢譎｢・?・?驛｢譎?貉匁凵諤??・?・?鬯?・?郢晢??
window.dumpFirstNotes=function(track=0,count=20){ if(!currentTracks[track]){ console.log('no track',track); return; } const arr=currentTracks[track].notes.slice(0,count).map(n=>({midi:n.midi,time:n.time,dur:n.duration,_t:n._timeSec,_d:n._durSec,ticks:n.ticks,durTicks:n.durationTicks})); console.table(arr); };
window.toggleSynth=function(flag){ usePianoSynth=flag; console.log('usePianoSynth=',usePianoSynth); };
window.toggleSamplePiano=function(flag){ useSamplePiano=flag; console.log('useSamplePiano=',useSamplePiano); if(useSamplePiano) loadPianoSamples(); };
// 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髯溷供??螽??讌｢諤??・?・?驍ｵ・?闕ｳ鄙ｫ?驛｢譎｢・?・?驛｢譎?樟??・?髴取ｻゑｽ?・?驍ｵ・?郢晢???・?・??・?・?髯?・?陋ｹ・?郢晢??驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・? (髯具??隴惹?橸??骰具??・??・?・?驍ｵ・??・?・?)
// 驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟邵?蝣?・?・??・?・?鬮?・??・?・?鬮?證ｦ・?・?驛｢・?陷?逎ｯ・?螟ゑ??・?闕ｳ蟯?陞ｺ驛｢・?遶擾??隨冗霜諤・・?・?髯具??隰費??邵?蝣?・?・?鬮?・??・?迢暦??譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?驛｢譏ｴ?・?邵?蟶?・?譎?樟郢晢??驛｢譎｢・?・?驛｢譎｢・?・?
window.ENABLE_FALLBACK_TONE = false;
function ensureAtLeastOneTestTone(){
    if(!audioCtx) return;
    if(scheduledCounter>0) return;
    if(!window.ENABLE_FALLBACK_TONE) return; // 髫??会ｽ?・?髯橸??陞｢・?郢晢??鬯?????・?驛｢・?陝ｲ・??・??驍ｵ・??・?・?驍ｵ・?郢晢??
    try{
        const osc=audioCtx.createOscillator();
        const g=audioCtx.createGain();
        osc.type='sine';
        osc.frequency.value=440;
        g.gain.setValueAtTime(0.001,audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.3,audioCtx.currentTime+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.6);
        osc.connect(g);
        g.connect(masterGain||audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime+0.62);
        console.warn('Fallback test tone scheduled (no notes were queued).');
    }catch(e){ console.warn('Fallback tone failed',e); }
}
function midiToFreq(m){ return A4Frequency*Math.pow(2,(m-69)/12); }
function seekTo(sec){
    sec=Math.max(0,Math.min(sec,getSongDuration()));
    playbackPosition=sec; playbackStartPos=sec;
    scheduleAll();
    if(isPlaying){ resyncAfterSeek('seekTo'); } else { drawChart(); }
}
function seekRelative(d){ seekTo(playbackPosition+d); }
function getSongDuration(){
    // NaN髮趣???・?・?髯?闌ｨ・?・?驛｢・?郢晢??隰費??髯橸??陞溘ｑ??・??・?・?驛｢・?陜｣・?隨冗｢∝寰隰費???・??驍ｵ・??・?・?髫????鬩搾??郢??郢晢??驛｢譎｢・?・?驛｢譎乗ｲ?陷・??髯具???・?・?驛｢・?髮区??・?・?郢晢??隹?・?驍ｵ・??・?・?髯?・?鬮???・?・?郢晢??
    let max=0; let any=false;
    try{
        (currentTracks||[]).forEach(t=>{
            const notes=(t&&t.notes)||[]; if(!notes.length) return;
            // 髫?蠑ｱ・玖?・?鬯??郢晢???・?螳夊р?・?・?髯橸??陞｢・?隨・驛｢・?闕ｵ譏ｶ?・?驍ｵ・?遶乗劼・?・?郢晢??隹?・?髫?・??・?・?驍ｵ・??・?・?驍ｵ・?雋?∞??竏ｬ諤??・?・?髫俶誓??・?髫?貊ゑ??・?
            for(const n of notes){
                const st=Number(n?.time); const du=Number(n?.duration);
                if(isFinite(st) && isFinite(du)){
                    any=true; const end=st+du; if(end>max) max=end;
                }
            }
        });
        // 鬯?・??・?・?髯橸???・?・?驛｢譎?蠕湖暮Δ譎???譁撰?憺??貊ゑ??・?驛｢・?郢?迺??郢晢??郢晢??郢晢??陋ｹ・?郢晢??驛｢譎｢・?・?驛｢譏ｶ?螢??､驛｢譎｢・?・?驛｢譏???・?隲?・?驛｢・?・つ郢晢??郢晢??
        if(melodyBuffer){ max=Math.max(max, melodyBuffer.duration||0); any=true; }
        try{
            if(Array.isArray(melodyParts)){
                for(const p of melodyParts){ if(p && p.buffer){ max=Math.max(max, p.buffer.duration||0); any=true; } }
            }
        }catch(_){ }
        if(accompBuffer){ max=Math.max(max, accompBuffer.duration||0); any=true; }
    }catch(_){ }
    return any? max: 0;
}
// 髯?闌ｨ・?・?髯???・?・?髯?迚呻??蜷??咎Δ譎?蠕娯鴬驛｢・??・?・?驍ｵ・??・?・?髯樊ｺ?蛻?陝ｲ・?驛｢・?陜｣・?陞ｻ・?鬮??薙§?・??驍ｵ・??・?・?驍ｵ・?遶擾???・?・??・?・?髯?・??・?・?髮九?迴?遶企?・?・?陝ｲ・?邵?遉ｼ・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏???・?郢晢??髯具??隴・隰・髯具??郢晢??
try{
    if(navigator.mediaDevices && navigator.mediaDevices.addEventListener){
        navigator.mediaDevices.addEventListener('devicechange', ()=>{
            try{ canInitMicWithoutPrompt().then(ok=>{ if(ok){ initMic(false).catch(()=>{}); } }); }catch(_){ }
        });
    }
}catch(_){ }
// ---- Pan ----
if(chartCanvas){ chartCanvas.onmousedown=e=>{ isPanning=true; panStartX=e.clientX; panStartOffset=timelineOffsetSec; }; }
window.onmousemove=e=>{ if(isPanning && !isAdjustingVOffset){ const dx=e.clientX-panStartX; timelineOffsetSec=panStartOffset-dx/pxPerSec; drawChart(); }};
window.onmouseup=()=>{ if(isPanning){ applyPanCommit(); isPanning=false; }};
function applyPanCommit(){
    if(timelineOffsetSec===0) return;
    playbackPosition+=timelineOffsetSec; if(playbackPosition<0) playbackPosition=0;
    playbackStartPos=playbackPosition; timelineOffsetSec=0; scheduleAll();
    if(isPlaying){
        // 髫??会ｽ?・?髯・陋滂ｽ?郢晢??髯??陝雜｣・?・??・?・?髯?讎???轣???・?髯滉ｻ??・?+ 髯??隶惹?・遒托??蟶・・?
        pausePlayback(); startPlayback();
        try{ if(typeof resyncAfterSeek==='function') resyncAfterSeek('pan-commit'); }catch(_){ }
    } else {
        drawChart();
    }
}
// 髮朱?会ｽ?・?髯晢???・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕?・?驍ｵ・??・?・?鬩???郢晢??陝ｲ?髫?蜴・??・?髫???・?・?
function updateTimelineScrollRange(){
    if(!timelineScroll) return;
    const dur = getSongDuration();
    const viewSec = (chartCanvas && chartCanvas.width)? (chartCanvas.width/pxPerSec) : 0;
    const max = Math.max(0, dur - viewSec);
    timelineScroll.min = '0';
    timelineScroll.max = String(max.toFixed(2));
    timelineScroll.step = '0.01';
    const playXS = (chartCanvas && chartCanvas.width)? getPlayX(chartCanvas.width) : 70;
    const left = Math.max(0, Math.min(max, (playbackPosition + timelineOffsetSec) - (playXS/pxPerSec)));
    timelineScroll.value = String(left.toFixed(2));
}
// 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髫?・?陜｣・??・?・?郢晢??
timelineScroll && (timelineScroll.oninput = () => {
    const x = parseFloat(timelineScroll.value)||0;
    const playXS = (chartCanvas && chartCanvas.width)? getPlayX(chartCanvas.width) : 70;
    const playXSec = playXS/pxPerSec; // 髯??陷?・?陷・??鬩搾??陞｢・?郢晢??髯晢???・?・?驛｢・??・?・?驛｢譎???譁絶落驛｢譏ｴ?・?郢晢??(鬩募??・?
    const newEff = x + playXSec; // eff = playbackPosition + timelineOffsetSec
    const delta = newEff - (playbackPosition + timelineOffsetSec);
    timelineOffsetSec += delta;
    drawChart();
    if(isPlaying) resyncAfterSeek('scrollbar');
});
// ---- Markers ----
Object.keys(markerCfg).forEach(k=>{ const [s,p]=markerCfg[k]; const sb=$(s),pb=$(p); if(sb) sb.onclick=()=> markers[k]=playbackPosition; if(pb) pb.onclick=()=>{ if(markers[k]!=null) seekTo(markers[k]); }; });
// ---- Pitch ----
function analyzePitch(){
    const nowMs = (typeof performance!=='undefined' && performance.now)? performance.now() : Date.now();
    try{ if(audioCtx && audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{}); } }catch(_){ }
    if(!micAnalyser||!micData) return;
    try{ micAnalyser.getFloatTimeDomainData(micData); }catch(_){ return; }
    // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎??騾?辟ｶMS驍ｵ・??・?・?UI驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?
    let rms=0; for(let i=0;i<micData.length;i++) rms+=micData[i]*micData[i]; rms=Math.sqrt(rms/Math.max(1,micData.length));
    const db=20*Math.log10(Math.max(1e-9,rms));
    if(micLevelBar){ const norm=Math.min(1,Math.max(0,(db+60)/60)); micLevelBar.style.width=(norm*100)+'%'; }
    if(micDbText){ micDbText.textContent=db.toFixed(1)+' dB'; }
    // 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?: 驛｢譎擾??・?邵??驛｢・??・?・?驛｢譎???驥・??・?・??・?・?鬮?????・?髯滓??ｧ隴?蟶?・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎∬??・?・?髢?・?髢?・?髯・郢晢??遶頑･??・?隲帷腸・?驍ｵ・??・?・?鬮?・??・?・?髯??趣??譁石馴Δ譎｢・?・?驛｢譎｢・?・?驛｢譏???譁滂ｽ?驛｢・??・?・?郢晢??郢晢??
    let gateDbEff = gateThreshold;
    if(IS_MOBILE && !IS_MOBILE_PCPIPE){
        try{
            const alpha = 0.02; // 驛｢譎擾??・?邵??驛｢・??・?・?驛｢譎???驥・??・?・??・?・?驍ｵ・??・?・?EMA髣???郢?閧??螢??・?騾趣??遶???驛｢・?郢晢???・?・?郢晢??
            // 髣????・?・?髮・?・?・?: 驛｢譎???驥・??・?・??・?・?驍ｵ・??・?・?驍ｵ・?驕停扱轢?驍ｵ・?闕ｵ譏ｶ?鬘鯉ｽ?蠑ｱ・・?晢??驍ｵ・??・?・?驍ｵ・?髢?・?陝ｲ・?髫???・?・?驍ｵ・?陷会ｽ?遯?・?驍ｵ・?遶擾???・?・?隰疲?ゑｽ?・??・?・?驍ｵ・??・?・?鬮?????・?鬯?・?闕ｳ螂????驍ｵ・??・?・?髣???驗呻??遯?・?驛｢・?陝ｲ・?遶企?・?・?郢晢???・?閧?・?・?郢晢??遶企豪・?・?陷?・??・??
            // 髫?螟ｲ・?・?髣比ｼ夲??・?: 髴托ｽ??・?・?髯懶???・?・?dB驍ｵ・?陟募?湖ｨ驛｢譎｢・?・?驛｢・??・?・?+3dB髣比ｼ夲??・?髣???陷茨???・?・?陜捺?・・?驛｢・?陝ｲ・?・ゑｽ?驍ｵ・??・?・?髴取ｻゑｽ?・?鬯?・??・?・?驍ｵ・?隲幢???・?・?陜灘叙??・?鬯?・?闕ｳ讓???・?郢晢??郢晢??
            if(db <= _mobileNoiseDb + 3){
                _mobileNoiseDb = (1-alpha)*_mobileNoiseDb + alpha*db;
            }
            // 驛｢譎???驥・??・?・??・?・?鬯?遨ゑｽ?・??・?・?陷托ｽ??・?・?驕ｨ繧托ｽ?・??・?・?驛｢・?陝ｶ譏ｶ闌?し??闔会ｽ??・?迢暦??・?雋?∞??竏ｫ・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?惧?・?・?陜捺?督蜻?謚??晢??80dB驍ｵ・?遶擾??隲?蜥趣??・?郢晢??20dB鬩墓ｧ?蜚ｱ?・?・??・?・?郢晢??郢晢??
            if(!Number.isFinite(_mobileNoiseDb)) _mobileNoiseDb = -60;
            _mobileNoiseDb = Math.max(-80, Math.min(-20, _mobileNoiseDb));
            const margin = 8; // 驛｢譎???驥・??・?・??・?・?+8dB 髣比ｼ夲??・?髣???驗呻??郢晢??驍ｵ・??・?・?髫?蟶?逕･?・?・??・?・?髫???・?・?驍ｵ・?郢晢???・?・?陋ｹ・??・??驛｢・?郢晢???・?・??・?・?驛｢・?郢晢???・?・?郢晢??
            gateDbEff = Math.max(gateThreshold, _mobileNoiseDb + margin);
        }catch(_){ gateDbEff = gateThreshold; }
    }
    // 髯?闌ｨ・?・?髯?迚呻??蜷??・?髫??会ｽ?・?鬩????・?・?驍ｵ・??・?・?髯・闕ｳ螂????驍ｵ・?郢晢??隲橸??髫?・?闕ｵ譏ｶ?・?鬩搾??陞｢・??・?・?髯懶???・?・?髯?・?陋ｹ・?郢晢??鬮?・??・?・?髯晢???・?・?髯?軸・?・??・?・??・?・?驛｢・?陞ｳ螟ｲ・?・??・?・?驍ｵ・??・?・?驛｢・?陷茨???・?・?陋ｹ・?郢晢??驛｢譎?蠕娯鴬驛｢・??・?・?髯具??郢晢??陝?/髣???・つ髫?蠑ｱ・臥?冗霜諤・・?・?髯具??鬮???・?・??・?・?鬩???陷???・?・?郢晢??
    try{
        if(db < -55){ _micSilentFrames++; } else { _micSilentFrames=0; }
        const thresholdFrames = Math.max(analysisRate*2, 60); // 鬩堺?・・?鬩募??・?
        if(_micSilentFrames>thresholdFrames && !_micReinitInFlight){
            _micReinitInFlight=true; _micSilentFrames=0;
            setTimeout(async()=>{ try{ await initMic(false).catch(()=>{}); }finally{ _micReinitInFlight=false; } }, 0);
        }
    }catch(_){ }
    // 驛｢譎?・?邵?蟶?・?譏ｴ?・?・取㏍・?・??・?・?驛｢・??・?・?: 髣???・つ髯溯??・?・?鬯?・?闕ｵ譎｢・?讓抵??・?雋?∞????豌｣闔会ｽ??・??髣???闕ｵ譏ｶ?・?驛｢・?闕ｵ譏ｶ遨宣し???・?・?鬯?・?陝ｲ・??・?竏ｫ・?・??・?・?驍ｵ・?郢晢???・?・?陋ｹ・?邵?讙趣??譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??驍ｵ・??・?・?驛｢譎?蠕娯蔓驍ｵ・??・?・?驍ｵ・?髢?・?隶蟷・?・・?・?郢晢??郢晢??
    if(typeof analyzePitch._gateOpen==='undefined') analyzePitch._gateOpen=false;
    if(typeof analyzePitch._gateOpenedAt==='undefined') analyzePitch._gateOpenedAt=0;
    let gateToUse = gateDbEff;
    if(IS_MOBILE && !IS_MOBILE_PCPIPE){ if(analyzePitch._gateOpen){ gateToUse = gateDbEff - 3; } }
    if(db<gateToUse) {
        // 髯橸??隰疲?・・?驛｢譎???驥・??・?譏ｴ?・?郢晢??驍ｵ・?隶呵??・?・?陞｢・??・?・?髯懶???・?・?髯?・?陋ｹ・?郢晢??驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢・??・?・?髣???隶守ｿ??・?髯?・?陋ｹ・?郢晢??髯?・??・?・?鬮?・??・?・?髫?・??・?・? 驕ｶ鄙ｫ?・?髯??隶守ｿ??・?髫?蟶?・?・?陜滂ｽ?驛｢・?陷?蝓滓ｻ矩Δ??遶丞｣??讌｢閼り・§・?・?驍ｵ・?闔会ｽ??・??
        let flat=true; for(let i=0;i<micData.length;i++){ if(micData[i]!==0){ flat=false; break; } }
        if(flat){
            _micFlatFrames++;
            const now=performance.now?performance.now():Date.now();
            if(_micFlatFrames>30 && now - _micLastReinitAt > 1500){ // 鬩堺?・・?.6鬩募??・?
                _micLastReinitAt=now; _micFlatFrames=0; setTimeout(()=>{ try{ initMic(false).catch(()=>{}); }catch(_){ } }, 0);
            }
        } else { _micFlatFrames=0; }
        analyzePitch._gateOpen=false;
        return;
    }
    if(!analyzePitch._gateOpen){
        // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟??・?髣疲・・?竏晢??諷???・?郢晢??隨??郢晢??陋ｹ・?邵?讙趣??譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??郢晢??郢晢??
        analyzePitch._gateOpenedAt = nowMs;
    }
    analyzePitch._gateOpen=true;
    const onsetActive = (IS_MOBILE && !IS_MOBILE_PCPIPE) && (nowMs - (analyzePitch._gateOpenedAt||0) <= 180);

    // --- New YIN pipeline (optional) ---
    try{
        if(USE_YIN_TRACKER && _yinTracker && micData){
            const r = _yinTracker.process(micData);
            let rawFreq = (r && r.freq) || 0;
            let rawConf = (r && r.conf) || 0;
            // 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?髯?・?闔会ｽ??・??: 髣???隲?・??・?・??・?・?鬯???・?・?髴難???・?・?驍ｵ・??・?・?髯滓汚??・?驛｢・?遶丞｣??讌｢・?螢?・?・?陞ｳ蟶?・?・?陷会ｽ?・つ遶擾??雎｢螳夲??蠑ｱ・玖?・?驍ｵ・??・?・?驛｢譎擾??・?・取ｺ?・?譏ｴ?・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢譎?樟郢晢??鬮?・?隲幢???・?・?郢晢??
            const confMin = (IS_MOBILE && !IS_MOBILE_PCPIPE) ? Math.max(0.50, PITCH_CONF_MIN) : PITCH_CONF_MIN;
            // 鬮?????・?髯?莨夲??・?: 鬮???・?・?鬯?・?髴茨??HS驍ｵ・??・?・? f/2, f, 2f 驛｢・?陞ｳ螟ｲ・?・?驕ｨ繧托ｽ?・??・?・?驍ｵ・?陷会ｽ?邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・??・?・?鬮?・?鬮?・??・?螳夲??螟ゑ??・??・?・??・?・?郢晢??郢晢??awFreq>0 驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?隰?・??・?・?郢晢??
            if(rawFreq>0){
                // 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?: 髫??会ｽ?・?鬩????・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎擾??諛ｶ・?・?陝ｶ蜷??・?郢晢??隰紋ｼ夲??・?3oct=36髯?雍???竏ｵ・?・?髣比ｼ夲??・?髣???陞??・?・?陝ｲ・?郢晢??鬩墓得??・?髫?蠑ｱ・玖?・?髫?・?髮区????郢晢??髢?・?隶・?鬨?蜈ｷ・?・?驛｢譎擾??・?邵??驛｢・??・?・?髯・?・?・?鬩???陷???・?・?郢晢??
                if(typeof analyzePitch._lastAcceptedFreqDisp==='undefined') analyzePitch._lastAcceptedFreqDisp=0;
                if(typeof analyzePitch._lastAcceptedRawHist==='undefined') analyzePitch._lastAcceptedRawHist=0;
                if(typeof analyzePitch._extremeFramesDisp==='undefined') analyzePitch._extremeFramesDisp=0;
                if(typeof analyzePitch._extremeFramesHist==='undefined') analyzePitch._extremeFramesHist=0;
                const isExtremeJump = (fNew, fRef)=>{
                    try{ if(!(fNew>0 && fRef>0)) return false; const dSemi=Math.abs(12*Math.log2(fNew/fRef)); return dSemi>=36; }catch(_){ return false; }
                };
                try{
                    const sr = audioCtx? audioCtx.sampleRate: 44100;
                    // 鬨?・??・?・?髫?證ｦ・?・? micData 驛｢・?陷・?・?・??・?・?鬨?蛹・??・?郢晢??陜捺?・飴驍ｵ・??・?・? getFloatTimeDomainData 髮九?迴?遶擾??郢晢??郢晢??
                    const frame = micData;
                    function goertzelPower(arr, sr, f){ if(!(f>0) || f>=sr*0.5) return 0; const w=2*Math.PI*f/sr; const c=Math.cos(w); const coeff=2*c; let s0=0,s1=0,s2=0; for(let n=0;n<arr.length;n++){ s0 = arr[n] + coeff*s1 - s2; s2=s1; s1=s0; } return Math.max(0, s1*s1 + s2*s2 - coeff*s1*s2); }
                    function shsScore(arr, sr, f0, K){ if(!(f0>0)) return 0; const kMax=Math.max(1, K|0); let sum=0, used=0; for(let k=1;k<=kMax;k++){ const fk=f0*k; if(fk>=sr*0.5) break; const p=goertzelPower(arr, sr, fk); sum += (p>0? Math.sqrt(p):0) * (1/k); used++; } return used? sum/used: 0; }
                    const base = rawFreq; const half=base*0.5; const dbl=base*2;
                    let sBase = shsScore(frame, sr, base, 5);
                    let sHalf = shsScore(frame, sr, half, 5);
                    let sDbl  = shsScore(frame, sr, Math.min(dbl, sr*0.49), 5);
                    // 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?: 髯??陷?・?陷・??鬩搾??陞｢・??・?・?驗呻??郢晢??驛｢・??・?・?驛｢・??・?・?驛｢譎会ｽ?・?IDI驍ｵ・??・?・?鬮?蜿?・?・??・?讓抵??・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§?・?螳・蛹・??・?髯???・?・?鬯?霈?・??・?・?騾趣??雎ｬ・?鬩墓ｨ費??譁溽坩・?譎｢・?・?驛｢譎擾??・??・??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟?企豪・?・?郢???・?・??・?・?髯滂ｽ?隲幢???・?・?郢晢??
                    if(IS_MOBILE && !IS_MOBILE_PCPIPE){
                        try{
                            let guideMidiAtPlayhead = null;
                            const tRef = playbackPosition - getPitchVisOffsetSec();
                            if(!isPitchOnlyMode){
                                const tr=currentTracks[melodyTrackIndex];
                                if(tr&&tr.notes&&tr.notes.length){ const nn=tr.notes.find(n=> tRef>=n.time && tRef<=n.time+n.duration) || tr.notes.find(n=> n.time>tRef) || tr.notes[tr.notes.length-1]; if(nn) guideMidiAtPlayhead = nn.midi|0; }
                            }
                            if(guideMidiAtPlayhead==null && Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                                const g = midiGhostNotes.find(n=> tRef>=n.time && tRef<=n.time+n.duration) || null; if(g) guideMidiAtPlayhead = g.midi|0;
                            }
                            if(guideMidiAtPlayhead!=null){
                                const mGuide = guideMidiAtPlayhead;
                                function octaveBias(f, score){ if(!(f>0) || score<=0) return score; const m = 69+12*Math.log2(f/ A4Frequency); let mAdj=m; while(mAdj - mGuide > 6) mAdj -= 12; while(mGuide - mAdj > 6) mAdj += 12; const d=Math.abs(mAdj - mGuide); const w = 1 + Math.max(0, 0.15 * Math.max(0, (6 - d))/6); return score * w; }
                                sHalf = octaveBias(half, sHalf);
                                sBase = octaveBias(base, sBase);
                                sDbl  = octaveBias(dbl,  sDbl);
                            }
                        }catch(_){ }
                    }
                    // 鬨?・??・?・?鬮?蜿?・?・?郢晢??鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?驛｢譎?蠕娯鴬驛｢・??・?・?驛｢・??・?・?
                    let wHalf=0.92, wBase=1.00, wDbl=1.03; // PC鬨?・??・?・?髯溷・萓ｭ郢晢??鬯?・?鬮?・?遶擾??
                    if(onsetActive){ wHalf*=0.8; wDbl*=0.95; } // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??髣????・?・?驍ｵ・??・?・?f/2鬯?蛹・??・?髫?螢?・?・??・?蝣?・?・?髴???・?閾?・?・??・?・?髫?螢?・?・?陞ｳ?
                    if(lastMicFreq>0){
                        const dSemi = Math.abs(12*Math.log2(base/lastMicFreq));
                        if(dSemi<=3){ wBase*=1.05; wDbl*=0.98; }
                    }
                    // 鬯?・?陋滂ｽ?雎ｬ・?髯懈瑳・?蛟･?・? f/2 鬮?・??・?・?髯具???・?・?髯橸??陞｢・?遯?・?髯???・?・?驛｢・?郢晢??隨・驍ｵ・?郢晢??驕ｶ鄙ｫ?・?half 驛｢・?陋幢???・??驛｢・?陝ｲ・?遶頑･??????・?驛｢・?遶丞､?・??
                    const mBase = 69+12*Math.log2(base/ A4Frequency);
                    if(mBase>=80){ wHalf*=0.85; wDbl*=1.05; }
                    let rHalf = sHalf*wHalf, rBase=sBase*wBase, rDbl=sDbl*wDbl;
                    let pick=base, bestS=sBase;
                    if(half>30 && rHalf>rBase && rHalf>rDbl){ pick=half; bestS=sHalf; }
                    if(rDbl>bestS && rDbl>rHalf){ pick=dbl; bestS=sDbl; }
                    // 髯?蛛ｵ?・??・?・??・?・?髫?蠑ｱ・・?晢??髣???鬮?竏?・?髯???・?・?髯?驛∬??・?・?闔蛹・??・?鬯・???・?鬮?????・?髯溷?鍋袖?つ?・?・?驛｢・?陜｣・??・?・??・?・?髣???隴趣???・?・?郢晢??
                    if(pick===half){
                        const alt=Math.max(rBase,rDbl);
                        const th = onsetActive? 1.25 : 1.10; // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??髫?蠑ｱ・・?晢??驛｢・?陋ｹ・??・?鬘俶・?・?・?驍ｵ・?陷会ｽ??・?・?
                        if(rHalf < alt*th){ pick=(rDbl>=rBase? dbl: base); bestS=(rDbl>=rBase? sDbl: sBase); }
                    }
                    // rawFreq 驍ｵ・??・?・?髣????・?・?鬯???・?・?髯溯??・?・?驍ｵ・??・?・?髯?・?髢?・?闕ｳ闊?・?髢?・?陟咲霜豎?・?・?髯???・?・?髣???鬮?・?邵?蝣?・?譎?§郢晢??驛｢・??・?・?驛｢譎∬??・?・?郢晢??
                    const second = (pick===base)? Math.max(sHalf, sDbl) : (pick===half? Math.max(sBase, sDbl): Math.max(sBase, sHalf));
                    const shsRel = bestS>0? Math.min(1, bestS / Math.max(1e-9, second*1.05)) : 0;
                    rawFreq = pick; rawConf = Math.max(rawConf, 0.35*rawConf + 0.65*Math.min(1, shsRel));

                    // 鬮?????・?髯?莨夲??・?: 髯区???・・?・?隲・?・?・??・?・?髯具??隴会ｽ??・?・?郢晢??alf, base, dbl郢晢??陝ｲ・??・?豁司terbi驍ｵ・??・?・?髯橸??霑壼遜??・?陞｢・?陜滂ｽ?郢晢??陋ｹ・??・??驍ｵ・?陷??・?蟶晢??霈?・??・?・??・?・?驍ｵ・?遶丞｢・坩・?譎?蠕娯鴬驛｢譎｢・?・?鬯?・?闔牙遜??・?陞滂ｽ??・?・?郢晢??
                    if(IS_MOBILE && !IS_MOBILE_PCPIPE) try{
                        const cands = [];
                        const costs = [];
                        // 驛｢・??・?・?驛｢・??・?・?驛｢譎?樟郢晢??鬮?蜈ｷ・?・?驍ｵ・??・?・?鬨?・??・?・?髯・?・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・? + 鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?驛｢譎擾??・?郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?邵??
                        function pushCand(f, score){ if(!(f>0)) return; cands.push(f); const inv = 1/Math.max(1e-9, score); let pen=0; if(lastMicFreq>0){ const dSemi=Math.abs(12*Math.log2(f/lastMicFreq)); pen = 0.06*dSemi + (Math.min(Math.abs(dSemi-12),Math.abs(dSemi-24))<0.7? 0.35: 0); } costs.push(inv+pen); }
                        pushCand(half, Math.max(1e-9, rHalf));
                        pushCand(base, Math.max(1e-9, rBase));
                        pushCand(dbl,  Math.max(1e-9, rDbl));
                        yinVitFrames.push({ cands, costs, time: playbackPosition });
                        if(yinVitFrames.length>YIN_VIT_MAX) yinVitFrames.shift();
                        const runVit=(frames, lag)=>{
                            const N=frames.length; if(N===0) return null; const out=N-1-Math.max(0,lag|0); if(out<0) return null;
                            const dp=frames.map(f=>new Array(f.cands.length).fill(Infinity));
                            const pv=frames.map(f=>new Array(f.cands.length).fill(-1));
                            for(let j=0;j<frames[0].cands.length;j++){ dp[0][j]=frames[0].costs[j]; }
                            const baseBeta=0.08, baseOct=1.15; // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?郢晢??闔・??・?・?霑壼遜??・?陞｢・??・?・?雋????・?・??・?・?髯区?ゑｽ?・?郢晢??郢晢??
                            const beta=baseBeta, octPenalty = onsetActive? 1.50 : baseOct; // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??驍ｵ・??・?・?髯滓汚??・?驍ｵ・?闕ｵ??・?蟷・?・・?・?
                            for(let i=1;i<N;i++){
                                const a=frames[i-1], b=frames[i];
                                for(let j=0;j<b.cands.length;j++){
                                    const f2=b.cands[j]; const lc=b.costs[j]; let best=Infinity,bk=-1;
                                    for(let k=0;k<a.cands.length;k++){
                                        const f1=a.cands[k]; let trans=0; if(f1===0||f2===0) trans=0.18; else { const d= Math.abs(12*Math.log2(f2/f1)); const nearOct=Math.min(Math.abs(d-12),Math.abs(d-24)); trans = beta*d + (nearOct<0.6? octPenalty: 0); if(d<=2.5) trans -= 0.03; }
                                        const cost=dp[i-1][k]+lc+trans; if(cost<best){ best=cost; bk=k; }
                                    }
                                    dp[i][j]=best; pv[i][j]=bk;
                                }
                            }
                            let lastJ=0; { let mv=Infinity; const last=dp[N-1]; for(let j=0;j<last.length;j++){ if(last[j]<mv){ mv=last[j]; lastJ=j; } } }
                            const path=new Array(N).fill(0); path[N-1]=lastJ; for(let i=N-1;i>0;i--){ const k=pv[i][path[i]]; path[i-1]=(k>=0? k: 0); }
                            const j=path[out]; return { idx: out, freq: frames[out].cands[j], time: frames[out].time };
                        };
                        const vit = runVit(yinVitFrames, YIN_VIT_LAG);
                        if(vit && vit.freq>0){ rawFreq = vit.freq; }
                    }catch(_){ }
                }catch(_){ /* ignore SHS fallback */ }
            }
            if(rawFreq>0){
                // 髣???隲?・??・?・??・?・?鬯???・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?/髫俶誓??・?髣????・?・?髫?蜴・??・?髫???・?・?驛｢・?陋幢??邵?蟶?・?・??・?・?驛｢譏ｴ?・?郢晢??郢晢??闔・?霎ｯ謌?綜隶抵??・つ?・?・?驛｢・?陷・?・?・?隴・隰梧??・?・?陷会ｽ?遯?・?鬮?遨ゑｽ?譏ｶ陞ｺ鬨?・??・?・?驛｢・?髮区??・?・?霑壼遜??・?陞｢・?陜滂ｽ?郢晢??郢晢??
                const liveMin = (IS_MOBILE && !IS_MOBILE_PCPIPE) ? Math.max(0.38, Math.min(confMin, 0.50)) : confMin; // PC驛｢譏???・?邵??驛｢譎丞ｹ?・主??・?・??・?・?驛｢譎｢・?・?髫?蠑ｱ・・?晢??PC驍ｵ・??・?・?髯?・?陟包???・?・?・つ
                if(rawConf >= confMin){
                    const sm = _pitchSmootherMod? _pitchSmootherMod.push(rawFreq, rawConf): rawFreq;
                    // 鬮?・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?郢晢??鬩・?・?・??・?・?髴難???・?・?/髮玖ｴ具??・??・?閾?・?・?闕ｵ譏ｶ???諱・・?・?髯滓坩螻??・?・?陝ｲ・?郢晢??髫??会ｽ?・?鬩????・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎芽??隶蟷・?・・?・?郢晢??陋ｹ・?・守坩・?譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・?郢晢??郢晢??
                    let acceptDisp = true;
                    if(IS_MOBILE){
                        const ref = lastMicFreq>0? lastMicFreq : (analyzePitch._lastAcceptedFreqDisp||0);
                        if(isExtremeJump(sm, ref)){
                            analyzePitch._extremeFramesDisp = (analyzePitch._extremeFramesDisp|0)+1;
                            if(analyzePitch._extremeFramesDisp < 2){ acceptDisp=false; }
                        } else { analyzePitch._extremeFramesDisp=0; }
                    }
                    if(acceptDisp){
                        lastMicFreq = sm; _mobileHoldRemain = (IS_MOBILE && !IS_MOBILE_PCPIPE)? (onsetActive? 2: 1) : 0; _mobileHoldFreq = sm;
                        analyzePitch._lastAcceptedFreqDisp = lastMicFreq;
                        lastMicMidi = 69 + 12*Math.log2(Math.max(1e-9,lastMicFreq)/A4Frequency);
                    } else {
                        // 驛｢譎擾??蜷??・?驛｢譎｢・?・?驛｢譎擾??・??・??驍ｵ・??・?・?鬮?遨ゑｽ?譏ｶ陞ｺ鬨?・??・?・?驍ｵ・??・?・?鬩???遶擾??陋ｹ・?驛｢・?陷?蝓滂ｽ?蟷・?・・?・?
                        if((IS_MOBILE && !IS_MOBILE_PCPIPE) && _mobileHoldRemain>0 && _mobileHoldFreq>0){
                            _mobileHoldRemain--; lastMicFreq=_mobileHoldFreq; lastMicMidi = 69 + 12*Math.log2(lastMicFreq/A4Frequency);
                        }
                    }
                }else if(IS_MOBILE){
                    // 髯橸???・?・?髮・?・?・?驍ｵ・??・?・?驍ｵ・??・?・?髫?・?闕ｵ譎｢・??驍ｵ・??・?・?驍ｵ・?郢晢??遯?・?驍ｵ・?遶擾???・?・??・?・?髣????・?・?鬨?蛹・??・?驍ｵ・??・?・?驍ｵ・??・?・?驛｢・?郢晢???・??髣???隲?・??・?・??・?・?鬯???・?・?驍ｵ・??・?・?驛｢・?郢???・?・?髫???・?・?驍ｵ・?陷会ｽ?遯?・?髯?・??・?・?鬮?蜍滓亜?つ?・?・?驛｢・?陜｣・??・?・??・?・?髣???郢晢??
                    if(rawConf >= liveMin){
                        const sm = _pitchSmootherMod? _pitchSmootherMod.push(rawFreq, rawConf): rawFreq;
                        let acceptDisp = true;
                        const ref = lastMicFreq>0? lastMicFreq : (analyzePitch._lastAcceptedFreqDisp||0);
                        if(IS_MOBILE && isExtremeJump(sm, ref)){
                            analyzePitch._extremeFramesDisp = (analyzePitch._extremeFramesDisp|0)+1;
                            if(analyzePitch._extremeFramesDisp < 2){ acceptDisp=false; }
                        } else { analyzePitch._extremeFramesDisp=0; }
                        if(acceptDisp){
                            lastMicFreq = sm; _mobileHoldRemain = ((IS_MOBILE && !IS_MOBILE_PCPIPE) && onsetActive? 1: 0); _mobileHoldFreq = sm;
                            analyzePitch._lastAcceptedFreqDisp = lastMicFreq;
                            lastMicMidi = 69 + 12*Math.log2(Math.max(1e-9,lastMicFreq)/A4Frequency);
                        }
                    }
                    // 鬨?・??・?・?鬮?蜿?・?・?郢晢??髫?蟶?逕･?・?・??・?・?鬯?・??・?・?驛｢・?郢晢??2 驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・?陷?・??・?・?隴・隰梧?・・?陋ｹ・?邵?蜊???・??・?・?驛｢・??・?・?驛｢・??・?・?髫?螢?・?・?陞ｳ蟶・・?郢晢??
                    if(_mobileHoldRemain>0 && _mobileHoldFreq>0){
                        _mobileHoldRemain--; lastMicFreq=_mobileHoldFreq; lastMicMidi = 69 + 12*Math.log2(lastMicFreq/A4Frequency);
                    }
                }
                if(!isCalibrating && rawConf >= confMin){
                    const vOff = getPitchVisOffsetSec();
                    const recTime = playbackPosition - vOff;
                    // 髯橸???・?・?髮・?・?・?驍ｵ・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?髯????らｹ晢??鬨??難??・?隰?歓??蛹・??・?髫?・??・?・?驛｢・?陷・?・?・?隴取得??・?陋??・?・?陜捺??・?蟶敖蛹・??・?髯句??・?・?驍ｵ・??・?・?髣???・つ鬮?蜈ｷ・?・?驍ｵ・?陷会ｽ?遯?・?髯??陝雜｣・?・?髢?・??・?・?隴会ｽ??・?・?郢晢??
                    // 鬯?・?陋??・?・??・?・?鬯???・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?驛｢・?郢???・?・??・?・?髫?蠑ｱ・・・?・?陋滂ｽ?????郢晢??騾趣??闖ｫ・?髯??鯉ｽ?謚ｫ?・?驍ｵ・?陷会ｽ?遶企?・?・?郢晢???・?・?陝ｲ・?遯?・?驍ｵ・?遶擾???・?・??・?・?鬩????・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ?郢晢??鬩墓得??・?髫?蠑ｱ・玖?・?髫?・?髮区????
                    let acceptHist = true;
                    if(IS_MOBILE){
                        const refH = analyzePitch._lastAcceptedRawHist||0;
                        if(isExtremeJump(rawFreq, refH)){
                            analyzePitch._extremeFramesHist = (analyzePitch._extremeFramesHist|0)+1;
                            if(analyzePitch._extremeFramesHist < 2){ acceptHist=false; }
                        } else { analyzePitch._extremeFramesHist=0; }
                    }
                    if(!IS_MOBILE || IS_MOBILE_PCPIPE || true){
                        if(acceptHist){
                            // 鬮?・??・?・?髫???・?・?: 髴取ｻゑｽ?・?髯?莨夲??・?髯区?ゑｽ?・?髫??隲幢??郢晢??
                            if(!(rawFreq>0) || !Number.isFinite(rawFreq) || rawFreq>12000){
                                __diagLog('hist-push-invalid', {rawFreq, rawConf, recTime, vOff, A4:A4Frequency});
                            }
                            pitchHistory.push({ time: recTime, visOff: vOff, freq: rawFreq, conf: rawConf, sid: scoreSessionId });
                            analyzePitch._lastAcceptedRawHist = rawFreq;
                            if(pitchHistory.length>2000) pitchHistory.shift();
                            if(IS_MOBILE) _mobileLowDecim = 0;
                        }
                    }
                } else if(!isCalibrating && (IS_MOBILE && !IS_MOBILE_PCPIPE)){
                    // 髣???隲?・??・?・??・?・?鬯???・?・?驍ｵ・??・?・?驍ｵ・?郢晢??liveMin 髣比ｼ夲??・?髣???郢晢?? 鬩搾??陞｢・?郢晢??鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?鬩墓?・?・?髣???隴擾??郢晢??驍ｵ・?雋?∞???鬮???・?・?鬯?・?闕ｳ蟯??讌｢讀??・?・?髮・?・?・?驍ｵ・??・?・?鬮?・?陋滂ｽ?????郢晢??陋ｹ・??・??驛｢・?陝ｲ・?遶???・?・?霓｣蛛???・?髴域喚?・?郢晢??郢晢??
                    const liveMin = Math.max(0.38, Math.min(confMin, 0.50));
                    if(rawConf >= liveMin){
                        const vOff = getPitchVisOffsetSec();
                        const recTime = playbackPosition - vOff;
                        // 驍ｵ・?髴???・?閾?・?・??・?・?鬯?・?霓｣蛛???・?髴域喚?・?: 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取刮・?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?3驍ｵ・?郢晢??驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?1髯?軸・?謚ｵ・?・?陷?・??・?・??・?・?
                        _mobileLowDecim = ((_mobileLowDecim|0) + 1);
                        if((_mobileLowDecim % 3)===0){
                            // 髣???隲?・??・?・??・?・?鬯???・?・?驍ｵ・??・?・?驛｢・?郢?闌ｨ・?・??・?・?鬩????・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ?郢晢??鬮?・?陋滂ｽ?????驍ｵ・?陷会ｽ?遶企?・?・?郢晢???・?・?髢?・??・?・?陞｢・?郢晢??鬩???遶擾??陋ｹ・?驛｢・??・?・?驛｢譏???・?邵??驛｢・??・?・?鬯?・??・?・?髮・?・?・?郢晢??郢晢??
                            let acceptHistL = true;
                            const refH = analyzePitch._lastAcceptedRawHist||0;
                            if(isExtremeJump(rawFreq, refH)){
                                analyzePitch._extremeFramesHist = (analyzePitch._extremeFramesHist|0)+1;
                                if(analyzePitch._extremeFramesHist < 2){ acceptHistL=false; }
                            } else { analyzePitch._extremeFramesHist=0; }
                            if(acceptHistL){
                                if(!(rawFreq>0) || !Number.isFinite(rawFreq) || rawFreq>12000){
                                    __diagLog('hist-push-invalid-low', {rawFreq, rawConf, recTime, vOff, A4:A4Frequency});
                                }
                                pitchHistory.push({ time: recTime, visOff: vOff, freq: rawFreq, conf: rawConf, sid: scoreSessionId });
                                analyzePitch._lastAcceptedRawHist = rawFreq;
                                if(pitchHistory.length>2000) pitchHistory.shift();
                            }
                        }
                    }
                }
            }
            if(!isPlaying) drawChart();
            return; // YIN驛｢譏???・?邵?蟶?・?・??・?・?髯橸??陟包???・?・?郢晢???・?・?陜捺??・???・・?・?鬨??郢晢??遶剰ご??・??・?・?鬮?・?陟募具??驍ｵ・??・?・?驍ｵ・?郢晢???・?・?郢晢??
        }
    }catch(_){ /* fallback blocked intentionally to keep pipeline clean */ }

    const srLive = audioCtx? audioCtx.sampleRate: 44100;
    const W = micAnalyser.fftSize; // 2048 鬩墓ｧ?蜚ｱ?・?・??・?・?
    // Hann 鬩???郢晢??
    const hann=new Float32Array(W); for(let n=0;n<W;n++) hann[n]=0.5*(1-Math.cos(2*Math.PI*n/(W-1)));
    // DC 鬯?・??・?・?髯?・??・?・? + 鬩???隰撰??陝???驍ｵ・?郢晢??
    let mean=0; for(let i=0;i<W;i++) mean+=micData[i]; mean/=W; const frame=new Float32Array(W);
    for(let i=0;i<W;i++){ frame[i]=(micData[i]-mean)*hann[i]; }
    // 髫?證ｦ・?・?鬩肴得??・?鬩???郢晢??陝ｲ?郢晢??郢晢??5..1200Hz 鬨?・??・?・?髯溷?懷???・?・?陝ｲ・?・つ郢??郢晢??驍ｵ・??・?・?驍ｵ・??・?・? lastMicFreq 驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎擾??・?郢晢??驛｢譎｢・?・?驛｢譎?樟邵?蟶昴???・?・?驍ｵ・?闕ｳ鄙ｫ?｣驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?
    // 鬯?・?陋滂ｽ?雎ｬ・?髯懈瑳・?繧托ｽ?・?郢晢??8驕ｶ霈?・?.7kHz, E8驕ｶ霈?・?.2kHz郢晢??陝ｲ・?遶擾??驍ｵ・??・?・?髫?・??・?・?驍ｵ・?陋ｹ・??・?迢暦??・?陋ｹ・?遶???驍ｵ・??・?・?髣???闔ｨ竏晏?彷maxLive驛｢・?陷???繝ｱ髯滓汚??・?
    const fmaxLive = 6000; // Hz郢晢??髢?・??・?・??・?・?髫?蟷?・?・?SR48k驍ｵ・??・?・? Nyquist=24k 驍ｵ・??・?・?髯?蟯??譏ｴ?・?髯??郢晢??郢晢??郢晢??郢晢??
    const tauMin = Math.max(2, Math.floor(srLive/Math.min(fmaxLive, srLive*0.49)));
    const tauMax = Math.max(tauMin+2, Math.min(Math.floor(srLive/65), Math.floor(W*0.9)));
    // 鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?髯具???・?・?鬩堺?・・??・?・?隰紋ｼ夲??・?2髯?雍???竏ｵ・?・?郢晢??郢晢??
    // 鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?髯具???・?・?鬩堺?・・? 髯憺屮・?・?髫?蟷?・?・?驍ｵ・??・?・??・?繧托ｽ?・?6髯?雍???竏ｵ・?・?驍ｵ・??・?・?驍ｵ・?陟募仰遶擾??陟咲?・??・??・?・?驍ｵ・?隰疲?ゑｽ?・??・?・?驍ｵ・?郢晢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?髴???・?閾?・?・??・?・?髯溷???・??・?・?驍ｵ・?遶乗劼・?・??・?・?驍ｵ・?郢晢??遶???・?・?鬮?・?郢晢??髯・闔会ｽ??・??髴托ｽ??・?・?驛｢・?遶丞､?・??
    // 髯溷?難??・??・?・??・?・?驍ｵ・??・?・?bestR驍ｵ・?隴?・??・?・??・?・?驍ｵ・??・?・?驛｢・?闕ｵ譏ｴ?・?驍ｵ・??・?・?驍ｵ・?遶丞｣?遨宣し??陞｢・?郢晢??驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟郢晢???・?繧托ｽ?・?6髯?雍???竏ｵ・?・?驛｢・?陷・?・?・??・?・?驍ｵ・?郢晢??・つ遶丞｣?譌ｺ驍ｵ・??・?・?驍ｵ・??・?・?髯??陝雜｣・?・?髢?・??・?・?陷会ｽ?郢晢??髯?・??・?・?鬮?・??・?・?髫?・??・?・?驍ｵ・?郢???・??
    let SEMI_NARROW = Math.pow(2, 6/12);
    let localTauMin=tauMin, localTauMax=tauMax;
    if(_forceGlobalSearch>0){
        _forceGlobalSearch = Math.max(0, _forceGlobalSearch-1); // 髣???・つ髫?蠑ｱ・芽搦・?驍ｵ・??・?・?髯?闌ｨ・?・?髯?侭?・?
    } else if(lastMicFreq>0){
        const tau0=srLive/lastMicFreq; localTauMin=Math.max(tauMin, Math.floor(tau0/SEMI_NARROW)); localTauMax=Math.min(tauMax, Math.ceil(tau0*SEMI_NARROW));
        const pad=2; localTauMin=Math.max(tauMin, localTauMin-pad); localTauMax=Math.min(tauMax, localTauMax+pad);
    }
    // 郢晢??陜捺?ゑｽ?・??・?・?髫?・?隰?・??・?・?騾???霎ｷ・?鬩肴得??・?鬩???郢晢??陝ｲ?驍ｵ・??・?・?鬯?遨ゑｽ?・??・?・??・?・?驍ｵ・??・?・?髴托ｽ??・?・?鬩???郢晢??郢晢??驛｢譏???闔橸??驛｢譏ｶ??・??驛｢・??・?・?驍ｵ・??・?・?髯?・?雋???陞ｻ? 驕ｶ鄙ｫ?・?鬩搾???・?・?驛｢・?郢晢??・ゑｽ?驍ｵ・??・?・?鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?驍ｵ・??・?・?驍ｵ・??・?・?鬯?蛹・??・?鬨?蛹・??・?
    // NACF 髫????髯樊ｻゑｽ?・?髫?證ｦ・?・?鬩肴得??・?郢晢??髢?・??・?・?陷・?郢晢??髯溷桁??・?郢晢??郢晢??
    let bestTau=-1, bestR=-1;
    // 髯・隴擾??au髯晢???・?・?郢晢??騾趣???・?・?闔ｨ諛域狭髮主桁??・?郢晢??陝ｲ・?邵?蝣?・?・??・?・?髯具???・?・?驍ｵ・??・?・?驛｢・?陜｣・??・?・??・?・?驍ｵ・?闕ｵ譎｢・?・?驍ｵ・?陷会ｽ?・つ遶乗剌蠕宣Δ??驗呻???・??驍ｵ・??・?・?驍ｵ・?陷会ｽ??・?蟶晢??・??・?・?驍ｵ・?郢晢??
    const coarseStep = (localTauMin <= 32 ? 1 : 2);
    // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢譎｢・?・?驛｢譏ｴ?・?邵??: 髫?謔ｶ?・??・?・?陞溘ｑ??・?郢晢??陝ｲ?驍ｵ・??・?・?鬩埼?碑ｻ?霎ｷ・?鬩肴得??・?
    function coarseSearch(tMin, tMax){
        let bTau=-1, bR=-1;
        for(let tau=tMin; tau<=tMax; tau+=coarseStep){
            let r=0,e0=0,e1=0; const N=W-tau;
            for(let n=0;n<N;n++){ const a=frame[n], b=frame[n+tau]; r+=a*b; e0+=a*a; e1+=b*b; }
            const den=Math.sqrt(e0*e1)+1e-12; const nacf=r/den; if(nacf>bR){ bR=nacf; bTau=tau; }
        }
        return {bTau,bR};
    }
    // 驍ｵ・??・?・?驍ｵ・?陞｢・?郢晢??髯橸??・つ髫??・つ髫?證ｦ・?・?鬩肴得??・?
    ({bTau:bestTau, bR:bestR} = coarseSearch(localTauMin, localTauMax));
    // 鬨?・??・?・?鬯?・??・?・?驍ｵ・?隰疲?ゑｽ?・??・?・?驍ｵ・?郢晢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯??隶朱宦蠕宣辧蜍溷??郢晢??驍ｵ・?雋?∞??竏ｬ諤??・?・?髯懈瑳・?蛟･?螳壽咎?・?霎ｷ・?鬩肴得??・?郢晢??闔・?陝遏ｩ?・?・つ髯具???・?・?髯橸??陞｢・?邵?蝣?・?・??・?・?驍ｵ・??・?・?驍ｵ・?闕ｳ迺??遶丞｣?關ｽ驍ｵ・??・?・?髴托ｽ??・?・?鬯?・?髦?蜷??・?髣????・?・?鬯???・?・?髯溯??・?・?驍ｵ・??・?・?髯具???・?・?髫???・?・?郢晢??郢晢??
    const REACQUIRE_R_THRESH = 0.20;
    if(bestR < REACQUIRE_R_THRESH){
        const resAll = coarseSearch(tauMin, tauMax);
        // 髯?蟯??譏ｴ?・?髫?・??・?・?髯懈ｺ・・?隨・驛｢・?闕ｵ譏ｶ?驢搾??・?霑壼??・?髯懈瑳・?・??・?・?陷亥沺・?・?驛｢・?陷?蝓滂ｽ?・?鬨?蛹・??・?
        if(resAll.bR > bestR + 0.02){ bestTau = resAll.bTau; bestR = resAll.bR; }
    }
    // 髯・郢晢??鬮?諛???・??・?・?髯滓汚??・?驛｢・?髮榊?・?・?陋滂ｽ??・?讓抵??・?雋????・?・??・?・?髯?・?陋ｹ・?郢晢??髯?闌ｨ・?・?髯懈瑳・?蛟･?螳壽咎?・?霎ｷ・?鬩肴得??・?郢晢??闔・??・?・??・?・?驍ｵ・?鬮?・?遶???・?・??・?・?鬩墓ｨ定ｷ・・?・??・?・?髯??趣??謚ｫ?讌｢豎?・?・?髯滂ｽ?隲幢???・?・?郢晢??
    if(bestTau===localTauMin || bestTau===localTauMax){
        const res = coarseSearch(tauMin, tauMax);
        if(res.bR > bestR + 1e-6){ bestTau = res.bTau; bestR = res.bR; }
    }
    if(bestTau>0){
        // bestR驍ｵ・??・?・?髯滂ｽ?隲帷腸・?驍ｵ・??・?・?鬩???霓｣蛛???・?郢晢???・?蟶晏擅?・?・?髫?・??・?・?郢晢??闔・??・?・??・?・?驍ｵ・?郢晢?? ?・?繧托ｽ?・?9髯?雍???竏ｵ・?・?驍ｵ・?遶乗劼・?・??・?・?驍ｵ・?郢晢?? ?・?繧托ｽ?・?4髯?雍???竏ｵ・?・?郢晢??陝ｲ・??・??驍ｵ・?遶乗劼・?・?郢晢???・?・?遶丞｣??驢搾??・?霑壼??・?髯溯??・?・?髯橸??・つ髫??・つ髯溷桁??・?鬮?・??・?・?髫?・??・?・?
        if(bestR>0){
            const narrow = Math.pow(2, 4/12), wide = Math.pow(2, 9/12);
            const t = Math.max(0, Math.min(1, (bestR-0.2)/(0.8-0.2))); // R=0.2驕ｶ鄙ｫ?・?, R=0.8驕ｶ鄙ｫ?・?
            const target = wide * Math.pow(narrow/wide, t); // R髣???陝????・?wide, R鬯?・?陋滂ｽ?郢晢??narrow
            if(Math.abs(target - SEMI_NARROW) > 1e-6 && lastMicFreq>0){
                SEMI_NARROW = target;
                let lMin=tauMin, lMax=tauMax;
                const tau0=srLive/lastMicFreq; lMin=Math.max(tauMin, Math.floor(tau0/SEMI_NARROW)); lMax=Math.min(tauMax, Math.ceil(tau0*SEMI_NARROW));
                const pad=2; lMin=Math.max(tauMin, lMin-pad); lMax=Math.min(tauMax, lMax+pad);
                const resLoc = coarseSearch(lMin, lMax);
                if(resLoc.bR > bestR + 1e-6){ bestTau = resLoc.bTau; bestR = resLoc.bR; }
            }
        }
        const t0=Math.max(localTauMin, bestTau-2), t1=Math.min(localTauMax, bestTau+2);
        for(let tau=t0; tau<=t1; tau++){ let r=0,e0=0,e1=0; const N=W-tau; for(let n=0;n<N;n++){ const a=frame[n], b=frame[n+tau]; r+=a*b; e0+=a*a; e1+=b*b; } const den=Math.sqrt(e0*e1)+1e-12; const nacf=r/den; if(nacf>bestR){ bestR=nacf; bestTau=tau; } }
    }
    // 驛｢譏???・?・主??・?譎?鯵・取㏍・?譏ｴ?・?邵???蜍ｳ隲橸??闖ｫ・?
    let estTau=bestTau; if(bestTau>Math.max(tauMin, localTauMin) && bestTau<Math.min(tauMax, localTauMax)){
        const fAt=(t)=>{ let r=0,e0=0,e1=0; const N=W-t; for(let n=0;n<N;n++){ const a=frame[n], b=frame[n+t]; r+=a*b; e0+=a*a; e1+=b*b; } return r/(Math.sqrt(e0*e1)+1e-12); };
        const ym1=fAt(bestTau-1), y0=bestR, yp1=fAt(bestTau+1); const denom=(ym1-2*y0+yp1); if(Math.abs(denom)>1e-9){ const delta=0.5*(ym1-yp1)/denom; if(Math.abs(delta)<=1) estTau=bestTau+delta; }
    }
    const NACF_THRESH=0.28; // 驛｢・?闕ｳ蟯???驍ｵ・?闕ｵ譏ｶ?鬥?縺・・?・?驛｢・?遶丞､?・??
    let freq=(bestR>=NACF_THRESH && estTau>0)? (srLive/estTau) : 0;
    // 髯?闌ｨ・?・?髯懈瑳・?骰狗ｲ??肴得??・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎擾??・?邵?蝣?・?・??・?・?SHS鬩埼宦蟷?邵?遉ｼ・?譎｢・?・?驛｢譏ｴ?・??・?・?闔・?陝遏ｩ?・?・つ髫??隲幢??郢晢??驍ｵ・??・?・?驍ｵ・??・?・?髫俶誓??・?髯??趣??雋ｻ・??驍ｵ・??・?・?驍ｵ・?郢晢???・?・?郢晢??
    function shsReacquire(frameArr, sr){
    const fMin=80, fMax=fmaxLive; const bins=128; let bestF=0, bestS=0; const scores=new Float32Array(bins);
        for(let i=0;i<bins;i++){
            const r=i/(bins-1); const f = fMin * Math.pow(fMax/fMin, r);
            const s = shsScore(frameArr, sr, f, 5);
            scores[i]=s; if(s>bestS){ bestS=s; bestF=f; }
        }
        const arr=Array.from(scores).sort((a,b)=>a-b); const med=arr[Math.floor(arr.length/2)]||0; if(bestS>Math.max(1e-9, med*2)) return bestF; return 0;
    }
    if(_forceGlobalSearch>0){
        const fRe = shsReacquire(frame, srLive);
        if(fRe>0) freq=fRe;
    }
    // 鬮???・?・?鬯?・?髴茨??HS驍ｵ・??・?・? f/2, f, 2f 驍ｵ・??・?・?髣????・?・?驍ｵ・?闕ｵ譎｢・???・????雎ｼ・??・?・?驛｢・?陝ｶ譏ｶ?驛???螢?・?・??・?・?陋ｹ・?邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・??・?・?鬮?・?鬮?・?郢晢??髫?螢?・?・?陞ｳ蟶・・?郢晢??
    function goertzelPower(frameArr, sr, f){
        if(!(f>0) || f>=sr*0.5) return 0; const w=2*Math.PI*f/sr; const c=Math.cos(w); const coeff=2*c; let s0=0,s1=0,s2=0; for(let n=0;n<frameArr.length;n++){ s0 = frameArr[n] + coeff*s1 - s2; s2=s1; s1=s0; } return Math.max(0, s1*s1 + s2*s2 - coeff*s1*s2);
    }
    function shsScore(frameArr, sr, f0, K){ if(!(f0>0)) return 0; const kMax=Math.max(1, K|0); let sum=0, used=0; for(let k=1;k<=kMax;k++){ const fk=f0*k; if(fk>=sr*0.5) break; const p=goertzelPower(frameArr, sr, fk); sum += (p>0? Math.sqrt(p):0) * (1/k); used++; } return used? sum/used: 0; }
    let conf=0.0;
    // --- 驛｢譎｢・?・?驛｢・??・?・?驛｢譎乗趨iterbi髯区???・・?・?隲・?・?・??・?・?髯具??陷会ｽ?郢晢??髫?蜴・??・?髫???・?・?郢晢??郢晢??req鬩墓?・?・?髯橸??陞｢・?郢晢??髯?鬘後??・?・??・?・?驍ｵ・??・?・?鬮?・?陟募??魘ｬ郢晢??郢晢??---
    // cFreqs, cCosts 驍ｵ・??・?・?驍ｵ・?髦?蜷??・?髣???驗呻??郢晢??驛｢譎?§・取ｺ?・?譏ｴ?・?邵?驢搾??・??・?・?髫?蝣?霍?・?・?陝ｲ・??・??驛｢・?陟暮?会ｽ?荵・・?髢?・?隨冗霜讀??・?・?鬯?・??・?・?驛｢・?郢??隲?・?驛｢・?・つ郢晢??郢晢??
    // 驍ｵ・?髦?蜻?・??驍ｵ・??・?・?驍ｵ・??・?・?髴托ｽ??・?・?驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯区???・・?・?隲???螟ゑ??・?陝ｶ譏ｶ??辧雜｣・?・?驍ｵ・??・?・?髯・陷会ｽ??・??驍ｵ・?髴域喚?驢搾??・?郢晢??隨??驛｢・?遶丞仰遶丞｣?・・Δ???・?・?驛｢譎?樟郢晢??髣???陟托???・?讚??髮榊?・?・?鬮?・?郢晢??驍ｵ・??・?・?髫?證ｦ・?・?鬨?蛹・??・?
    try{
        if(Array.isArray(cFreqs) && Array.isArray(cCosts) && cFreqs.length===cCosts.length){
            const idx = Array.from({length:cFreqs.length}, (_,i)=>i).sort((a,b)=> cCosts[a]-cCosts[b]);
            const keep = Math.min(5, idx.length);
            const selCands = new Array(keep);
            const selCosts = new Array(keep);
            for(let ii=0; ii<keep; ii++){ selCands[ii]=cFreqs[idx[ii]]; selCosts[ii]=cCosts[idx[ii]]; }
            liveVitFrames.push({ cands: selCands, costs: selCosts, time: playbackPosition });
            if(liveVitFrames.length > LIVE_VIT_MAX) liveVitFrames.shift();
            // 鬩墓得??・?鬯?霈?・??・?・??・?・?Viterbi驍ｵ・??・?・?髯橸??霑壼遜??・?陞｢・?遶??梧Τ?・?・?髮主桁??・?髫?・??・?・?驛｢・?陝ｶ譏ｶ?閧?・?・??・?・?
            const vit = (function runLiveViterbi(frames, lag){
                try{
                    const N = frames.length; if(N===0) return null;
                    const outIndex = N - 1 - Math.max(0, lag|0);
                    if(outIndex < 0) return null; // 驍ｵ・??・?・?驍ｵ・??・?・?鬯?霈?・??・?・??・?・?髯具??郢晢??遯?・?髮・隲帛ｲ?遨宣し???・?・?驍ｵ・??・?・?驍ｵ・?郢晢??遶企?・?・?郢晢??
                    // DP鬯?貊難??鄙ｫ?・?
                    const dp = frames.map(f => new Array(f.cands.length).fill(Infinity));
                    const pv = frames.map(f => new Array(f.cands.length).fill(-1));
                    // 髯具??隴・隰・髯具??郢晢??
                    const f0 = frames[0]; for(let j=0;j<f0.cands.length;j++){ dp[0][j] = f0.costs[j]; }
                    const baseBeta = 0.10; const baseOct = 1.25;
                    const beta = onsetActive? baseBeta : baseBeta;
                    const octPenalty = onsetActive? 1.45 : baseOct;
                    for(let i=1;i<N;i++){
                        const fi = frames[i]; const fi_1 = frames[i-1];
                        for(let j=0;j<fi.cands.length;j++){
                            const f2 = fi.cands[j]; const lc = fi.costs[j];
                            let best=Infinity, bestk=-1;
                            for(let k=0;k<fi_1.cands.length;k++){
                                const f1 = fi_1.cands[k];
                                let trans=0;
                                if(f1===0 || f2===0){ trans = 0.26; }
                                else {
                                    const dSemi = Math.abs(12*Math.log2(f2/f1));
                                    const nearOct = Math.min(Math.abs(dSemi-12), Math.abs(dSemi-24));
                                    trans = beta*dSemi + (nearOct<0.7? octPenalty: 0);
                                    if(dSemi<=3) trans -= 0.04; else if(dSemi<12) trans += 0.03;
                                }
                                const cost = dp[i-1][k] + lc + trans;
                                if(cost<best){ best=cost; bestk=k; }
                            }
                            dp[i][j]=best; pv[i][j]=bestk;
                        }
                    }
                    // 髫?蟷?・?・?髯・?・?・?驍ｵ・?闕ｵ譎｢・???・????髯・闕ｳ鄙ｫ・・Δ???・?・?驛｢譎?樟郢晢??驛｢譏???・?邵?蟶?・?・?髮区??・?・??・?・?髯?蛹??・?
                    let lastJ=0; { let minv=Infinity; const last=dp[N-1]; for(let j=0;j<last.length;j++){ if(last[j]<minv){ minv=last[j]; lastJ=j; } } }
                    const pathIdx = new Array(N).fill(0); pathIdx[N-1]=lastJ; for(let i=N-1;i>0;i--){ const k=pv[i][pathIdx[i]]; pathIdx[i-1] = (k>=0? k: 0); }
                    const selJ = pathIdx[outIndex];
                    return { idx: outIndex, freq: frames[outIndex].cands[selJ], time: frames[outIndex].time };
                }catch(_){ return null; }
            })(liveVitFrames, LIVE_VIT_LAG);
            if(vit && vit.freq>0){ freq = vit.freq; var __vitTimeOverride = vit.time; }
        }
    }catch(_){ }

    if(freq>0){
        const base = freq; const half=base*0.5; const dbl=base*2;
        const sBase = shsScore(frame, srLive, base, 5);
        const sHalf = shsScore(frame, srLive, half, 5);
        const sDbl  = shsScore(frame, srLive, Math.min(dbl, srLive*0.49), 5);
    // 髣???闕ｵ譏ｴ窶?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?ｧ・・?・?郢晢??/2郢晢??陝ｲ・?遶頑･?・?・?遶丞､?・?讙趣??・??・?・?驍ｵ・?闕ｳ螂???・?驍ｵ・?陷会ｽ?・つ遶擾???・?・?驗呻??邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?ｧ・・?・?郢晢??f郢晢??陝ｲ・?郢晢??鬮?驢搾??・?騾寂握・?蠑ｱ・・?頑･?諢?隰費???・?鬘費??・?郢晢??隨・驍ｵ・?闕ｳ蟯???驛｢・?驕擾??郤・??驍ｵ・??・?・?髣皮甥?・??・??
    let wHalf=0.88, wBase=1.00, wDbl=1.12;
        // 鬨?・??・?・?鬮?蜿?・?・?郢晢??驛｢譎?樟?取ｨ抵??譎｢・?・?驛｢譎擾??・?邵?螳・????・?驍ｵ・?郢晢??郢晢??驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?郢晢??闔蛹・??・?鬯・???・?驕ｶ髮・??譎｢・?・?陋滂ｽ??・?讚?ｱ?惱・??・?・?隲帛ｲ???+驍ｵ・?遶擾???・?・?驕擾??陷・驕ｶ髮∝ｮ??・?・?陟托???・?讚?ｱ?惱・??・?・?隲帛ｲ???+郢晢??陝ｲ・?・つ郢?驫??匚????・?驍ｵ・??・?・?驍ｵ・?陷会ｽ?遶企?・?・?郢晢??
        let trend=0; try{
            if(pitchSmoothBuf.length>=4){
                const a=pitchSmoothBuf[pitchSmoothBuf.length-4];
                const b=pitchSmoothBuf[pitchSmoothBuf.length-1];
                trend = Math.max(-1, Math.min(1, Math.sign(b-a)));
            }
        }catch(_){ }
        const trendBoost = 1 + 0.05*trend;    // 髣???鬯・???・?髫?蠑ｱ?・?1.05, 髣???驕擾??陷・髫?蠑ｱ?・?0.95郢晢??騾趣???・?・?陋??・?・?陟托??邵?蟶晢??・?郢晢??遶???・?蛹・??・?鬨?蛹・??・?郢晢??郢晢??
        // 鬨?・??・?・?鬮?蜿?・?・?郢晢??髯???・?・?髯?迚呻??・?IDI驍ｵ・??・?・?驍ｵ・??・?・?鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?郢晢??隰紋ｼ夲??・?6髯?雍???竏ｵ・?・?髣比ｼ夲??・?髯??郢晢???・?螳壽・・?・?鬯?霈?・?・つ郢晢???・?・?6鬮?諛?・?郢晢??髮九?・?・?邵?蟶・・?郢晢??
        function contMul(m){
            try{
                if(!(lastMicMidi>0)) return 1.0;
                let mm=m; const exp=lastMicMidi;
                while(mm-exp>6) mm-=12; while(exp-mm>6) mm+=12;
                const d=Math.abs(mm-exp);
                if(d<=3) return 1.05; // 鬮?驢搾??・?騾寂悪・?・??・?・?髯溷桁??・?髯???・?・?鬯?霈?・?
                if(d<=6) return 1.00; // 鬯?・?陞｢・??・?・??・?・?
                return 0.85;           // 1驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏???貊ゑ??・?陞｢・?遶???・?・??・?・?驛｢・?陟暮?会ｽ??門??惱・??・?・?隲帷???・?髮九?・?・?邵??
            }catch(_){ return 1.0; }
        }
        const mHalf = 69+12*Math.log2(Math.max(1e-9,half)/A4Frequency);
        const mBase = 69+12*Math.log2(Math.max(1e-9,base)/A4Frequency);
        const mDbl  = 69+12*Math.log2(Math.max(1e-9,dbl)/A4Frequency);
        // 鬯?・?陋滂ｽ?雎ｬ・?髯懈瑳・?蛟･?蝣?・?・??・?・?髣???闕ｵ譏ｴ窶?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?ｧ・・?・?郢晢??/2郢晢??陝ｲ・?遶剰ご??・??・?・?鬮?・??・?・?髯具???・?・?髯橸??陞｢・??・?螳・????・?驛｢・?遶丞｣??讌｢・?螢?・?・?陞ｳ蟶?・?・?陷会ｽ?・つ郢晢??f 驛｢・?陋幢???・?蜀暦??・?陞｢・?・ゑｽ?驍ｵ・??・?・?髯???・?・?鬯?霈?・?
        if(mBase>=80){ // 驍ｵ・??・?・?驍ｵ・?郢晢??隨??驍ｵ・?郢晢??G#5 髣比ｼ夲??・?髣???郢晢??
            wHalf *= 0.85; // 驛｢・?陋ｹ・??・?鬘伜?闕?譎｢・?螳壽╂隰費???・?鬘費??・??・?・?驍ｵ・?闕ｳ螂???・?
            wDbl  *= 1.05;
        }

        let rHalf = sHalf * wHalf * (trend<0? 1.04:1.00) * contMul(mHalf); // 髣???驕擾??陷・髯具???・?・?髯?・?闔会ｽ?邵?蝣?・?・??・?・?髯?莨∝ｮ?郢晢??髯句??・?・?驛｢・?髮区??・?・??・?・?髯???・?・?鬯?霈?・?
        let rBase = sBase * wBase * contMul(mBase);
        let rDbl  = sDbl  * wDbl  * (trend>0? trendBoost:1.00) * contMul(mDbl); // 髣???鬯・???・?髯具???・?・?髯?・?闔会ｽ?邵?蝣?・?・??・?・?2f髯句??・?・?驛｢・?髮区??・?・??・?・?髯???・?・?鬯?霈?・?

        let pick=base, bestS=sBase, bestRW=rBase;
        if(half>30 && rHalf>bestRW){ pick=half; bestS=sHalf; bestRW=rHalf; }
        if(rDbl>bestRW){ pick=dbl; bestS=sDbl; bestRW=rDbl; }
        // 驛｢譎?・?邵?蟶?・?譏ｴ?・?・取㏍・?・??・?・?驛｢・??・?・?: 髣???鬯・???・?髯具???・?・?髯?・?闔会ｽ?邵?? pick 驍ｵ・?郢晢??half 驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驛｢・?郢??・つ遶乗亢?鈴劑???・?・?驍ｵ・??・?・?驛｢・?隰梧汚??・?鬮?竏?・?郢晢??郢晢??ase/dbl郢晢??陝ｲ・??・?螳壽・・?・?髯?蛹??・?
        if(trend>0 && pick===half){
            const alt = Math.max(rBase, rDbl);
            if(rHalf < alt * 1.12){ // 12%髣比ｼ夲??・?髯??郢晢??郢晢??髯?蛛ｵ?・??・?・??・?・?驍ｵ・??・?・?驛｢・?髯具???・?・?陋滂ｽ??・?讚?????・?・?驍ｵ・??・?・?
                if(rDbl>=rBase){ pick=dbl; bestS=sDbl; bestRW=rDbl; }
                else { pick=base; bestS=sBase; bestRW=rBase; }
            }
        }
        // SHS驍ｵ・??・?・?鬨?・??・?・?髯・?・?・?髯???・?・?髣???鬮?・??・?? confidence 驍ｵ・??・?・?髯?・?髢?・?闕ｳ闊?・?髢?・?陷・??驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驍ｵ・??・?・?髮手ご・?????・?郢晢???・?・?郢晢??
        const second = (pick===base)? Math.max(sHalf, sDbl) : (pick===half? Math.max(sBase, sDbl): Math.max(sBase, sHalf));
        const shsRel = bestS>0? Math.min(1, bestS / Math.max(1e-9, second*1.05)) : 0; // 1.05驍ｵ・??・?・?驛｢・?闕ｳ蟯???驍ｵ・?闕ｵ譏ｶ?鬥??蜍淞・??・??
        conf = Math.max(0, Math.min(1, 0.65*bestR + 0.35*shsRel));
        freq = pick;
    }
    if(freq<=0){ if(_forceGlobalSearch<=0 && lastMicFreq>0) freq=lastMicFreq; }
    if(freq>0){
        // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??髢?・??・?・??・?・?髯?讎贋ｾ・・?・??・?・?髯懶??郢晢??+ 驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢・??・?・?驛｢譎｢・?・? + 驛｢譏ｴ?・?郢晢??驛｢譎擾??・?邵??驛｢譎｢・?・?驛｢譎｢・?・? + 髫????髯樊ｻゑｽ?・?髯樊ｺ?逕･陜滂ｽ?髯具???・?・?鬯?・?隰?・??・?・?郢晢??
        pitchSmoothBuf.push(freq); if(pitchSmoothBuf.length>PITCH_SMOOTH_WINDOW) pitchSmoothBuf.shift();
        const avg = pitchSmoothBuf.reduce((a,b)=>a+b,0)/pitchSmoothBuf.length;
        const med = [...pitchSmoothBuf].sort((a,b)=>a-b)[Math.floor(pitchSmoothBuf.length/2)];
        // 髯晢???・?・?髯懶??郢晢??遶???・?譎｢・?・?驛｢譏ｴ?・?邵??驛｢・??・?・?驛｢譎｢・?・?驛｢・?陋幢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏???螟ｲ・?・?陋ｹ・?・取ｺ?・?譎?蠕娯雷驛｢譏???・?陜滂ｽ?郢晢??郢晢??
        const fused = 0.6*med + 0.4*avg;
        // 髣????・?・?鬯???・?・?髯溯??・?・?驍ｵ・??・?・?髯滂ｽ?隲帷腸・?驍ｵ・??・?・?驛｢譏ｴ?・?郢晢??驛｢譎擾??・?邵??驛｢譎｢・?・?驛｢譎｢・?・?/髫????髯樊ｻゑｽ?・?髯樊ｺ?逕･陜滂ｽ?鬯?・?闕ｳ螂???蟶?・?・?・?髯?閧??螂???・??・?・?髫?・??・?・?
        function lerp(a,b,t){ return a + (b-a)*Math.max(0,Math.min(1,t)); }
    const DEAD_CENTS = lerp(10, 3, conf);           // 髣???隲?・??・?・??・?・?鬯???・?・?驕ｶ鬘假??讖ｸ・?・?郢晢???・?讓抵??譏ｴ?・?郢晢??驛｢譎擾??・?邵??驛｢譎｢・?・?驛｢譎｢・?・?, 鬯?・?陋??・?・??・?・?鬯???・?・?驕ｶ髮・・?陟托??驍ｵ・?郢晢??
    let   MAX_STEP_CENTS = lerp(15, 45, conf);      // 髣???隲?・??・?・??・?・?鬯???・?・?驕ｶ鬘假??讖ｸ・?・?闕ｳ螂????驍ｵ・?郢晢?? 鬯?・?陋??・?・??・?・?鬯???・?・?驕ｶ鬘假??讖ｸ・?・??・?・?驍ｵ・?鬮?・??・?・?郢晢??鬩・?・?・??・?・?髯溷?鍋袖?つ?・?・?UP郢晢??郢晢??
        const cents = (lastMicFreq>0)? 1200*Math.log2(fused/lastMicFreq) : 0;
        let smoothed = (lastMicFreq>0 && Math.abs(cents)<DEAD_CENTS)? lastMicFreq : fused;
        // 1驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?髫????髯樊ｻゑｽ?・?髯樊ｺ?逕･陜滂ｽ?鬯?・?隰?・??・?・?陋ｹ・?邵?譎会ｽ?譎｢・?・?驛｢譎???譁石倬Δ???・?・?郢晢??郢晢??
        if(lastMicFreq>0){
            // 鬯?・?陋??・?・??・?・?鬯???・?・?驍ｵ・?闕ｵ譏ｶ蜻?髫?・??・?・?髮趣??・つ驍ｵ・??・?・?髯樊ｺ?逕･陜滂ｽ?郢晢??郢晢?? 髯?雍???竏ｵ・?・?郢晢??陝ｲ・??・?螳夲???隲幢??郢晢??驍ｵ・?陷会ｽ?隨??驛｢・?隰梧汚??・?・つ髫?蠑ｱ・芽搦・?驍ｵ・??・?・?驍ｵ・?髴???・?閾?・?・??・?・?髣???闔ｨ竏晏?憺Δ??陜｣・??・?・??・?・?驛｢・?遶丞｣??・?髯?・?隰費???・?莨・??・?郢晢???・??驛｢・?陝ｶ譏?????・?・?郢晢??
            const absC = Math.abs(cents);
            if(conf>0.7 && absC>100){
                // 髫????髯樊ｻゑｽ?・?驍ｵ・??・?・??・?繧托ｽ?・?2髯?雍???竏ｵ・?・?驍ｵ・??・?・?驍ｵ・??・?・?髯?螂???・?髫?蠑ｱ・・・?・??・?・?髯滓?萓ｭ?・?蟶晏搦?・?・?髯橸???・?・?
                MAX_STEP_CENTS = Math.max(MAX_STEP_CENTS, Math.min(200, absC*1.2));
            }
            const maxStep = lastMicFreq * Math.pow(2, MAX_STEP_CENTS/1200) - lastMicFreq;
            const diff = smoothed - lastMicFreq;
            if(Math.abs(diff) > Math.abs(maxStep)) smoothed = lastMicFreq + Math.sign(diff)*Math.abs(maxStep);
        }
        // 髯懈圜・?・?鬨?・?・つ髯具???・?・?髯橸??陞｢・?郢晢??髯?蜿?・?竏晄?らｹ晢??陜捺?捺?矩し??郢晢??郢晢??驛｢譏ｴ?・?邵?譎会ｽ?譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?鬮?????・?鬯?・?闕ｳ螂???螳壽・・?・?髯?驛∬??・?・?郢晢??
        // 驛｢譎｢・?・?驛｢・??・?・?驛｢譎樊束・つ?・?・?驍ｵ・??・?・?髫?蜴・??・?髫???・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎丞ｹ?邵?蜥擾??譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎?櫨驍???鬨?・?・つ郢晢??隰紋ｼ夲??・?6髯?雍???竏ｵ・?・?郢晢??郢晢??
        lastMicFreq = smoothed;
        let liveMidi = 69 + 12*Math.log2(Math.max(1e-9,lastMicFreq)/A4Frequency);
        // 驛｢・??・?・?驛｢・??・?・?驛｢譎?櫨驍???鬨?・?・つ郢晢??陋ｹ・?・朱豪・?譎｢・?・?驛｢譏ｴ?・?邵??驛｢譎擾??・?郢晢??驛｢譎?樟?冗｣?諱・圷・?騾寂悪・?・?髴域喚髮?驛｢・?驍?私??・?隲?肩・?・??・?・?郢晢??陝ｲ・?郢晢??髫?・??・?・?髯晏??・?
        lastMicMidi = liveMidi;
    // 鬮?・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?驛｢譎｢・?・?鬩搾???・?・?鬮?・?髢?・?騾?驢搾??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎槭??・?・??・?・?髯晢???・?・?驍ｵ・??・?・?驛｢譎??堤?晢??驛｢譏ｶ?螢?・?驛｢譎｢・?・?驛｢・??・?・?
    let dCentsForDot = null; // 驛｢・??・?・?驛｢・??・?・?驛｢譎擾??・?遶頑･?豎?・?・?驍ｵ・?陷?・??・?迢暦??・??・?・?驛｢譎｢・?・?驛｢譏???・??・?・?髯晢???・?・?郢晢??隰紋ｼ夲??・?600c髫?螢??・?驍画?抵??・??・?・?郢晢??郢晢??
    let pcForDot = null;     // 驛｢譎??堤?晢??驛｢譏ｶ?螢?・?驛｢譎｢・?・?驛｢・??・?・? 0..11郢晢??郢晢??=0郢晢??郢晢??
        try{
            // 驛｢・??・?・?驛｢・??・?・?驛｢譎擾??・?郢晢??驛｢譎｢・?・?驛｢譎?樟郢晢??髯?・?鬮???・?・?郢晢?? 1) 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢譎?樟?主??・?譏ｴ?・?邵?? 2) 鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎擾??・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?
            let nn=null;
            const tr=currentTracks[melodyTrackIndex];
            const t = ((typeof __vitTimeOverride==='number')? __vitTimeOverride: playbackPosition) - getPitchVisOffsetSec(); // 鬮?・?陋滂ｽ?????驛｢譎｢・?・?髣???隴取得??・?陋滂ｽ?遶????蛹・??・?驍ｵ・?郢晢???・?????蠑ｱ・・け??
            const T_TOL = 0.12; // 120ms 髣比ｼ夲??・?髯??郢晢??郢晢??髯?・?陟包???・?・?・つ驛｢譎擾??・?郢晢??驛｢譎?樟????・?・?陷会ｽ?遯?・?髫???・?・?驍ｵ・?郢晢???・?・?闔・?陟?鬮?證ｮ鞫?陜滂ｽ?驍ｵ・??・?・?驕ｯ・?隲幢??驍顔距??・??・?・?驍ｵ・??・?・?驍ｵ・?郢晢???・???????・?・?驍ｵ・?郢晢??・つ隴趣???・?・?郢晢??
            if(tr && tr.notes && tr.notes.length){
                // 驍ｵ・??・?・?驍ｵ・?陞｢・?郢晢??鬯?・?陞｢・??・?・??・?・?驍ｵ・??・?・?髯具??郢晢??隲?・?髫??隲・?・?・??・?・?
                nn = tr.notes.find(n=> t>=n.time && t<=n.time+n.duration);
                if(!nn){
                    // 髯?隨?・?螂???・?陟募?・・?髫????鬮?螟ｧ・?・??・?蜥?・?・?髮区??蠕宣辧蜍溷???・??驍ｵ・?遶擾??陷・??鬯?・?隶鯉ｽ??・?・??・?・?髯晢???・?・?驍ｵ・?驕停扱??句?・・?・?髯??郢晢??遶企?・?・?騾???隲?蜻?豎樒ｹ晢???・?鬘費??・?陷?蝓滂ｽ?・?鬨?蛹・??・?
                    let prev=null, next=null;
                    for(const n of tr.notes){ if(n.time<=t) prev=n; if(n.time>t){ next=n; break; } }
                    let best=null, bd=1e9;
                    if(prev){ const d=Math.min(Math.abs(t-prev.time), Math.abs((prev.time+prev.duration)-t)); if(d<bd){ bd=d; best=prev; } }
                    if(next){ const d=Math.min(Math.abs(t-next.time), Math.abs((next.time+next.duration)-t)); if(d<bd){ bd=d; best=next; } }
                    if(best && bd<=T_TOL) nn=best;
                    // 驍ｵ・?隴擾???・?讙趣??・??・?・?驛｢・?郢?螂???・?闕ｵ譏ｶ蜻?驍ｵ・?闕ｵ譎｢・?閾?・?・??・?・?驍ｵ・?闔会ｽ??・?讙趣??・??・?・?髫????髯溷供??蠕?・?驛｢譎擾??・?郢晢??驛｢譎???・?蝣?・?譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?
                    if(!nn) nn = next || tr.notes[tr.notes.length-1];
                }
            }
            if(!nn && Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                // 鬮?蜿?・?・??・?讚???蠑ｱ・玖?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??驛｢譎｢・?・?驛｢譎???・?螳夲??證ｦ・?・?鬨?蛹・??・?郢晢??隰紋ｼ夲??・?duration驍ｵ・??・?・?鬩???郢晢??陝ｲ?髯???・?・?髯???迴?・つ遶丞｣??驢搾??・?闔会ｽ??・?讙趣??・??・?・?髫????鬮?螟ｧ・?・??・?蜥?・?・?遶丞､?・??驛｢・?陝ｲ・?遶・120ms鬮?・??・?・?髯橸???・?・?郢晢??郢晢??
                let best=null, bd=1e9;
                for(const g of midiGhostNotes){
                    const dCenter = Math.abs(t - (g.time + (g.duration||0)/2));
                    const score = dCenter / Math.max(0.001, g.duration||0.4);
                    if(score < bd){ bd=score; best=g; }
                }
                if(best){
                    const dEdge = Math.min(Math.abs(t-best.time), Math.abs((best.time+(best.duration||0))-t));
                    if(dEdge<=T_TOL || (t>=best.time && t<=best.time+(best.duration||0))) nn = { midi: best.midi, time: best.time, duration: best.duration };
                }
            }
            if(!nn && isPracticing && Array.isArray(practiceExpectedNotes) && practiceExpectedNotes.length){
                // 驛｢譎｢・?・?驛｢・??・?・?驛｢譎???・趣??驛｢・??・?・?鬨?蛹・??・?髫?蟶?・?・??・?・?郢晢??郢晢??驛｢譎｢・?・?驛｢譎?樟?ゑｽ?驛｢・?騾???隲?蜥取≧陞滂ｽ??・?蜥?・?・?陷?蝓滂ｽ?・?鬨?蛹・??・?郢晢??髢?・??・?・??・?・?鬩怜雀?芽?撰??髴難???・?・?驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?郢晢??郢晢??
                let best=null, bd=1e9;
                for(const g of practiceExpectedNotes){
                    const mid = g.time + (g.duration||0)/2;
                    const d = Math.abs(t - mid);
                    if(d<bd){ bd=d; best=g; }
                }
                if(best){
                    const dEdge = Math.min(Math.abs(t-best.time), Math.abs((best.time+(best.duration||0))-t));
                    if(dEdge<=T_TOL || (t>=best.time && t<=best.time+(best.duration||0))) nn = { midi: best.midi, time: best.time, duration: best.duration };
                }
            }
            if(nn){
                    // nn.midi 驛｢・?髮区????謌????隰費??遶・ ?・?繧托ｽ?・?2驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎樊束・つ陷?・??・?・?隲帷腸・?驛｢・?郢晢??liveMidi 驍ｵ・??・?・?髫????驛｢・?郢?螂???・?闔会ｽ??・?讓抵??・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§?・?蟶晢??蛹・??・?驍ｵ・??・?・?
                    let best=nn.midi, bestD=1e9;
                    for(let k=-2;k<=2;k++){
                        const cand=nn.midi + 12*k;
                        const d=Math.abs(cand - liveMidi);
                        if(d<bestD){ bestD=d; best=cand; }
                    }
                    const fTar = midiToFreq(best);
                    let centErr = 1200*Math.log2(Math.max(1e-9,lastMicFreq)/Math.max(1e-9,fTar));
                    centErr = wrapToPm600(centErr);
                    dCentsForDot = centErr;
                    pcForDot = ((nn.midi%12)+12)%12;
                    // 鬩搾???・?・?鬮?・?陋ｹ・??・?螳夲??蜴・??・?髫???・?・?郢晢??陜捺?難??・?髴難???・?・?髣????・?・?驍ｵ・??・?・?驍ｵ・??・?・?郢晢??郢晢??
                    try{
                        if((isPlaying || isPracticing) && scoreStats && Number.isFinite(centErr)){
                            const bin = scoreStats.bins[pcForDot];
                            bin.count++;
                            scoreStats.total++;
                            bin.sum += centErr;
                            bin.sumAbs += Math.abs(centErr);
                            const tol = toleranceCents||0;
                            if(Math.abs(centErr) <= tol) bin.inTol++; else bin.outTol++;
                            const bias = 5; // 5c 髣比ｼ夲??・?髣???驗呻???・?蟶晢??・?陋??・?・?闕ｳ・?邵??髯?・?闔会ｽ?遶???・?・?陷会ｽ?遯?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?
                            if(centErr >= bias) bin.sharp++;
                            else if(centErr <= -bias) bin.flat++;
                        }
                    }catch(_){ }
            }
        }catch(_){ /* fall back to liveMidi */ }
        // 鬮?・??・?・?鬩肴得??・?鬩搾???・?・?鬮?・?髣鯉ｽ??・?・?騾趣??雎ｬ・?鬩墓ｩ?・?・??・??陷会ｽ?邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?ｧ・・?・?騾???陝ｲ・?髫???・?・?
        try{
            if((isPlaying || isPracticing) && dCentsForDot!=null && pcForDot!=null){
                const tol = toleranceCents||0; const ok = Math.abs(dCentsForDot) <= tol;
                const mForOct = (69 + 12*Math.log2(Math.max(1e-9,lastMicFreq)/A4Frequency));
                const oct = Math.floor(mForOct/12) - 1; const key = String(oct);
                if(!scoreDetailByOct[key]) scoreDetailByOct[key] = {};
                const cell = (scoreDetailByOct[key][pcForDot] ||= {in:0,out:0,count:0});
                cell.count++; if(ok) cell.in++; else cell.out++;
            }
        }catch(_){ }
        // 鬮?蜍?・??・?・?陞｢・?陜滂ｽ?鬯?霈?・??・?・??・?・?鬮?・?隲?肩・?・??・?・?: 髯・闔会ｽ??・??鬯?遨ゑｽ?・?隰碑歓螻・・?・?驍ｵ・??・?・?髫?蠑ｱ・・け??驛｢・?陋幢??隨・驛｢・?陝ｲ・??・??驍ｵ・??・?・?髣???隴取得??・?陋??・?・?陋ｹ・?邵?蟶?・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髣???陷?・??・?・??・?・?驍ｵ・??・?・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・?遶??夲???郢晢??遶擾??驛｢・?郢晢??隨・驍ｵ・?隰?・??・?・?郢晢??
        // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?§・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?髣????・?・?驍ｵ・??・?・?髫俶誓??・?髴難???・?・?驛｢・?陷?闌ｨ・?・?闕ｵ譎｢・??驍ｵ・??・?・?驍ｵ・?郢晢??
        if(!isCalibrating){
            const vOff = getPitchVisOffsetSec();
            const recTime = ((typeof __vitTimeOverride==='number')? __vitTimeOverride: playbackPosition) - vOff;
            if(!(lastMicFreq>0) || !Number.isFinite(lastMicFreq) || lastMicFreq>12000){
                __diagLog('live-push-invalid', {lastMicFreq, conf, recTime, vOff, A4:A4Frequency});
            }
            pitchHistory.push({ time: recTime, visOff: vOff, freq: lastMicFreq, conf, sid: scoreSessionId });
            if(pitchHistory.length>2000) pitchHistory.shift();
        }
    }
        if(!isPlaying) drawChart();
}
function zeroCrossFreq(buf,sr){
    let crossings=0; let lastSign=buf[0]>0; for(let i=1;i<buf.length;i++){ const s=buf[i]>0; if(s!==lastSign){ crossings++; lastSign=s; } }
    const freq = (crossings/2)*(sr/buf.length); return freq||-1;
}
function autoCorrelate(buf,sr){ const S=buf.length; let rms=0; for(let i=0;i<S;i++) rms+=buf[i]*buf[i]; rms=Math.sqrt(rms/S); if(rms<0.01) return -1; const end=S/2; let best=0,bestV=0; for(let lag=20;lag<end;lag++){ let sum=0; for(let i=0;i<end;i++) sum+=buf[i]*buf[i+lag]; if(sum>bestV){ bestV=sum; best=lag; } } return best? sr/best:-1; }
// 驛｢・??・?・?驛｢譎｢・?・?驛｢譏???・??・?・??・?・?驛｢・?郢晢???・?繧托ｽ?・?600c 驍ｵ・??・?・?髫?螢??・??・?莨・・??・?・?驛｢・?・つ郢晢??陜捺?督蜥取≧陞滂ｽ??・?蜥?・?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§遶丞現?・?郢晢??
function wrapToPm600(cents){
    const x = ((cents + 600) % 1200 + 1200) % 1200 - 600;
    return x;
}
// ---- Draw ----
function loop(){
    updatePlaybackPositionHybrid();
    const now = performance.now();
    const dt = now - _lastFrameTime; _lastFrameTime = now; _frameAccum += dt; _frameCnt++;
    // ===== Drift (Audio vs Perf) 鬮?・?陜捺?ゑｽ?・??・?・? =====
    // audioCtx.currentTime 驍ｵ・??・?・? performance.now 驛｢譎??郢晢??驛｢・??・?・?驍ｵ・??・?・? play 鬯?・??・?・?鬮?・?隰疲?ゑｽ?・??・?・?髯具??郢晢???・?蟶昴??陷?謫?・?・?陞溘?鬟ｭ驍ｵ・??・?・?鬮?・?陋滂ｽ?????驍ｵ・?陷会ｽ?・つ郢晢??
    // 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・?陞｢・??・?迹壽・雋???陞ｻ荳・・?陜捺??・?蟶敖蛹・??・?or驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?or驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢・??・?・?鬯?霈?・??・?・??・?・?郢晢??陝ｲ・?郢晢??髯具??郢晢???・?鬘伜ｴ慕ｹ晢???・??髯憺屮・?・?鬩慕甥・?・?郢晢??驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?驍ｵ・?陷?・??・?迢暦??・?郢晢??
    if(audioCtx && isPlaying){
        try{
            const nowPerfSec = now/1000;
            const ctxDt = Math.max(0, audioCtx.currentTime - playbackStartTime);
            const perfDt = Math.max(0, nowPerfSec - playbackStartPerf);
            const driftMs = (perfDt - ctxDt)*1000; // 髮・?・?・?: perf 驍ｵ・??・?・?髫???・?・?驍ｵ・?隰疲?・・?鬮?・?郢晢??
            if(!window.__driftStats){
                window.__driftStats = { samples:0, avg:0, max:0, last:0, updated:0 };
            }
            const ds = window.__driftStats;
            ds.samples++;
            // online average
            ds.avg += (driftMs - ds.avg)/ds.samples;
            if(Math.abs(driftMs) > Math.abs(ds.max)) ds.max = driftMs;
            ds.last = driftMs;
            if(!ds.updated || (now - ds.updated) > 500){
                // 500ms 髮惹??・?・?遶企豪・?・??・?・?驛｢譎｢・?・?驛｢譎?蠕?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?髯?・?髢?・?闕ｳ?
                const el = document.getElementById('driftOverlay');
                if(el){
                    el.textContent = `Drift(avg:${ds.avg.toFixed(1)}ms max:${ds.max.toFixed(1)}ms last:${ds.last.toFixed(1)}ms mode:${FORCE_PERF_CLOCK?'PERF':'AUTO'} state:${_driftForceState}`;
                }
                ds.updated = now;
            }
            // ==== 髯滓汚??・?髯具???・?・?髯具???・?・?髯橸??郢晢??(1s 驍ｵ・??・?・? 1 髯?軸・?謚ｵ・?・?陷?・??・?・??・?・?) ====
            if(now - _lastDriftDecisionAt > 1000){
                _lastDriftDecisionAt = now;
                if(FORCE_PERF_CLOCK){
                    // 鬮?證ｦ・?・?鬯?・??・?・?髯具???・?・?髯橸??郢晢?? 髯晢???・?・?髯懶??郢晢??遯?・?驛｢譎?・?邵?蟶?・?譏ｴ?・?・取㏍・?・??・?・?驛｢・??・?・?鬯?・??・?・?髯区?ゑｽ?・?驛｢・?髮区??・?蜻??慕ｹ晢???・?・?陷?・?陞ｻ骰具??・?郢晢??
                    if(ds.samples>DRIFT_FORCE_SAMPLES && Math.abs(ds.avg) < DRIFT_FORCE_HYST_MS){
                        FORCE_PERF_CLOCK=false; _driftForceState='idle';
                        try{ console.warn('[drift] FORCE_PERF_CLOCK OFF (avg', ds.avg.toFixed(1),'ms)'); }catch(_){ }
                    } else {
                        _driftForceState='forcing';
                    }
                } else {
                    if(ds.samples>DRIFT_FORCE_SAMPLES && Math.abs(ds.avg) > DRIFT_FORCE_AVG_MS){
                        // 髣???・つ髯溯??・?・? armed 驛｢・?陷?蝓滂ｽ?諛???・?髦?蜷??蝣?・?譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?髫?・??・?・?髯区?ゑｽ?・?驍ｵ・?霑ｹ螟ｲ・?・??・?・?驍ｵ・??・?・?驛｢・?陋ｹ・?陷・??鬯?・?髦?蜻?・?螳壼初陟托ｽ?遶擾??驛｢・?郢晢??
                        if(_driftForceState!=='armed'){
                            _driftForceState='armed';
                        } else {
                            FORCE_PERF_CLOCK=true; _driftForceState='forcing';
                            try{ console.warn('[drift] FORCE_PERF_CLOCK ON (avg', ds.avg.toFixed(1),'ms)'); }catch(_){ }
                        }
                    } else {
                        _driftForceState='idle';
                    }
                }
            }
        }catch(_){ }
    }
    let doDraw = true;
    if(IS_MOBILE){
        // 60fps 鬩????・?・?髫?蟷?・?・?驍ｵ・??・?・?髴取ｻゑｽ?・?鬯?・?郢晢??遶???・?・?雋?∞??讓抵??譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?驛｢・?陝ｶ譏???・?髯??鯉ｽ?謚ｫ?・? ( ~28-40fps 鬨?・??・?・?髯橸??郢晢??)
        // 驛｢・?闕ｳ蟯???驍ｵ・?闕ｵ譏ｶ?鬥?・?・??・?・?髯区?ゑｽ?・?驛｢・?陷・?・?・?驗呻???・?・?驍ｵ・??・?・?髫??陷諤懈?鬯???・?・?髯溯??・?・?驛｢・?陷?蝓滂ｽ?蟷・?・・?・?驍ｵ・?陷会ｽ?・つ遶丞｣?窶?驛｢・??・?・?驍ｵ・??・?・?驍ｵ・?鬮?・??・?螳壽割陷?蜴・??・?郢晢??
        if(dt < 14){ doDraw = false; }
    }
    if(doDraw){
        drawChart();
        if(IS_MOBILE){
            _frameSkipToggle = !_frameSkipToggle;
            if(!_frameSkipToggle){ setSelectionByPlayhead(); }
        } else {
            setSelectionByPlayhead();
        }
    }
    if(now - _lastPerfLog > 2000){
        try{ const avg = (_frameAccum/_frameCnt).toFixed(1); console.debug('[perf] avgFrame(ms)=',avg,' pos=',playbackPosition.toFixed(3)); }catch(_){ }
        _frameAccum=0; _frameCnt=0; _lastPerfLog=now;
    }
    if(isPlaying) requestAnimationFrame(loop);
}
// LRU 髯橸??陞｢・?隰・驛｢譏ｶ?螢?笙るΔ譏ｴ?・?邵?? (髯??陷?・?陷・??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎樊味?・?・?郢晢??髯・)
setInterval(()=>{ maybeRunLru(); },5000);
// 鬯?蛹・??・?髫?螢?・?蜻・・?髫?・?闕ｵ譏ｶ?蝣?・?譎?・?郢晢??驛｢譎?樟郢晢??驛｢・??・?・?驛｢譎??騾?驢搾??譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?
let noteRectsGlobal=[]; // fallback in case earlier declaration fails
function drawChart(){
    if(!chartCanvas||!ctx) return;
    // 髣比ｼ夲??・?髯?莉｣?・? 髮惹??・?・?郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・? canvas.width/height 驛｢・?髮区???・?鬮?・??・?・?髯橸??郢晢??驕ｶ鄙ｫ?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏???・?郢晢??鬮?・?髢?・??・?・?陷会ｽ?邵?蝣?・?・??・?・?驛｢・??・?・?驍ｵ・??・?・?驍ｵ・?隶朱?托ｽ?・?髯懈圜・?・?
    let w=chartCanvas.width; let h=chartCanvas.height;
    if(!w || !h){
        // 髯具??隴惹?橸??骰具??譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎?樟??・?髫?蟷?・?・?鬩墓?・?・?髯橸??陞｢・?邵?? 0 驍ｵ・??・?・?驍ｵ・??・?・?驛｢・?陷?・??・?・??・?・?髯?・?陋ｹ・?郢晢??驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?
        try{ resizeCanvas(); }catch(_){ }
        // 驍ｵ・??・?・?驍ｵ・??・?・? 0 驍ｵ・??・?・?髯懶???・?・?髯?・?陋ｹ・?郢晢??髯橸??隶鍋???・?・?驍ｵ・??・?・?驍ｵ・?陷会ｽ?遯?・?髯滓汚??・?髯具???・?・?鬮?・??・?・?髯橸??陞滂ｽ??・?・?陋ｹ・?・取ｺ?・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髯樊ｺ?蛻?霎溷?ゑｽ?・??・?・?驍ｵ・?闔会ｽ?邵?蝣?・?・??・?・?髫??陷諤懈?驛｢譎?蠕湖暮Δ譎???譁撰?憺し??隶吩???・?髫?迹・?会ｽ??驛｢・?陟募???驢搾??・?郢晢???・?・?郢晢??
        w = chartCanvas.width; h = chartCanvas.height;
        if(!w){
            const vw = Math.max(0, window.innerWidth||document.documentElement.clientWidth||0);
            const fallbackW = Math.max(320, Math.floor(vw*0.6)||0, 640);
            w = fallbackW;
            chartCanvas.width = w;
            chartCanvas.style.width = w + 'px';
        }
        if(!h){
            let ph = 0;
            try{ const p = chartCanvas.parentElement; ph = p? Math.floor(p.clientHeight || p.getBoundingClientRect().height || 0) : 0; }catch(_){ ph=0; }
            const fallbackH = ph>0? ph: 360;
            h = fallbackH;
            chartCanvas.height = h;
            chartCanvas.style.height = h + 'px';
        }
    }
    ctx.clearRect(0,0,w,h);
    // 髯?・??・?・?鬮?證ｮ鞫?陜滂ｽ?鬯?霈?・??・?・??・?・?鬮?・?隲?肩・?・??・?・?驍ｵ・??・?・?髴托ｽ??・?・?髯懶???・?・?髯区?ゑｽ?・?郢晢??闔蛹・??・?隴取得??・?闖ｫ・?陷・??驍ｵ・??・?・?驍ｵ・??・?・?髯晢???・?・?髯具??郢晢??邵?螳壽呵搏??郢晢??鬩励???・?郢晢??郢晢??
    const curOff = getPitchVisOffsetSec();
    const total=verticalZoom*12; const min=36; const maxDisplay=132; const vmin=min+Math.round((maxDisplay-min-total)*(verticalOffset/100)); const vmax=vmin+total; const pxSemi=h/total; const playX=getPlayX(w); const eff=playbackPosition+timelineOffsetSec;
    // 鬮?・?隴?・?陷搾??驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??郢晢??髢?・?陷環鬯?・??・?・?=鬨?蜈ｷ・?・?驍ｵ・?郢晢???・?・?陝ｶ譎擾??・?=驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?郢晢??郢晢??
    for(let m=vmin;m<=vmax;m++){
        const y=h-(m-vmin+1)*pxSemi;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(w,y);
        const pc = ((m%12)+12)%12;
        const isC = pc===0; // C驍ｵ・??・?・?髯樊ｻゑｽ?・?驛｢・?遶丞｣??・?鬨?・??・?・?髯?螂???・?驛｢・?陜｣・??・?・??・?・?髫?謔ｶ?・?
        const isNatural = (pc===0||pc===2||pc===4||pc===5||pc===7||pc===9||pc===11);
        // C鬮?・?陟募?・・?驛｢・?陋ｹ・??・?莨・蜈ｷ・?・?驍ｵ・?闕ｳ迺??遶丞｣?關ｽ驛｢・?陟包???・?・??・?・?髯樊ｻ薙§郢晢??鬨?蜈ｷ・?・?鬯?・??・?・?/鬲・??・?譎擾??・?驍ｵ・??・?・?髮趣??郢晢???・?・??・?・?
        ctx.strokeStyle = isC ? '#ffffff' : (isNatural ? '#8c8c8c' : '#3a3a3a');
        ctx.lineWidth = isC ? 2 : 1;
        ctx.stroke();
    }
    // 髯?・??・?・?鬮?蜍滂ｽ?諛ｶ・?・?闔ｨ諛茨??・?髫?蠑ｱ・玖?・?鬩???郢晢??陝ｲ?郢晢??闔蛹・??・?陷?荳樣?・ 2鬩穂ｿ?諷??・?・?郢晢?? x = playX + ((t-eff)*pxPerSec/tempoFactor) 驛｢・?髮区????螟?・・?・?
    const visMarginSec = 2.0;
    const visStart=eff - (playX/pxPerSec)*tempoFactor - visMarginSec;
    const visEnd  =eff + ((w-playX)/pxPerSec)*tempoFactor + visMarginSec;

    // 髣皮判縺倡?晢??驛｢譎｢・?・?驛｢譎?樟郢晢??驛｢譎擾??・?郢晢??驛｢譏ｴ?・??・?螳夲??證ｦ・?・?驍ｵ・?陋ｹ・??・?竏ｫ・?・??・?・?髣???陷?・??・?・??・?・?驍ｵ・??・?・?髫??陷諤懈?郢晢??髢?・?隶捺??闊?・?・?驛｢譏???・?郢晢??驛｢譏???蛹・??・??・?・?髯樊ｻ薙§邵?? showNotes=true郢晢??郢晢??
    try{
        if(Array.isArray(melodyParts) && !isPitchOnlyMode){
            for(let i=0;i<melodyParts.length;i++){
                if(i===currentMelodyPart) continue;
                const p = melodyParts[i];
                if(!p || !p.showNotes) continue;
                const notes = Array.isArray(p.notes)? p.notes: [];
                if(!notes.length) continue;
                ctx.save();
                ctx.lineWidth = Math.max(1, Math.floor(guideLineWidth*0.6));
                // 髮趣???・?・?驍ｵ・?郢晢??霑夲??驍ｵ・??・?・?鬮?・?隴?・?陷搾??驍ｵ・??・?・?
                ctx.strokeStyle = 'rgba(180, 190, 210, 0.45)';
                for(const n of notes){
                    if(!n) continue;
                    if(n.time>visEnd) break;
                    if(n.time+n.duration<visStart) continue;
                    const x1=playX+(n.time-eff)*pxPerSec/tempoFactor;
                    const x2=playX+((n.time+n.duration)-eff)*pxPerSec/tempoFactor;
                    if(x2<0||x1>w) continue;
                    const y=h-(n.midi-vmin+1)*pxSemi;
                    ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y); ctx.stroke();
                }
                ctx.restore();
            }
        }
    }catch(_){ }

    // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢譎擾??・?郢晢??驛｢譎∬??・?・?陋ｹ・?・主??・?・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?遶擾??隴?・?髴取ｻゑｽ?・?驍ｵ・?隴会ｽ??・?・?郢晢??+ 鬯?蛹・??・?髫?螢?・?・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎∬??・?・?騾趣??遶城メ・?螢?・?・?郢晢??驛｢譎｢・?・?驛｢譎???・?螳壽≧陜難??隰??驍ｵ・??・?・?髫??陷諤懈?郢晢??郢晢??
    // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?§・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?髣????・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??鬮?・??・?・?鬩穂ｼ夲??・?驛｢・?陷?蝓滂ｽ?蟷・????・?・?郢晢??陋ｹ・?邵?荵滂ｽ?譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??驍ｵ・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?郢晢??郢晢??
    if(!isCalibrating && currentTracks[melodyTrackIndex] && !isPitchOnlyMode){
        ctx.lineWidth=guideLineWidth; ctx.strokeStyle='#4e8cff';
        const notes=currentTracks[melodyTrackIndex].notes;
    
        noteRectsGlobal.length=0;
        const t = playbackPosition;
        let playheadIdx = -1;
        for(let i=0;i<notes.length;i++){
            const n=notes[i];
            if(n.time<=t && t<=n.time+n.duration){ playheadIdx = i; break; }
        }
        for(let i=0;i<notes.length;i++){
            const n=notes[i];
            if(n.time>visEnd) break;
            if(n.time+n.duration<visStart) continue;
            const x1=playX+(n.time-eff)*pxPerSec/tempoFactor;
            const x2=playX+((n.time+n.duration)-eff)*pxPerSec/tempoFactor;
            if(x2<0||x1>w) continue;
            const y=h-(n.midi-vmin+1)*pxSemi;
            const sel=window._selection||{type:'none'};
            const isSingleSel = (sel.type==='single' && sel.index!=null && notes[sel.index]===n);
            const isRangeSel  = (sel.type==='range' && sel.startSec!=null && sel.endSec!=null && !(n.time>sel.endSec || (n.time+n.duration)<sel.startSec));
            if(isSingleSel){
                // 髯?髮・??・?・?・つ鬯?蛹・??・?髫?螢?・?・?郢晢??驍ｵ・??・?・?鬲・?・・?霑夲??驍ｵ・??・?・?髯滓汚??・?鬮?・??・?・?
                ctx.save();
                ctx.fillStyle='rgba(255,255,80,0.38)';
                const barH = Math.min(12, pxSemi*1.0);
                ctx.fillRect(x1, y-barH/2, x2-x1, barH);
                ctx.strokeStyle='#ffe600'; ctx.lineWidth=Math.max(guideLineWidth,3.2);
                ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y); ctx.stroke();
                ctx.restore();
            } else if(isRangeSel){
                // 鬩???郢晢??陝ｲ?鬯?蛹・??・?髫?螢?・?・?郢晢??鬲・?・・?霑夲??驛｢・?陝ｶ譏ｶ闌?し??闔会ｽ?・つ遶擾??髢?讙趣??・?陋ｹ・??・?竏ｫ・?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?鬩堺?夲??・?驍ｵ・??・?・?髯?・??・?・?鬮?證ｮ鞫?陜滂ｽ?
                ctx.save();
                ctx.fillStyle='rgba(120, 220, 255, 0.18)';
                const barH = Math.min(10, pxSemi*0.9);
                ctx.fillRect(x1, y-barH/2, x2-x1, barH);
                ctx.strokeStyle='#6fe0ff'; ctx.lineWidth=Math.max(guideLineWidth,2.0);
                ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y); ctx.stroke();
                ctx.restore();
            } else {
                ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y); ctx.stroke();
            }
            // 鬮?・??・?・?髯橸???・?・?鬩???郢晢??陝ｲ?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?郢晢??髢?・?陷環驍ｵ・?郢晢???・?・?雋????・?・?陞滂ｽ??・?・?郢晢?? toleranceCents 驛｢・?髮区?????鬯?・??・?・?髫??陝ｶ・??・?・?陷会ｽ??・??驍ｵ・??・?・?髣???髮榊?・?・?闕ｵ譏ｶ?讌｢・??陷諤懈?
            const dy = (toleranceCents/100) * pxSemi; // cents -> semitone -> px
            if(dy>0.2){
                ctx.save();
                ctx.lineWidth = 1;
                ctx.strokeStyle = '#ffffff';
                // 髣???鬮?竏?・?
                ctx.beginPath(); ctx.moveTo(x1, y - dy); ctx.lineTo(x2, y - dy); ctx.stroke();
                // 髣???陷?・?郢晢??
                ctx.beginPath(); ctx.moveTo(x1, y + dy); ctx.lineTo(x2, y + dy); ctx.stroke();
                ctx.restore();
            }
            noteRectsGlobal.push({x1,x2,y,idx:notes.indexOf(n)});
            if(showNoteNames){ ctx.font='10px sans-serif'; ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='middle'; const lab=noteLabel(n.midi); ctx.fillText(lab,(x1+x2)/2,y-8); }
        }
    }
    // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?鬩搾???・?・?鬩怜生?・?驍ｵ・?闕ｵ譎｢・???・?蠑ｱ・・け??t驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?MIDI驛｢・?髮区??蠕宣辧?灘惧?・?・?郢晢??esp髯???・?・?髯?驛∬??・?・?郢晢??
    function ghostMidiAt(t){
        try{
            if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                // resp髯???・?・?髯???迴?邵?螳壼初?つ鬮?・??・?・?驍ｵ・?陷?・??・?迢暦??・?郢??郢晢??驛｢・?陷?閧?邊?し??郢晢??
                let cand=null;
                for(const n of midiGhostNotes){
                    if(n && (n.role==='resp') && t>=n.time && t<=n.time+n.duration){ cand=n; break; }
                }
                if(!cand){
                    for(const n of midiGhostNotes){
                        if(n && t>=n.time && t<=n.time+n.duration){ cand=n; break; }
                    }
                }
                if(cand) return cand.midi|0;
            }
        }catch(_){ }
        return null;
    }
    // 髫?謔ｶ?・??・?・?陞｢・?陷・??髯具???・?・?驍ｵ・?陟募?鯉ｼ・Δ譎｢・?・?驛｢譎｢・?・?郢晢??陋ｹ・?邵??驛｢譎丞ｹ?・取㊥・?閧?・??会ｽ?・?隰?・??・?・?霑壼衷遘???・?髦?蜊搾??驍ｵ・??・?・?驍ｵ・?郢晢??・ゑｽ?
    function isCallAt(t){
        try{
            if(!isPracticing) return false;
            if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                for(const n of midiGhostNotes){
                    if(n && n.role==='call' && t>=n.time && t<=n.time+n.duration){ return true; }
                }
            }
        }catch(_){ }
        return false;
    }
    // 髯??陷?・?陷・??鬩搾??陞｢・??・?・?驗呻??郢晢??驛｢・??・?・?驛｢・??・?・?驛｢譎会ｽ?・?IDI郢晢??騾趣??雎ｬ・?鬩墓ｨ費??譁溽坩・?譎｢・?・?驛｢譎擾??・?邵?蝣?・?・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?髯具??陷???・?・?郢晢??
    let guideMidiAtPlayhead = null;
    if(!isPitchOnlyMode){
        try{
            const tr=currentTracks[melodyTrackIndex];
            const tRef = playbackPosition - getPitchVisOffsetSec();
            if(tr&&tr.notes&&tr.notes.length){
                const nn=tr.notes.find(n=> tRef>=n.time && tRef<=n.time+n.duration) || tr.notes.find(n=> n.time>tRef) || tr.notes[tr.notes.length-1];
                if(nn) guideMidiAtPlayhead = nn.midi|0;
            } else {
                // 驛｢譎?樟?主??・?譏ｴ?・?邵?驢搾??・?隶吝ｯ???驍ｵ・?郢晢???・?・??・?・?髯?・?陋ｹ・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟?ゑｽ?驛｢・?郢晢??
                const gM = ghostMidiAt(tRef);
                if(gM!=null) guideMidiAtPlayhead = gM;
            }
        }catch(_){ }
    }
    // 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏???蛹・??・??・?・?驍ｵ・??・?・?鬮?遨ゑｽ?譎｢・??驍ｵ・?陷?・??・?讚???・?陜｣・??・?・?陞滂ｽ??・?・?闔・??・?・?隴?・??・?・??・?・?驍ｵ・??・?・?鬯?・?鬮?・?郢晢??髫??闕ｳ蟯??・?驍ｵ・?陷?・??・?迢暦??・?雋?∞??竏ｫ・?・?遶丞､?・??驍ｵ・?髦?蜷??蝣?・?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎???・?蟶晢?りｫ?諛?・?郢晢??郢晢??
    let _assistSegments = null;
    if(isAssistActive()){
    const LAG_MS = Math.round((getPitchVisOffsetSec())*1000);
        const lag = LAG_MS/1000;
        const effStart = eff - (playX/pxPerSec)*tempoFactor - 1;
        const effEnd   = eff + ((w-playX)/pxPerSec)*tempoFactor + 1;
        const drawUntil = (playbackPosition - lag);
        const pts=[];
        for(const p of pitchHistory){
            const t = p.time + ((p.visOff!=null)? (p.visOff - curOff) : 0);
            if(!(t>=effStart && t<=effEnd)) continue; if(t>drawUntil) continue;
            if(typeof p.conf==='number' && p.conf < PITCH_CONF_MIN) continue;
            if(isCallAt(t)) continue;
            pts.push({t});
        }
        pts.sort((a,b)=>a.t-b.t);
        if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
            const TOL = 0.15; // 150ms
            const segs=[];
            for(const p of pts){
                let best=null, bd=1e9;
                for(const g of midiGhostNotes){ const c=g.time+(g.duration||0)/2; const d=Math.abs(p.t - c); if(d<bd){ bd=d; best=g; } }
                if(!best) continue;
                const dEdge = Math.min(Math.abs(p.t-best.time), Math.abs((best.time+(best.duration||0))-p.t));
                if(Math.min(bd, dEdge) > TOL) continue;
                const y = h - (best.midi - vmin + 1) * pxSemi - 3; // -3px 髣???驗呻??遶企豪・?・?陞｢・??・?閾?・?・?陷会ｽ?遯?・?鬯?・?鬮?・?遶企?・?・?驗呻???・?蟶晢??蛹・??・?驍ｵ・?闔会ｽ??・??
                const x1 = playX + ((p.t - 0.06 - eff) * pxPerSec / tempoFactor);
                const x2 = playX + ((p.t + 0.06 - eff) * pxPerSec / tempoFactor);
                if(x2<0 || x1>w) continue;
                segs.push({x1,x2,y});
            }
            if(segs.length) _assistSegments = segs;
        }
    }

    // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?§・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?髣????・?・?驍ｵ・??・?・?鬯?・?隶・?・?・??・?・?鬩穂ｼ夲??・?
    // 鬮?????・?髯?莨夲??・?髣皮甥・?髮?・?・?陋??・?・?髢?・??・?・??・?・?髯?・?鬲・?夲??・?郢晢?? 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・?髯句??繩??・?・??・?・?髣????・?・?驍ｵ・??・?・?驛｢・?郢?迚呻??・?鬮?蜿?・?・?遶頑･?・?蟶?逕･?・?・??・?・?鬯?・??・?・?髯橸???・?・?髮・?・?・?驍ｵ・?陟募??譌ｺ驛｢・?陟募?・・?髫??陷諤懈?驛｢・?陞ｳ螟ｲ・?・??・?・?髯?・??・?・?
    let allowDrawPitch = (isPitchOnlyMode || isPlaying);
    // 髯句??繩??・?・??・?・?髣????・?・?驍ｵ・??・?・?驛｢・?郢?迚呻??・?鬮?蜿?・?・?遶頑･?・?蟶?逕･隴?・・?・??・?・?髯橸???・?・?髮・?・?・?驍ｵ・?陟募??譌ｺ驛｢・?陟募?・・?髫??陷諤懈?驛｢・?陞ｳ螟ｲ・?・??・?・?髯?・??・?・?郢晢??郢晢??C/驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?髯?闌ｨ・?・?鬯?・?陞滂ｽ??・?・?郢晢??
    if(!allowDrawPitch){
        try{
            // 鬨?・??・?・?鬮?莉｣?・?0.5 鬩穂ｼ懷???・?・??・?・?髯??郢晢??遶頑･??・・?・?鬯???・?・?髯溯??・?・?鬯?・??・?・?髯区?ゑｽ?・?髣比ｼ夲??・?髣???驗呻??郢晢??髴難???・?・?驍ｵ・?陟募??譌ｺ驛｢・?陟募?・・?髫??陷諤懈?鬮?・??・?・?髯?・??・?・?
            const tNow = playbackPosition - getPitchVisOffsetSec();
            const drawConfMin = IS_MOBILE ? DRAW_CONF_MIN_MOBILE : PITCH_CONF_MIN;
            for(let i=pitchHistory.length-1;i>=0;i--){ const p=pitchHistory[i]; if((tNow - p.time) > 0.5) break; if((p.conf==null) || (p.conf >= drawConfMin)){ allowDrawPitch = true; break; } }
        }catch(_){ }
    }
    if(!isCalibrating && pitchHistory.length && !isAssistActive() && allowDrawPitch){
    const LAG_MS = Math.round((getPitchVisOffsetSec())*1000); // 髮九ｑ??・?髯橸??陞溽??隘夜劑謚ｵ・?・?驛｢・?郢??雋ょ????謫?・?・?
        // 鬮?・?隲?肩・?・??・?・?驍ｵ・??・?・?驍ｵ・?郢晢?? 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取辨・?・?髦?蜷??・?鬮?・??・?・?髴取ｻゑｽ?・?驍ｵ・??・?・?鬯?・??・?・?鬩搾??陞｢・?郢晢??驍ｵ・??・?・?郢晢??鬩・?・?・??・?・?髫?・?髣頑ｹ??抵??譎｢・?・?驛｢譎?樟?ゑｽ?驛｢・?騾???隲?蜻?豌｣陜鍋????・?・?鬩搾??闔牙遜??・?郢晢???・?蟶晢?りｫ?諛?・?郢晢??郢晢??
        const CHANGE_TOL_SEMI = 0.5;      // 髯憺屮・?・?髫?蟷?・?・?驍ｵ・??・?・?髯具??郢晢??霑夲??驍ｵ・?陷会ｽ?遯?・?驍ｵ・?郢晢??・つ?・?・?郢晢??闔・?雎ｼ?鬯?・??・?・?郢晢??郢晢??
        const lag = LAG_MS/1000;
        const bridgeGap = Math.max(0.001, (1/Math.max(1,(analysisRate||20))) * 1.5);
        // 髯?・??・?・?鬮?蜍滓亜陷・??鬯?・?霓｣蛛???・??・?・?驍ｵ・??・?・?髯?・?陋ｹ・??・?蜀暦??・?陝ｶ蜷??・?髯橸???・?・?髮・?・?・?驛｢・?陷?蝓滂ｽ?讌｢諤・・?・?郢晢??闔・??・?・?闔会ｽ??・??髣???陷?・??・?・?陋ｹ??・?・?郢晢??
        const visStart = eff - (playX/pxPerSec)*tempoFactor - 1;
        const visEnd = eff + ((w-playX)/pxPerSec)*tempoFactor + 1;
        // 鬯?霈?・??・?・??・?・?驛｢・?髮区???驛∵Τ?・?・?驍ｵ・?陷会ｽ?隨??髫??陷諤懈?髯・?・?・?鬮?雜｣・?・?髫?蠑ｱ・玖?・?驍ｵ・??・?・?髣???闔ｨ竏晏?・
        const drawUntil = (playbackPosition - lag);

    // 1) 鬩???郢晢??陝ｲ?髯??郢晢??郢晢??髴難???・?・?驛｢・?陷?蝓滂ｽ?讌｢諤・・?・?驍ｵ・?陷会ｽ?・つ遶擾??陷・??鬯?・?鬯?・??・?・?郢晢??遶頑･?蜿・・?・?驍ｵ・??・?・?驍ｵ・?遶擾???・?・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?MIDI驍ｵ・??・?・?dCents驛｢・?陷?閧?・?蟷・蜴・??・?
        const pts = [];
        // 鬮?・?隲?肩・?・??・?・?驍ｵ・??・?・?驍ｵ・?郢晢?? 驛｢・??・?・?驛｢・??・?・?驛｢譎?樟?主??・?・??・?・?驛｢譎｢・?・?鬯?・??・?・?髯?・??・?・?驍ｵ・??・?・?鬮?・?陟暮?会ｽ?蜀暦??・??・?・?驍ｵ・?郢晢???・?・?闔蛹・??・??・?・?鬯???・?・?髯溯??・?・?驍ｵ・??・?・?髣???驕擾??陷第?抵??・??・?・?驍ｵ・??・?・?鬯?蛹・??・?鬨?蛹・??・?郢晢??郢晢??
        const WIN = 0;
        for(let i=0;i<pitchHistory.length;i++){
            const p = pitchHistory[i];
            // 髣???隴取得??・?闖ｫ・?陷・??驍ｵ・??・?・?髯?・??・?・?鬮??薙§邵?讙趣??譎???譁絶落驛｢譏ｴ?・?郢晢??髯晢???・?・?髯具??郢晢???・?螳夲??・??・?・?髯懶???・?・?髯区?ゑｽ?・?驍ｵ・??・?・?髯?・?陋ｹ・??・?蜀暦??・?陝ｶ蜷??・?髯??陜難??郢晢??鬩励???・?
            const t = p.time + ((p.visOff!=null)? (p.visOff - curOff) : 0);
            if(!(t>=visStart && t<=visEnd)) continue;
            if(t > drawUntil) continue;   // 鬯?霈?・??・?・??・?・?驛｢・?陋ｹ・??・?鬘?蜍滂ｽ?蠕?・?驍ｵ・??・?・?驍ｵ・??・?・?髫??闕ｳ迺?・?驍ｵ・??・?・?驍ｵ・?郢晢??
            const drawConfMin = IS_MOBILE ? DRAW_CONF_MIN_MOBILE : PITCH_CONF_MIN;
            if(typeof p.conf==='number' && p.conf < drawConfMin) continue; // 髣???隲?・??・?・??・?・?鬯???・?・?驍ｵ・??・?・?髴取ｻゑｽ?・?鬮?霈?・?
            if(isCallAt(t)) continue;     // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?髣????・?・?驍ｵ・??・?・?鬯?・?隶・?・?・??・?・?鬩穂ｼ夲??・?
            // 鬮?・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?MIDI: 驛｢・??・?・?驛｢・??・?・?驛｢譎擾??・?遶剰ご??・??・?・?髯?・??・?・?鬨?・?・つ驍ｵ・??・?・?髯晏??・??・?・??・?・?驍ｵ・?郢???・?・??・?・?驍ｵ・??・?・?鬨??難??・?隰?歓??蛹・??・?髫?・??・?・?驍ｵ・?闕ｵ譎｢・?陋ｾ・りｫ?諛?・?驍ｵ・?郢晢??
            let midi;
            let dCents = (p.dCents!=null && Number.isFinite(p.dCents))? p.dCents : null;
            midi = (69+12*Math.log2(Math.max(1e-9,p.freq)/A4Frequency));
            if(!(midi>=vmin && midi<=vmax)) continue;
            pts.push({t, midi, dCents, conf:(typeof p.conf==='number'? p.conf: 0.7), freq:p.freq});
        }
        if(pts.length){
            // 鬮?・??・?・?髫???・?・?: 髯?・??・?・?鬮?遨ゑｽ?貊ゑ??・?郢晢??陝ｲ?驍ｵ・??・?・?鬯?・??・?・?鬯?・?陋滂ｽ?邵?驢搾??譎｢・?・?驛｢・??・?・?驍ｵ・?隰疲?ゑｽ?・?雋????・?・??・?・?鬨?・?郢晢??遶・1驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??闔蛹・??・?郢晢?? C驍ｵ・??・?・?驍ｵ・??・?・?郢晢??陝ｲ・?遶頑･??????・?驛｢・?髮榊?・?・?陋滂ｽ??・?讓抵??・??・?・?驍ｵ・?郢晢???・?迢暦??・?陋ｹ・??・?・?隲幢??郢晢??
            try{
                const classes = new Map();
                for(const p of pts){
                    const pc = ((Math.round(p.midi)%12)+12)%12;
                    classes.set(pc, (classes.get(pc)||0)+1);
                }
                if(classes.size===1){
                    const onlyPc=[...classes.keys()][0];
                    __diagLog('c-only-visual', {
                        pc: onlyPc,
                        count: pts.length,
                        A4: A4Frequency,
                        visRange: {vmin, vmax},
                        states: {isCalibrating, practicing:isPracticing, assist:isAssistActive()},
                        micRenderMode
                    }, 4000);
                }
            }catch(_){ }
            // pitchHistory 驍ｵ・??・?・?髫?蠑ｱ・・・?・??・?・?髯具??陷会ｽ?邵?蟶?≧?・?・?髯?莨夲??・?驍ｵ・?髴???・?讙趣??・?闕ｵ譏ｶ陞ｺ驛｢・?遶丞仰遶丞､?・??驍ｵ・?髦?蜷??蝣?・?・??・?・?鬮?????・?髯?莨夲??・?髴難???・?・?髯具??郢晢??pts 驛｢・?郢?闌ｨ・?・?郢??郢晢??髫?蠑ｱ・・・?・??・?・?髯具??陷会ｽ?・つ郢晢??
            // 髣???陝雜｣・?・?遶丞｣??鬘鯉ｽ???・?・?郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎???・?蟶晢??蛹・??・?驍ｵ・?闔会ｽ?遯?・?髫??陷諤懈?鬮?蜈ｷ・?・?鬮?蛹・??・?驛｢・?陞ｳ螟ｲ・?・??・?・?髮九?・?蜷???驛｢・?陷茨???・?・?陜捺?ゑｽ?・??・?・?鬩????・?・?驍ｵ・??・?・?鬯??郢晢???・?・?闕ｳ讒ｭ?・?髫?蜴・??・?驍ｵ・??・?・?髣???鬯・汚??・?遶丞｣??蟶昴♀?・?・?髣???・つ郢晢??陝ｲ・?・つ郢晢??
            if(micRenderMode==='dot'){
                // 髫俶誓??・?驍ｵ・?郢晢??邵?蟶?・?譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・? 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取刮・?・?隴∫???蝣?・?・??・?・?髯・闕ｳ螂????驍ｵ・??・?・?髴難???・?・?驛｢・?陷?閧?・?蟶敖蛹・??・?
                ctx.save();
                for(const p of pts){
                    const y = h - (p.midi - vmin + 1) * pxSemi;
                    const x = playX + ((p.t - eff) * pxPerSec / tempoFactor);
                    if(x<0 || x>w) continue;
                    ctx.beginPath();
                    ctx.arc(x, y, 2.5, 0, Math.PI*2);
                    ctx.fillStyle = 'rgba(255,80,80,0.9)';
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 1.2;
                    ctx.fill(); ctx.stroke();
                }
                ctx.restore();
            } else if(micRenderMode==='graph'){
                // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎???驥・坩・?譎｢・?・?驛｢譏ｴ?・? 髴取ｻゑｽ?・?鬯?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??驍ｵ・??・?・?髯具??郢晢??霑夲??驍ｵ・?陷会ｽ?・つ遶擾???・?・??・?・?髯橸???・?・?髯??郢晢??郢晢??髯?螟ｧ豸?隰??鬩搾??闔会ｽ?・つ遶擾???・?・??・?・?髯橸???・?・?髯樊ｻ薙§郢晢??鬮?・?驕停扱蟲?髫俶誓??・?
                // 鬮?驢搾??・?騾寂握?・・?・?髯橸??陞｢・?郢晢??驍ｵ・?雋?∞??竏ｫ・?・??・?・?鬯?・??・?・?髯区?ゑｽ?・?
                const CHANGE_TOL_SEMI = 0.5;      // 髯?雍???竏ｵ・?・?髯晢???・?・?髯具??郢晢??郢晢??髯具??郢晢??霑夲??驍ｵ・?陷会ｽ?遯?・?驍ｵ・?郢晢??・つ?・?・?
                const bridgeGap = Math.max(0.02, (1/Math.max(1,(analysisRate||20))) * 1.8);
                // 鬮?・??・?・?鬩穂ｼ夲??・?髯・郢?閾?闊樣し???・?・?鬮???・?・?鬯?・?闕ｳ讖ｸ・?・??・?・?髮矩宦・?・?陜滂ｽ?: 3髴難???・?・?鬩募???・?髯?讎贋ｾ・・?・??・?・?髯懶??郢晢??[1,2,1]/4 驛｢・?陝ｶ譏ｶ?螳??蛹・??・?郢晢??陜捺???・?鬯?・?髦?蜷??・?驍ｵ・?隴擾??郢晢??驍ｵ・??・?・?驍ｵ・??・?・?郢晢??郢晢??
                (function smoothDisplayPoints(){
                    if(pts.length<3) return;
                    const sm = new Array(pts.length);
                    for(let i=0;i<pts.length;i++){
                        if(i===0 || i===pts.length-1){ sm[i] = { ...pts[i] }; }
                        else {
                            const m = (pts[i-1].midi + 2*pts[i].midi + pts[i+1].midi)/4;
                            sm[i] = { ...pts[i], midi: m };
                        }
                    }
                    for(let i=0;i<pts.length;i++){ pts[i].midi = sm[i].midi; }
                })();
                // 驍ｵ・??・?・?驍ｵ・?陞?搨??・?・?鬩搾??陞｢・?邵?譎会ｽ?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?樟?頑･??慕ｹ晢??霑夲??
                const segs=[]; // {pts:[{x,y,t,midi,inTol,conf}]}
                let cur=null; let last=null;
                for(const p of pts){
                    const x = playX + ((p.t - eff) * pxPerSec / tempoFactor);
                    const y = h - (p.midi - vmin + 1) * pxSemi;
                    const inTol = (p.dCents!=null)? (Math.abs(p.dCents) <= (toleranceCents||0)) : false;
                    if(x<0 || x>w){ last=p; continue; }
                    const voiced = (p.conf==null? true: p.conf>=0.3);
                    if(!voiced){ last=p; continue; }
                    const isCont = last? ((p.t - last.t) <= bridgeGap && Math.abs(p.midi - last.midi) <= CHANGE_TOL_SEMI) : false;
                    if(!cur || !isCont){
                        if(cur && cur.pts.length>=2) segs.push(cur);
                        cur = { pts:[{x,y,t:p.t,midi:p.midi,inTol,conf:p.conf}] };
                    } else {
                        cur.pts.push({x,y,t:p.t,midi:p.midi,inTol,conf:p.conf});
                    }
                    last=p;
                }
                if(cur && cur.pts.length>=2) segs.push(cur);
                // 髯晢???・?・?髮矩宦・?・?陜滂ｽ?髫??陷諤懈?驛｢譎渉・?・取刮・?譏???・?郢晢??: 驛｢譎???・取㏍・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・?陷・?・?・?隴?・??・?・??・?・?髫?蜴・??・?鬩搾??陞｢・?邵?蝣?・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?
                function drawSmoothedPolyline(ctx, points){
                    if(!points || points.length<2) return;
                    ctx.beginPath();
                    if(points.length===2){
                        ctx.moveTo(points[0].x, points[0].y);
                        ctx.lineTo(points[1].x, points[1].y);
                        ctx.stroke();
                        return;
                    }
                    ctx.moveTo(points[0].x, points[0].y);
                    for(let i=1;i<points.length-1;i++){
                        const xc=(points[i].x + points[i+1].x)/2;
                        const yc=(points[i].y + points[i+1].y)/2;
                        ctx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);
                    }
                    ctx.lineTo(points[points.length-1].x, points[points.length-1].y);
                    ctx.stroke();
                }
                function splitRuns(points, predicate){
                    const runs=[]; let run=[];
                    for(const pt of points){
                        if(predicate(pt)){
                            run.push(pt);
                        } else {
                            if(run.length>=2) runs.push(run);
                            run=[];
                        }
                    }
                    if(run.length>=2) runs.push(run);
                    return runs;
                }
                // 鬮?・?驕停扱蟲?郢晢??鬩・?・?・??・?・?郢晢??闖ｫ?郢晢?? 髯?螟ｧ豸?隰??郢晢??髢?・??・?・?隰・∞??・?陝ｲ・?郢晢??鬯??郢晢??遶頑･?・??陷諤懈?
                ctx.save();
                ctx.lineWidth = 2.0;
                // 髫俶誓??・?: 鬮?・??・?・?髯橸???・?・?髯樊ｺ?・?諷環?・?・?鬩搾??陞溽浹螟雁?慕ｹ晢??郢晢??驍ｵ・??・?・?驛｢譎???・取㏍・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?
                ctx.strokeStyle = 'rgba(255,120,120,0.9)';
                for(const s of segs){
                    const runs = splitRuns(s.pts, (pt)=>!pt.inTol);
                    for(const r of runs){ drawSmoothedPolyline(ctx, r); }
                }
                // 鬩搾??郢晢?? 鬮?・??・?・?髯橸???・?・?髯??郢晢???・?螳壽≧陜難??隰??驍ｵ・??・?・?
                ctx.strokeStyle = 'rgba(24,200,70,0.98)';
                for(const s of segs){
                    const runs = splitRuns(s.pts, (pt)=>pt.inTol);
                    for(const r of runs){ drawSmoothedPolyline(ctx, r); }
                }
                ctx.restore();
            } else {
                // 髫?・?陜｣・??・?・?陞滂ｽ??・?・?陜捺?・飴髯・陋??・?・?郢晢?? 鬯?・??・?・?鬩搾??陞｢・?郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯具??郢晢??霑夲??驍ｵ・?陷会ｽ?遯?・?髯樊ｻゑｽ?・?驍ｵ・?郢晢??雎ｼ・??・?・?髯具??郢晢???・??
                // 2) 鬯?・??・?・?鬩搾??陞｢・?郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯具??郢晢??霑夲??
                let run=null; // {t0, t1, sumMidi, sumW, lastT, baseKey, inTol, outTol, confSum, cnt, samples:[]}
                const flushRun=(r)=>{
                if(!r) return;
                const mAvg = r.sumMidi / Math.max(1e-6, r.sumW);
                const y = h - (mAvg - vmin + 1) * pxSemi;
                const x1 = playX + ((r.t0 - eff) * pxPerSec / tempoFactor);
                const x2 = playX + ((r.t1 - eff) * pxPerSec / tempoFactor);
                if(x2<0 || x1>w) return;
                // 雎ｼ・??・?・?髯具??郢晢???・??: 鬮?・??・?・?髯橸???・?・?髯??郢晢??霑夲??髯?・?陋ｹ・?邵?螳夲??雜｣・?・?髯橸??陞滂ｽ??・?・?郢晢??0%髣比ｼ夲??・?髣???驗呻??邵?蟶昴??隰・∞??・?郢晢??
                const tol = toleranceCents||0;
                const okRatio = (r.inTol + r.outTol) > 0 ? (r.inTol/(r.inTol + r.outTol)) : 0;
                const alpha = Math.max(0.35, Math.min(1, 0.45 + 0.55*(r.confSum/Math.max(1,r.cnt)) ));
                if(okRatio >= 0.5){
                    // 鬮?蜍?・??・?・?髢?・?・つ?・?・?髯?・?陷?・??・?・?郢晢?? 鬨?蜈ｷ・?・?鬩搾??郢晢??+ 鬩搾??髫?・?隰費??鬩搾??郢晢??+ 驛｢・?闕ｳ蟯???驍ｵ・?闕ｵ譏ｶ?讌｢蜿蛾・・?邵?讙趣??譎???譁絶落驛｢譏ｴ?・?郢晢??
                    const yOff = y - 3; // 髣???驗呻??遶・ 3px
                    ctx.save();
                    // 髯樊ｻ・束郢晢??鬨?蜈ｷ・?・?鬩搾??郢晢??
                    ctx.lineWidth = 6;
                    ctx.strokeStyle = `rgba(255,255,255,${alpha*0.95})`;
                    ctx.beginPath(); ctx.moveTo(x1, yOff); ctx.lineTo(x2, yOff); ctx.stroke();
                    // 髯??郢晢??郢晢??鬩搾??郢晢??
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = `rgba(24,200,70,${alpha})`;
                    ctx.beginPath(); ctx.moveTo(x1, yOff); ctx.lineTo(x2, yOff); ctx.stroke();
                    ctx.restore();
                } else {
                    ctx.save();
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = `rgba(255,64,64,${alpha})`;
                    ctx.beginPath(); ctx.moveTo(x1, y); ctx.lineTo(x2, y); ctx.stroke();
                    ctx.restore();
                }

                // 驛｢譎∽??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎乗ｲ??・?・?隲幢??郢晢??驍ｵ・??・?・?髮主桁??・?鬩搾??陞｢・?驍ｱ蟶敖蛹・??・?
                try{
                    // 髫?螟ｲ・?・?髣比ｼ夲??・?: 驛｢譎｢・?・?驛｢譎｢・?・?鬯?貊ゑ??・?驍ｵ・?郢晢??.3s髣比ｼ夲??・?髣???驗呻??・つ遶丞｣?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取?・?・??・?・?驍ｵ・?郢晢??髣比ｼ夲??・?髣???郢晢??
                    const dur = (r.t1 - r.t0);
                    if(dur >= 0.3 && r.samples && r.samples.length >= 5){
                        // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髣????・?・?髯樊ｻゑｽ?・?髯区?ゑｽ?・?驛｢・?髮区????謌????隰費??遶企豪・?・?陷会ｽ?隨??驛｢・??・?・?驛｢譎｢・?・?驛｢譏???・??・?・?髯晢???・?・?髯具??陷会ｽ??・?螳壽割隲帛現?・?
                        const mids = r.samples.map(s=> s.midi);
                        const times = r.samples.map(s=> s.t);
                        const med = mids.slice().sort((a,b)=>a-b)[Math.floor(mids.length/2)];
                        const cents = mids.map(m=> (m - med)*100);
                        // 1髫?・??・?・?驛｢譎?樟?取ｨ抵??譎｢・?・?驛｢譎擾??・??・?蟶晢??・??・?・?髯?・??・?・?郢晢??闔・?髢?・?鬩榊?蝮??・?・??・?・?髯?讎贋ｾ・・?・??・?・?髯懶??郢晢???・?・?郢晢??
                        const win = Math.max(1, Math.floor(Math.min(7, Math.max(3, Math.round(r.samples.length*0.12)))));
                        const detr = cents.map((v,i)=>{
                            let s=0,c=0; for(let k=-win;k<=win;k++){ const j=i+k; if(j>=0&&j<cents.length){ s+=cents[j]; c++; } }
                            const ma = s/Math.max(1,c); return v - ma;
                        });
                        // 髯?髮・・??・?・?隴∬・笳・Δ譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・?闕ｵ譎｢・???謳・・?・?髫?蟷?・?・?髫?蜴・??・?髯?讎???骰・螟ゑ??・?陷?驛?・?髯橸??陞滂ｽ??・?・?郢晢??驍ｵ・?郢晢??Hz髯懈瑳・?繧托ｽ?・?郢晢??
                        let zc=0; for(let i=1;i<detr.length;i++){ if((detr[i-1]<=0 && detr[i]>0) || (detr[i-1]>=0 && detr[i]<0)) zc++; }
                        const fs = Math.max(1e-6, r.cnt / Math.max(1e-6, dur)); // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・・/鬩穂ｿ?諷??・?・?鬩・?・?・??・?・?髫?・?髣頑ｹ??抵??譎｢・?・?驛｢譎槭??・?・?陷?・??・?・??・?・?郢晢??郢晢??
                        const estHz = (zc/2) / Math.max(1e-6, dur); // 鬩埼?碑ｻ?髢?・?髯橸??郢晢??
                        // 髫?蜴・??・?髯晢??郢晢???・?・?郢晢??eak-to-peak驍ｵ・??・?・?髯?莨∝ｮ?郢晢??郢晢??郢晢??
                        const minV = Math.min(...detr), maxV=Math.max(...detr);
                        const amp = (maxV - minV)/2; // cents
                        const vibOK = (estHz>=3.5 && estHz<=8.5 && amp>=20);
                        if(vibOK){
                            // 髮主桁??・?鬩搾??陞｢・?郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?
                            const ampPx = Math.min(6, Math.max(3, (amp/100)*pxSemi*0.9)); // 驛｢・??・?・?驛｢譎???蛟･?夐Δ譎｢・?・?驛｢譎｢・?・?驕ｶ?鯛名x髫??陝ｶ・??・?・?陷会ｽ?郢晢??鬩堺?・・?.9髯区?・・?
                            const yWave = y - 8; // 驛｢譎擾??・?郢晢??驛｢譎???・?・?陞｢・?郢晢??髯・闔会ｽ??・??髣???郢晢??
                            const fHz = estHz;
                            // 髯?・??・?・?鬮?遨ゑｽ?貊ゑ??・?郢晢??陝ｲ?驍ｵ・??・?・?驍ｵ・?郢晢??郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取?・?・??・?・?驍ｵ・?闕ｵ譎｢・?閾?・?譎???・取㏍・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・?陜｣・?陷・??髫?蠕?・?
                            const step = Math.max(2, Math.floor((x2-x1)/48));
                            ctx.save();
                            ctx.lineWidth = 2;
                            ctx.strokeStyle = 'rgba(120,200,255,0.9)';
                            ctx.beginPath();
                            const totalPx = x2 - x1;
                            const twoPiF = 2*Math.PI*fHz;
                            for(let i=0;i<=Math.max(1, Math.floor(totalPx/step)); i++){
                                const px = x1 + i*step;
                                if(px<x1 || px> x2) continue;
                                const tt = r.t0 + ( (px - x1) / (x2 - x1) ) * dur; // 鬩搾??陞｢・??・?・??・?・?髯・?・?・?髯滂ｽ?郢晢??
                                const phase = twoPiF * (tt - r.t0);
                                const yy = yWave - ampPx * Math.sin(phase);
                                if(i===0) ctx.moveTo(px, yy); else ctx.lineTo(px, yy);
                            }
                            ctx.stroke();
                            ctx.restore();
                        }
                    }
                }catch(_){ }
            };
            // 驛｢・?郢晢??隨・??驍ｵ・?闕ｳ螂???鬘費??・?陷会ｽ?隨??鬯?・??・?・?鬩搾??陞｢・?郢晢??驛｢譎｢・?・?驛｢譎???譁石夐Δ??陝ｶ譎≫裸驍ｵ・?郢晢???・?・??・?・?髯晢???・?・?驛｢譎?蠕?・?驍ｵ・??・?・?髯晢???・?・?髯懶??郢晢??陜滂ｽ?驍ｵ・?陷会ｽ?遶企?・?・?郢晢??隨??驛｢・?遶丞｣??・?髯具??郢晢??霑夲??驍ｵ・?陷会ｽ?遯?・?驍ｵ・?郢晢??・つ?・?・?郢晢??陋ｹ・?邵?譎会ｽ?譎???蛟･?夐Δ譎｢・?・?驛｢譎｢・?・?郢晢??郢晢??
            const DRIFT_SPLIT_SEMI = 0.18; // 驕ｶ霈?・?18 cents
            const DRIFT_MIN_DUR = 0.25;    // 0.25s 髣比ｼ夲??・?髣???鬯倩??・?・?陞｢・??・?讓抵??・?雋?∞??陋ｾ蝨?驕ｨ繧托ｽ?・??・?・?
            for(const p of pts){
                    const key = Math.round(p.midi); // 髯?雍???竏ｵ・?・?髣????・?・?驛｢・?郢晢???・?・?陋ｹ・?郢晢??驛｢譎?§・主??・?譎｢・?・?驛｢譎???・?螳壽・陟包???・?・?・つ驛｢譎?樟郢晢??驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・?陷会ｽ?遯?・?髫???・?・?驍ｵ・?郢晢???・?・?郢晢??
                    const w = 0.5 + 0.5*p.conf;
                    if(!run){
                        run = { t0:p.t, t1:p.t, sumMidi:p.midi*w, sumW:w, lastT:p.t, baseKey:key, inTol:0, outTol:0, confSum:p.conf, cnt:1, samples:[{t:p.t, midi:p.midi}] };
                        if(p.dCents!=null){ (Math.abs(p.dCents) <= (toleranceCents||0)) ? run.inTol++ : run.outTol++; }
                        continue;
                    }
                    const gap = p.t - run.lastT;
                    const lastMidiInRun = run.samples[run.samples.length-1]?.midi ?? (run.sumMidi/Math.max(1e-6,run.sumW));
                    const mAvgCur = run.sumMidi/Math.max(1e-6,run.sumW);
                    const deltaToKey = Math.abs(p.midi - run.baseKey);
                    const deltaToLast = Math.abs(p.midi - lastMidiInRun);
                    const deltaToAvg  = Math.abs(p.midi - mAvgCur);
                    // 鬯?・??・?・?鬩搾??陞｢・?・つ?・?・?驍ｵ・??・?・?驍ｵ・?隶吩??・?・?髯?莉｣?・?鬩募???・?髯?讎贋ｾ・・?・??・?・?髯懶??郢晢??・つ鬮?・?郢晢??驍ｵ・??・?・?驍ｵ・??・?・?驛｢・?陝ｲ・?・ゑｽ?驍ｵ・?霑ｹ螟ｲ・?・??・?・?髯橸???・?・?髯??郢晢??遶企?・?・?驕帝?郢晢??陋ｹ・?邵?蜀暦??譎｢・?・?髯懈圜・?・?髯橸??陞｢・?遶企豪・?・?陋ｹ・??・?遏ｩ・?遨ゑｽ?・??・?・??・?・?驍ｵ・??・?・?髯??鯉ｽ?謚ｫ螟｢髯滓汚??・?驛｢・?驗呻???・?螳夲??螢?・?・?陞ｳ蟶・・?郢晢??
                    const continuous = (gap <= bridgeGap) && ( (deltaToLast <= CHANGE_TOL_SEMI*1.2) || (deltaToAvg <= CHANGE_TOL_SEMI) || (deltaToKey <= CHANGE_TOL_SEMI*0.9) );
                    if(continuous){
                        // 鬩肴得??・?鬩???鬮?・?郢晢??驛｢譎｢・?・?驛｢譎???譁石夐し・?驕停扱??句?・・?・?驛｢・?陞ｳ螟ｲ・?・?郢晢??遶擾??驍ｵ・?雋?∞?????慕ｹ晢??霑夲??郢晢??騾趣??髢?讓抵??・?郢晢???・?・??・?・?髯晢???・?・?驛｢譎?蠕?・?髫?螢?・?・?陞ｳ蟶・・?郢晢??
                        const durRun = (run.lastT - run.t0);
                        if(durRun >= DRIFT_MIN_DUR && Math.abs(p.midi - mAvgCur) > DRIFT_SPLIT_SEMI){
                            // 髴托ｽ??・?・?髯懶???・?・?驍ｵ・??・?・? run 驛｢・?陜｣・??・?・??・?・?髯橸??陞｢・??・??驍ｵ・?遶擾??騾??驍ｵ・?陷会ｽ??・?? run 驛｢・?陝ｶ譎擾??謌?ｲらｹ晢??
                            __diagLog('line-split-drift', {dur:durRun, drift:Math.abs(p.midi - mAvgCur), tol:DRIFT_SPLIT_SEMI}, 4000);
                            flushRun(run);
                            run = { t0:p.t, t1:p.t, sumMidi:p.midi*w, sumW:w, lastT:p.t, baseKey:key, inTol:0, outTol:0, confSum:p.conf, cnt:1, samples:[{t:p.t, midi:p.midi}] };
                            if(p.dCents!=null){ (Math.abs(p.dCents) <= (toleranceCents||0)) ? run.inTol++ : run.outTol++; }
                        } else {
                            run.t1 = p.t; run.lastT = p.t;
                            run.sumMidi += p.midi*w; run.sumW += w;
                            run.confSum += p.conf; run.cnt++;
                            run.samples.push({t:p.t, midi:p.midi});
                            if(p.dCents!=null){ (Math.abs(p.dCents) <= (toleranceCents||0)) ? run.inTol++ : run.outTol++; }
                        }
                    } else {
                        // 驍ｵ・?郢晢??遶擾??驍ｵ・??・?・?run驛｢・?陜｣・??・?・??・?・?髯橸??陞｢・??・??驍ｵ・??・?・?髫???・?・?鬮?蜍滓ｲ∬濤謌?ｲらｹ晢??
                        flushRun(run);
                        run = { t0:p.t, t1:p.t, sumMidi:p.midi*w, sumW:w, lastT:p.t, baseKey:key, inTol:0, outTol:0, confSum:p.conf, cnt:1, samples:[{t:p.t, midi:p.midi}] };
                        if(p.dCents!=null){ (Math.abs(p.dCents) <= (toleranceCents||0)) ? run.inTol++ : run.outTol++; }
                    }
                }
                flushRun(run);
            }
        }
        // 驛｢・??・?・?驛｢・??・?・?驛｢譎?・?隨乗ｪ趣??・?驍???陷・??驍ｵ・??・?・?驛｢譎??堤?晢??驛｢譏ｶ?螢?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?蠕?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?驛｢譎擾??・?郢晢??驛｢譏???・??・?・?郢?閾?闊樣??・??・?・?髴托ｽ??・?・?驍ｵ・??・?・?驍ｵ・?雋?∞???鬨?・?遶擾??隰・
    }
    // 髣比ｼ夲??・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・??・?・?郢晢??IDI驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?/鬩搾???・?・?鬩怜雀?・?邵?荵滂ｽ?譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??驛｢譎丞ｹ?・取ｨ抵??譎∽??・守､?・?譎｢・?・?郢晢??郢晢??
    // 鬯?・?陞｢・??・?・??・?・?: 髫俶誓??・?驍ｵ・??・?・?鬩墓?・?・?鬩搾??陞｢・?・つ郢??雋よ坩笙り楜闌?・?・??・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎?????・??・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驍ｵ・??・?・?髯?・?陟募具??鬯?・?陋幢??郢晢??髯橸??雋????・?・?陞｢・?邵?蟶晏??・?・?鬩穂ｼ夲??・?驍ｵ・?郢晢??
    // 髯樊ｺ?蛻?陝ｲ・?: 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?髯憺屮・?・?鬩慕甥・?闌ｨ・?・??・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎擾??・?邵?蝣?・?・??・?・?驍ｵ・?遶丞｣??ｧ驛｢譏ｴ?・?郢晢??髯・郢?閾?闊樣Δ譎｢・?・?驛｢譎｢・?・?驛｢譎?????・??・?・?驍ｵ・??・?・?驛｢・?郢??邵?螳茨??・??・?・?驛｢譏ｴ?・?髫俶誓??・?鬩墓?・?・?鬩搾??陞｢・??・?蟶晏??・?・?鬩穂ｼ夲??・?驍ｵ・?陷?・??・??
    // 鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎?????・??・?・?驍ｵ・??・?・? PC/驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?髯・闕ｳ螂???蜀暦??・?陞｢・?郢晢??驛｢譏ｴ?・?郢晢??髯・郢?閾?闊樣Δ譎｢・?・?驛｢譎｢・?・?驛｢譎擾??・?邵?蝣?・?・?郢??邵?螳茨??・??・?・?驛｢譎擾??・??・?蟶晏??・?・?鬩穂ｼ夲??・?
    if(Array.isArray(midiGhostNotes) && midiGhostNotes.length && (!isPitchOnlyMode || isPracticing)){
    const visStart=eff - (playX/pxPerSec)*tempoFactor - 1; const visEnd=eff + ((w-playX)/pxPerSec)*tempoFactor + 1;
        ctx.save();
        ctx.lineWidth = Math.max(2, guideLineWidth);
    for(const n of midiGhostNotes){
            // 驛｢譎擾??・?郢晢??驛｢譎乗ｲ??・?・?陟托??郢晢??髫??陷諤懈?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・?髮区???・?髫?蜴・??・?
            if(n.role==='resp' || n.role==='calib'){
                ctx.strokeStyle = '#4e8cff';
                ctx.setLineDash([]);
            }else if(n.role==='call'){
                ctx.strokeStyle = 'rgba(255,80,80,0.9)';
                ctx.setLineDash([6,4]);
            }else{
                // 髫??会ｽ?・?髯橸??陞滂ｽ??・?・?郢晢??IDI驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?鬩???闔ｨ螟ｲ・?・?郢晢??
                ctx.strokeStyle = 'rgba(255,80,80,0.9)';
                ctx.setLineDash([6,4]);
            }
            const st=n.time, en=n.time+n.duration;
            if(en<visStart || st>visEnd) continue;
            const x1=playX+(st-eff)*pxPerSec/tempoFactor;
            const x2=playX+((en)-eff)*pxPerSec/tempoFactor;
            if(x2<0 || x1>w) continue;
            // 鬮?遨ゑｽ?譏ｶ陞ｺ鬨?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・??・?・?鬩穂ｼ夲??・?驛｢・??・?・?驛｢譎???譁石夂ｹ晢??闔・?雋よ坩笙り楜闌?・?・??・?・?鬩怜雀?・?郢晢?? call/resp/calib 驍ｵ・??・?・?鬯?蛹・??・?鬨?蛹・??・?郢晢??郢晢??
            const dispMidi = (practiceMode==='basic' && (n.role==='call' || n.role==='resp' || n.role==='calib'))
                ? (n.midi + (practiceCallDisplayOctShift|0))
                : n.midi;
            const y=h-(dispMidi-vmin+1)*pxSemi;
            ctx.beginPath();
            ctx.moveTo(x1,y);
            ctx.lineTo(x2,y);
            ctx.stroke();
            // 驛｢譎｢・?・?驛｢譎??・・: 驛｢・??・?・?驛｢譎｢・?・?驛｢譎?櫨鬪?蜊???・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?陜灘叙??・?髯?・?鬮?・??・?蟶晏??・?・?鬩穂ｼ夲??・?郢晢??郢晢??all/resp 髯?・?隴?・?陝・?郢晢??陝ｲ・?・つ郢晢??
            if(n.role==='call' || n.role==='resp'){
                try{
                    const lbl = noteLabel(Math.round(dispMidi));
                    ctx.save();
                    ctx.font='12px sans-serif';
                    ctx.textAlign='center'; ctx.textBaseline='bottom';
                    const textX = (x1+x2)/2, textY = y-6;
                    const tw=ctx.measureText(lbl).width;
                    ctx.fillStyle='rgba(0,0,0,0.6)';
                    ctx.fillRect(textX - tw/2 - 4, textY-16, tw+8, 14);
                    ctx.fillStyle = (n.role==='call')? '#ffd27d' : '#d6f0ff';
                    ctx.fillText(lbl, textX, textY-2);
                    ctx.restore();
                }catch(_){ }
            }
            // 鬯?・?陋幢???・?讓抵??譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?鬨?蛹・??・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・??・?・?郢晢??esp郢晢??陝ｲ・?遶企豪・?・??・?・?鬯?・?陞｢・??・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?櫨鬩溽?托ｽ?雋楪・?郢晢??鬮?・??・?・?髯橸???・?・?鬩???郢晢??陝ｲ?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・?陷・?・?・?陋??・?・?郢晢??
            if(n.role==='resp'){
                const dy = (toleranceCents/100) * pxSemi;
                if(dy>0.2){
                    ctx.save();
                    ctx.setLineDash([]);
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = '#ffffff';
                    // 髣???鬮?竏?・?
                    ctx.beginPath(); ctx.moveTo(x1, y - dy); ctx.lineTo(x2, y - dy); ctx.stroke();
                    // 髣???陷?・?郢晢??
                    ctx.beginPath(); ctx.moveTo(x1, y + dy); ctx.lineTo(x2, y + dy); ctx.stroke();
                    ctx.restore();
                }
            }
        }
        ctx.restore();
    }
    // 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏???蛹・??・??・?・?驍ｵ・??・?・?髫?・?陜｣・??・?・?陞｢・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??髣???驗呻??遶???・?・?鬮?・?郢晢??驍ｵ・??・?・?髫??闕ｳ螂???・?郢晢??髢?・?陷環鬩搾??郢晢???・?・?霑｢證ｦ・?・?闔会ｽ?邵?蟶晏寰陷・??・?・?髢?・?・つ?・?・?UP郢晢??陝ｲ・?・つ郢晢??
    // 髯樊ｺ?蛻?陝ｲ・?: 驛｢譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?髯憺屮・?・?鬩慕甥・?闌ｨ・?・??・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎擾??・?邵?蝣?・?・??・?・?驍ｵ・?遶丞｣??ｧ驛｢譏ｴ?・?郢晢??髯・郢?閾?闊樣Δ譎｢・?・?驛｢譎｢・?・?驛｢譎?????・??・?・?驍ｵ・??・?・?驛｢・?郢?螂???・??・?・?鬩穂ｼ夲??・?驍ｵ・?陷?・??・??
    if(_assistSegments && _assistSegments.length && (!isPitchOnlyMode || (IS_MOBILE && isPracticing))){
        ctx.save();
        for(const s of _assistSegments){
            // 髯樊ｻ・束郢晢??驍ｵ・??・?・?鬨?蜈ｷ・?・?鬩搾??郢晢??
            ctx.lineWidth = 5;
            ctx.strokeStyle = 'rgba(255,255,255,0.9)';
            ctx.beginPath(); ctx.moveTo(s.x1, s.y); ctx.lineTo(s.x2, s.y); ctx.stroke();
            // 髯??郢晢??郢晢??驍ｵ・??・?・?鬩搾??髫?・?隰費??鬩搾??郢晢??
            ctx.lineWidth = 3;
            ctx.strokeStyle = 'rgba(24,200,70,0.95)';
            ctx.beginPath(); ctx.moveTo(s.x1, s.y); ctx.lineTo(s.x2, s.y); ctx.stroke();
        }
        ctx.restore();
    }
    // 驛｢譎｢・?・?驛｢・??・?・?驛｢譎?§邵??驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・? (髯??陷?・?陷・??髣????・?・?/髯句??繩??・?・??・?・?髣????・?・?髯?闌ｨ・?・?鬯?・?郢晢??
    // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?§・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?髣????・?・?驍ｵ・??・?・?鬯?・?隶・?・?・??・?・?鬩穂ｼ夲??・?郢晢??陋ｹ・?邵?荵滂ｽ?譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??驍ｵ・??・?・?鬮?遨ゑｽ?譏ｶ髮?驛｢・?陷茨???・?・?郢晢??
    if(!isCalibrating && lastMicFreq>0){
        // 鬮?・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?驍ｵ・??・?・?驍ｵ・?遶丞｣??・Δ???・?・?驛｢譏???螟ｲ・?・?陋ｹ・?郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?邵?? or 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎∬??・?・?陝ｲ・?遯?・?驍ｵ・?郢???・??匁捗?・?・?髯?・?陋ｹ・?郢晢??髫????驛｢・?郢?螂???・?闔会ｽ??・?讓抵??・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§遶頑･?豎樒ｹ晢??隨?迢暦??・?郢晢??
        // 髯憺屮・?・?髮・隰費??郢晢??髯滂ｽ?郢晢??隨・鬨??難??・?隰?歓??蛹・??・?髫?・??・?・?鬨?蛹・??・?髫?螟ｲ・?・?驍ｵ・??・?・?MIDI郢晢??郢晢??astMicFreq郢晢??郢晢??
        let midi = 69 + 12*Math.log2(lastMicFreq/A4Frequency);
        // 驛｢・??・?・?驛｢・??・?・?驛｢譎会ｽ?・?IDI驍ｵ・??・?・?髯?・?陋ｹ・??・?蜀暦??・?陝ｶ蜻?・?迢暦??・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・?隲?肩・?・??・?・?驍ｵ・??・?・?髫?・??・?・?髯晏??・??・?・?髢?・?陷・??MIDI驍ｵ・?隴擾??郢晢??驍ｵ・??・?・?驍ｵ・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?郢晢??郢晢??
        // 髣???隲?・??・?・??・?・?鬯???・?・?驛｢譎???驥・?抵??譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・?髫俶誓??・?髣????・?・?驛｢・?陷?閧?・?蝣?・?・?闕ｵ譏ｶ?驢搾??・?郢晢???・?・?闔・??・?・??・?・?髮・?・?・?髯?・?隴?・??・?・?陋滂ｽ?郢晢??髯憺屮・?・?髮・隰費??遶頑･???陋ｹ・??・?蜀暦??・?陝ｶ蜻?・?荵・・?郢晢??
        const canShowLive = (function(){
            try{
                // 鬨?・??・?・?鬮?螟ｧ・?・??・?・??・?・?髮・?・?・?驍ｵ・??・?・?髣????・?・?鬯???・?・?髯溯??・?・?驍ｵ・??・?・?髯具???・?・?髯橸??陞滂ｽ??・?・?闔・?鬩溽?大初?つ髫?蠑ｱ・・け??髯晢???・?・?驍ｵ・??・?・?髴難???・?・?驍ｵ・?陟募??譌ｺ驛｢・?陟募?・・?驍ｵ・?隴擾???・?讙趣??・??・?・?髯?・?陋ｹ・??・?蜀暦??・?陝ｶ蜻?・?荵・・?郢晢??
                const tRef = playbackPosition - getPitchVisOffsetSec();
                const drawConfMin = IS_MOBILE ? DRAW_CONF_MIN_MOBILE : PITCH_CONF_MIN;
                for(let i=pitchHistory.length-1;i>=0;i--){ const p=pitchHistory[i]; if((tRef - p.time) > 0.25) break; if(Math.abs(p.time - tRef) <= 0.12){ return (p.conf==null) || (p.conf >= drawConfMin); } }
            }catch(_){ }
            return true; // 髫??郢晢???・?・??・?・?驍ｵ・?陟募???驢搾??・?闔会ｽ??・?讙趣??・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?
        })();
        if(canShowLive && midi>=vmin && midi<=vmax){
            const y=h-(midi-vmin+1)*pxSemi;
            // 髯樊ｺ?謌溯??・?鬨?蜈ｷ・?・?驕ｶ鬘假??讒ｭ?・?鬯?蟷?・?・?髫俶誓??・?髯??郢晢??
            ctx.beginPath(); ctx.arc(playX,y,8,0,Math.PI*2); ctx.fillStyle='rgba(255,80,80,0.9)'; ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.fill(); ctx.stroke();
            // 鬯?・??・?・?髯?・?陝雜｣・?・??・?・?鬩穂ｼ夲??・?
            const label=noteLabel(Math.round(midi));
            ctx.font='12px sans-serif'; ctx.textAlign='left'; ctx.textBaseline='middle';
            const tx=playX+12; const ty=y;
            ctx.fillStyle='rgba(0,0,0,0.6)'; const pad=4; const tw=ctx.measureText(label).width; ctx.fillRect(tx-2,ty-10,tw+pad+2,16);
            ctx.fillStyle='#ffe'; ctx.fillText(label,tx,ty);
            // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?鬯?螟ｲ・?・?: 鬨?・??・?・?髫?轣倡函郢晢??驛｢譎｢・?・?驛｢譎?樟?頑･?豎?・?・?驍ｵ・?陷?・??・?迢暦??・??・?・?驛｢譎｢・?・?驛｢譏???・??・?・?髯晢???・?・?驛｢・?陞ｳ螟ｲ・?・??・?・?鬩穂ｼ夲??・?郢晢??騾趣??雎ｬ・?鬩墓ｨ費??譁溽坩・?譎｢・?・?驛｢譎擾??・?邵?蝣?・?・??・?・?鬯?・?隶・?・?・??・?・?鬩穂ｼ夲??・?郢晢??郢晢??
            try{
                if(!isPitchOnlyMode){
                const tr=currentTracks[melodyTrackIndex];
                if(tr && tr.notes && tr.notes.length){
                    const t=playbackPosition; const nn=tr.notes.find(n=> t>=n.time && t<=n.time+n.duration) || tr.notes.find(n=> n.time>t) || tr.notes[tr.notes.length-1];
                    if(nn){
                        // 鬮?・??・?・?鬩穂ｼ夲??・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§遶頑･???陋ｹ・??・?蜀暦??・?陝ｶ蜷??・?鬨?・??・?・?髫?轣侑ｿIDI驛｢・?鬮?・??・?・?12驍ｵ・??・?・?髯・郢晢??隨?迢暦??・?郢晢??
                        let mTar = nn.midi; let mLive = Math.round(midi);
                        while(mLive - mTar > 6) mTar += 12; while(mTar - mLive > 6) mTar -= 12;
                        const fTar = midiToFreq(mTar);
                        const dCents = 1200*Math.log2(Math.max(1e-9,lastMicFreq)/Math.max(1e-9,fTar));
                        const centsTxt = (dCents>=0? '+':'') + Math.round(dCents) + 'c';
                        const within = Math.abs(dCents) <= (toleranceCents||0);
                        const cx = tx + tw + 10;
                        const cy = ty;
                        const ctW = ctx.measureText(centsTxt).width + 8;
                        ctx.fillStyle = 'rgba(0,0,0,0.6)';
                        ctx.fillRect(cx-2, cy-10, ctW+2, 16);
                        ctx.fillStyle = within? '#aef0ae' : '#ffd6a6';
                        ctx.fillText(centsTxt, cx+2, cy);
                    }
                }
                }
            }catch(_){ }
        }

        // 鬮?????・?髯?莨夲??・?: 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髯晢???・?・?髯句??・?・?驍ｵ・??・?・?髴托ｽ??・?・?髯懶???・?・?驍ｵ・??・?・?鬯?・??・?・?髯?・?鬮?・??・?蝣?・?・??・?・?驛｢譎｢・?・?驛｢譎?蠕?・?驛｢譎｢・?・?驛｢・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?郢晢??郢晢??C/驛｢・??・?・?驛｢譎???・?郢晢??/驛｢・??・?・?驛｢譎?§・取ｨ抵??譏ｴ?・?郢晢??髯?闌ｨ・?・?鬯?・?陞滂ｽ??・?・?郢晢??
        try{
            // noteLabel() 驍ｵ・??・?・? labelNotation 鬮?・??・?・?髯橸??陞｢・?遶頑･??謌贋ｾ?隨・??驍ｵ・??・?・? CDE/驛｢譎擾??・?・取ｨ抵??譏ｴ?・?驛｢・?髮区???・?驛｢・?鬯・??・?蟶?・?・?陋ｹ・??・??
            const liveRoundMidi = Math.round(midi);
            const liveLabel = noteLabel(liveRoundMidi);
            // 鬩????・?・?髫?蟷?・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驍ｵ・??・?・?髯?・?陋ｹ・??・?蜀暦??・?陝ｶ蜷?陞ｺ鬯?蛹・??・?髯溯??・?・?驍ｵ・??・?・?驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎?樟邵?遉ｼ・?・??・?・?驛｢・??・?・?郢晢??髢?・??・?・??・?・?驍ｵ・??・?・?4.5%驛｢・?陷・?・?・?闔ｨ竏晏?・8px驍ｵ・??・?・?髫?螢?・?・?陞ｳ蟶・・?郢晢??
            const fontPx = Math.max(12, Math.min(18, Math.floor(h*0.045)));
            ctx.save();
            ctx.font = `bold ${fontPx}px sans-serif`;
            ctx.textAlign = 'left'; ctx.textBaseline = 'top';
            const padX = 10, padY = 6;
            const x0 = 8, y0 = 8; // 髯晢???・?・?髣???驗呻??遶頑･?鞫・・?・?髯橸??郢晢??
            const tw = ctx.measureText(liveLabel).width;
            const boxW = Math.floor(tw + padX*2);
            const boxH = Math.floor(fontPx + padY*2);
            // 鬮?・?隴?・?陷搾??郢晢??闔・?雎ｼ?鬯?・?闕ｵ蜉ｱ?・?郢晢??郢晢??
            ctx.fillStyle = 'rgba(0,0,0,0.55)';
            ctx.fillRect(x0, y0, boxW, boxH);
            // 驛｢譏ｴ?・?邵?蜀暦??・??・?・?驛｢譏ｴ?・?
            ctx.fillStyle = '#fff';
            ctx.fillText(liveLabel, x0 + padX, y0 + padY);
            ctx.restore();
        }catch(_){ }
    }
    // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?§・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟郢・驛｢・??・?・?驛｢譎｢・?・?鬮?・??・?・?鬩穂ｼ夲??・?郢晢??陋ｹ・?邵?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髣???驗呻??遶頑･?譽・・?・?驍ｵ・?鬮?・??・?・?郢晢??郢晢??
    if(isCalibrating && calibCountdownText){
        ctx.save();
        ctx.globalAlpha = 1;
        const msg = String(calibCountdownText);
        // 髯?・??・?・?鬮?遨ゑｽ?貊ゑ??・?郢晢??陝ｲ?髯??郢晢??郢晢??髯?閧?・?・??・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??驛｢譎｢・?・?驛｢譏ｴ?・??・?螳壽??・?・?髮・隰費??遶頑･??雜｣・?・?髫?轣倡函?・?螳夲??雜｣・?・?髯橸??郢晢??
        let anchorX = null, anchorY = null;
        try{
            if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                const visStart=eff - (playX/pxPerSec)*tempoFactor - 1;
                const visEnd  =eff + ((w-playX)/pxPerSec)*tempoFactor + 1;
                for(const n of midiGhostNotes){
                    const st=n.time, en=st+n.duration;
                    if(en<visStart || st>visEnd) continue;
                    const x1=playX+(st-eff)*pxPerSec/tempoFactor;
                    const x2=playX+((en)-eff)*pxPerSec/tempoFactor;
                    const y=h-(n.midi-vmin+1)*pxSemi;
                    anchorX = Math.max(40, Math.min(w-40, (x1+x2)/2));
                    anchorY = Math.max(40, Math.min(h-40, y - 36));
                    break;
                }
            }
        }catch(_){ }
        // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・?霑ｹ螟ｲ・?・?闕ｵ譏ｶ蜻?驍ｵ・?闕ｵ譎｢・?閾?・?・??・?・?驍ｵ・?闔会ｽ??・?讙趣??・??・?・?驍ｵ・?遶擾???・?・?陷?・?霎ｯ證ｮ蝮朱?・??・?・?陷会ｽ?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?/髣????・?・?髯樊ｻゑｽ?・?驍ｵ・??・?・?驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?
        if(anchorX==null || anchorY==null){
            if(calibAnchorActive){
                try{
                    const xRaw = playX + ((calibAnchorTime - eff) * pxPerSec/tempoFactor);
                    const yRaw = h - ((calibAnchorMidi - vmin + 1) * pxSemi);
                    anchorX = Math.max(40, Math.min(w-40, xRaw));
                    anchorY = (yRaw>=40 && yRaw<=h-40)? Math.round(yRaw - 36) : Math.floor(h*0.35);
                }catch(_){ }
            }
            if(anchorX==null || anchorY==null){ anchorX=Math.floor(w*0.5); anchorY=Math.floor(h*0.35); }
        }
        // 鬮?・?隴?・?陷搾??驛｢譏???・?郢晢??驛｢譎｢・?・?
        const fontPx = Math.floor(h*0.22);
        ctx.font = `bold ${fontPx}px sans-serif`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        const padX=18, padY=10; const metrics = ctx.measureText(msg);
        const textW = Math.max(metrics.width, fontPx*0.6);
        const boxW = Math.floor(textW + padX*2); const boxH = Math.floor(fontPx + padY*2);
        const bx = Math.floor(anchorX - boxW/2); const by = Math.floor(anchorY - boxH/2);
        ctx.fillStyle='rgba(0,0,0,0.55)';
        // 鬮?諤懷???・?・??・?・?鬩墓得??・?髯溷私??・?
        const r=12; ctx.beginPath();
        ctx.moveTo(bx+r,by); ctx.lineTo(bx+boxW-r,by); ctx.quadraticCurveTo(bx+boxW,by,bx+boxW,by+r);
        ctx.lineTo(bx+boxW,by+boxH-r); ctx.quadraticCurveTo(bx+boxW,by+boxH,bx+boxW-r,by+boxH);
        ctx.lineTo(bx+r,by+boxH); ctx.quadraticCurveTo(bx,by+boxH,bx,by+boxH-r);
        ctx.lineTo(bx,by+r); ctx.quadraticCurveTo(bx,by,bx+r,by); ctx.closePath(); ctx.fill();
        // 髫?・??・?・?髯・隴会ｽ??・?・?髢?・?陷環郢晢??驕擾???・?・?陜｣・??・?・?郢晢???・?・?驍?私??・??・?・?髯溷私??・?郢晢??郢晢??
        ctx.shadowColor='rgba(255,40,40,0.9)'; ctx.shadowBlur=12; ctx.lineWidth=8; ctx.strokeStyle='rgba(0,0,0,0.8)'; ctx.fillStyle='#fff';
        ctx.strokeText(msg, anchorX, anchorY+2);
        ctx.fillText(msg, anchorX, anchorY+2);
        ctx.shadowBlur=0;
        ctx.restore();
    }
    // 鬩搾???・?・?鬩怜雀螳??・?・??・?・?: 髴托ｽ??・?・?髯懶???・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?櫨鬪?蜊???・?髮区??・?・??・?・?驍ｵ・?鬮?・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?郢晢??陋ｹ・?邵?蜥?・?・??・?・?驛｢譎｢・?・?驛｢譎?樟郢・驛｢・??・?・?驛｢譎｢・?・?鬯?螟ｲ・?・?郢晢??郢晢??
    try{
        if(isPracticing && Array.isArray(midiGhostNotes) && midiGhostNotes.length){
            // 髴托ｽ??・?・?髯懶???・?・?髫?蠑ｱ・・け??驍ｵ・??・?・?驕ｯ・?隲帷腸・?驍ｵ・?闕ｵ譏ｶ螟｢驍ｵ・??・?・?驍ｵ・?郢晢???・?迢暦??・?郢晢??call 驛｢譎擾??・?郢晢??驛｢譎?樟郢晢??驛｢譎｢・?・?驛｢譎??・取刮・?・??・?・?驍ｵ・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?郢晢??陋ｹ・?邵?諛???譎｢・?・?鬯?・??・?・?髮・?・?・?郢晢??郢晢??
            const now = playbackPosition + timelineOffsetSec;
            let curLabel = null;
            for(const n of midiGhostNotes){
                if(n.role!=='call' || !n.label) continue;
                const st=n.time, en=n.time+n.duration;
                if(now>=st && now<=en){ curLabel=n.label; break; }
            }
            if(curLabel){
                ctx.save();
                // 鬨?蛹・??・?鬯?・??・?・?髣???闔ｨ竏??雁???・?・?髯樊ｻゑｽ?・?驍ｵ・??・?・?驛｢譏???・?郢晢??驛｢譎｢・?・?郢晢??陋ｹ・?隴?螟?ｰ帷?晢??
                const W=w, H=h; const anchorX = Math.floor(W*0.5); const anchorY = Math.floor(H*0.18);
                const fontPx = Math.max(20, Math.floor(h*0.08));
                ctx.font = `bold ${fontPx}px sans-serif`;
                ctx.textAlign='center'; ctx.textBaseline='middle';
                const txt = String(curLabel);
                const padX=14, padY=8; const metrics = ctx.measureText(txt);
                const textW = metrics.width; const boxW = Math.floor(textW + padX*2), boxH=Math.floor(fontPx + padY*2);
                const bx = Math.floor(anchorX - boxW/2), by=Math.floor(anchorY - boxH/2);
                ctx.fillStyle='rgba(0,0,0,0.55)';
                const r=10; ctx.beginPath();
                ctx.moveTo(bx+r,by); ctx.lineTo(bx+boxW-r,by); ctx.quadraticCurveTo(bx+boxW,by,bx+boxW,by+r);
                ctx.lineTo(bx+boxW,by+boxH-r); ctx.quadraticCurveTo(bx+boxW,by+boxH,bx+boxW-r,by+boxH);
                ctx.lineTo(bx+r,by+boxH); ctx.quadraticCurveTo(bx,by+boxH,bx,by+boxH-r);
                ctx.lineTo(bx,by+r); ctx.quadraticCurveTo(bx,by,bx+r,by); ctx.closePath(); ctx.fill();
                ctx.fillStyle='#ffd27d'; ctx.strokeStyle='rgba(0,0,0,0.85)'; ctx.lineWidth=4;
                ctx.strokeText(txt, anchorX, anchorY+1);
                ctx.fillText(txt, anchorX, anchorY+1);
                ctx.restore();
            }
        }
    }catch(_){ }
    // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎???・?郢晢??驛｢・??・?・?驛｢譎｢・?・?鬮?・??・?・?鬩穂ｼ夲??・?郢晢??郢晢??驍ｵ・?陝抵??郢晢??郢晢??
    try{
        ctx.save();
        const labels = Object.keys(markers||{});
        for(const k of labels){
            const t = markers[k];
            if(typeof t!=="number") continue;
            const x=playX+((t-eff)*pxPerSec/tempoFactor);
            if(x<0||x>w) continue; // 驛｢譎∽??・守､?・?譎｢・?・?髯樊ｻ薙§郢晢??驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??
            // 鬨?・??・?・?髯?螂???・?: 髣???鬯倩??・?・??・?・?驍ｵ・??・?・?髣???髣・???・?・?陋幢??・つ遶丞｣?關ｽ驍ｵ・??・?・?髣???闕ｵ譏ｶ?鬥?縺・・?・?鬩搾??陞｢・?・つ遶丞｢・??・?譎??・・
            ctx.strokeStyle = '#0ff';
            ctx.fillStyle = '#0ff';
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x-5, 10); ctx.lineTo(x+5, 10); ctx.closePath(); ctx.fill();
            ctx.beginPath(); ctx.moveTo(x, 10); ctx.lineTo(x, Math.min(24,h)); ctx.stroke();
            ctx.fillStyle='#cff'; ctx.font='11px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillText(k, x, 26);
        }
        ctx.restore();
    }catch(_){ }
    // 鬯?・??・?・?鬩墓ｨ費??譁溽坩・?譎｢・?・?驛｢譎擾??・?郢晢??髯?・??・?・?髣???驗呻??邵?讙趣??譎｢・?・?驛｢譎?蠕?・?驛｢譎｢・?・?驛｢・??・?・?
    try{
        if(isPitchOnlyMode){
            const pad = 10;
            const label = '鬯?・??・?・?鬩墓ｨ費??譁溽坩・?譎｢・?・?驛｢譏ｴ?・?;
            ctx.save();
            ctx.font = 'bold 13px sans-serif';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'top';
            const tw = ctx.measureText(label).width;
            const boxW = Math.ceil(tw + 12);
            const boxH = 22;
            const x = (chartCanvas?.width||0) - pad - boxW;
            const y = pad;
            // 鬮?・?隴?・?陷搾??郢晢??闔・?雎ｼ?鬯?・?闕ｵ蜉ｱ?・?驛｢譎｢・?・?鬮?諤懷???・?・??・?・?郢晢??郢晢??
            ctx.fillStyle = 'rgba(0,0,0,0.55)';
            const r = 8; ctx.beginPath();
            ctx.moveTo(x+r, y); ctx.lineTo(x+boxW-r, y); ctx.quadraticCurveTo(x+boxW, y, x+boxW, y+r);
            ctx.lineTo(x+boxW, y+boxH-r); ctx.quadraticCurveTo(x+boxW, y+boxH, x+boxW-r, y+boxH);
            ctx.lineTo(x+r, y+boxH); ctx.quadraticCurveTo(x, y+boxH, x, y+boxH-r);
            ctx.lineTo(x, y+r); ctx.quadraticCurveTo(x, y, x+r, y); ctx.closePath(); ctx.fill();
            // 髫?竏?・??・?・?郢晢??
            ctx.fillStyle = '#fff';
            ctx.fillText(label, x + boxW - 6, y + Math.floor((boxH-13)/2));
            ctx.restore();
        }
    }catch(_){ }
    // 髯??陷?・?陷・??驛｢譎渉・?郢晢??驛｢譏???螟ｲ・?・?陋ｹ・??・?閧?・?・?鬯俶???・し??隰?・??・?・?郢晢??
    ctx.strokeStyle='#ffffff'; ctx.beginPath(); ctx.moveTo(playX+0.5,0); ctx.lineTo(playX+0.5,h); ctx.stroke();
    // 髫????髯溷供??螽??骰具??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕?・?鬩???郢晢??陝ｲ?驛｢・?陷???・?・?髫???・?・?
    updateTimelineScrollRange();
}

// 髯??陷?・?陷・??鬩搾??陞｢・??・?・?陷?・??・?・??・?・?驍ｵ・??・?・?驍ｵ・?郢???・?迢暦??譎擾??・?郢晢??驛｢譎???・?蟶?・?・?・?髯?閧?蝮?遶城メ・?螢?・?・??・?・?髢?・??・?・??・?・?鬯?・?郢晢??・守坩・?譎｢・?・?驛｢譎牙愛陷・??驍ｵ・??・?・?驍ｵ・??・?・?郢晢??郢晢??
function setSelectionByPlayhead(){
    try{
        if(!editToolbar || editToolbar.classList.contains('hidden')) return; // 鬩搾???・?・?鬯?・?郢晢??・守坩・?譎｢・?・?驛｢譎?櫨?・?・?郢晢??
        const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes||!tr.notes.length) return;
        const sel=window._selection||{type:'none'};
        // 鬩???郢晢??陝ｲ?鬯?蛹・??・?髫?螢?・?雋ｻ・?・??・?・?驍ｵ・??・?・?鬮?・??・?・?髯?讎贋ｾ帷?晢??髫?蜴・??・?驍ｵ・?陷会ｽ?遶企?・?・?郢晢??
        if(sel.type==='range') return;
        const t = playbackPosition; // 髫?蜴・??・?髣???驗呻??郢晢??髴托ｽ??・?・?髯懶???・?・?鬩募??・?
        // 髯晢???・?・?驍ｵ・??・?・?髯??陷?・?陷・??鬩搾??陞｢・??・?・?闕ｵ譏ｴ?驛｢譎｢・?・?驛｢譎???・?螳壽・・?・?髯???迴?・つ遶擾??隨乗ｪ趣??・?闔会ｽ??・?讙趣??・??・?・?髫????鬮?螟ｧ・?・??・?蜥?・?・??・?・?驛｢譎擾??・?郢晢??驛｢譎∬??・?・?騾趣??陝ｷ謌?ｲらｹ晢??鬩搾??郢???・?・?郢晢??郢晢??鬩????・?・?驍ｵ・?闕ｵ譎｢・?閾?・?・??・?・?鬮?閧?霎ｨ陞ｻ・?驍ｵ・?隴?・?隲?蜻?豌｣隰?・??・?・?陝ｲ・??・?蟶晢??蛹・??・?髫?螢??・?
        let idx=-1;
        for(let i=0;i<tr.notes.length;i++){ const n=tr.notes[i]; if(t>=n.time && t<=n.time+n.duration){ idx=i; break; } }
        if(idx<0){
            // 髫????鬮?螟ｧ・?・??・??趣???隲・?・?・??・?・?
            let bestIdx=-1, bestDist=1e9;
            for(let i=0;i<tr.notes.length;i++){
                const n=tr.notes[i];
                const d = (t < n.time)? (n.time - t) : (t - (n.time+n.duration));
                if(d < bestDist){ bestDist=d; bestIdx=i; }
            }
            idx = bestIdx;
        }
        if(idx>=0){ setSingleSelection(idx,{audition:false}); }
    }catch(_){ }
}
// 鬯?蛹・??・?髫?螢?・?蜻・・?髫?・?陷茨???・?・?陋ｹ・?邵?蝣?・?譎｢・?・?驛｢譎｢・?・?驛｢譎?貉匁凵諤??・?・?鬯?・?郢晢?? 髫??陷諤懈?驍ｵ・??・?・?髯?・?郢?蟲??・?郢晢??郢晢??
window._selection = { type:'none', index:null, startSec:null, endSec:null };
let _rangePending = null; // {startIdx, startTime}
function setSingleSelection(idx, opts){
    const audition = (opts && opts.audition===false)? false: true;
    window._selection = { type:'single', index:idx, startSec:null, endSec:null };
    if(audition){
        try{
            const tr=currentTracks[melodyTrackIndex];
            if(tr&&tr.notes&&tr.notes[idx]){
                ensureAudio();
                const m=Math.max(36,Math.min(127,tr.notes[idx].midi));
                const d=Math.min(tr.notes[idx].duration||0.4, 0.6);
                // 鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎擾??・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?鬯?・??・?・?髮・髣??鯉ｼ・Δ???・?・?驛｢譎｢・?・?驛｢・?髮区???・?髯具???・?・?鬨?蛹・??・?驍ｵ・?遶丞｣??驢搾??・?闔会ｽ??・?讙趣??・??・?・?鬨??難??阮・・?
                if(!practiceCallGain && audioCtx){ practiceCallGain = audioCtx.createGain(); practiceCallGain.gain.value=0.9; try{ (masterGain||audioCtx.destination) && practiceCallGain.connect(masterGain||audioCtx.destination); }catch(_){ practiceCallGain.connect(audioCtx.destination); } }
                const ok = simplePlaySfz(m, (audioCtx?audioCtx.currentTime:0)+0.02, d, practiceCallGain||masterGain||audioCtx?.destination);
                if(!ok && audioCtx){
                    try{ const osc=audioCtx.createOscillator(); const g=audioCtx.createGain(); osc.frequency.value=440*Math.pow(2,(m-69)/12); g.gain.setValueAtTime(0,audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.9,audioCtx.currentTime+0.01); g.gain.linearRampToValueAtTime(0,audioCtx.currentTime+d); osc.connect(g); g.connect(practiceCallGain||masterGain||audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+d+0.02); }catch(_){ }
                }
            }
        }catch(_){ }
    }
    drawChart();
}
function setRangeSelection(aSec,bSec){ const s=Math.min(aSec,bSec), e=Math.max(aSec,bSec); window._selection = { type:'range', index:null, startSec:s, endSec:e }; drawChart(); }
function clearSelection(){ window._selection = { type:'none', index:null, startSec:null, endSec:null }; drawChart(); }
function viewToTime(x,eff,playX){ return (x - playX) / pxPerSec * tempoFactor + eff; }
function hitTestNote(x,y){ const tol=6; const rects=noteRectsGlobal||[]; for(let i=0;i<rects.length;i++){ const r=rects[i]; if(x>=r.x1 && x<=r.x2 && Math.abs(y-r.y)<=tol) return r.idx; } return null; }
// 鬩???郢晢??陝ｲ?驛｢譎擾??・?・主??・?譏ｴ?・?邵??
let draggingRange=false, dragStartX=0;
if(chartCanvas){
    // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?鬯??闔ｨ諛茨??・?驍ｵ・??・?・?髣???髮榊?・?・?闕ｵ譏ｴ笳矩Δ譎｢・?・?驛｢・??・?・?驛｢譎丞ｹ?邵?蟶昴???・?・?驛｢・??・?・?驛｢譎???譁絶落驛｢譏ｴ?・?郢晢??驛｢・?陜｣・??・?・??・?・?髯?讎?｡・・?・?陋ｹ・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?鬩???隰梧汚??・??・?・?驍ｵ・??・?・?髯?・??・?・?髯・郢晢??陜滂ｽ?郢晢??郢晢??
    let swipeYActive=false, swipeStartY=0, swipePointerId=null;
    let swipeStartRelSemi=0, swipeAllowRangeSemi=0, swipePxPerSemi=1, swipeH=1;
    chartCanvas.addEventListener('pointerdown',(e)=>{
        if(isAdjustingVOffset) return; // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴髫?・?陜｣・??・?・?隲帑ｼ夲??・??・?・?驍ｵ・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?
        // 髴托ｽ??・?・?髯懶???・?・?驍ｵ・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?髫?螟ｲ・?・?髣比ｼ夲??・?驍ｵ・?闕ｵ譎｢・?閾?・?譎??堤??驢搾??・??・?・?驛｢譎｢・?・?驕ｶ鬘假??讓????鬯?・??・?・?髯樊ｺ?蛻?鬩?・?髣???郢?閧??螟ゑ??・?陜｣・??・?・?隲?諛?・?
        const total = verticalZoom*12; // 鬮?・??・?・?鬩穂ｼ夲??・?髯?雍???竏ｵ・?・?髫?・??・?・?
        const min=36, max=132; // 髯?闌ｨ・?・?髯?侭?・?
        const allowRange = Math.max(0, (max-min-total)); // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髯?・??・?・?鬮?・??・?・?驍ｵ・??・?・?髯?雍???竏ｵ・?・?髯晢??郢晢??
        swipeAllowRangeSemi = allowRange;
        swipeH = chartCanvas.height||1;
        swipePxPerSemi = (swipeH>0 && total>0)? (swipeH/total) : 1; // px / semi
        const relSemi = (verticalOffset/100) * allowRange; // 髴托ｽ??・?・?髯懶???・?・?驍ｵ・??・?・?鬨?・??・?・?髯・?・?・?髯?雍???竏ｵ・?・?驛｢・??・?・?驛｢譎???譁絶落驛｢譏ｴ?・?郢晢??
        swipeStartRelSemi = relSemi;
        swipeYActive=true; swipeStartY=e.clientY; swipePointerId=e.pointerId; try{ chartCanvas.setPointerCapture(e.pointerId); }catch(_){ }
    });
    chartCanvas.addEventListener('pointermove',(e)=>{
        if(isAdjustingVOffset) return; // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴髫?・?陜｣・??・?・?隲帑ｼ夲??・??・?・?驍ｵ・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?
        if(!swipeYActive) return; if(swipePointerId!=null && e.pointerId!==swipePointerId) return; const dy = e.clientY - swipeStartY;
        // 驛｢譎??堤??驢搾??・??・?・?驛｢譎｢・?・?驕ｶ鬘假??讓????鬯?・??・?・?驕ｶ鄙ｫ?・? 驍ｵ・??・?・?髯樊ｺ?蛻?鬩?・?郢晢??郢晢??y > 0: 髣???闕ｵ譏ｶ?閧?・?譎擾??・?・主??・?譏ｴ?・?邵?? 驕ｶ鄙ｫ?・?鬮?・??・?・?鬩穂ｼ夲??・?鬩???郢晢??陝ｲ?驛｢・?陷・?・?・?闕ｵ譏ｶ?逎ｯ?ｧ?・?・?髯?讎?｡・・?・?隰?蠖ｳlSemi 驛｢・?髮区??・?・?隲?諛ｷ?蛹??・?郢晢??
        const deltaSemi = dy / (swipePxPerSemi||1);
        const newRelSemi = Math.max(0, Math.min(swipeAllowRangeSemi, swipeStartRelSemi + deltaSemi));
        verticalOffset = (swipeAllowRangeSemi>0)? Math.max(0, Math.min(100, Math.round((newRelSemi / swipeAllowRangeSemi)*100))) : 0;
        try{ if(typeof syncVerticalOffsetSliders==='function') syncVerticalOffsetSliders(); }catch(_){ }
        drawChart();
    });
    chartCanvas.addEventListener('pointerup',()=>{ swipeYActive=false; swipePointerId=null; });
    chartCanvas.addEventListener('pointercancel',()=>{ swipeYActive=false; swipePointerId=null; });
    chartCanvas.addEventListener('mousedown',(e)=>{
        if(isAdjustingVOffset) return; // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴髫?・?陜｣・??・?・?隲帑ｼ夲??・??・?・?驍ｵ・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?
        const rect=chartCanvas.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top;
        if(_rangePending){
            // 2髫?・??・?・?鬯?・?陷?髢・?・?髯滉ｻ??・? 鬩搾??郢?蟲?笳矩??蛹・??・?髫?螢?・?・?郢晢??驛｢譎?鯵邵?・?驛｢譎｢・?・?驍ｵ・??・?・?鬮?・?陟募??魘ｬ驍ｵ・?雋?∞??竏ｫ・?・?遶丞､?・??驍ｵ・?髦?蜷??蝣?・?・??・?・?髴取ｻゑｽ?・?鬮?霈?・?
        }
    const idx=hitTestNote(x,y); if(idx!=null){ setSingleSelection(idx,{audition:true}); }
    });
    chartCanvas.addEventListener('mousemove',(e)=>{
        if(!draggingRange) return; const rect=chartCanvas.getBoundingClientRect(); const x=e.clientX-rect.left; const eff=playbackPosition+timelineOffsetSec; const playX=(chartCanvas&&chartCanvas.width)? getPlayX(chartCanvas.width):70; setRangeSelection(viewToTime(dragStartX,eff,playX), viewToTime(x,eff,playX));
    });
    chartCanvas.addEventListener('mouseup',()=>{ draggingRange=false; });
    // 驛｢・??・?・?驛｢譏ｴ?・?郢晢??
    chartCanvas.addEventListener('touchstart',(e)=>{
        if(isAdjustingVOffset) return; // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴髫?・?陜｣・??・?・?隲帑ｼ夲??・??・?・?驍ｵ・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?
        const t=e.touches[0]; if(!t) return;
        const total = verticalZoom*12; const min=36, max=132; const allowRange=Math.max(0,(max-min-total));
        swipeAllowRangeSemi=allowRange; swipeH=chartCanvas.height||1; swipePxPerSemi=(swipeH>0 && total>0)? (swipeH/total):1; swipeStartRelSemi=(verticalOffset/100)*allowRange; swipeStartY=t.clientY;
    },{passive:true});
    chartCanvas.addEventListener('touchmove',(e)=>{
        const t=e.touches[0]; if(!t) return;
        const dy = t.clientY - (swipeStartY||t.clientY);
        const deltaSemi = dy / (swipePxPerSemi||1);
        const newRelSemi = Math.max(0, Math.min(swipeAllowRangeSemi, swipeStartRelSemi + deltaSemi));
        verticalOffset = (swipeAllowRangeSemi>0)? Math.max(0, Math.min(100, Math.round((newRelSemi / swipeAllowRangeSemi)*100))) : 0;
        try{ if(typeof syncVerticalOffsetSliders==='function') syncVerticalOffsetSliders(); }catch(_){ }
        drawChart();
        e.preventDefault();
    },{passive:false});
    chartCanvas.addEventListener('touchend',()=>{ draggingRange=false; swipeStartY=0; });
}
// 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?・??・?・?隲?肩・?・??・?・?鬯?蛹・??・?鬨?蛹・??・?郢晢??隰紋ｼ夲??・?12郢晢??郢晢??
function applyOctaveShift(delta){
    const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes||!tr.notes.length) return;
    const notes=tr.notes; const clamp=(m)=> Math.max(36,Math.min(127,m));
    const sel=window._selection;
    if(sel.type==='single' && sel.index!=null){
        const idx=sel.index;
        const applyForward = !!(applyForwardToggle && applyForwardToggle.checked);
        const endIdx = applyForward? findPhraseEndIndex(idx): idx;
        for(let i=idx;i<=endIdx;i++){ notes[i].midi = clamp(notes[i].midi + delta); }
        setSingleSelection(idx);
    } else if(sel.type==='range' && sel.startSec!=null && sel.endSec!=null){
        for(let i=0;i<notes.length;i++){
            const st=notes[i].time, en=st+notes[i].duration;
            if(!(en<sel.startSec || st>sel.endSec)){
                notes[i].midi = clamp(notes[i].midi + delta);
            }
        }
    }
    autoCenterMelodyTrack();
    drawChart();
}
function applySemitoneShift(delta){
    autoCenterFrozen = true; // 髣比ｼ夲??・?鬯?・?鬮?・?郢晢??鬮?・??・?・?髯??趣??譁絶落驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・?髮区?樣・髮・?・?・?
    const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes||!tr.notes.length) return;
    // 鬩搾???・?・?鬯?・?郢晢??・守坩・?譎｢・?・?驛｢譎?????・??・?・?驍ｵ・??・?・?驍ｵ・?遶乗劼・?・?雋????・?・?隶吩??・?・?髯????らｫ頑･?諤呵悋??陷・??鬩搾??陞｢・??・?・?闕ｵ譏ｴ?驛｢譎｢・?・?驛｢譎?樟?冗｣?・?蛹・??・?髫?螢?・?・??・?螳壽・隴?・?隰・郢晢??髢?・??・?・?郢晢??陝ｲ?鬯?蛹・??・?髫?螢?・?雋ｻ・?・??・?・?驍ｵ・??・?・?鬩搾???・?・?髫?謔ｶ?・??・?・?郢晢??
    try{
        if(editToolbar && !editToolbar.classList.contains('hidden')){
            const selNow = window._selection || {type:'none'};
            if(selNow.type !== 'range'){ setSelectionByPlayhead(); }
        }
    }catch(_){ }
    const notes=tr.notes; const clamp=(m)=> Math.max(36,Math.min(127,m)); const sel=window._selection;
    if(sel.type==='single' && sel.index!=null){
        const idx=sel.index; const applyForward = !!(applyForwardToggle && applyForwardToggle.checked);
        const endIdx = applyForward? findPhraseEndIndex(idx): idx;
        for(let i=idx;i<=endIdx;i++){ notes[i].midi = clamp(notes[i].midi + delta); }
        if(!applyForward){ try{ ensureAudio(); const m=clamp(notes[endIdx].midi); const d=Math.min(notes[endIdx].duration||0.4,0.6); simplePlaySfz(m,(audioCtx?audioCtx.currentTime:0)+0.02,d,masterGain||audioCtx?.destination); }catch(_){ } }
        setSingleSelection(idx,{audition:false});
    } else if(sel.type==='range' && sel.startSec!=null && sel.endSec!=null){
        for(let i=0;i<notes.length;i++){ const st=notes[i].time,en=st+notes[i].duration; if(!(en<sel.startSec || st>sel.endSec)){ notes[i].midi = clamp(notes[i].midi + delta); } }
    }
    autoCenterMelodyTrack();
    // 驛｢譎擾??・?郢晢??驛｢譎会ｽ?・?郢晢??髯具??陷会ｽ?遯?・?髯樊ｺ?・?・??・?蜀暦??・??・?・?驍ｵ・?雋???・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・?陋幢??・取㏍・?・??・?・?驛｢譏ｴ?・?郢晢??
    scheduleAll(); if(isPlaying){ pausePlayback(); startPlayback(); } else { drawChart(); }
}
// 驛｢・??・?・?驛｢譎｢・?・?驛｢譎?鯵郢晢??驛｢譎牙愛隴??髣???郢晢?? 驕ｶ鄙ｫ?・?驕ｶ鄙ｫ?・??・?繧托ｽ?・?12驍ｵ・?郢晢??hift髣????・?・?鬨?蛹・??・?驍ｵ・??・?・?髣比ｼ夲??・?鬯?・?鬮?・?遶企豪・?・?郢?驫?螳??蛹・??・?
window.addEventListener('keydown',(e)=>{ if(e.key==='ArrowUp' || e.key==='ArrowDown'){ const delta=(e.key==='ArrowUp')? +12 : -12; if(window._selection.type==='single' && window._selection.index!=null && e.shiftKey){ const prev=applyForwardToggle? applyForwardToggle.checked: false; if(applyForwardToggle) applyForwardToggle.checked=true; applyOctaveShift(delta); if(applyForwardToggle) applyForwardToggle.checked=prev; } else { applyOctaveShift(delta); } e.preventDefault(); } });
window.addEventListener('keydown',(e)=>{ if(e.key==='ArrowUp' || e.key==='ArrowDown'){ const delta=(e.key==='ArrowUp')? +12 : -12; if(window._selection.type==='single' && window._selection.index!=null && e.shiftKey){ const prev=applyForwardToggle? applyForwardToggle.checked: false; if(applyForwardToggle) applyForwardToggle.checked=true; applyOctaveShift(delta); if(applyForwardToggle) applyForwardToggle.checked=prev; } else { applyOctaveShift(delta); } e.preventDefault(); } else if(e.key==='[' || e.key===']'){ const d=(e.key===']')? +1 : -1; applySemitoneShift(d); e.preventDefault(); } });
// 髫?證ｦ・?・?髴難???・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?蠕?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?ON/OFF: O 驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯具??郢晢???・?鬘假??蜴・??・?驍ｵ・?郢晢??
window.addEventListener('keydown',(e)=>{ if(e.key==='o' || e.key==='O'){ scorePitchClassOverlay = !scorePitchClassOverlay; drawChart(); } });
// 驛｢・??・?・?驛｢・??・?・?驛｢譎擾??・?邵?蟶?・?譎会ｽ?・?郢晢??驛｢譎?諛?・?髫?蜴・??・?驍ｵ・??・?・?髯溷?懶??・?隰??髴取ｻゑｽ?・?髯?莨夲??・?髯具??郢晢??
// 驛｢譎?鯵邵?・?驛｢譎｢・?・?
if(clearSelectionBtn){ clearSelectionBtn.onclick=()=> clearSelection(); }
if(octDownBtn){ octDownBtn.onclick=()=> applyOctaveShift(-12); }
if(octUpBtn){ octUpBtn.onclick=()=> applyOctaveShift(+12); }

// 髯晢???・?・?鬩????・?・?驍ｵ・??・?・?髯?闌ｨ・?・?髣???髦?蜷?窶?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§郢晢??驛｢・??・?・?驛｢譎｢・?・?郢晢??髣鯉ｽ??・?・?郢晢??郢晢??隰?・??・?・?郢晢?? 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢譎?樟?主??・?譏ｴ?・?邵?鬘梧??・?・?髣???髦?蜻?・?謚ｵ・?繧托ｽ?・?12鬩募???・?髯?髦??・?
const globalOctUpBtn = document.getElementById('globalOctUpBtn');
const globalOctDownBtn = document.getElementById('globalOctDownBtn');
function shiftAllMelodyNotes(delta){
    try{
        const tr = currentTracks[melodyTrackIndex];
        if(!tr || !Array.isArray(tr.notes) || !tr.notes.length) return;
        const clamp = (m)=> Math.max(36, Math.min(127, m));
        for(let i=0;i<tr.notes.length;i++){
            tr.notes[i].midi = clamp((tr.notes[i].midi|0) + delta);
        }
        // 鬮?・??・?・?髯??趣??譁絶落驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?髣比ｼ夲??・?鬯?・?隶主??驟ｪ髮・?・?・?郢晢??陋ｹ・?・主?・?譎｢・?・?驛｢・??・?・?髫?・?闕ｳ讒ｫ・?蜥擾??・?髮区?樒?髯?驛∬??・?・?郢晢??
        autoCenterFrozen = true;
        // 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髫?蜴・??・?髫???・?・?驍ｵ・??・?・?髯??髢?・?驍ｱ蟶敖蛹・??・?
        scheduleAll(); if(isPlaying){ pausePlayback(); startPlayback(); } else { drawChart(); }
    }catch(_){ }
}
function updateGlobalOctButtonsTooltip(){
    try{
        const up = document.getElementById('globalOctUpBtn');
        const dn = document.getElementById('globalOctDownBtn');
        if(!up || !dn) return;
        if(practiceMode==='basic'){
            up.title = '髯憺屮・?・?鬩慕甥・?闌ｨ・?・??・?・?鬩怜生?・? 髫俶誓??・?鬩墓?・?・?鬩搾??陞｢・?邵?螳茨??・??・?・?驛｢譎擾??・?郢晢??鬮?・??・?・?鬩穂ｼ夲??・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§?・??+12郢晢??騾趣??雎ｬ・?驍ｵ・??・?・?髯樊ｺ?・?・??・?蜀暦??・?驗呻??遶擾??驍ｵ・?陝ｶ蜻?・?阮・・?郢晢??;
            dn.title = '髯憺屮・?・?鬩慕甥・?闌ｨ・?・??・?・?鬩怜生?・? 髫俶誓??・?鬩墓?・?・?鬩搾??陞｢・?邵?螳茨??・??・?・?驛｢譎擾??・?郢晢??鬮?・??・?・?鬩穂ｼ夲??・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§?・??-12郢晢??騾趣??雎ｬ・?驍ｵ・??・?・?髯樊ｺ?・?・??・?蜀暦??・?驗呻??遶擾??驍ｵ・?陝ｶ蜻?・?阮・・?郢晢??;
        } else {
            up.title = '驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??髯?闌ｨ・?・?髣???髦?蜻?・??+12郢晢??髢?・??・?・??・?・?鬯?・?郢晢???・?・?郢晢??;
            dn.title = '驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??髯?闌ｨ・?・?髣???髦?蜻?・??-12郢晢??髢?・??・?・??・?・?鬯?・?郢晢???・?・?郢晢??;
        }
    }catch(_){ }
}
if(globalOctUpBtn){
    globalOctUpBtn.onclick = ()=>{
        if(practiceMode==='basic'){
            practiceCallDisplayOctShift = (practiceCallDisplayOctShift|0) + 12;
            // 鬮?・??・?・?鬩穂ｼ夲??・?鬩???郢晢??陝ｲ?驛｢・?郢??驍顔距??・?闕ｳ蟯?髮?驍ｵ・??・?・?髯・郢晢??隨?迢暦??・?陷茨???・?・?鬩・?・?・?闕ｵ譎｢・??驍ｵ・?陷?・??・??髯???・?・?髯?驛∬??・?・?郢晢??
            try{
                if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                    let gMin=Infinity, gMax=-Infinity;
                    for(const n of midiGhostNotes){ const mm=(n.role==='call')? (n.midi + (practiceCallDisplayOctShift|0)) : n.midi; if(mm<gMin) gMin=mm; if(mm>gMax) gMax=mm; }
                    if(isFinite(gMin) && isFinite(gMax)) setVerticalOffsetToRange(gMin, gMax);
                }
            }catch(_){ }
            drawChart();
        } else {
            shiftAllMelodyNotes(+12);
        }
        updateGlobalOctButtonsTooltip();
    };
}
if(globalOctDownBtn){
    globalOctDownBtn.onclick = ()=>{
        if(practiceMode==='basic'){
            practiceCallDisplayOctShift = (practiceCallDisplayOctShift|0) - 12;
            try{
                if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                    let gMin=Infinity, gMax=-Infinity;
                    for(const n of midiGhostNotes){ const mm=(n.role==='call')? (n.midi + (practiceCallDisplayOctShift|0)) : n.midi; if(mm<gMin) gMin=mm; if(mm>gMax) gMax=mm; }
                    if(isFinite(gMin) && isFinite(gMax)) setVerticalOffsetToRange(gMin, gMax);
                }
            }catch(_){ }
            drawChart();
        } else {
            shiftAllMelodyNotes(-12);
        }
        updateGlobalOctButtonsTooltip();
    };
}
// 髯?雍???竏ｵ・?・?驛｢譎?鯵邵?・?驛｢譎｢・?・?
const semiDownBtn=document.getElementById('semiDownBtn');
const semiUpBtn=document.getElementById('semiUpBtn');
if(semiDownBtn){ semiDownBtn.onclick=()=> applySemitoneShift(-1); }
if(semiUpBtn){ semiUpBtn.onclick=()=> applySemitoneShift(+1); }
// 鬩搾???・?・?鬯?・?郢晢??・守坩・?譎｢・?・?驛｢譎擾??・?郢晢??鬮?・??・?・?鬩穂ｼ夲??・?髯具??郢晢??陝蟶・・?闔・?郢晢??髫?蟶?・?蛟･?・?鬯?・?隶・?・?・??・?・?鬩穂ｼ夲??・?郢晢??陝ｲ・?・つ郢??郢晢??驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・? show/hide 驛｢・?陋幢??郢晢??驛｢・??・?・?驛｢譎｢・?・?
if(editModeToggle){
    editModeToggle.onclick=()=>{
        if(!editToolbar) return;
        if(editToolbar.classList.contains('hidden')){
            editToolbar.classList.remove('hidden');
            editToolbar.style.display='flex';
            // 鬩搾???・?・?鬯?・?郢晢??・守坩・?譎｢・?・?驛｢譎擾??・?遶頑･?諤??・?・?驍ｵ・??・?・?驍ｵ・?雋?∞????諤??・?・?驍ｵ・?遶乗亢?・?鬨??難??・??・?・?陞｢・??・?・?闕ｵ譏ｴ?驛｢譎｢・?・?驛｢譎???・?蟶晢??蛹・??・?髫?螢??・?
            setSelectionByPlayhead();
        } else {
            editToolbar.classList.add('hidden');
            editToolbar.style.display='none';
        }
    };
}

// Undo/Redo 驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?邵??
const undoStack=[]; const redoStack=[]; const MAX_HISTORY=100;
function snapshotNotes(){ try{ const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes) return null; return tr.notes.map(n=>({midi:n.midi,time:n.time,duration:n.duration})); }catch(_){ return null; } }
function pushHistory(){ const snap=snapshotNotes(); if(!snap) return; undoStack.push(snap); if(undoStack.length>MAX_HISTORY) undoStack.shift(); redoStack.length=0; }
function restoreFromSnap(snap){ try{ const tr=currentTracks[melodyTrackIndex]; if(!tr) return; tr.notes = snap.map(n=>({midi:n.midi,time:n.time,duration:n.duration})); autoCenterMelodyTrack(); drawChart(); }catch(_){ }}
function doUndo(){ if(!undoStack.length) return; const current=snapshotNotes(); const prev=undoStack.pop(); if(current) redoStack.push(current); restoreFromSnap(prev); }
function doRedo(){ if(!redoStack.length) return; const current=snapshotNotes(); const next=redoStack.pop(); if(current) undoStack.push(current); restoreFromSnap(next); }
if(undoBtn){ undoBtn.onclick=()=> doUndo(); }
if(redoBtn){ redoBtn.onclick=()=> doRedo(); }
// 驛｢譎擾??・?郢晢??驛｢譏???・?郢晢??髯?????・?: 髯??陷?・?陷・??鬩搾??陞｢・??・?・?陷?・??・?・??・?・?驍ｵ・??・?・?髴托ｽ??・?・?髯懶???・?・?驛｢譎擾??・?郢晢??驛｢譎???・??2驍ｵ・??・?・?驍ｵ・??・?・?髯具??郢晢??霑夲??
function splitCurrentNoteAtPlayhead(){
    try{
        const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes||!tr.notes.length) return;
        const t=playbackPosition; const notes=tr.notes;
        // 髯??陷?・?陷・??鬩搾??陞｢・??・?・?闕ｵ譏ｴ?驛｢譎｢・?・?驛｢譎乗ｲ?霎ｷ・?鬩肴得??・?
        let idx=-1; for(let i=0;i<notes.length;i++){ const n=notes[i]; if(t>n.time && t<n.time+n.duration){ idx=i; break; } }
        if(idx<0) return; const n=notes[idx];
        const rel = t - n.time; const remain = n.duration - rel; const MIN_DUR=0.05; // 50ms 髫?蟷?・?・?髮・・つ驍ｵ・??・?・?髯具??郢晢??霑夲??驍ｵ・?陷会ｽ?遶企?・?・?郢晢??
        if(rel<MIN_DUR || remain<MIN_DUR) return; // 鬩????・?・?驍ｵ・?陷?・?驍?驍ｵ・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?
        pushHistory();
        // 髯?蛹??・?郢晢??驛｢譎｢・?・?驛｢譎???・?螳壽≧隶朱?托ｽ??驍ｵ・??・?・?鬩墓得??・?鬩搾???・?・?驍ｵ・?隲?諛ｶ・?・?隰疲?難???驛｢譎擾??・?郢晢??驛｢譎???・?螳夲??蜴・??・?髯?闌ｨ・?・?
        n.duration = rel;
        const newNote = { midi:n.midi, time:t, duration:remain };
        notes.splice(idx+1,0,newNote);
        // 髯溷?難??雜｣・?・?陞｢・?遯?・? time 鬯??郢晢??邵?蝣?・?・?郢???・?迢暦??・?髦?蜷??蟶昴???・?・?髫?謔ｶ?・??・?・?陜捺?・飴驍ｵ・??・?・? time=t 髣比ｼ夲??・?鬯?・?鬮?・?遶企?・?・??・?・?驍ｵ・??・?・?OK郢晢??郢晢??
        setSingleSelection(idx+1,{audition:false});
        scheduleAll(); drawChart();
    }catch(_){ }
}
const splitBtn=document.getElementById('splitNoteBtn'); if(splitBtn){ splitBtn.onclick=()=>{ splitCurrentNoteAtPlayhead(); }; }
// Ctrl+Z / Ctrl+Y
window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ doUndo(); e.preventDefault(); } else if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='y'){ doRedo(); e.preventDefault(); } });

// 髫?・?陜｣・??・?・?隲幢??霎ｯ諷???・??・?・?髯橸???・?・?髮・?・?・?髣???隴取得??・?陋??・?・?陋ｹ・?邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎擾??諛?螳??蛹・??・?髫?蠑ｱ・・・?・?郢晢??
const _applyOctaveShiftOrig = applyOctaveShift;
applyOctaveShift = function(delta){ pushHistory(); _applyOctaveShiftOrig(delta); };
// 髫?・?陜｣・??・?・?隲幢??霎ｯ諷???・??・?・?髯橸???・?・?髮・?・?・?髣???隴取得??・?陋??・?・?陋ｹ・?邵?讙趣??・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?髯?雍???竏ｵ・?・?鬯?蛹・??・?鬨?蛹・??・?髫?蠑ｱ・・・?・?郢晢??
const _applySemitoneShiftOrig = applySemitoneShift;
applySemitoneShift = function(delta){ pushHistory(); _applySemitoneShiftOrig(delta); };
function snapshotNotes(){ try{ const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes) return null; const notesSnap=tr.notes.map(n=>({midi:n.midi,time:n.time,duration:n.duration})); const marks={}; Object.keys(markers||{}).forEach(k=>{ const v=markers[k]; if(typeof v==='number') marks[k]=v; }); return {notes:notesSnap, markers:marks}; }catch(_){ return null; } }
function restoreFromSnap(snap){ try{ const tr=currentTracks[melodyTrackIndex]; if(!tr) return; if(Array.isArray(snap)){ tr.notes = snap.map(n=>({midi:n.midi,time:n.time,duration:n.duration})); } else if(snap && Array.isArray(snap.notes)){ tr.notes = snap.notes.map(n=>({midi:n.midi,time:n.time,duration:n.duration})); if(snap.markers){ Object.keys(snap.markers).forEach(k=>{ const v=snap.markers[k]; if(typeof v==='number') markers[k]=v; }); } } autoCenterMelodyTrack(); drawChart(); }catch(_){ }}

// 髫?蜴・??・?驍ｵ・?隴∫???蝣?・?・??・?・?鬮?・?隲?肩・?・??・?・?髣???隴取得??・?郢晢??髯溷桁??・?髯?蛹??・??・?・?郢晢??ocalStorage郢晢??郢晢??
function getSongKey(){ try{ const n=(melodyAudioLabel&&melodyAudioLabel.textContent)||'unknown'; const d=Math.round((melodyBuffer&&melodyBuffer.duration)||0); return 'corr:'+n+':'+d; }catch(_){ return 'corr:unknown'; } }
// 髫??会ｽ?・?: 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟?取ｨ抵??譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?鬮?・?隲?肩・?・??・?・?髣???隴取得??・?郢晢??髯溷桁??・?髯?蛹??・?郢晢??髯?蜿?・?竏晄?・

// MIDI髯?・?郢?蟲??・?驍ｵ・??・?・?鬮?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?驍ｵ・??・?・?鬯?・??・?・?髯?閧??螂???・?隲?肩・?・??・?・?郢晢??陋ｹ・?郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?邵???・?蛹・??・?髫?螢?・?・??・?・??・?・?髯滂ｽ?隲幢???・?・?郢晢??
if(midiRefBtn && midiRefInput){ midiRefBtn.onclick=()=> midiRefInput.click(); }
let _midiTracksCache=null; // [{notes:[{midi,st,en}], index}]
let _midiAlign={ detIdx:0, refIdx:0, scale:1.0 };
if(midiRefInput){ midiRefInput.onchange=async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
        const arr=await f.arrayBuffer();
        const parsed = parseMidiAllTracks(new Uint8Array(arr)); // [{notes:[{midi,st,en}], index}]
    if(!parsed || !parsed.length){ console.warn('MIDI驍ｵ・?闕ｵ譎｢・???諢?郢?蟲??・?驛｢譎?樟?主??・?譏ｴ?・?邵?驢搾??・?陷?闌ｨ・?・?隲幢??郢晢??驍ｵ・??・?・?驍ｵ・?鬮?・?遶擾??驍ｵ・?陝ｶ蜻?・?骰具??・??・?・?驍ｵ・?陷会ｽ?隨??'); return; }
        _midiTracksCache = parsed;
        if(parsed.length===1){
            // 髯?髮・??・?・?・つ驛｢譎?樟?主??・?譏ｴ?・?邵?驢搾??・??・?・?驛｢・?郢?鄙ｫ?・?髯?閧?蝮?遶????蛹・??・?驍ｵ・?陝ｶ蜷???驍ｵ・?遶丞｣?遨宣し??陞｢・?郢晢??髯?闌ｨ・?・?髣???髦?蜷??・?驛｢譎｢・?・?驛｢譎∽??・守､?・?譎｢・?・?郢晢??鬩・?・?・??・?・?驍ｵ・??・?・?鬩墓?・?・?鬩搾??陞滂ｽ??・?・?陝ｲ・??・?蟶晏??・?・?鬩穂ｼ夲??・?郢晢??髢?・??・?・?陋幢??郢晢??驛｢譎｢・?・?驛｢・??・?・?郢晢??郢晢??
            const refNotesSec = normalizeMidiToSeconds(parsed[0].notes);
            let mapped = applyAlignMapping(refNotesSec);
            mapped = Array.isArray(mapped)? mapped.slice().sort((a,b)=>a.time-b.time): [];
            midiGhostNotes = mapped;
            drawChart();
            // 驛｢譎?樟?主??・?譏ｴ?・?邵???・?蛹・??・?髫?螢?・?・?郢晢??鬨?・?遶擾??隰・・諢??・?・?驍ｵ・??・?・?驍ｵ・?陟募仰郢晢??遶????蛹・??・?/鬨??難??阮・・?驍ｵ・??・?・?髯区??隱?驍擾??UI驍ｵ・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?
            if(midiTrackSelect){ midiTrackSelect.style.display='none'; }
            if(midiApplyBtn){ midiApplyBtn.style.display='inline-block'; }
            if(midiGenerateBtn){ midiGenerateBtn.style.display='inline-block'; }
            buildAlignDropdowns(refNotesSec);
            if(midiAlignPanel) midiAlignPanel.style.display='flex';
        } else {
            // 驛｢譎?樟?主??・?譏ｴ?・?邵???・?蛹・??・?髫?螢?諢オ驛｢・?陞ｳ螟ｲ・?・??・?・?鬩穂ｼ夲??・?
            if(midiTrackSelect){
                midiTrackSelect.innerHTML='';
                parsed.forEach((tr, i)=>{
                    const opt=document.createElement('option');
                    opt.value=String(i);
                    opt.textContent=`MIDI Track ${i+1} (${tr.notes.length} notes)`;
                    midiTrackSelect.appendChild(opt);
                });
                midiTrackSelect.selectedIndex=0;
                midiTrackSelect.style.display='inline-block';
                // 驛｢譎?樟?主??・?譏ｴ?・?邵???・?蛹・??・?髫?螢?・?・?邵?蝣?・?・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎乗ｲ?陝ｲ・?髫???・?・?
                midiTrackSelect.onchange=()=>{
                    try{
                        const idx = midiTrackSelect.selectedIndex||0;
                        const refNotesSec = normalizeMidiToSeconds(_midiTracksCache[idx].notes);
                        let mapped = applyAlignMapping(refNotesSec);
                        mapped = Array.isArray(mapped)? mapped.slice().sort((a,b)=>a.time-b.time): [];
                        midiGhostNotes = mapped;
                        drawChart();
                    }catch(_){ }
                };
            }
            if(midiApplyBtn){ midiApplyBtn.style.display='inline-block'; }
            if(midiGenerateBtn){ midiGenerateBtn.style.display='inline-block'; }
            const refNotesSec = normalizeMidiToSeconds(parsed[0].notes);
            // 驛｢譎?樟?主??・?譏ｴ?・?邵???・?蛹・??・?髫?螢?・?髮・・?髴難???・?・?驍ｵ・??・?・?髯?闌ｨ・?・?髣???髦?蜷??・?驛｢譎｢・?・?驛｢譎∽??・守､?・?譎｢・?・?郢晢??髢?・??・?・?陋幢??郢晢??驛｢譎｢・?・?驛｢・??・?・?郢晢??郢晢??
            let mapped0 = applyAlignMapping(refNotesSec);
            mapped0 = Array.isArray(mapped0)? mapped0.slice().sort((a,b)=>a.time-b.time): [];
            midiGhostNotes = mapped0;
            drawChart();
            buildAlignDropdowns(refNotesSec);
            if(midiAlignPanel) midiAlignPanel.style.display='flex';
        }
    }catch(err){ console.warn('MIDI髯?・?郢?蟲??・?驍ｵ・??・?・?鬮?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?驍ｵ・??・?・?髯樊ｻゑｽ?・?髫?・?郢晢??', err); }
}; }
if(midiApplyBtn){ midiApplyBtn.onclick=()=>{
    if(!_midiTracksCache || !_midiTracksCache.length) return;
    const idx = Math.max(0, Math.min(_midiTracksCache.length-1, (midiTrackSelect && midiTrackSelect.selectedIndex) || 0));
    const refNotesRaw = normalizeMidiNotesForAlign(_midiTracksCache[idx].notes);
    const refNotes = applyAlignMapping(refNotesRaw);
    // 鬯?蛹・??・?鬨?蛹・??・?髫?蠑ｱ・・?晢??驛｢譎丞ｹ?・取ｨ抵??譎∽??・守､?・?譎｢・?・?驛｢・?陷?闌ｨ・?・?陋ｹ・?隨・
    midiGhostNotes = null;
    pushHistory(); alignOctaveToReferenceDP(refNotes);
    drawChart();
}; }
// MIDI驍ｵ・?闕ｵ譎｢・?閾?・?譎擾??・?郢晢??驛｢譏ｴ?・?陷・??髫?蠕?・?
if(midiGenerateBtn){ midiGenerateBtn.onclick=()=>{
    if(!_midiTracksCache || !_midiTracksCache.length){ console.warn('髯???迴?遶頑ｺ?IDI驛｢・?陞ｳ螟ｲ・?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驛｢・?髦?蜷??蝣?・?・?闕ｳ蟯?蜻?驍ｵ・?髴???・??'); return; }
    const idx = Math.max(0, Math.min(_midiTracksCache.length-1, (midiTrackSelect && midiTrackSelect.selectedIndex) || 0));
    const ref = _midiTracksCache[idx];
    // 鬨??難??阮・・?髯???迴?郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢譎?樟?主??・?譏ｴ?・?邵??
    const notesRaw = normalizeMidiToSeconds(ref.notes);
    const notes = applyAlignMapping(notesRaw);
    if(!Array.isArray(notes) || !notes.length){ console.warn('MIDI驍ｵ・?闕ｵ譎｢・???・?蟶?逕･隴?・・?・??・?・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・??・?蟶敖?難??阮・・?驍ｵ・??・?・?驍ｵ・?鬮?・?遶擾??驍ｵ・?陝ｶ蜻?・?骰具??・??・?・?驍ｵ・?陷会ｽ?隨??'); return; }
    // 髴托ｽ??・?・?髯懶???・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢譎?樟?主??・?譏ｴ?・?邵?驢搾??・??・?・?鬩励???・?髫??郢晢??
    pushHistory();
    currentTracks[melodyTrackIndex] = { notes: notes.map(n=>({ midi:n.midi, time:n.time, duration:n.duration })) };
    // 驛｢譎擾??・?郢晢??驛｢譏ｴ?・?郢晢??鬩励???・?髫??郢晢?? 鬮?・??・?・?髯??趣??譁絶落驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・?髮区???・?髫?蟶?逕･隴??悟ｳ?隰費???・??驍ｵ・??・?・?鬯?蛹・??・?鬨?蛹・??・?
    autoCenterFrozen = false;
    autoCenterMelodyTrack();
    // 鬨??難??阮・・?髯溷供??蠕?・?驛｢譎丞ｹ?・取ｨ抵??譎∽??・守､?・?譎｢・?・?驛｢・?陷?闌ｨ・?・?陋ｹ・?隨・
    midiGhostNotes = null;
    drawChart();
    // 髫?蠕｡・?蜥擾??・?驛｢譎｢・?・?驛｢譏ｴ?・?邵?譎会ｽ?譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?驛｢謨鳴驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?驍ｵ・?陷会ｽ?遶企?・?・?郢晢??
}; }

function normalizeMidiNotesForAlign(trackNotes){
    // [{midi, st, en}] -> [{midi, time, duration}] 鬨?・??・?・?髯・?・?・?tick驛｢譎??郢晢??驛｢・??・?・?驍ｵ・??・?・?驛｢・?陋ｹ・??・??
    if(!Array.isArray(trackNotes) || !trackNotes.length) return [];
    const minT = Math.min(...trackNotes.map(n=>n.st));
    return trackNotes.map(n=>({ midi:n.midi, time:(n.st-minT), duration:(n.en-n.st) }));
}

// 髯・?・?・?髯滂ｽ?隲・?・?・??・?・?髫?・??・?・?: UI髫?蝣?霍?・?・?闔ｨ螟ｲ・?・?闔・?郢晢??鬯???・?・?驍ｵ・?郢晢???・?・?驍ｵ・??・?・?驍ｵ・?闕ｵ譏ｴ?・?髯区???・・?・?隲帛･・??蟶晏??・?・?鬩穂ｼ夲??・?郢晢??郢晢??
function buildAlignDropdowns(refNotes){
    try{
        if(!midiAlignDetStart || !midiAlignRefStart) return;
        // 鬮?證ｦ・?・?髫?・?闔牙??・?郢晢??陜捺?ゑｽ?・?隲幢??郢晢??髮九?迴?遶擾??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??郢晢??郢晢??
        const det = (currentTracks[melodyTrackIndex]?.notes)||[];
        const detOpts = det.map((n,i)=>({ i, label:`#${i+1} ${noteLabel(n.midi)} @${n.time.toFixed(2)}s` }));
        midiAlignDetStart.innerHTML='';
        detOpts.slice(0,200).forEach(o=>{ const opt=document.createElement('option'); opt.value=String(o.i); opt.textContent=o.label; midiAlignDetStart.appendChild(opt); });
        // 髯?・?郢?蟲??・?髯句??・?・?郢晢??郢晢??IDI郢晢??郢晢??
        const refOpts = refNotes.map((n,i)=>({ i, label:`#${i+1} ${noteLabel(n.midi)} t${n.time}` }));
        midiAlignRefStart.innerHTML='';
        refOpts.slice(0,200).forEach(o=>{ const opt=document.createElement('option'); opt.value=String(o.i); opt.textContent=o.label; midiAlignRefStart.appendChild(opt); });
        // 髫??会ｽ?・?髯橸??郢晢??
        midiAlignDetStart.value='0'; midiAlignRefStart.value='0';
        _midiAlign={ detIdx:0, refIdx:0, scale:1.0 };
        if(midiAlignScale) midiAlignScale.value='1.0';
        updateAlignInfo();
        // 驛｢・??・?・?驛｢譎??・趣??驛｢譏ｴ?・?
        const onAlignChanged = ()=>{
            updateAlignInfo();
            // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎乗ｲ?陝ｲ・?髫???・?・?郢晢??髢?・?隶捺??闊?・?・?鬯?蛹・??・?髫?螢?・?雋ｻ・?・??・?・?驛｢譎?樟?主??・?譏ｴ?・?邵?鬘梧・・?・?髯???迴?・つ遶丞｣??驢搾??・?闔会ｽ??・?讙趣??・??・?・?髯?閧?・?・??・?・??・?・?郢晢??郢晢??
            try{
                const idx = (midiTrackSelect && midiTrackSelect.style.display!=='none')? (midiTrackSelect.selectedIndex||0) : 0;
                const src = (_midiTracksCache && _midiTracksCache.length)? _midiTracksCache[Math.max(0,Math.min(idx,_midiTracksCache.length-1))]: null;
                const base = src? normalizeMidiToSeconds(src.notes): refNotes;
                let mapped = applyAlignMapping(base);
                mapped = Array.isArray(mapped)? mapped.slice().sort((a,b)=>a.time-b.time): [];
                midiGhostNotes = mapped;
                drawChart();
            }catch(_){ }
        };
        midiAlignDetStart.onchange=()=>{ _midiAlign.detIdx=parseInt(midiAlignDetStart.value)||0; onAlignChanged(); };
        midiAlignRefStart.onchange=()=>{ _midiAlign.refIdx=parseInt(midiAlignRefStart.value)||0; onAlignChanged(); };
        if(midiAlignScale){ midiAlignScale.oninput=()=>{ _midiAlign.scale=parseFloat(midiAlignScale.value)||1.0; onAlignChanged(); }; }
        if(midiAlignFitEnds){
            midiAlignFitEnds.onclick=()=>{
                try{
                    // 髴托ｽ??・?・?髯懶???・?・?驍ｵ・??・?・?鬯?蛹・??・?髫?螢?・?・?郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?邵?莉｣?・?陋ｹ・?遶企?・?・?闔会ｽ??・?讙趣??・??・?・?髯?閧?・?・??・?・??・?・?郢晢??陝ｲ・?・ゑｽ?驛｢・?霑壼衷??恷・??・?・?MIDI郢晢??髢?・??・?・?陋幢??郢晢??驛｢譎｢・?・?驛｢・??・?・?郢晢??陝ｲ・??・?螳壽╂鬮???・?・?郢晢??
                    const idx = (midiTrackSelect && midiTrackSelect.style.display!=='none')? (midiTrackSelect.selectedIndex||0) : 0;
                    const src = (_midiTracksCache && _midiTracksCache.length)? _midiTracksCache[Math.max(0,Math.min(idx,_midiTracksCache.length-1))]: null;
                    if(!src) return;
                    const ref = normalizeMidiToSeconds(src.notes);
                    if(!ref.length) return;
                    // 髫??隲幢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??郢晢??闔・??・?・?雋???驛｢譎｢・?・?驛｢譏ｴ?・??・?・?郢晢??
                    const det = (currentTracks[melodyTrackIndex]?.notes)||[];
                    if(!det.length) return;
                    // 髯?閧?・?・??・?・??・?・?驍ｵ・??・?・?髫????髯溷供??蠕?・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・?郢晢??髫?蠑ｱ・玖?・?
                    const detT0 = det[0].time;
                    const detT1 = det[det.length-1].time + det[det.length-1].duration;
                    const refT0 = ref[0].time;
                    const refT1 = ref[ref.length-1].time + ref[ref.length-1].duration;
                    const detSpan = Math.max(1e-6, detT1 - detT0);
                    const refSpan = Math.max(1e-6, refT1 - refT0);
                    // 髴托ｽ??・?・?髣皮甥・?髮?・?・?陋滂ｽ?郢晢?? applyAlignMapping 驍ｵ・??・?・? detIdx/refIdx 驛｢・?陞ｳ螟ｲ・?・??・?・?髴難???・?・?驍ｵ・??・?・?驍ｵ・?陷?・??・?迢暦??・??・?・?驛｢譎???譁絶落驛｢譏ｴ?・?郢晢??驛｢・?郢??陋ｻ閧?・?・?陋ｹ・??・?迢暦??・?郢晢??
                    // 髣????・?・?鬩????・?・?髯?・?陋ｹ・??・?蜀暦??・?陝ｶ蜷??・?髫?・?闕ｳ讒ｫ・?蜥擾??・??・?・?髯?・?陋ｹ・??・?蜀暦??・?陝ｶ蜻?・?迢暦??・?雋?∞??竏ｫ・?・?遶擾???・?・??・?・?髴難???・?・?驍ｵ・??・?・?0驍ｵ・??・?・?髯懈圜・?・?髯橸??陞｢・??・??驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・?鬩阪?ﾂ諛?・?驍ｵ・?陷会ｽ?・つ郢?譖ｵ驍ｵ・??・?・?驛｢・?郢??雋ょ????謫?・?・?驍ｵ・?郢晢??
                    _midiAlign.detIdx = 0;
                    _midiAlign.refIdx = 0;
                    const scale = detSpan / refSpan;
                    _midiAlign.scale = scale;
                    if(midiAlignScale){ midiAlignScale.value = String(scale.toFixed(3)); }
                    onAlignChanged();
                }catch(_){ }
            };
        }
    }catch(e){ console.warn('buildAlignDropdowns failed', e); }
}
function updateAlignInfo(){
    try{
    if(!midiAlignInfo) return;
    midiAlignInfo.textContent = `det#${_midiAlign.detIdx+1} 驕ｶ髦??・?ref#${_midiAlign.refIdx+1}, scale ${_midiAlign.scale.toFixed(3)}`;
    }catch(_){ }
}
// 鬮?・??・?・?髫?・??・?・?鬯?蛹・??・?鬨?蛹・??・?: refNotes/time驛｢・?陋幢??・つ驗ゑ??ef驍ｵ・??・?・?髫俶誓??・?髴難???・?・?驕ｶ髮・??繻フ驍ｵ・??・?・?髫俶誓??・?髴難???・?・?驍ｵ・?鬮?・?遶頑･???陋ｹ・??・?蜀暦??・?陝ｶ蜊債遶乗楓ﾂ陷?・?驍擾??scale驍ｵ・??・?・?髣費???・?・?鬩搾???・?・?
function applyAlignMapping(refNotes){
    try{
        if(!Array.isArray(refNotes)||!refNotes.length) return refNotes;
        const det = (currentTracks[melodyTrackIndex]?.notes)||[];
        const di = Math.max(0, Math.min(det.length-1, _midiAlign.detIdx|0));
        const ri = Math.max(0, Math.min(refNotes.length-1, _midiAlign.refIdx|0));
        const scale = (typeof _midiAlign.scale==='number' && isFinite(_midiAlign.scale) && _midiAlign.scale>0)? _midiAlign.scale: 1.0;
        const detT0 = det[di]? det[di].time: 0;
        const refT0 = refNotes[ri]? refNotes[ri].time: 0;
        return refNotes.map(n=>({
            midi: n.midi,
            time: detT0 + (n.time - refT0) * scale,
            duration: (n.duration||0) * scale
        }));
    }catch(_){ return refNotes; }
}

// MIDI tick 驕ｶ鄙ｫ?・?鬩募??・?髯樊ｺ?蛻?鬩?・?驛｢・?陷・?・?・??・?・?驍ｵ・?郢晢??陷・??髫?譴?閻??・?・?闔蛹・??・??・?・?: 驛｢譏ｴ?・?・趣??驛｢譏ｴ?・?00ms/髯懈懶??蟶・・?鬯?・??・?・?鬮?・??・?・?鬨?・??・?・?髯溷・萓ｭ邵?蝣?・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・? or 鬯?・??・?・?髯橸???・?・?鬯?貊ゑ??・?驍ｵ・??・?・?髯?・?陋ｹ・??・?蜀暦??・?陝ｶ蜻?・?荵・・?郢晢??
function normalizeMidiToSeconds(trackNotes){
    // 髫?莨夲??・?髯橸??郢晢?? 鬯?・??・?・?髯橸???・?・?驍ｵ・??・?・?鬯?貊ゑ??・?驍ｵ・?髴域喚?讌｢??陋ｹ・??・?蜀暦??・?陝ｶ蜷??・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??陋ｹ・?・朱豪・?譎｢・?・?驛｢譏ｴ?・?邵??鬯?・??・?・?髯橸???・?・?驍ｵ・?陟募??譌ｺ驛｢・?陟募?・・?驍ｵ・?隴擾??隨・驛｢・?陝ｲ・??・?螳壽・・?・?髯?驛∬??・?・?郢晢??
    if(!Array.isArray(trackNotes) || !trackNotes.length) return [];
    const stMin = Math.min(...trackNotes.map(n=>n.st));
    const stMax = Math.max(...trackNotes.map(n=>n.en));
    const tickSpan = Math.max(1, stMax - stMin);
    const audioSpan = (melodyBuffer?.duration) || (accompBuffer?.duration) || 60; // 鬯?・??・?・?髯橸???・?・?驍ｵ・?隶吝ｯ???驍ｵ・?闔会ｽ??・?讙趣??・??・?・?髣比ｼ夲??・?驍ｵ・??・?・?60鬩募??・?
    const scale = audioSpan / tickSpan;
    return trackNotes.map(n=>({ midi:n.midi, time:(n.st-stMin)*scale, duration:(n.en-n.st)*scale }));
}

// 髯?・?郢?蟲??・?MIDI驍ｵ・??・?・?髯・?・?・?驍ｵ・?陷会ｽ?・つ遶乗?蜉帝ｨ?・?郢晢???・?・?髢?・?陋ｻ・?髮取?・??青謚ｵ・?繧托ｽ?・?12髫?・??・?・?髯?・?髣鯉ｽ??・?・?騾趣??・つ?・?・?鬩搾??陞｢・?・つ?・?・?鬯?・?陝雜｣・?・?陷???・?・?郢晢??
function alignOctaveToReferenceDP(ref){
    try{
        const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes||!tr.notes.length) return;
        const notes=tr.notes;
        const N=Math.min(ref.length, notes.length); if(N<=0) return;
        // 髯?・?郢晢??郢晢??驛｢譎｢・?・?驛｢譎?樟?頑･?豎?・?・?驍ｵ・?陷会ｽ?遯?・?髯区???・・?・?郢晢?? m+12k, k in {-2,-1,0,1,2}
        const K=[-2,-1,0,1,2];
        const C=new Array(N); // costs
        const P=new Array(N); // backpointers
        const LAMBDA_JUMP=3.0;   // 鬯?・??・?・?髫?證ｦ・?・?驛｢譎擾??・?郢晢??驛｢譎会ｽ?・?闖ｫ・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§邵?螟ゑ??譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ?郢晢??鬩励???・?
        const LAMBDA_DIFF=0.8;   // ref驍ｵ・??・?・?驍ｵ・??・?・?髯?雍???竏ｵ・?・?髯晢???・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏???蛹・??・?郢?閧???
        const LAMBDA_OCT=0.6;    // ?・?繧托ｽ?・?12驍ｵ・?隴擾??郢晢??驛｢・?郢??郢晢??驍ｵ・??・?・?鬩励???・?
        for(let i=0;i<N;i++){
            C[i]=new Array(K.length).fill(Infinity);
            P[i]=new Array(K.length).fill(-1);
            const refM=ref[i].midi;
            for(let a=0;a<K.length;a++){
                const m0 = notes[i].midi + K[a]*12;
                const d = Math.abs(m0 - refM);
                const octAbs = Math.abs(K[a]);
                const obs = LAMBDA_DIFF * d + LAMBDA_OCT * octAbs; // 鬮?蛹・??・?髮九ｑ??・?驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?
                if(i===0){ C[i][a]=obs; continue; }
                // 鬯?蛹・??・?鬩募???・?驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?
                let best=Infinity, bestA=-1;
                for(let b=0;b<K.length;b++){
                    const trans = LAMBDA_JUMP * Math.abs(K[a]-K[b]);
                    const val = C[i-1][b] + obs + trans;
                    if(val<best){ best=val; bestA=b; }
                }
                C[i][a]=best; P[i][a]=bestA;
            }
        }
        // 髯溷供???会ｽ??取?闔会ｽ?遯?・?驍ｵ・??・?・?髫????雎ｼ・??・?・?髯具??陷会ｽ??・?螳・蛹・??・?髯?蛹??・?
        let lastA=0, lastCost=Infinity;
        for(let a=0;a<K.length;a++){ if(C[N-1][a]<lastCost){ lastCost=C[N-1][a]; lastA=a; } }
        for(let i=N-1;i>=0;i--){
            const k=K[lastA];
            notes[i].midi = notes[i].midi + k*12;
            lastA = (i>0? P[i][lastA]: -1);
            if(lastA<0 && i>0){ // 驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?
                let best=0, cost=Infinity; for(let a=0;a<K.length;a++){ if(C[i-1][a]<cost){ cost=C[i-1][a]; best=a; } } lastA=best;
            }
        }
    }catch(_){ /* ignore */ }
}

// 鬩・?・?・?髫?荵暦??・?IDI驛｢譏???・?郢晢??驛｢・??・?・?髯?闌ｨ・?・?驛｢譎?樟?主??・?譏ｴ?・?邵?鬘鯉ｽ?螟願か?・?・?郢晢??ype0/1郢晢??郢晢?? 髯?・?郢晢??郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?邵?驢搾??・??・?・?NoteOn/Off驛｢・?陷?蝓滂ｽ?讌｢諤・・?・?
function parseMidiAllTracks(u8){
    try{
        const dv=new DataView(u8.buffer,u8.byteOffset,u8.byteLength);
        let p=0; function readStr(len){ let s=''; for(let i=0;i<len;i++) s+=String.fromCharCode(dv.getUint8(p++)); return s; }
        function readU32(){ const v=dv.getUint32(p); p+=4; return v; }
        function readU16(){ const v=dv.getUint16(p); p+=2; return v; }
        if(readStr(4)!=='MThd') return [];
        const hdrLen=readU32(); const format=readU16(); const ntr=readU16(); const division=readU16(); p = 8+6; // skip to after header
        const tracks=[];
        for(let t=0;t<ntr;t++){
            const id=readStr(4); const len=readU32(); if(id!=='MTrk'){ p+=len; continue; }
            const end=p+len; let curTime=0; let runningStatus=0; const events=[];
            function readVar(){ let v=0; while(true){ const b=dv.getUint8(p++); v=(v<<7)|(b&0x7F); if(!(b&0x80)) break; } return v; }
            while(p<end){ const dt=readVar(); curTime+=dt; let st=dv.getUint8(p++); if(st<0x80){ p--; st=runningStatus; } else { runningStatus=st; }
                if((st&0xF0)===0x90 || (st&0xF0)===0x80){ const note=dv.getUint8(p++); const vel=dv.getUint8(p++); events.push({t:curTime, type:(st&0xF0), note, vel}); }
                else if(st===0xFF){ const meta=dv.getUint8(p++); const len=readVar(); p+=len; }
                else { const hi=st&0xF0; const cons = (hi===0xC0||hi===0xD0)? 1: 2; p+=cons; }
            }
            const onMap=new Map(); const notes=[];
            events.forEach(ev=>{
                if(ev.type===0x90 && ev.vel>0){ onMap.set(ev.note, ev.t); }
                else if((ev.type===0x80) || (ev.type===0x90 && ev.vel===0)){ const st=onMap.get(ev.note); if(st!=null){ notes.push({midi:ev.note, st, en:ev.t}); onMap.delete(ev.note); } }
            });
            tracks.push({ index:t, notes });
        }
        return tracks.filter(tr=> tr.notes && tr.notes.length>0).sort((a,b)=> b.notes.length - a.notes.length);
    }catch(_){ return []; }
}

// 髫??会ｽ?・?API: 鬩・?・?・?髫?荵暦??・?IDI驛｢譏???・?郢晢??驛｢・??・?・?郢晢??郢晢??ype0/1, 髯?髮・・??・?・?雎墓ぁ?・?晢??郢晢?? 髫????驛｢・?郢?蛹?・?・?髫?・??・?・?驍ｵ・??・?・?髯樊ｺ?・?・??・?讓抵??譎｢・?・?驛｢譎擾??・?郢晢??驛｢・??・?・?驛｢譏???譏ｴ?暮Δ???・?・?鬮?螟ｧ蠎?・?・??・?・?驛｢譎?樟?主??・?譏ｴ?・?邵?驢搾??・?陋幢??・朱豪・?譎｢・?・?驛｢譏ｴ?・?邵??驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?郢晢??
function parseMidiMelody(u8){
    // 髣懈瑳蜑?・?・?陋滂ｽ?遶企?・?・?陷会ｽ?郢晢??鬮?諛?・??・?・??・?・?髫?荵暦??・??・?・??・?・?驍ｵ・??・?・?髯?・?隰費???・?鄙ｫ?・?闔・??・?・?隰疲?・・?髯・?・?・?髯滂ｽ?隲帷???蝣?・?・??・?・?驍ｵ・??・?・?驍ｵ・?郢晢???・?・?陝ｲ・?・つ郢???・?・??・?・?髫?・?驍???陷・??驍ｵ・??・?・?鬩????・?・?鬯?貊難??鄙ｫ?・?驍ｵ・?郢晢??
    try{
        // 驍ｵ・?髦?蜻?・??驍ｵ・??・?・?驍ｵ・??・?・?鬩・?・?・?鬨?・??・?・?髯具??隰費??郢晢??驍ｵ・?雋?∞??竏ｫ・?・?遶擾??鬩?迹壽??屐??郢晢??MIDI鬮?證ｦ・?・?髫?・?髣??・・?髫????髯・陜謎ｸ?蠢憺し???・?・?驛｢譎渉・?郢晢??驛｢謨鳴驍ｵ・??・?・?驛｢譏ｴ?・?・取刮・?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・?・ゑｽ?oteOn/Off驍ｵ・??・?・?驍ｵ・??・?・?髯・?・?・?髯滂ｽ?郢晢??
        // 髯橸??雋?・ゑｽ?鬨?蛹・??・?驍ｵ・??・?・?鬩榊･・??・?髯溯??・?・?驍ｵ・?隰疲?ゑｽ?・?郢晢???・?・?遶丞｣??驢搾??・?霑壼遜??・?陞滓?螟ゑ??譎｢・?・?驛｢・??・?・?驛｢譎?§・主??・?譎｢・?・?髯・闕ｳ・?郢晢??驛｢・?陷?闌ｨ・?・?隲・?・?・?郢晢??
        const dv=new DataView(u8.buffer,u8.byteOffset,u8.byteLength);
        let p=0; function readStr(len){ let s=''; for(let i=0;i<len;i++) s+=String.fromCharCode(dv.getUint8(p++)); return s; }
        function readU32(){ const v=dv.getUint32(p); p+=4; return v; }
        function readU16(){ const v=dv.getUint16(p); p+=2; return v; }
        if(readStr(4)!=='MThd') return [];
        const hdrLen=readU32(); const format=readU16(); const ntr=readU16(); const division=readU16(); p = 8+6; // 髯?閧?・?・??・?・??・?・?驍ｵ・?闕ｵ譎｢・?閾?・?・??・?・?鬨?・??・?・?髯・?・?・?
        const tracks=[];
        for(let t=0;t<ntr;t++){
            const id=readStr(4); const len=readU32(); if(id!=='MTrk'){ p+=len; continue; }
            const end=p+len; let curTime=0; let runningStatus=0; const events=[];
            function readVar(){ let v=0; while(true){ const b=dv.getUint8(p++); v=(v<<7)|(b&0x7F); if(!(b&0x80)) break; } return v; }
            while(p<end){ const dt=readVar(); curTime+=dt; let st=dv.getUint8(p++); if(st<0x80){ p--; st=runningStatus; } else { runningStatus=st; }
                if((st&0xF0)===0x90 || (st&0xF0)===0x80){ const note=dv.getUint8(p++); const vel=dv.getUint8(p++); events.push({t:curTime, type:(st&0xF0), note, vel}); }
                else if(st===0xFF){ const meta=dv.getUint8(p++); const len=readVar(); p+=len; }
                else { // 驍ｵ・?隴擾??郢晢??髣泌ｳ??・? 鬯?貊ゑ??・?驍ｵ・?陟?屮・?・??・?・?驛｢・?遶擾??鬩・驍ｵ・??・?・?髯???・?・?鬨??郢晢??
                    const hi=st&0xF0; const cons = (hi===0xC0||hi===0xD0)? 1: 2; p+=cons; }
            }
            // NoteOn/Off 驍ｵ・?闕ｵ譎｢・?閾?・?譎擾??・?郢晢??驛｢譎?樟?・
            const onMap=new Map(); const notes=[];
            events.forEach(ev=>{
                if(ev.type===0x90 && ev.vel>0){ onMap.set(ev.note, ev.t); }
                else if((ev.type===0x80) || (ev.type===0x90 && ev.vel===0)){ const st=onMap.get(ev.note); if(st!=null){ notes.push({midi:ev.note, st, en:ev.t}); onMap.delete(ev.note); } }
            });
            tracks.push({notes});
        }
        // 髫????驛｢・?郢??郢晢??驛｢譎｢・?・?驛｢譎乗ｲ?霎溷?ゑｽ?・??・?・?髯樊ｺ?・?・??・?讓抵??譎?樟?主??・?譏ｴ?・?邵?驢搾??・?陷?蝓滂ｽ?・?鬨?蛹・??・?
        tracks.sort((a,b)=> (b.notes.length)-(a.notes.length));
        const picked=(tracks[0]?.notes)||[]; if(!picked.length) return [];
        // 髫?蠑ｱ・玖?・?髮・?・?・?鬮?遨ゑｽ?讒ｫ?・?晢??郢晢??ivision髣比ｼ夲??・?髯橸??郢晢?? 480ticks/髯懈懶??蟶・・? 驕ｶ霈?・?120bpm驍ｵ・??・?・?鬩穂ｼ應ｺ蛾??・?鬩阪??蟷?郢晢??髣???髢?・?郢晢??驕ｶ髮・・??・?・??・?・?鬨?・??・?・?髯・?・?・?髮手ご・?????・?郢晢??遶頑･?謚?・?・?驍ｵ・?郢晢??隨??驛｢・?遶擾???・?・?騾?・?驍擾??驍ｵ・??・?・?驍ｵ・??・?・?髯具???・?・?鬨?蛹・??・?郢晢??郢晢??
        // 髯橸??雋???騾?驢搾??・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢・??・?・?驍ｵ・??・?・?MIDI驍ｵ・??・?・?髫?・??・?・?髯?・?陋ｹ・?遶企豪・?譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎???・?郢晢??驛｢・??・?・?驛｢譎｢・?・?/鬯???・?・?髯?・?陋ｹ・??・?蜀暦??・?陝ｶ蜻?・?螳壽割?・?・?驍ｵ・?郢晢??郢晢??驍ｵ・?霑ｹ螢??・?驍ｵ・?郢晢??
        const minT=Math.min(...picked.map(n=>n.st));
        const res=picked.map(n=>({ midi:n.midi, time:(n.st-minT), duration:(n.en-n.st) }));
        return res;
    }catch(_){ return []; }
}

// 髯?・?郢?蟲??・?MIDI驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?§?・?螳夲??・??・?・?髯?・?髣鯉ｽ??・?・?髢?・?陟咲霜豎?・?・?鬨?・?郢晢??遶頑･?・????驛｢・?郢?螂???・?闔会ｽ??・?讖ｸ・?繧托ｽ?・?12驍ｵ・??・?・?郢晢??郢晢??
function alignOctaveToReference(ref){ return alignOctaveToReferenceDP(ref); }
function noteLabel(midi){
    const namesCDE=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const namesDo=['驛｢譏ｴ?・?,'驛｢譏ｴ?・?','驛｢譎｢・?・?','驛｢譎｢・?・?#','驛｢譏ｴ?・?,'驛｢譎???譁撰?・,'驛｢譎???譁撰?・','驛｢・??・?・?','驛｢・??・?・?#','驛｢譎｢・?・?','驛｢譎｢・?・?#','驛｢・??・?・?'];
    const names = labelNotation==='驛｢譎擾??・?・取ｨ抵??譏ｴ?・?? namesDo : namesCDE; const o=Math.floor(midi/12)-1; return names[midi%12]+o; }
// 髫??会ｽ?・?驛｢譏ｴ?・?・趣??驛｢譎???隴幢??鬯?・??・?・?驛｢・?陷???・?・?髯?・??・?・?驍ｵ・?郢??郢晢??驛｢譎｢・?・?驛｢譎会ｽ?・?郢晢??髯具??陷会ｽ?郢晢??鬩募?・?讚?・?髣???郢晢??time/duration 驍ｵ・??・?・?驍ｵ・??・?・?驛｢・?陷・?・?・??・?・?鬨?蛹・??・?驍ｵ・?郢晢??
function buildTimesFromTicks(){ /* no-op: MIDI髫?・??・?・?髯?・??・?・? */ }

// ---- 驛｢・??・?・?驛｢譎擾??・?郢晢??驛｢・??・?・?驛｢・??・?・?髫?蛹・??・?郢晢?? ----
function noteName(pc){
    const namesCDE=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const namesDo=['驛｢譏ｴ?・?,'驛｢譏ｴ?・?','驛｢譎｢・?・?','驛｢譎｢・?・?#','驛｢譏ｴ?・?,'驛｢譎???譁撰?・,'驛｢譎???譁撰?・','驛｢・??・?・?','驛｢・??・?・?#','驛｢譎｢・?・?','驛｢譎｢・?・?#','驛｢・??・?・?'];
    const arr = labelNotation==='驛｢譎擾??・?・取ｨ抵??譏ｴ?・?? namesDo : namesCDE;
    return arr[((pc%12)+12)%12];
}
function buildAdviceText(){
    if(!scoreStats || scoreStats.total<5) return '驛｢譏ｴ?・?郢晢??驛｢・??・?・?驍ｵ・?隰疲?・??蜻??慕ｹ晢??邵?蝣?・?・??・?・?驍ｵ・?郢???・?鬘費??・??・?・?驍ｵ・?陝ｶ蜻?・?骰具??・?郢??遶擾??驍ｵ・?陞｢・?郢晢??髯??陷?・?陷・??驍ｵ・?陷会ｽ?遯?・?髮寂?・?螽?螟｢驍ｵ・??・?・?驍ｵ・?闕ｳ蟯?蜻?驍ｵ・?髴???・?讓抵??・?郢晢??;
    const hi=[], lo=[], stable=[], unstable=[];
    for(let pc=0; pc<12; pc++){
        const b=scoreStats.bins[pc]; if(!b||b.count<3) continue;
        const avg=b.sum/b.count; const avgAbs=b.sumAbs/b.count; const tolRate=(b.inTol/Math.max(1,b.count));
        if(avg>=5 && b.sharp > b.flat) hi.push({pc, avg});
        if(avg<=-5 && b.flat > b.sharp) lo.push({pc, avg});
        if(avgAbs<=6 && tolRate>=0.75) stable.push({pc, tolRate});
        if(avgAbs>=12 && tolRate<0.6) unstable.push({pc, avgAbs});
    }
    hi.sort((a,b)=> Math.abs(b.avg)-Math.abs(a.avg));
    lo.sort((a,b)=> Math.abs(b.avg)-Math.abs(a.avg));
    stable.sort((a,b)=> b.tolRate-a.tolRate);
    unstable.sort((a,b)=> b.avgAbs-a.avgAbs);
    const fmtList=(arr, prop, suffix='')=> arr.slice(0,6).map(o=> `${noteName(o.pc)}${suffix}`).join(' ');
    const totalIn = scoreStats.bins.reduce((s,b)=> s + (b?.inTol||0), 0);
    const totalCnt = scoreStats.bins.reduce((s,b)=> s + (b?.count||0), 0);
    const hitRate = totalCnt? (totalIn/totalCnt*100) : 0;
    const lines=[];
    if(hi.length) lines.push(`鬯?・?陋滂ｽ??・??: ${fmtList(hi,'avg')}`);
    if(lo.length) lines.push(`髣???陟托???・??: ${fmtList(lo,'avg')}`);
    if(unstable.length) lines.push(`髣???隶主?・??・?霑壼遜??・?郢晢?? ${fmtList(unstable,'avgAbs')}`);
    if(stable.length) lines.push(`髯橸??霑壼遜??・?郢晢?? ${fmtList(stable,'tolRate')}`);
    lines.push(`髯?・??・?・?髣????・?・?鬩・郢晢?? ${hitRate.toFixed(1)}%`);
    if(hi.length||lo.length||unstable.length){
        lines.push('髯・?・?・?鬩???郢晢?? 鬯?・??・?・?髯?闌ｨ・?・?郢晢??騾趣??雎ｬ・?驍ｵ・??・?・?髯?闌ｨ・?・?驛｢・?陞??・?・?陝ｲ・??・?螳壼初?乗劼・?・??・?・?驍ｵ・??・?・?驍ｵ・?郢?蜈ｷ・?・?陋滂ｽ??・?竏ｫ・?髮∽?臥?晢??髯懶???・?・?驛｢・?陷?蝓滓ｻ矩Δ??遶丞｣??鬥?譴??・?・?驍ｵ・??・?・?鬨?・?・つ驍ｵ・?闕ｵ譏ｶ髮?驛｢・?郢晢??/ 髣???陟托???・?竏ｫ・?鬘假??讖ｸ・?・??・?・?髯晢???・?・?驛｢・?陜｣・??・?・?闕ｵ譏ｶ阡馴藍??驗呻???・?・?驍ｵ・??・?・?髫??会ｽ?・?驛｢・?遶丞｣??讌｢諤??・?・?鬯?????・?驛｢譎???邵??驛｢譎｢・?・?驛｢譎?樟?剰ご??・?郢晢??);
    } else {
        lines.push('雎ｼ・??・?・?髯槭???・?: 髯樊ｻゑｽ?・?驍ｵ・?鬮?・?遶??悟ｱ∬叉螂・??鬘費??・??・?・?驍ｵ・?郢???・?鬘費??・??・?・?驍ｵ・?陝ｶ蜻?・?骰具??・?郢???・??驍ｵ・??・?・?鬮?・??・?・?髯・髣??個蝣?・?譎???驥・?抵??譎｢・?・?驛｢・??・?・?鬩搾??郢?莨夲??・??・?・?驍ｵ・??・?・?髯?・?陟托??遶擾??驛｢・?驗呻???・?蟶敖雜｣・?・?驍ｵ・?鬮?・?遶擾??驍ｵ・?陷会ｽ??・??驍ｵ・?郢晢??・つ郢晢??);
    }
    return lines.join('\n');
}
function drawAdviceBars(){ /* 驛｢・??・?・?驛｢譎｢・?・?驛｢譎擾??髮?・?・?雋???郢晢??驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?鬮?陬懈桶隰泌調・?・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?髯具??郢晢??*/ if(_adviceCtx&&adviceCanvas){ try{ _adviceCtx.clearRect(0,0,adviceCanvas.width, adviceCanvas.height); }catch(_){ } } }
function openAdvice(){ if(advicePanel) advicePanel.style.display='block'; if(adviceTextEl) adviceTextEl.textContent = buildAdviceText(); /* 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丈ｾ?脂荵滂ｽ?・??・?・?髯???・?・?驍ｵ・?隲?諛??朱??・??・?・? */ }
function closeAdvice(){ if(advicePanel) advicePanel.style.display='none'; }
if(adviceBtn){ adviceBtn.onclick = ()=> openAdvice(); }
if(adviceCloseBtn){ adviceCloseBtn.onclick = ()=> closeAdvice(); }

// 驛｢譎???・?邵??驛｢・??・?・?髯橸??霑壼遜??・?陞｢・?陜滂ｽ?驛｢譎渉・?・取刮・?譎?惧?・?・?騾趣??陝ｷ證ｮ・?・?陝ｲ・?遶??壽?秘ｫ??郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵?驢搾??・??・?・?鬯?・?陝ｲ・?・ゑｽ?驛｢・?陷茨???・?・?郢晢??
(function(){
    try{
        const micHelpBtn = document.getElementById('micHelpBtn');
        const micHelpPanel = document.getElementById('micHelpPanel');
        const micHelpClose = document.getElementById('micHelpClose');
        if(!micHelpPanel) return; // 驛｢譏???・?郢晢??驛｢譎｢・?・?驍ｵ・?隶吝ｯ???驍ｵ・?闔会ｽ??・?讙趣??・??・?・?髣???髴???・?繧会ｽ?・?陷会ｽ?遶企?・?・?郢晢??
        function openMicHelp(){ micHelpPanel.style.display='block'; }
        function closeMicHelp(){ micHelpPanel.style.display='none'; }
        if(micHelpBtn){
            micHelpBtn.addEventListener('click', (e)=>{
                e.stopPropagation();
                const isOpen = micHelpPanel.style.display !== 'none' && micHelpPanel.style.display !== '';
                if(isOpen) closeMicHelp(); else openMicHelp();
            });
        }
        if(micHelpClose){
            micHelpClose.addEventListener('click', (e)=>{ e.stopPropagation(); closeMicHelp(); });
        }
        // 驛｢譏???・?郢晢??驛｢譎｢・?・?髯樊ｻ薙§邵?驢搾??譎｢・?・?驛｢譏ｴ?・?邵?驢搾??・??・?・?鬯?・?陝ｲ・?・ゑｽ?驛｢・?陷茨???・?・?闔蛹・??・?隰費??郢晢??驛｢譎樔ｺゑｾ取刮・?・??・?・?驍ｵ・??・?・?髯溷私??・?鬯?・??・?・?驛｢・?陝ｶ譏ｶ闌?し??闔会ｽ??・?荵・・?郢晢??
        document.addEventListener('click', (e)=>{
            try{
                if(!micHelpPanel || micHelpPanel.style.display==='none') return;
                const t = e.target;
                if(t instanceof Node){
                    if(micHelpPanel.contains(t)) return; // 髯??郢晢??郢晢??驍ｵ・??・?・?驛｢・?髢?・??・?・??・?・?髫?謔ｶ?・?
                    if(micHelpBtn && micHelpBtn.contains && micHelpBtn.contains(t)) return; // 驛｢譎?鯵邵?・?驛｢譎｢・?・?鬮?・??・?・?髣???郢晢??
                }
                closeMicHelp();
            }catch(_){ /* ignore */ }
        });
        // Esc 驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?鬯?・?陝ｲ・?・ゑｽ?驛｢・?郢晢??
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeMicHelp(); } });
    }catch(e){ console.warn('micHelp wiring failed', e); }
})();

// 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?貉匁刮・?譎渉・?・取刮・?譎?惧?・?・?騾趣??陝ｷ證ｮ・?・?陝ｲ・?遶??壽?秘ｫ??郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??/Esc驍ｵ・??・?・?鬯?・?陝ｲ・?・ゑｽ?驛｢・?陷茨???・?・?郢晢??
(function(){
    try{
        const helpBtn = document.getElementById('globalHelpBtn');
        const panel = document.getElementById('globalHelpPanel');
        const closeBtn = document.getElementById('globalHelpClose');
        if(!panel) return;
        function openHelp(){ panel.style.display='block'; }
        function closeHelp(){ panel.style.display='none'; }
        if(helpBtn){
            helpBtn.addEventListener('click', (e)=>{
                e.stopPropagation();
                const isOpen = panel.style.display !== 'none' && panel.style.display !== '';
                if(isOpen) closeHelp(); else openHelp();
            });
        }
        if(closeBtn){ closeBtn.addEventListener('click', (e)=>{ e.stopPropagation(); closeHelp(); }); }
        document.addEventListener('click', (e)=>{
            if(!panel || panel.style.display==='none') return;
            const t = e.target;
            if(t instanceof Node){
                if(panel.contains(t)) return;
                if(helpBtn && helpBtn.contains && helpBtn.contains(t)) return;
            }
            closeHelp();
        });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeHelp(); } });
    }catch(e){ console.warn('globalHelp wiring failed', e); }
})();

// 髯?髮・・?雎ｬ・?郢晢??陋ｹ・?・守坩・?譎擾??・?郢晢??驛｢・??・?・?驛｢譏???譏ｴ?暮Δ???・?・?郢晢??陝ｲ・?郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?邵?鬘鯉ｽ??隲幢??郢晢??: 髯?・?隴?・?陷・??鬨?蜈ｷ・?・?鬯?・??・?・?驍ｵ・?隶吝ｯ???驍ｵ・?郢晢??郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?邵?驢搾??・?陞ｳ螟ｲ・?・?隴∫????郢晢??鬩・?・?・?郢晢??霎溷?ゑｽ?・?郢???・??匁捗?・?・?髯?・?陋ｹ・?郢晢??驛｢譎擾??・?郢晢??驛｢譎乗ｲ?霎溷?ゑｽ?・?隰疲?ゑｽ?・?陞｢・??・?讓｣・??郢晢???・?・?郢晢??
function findMonophonicTracks(){
    const res=[];
    currentTracks.forEach((tr,idx)=>{
        const notes=(tr.notes||[]).slice().sort((a,b)=>a.time-b.time);
        if(!notes.length) return;
        let ok=true; let lastEnd=-Infinity;
        for(const n of notes){ if(n.time < lastEnd - 1e-6){ ok=false; break; } lastEnd = Math.max(lastEnd, n.time + n.duration); }
        if(ok) res.push({idx, count: notes.length});
    });
    res.sort((a,b)=> b.count - a.count);
    return res.map(o=>o.idx);
}

function autoSelectMelodyTrackIfMonophonic(){
    const monos=findMonophonicTracks();
    if(monos.length){
        melodyTrackIndex=monos[0];
        populateTrackSelectors();
    }
}

// 驛｢譎?樟?主??・?譏ｴ?・?邵?驢搾??・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・?陜｣・?隶捺??闊?・?・?驍ｵ・??・?・?鬮?・?隲橸??隰??髯??郢晢???・?・??・?・?驍ｵ・??・?・?髫?蜴・??・?髫???・?・?郢晢??鬩・?・?・?遶擾???・?・??・?・?驍ｵ・?隶吝ｯ???驍ｵ・?闔会ｽ??・?讙趣??・??・?・?鬲・??逕溽?・??驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??郢晢??郢晢??
function populateTrackSelectors(){
    try{
        const tracks = Array.isArray(currentTracks)? currentTracks: [];
        // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??鬯?蛹・??・?髫?螢?・?・?郢晢??驛｢譎｢・?・?驛｢謨鳴驛｢・??・?・?驛｢譎｢・?・?
        if(melodySel){
            // 髫??会ｽ?・?髯・陋滂ｽ??・?蝣?・?・??・?・?驛｢譎｢・?・?驛｢・??・?・?
            while(melodySel.firstChild) melodySel.removeChild(melodySel.firstChild);
            tracks.forEach((t, i)=>{
                const opt=document.createElement('option');
                const count = (t && Array.isArray(t.notes))? t.notes.length: 0;
                opt.value=String(i);
                opt.textContent = `Track ${i+1} (${count} notes)`;
                if(i===melodyTrackIndex) opt.selected=true;
                melodySel.appendChild(opt);
            });
            // 鬩???郢晢??陝ｲ?髯樊ｻ薙§遶企?・?・?郢晢??驍ｵ・??・?・?髣????・?・?驛｢・?郢晢??
            const idx = Math.max(0, Math.min(melodyTrackIndex, Math.max(0, tracks.length-1)));
            melodySel.value = String(idx);
        }
        // 髣費???・?・?髯槭??閾・・?・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?郢晢??髢?・?隶捺??闊?・?・?驍ｵ・??・?・?鬮?・??・?・?驍ｵ・??・?・?髯?・?隰費???・?鬘俶??郢?閾?闊樣し???・?・?鬮?・?隲幢??陷搾??鬮?・??・?・?鬩穂ｼ夲??・?郢晢??郢晢??
        if(accompSel){
            while(accompSel.firstChild) accompSel.removeChild(accompSel.firstChild);
            const opt=document.createElement('option');
            opt.value='auto';
            const accompCount = tracks.reduce((a, t, i)=> a + ((i===melodyTrackIndex)? 0: ((t?.notes?.length)||0)), 0);
            opt.textContent = `Auto (melody鬯?・??・?・?驍ｵ・?闕ｳ讒ｭ?・?驛｢譎?樟?主??・?譏ｴ?・?邵??, total ${accompCount} notes)`;
            accompSel.appendChild(opt);
            accompSel.disabled = true; // 髴托ｽ??・?・?鬮?・?髯??I驍ｵ・??・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驍ｵ・??・?・?驍ｵ・??・?・?髯樊ｺ?蛻?陝ｲ・?
        }
        // 驛｢譎?樟?主??・?譏ｴ?・?邵?驢搾??髮・??譎???・?髮・闔牙衷讓ｪ髯溷・萓ｭ郢晢??鬩・?・?・?髫?蜑ｰ萓ｭ邵?蝣?・?譎｢・?・?驛｢譏ｴ?・?郢晢??郢晢??陜捺?薙＊髯橸??雋????・?・?郢晢??郢晢??驍ｵ・?雋?∞???鬨?・?遶擾??隰・・・?・?遶乗劼・?・?霑壼??・?驍ｵ・??・?・?髣???髴???・?繧会ｽ?・?陷会ｽ?遶企?・?・?郢晢???・?・?郢晢??
        // trackInstrumentGrid 驍ｵ・?隰疲?ゑｽ?・?闔ｨ諛夷帝し・?陷会ｽ?遯?・?驛｢・?郢??・つ遶丞､?・??驍ｵ・?髦?蜷??蝣?・?・??・?・?髯樊ｺ?蛻?陝ｲ・?驍ｵ・?陷会ｽ?遶企?・?・?郢晢???・?・?闔・??・?・?郢晢??隰?繧会ｽ?・??・?・?鬮?・??・?・?鬩肴得??・?UI驍ｵ・??・?・?髯晏玄魍??晢??驛｢・?陷茨???・?・?郢晢??
    }catch(e){ console.warn('populateTrackSelectors failed', e); }
}

// fflate 驛｢・?髮区?∝樺鬨?・?郢晢??・取ｺ?・?譎｢・?・?驛｢譏???螟ｲ・?・?陜捺?薙＊髯橸??陞溘ｑ??・??・?・?驛｢・?郢晢??郢・驛｢譎???蛟･?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?隰?・??・?・?郢晢??
async function loadFflateDynamic(){
    function isStub(){
        try{
            if(typeof fflate==='undefined') return true;
            if(typeof fflate.unzipSync!=='function') return true;
            const s=String(fflate.unzipSync);
            if(/髫?蟷?・?・?髴大??・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?§・主??・?譎｢・?・?驛｢・?陝ｶ譏ｴ?・?鬩励???・?驍ｵ・?陷会ｽ?遯?・?驍ｵ・?闕ｳ蟯?蜻?驍ｵ・?髴???・??/.test(s)) return true;
        }catch(_){ return true; }
        return false;
    }
    if(!isStub()) return true;
    // 驍ｵ・??・?・?驍ｵ・?陞｢・?・取ｺ?・?譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・? assets/libs 驛｢・?髮区???・?髮主桁??・?髯?闌ｨ・?・?鬮?・??・?・?鬮?・?郢晢??
    await new Promise((res)=>{
        const s=document.createElement('script'); s.src='assets/libs/fflate.min.js'; s.async=true; s.onload=()=>res(true); s.onerror=()=>res(false); document.head.appendChild(s);
    });
    if(!isStub()) return true;
    // 髫????髯溷供??螽???札N驛｢・?陞ｳ螟ｲ・?・??・?・?驍ｵ・?陷?・??・?・?陋ｹ・?邵?讙趣??譎???驥・??・?・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・?髯樊ｻゑｽ?・?髫?・?陷会ｽ??・??驍ｵ・??・?・?驛｢・?郢??・・?驍ｵ・?郢晢???・?・?郢晢??
    await new Promise((res)=>{
        const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.min.js'; s.async=true; s.onload=()=>res(true); s.onerror=()=>res(false); document.head.appendChild(s);
    });
    return !isStub();
}
// ---- Playback core (missing helpers) ----
function startPlayback(){
    if(isPlaying) return;
    ensureAudio(); tuneCompressor();
    // 鬯?・??・?・?髮・陷亥沺縺夜Δ譎｢・?・?驛｢譎｢・?・?驛｢譎牙愛陷・?? or 鬯?・??・?・?鬩墓ｨ費??譁溽坩・?譎｢・?・?驛｢譎擾??・?邵?蝣?・?・??・?・?驍ｵ・?隶吝ｯ???鬯?・??・?・?髯??陷?・?陷・??驍ｵ・?郢晢?? 驛｢譎???・?邵??驛｢・??・?・?鬮?證ｦ・?・?髫?・?髣??・・?驍ｵ・??・?・?驍ｵ・??・?・?髫俶誓??・?髴難???・?・?驛｢・?陞ｳ螟ｲ・?・?陋滂ｽ?????
    const practiceMode = (function(){
        let hasAny=false;
        try{ if(melodyBuffer) hasAny=true; if(accompBuffer) hasAny=true; if(Array.isArray(melodyParts)){ for(const p of melodyParts){ if(p&&p.buffer){ hasAny=true; break; } } } }catch(_){ }
        // isPitchOnlyMode 驍ｵ・?郢晢??true 驍ｵ・??・?・?髯懶???・?・?髯?・?陋ｹ・?郢晢??驍ｵ・?郢晢??雎ｬ・?髮・髣????・?驍ｵ・?郢??隨・??驍ｵ・??・?・?驛｢・?郢???・?・??・?・?髯具???・?・?鬨?・?郢晢??遶頑･?・?貊ゑ??・?鬯?・??・?・?髯句??・?・?驍ｵ・??・?・?
        if(isPitchOnlyMode) return true;
        return !hasAny;
    })();
    try{ if(audioCtx.state!=='running'){ audioCtx.resume().catch(()=>{}); } }catch(_){ }
    isPlaying=true;
    const START_LAT=0.02; const startLead = 0; // btLatencySec 驍ｵ・??・?・? scheduleMore 髯句??・?・?驍ｵ・??・?・?鬮?・?隲?肩・?・??・?・?驍ｵ・?陷?・??・?荵・・?陋ｹ・??・??驍ｵ・?髦?蜷??蝣?・?・??・?・?髯?莨夲??・?鬩阪??蟷??・??驍ｵ・??・?・?驍ｵ・?郢晢???・?・?郢晢??
    playbackStartTime=audioCtx.currentTime + START_LAT + startLead;
    playbackStartPerf=performance.now()/1000 + START_LAT + startLead;
    playbackStartPos=playbackPosition;
    stopAllSources();
    // 驛｢譎擾??・?・取㏍・?譎???譁石夐ｩ搾???・?・?鬮?・?闔・?郢晢??髫?蟶?・?・?陜滂ｽ?
    try{ if(window.__driftStats){ window.__driftStats.samples=0; window.__driftStats.avg=0; window.__driftStats.max=0; window.__driftStats.last=0; const el=document.getElementById('driftOverlay'); if(el) el.textContent='Drift(start)'; }
        const el=document.getElementById('driftOverlay'); if(el){ el.textContent+=''; }
    }catch(_){ }
    if(!practiceMode){
        // 驛｢譎???・?・取刮・?譏ｶ?螢??､驛｢譎｢・?・?驛｢譏ｴ?・? 髫?蟶?逕･隴?・・?譏???・?郢晢??驛｢譎?樟郢晢??驍ｵ・??・?・?髯?・?隴?・?陷・??髯??陷?・?陷・??
        try{ melodySources.forEach(s=>{ try{s.stop(0);}catch(_){}}); }catch(_){ } melodySources=[];
        if(Array.isArray(melodyParts)){
            for(let i=0;i<melodyParts.length;i++){
                const p = melodyParts[i];
                if(!p || !p.buffer) continue;
                if(!p.playAudio) continue;
                const s = createAndStartSource(p.buffer, playbackStartTime, playbackPosition, melodyGain||masterGain||audioCtx.destination);
                if(s) melodySources.push(s);
            }
        } else if(melodyBuffer){
            // 驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?: 髫??会ｽ?・?髯?髮・??・?・?・つ
            melodySource=createAndStartSource(melodyBuffer, playbackStartTime, playbackPosition, melodyGain||masterGain||audioCtx.destination);
        }
        if(accompBuffer){ accompSource=createAndStartSource(accompBuffer, playbackStartTime, playbackPosition, accompGain||masterGain||audioCtx.destination); }
    } else {
        // 鬮?・??・?・?髯??趣???青蝣?・?・??・?・?驛｢譎丞ｹ?・取ｺ?・?譎｢・?・?驛｢譎丞ｹ?郢晢??驍ｵ・?陷会ｽ?遶企?・?・?郢晢??・つ郢?闌ｨ・?・??・?・?鬯?・?髣????・? granted 驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?鬮?・?隨・??驍ｵ・??・??隰?諷???・?闕ｵ譏ｶ?讌｢?戊ｭ・隰・髯具??隰費??・つ郢晢??
    if(!micAnalyser || !micData){ try{ canInitMicWithoutPrompt().then(ok=>{ if(ok) initMic(false).catch(()=>{}); }); }catch(_){ } }
    }
    if(analysisTimer){ clearInterval(analysisTimer); analysisTimer=null; }
    analysisTimer=setInterval(analyzePitch, 1000/analysisRate);
    // 鬯?・??・?・?鬩墓ｨ費??譁溽坩・?譎｢・?・?驛｢譏???螟ｲ・?・?髢?・?隨冗｢・??・??・?・?髯??陷?・?陷・??郢晢??陝ｲ・?邵?蝣?・?・?郢?莉ｰ??・?・?鬮?・?陟墓ｹ匁刮・?譎｢・?・?驛｢譎丞ｹ?郢晢??髯滂ｽ?郢晢??隨・髫俶誓??・?髯?髦??・?
    requestAnimationFrame(loop);
    // 髫?證ｦ・?・?髴難???・?・?鬯?・?陷?・??・?・?郢晢?? 鬩搾???・?・?鬮?・?陋ｹ・??・?蝣?・?譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??
    try{
        scoreSessionId++;
        scoreStats = { total:0, bins: Array.from({length:12},()=>({count:0,sum:0,sumAbs:0,inTol:0,outTol:0,sharp:0,flat:0})) };
    }catch(_){ scoreStats=null; }
    // 髯句??繩??・?・??・?・?驛｢・??・?・?驛｢譎擾??・?郢晢??驛｢・??・?・?驛｢・??・?・?髣???隴手歓鬚ｨ驍ｵ・?陟募??譌ｺ驛｢・?陟募?・・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?
    if(_pauseAdviceTimer){ try{ clearTimeout(_pauseAdviceTimer); }catch(_){} _pauseAdviceTimer=null; }
    // 鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎擾??・?邵?蝣?・?・?郢??郢・驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?鬮?・??・?・?鬩穂ｼ夲??・?驍ｵ・?陷会ｽ?遶企?・?・?郢晢??
}
function pausePlayback(){
    isPlaying=false;
    try{ console.warn('[pausePlayback] called at pos=', (playbackPosition||0).toFixed(3)); }catch(_){ }
    try{ if(schedTimer) clearInterval(schedTimer); schedTimer=null; }catch(_){ }
    stopAllSources();
    forceStopAllVoices();
    // 髫?・??・?・?髯?軸・?・?郢晢??鬨??難??蛟ｪ?讌｢蟯?陷?・?遶擾??驍ｵ・??・?・?髯?逎ｯ繝｡?・?・??・?・?驍ｵ・??・?・?髯・郢晢??鬮?諛???・?陋幢??・取㏍・?・??・?・?驛｢譏ｴ?・?郢晢??
    scheduleAll();
    // 驛｢・??・?・?驛｢譎擾??・?郢晢??驛｢・??・?・?驛｢・??・?・?驍ｵ・??・?・?鬮?・??・?・?髯?閧??螂???・??・?・?鬩穂ｼ夲??・?驍ｵ・??・?・?驍ｵ・?陷会ｽ?遶企?・?・?郢晢???・?・?陋ｹ・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?鬯?・?闕ｵ譎｢・?・?髫???・?・?髯溽??蠕?・?・?陝ｲ・?・つ郢???・?・?隴手歓鬚ｨ驛｢・??・?・?驛｢・??・?・?驛｢譎???・?郢晢??驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?郢晢??
    if(_pauseAdviceTimer){ try{ clearTimeout(_pauseAdviceTimer); }catch(_){} _pauseAdviceTimer=null; }
}

// 髯??陷?・?陷・??髣????・?・?驍ｵ・??・?・?髯?闌ｨ・?・?驛｢譎擾??・?郢晢??驛｢譏???螟ｲ・?・?陋ｹ・?邵?遉ｼ・?譎｢・?・?驛｢譎丞ｹ?・・/驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?/驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??陝ｲ・??・?螳・????・?髯具???・?・?髯句??繩??・?・??・?・?
function forceStopAllVoices(){
    try{
        const now=audioCtx? audioCtx.currentTime: 0;
        // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取?・?蟷?・?・?髣???郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?
        activeSampleVoices.forEach(v=>{
            try{ if(v.g && v.g.gain){ v.g.gain.cancelScheduledValues(now); v.g.gain.setValueAtTime(0.0001, now); } }catch(_){ }
            try{ if(v.src && v.src.stop) v.src.stop(0); }catch(_){}
            try{ if(v.rsrc && v.rsrc.stop) v.rsrc.stop(0); }catch(_){}
            try{ if(v.g && v.g.disconnect) v.g.disconnect(); }catch(_){}
        });
        activeSampleVoices=[];
    }catch(_){ }
    try{
        // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?
        activeVoices.forEach(v=>{ try{ v.nodes.forEach(n=>{ try{ if(n.stop) n.stop(0); }catch(_){ } try{ if(n.disconnect) n.disconnect(); }catch(_){ } }); }catch(_){ } });
        activeVoices=[];
    }catch(_){ }
}
function updatePlaybackPosition(){ if(!isPlaying||!audioCtx) return; const dt=Math.max(0, audioCtx.currentTime - playbackStartTime); playbackPosition = playbackStartPos + dt; }

// ---- Playback position hybrid clock ----
// AudioContext.currentTime 驍ｵ・?隶呎???・?髯・郢晢???・?・?遶乗剌・?蜀暦??・??・?・?鬮?・?陷会ｽ??・??驍ｵ・?陜灘?り･夜Δ??陟暮?会ｽ??匁捗?・?・?髯?・?陋ｹ・?遶頑･?蟯?陷?・?遶擾??驍ｵ・??・?謚孑formance.now() 驛｢・?陷・?・?・??・?・?鬨?蛹・??・?
let playbackStartPerf=0; // 鬩穂ｿ?諷??・?・?郢晢??erformance.now/1000郢晢??郢晢??
const IS_MOBILE = /Android|iPhone|iPad|iPod|Mobile|Tablet/i.test(navigator.userAgent||'');
const IS_MOBILE_PCPIPE = IS_MOBILE && USE_PC_PIPELINE_ON_MOBILE;
let _lastFrameTime=performance.now();
let _frameAccum=0, _frameCnt=0, _lastPerfLog=performance.now();
let _frameSkipToggle=false;
// === Drift 髯滓汚??・?髯具???・?・?鬨?蛹・??・?髯具???・?・?髯溷桁??・?驛｢譎???驥・??・?・??・?・? ===
// 鬯?・?陋滂ｽ?郢晢??驛｢譎｢・?・?驛｢譎???譁石夐恆・??・?・?髯・郢晢??邵?? AudioContext.currentTime 髣懈瑳蜑?・?・?陋滂ｽ??・?螳夲??・??・?・?髫?・?郢晢???・?? performance.now() 驛｢譎??郢晢??驛｢・??・?・?驍ｵ・??・?・?髯具??郢晢??陝蟶?・?・?陋ｹ・??・??
// 髯具???・?・?髯橸??陞｢・?隰??髣比ｼ夲??・?驍ｵ・??・?・? loop() 髯??郢晢??邵?? driftStats 驛｢・?髮区?貞ｴ?恷・??・?・?驍ｵ・?陷会ｽ?遯?・?鬮?・??・?・?髯?讎???轣???・?髫???・?・?
let FORCE_PERF_CLOCK=false; // true 驍ｵ・??・?・?驛｢・?郢晢??perfDt 驛｢・?陋幢??隨?螳茨??・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?髫?證ｦ・?・?鬨?蛹・??・?
let _driftForceState='idle'; // 'idle' | 'armed' | 'forcing'
const DRIFT_FORCE_AVG_MS=150;      // 髯晢???・?・?髯懶??郢晢???・?・?陞滓?・?・?鬯?・??・?・?髯区?ゑｽ?・?
const DRIFT_FORCE_SAMPLES=60;      // 髫????髣???陟托??邵?遉ｼ・?譎｢・?・?驛｢譎丞ｹ?・取?・?・??・?・?
const DRIFT_FORCE_HYST_MS=90;      // 鬮?證ｦ・?・?鬯?・??・?・?驍ｵ・??・?・?驍ｵ・?雋?∞??竏ｫ・?・??・?・?驛｢譎?・?邵?蟶?・?譏ｴ?・?・取㏍・?・??・?・?驛｢・??・?・?(髯晢???・?・?髯懶??郢晢??遯?・?驍ｵ・?髦?蜷??・?髯区?ゑｽ?・?髫?蟷?・?・?髮・・つ驍ｵ・??・?・?髫??会ｽ?・?驛｢・?郢晢??
let _lastDriftDecisionAt=0;
// ==== 髯・郢晢??隰?繧??????鬯?蛹・??・?髯具??驍丞?・?・?闔・??・?・?郢晢?? 鬯?・?陷?荳樣??驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・? (驛｢譎擾??・?郢晢??驛｢譏ｴ?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??) 驍ｵ・??・?・?髯?閧??蜍???驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・? (髯??陷?・?陷・??鬩搾??郢晢??髫俶誓??・?髴難???・?・?) 驍ｵ・??・?・?髯具??郢晢??陞ｻ・?髫??陷諤懈? ====
// 髯橸??雋????・?・?郢晢??陝・?鬯?・?隴擾??・朱豪・?譎｢・?・?:
// 1) noteGridCanvas, dynamicCanvas 驍ｵ・??・?・?2髫?・?陞溘ｉ闊樣坿・?闕ｳ螂???? chartContainer 驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?邵??
// 2) 驛｢譎擾??・?郢晢??驛｢譏ｴ?・?鬮?・?隴?・?陷搾??驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・?郢晢??郢晢??驛｢譎｢・?・?驛｢譎???・?・??・?・?鬯?・?郢晢??遯?・?髫俶誓??・?驍ｵ・?鬮?・?隨??髫?蠑ｱ・・?・??驍ｵ・?陞滂ｽ?郢晢??髫??陷諤懈?
// 3) 髮惹??・?・?郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・? dynamicCanvas 驍ｵ・??・?・?髯??陷?・?陷・??鬩搾??陞｢・?郢晢??髫俶誓??・?髴難???・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??驍ｵ・??・?・?
// 4) 驍ｵ・?髦?蜻?・?讙趣??・??・?・?驛｢・?陋ｹ・??・?鬘費??譎｢・?・?驛｢譎?蠕娯鴬驛｢譎｢・?・?驍ｵ・??・?・?驍ｵ・??・?・? CPU/GPU 鬮?蜈ｷ・?・?鬮?蛹・??・?驍ｵ・??・?・? jank 驛｢・?陷・?・?・?陷?蜴・??・?郢晢??
// 驛｢譎???驥・??・?・??・?・?郢晢??郢晢??rue 驍ｵ・??・?・?髣・隰疲?ゑｽ?・??・?・?髯具??隰費???・?螳夲??蟶?逕･隴??悟ｳ?隰費??隨・驛｢・?陋ｹ・?・趣??髯橸??陞｢・?・つ郢?逕ｻ・???・?・??・?・?鬯?・?陟托??邵?蝣?・?・??・?・?髫?蟷?・?・?髣????・?・?鬨?蛹・??・?郢晢??郢晢??
let USE_STATIC_LAYER_OPT=false;
function updatePlaybackPositionHybrid(){
    if(!isPlaying||!audioCtx) return;
    try{
        const nowPerf = performance.now()/1000;
        const ctxDt = Math.max(0, audioCtx.currentTime - playbackStartTime);
        const perfDt = Math.max(0, nowPerf - playbackStartPerf);
        let usePerf=false;
        if(FORCE_PERF_CLOCK){
            // 髯滓汚??・?髯具???・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・? drift 驍ｵ・?隰疲?ゑｽ?・??・?・?驍ｵ・?鬮?・??・?讚???・??・?・?髯・郢晢??・つ?・?邊羊formance 髫?蠑ｱ・玖?・?驛｢・?陷・?・?・??・?・?鬯???・?・?驍ｵ・?郢晢??
            playbackPosition = playbackStartPos + perfDt;
            return;
        }
        if(perfDt>0.15){
            const ratio = ctxDt / (perfDt||1e-6);
            usePerf = IS_MOBILE? (ratio < 0.5) : (ratio < 0.6);
        }
        let dt = ctxDt;
        if(!usePerf){
            if(perfDt - ctxDt > 0.04){ // 40ms 髣比ｼ夲??・?髣???髮榊?・?・?陞滓?・?・?驍ｵ・??・?・?髯滓??蛟仰郢晢??遶???諱・・?・?髯溯?・・?
                dt = ctxDt + (perfDt-ctxDt)*0.10;
            }
        } else {
            dt = perfDt;
        }
        playbackPosition = playbackStartPos + dt;
    }catch(_){
        const dt=Math.max(0, audioCtx.currentTime - playbackStartTime);
        playbackPosition = playbackStartPos + dt;
    }
}
function scheduleMore(){
    if(SIMPLE_SFZ_MODE){ return scheduleMoreSimple(); }
    if(!isPlaying||!audioCtx) return;
    // 鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譏ｴ?・? 鬯?・??・?・?髮・髣????・?髣???髴???・?繧???貊ゑ??・?驍ｵ・?郢晢???・?・??・?・?髯?・?陋ｹ・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髣???陝雜｣・?・?郢晢??
    if(!melodyBuffer && !accompBuffer) return;
    const now=audioCtx.currentTime;
    // 髫?蟶?逕･隴?・・?譎?樟?主??・?譏ｴ?・?邵?驢搾??譎???譁絶襖驛｢譎｢・?・?驛｢・??・?・?
    // 髯?・??・?・?髣???陞??・?・?闔・??・?・?雋?陜ｨ?驍ｵ・??・?・?驛｢譎?蠕?・?髯?・??・?・?髯句??・?・?郢晢??陝ｲ・?郢晢??髯??陷?・?陷・??驛｢譏ｶ?螢?笙るΔ譏ｴ?・?邵?驢搾??・??・?・?髯滓?萓ｭ遶???驍ｵ・?郢?閧?・?迢暦??譎?樟邵?蝣?・?譎｢・?・?驛｢・?郢??郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?驍ｵ・??・?・?髯・闔ｨ竏夊｣・
    // 髯??陷?・?陷・??髯?・??・?・?髯?・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴髯区?ゑｽ?・?>~0.01驍ｵ・??・?・?髯具???・?・?髫???・?・?郢晢??陋ｹ・?郢晢??驛｢・??・?・?驛｢譏ｴ?・?邵?驢搾??譎?鯵郢晢??驛｢・??・?・?驛｢・??・?・?驍ｵ・??・?・?髯晏??・??・?・??・?・?髮九?迴?遶擾??郢晢??郢晢??
    const gvEl=document.getElementById('guideVolumeSlider');
    const avEl=document.getElementById('accompVolumeSlider');
    const enableMel = gvEl? (parseFloat(gvEl.value)>0.01) : true;
    const enableAcc = avEl? (parseFloat(avEl.value)>0.01) : true;
    const isTrackEnabled = (ti)=>{
        const isMel = (ti===melodyTrackIndex);
        if((isMel && !enableMel) || (!isMel && !enableAcc)) return false;
        const assign = trackInstrumentAssign[ti]|| (isMel? 'Flute': 'Piano');
        return assign!=='none' && (currentTracks[ti]?.notes?.length>0);
    };
    // 髫?・??・?・?驛｢譎擾??・?郢晢??驛｢譎乗ｲ?霎ｷ・?鬩肴得??・?驛｢譎渉・?・取刮・?譏ｴ?・?
    const findNextNoteTime = (after)=>{
        let t=Infinity;
        for(let ti=0; ti<currentTracks.length; ti++){
            if(!isTrackEnabled(ti)) continue;
            const notes=currentTracks[ti].notes;
            for(const n of notes){
                const st=n.time; if(st>after+1e-6){ if(st<t) t=st; break; }
            }
        }
        return isFinite(t)? t: null;
    };

    // from/target 驛｢・?髮区??・?・??・?・?驍ｵ・??・?・?髫?蟷・?溯?讓抵??・??・?・?鬩墓得??・?髮・?・?・?
    let from = isFinite(scheduledUntil)? scheduledUntil: (playbackPosition||0);
    const baseAhead = SCHEDULE_AHEAD; // 髣???・つ髯橸??陞｢・?郢晢??髯?逎ｯ繝｡?・?・??・?・?驍ｵ・??・?・?

    // 髯?・?陟包???・?・?・つ髯?・??・?・?驍ｵ・??・?・?髯???・?・?驍ｵ・?隲?諛?・?驍ｵ・??・?・?髫?・??・?・?髯?軸・?・?遶擾??驍ｵ・??・?・?髯?螟ｧ豸?・つ?・?・?驍ｵ・?陷会ｽ?隨・??驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?郢晢??闔蛹・??・?鬩?謳?・?・??・?・?驍ｵ・??・?・?髮・?・?・?驍ｵ・??・?・?驛｢・?陝ｲ・?遶企?・?・?郢晢???・?閧?・?・?郢晢???・?・?郢晢??
    let loops=0; const MAX_LOOPS=3; let scheduledTotal=0; const MAX_NODES_PER_CALL=120;
    while(loops<MAX_LOOPS){
        loops++;
        const basePos = Math.max(isFinite(scheduledUntil)? scheduledUntil: 0, playbackPosition||0);
        const songDur = getSongDuration();
        let target = Math.min(isFinite(songDur)? songDur: (basePos+baseAhead), basePos + baseAhead);
        if(!(isFinite(target))) target = basePos + baseAhead;
        if(target<=from+1e-6){ target = from + baseAhead; }
        if(window.DEBUG_SCHED){ try{ console.log('[sched] win',loops,'from',from.toFixed(3),'base',basePos.toFixed(3),'target',target.toFixed(3),'pos', (playbackPosition||0).toFixed(3)); }catch(_){ } }

        let scheduledCount=0; let hardLimitHit=false;
        for(let ti=0; ti<currentTracks.length && !hardLimitHit; ti++){
            if(!isTrackEnabled(ti)) continue;
            const isMel = (ti===melodyTrackIndex);
            const assign = trackInstrumentAssign[ti]|| (isMel? 'Flute': 'Piano');
            const out = isMel? (melodyGain||masterGain||audioCtx.destination): (accompGain||masterGain||audioCtx.destination);
            const notes=currentTracks[ti].notes;
            for(const n of notes){
                const st=n.time, en=st+n.duration;
                if(en<=from) continue; if(st>=target) break;
                // 髯懈圜・?・?髯橸??陞｢・?雋よ・・??隰費??遶頑･?豎?・?・?驍ｵ・?陷会ｽ?遯?・? when 驛｢・?陷?闌ｨ・?・??・?・?髯橸??郢晢??
                let when = (isFinite(playbackStartTime)? playbackStartTime: audioCtx.currentTime) + ((isFinite(st)&&isFinite(playbackStartPos))? (st - playbackStartPos): 0);
                if(btLatencyEnabled){ when -= btLatencySec; }
                if(when < now - 0.01){ when = now + 0.002; }

                let ok=false;
                if(useSamplePiano && (instrumentMaps[assign] || pianoSampleMap) && (Object.keys(instrumentMaps[assign]||pianoSampleMap).length)){
                    ok = playFromZipPiano(n.midi, when, n.duration, out, assign);
                    if(window.DEBUG_SAMPLE_NOTE && ok){ try{ console.log('scheduled sample', {inst:assign, midi:n.midi, when: (when-audioCtx.currentTime).toFixed(3)}); }catch(_){ } }
                }
                if(!ok){ ok = !!createPianoVoice(n.midi, when, n.duration, out); }
                if(ok){ scheduledCounter++; scheduledCount++; scheduledTotal++; }

                if(scheduledTotal >= MAX_NODES_PER_CALL){ hardLimitHit=true; break; }
            }
        }

        // 鬯?・??・?・?髫?莉吝???・?螳夲??蜴・??・?髫???・?・?
        scheduledUntil = target;
        if(window.DEBUG_SCHED){ try{ console.log('[sched] scheduled:', scheduledCount, 'accum:', scheduledTotal, 'scheduledUntil->', (scheduledUntil||0).toFixed(3)); }catch(_){ } }

        // 驛｢譎擾??・?郢晢??驛｢譎?樟??・?1驍ｵ・??・?・?驛｢・?郢?菫・??驍ｵ・?闔会ｽ??・?讙趣??・??・?・?驍ｵ・?遶乗亢?・?驍ｵ・??・?・?驛｢譎擾??・?郢晢??驛｢譎???・?螳夲??證ｦ・?・?驍ｵ・?陷会ｽ?遯?・? from 驛｢・?陋幢??邵?螟ゑ??譎｢・?・?驛｢譎｢・?・?驛｢譎?惧?・?・?陜捺?督蜻?譽・・?・?30鬩穂ｿ?諷??・?・?郢晢??
        if(scheduledCount===0 && !hardLimitHit){
            const nextT = findNextNoteTime(from);
            if(nextT!=null){
                const jumpTo = Math.min(nextT, from + (MAX_DYNAMIC_LOOKAHEAD||30));
                if(window.DEBUG_SCHED){ try{ console.log('[sched] no-notes; jump from', from.toFixed(3), '->', jumpTo.toFixed(3)); }catch(_){ } }
                from = jumpTo;
                continue; // 髫?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ?邵?螳壽呵泛雜?・?・?髢?・??・?・?郢晢??
            }
        }

        // 髫??髦?蜷?阡馴刹・?郢晢???・?鬘費??・??・?・?驍ｵ・?雋???・?髯???迴?遯?・?驍ｵ・??・?・?驍ｵ・?郢晢???・?・??・?・?髯?・?陋ｹ・?郢晢??鬩搾??郢???・?・?郢晢??
        if(hardLimitHit || scheduledTotal >= MAX_NODES_PER_CALL) break;
        if(scheduledCount===0) break;
    }
}
function autoCenterMelodyTrack(){
    if(autoCenterFrozen) return; // 髯??陷?・??・?・?髯應ｼ夲??・??・?・?驍ｵ・??・?・?鬮?・??・?・?髯??趣??譁絶落驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・?陷会ｽ?遶企?・?・?郢晢??
    // 2.5驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎樊束陝?????晢?? 鬮?・??・?・?髯??趣??譁絶酪驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?鬮?・??・?・?髯??趣??譁絶?驛｢譎???譁絶落驛｢譏ｴ?・?郢晢??驍ｵ・??・?・?鬮?・?陟暮?会ｽ?蜀暦??・??・?・?驍ｵ・?郢晢??
    // 髯滂ｽ?郢晢???・?・?遶丞｣??蝣?・?・?郢???・?讙趣??・??・?・?髫??陷?・?髯悟､ゑｽ?・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴驛｢・?郢晢??郢晢??驛｢・??・?・?驛｢譎｢・?・?髫?・?陜｣・??・?・?隲帷???蟶晏擅?・?・?髫?・??・?・?驍ｵ・?陷?・??・??
    return;
}
// 髫?謔ｶ?・??・?・?陞｢・??・??驍ｵ・?隶夲??IDI鬩???郢晢??陝ｲ? [low, high] 驍ｵ・?霑ｹ螟ｲ・?・?闕ｵ譏ｶ??驛｢・?闕ｵ譎｢・?閧?・?・?郢晢??遶???縺・・?・?驛｢・??・?・?驛｢譎???譁絶落驛｢譏ｴ?・?郢晢??驛｢・?陞ｳ螟ｲ・?・??・?・?髫?・??・?・?
function setVerticalOffsetToRange(low, high){
    if(!Number.isFinite(low) || !Number.isFinite(high)) return;
    const total=verticalZoom*12; // 鬮?・??・?・?鬩穂ｼ夲??・?髯?雍???竏ｵ・?・?髫?・??・?・?
    const min=36, max=132; // 髫??陷諤懈?驍ｵ・??・?・?髯?闌ｨ・?・?鬩???郢晢??陝ｲ?
    const allowRange=Math.max(0, (max-min-total));
    const span = Math.max(1, (high - low + 1));
    const desiredCenter = (low + high) / 2;
    const clampedCenter = Math.max(min + total/2, Math.min(max - total/2, desiredCenter));
    const desiredVmin = Math.round(clampedCenter - total/2);
    const rel = Math.max(0, Math.min(allowRange, desiredVmin - min));
    verticalOffset = Math.round((rel / Math.max(1, allowRange)) * 100);
    try{ if(typeof syncVerticalOffsetSliders==='function') syncVerticalOffsetSliders(); }catch(_){ }
}
// 髯滂ｽ?郢晢???・?・?遶丞｣??讌｢?・?隲帷腸・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??鬨?蛹・??・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢・?郢?閧?・?・?髣?侭?・?
window.resetAutoCenter = function(){ autoCenterFrozen=false; autoCenterMelodyTrack(); drawChart(); };
function scheduleAll(){ scheduledUntil=playbackPosition; }

// ==================== MIDI Functions ====================
// MIDI parser: Extract all tracks with note events
function parseMidiAllTracks(u8){
    try{
        const dv=new DataView(u8.buffer,u8.byteOffset,u8.byteLength);
        let p=0;
        function readStr(len){ let s=''; for(let i=0;i<len;i++) s+=String.fromCharCode(dv.getUint8(p++)); return s; }
        function readU32(){ const v=dv.getUint32(p); p+=4; return v; }
        function readU16(){ const v=dv.getUint16(p); p+=2; return v; }
        if(readStr(4)!=='MThd') return [];
        const hdrLen=readU32(); const format=readU16(); const ntr=readU16(); const division=readU16();
        p = 8+6; // skip to after header
        const tracks=[];
        for(let t=0;t<ntr;t++){
            const id=readStr(4); const len=readU32();
            if(id!=='MTrk'){ p+=len; continue; }
            const end=p+len; let curTime=0; let runningStatus=0; const events=[];
            function readVar(){ let v=0; while(true){ const b=dv.getUint8(p++); v=(v<<7)|(b&0x7F); if(!(b&0x80)) break; } return v; }
            while(p<end){
                const dt=readVar(); curTime+=dt;
                let st=dv.getUint8(p++);
                if(st<0x80){ p--; st=runningStatus; } else { runningStatus=st; }
                if((st&0xF0)===0x90 || (st&0xF0)===0x80){
                    const note=dv.getUint8(p++); const vel=dv.getUint8(p++);
                    events.push({t:curTime, type:(st&0xF0), note, vel});
                }
                else if(st===0xFF){ const meta=dv.getUint8(p++); const len=readVar(); p+=len; }
                else { const hi=st&0xF0; const cons = (hi===0xC0||hi===0xD0)? 1: 2; p+=cons; }
            }
            const onMap=new Map(); const notes=[];
            events.forEach(ev=>{
                if(ev.type===0x90 && ev.vel>0){ onMap.set(ev.note, ev.t); }
                else if((ev.type===0x80) || (ev.type===0x90 && ev.vel===0)){
                    const st=onMap.get(ev.note);
                    if(st!=null){ notes.push({midi:ev.note, st, en:ev.t}); onMap.delete(ev.note); }
                }
            });
            tracks.push({ index:t, notes });
        }
        return tracks.filter(tr=> tr.notes && tr.notes.length>0).sort((a,b)=> b.notes.length - a.notes.length);
    }catch(_){ return []; }
}

// Convert MIDI track notes to app format with octave shift
function convertMidiTrackToNotes(midiNotes, octaveShiftSemitones){
    if(!midiNotes || !Array.isArray(midiNotes)) return [];
    // Assuming 480ppq, 120BPM -> 1 tick = 1.04ms approx
    const tickToSec = (tick)=> tick / 480.0 * 0.5;
    const notes = midiNotes.map(n=>{
        const midi = n.midi + octaveShiftSemitones;
        const time = tickToSec(n.st);
        const duration = tickToSec(n.en - n.st);
        return {midi, time, duration};
    }).filter(n=> n.midi>=0 && n.midi<=127).sort((a,b)=> a.time - b.time);
    return notes;
}

// Show MIDI track selection dialog
function showMidiTrackDialog(parsedTracks, partObj, fileName){
    return new Promise((resolve, reject)=>{
        const dialog = document.getElementById('midiTrackDialog');
        const overlay = document.getElementById('midiTrackDialogOverlay');
        const trackSelect = document.getElementById('midiTrackSelect');
        const octaveShift = document.getElementById('midiOctaveShift');
        const octaveShiftVal = document.getElementById('midiOctaveShiftVal');
        const okBtn = document.getElementById('midiTrackOkBtn');
        const cancelBtn = document.getElementById('midiTrackCancelBtn');
        if(!dialog || !overlay || !trackSelect || !octaveShift || !okBtn || !cancelBtn){
            reject(new Error('Dialog elements not found')); return;
        }
        
        // Populate track options
        trackSelect.innerHTML='';
        parsedTracks.forEach((tr, i)=>{
            const opt=document.createElement('option');
            opt.value=String(i);
            opt.textContent=`Track ${i+1} (${tr.notes.length} notes)`;
            trackSelect.appendChild(opt);
        });
        trackSelect.selectedIndex=0;
        octaveShift.value='0';
        if(octaveShiftVal) octaveShiftVal.textContent='0';
        
        // Octave shift slider update
        const updateOctaveLabel = ()=>{
            if(octaveShiftVal) octaveShiftVal.textContent = octaveShift.value;
        };
        octaveShift.addEventListener('input', updateOctaveLabel);
        
        // Show dialog
        dialog.style.display='block';
        overlay.style.display='block';
        
        // OK button handler
        const handleOk = async ()=>{
            try{
                const selectedIdx = parseInt(trackSelect.value, 10);
                const octaveShiftSemitones = parseInt(octaveShift.value, 10);
                const selectedTrack = parsedTracks[selectedIdx];
                if(!selectedTrack){ reject(new Error('Invalid track selection')); return; }
                
                // Convert MIDI notes to app format
                const notes = convertMidiTrackToNotes(selectedTrack.notes, octaveShiftSemitones);
                partObj.notes = notes;
                partObj.duration = notes.length>0 ? Math.max(...notes.map(n=>n.time+n.duration)) : 0;
                partObj.buffer = null; // No audio buffer for MIDI
                
                // Reset state
                autoCenterFrozen = false;
                autoCenterMelodyTrack();
                try{ if(isAssistActive()) stopLatencyAssist(); }catch(_){ }
                try{ if(isCalibrating){ _calibAbort=true; isCalibrating=false; } }catch(_){ }
                midiGhostNotes = null; calibCountdownText=null; calibAnchorActive=false;
                
                // Update currentTracks
                currentTracks=[{name:`Melody P${currentMelodyPart+1}`, notes:(partObj.notes||[])}];
                melodyTrackIndex=0;
                melodyNotesExtracted=true;
                
                // Disable pitch-only mode
                try{
                    if(isPitchOnlyMode){
                        isPitchOnlyMode = false;
                        const btn = document.getElementById('pitchOnlyModeBtn');
                        if(btn){
                            btn.classList.toggle('active', false);
                            btn.title = 'Pitch-only mode';
                        }
                    }
                }catch(_){ }
                
                // Reset playback
                if(isPlaying){ try{ pausePlayback(); }catch(_){ } }
                stopStage = 0;
                timelineOffsetSec = 0;
                scheduledUntil = 0;
                playbackPosition = 0;
                playbackStartPos = 0;
                
                // Update UI
                try{ if(typeof resizeCanvas==='function') resizeCanvas(); }catch(_){ }
                scheduleAll();
                updateTimelineScrollRange();
                drawChart();
                try{ if(btCalibStatus) btCalibStatus.textContent='Not calibrated'; }catch(_){ }
                
                dialog.style.display='none';
                overlay.style.display='none';
                octaveShift.removeEventListener('input', updateOctaveLabel);
                okBtn.removeEventListener('click', handleOk);
                cancelBtn.removeEventListener('click', handleCancel);
                resolve();
            }catch(err){
                console.warn('MIDI track dialog error:', err);
                dialog.style.display='none';
                overlay.style.display='none';
                octaveShift.removeEventListener('input', updateOctaveLabel);
                okBtn.removeEventListener('click', handleOk);
                cancelBtn.removeEventListener('click', handleCancel);
                reject(err);
            }
        };
        
        // Cancel button handler
        const handleCancel = ()=>{
            dialog.style.display='none';
            overlay.style.display='none';
            octaveShift.removeEventListener('input', updateOctaveLabel);
            okBtn.removeEventListener('click', handleOk);
            cancelBtn.removeEventListener('click', handleCancel);
            reject(new Error('User cancelled'));
        };
        
        okBtn.addEventListener('click', handleOk);
        cancelBtn.addEventListener('click', handleCancel);
    });
}

// ---- UI ----
// 鬯?・??・?・?髯橸???・?・?驛｢譎???譁撰?憺Δ???・?・?驛｢譎｢・?・? UI
if(melodyAudioBtn && melodyAudioInput){ melodyAudioBtn.onclick=()=>{ if(melodyAudioBtn.disabled) return; melodyAudioInput.click(); }; }
if(melodyAudioInput){ melodyAudioInput.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; if(melodyAudioLabel){ melodyAudioLabel.textContent=f.name; melodyAudioLabel.title=f.name; } const overlay=document.getElementById('analyzingOverlay'); try{ if(overlay){ overlay.classList.remove('hidden'); } const ab=await f.arrayBuffer(); const srcU8=new Uint8Array(ab);
    const P = melodyParts[currentMelodyPart];
    P.origBytes=new Uint8Array(srcU8.length); P.origBytes.set(srcU8);
    P.origName=f.name; P.origExt=(f.name.split('.').pop()||'bin').toLowerCase(); if(!audioCtx) ensureAudio();
    // Check if MIDI file (.mid, .midi)
    if(P.origExt==='mid' || P.origExt==='midi'){
        if(overlay){ overlay.classList.add('hidden'); }
        const parsed = parseMidiAllTracks(srcU8);
        if(!parsed || !parsed.length){ console.warn('Could not extract tracks from MIDI'); return; }
        // Show track selection dialog
        await showMidiTrackDialog(parsed, P, f.name);
        return;
    }
    // Audio file processing
    P.buffer=await new Promise((res,rej)=> audioCtx.decodeAudioData(ab, b=>res(b), e=>rej(e)));
    P.duration=P.buffer.duration||0; await extractMelodyNotesFromBuffer(P.buffer);
    // 髫?螟ｲ・?・?髯???・?・?鬩搾??陷亥沺・?・?驍ｵ・??・?・? currentTracks[0] 驍ｵ・??・?・?髯?闌ｨ・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?郢晢???・?迢暦??・?雋?∞??竏ｫ・?・?遶丞｣??､驛｢譎｢・?・?驛｢譎?樟郢晢?? notes 驍ｵ・??・?・?髯??陷?・?隨・
    try{ P.notes = (currentTracks && currentTracks[0] && Array.isArray(currentTracks[0].notes))? currentTracks[0].notes.slice() : []; }catch(_){ P.notes = []; }
    // 鬮?證ｦ・?・?髫?・?髣????骰具??・?陋ｹ・??・?鬘費??譎擾??・?郢晢??驛｢譏ｴ?・?遯?・?髫?蜴・??・?髫???・?・?驍ｵ・?髴???・?讙趣??・?雋???・?驍ｵ・??・?・?鬮?・??・?・?髯??趣??譁絶落驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・?陞ｳ螟ｲ・?・??・?・?鬯?・??・?・?驍ｵ・?陷会ｽ?遯?・?鬯?蛹・??・?鬨?蛹・??・?
    autoCenterFrozen = false;
    autoCenterMelodyTrack();
    // --- 髯??鬮?・?邵?譎会ｽ?譏ｴ?・?郢晢??: 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?・??・?・??・?・?鬯?・??・?・?驛｢譎｢・?・?髯句??繩??・?・??・?・?驛｢譎｢・?・?鬯???・?・?髯???・?・?驍ｵ・?陷会ｽ?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?/驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髫?蜴・??・?髫???・?・? ---
    try{ if(isAssistActive()) stopLatencyAssist(); }catch(_){ }
    try{ if(isCalibrating){ _calibAbort=true; isCalibrating=false; } }catch(_){ }
    midiGhostNotes = null; calibCountdownText=null; calibAnchorActive=false;
    // 驛｢譏???・?郢晢??驛｢譎?樟郢晢??驛｢譎擾??・?郢晢??驛｢譏ｴ?・??・?蟶昴???・?・?鬯?・?郢晢???・?・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?髯具??郢晢??陝?
    currentTracks=[{name:`Melody P${currentMelodyPart+1}`, notes:(P.notes||[])}]; melodyTrackIndex=0; melodyNotesExtracted=true;
    // 驛｢譎??堤?晢??驛｢譏ｶ?譎｢・?・?郢?閾?闊樣Δ譎｢・?・?驛｢譎｢・?・?驛｢譎擾??・?郢晢??鬮?證ｦ・?・?鬯?・??・?・?郢晢??鬩・?・?・??・?・?鬮?雜｣・?・?鬨?・??・?・?髯溷供??蠕?・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・??・?・??・?・?鬩穂ｼ夲??・?驛｢譎｢・?・?髯??陷?・?陷・??驛｢・?陷?蝓淞蜑ｰ諤・・?・?驍ｵ・??・?・?髫??会ｽ?・?驍ｵ・?陷?・??・?・?郢晢??
    try{
        if(isPitchOnlyMode){
            isPitchOnlyMode = false;
            const btn = document.getElementById('pitchOnlyModeBtn');
            if(btn){
                btn.classList.toggle('active', false);
                btn.title = '鬯?・??・?・?髮・髣??会ｽ?螳壽割?・?・?驛｢・?闕ｳ蟯???驍ｵ・?遶丞｣??・?驛｢・??・?・?驛｢・??・?・?驍ｵ・??・?・?鬯?・??・?・?鬩墓ｨ費??譏ｶ蜻?驍ｵ・?闔会ｽ??・?蟶晏搦陋滂ｽ?????驛｢譎｢・?・?鬮?・??・?・?鬩穂ｼ夲??・?驍ｵ・?陷会ｽ?遶擾??驍ｵ・?陷?・??・?・?闔・?郢晢??鬨??難??蛟･?・?髴取ｻゑｽ?・?鬯?・??・?・?郢晢??郢晢??;
            }
        }
    }catch(_){ }
    // 髯??陷?・?陷・??鬯?・??・?・?鬯?・??・?・?驛｢・?髮区???・?髫?蟶?・?・?陜滂ｽ?
    if(isPlaying){ try{ pausePlayback(); }catch(_){ } }
    stopStage = 0;
    timelineOffsetSec = 0;
    scheduledUntil = 0;
    playbackPosition = 0;
    playbackStartPos = 0;
    // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕娯雷驛｢・?陷?蝓淞蜻?・???・?・?髴托ｽ??・?・?髫?・?闕ｵ譏ｶ??
    try{ if(typeof resizeCanvas==='function') resizeCanvas(); }catch(_){ }
    scheduleAll();
    updateTimelineScrollRange();
    drawChart();
    // 驛｢・??・?・?驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢・?髮区???・?髫?蟶?・?・?陜滂ｽ?
    try{ if(btCalibStatus) btCalibStatus.textContent='髫?蟷?・?・?髮九ｑ??・?髯橸??郢晢??; }catch(_){ }
    }catch(err){ console.warn('驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??鬯?・??・?・?髯橸???・?・?驍ｵ・??・?・?鬮?・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?髯樊ｻゑｽ?・?髫?・?郢晢??', err); } finally { if(overlay){ overlay.classList.add('hidden'); } } }; }
if(accompAudioBtn && accompAudioInput){ accompAudioBtn.onclick=()=>{ if(accompAudioBtn.disabled) return; accompAudioInput.click(); }; }
if(accompAudioInput){ accompAudioInput.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; if(accompAudioLabel){ accompAudioLabel.textContent=f.name; accompAudioLabel.title=f.name; } try{ const ab=await f.arrayBuffer(); const srcU8=new Uint8Array(ab); accompOrigBytes=new Uint8Array(srcU8.length); accompOrigBytes.set(srcU8); accompOrigName=f.name; accompOrigExt=(f.name.split('.').pop()||'bin').toLowerCase(); if(!audioCtx) ensureAudio(); accompBuffer=await new Promise((res,rej)=> audioCtx.decodeAudioData(ab, b=>res(b), e=>rej(e))); accompDuration=accompBuffer.duration||0; }catch(err){ console.warn('髣費???・?・?髯槭??豐∬??・?髯橸???・?・?驍ｵ・??・?・?鬮?・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?髯樊ｻゑｽ?・?髫?・?郢晢??', err); } }; }

// ================= 驛｢・??・?・?驛｢譏ｴ?・?邵?蜥擾??譎｢・?・?驛｢譎｢・?・?髣???隴取得??・?郢晢??鬮?・??・?・?鬮?雜｣・?・? =================
function textEncodeUtf8(str){ try{ return new TextEncoder().encode(str); }catch(_){ // IE/髫??会ｽ?・?驛｢譎?§・主??・?・??・?・?驛｢・??・?・?髫???・?・?髯橸??陞｢・?遶企?・?・?郢晢??
    const u8=new Uint8Array(str.length); for(let i=0;i<str.length;i++) u8[i]=str.charCodeAt(i)&255; return u8; }
}
function textDecodeUtf8(u8){ try{ return new TextDecoder().decode(u8); }catch(_){ let s=''; for(let i=0;i<u8.length;i++) s+=String.fromCharCode(u8[i]); return s; } }

function buildSessionJson(){
    const tr=currentTracks[melodyTrackIndex];
    const notes=(tr&&tr.notes)? tr.notes.map(n=>({midi:n.midi,time:n.time,duration:n.duration})) : [];
    const dots=pitchHistory.map(p=>({time:p.time,freq:p.freq,conf:p.conf}));
    const meta={
        app:"pitch-trainer",
        ver:"1",
        a4:A4Frequency,
        toleranceCents,
        tempoFactor,
        guideLineWidth,
        verticalZoom, verticalOffset,
        pxPerSec, timelineOffsetSec,
        labelNotation,
        btLatencyEnabled, btLatencySec,
        guideVolume: (guideVol? parseFloat(guideVol.value): (melodyGain? melodyGain.gain.value: 0.8)),
        accompVolume: (accompVol? parseFloat(accompVol.value): (accompGain? accompGain.gain.value: 0.8)),
        markers
    };
    const audio={
        melody: melodyOrigBytes? {name:melodyOrigName||'melody', ext:melodyOrigExt||'bin'} : null,
        accomp: accompOrigBytes? {name:accompOrigName||'accomp', ext:accompOrigExt||'bin'} : null
    };
    return {meta, notes, dots, audio};
}

function suggestSessionFileName(){
    const base=(melodyOrigName||melodyAudioLabel?.textContent||'session').replace(/\.[^.]+$/,'');
    return base+".session.zip";
}

function makeZipStoreOnly(files){
    // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取刮・?・??・?・? Store-only ZIP 鬨??難??阮・・?郢晢??闔蛹・??・??・?・?髯樊ｻゑｽ?・?驛｢譏ｴ?・?邵??驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟?取??・?遶擾??隰・: 髣???・つ鬯?蟷?・?・?鬮?證ｦ・?・?髯??隶朱宦遶?驍ｵ・??・?・?鬯?・?隶抵???・?・??・?・?髯滂ｽ?隲帷???・?髯?・??・?・?鬮?・??・?・?髫?・??・?・?驍ｵ・?郢???・?鄙ｫ?・?郢晢??
    const chunks=[]; let offset=0; const enc=textEncodeUtf8;
    function pushU32LE(arr,v){ arr.push(v&255,(v>>8)&255,(v>>16)&255,(v>>24)&255); }
    function pushU16LE(arr,v){ arr.push(v&255,(v>>8)&255); }
    function dosTime(){ const d=new Date(); const t=((d.getHours())<<11)|((d.getMinutes())<<5)|((d.getSeconds()/2)|0); const da=(((d.getFullYear()-1980)<<9)|((d.getMonth()+1)<<5)|(d.getDate())); return {t,da}; }
    const {t,da}=dosTime();
    files.forEach(f=>{
        const nameU8=enc(f.name);
        const localHeader=[0x50,0x4b,0x03,0x04, 20,0, 0,0, 0,0, 0,0, 0,0, 0,0];
        // 鬩励???・?髯?・?郢晢??version/extract needed etc 驍ｵ・??・?・?髫??会ｽ?・?髯橸??郢晢??
        const crc=0; const compSize=f.data.length; const unCompSize=f.data.length;
        localHeader.push(0,0, 0,0); // mod time/date 驍ｵ・??・?・?髯溷供??蠕個?
        pushU16LE(localHeader,nameU8.length); pushU16LE(localHeader,0); // extra=0
        const hdrU8=new Uint8Array(localHeader);
        // 髫?蠑ｱ・・け??
        hdrU8[10]=t&255; hdrU8[11]=(t>>8)&255; hdrU8[12]=da&255; hdrU8[13]=(da>>8)&255;
        // 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?/CRC
        hdrU8[14]=crc&255; hdrU8[15]=(crc>>8)&255; hdrU8[16]=(crc>>16)&255; hdrU8[17]=(crc>>24)&255;
        hdrU8[18]=compSize&255; hdrU8[19]=(compSize>>8)&255; hdrU8[20]=(compSize>>16)&255; hdrU8[21]=(compSize>>24)&255;
        hdrU8[22]=unCompSize&255; hdrU8[23]=(unCompSize>>8)&255; hdrU8[24]=(unCompSize>>16)&255; hdrU8[25]=(unCompSize>>24)&255;
        chunks.push(hdrU8); chunks.push(nameU8); chunks.push(f.data);
        offset += hdrU8.length + nameU8.length + f.data.length;
    });
    // 髯?髮・・??・?・?隴∫???鬥?・?・??・?・?鬩搾??郢晢??
    let total=0; chunks.forEach(c=> total+=c.length); const out=new Uint8Array(total); let p=0; chunks.forEach(c=>{ out.set(c,p); p+=c.length; });
    return out;
}

async function saveSessionZip(){
    try{
        const sess=buildSessionJson();
        const files=[];
        // session.json
        files.push({name:'session.json', data: textEncodeUtf8(JSON.stringify(sess))});
    if(melodyOrigBytes){ files.push({name: `${melodyOrigName||('melody.'+(melodyOrigExt||'bin'))}`, data: melodyOrigBytes}); }
    if(accompOrigBytes){ files.push({name: `${accompOrigName||('accomp.'+(accompOrigExt||'bin'))}`, data: accompOrigBytes}); }
        let zipU8=null;
        if(window.fflate && typeof fflate.zipSync==='function'){
            const m={}; files.forEach(f=> m[f.name]=f.data );
            zipU8=fflate.zipSync(m, { level: 0 }); // 髴取ｻゑｽ?・?髯懶???・?・?鬩搾???・?・?(Store)驍ｵ・??・?・?髯?蟯??譏ｴ?・?
        }else{
            zipU8=makeZipStoreOnly(files);
        }
        const blob=new Blob([zipU8], {type:'application/zip'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=suggestSessionFileName(); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 10000);
    }catch(err){ console.warn('驛｢・??・?・?驛｢譏ｴ?・?邵?蜥擾??譎｢・?・?驛｢譎｢・?・?髣???隴取得??・?陋滂ｽ?遶頑･?譽・・?・?髫?・?郢晢??', err); }
}

async function loadSessionZipFromBytes(u8){
    let files=null; let usedFallback=false;
    try{
        if(window.fflate && typeof fflate.unzipSync==='function' && !/髫?蟷?・?・?髴大??・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?§・主??・?譎｢・?・?/.test(String(fflate.unzipSync))){
            files=fflate.unzipSync(u8);
        }else{
            files=unzipStoreOnly(u8);
            usedFallback=true;
        }
    }catch(e){ console.warn('unzip髯樊ｻゑｽ?・?髫?・?郢晢??,e); files=unzipStoreOnly(u8); usedFallback=true; }
    if(!files){ throw new Error('ZIP髯橸??隴会ｽ?陝ｷ諷???・??・?・?髯樊ｻゑｽ?・?髫?・?郢晢??); }
    const sessEntry=files['session.json'] || files['./session.json'] || (function(){ for(const k in files){ if(k.endsWith('session.json')) return files[k]; } return null; })();
    if(!sessEntry) throw new Error('session.json 驍ｵ・?霑ｹ螟ｲ・?・?闕ｵ譏ｶ蜻?驍ｵ・?闕ｵ譎｢・?鬘費??・??・?・?驍ｵ・?陝ｶ蜻?・??');
    let sess; try{ sess=JSON.parse(textDecodeUtf8(sessEntry)); }catch(e){ throw new Error('session.json 鬮?證ｦ・?・?髫?・?闔牙遜??・??・?・?髫?・?郢晢??); }
    // 髯溷桁??・?髯?蛹??・? 驛｢譎｢・?・?驛｢・??・?・?
    try{
        A4Frequency=sess.meta?.a4||A4Frequency; toleranceCents=sess.meta?.toleranceCents??toleranceCents; tempoFactor=sess.meta?.tempoFactor??tempoFactor; guideLineWidth=sess.meta?.guideLineWidth??guideLineWidth; verticalZoom=sess.meta?.verticalZoom??verticalZoom; verticalOffset=sess.meta?.verticalOffset??verticalOffset; pxPerSec=sess.meta?.pxPerSec??pxPerSec; timelineOffsetSec=sess.meta?.timelineOffsetSec??timelineOffsetSec; labelNotation=sess.meta?.labelNotation||labelNotation; btLatencyEnabled=!!sess.meta?.btLatencyEnabled; btLatencySec=sess.meta?.btLatencySec??btLatencySec; if(sess.meta?.markers) markers=sess.meta.markers; 
        // 鬮?????・?髯?莨夲??・?: 鬯?・??・?・?鬯?・?陷托ｽ??・?・??・?・?髯橸??郢晢??
        const gv = sess.meta?.guideVolume; const av = sess.meta?.accompVolume;
        if(typeof gv==='number' && guideVol){ guideVol.value=String(gv); }
        if(typeof av==='number' && accompVol){ accompVol.value=String(av); }
    }catch(_){ }
    // 髯溷桁??・?髯?蛹??・? 驛｢譎擾??・?郢晢??驛｢譏ｴ?・?
    currentTracks=[{name:'Melody', notes: (sess.notes||[]).map(n=>({midi:n.midi,time:n.time,duration:n.duration}))}]; melodyTrackIndex=0; melodyNotesExtracted=true;
    // 髯溷桁??・?髯?蛹??・? 髫俶誓??・?髴難???・?・?
    pitchHistory=(sess.dots||[]).map(d=>({time:d.time,freq:d.freq,conf:d.conf}));
    // 髯溷桁??・?髯?蛹??・? 鬯?・??・?・?髯橸???・?・?郢晢??闔・??・?・?闔ｨ諛夷帝し・?陷?・??・?讙趣??・??・?・?郢晢??郢晢??
    melodyBuffer=null; accompBuffer=null; melodyDuration=0; accompDuration=0;
    melodyOrigBytes=null; accompOrigBytes=null; melodyOrigName=null; accompOrigName=null; melodyOrigExt=null; accompOrigExt=null;
    // 驍ｵ・??・?・?驍ｵ・?陞｢・?郢晢?? session.json 驍ｵ・??・?・? audio.name 驍ｵ・??・?・?髫?證ｦ・?・?驍ｵ・?陷会ｽ?・つ遶擾???・?・?闕ｵ譏ｶ蜻?驍ｵ・?闕ｵ譎｢・?閾?・?・??・?・?驍ｵ・?闔会ｽ??・?讙趣??・??・?・?髫??会ｽ?・?髯・陋滂ｽ?郢晢??髮惹??・?閧?闊樣匚??鬮?・?邵?蝣?・?・?郢?閧?邊?し??郢晢??
    const melNameHint = sess.audio?.melody?.name || null;
    const accNameHint = sess.audio?.accomp?.name || null;
    const melBin = melNameHint? findFileByNames(files,[melNameHint]) : findFileByNames(files,['melody.wav','melody.mp3','melody.m4a','melody.aac','melody.bin']);
    const accBin = accNameHint? findFileByNames(files,[accNameHint]) : findFileByNames(files,['accomp.wav','accomp.mp3','accomp.m4a','accomp.aac','accomp.bin']);
    const overlay=document.getElementById('analyzingOverlay'); if(overlay){ overlay.classList.remove('hidden'); }
    try{
        ensureAudio();
        if(melBin){
            // 髣???隴取得??・?陋滂ｽ?騾?驢搾??・??・?・?驛｢譏ｴ?・?邵??驛｢譎｢・?・?驛｢譎丞ｹ?邵?諷???譎??堤?晢??驍ｵ・?陷会ｽ?遯?・?髣???隴・隰・
            melodyOrigBytes=new Uint8Array(melBin.bytes.length); melodyOrigBytes.set(melBin.bytes);
            melodyOrigName=melBin.name; melodyOrigExt=detectExtFromName(melBin.name);
            const ab = melBin.bytes.buffer.slice(melBin.bytes.byteOffset, melBin.bytes.byteOffset + melBin.bytes.byteLength);
            const buf=await new Promise((res,rej)=> audioCtx.decodeAudioData(ab, b=>res(b), e=>rej(e)));
            melodyBuffer=buf; melodyDuration=buf.duration||0;
        }
        if(accBin){
            accompOrigBytes=new Uint8Array(accBin.bytes.length); accompOrigBytes.set(accBin.bytes);
            accompOrigName=accBin.name; accompOrigExt=detectExtFromName(accBin.name);
            const ab = accBin.bytes.buffer.slice(accBin.bytes.byteOffset, accBin.bytes.byteOffset + accBin.bytes.byteLength);
            const buf=await new Promise((res,rej)=> audioCtx.decodeAudioData(ab, b=>res(b), e=>rej(e)));
            accompBuffer=buf; accompDuration=buf.duration||0;
        }
    }catch(err){ console.warn('鬯?・??・?・?髯橸???・?・?髯溷桁??・?髯?蛹??・??・?・??・?・?髫?・?郢晢??,err); }
    finally{ if(overlay){ overlay.classList.add('hidden'); } }
    // UI 髯?・?髢?・?闕ｳ?
    if(melodyAudioLabel){ melodyAudioLabel.textContent=melodyOrigName||'(zip髯??郢晢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??)'; melodyAudioLabel.title=melodyAudioLabel.textContent; }
    if(accompAudioLabel){ accompAudioLabel.textContent=accompOrigName||'(zip髯??郢晢??郢晢??髣費???・?・?髯槭???・?'; accompAudioLabel.title=accompAudioLabel.textContent; }
    // 驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴鬩???陝ｲ・??・?繧頑╂髢?・?闕ｳ?
    try{
    // A4 UI驍ｵ・??・?・?驍ｵ・?郢晢??
        if(tolSlider&&tolVal){ tolSlider.value=String(toleranceCents); tolVal.textContent=String(toleranceCents); }
        if(vZoom) vZoom.value=String(verticalZoom);
        if(timeScale&&timeScaleVal){ timeScale.value=String(pxPerSec); timeScaleVal.textContent=String(pxPerSec); }
        if(guideVol && melodyGain){ const v=parseFloat(guideVol.value); if(isFinite(v)) melodyGain.gain.value=v; }
        if(accompVol && accompGain){ const v=parseFloat(accompVol.value); if(isFinite(v)) accompGain.gain.value=v; }
        if(btLatencyToggle){ btLatencyToggle.checked = !!btLatencyEnabled; }
        if(btLatencySlider){ const ms=Math.round((btLatencySec||0)*1000); btLatencySlider.value=String(ms); if(btLatencyValue) btLatencyValue.textContent=`${ms} ms`; btLatencySlider.disabled = !btLatencyEnabled; }
    }catch(_){ }
    // 鬮?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?鬨?・??・?・?髯溷供??蠕?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?鬩搾???・?・?鬯?・?郢晢??邵?蝣?・?・??・?・?驍ｵ・??・?・?驍ｵ・?郢晢??隨??驛｢・?遶擾??郢晢??髯??趣??譁絶落驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・?陞ｳ螟ｲ・?・??・?・?髯?・??・?・?
    autoCenterFrozen = false;
    autoCenterMelodyTrack();
    drawChart();
}

function findFileByNames(files, candidates){
    for(const k in files){
        const low=k.toLowerCase();
        for(const c of candidates){
            if(low.endsWith(c)){
                const u8=files[k];
                return { name: k, bytes: (u8 instanceof Uint8Array)? u8 : new Uint8Array(u8) };
            }
        }
    }
    return null;
}
function detectExtFromName(name){ const m=name.match(/\.([a-z0-9]+)$/i); return m? m[1].toLowerCase(): 'bin'; }

// 驛｢譎?鯵邵?・?驛｢譎｢・?・?鬩搾??陷・?・?・?郢晢??
if(sessionSaveBtn){ sessionSaveBtn.onclick=()=>{ if(!melodyOrigBytes && !accompOrigBytes){ const ok = confirm('鬯?・??・?・?髯橸???・?・?驛｢譎???譁撰?憺Δ???・?・?驛｢譎｢・?・?驍ｵ・?隴?・?隰費??鬮?・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?驍ｵ・?陷?・?・つ郢???・??驍ｵ・??・?・?髴托ｽ??・?・?髫?・?闕ｵ譏ｴ?蝣?・?・?郢??郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?髫俶誓??・?髴難???・?・?驍ｵ・??・?・?驍ｵ・??・?・?驛｢・?陷・?・?・?隴取得??・?陋滂ｽ??・??驍ｵ・??・?・?驍ｵ・?陷?・?・ゑｽ??'); if(!ok) return; } saveSessionZip(); }; }
if(sessionLoadBtn && sessionLoadInput){ sessionLoadBtn.onclick=()=> sessionLoadInput.click(); sessionLoadInput.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ const ab=await f.arrayBuffer(); await loadSessionZipFromBytes(new Uint8Array(ab)); }catch(err){ console.warn('驛｢・??・?・?驛｢譏ｴ?・?邵?蜥擾??譎｢・?・?驛｢譎｢・?・?鬮?・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?髯樊ｻゑｽ?・?髫?・?郢晢??', err); } }; }
playBtn && (playBtn.onclick=()=>{ 
    if(!isPlaying) startPlayback(); 
    // 鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譏???螟ｲ・?・?郢晢??asic髫?謔ｶ?・??・?・?陞滂ｽ??・?・?陝ｲ・?邵?蝣?・?・??・?・?驍ｵ・??・?・?鬯?・?陷?・??・?・?闕ｵ譎｢・??驍ｵ・??・?・?驍ｵ・?郢晢??遶企?・?・?郢晢???・?・??・?・?髯?・?陋ｹ・?・つ遶乗亢?・?鬨??難??蛟･?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?鬯?・?陷?・??・?・?郢晢??
    try{ if(practiceMode==='basic' && !isPracticing){ startBasicPractice(); } }catch(_){ }
});
if(pauseBtn){
    pauseBtn.onclick=null;
    pauseBtn.addEventListener('keydown', (e)=>{ e.preventDefault(); e.stopPropagation(); });
    pauseBtn.addEventListener('keyup', (e)=>{ e.preventDefault(); e.stopPropagation(); });
    pauseBtn.addEventListener('pointerup', (ev)=>{
        if(!ev || ev.isTrusted!==true) return;
        pausePlayback();
    });
}
// stop 驍ｵ・??・?・? pointer 髫?・?陜｣・??・?・?隲帷???・?驍ｵ・??・?・?髯?・?陷会ｽ??・??髣皮甥?・??・??驛｢・?陷茨???・?・?陋ｹ・?邵?蜀暦??譎｢・?・?驛｢譎?鯵郢晢??驛｢譎?・?驗ゑ??髫?螟ｲ・?・?驍ｵ・??・?・? click 髯?・?陜捺?・・?驛｢・?陜｣・?隨冗霜諤・・?・?髯具??陷???・?・?郢晢??
if(stopBtn){
    stopBtn.onclick=null;
    stopBtn.addEventListener('keydown', (e)=>{ e.preventDefault(); e.stopPropagation(); });
    stopBtn.addEventListener('keyup', (e)=>{ e.preventDefault(); e.stopPropagation(); });
    stopBtn.addEventListener('pointerdown', (ev)=>{
        // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髫?・?陜｣・??・?・?隲帷???・?驍ｵ・??・?・?鬮?・??・?・?髯?・??・?・?
        if(STOP_TRUSTED_ONLY && (!ev || ev.isTrusted!==true)){
            try{ console.warn('stop ignored (untrusted trigger: pointerdown)'); }catch(_){ }
            return;
        }
        stopBtn.dataset._armed='1';
    });
    stopBtn.addEventListener('pointerup', (ev)=>{
        if(stopBtn.dataset._armed!=='1') return;
        stopBtn.dataset._armed='0';
        if(STOP_TRUSTED_ONLY && (!ev || ev.isTrusted!==true)){
            try{ console.warn('stop ignored (untrusted trigger: pointerup)'); }catch(_){ }
            return;
        }
        // 鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎?????・??・?・?驍ｵ・??・?・?驛｢・?霑壼整驟ｪ髮・?・?・?驍ｵ・??・?・?鬩搾??郢???・?・?郢晢??
        if(isPracticing){ try{ stopBasicPractice(true); }catch(_){ } }
        // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?§・取ｨ抵??譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?/驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏???蛹・??・??・?・?驍ｵ・??・?・?驛｢・?霑壼雀蛻晞辧雜｣・?・?驍ｵ・??・?・?髣????・?・?髫???・?・?
        if(isCalibrating){ _calibAbort = true; }
        if(isAssistActive()){ stopLatencyAssist(); }
        if(isPlaying){
            pausePlayback();
            stopStage=1;
        } else if(stopStage===1){
            playbackPosition=0; playbackStartPos=0; stopStage=0;
            scheduleAll(); // 髯?逎ｯ繝｡?・?・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎擾??・?邵?閧?・?・?郢晢??髣???陷?・??・?・??・?・?驍ｵ・??・?・?鬩墓得??・?髮・?・?・?
            drawChart();
        }
    });
}
rw5 && (rw5.onclick=()=>seekRelative(-5)); rw10 && (rw10.onclick=()=>seekRelative(-10)); fw5 && (fw5.onclick=()=>seekRelative(5)); fw10 && (fw10.onclick=()=>seekRelative(10));
tolSlider && (tolSlider.oninput=()=>{ toleranceCents=parseInt(tolSlider.value); tolVal.textContent=toleranceCents; drawChart(); }); tolVal && (tolVal.textContent=toleranceCents);
gateSlider && (gateSlider.oninput=()=>{ gateThreshold=parseInt(gateSlider.value); gateVal.textContent=gateThreshold; updateMicGateVisual(); }); gateVal && (gateVal.textContent=gateThreshold);
rateSlider && (rateSlider.oninput=()=>{
    let v=parseInt(rateSlider.value);
    // hop=frame/2 驍ｵ・??・?・?髣???驕擾??陷第?抵??・?髮区??・?・?陋ｹ・??・?荵・・?郢晢??IN驍ｵ・??・?・?髯橸??霑壼遜??・?陞｢・?陜滂ｽ?郢晢??郢晢??
    try{
        const sr = (audioCtx && audioCtx.sampleRate) ? audioCtx.sampleRate : 48000;
        const W = (micAnalyser && micAnalyser.fftSize) ? micAnalyser.fftSize : 2048;
        const hopRate = Math.max(10, Math.min(120, Math.round(sr / Math.max(1, Math.floor(W/2)))));
        v = Math.max(v, hopRate);
    }catch(_){ }
    analysisRate=v; rateVal.textContent=analysisRate;
    if(analysisTimer){ clearInterval(analysisTimer); analysisTimer=setInterval(analyzePitch,1000/analysisRate);} 
}); rateVal && (rateVal.textContent=analysisRate);
// A4/驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎樊束驍顔距??・?闕ｳ蟯?髮?UI驍ｵ・??・?・?髯?蜿?・?竏晄?る寞繧・樟?擾??
labelSel && (labelSel.onchange=()=>{ labelNotation=labelSel.value; });
vZoom && (vZoom.oninput=()=>{ verticalZoom=parseFloat(vZoom.value); drawChart(); });
timeScale && (timeScale.oninput=()=>{ pxPerSec=parseInt(timeScale.value); if(timeScaleVal) timeScaleVal.textContent=pxPerSec; drawChart(); });
guideVol && (guideVol.oninput=()=>{ if(!melodyGain) return; const v=parseFloat(guideVol.value); melodyGain.gain.value = (isFinite(v)? v: (melodyGain.gain.value||0.8)); });
accompVol && (accompVol.oninput=()=>{ if(!accompGain) return; const v=parseFloat(accompVol.value); accompGain.gain.value = (isFinite(v)? v: (accompGain.gain.value||0.8)); });
guideLineWidthSlider && (guideLineWidthSlider.oninput=()=>{ guideLineWidth=parseInt(guideLineWidthSlider.value)||4; drawChart(); });
// 髫??会ｽ?・?髯・陋滂ｽ?郢晢??驛｢譎?樟?主??・?譏ｴ?・?邵?郢肘驛｢・??・?・?驛｢譎??・趣??驛｢譎?樟郢晢??驍ｵ・?陷?・?遶冗距??・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?

// 髯?・??・?・?鬮?證ｮ鞫?陜滂ｽ?鬮?・?隲?肩・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴: 髯?螂???・?髫?蠑ｱ・・??????謫?・?・?
const _visTimeSnapMsEl = document.getElementById('visTimeSnapMs');
const _visTimeSnapMsVal = document.getElementById('visTimeSnapMsVal');
if(_visTimeSnapMsEl){
    _visTimeSnapMsEl.oninput=()=>{ visTimeSnapMs = parseInt(_visTimeSnapMsEl.value)||180; if(_visTimeSnapMsVal) _visTimeSnapMsVal.textContent=String(visTimeSnapMs); drawChart(); };
    if(_visTimeSnapMsVal) _visTimeSnapMsVal.textContent=String(visTimeSnapMs);
}
const _visBridgeGapMsEl = document.getElementById('visBridgeGapMs');
const _visBridgeGapMsVal = document.getElementById('visBridgeGapMsVal');
if(_visBridgeGapMsEl){
    _visBridgeGapMsEl.oninput=()=>{ visBridgeGapMs = parseInt(_visBridgeGapMsEl.value)||150; if(_visBridgeGapMsVal) _visBridgeGapMsVal.textContent=String(visBridgeGapMs); drawChart(); };
    if(_visBridgeGapMsVal) _visBridgeGapMsVal.textContent=String(visBridgeGapMs);
}
const _visBridgeGapInNoteMsEl = document.getElementById('visBridgeGapInNoteMs');
const _visBridgeGapInNoteMsVal = document.getElementById('visBridgeGapInNoteMsVal');
if(_visBridgeGapInNoteMsEl){
    _visBridgeGapInNoteMsEl.oninput=()=>{ visBridgeGapInNoteMs = parseInt(_visBridgeGapInNoteMsEl.value)||300; if(_visBridgeGapInNoteMsVal) _visBridgeGapInNoteMsVal.textContent=String(visBridgeGapInNoteMs); drawChart(); };
    if(_visBridgeGapInNoteMsVal) _visBridgeGapInNoteMsVal.textContent=String(visBridgeGapInNoteMs);
}
const _visChangeTolSemiEl = document.getElementById('visChangeTolSemi');
const _visChangeTolSemiVal = document.getElementById('visChangeTolSemiVal');
if(_visChangeTolSemiEl){
    _visChangeTolSemiEl.oninput=()=>{ visChangeTolSemi = parseFloat(_visChangeTolSemiEl.value)||0.65; if(_visChangeTolSemiVal) _visChangeTolSemiVal.textContent=String(visChangeTolSemi); drawChart(); };
    if(_visChangeTolSemiVal) _visChangeTolSemiVal.textContent=String(visChangeTolSemi);
}
const _visEdgePadMsEl = document.getElementById('visEdgePadMs');
const _visEdgePadMsVal = document.getElementById('visEdgePadMsVal');
if(_visEdgePadMsEl){
    _visEdgePadMsEl.oninput=()=>{ visEdgePadMs = parseInt(_visEdgePadMsEl.value)||160; if(_visEdgePadMsVal) _visEdgePadMsVal.textContent=String(visEdgePadMs); drawChart(); };
    if(_visEdgePadMsVal) _visEdgePadMsVal.textContent=String(visEdgePadMs);
}

micBtn && (micBtn.onclick=async()=>{
    // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?髫?・?陜｣・??・?・?隲帷???? AudioContext 驛｢・?陜｣・??・?・??・?・?髯橸??雋???讌｢・?蟶?逕･隴??悟ｳ?郢晢??髯??陜難??陝ｷ?
    _userExplicitMicInit=true;
    try{ activateAudioOnce(); }catch(_){ }
    try{ if(audioCtx && audioCtx.state==='suspended'){ await audioCtx.resume().catch(()=>{}); } }catch(_){ }
    try{ setMicStatus('ON?'); }catch(_){ }
    await initMic(true); // 髫?荳橸??闌ｨ・?・??・?・?髫?・?陜｣・??・?・?隲帛ｲ??驢搾??・??・?・?驍ｵ・??・?・?驛｢譎丞ｹ?・取ｺ?・?譎｢・?・?驛｢譎丞ｹ?郢晢??鬮?・??・?・?髯?・??・?・?
    if(!analysisTimer) analysisTimer=setInterval(analyzePitch,1000/analysisRate);
    if(!isPlaying) drawChart();
});
if(micDisconnectBtn){ micDisconnectBtn.onclick=()=>{ stopMic(); }; }
showNoteNamesToggle && (showNoteNamesToggle.onchange=()=>{ showNoteNames=showNoteNamesToggle.checked; drawChart(); });
function syncVerticalOffsetSliders(){ try{ if(vOffsetSliderRight) vOffsetSliderRight.value=String(verticalOffset); }catch(_){ } }
// 鬩搾???・?・?驛｢・??・?・?驛｢譎???譁絶落驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴驛｢譎｢・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎??・趣??驛｢譎?樟郢晢?? DOM 髫?蝣?霍?・?・?霑壼遜??・?陟募???鬥??蜈ｷ・?・?鬯?・??・?・?髮九?迴?遶擾??郢晢??騾趣??郤・??鬮?髦??・?闔??・???・?・?驍ｵ・??・?・?驍ｵ・?雋?∞??竏ｫ・?・?髦?蜻?・??驍ｵ・??・?・?驍ｵ・??・?・?髫?蟷?・?・?鬮?・??・?・?髯橸??陞滂ｽ??・?・?郢晢??
// 髯??陷?・?陷・??驛｢譏???・?・取ｨ抵??譏ｴ?・?郢晢??髯?・??・?・?鬩????・?・?驍ｵ・??・?・?驛｢譏ｶ?螢?笙るΔ譏ｴ?・?邵?驢搾??譎?鯵郢晢??驛｢・??・?・?驛｢・??・?・?驍ｵ・??・?・?髯晏??・??・?・??・?・?郢晢??闔・??・?・?隴?・?陝・?髣・陷?逎ｯ蜈ｱ驍ｵ・??・?・?驍ｵ・??・?・?郢晢??郢晢??
// if(melodyPlayToggle){ melodyPlayToggle.onchange=()=>{ ... } }
// if(accompPlayToggle){ accompPlayToggle.onchange=()=>{ ... } }
// BT鬮?・?隲?肩・?・??・?・?UI驛｢・??・?・?驛｢譎??・趣??驛｢譏ｴ?・?
if(btLatencyToggle){ btLatencyToggle.onchange=()=>{ btLatencyEnabled=btLatencyToggle.checked; if(btLatencySlider) btLatencySlider.disabled = !btLatencyEnabled; }; }
if(btLatencySlider){ btLatencySlider.oninput=()=>{ const ms=parseInt(btLatencySlider.value)||0; btLatencySec=Math.max(0, Math.min(500, ms))/1000; if(btLatencyValue) btLatencyValue.textContent=`${ms} ms`; drawChart(); }; }
if(btLatencyCalibBtn){ btLatencyCalibBtn.onclick=()=>{
    const ok = confirm('鬯?霈?・??・?・??・?・?鬮?・?隲?肩・?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎???・?蟶晢??・?陷?・??・?・?闕ｵ譎｢・??驍ｵ・??・?・?驍ｵ・?陷?・?・つ郢晢??n\n髫??驕擾???・?・?郢晢??\n1) 3驕ｶ鄙ｫ?・?驕ｶ鄙ｫ?・? 驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏???・??・?・?陟募仰遶擾???・?・?・つ髯橸??陞溯?・?・?鬯?・?隴∬・?・?驛｢譎擾??・?郢晢??驛｢譏ｴ?・?遯?・?髮趣??遶丞､?・?遒??陞｢・??・??驍ｵ・??・?・?驍ｵ・?陷?・??・?・?騾趣??雎ｬ・?驍ｵ・??・?・?鬯?????・?驛｢・?驗呻??遶擾??驍ｵ・?陝ｶ蜻?・?阮・・?陝ｲ・?・つ郢晢??n2) 驛｢譎擾??・?郢晢??驛｢譏ｴ?・?遶頑･???陋ｹ・??・?蜀暦??・?陝ｶ蜷??・?鬩墓得??・?驍ｵ・?陷諤憺?馴辨・??・?・?驍ｵ・?陷会ｽ?遯?・?驍ｵ・?闕ｳ蟯?蜻?驍ｵ・?髴???・?讓抵??・?郢?蛹?・?・?鬩墓ｨ費??譏ｴ?・?髴取ｻゑｽ?・?鬮??薙§?・??驍ｵ・?郢晢??雎ｬ・?驛｢・?陷?逎ｯ蜊?し???・?・?驍ｵ・?雋????驛｢・??・?・?驛｢譎???菴?・?驛｢・??・?・?驍ｵ・??・?・?驍ｵ・?闔会ｽ?邵?螳夲??・?陜｣・??・?・?陞｢・?遯?・?髯???・?・?驍ｵ・??・?・?驍ｵ・?陷?・?・つ郢晢??n3) 鬨?蛹・??・?鬯?・??・?・?髣???闕ｵ譏ｴ?・?驍ｵ・?驕停沖隘夜劑謚ｵ・?・?鬮?・?隲?肩・?・??・?・?驍ｵ・?鬮?・?邵?蟶?・?譎｢・?・?驛｢・??・?・?驛｢謨鳴驛｢・?髮区?∝樺驍ｵ・?闕ｵ譏ｶ??驍ｵ・??・?・?髯?螂???・?髫?蠑ｱ・・?頑･?諢?髢?・?闕ｳ蜊???・?髴???・?讙趣??・??・?・?驍ｵ・?陷?・?・つ郢?闌ｨ・?・?陜｣・??・?・?陞｢・?遶???・?譎擾??・?郢晢??驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢譎???菴?・?驛｢・??・?・?驍ｵ・?陟包???・?・?・つ鬮?・??・?・?驍ｵ・?陷?・??・?迢暦??・?陋ｹ・?遶???驍ｵ・??・?・?鬮?・??・?・?髫?・??・?・?驍ｵ・?陷会ｽ?遯?・?驍ｵ・?闕ｳ蟯?蜻?驍ｵ・?髴???・?讓抵??・?郢晢??n4) 鬩搾??郢???・?・?郢晢??郢晢??髯句??繩??・?・??・?・?驛｢譎?鯵邵?・?驛｢譎｢・?・?驛｢・?陷?蝓滂ｽ?・?驍ｵ・?陷会ｽ?遯?・?驍ｵ・?闕ｳ蟯?蜻?驍ｵ・?髴???・?讓抵??・?郢晢??);
    if(!ok) return;
    runLatencyAssist();
}; }
// 驛｢譎擾??・?郢・驛｢譎｢・?・?/髯?闌ｨ・?・?鬯?????・?驍ｵ・??・?・?UI髫?・??・?・?鬨??郢晢??遶企豪・?・?陋ｹ・??・?莨・??・?隶・?・?・??・?・?鬩穂ｼ夲??・?郢晢??闔・?郢晢??鬯?蟷?・?・?髯区?ゑｽ?・?驍ｵ・??・?・?髯懈圜・?・?髯橸??陞滂ｽ??・?・?郢晢??
// 驛｢譎???・?邵??驛｢・??・?・?髴托ｽ??・?・?髫?・?驍?私??・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?
function setMicStatus(text){
    let el=document.getElementById('micStatusBadge');
    if(!el){ el=document.createElement('div'); el.id='micStatusBadge'; el.style.cssText='position:absolute;top:8px;right:8px;padding:4px 8px;font-size:12px;background:#222;border:1px solid #4e8cff;color:#4e8cff;border-radius:4px;z-index:2000;font-family:sans-serif;'; document.body.appendChild(el);} 
    el.textContent='MIC '+text;
    if(text==='ON'){ el.style.background='#143'; el.style.color='#4eff9d'; el.style.borderColor='#4eff9d'; }
}
function updateMicGateVisual(){ if(!micGateLine) return; // gateThreshold dB 驛｢・?郢晢??0..1 驍ｵ・??・?・?髮・?・?・?鬮?遨ゑｽ?讒ｫ?・(-60..0)
  const norm=Math.min(1,Math.max(0,(gateThreshold+60)/60)); micGateLine.style.left=(norm*100)+'%'; }
// Canvas 驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?郢晢??陜捺?ゑｽ?・??・?・?鬮?諛ｶ・?・?驍ｵ・?陷会ｽ?遯?・?驍ｵ・?郢晢??隨??驍ｵ・?雋?∞???鬮?????・?髯?莨夲??・?郢晢??郢晢??
function resizeCanvas(){
    if(!chartCanvas) return;
    // 鬮?蛹・??・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・?髮区?貞ｴ?恷・??・?・?驍ｵ・?陷会ｽ?遯?・?髯懈圜・?・?髯橸??陞｢・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?髯晢??郢晢??鬯?・?陋滂ｽ??・??驛｢・?陞ｳ螟ｲ・?・??・?・?髯橸??陞滂ｽ??・?・?陜捺??・?蟶敖蛹・??・?髯溯??・?・?髫?轣倩???・?・??・?・?驛｢・?陜｣・??・?・??・?・?髯橸??陞｢・??・??驍ｵ・?陝ｶ蜻?・?荵・・?郢晢??
    const parent=chartCanvas.parentElement; if(parent){
        // 驛｢譎∽??・守､?・?譎｢・?・?驛｢譎???郢晢??驛｢譏???・??・?・?郢晢??遶??晏寰?・?・?驍ｵ・??・?・?content髯晢??郢晢???・?螳夲??閧?・?????・?郢晢???・??驍ｵ・??・?・?驍ｵ・?遶乗劼・?・?霑壼??・?髯句??・?・?驛｢・?陷?蝓滂ｽ?・?鬨?蛹・??・?
        const vvw = (window.visualViewport && window.visualViewport.width) ? window.visualViewport.width : (window.innerWidth || document.documentElement.clientWidth || parent.clientWidth || 0);
        // 鬮?蛹・??・?驍ｵ・??・?・?髯??郢晢??郢晢??髯晢??郢晢???・?・?郢晢??adding/border鬯?・??・?・?髯樊ｺ?遘?・?・?陝ｲ・??・?螳夲??證ｦ・?・?髯橸??郢晢??
        const parentRect = parent.getBoundingClientRect();
        const style = getComputedStyle(parent);
        const padL = parseFloat(style.paddingLeft)||0, padR = parseFloat(style.paddingRight)||0;
        const borL = parseFloat(style.borderLeftWidth)||0, borR = parseFloat(style.borderRightWidth)||0;
        const inner = Math.max(0, Math.floor(parentRect.width - padL - padR - borL - borR));
        // 髯晢???・?・?髯句??・?・?驍ｵ・??・?・?鬩搾???・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴驛｢譎｢・?・?驛｢譏???・?郢晢??驛｢譎｢・?・?髯具??郢晢???・?螳壽???・?・?驍ｵ・?隲?諛ｶ・?・?髴???・?讓抵??・??・?・?髯晢??郢晢???・?・??・?・?髣???隴趣???・?・?闔・?郢晢??髫?蟶?・?蛟･笳・Δ譎｢・?・?髯晢??郢晢???・?・??・?・?驛｢・?髮区??・?鬥?・?蛹・??・?驍ｵ・?陷?・??・?迢暦??・?雋?∞??竏ｬ螻?惱・??・?・?隲帷???・?髫????髯樊ｻゑｽ?・?髯区?ゑｽ?・?驛｢・?陷?蝓滂ｽ?・?鬨?蛹・??・?郢晢??郢晢??
        // 髯晢???・?・?髯?・??・?・?驍ｵ・??・?・?鬩搾???・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴驛｢譎｢・?・?驛｢譏???・?郢晢??驛｢譎｢・?・?髯具??郢晢???・?螳壽???・?・?驍ｵ・?隲?諛ｶ・?・?髴???・?・?
        let leftW = 0, rightW = 0;
        try{
            const rightPanel = document.getElementById('rightVerticalPanel');
            if(rightPanel){ const w = Math.ceil(rightPanel.getBoundingClientRect().width)||0; rightW = w; }
        }catch(_){ /* ignore */ }
    const sideTotal = Math.max(0, /*leftW +*/ rightW);
        const innerAfterSides = Math.max(0, inner - sideTotal);
        const vvwAfterSides = Math.max(0, Math.floor(vvw) - sideTotal);
        // 髫????髯・闕ｳ讖ｸ・?・?郢晢???・?蟶晢???・?・?髣???隴擾???・??驍ｵ・??・?・? 0px 驍ｵ・??・?・?驍ｵ・??・?・?驛｢・?陝ｲ・?遶企?・?・?郢晢???・?閧?・?・?郢晢??遶企豪・?・?陷?・??・??
        let avail = Math.max(120, innerAfterSides, vvwAfterSides);
        // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕娯雷驍ｵ・??・?・?CSS髯晢??郢晢???・?繧頑?隴?・?隰・驍ｵ・?陷会ｽ?遯?・?驍ｵ・?遶乗?萓?鬩????・?・?驍ｵ・?隶呵??・?・??・?・?髫?蟷?・?・?髯晢??郢晢???・?蟶晏ｱ・?晢??遶擾??驍ｵ・??・?・?驍ｵ・?郢晢???・?閧?・?・?郢晢??遶企豪・?・?陷?・??・??
        chartCanvas.width = avail; // flex 髫?・?陋滂ｽ??・?・?陷?譎｢・?・?郢晢??・ゑｽ?驛｢・?霑壼遜??・??・?・?髯??鯉ｽ?謚ｫ?・?
        chartCanvas.style.width = avail + 'px';
        chartCanvas.height=parent.clientHeight; // container 鬯?・?陋滂ｽ??・??
    } else {
        chartCanvas.width=chartCanvas.clientWidth;
        chartCanvas.height=chartCanvas.clientHeight;
    }
    // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?蠕?・?驍ｵ・??・?・?髯晢??郢晢???・?繧・・??・?・?髫?蟷?・?・?髯晢??郢晢??遶企豪・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?
    try{
        const bar = document.getElementById('timelineScrollBar');
        const input = document.getElementById('timelineScroll');
        if(bar){
            const vvw = (window.visualViewport && window.visualViewport.width) ? window.visualViewport.width : (window.innerWidth || document.documentElement.clientWidth || 0);
            const parent = bar.parentElement || document.body;
            const rect = parent.getBoundingClientRect();
            const st = getComputedStyle(parent);
            const pad = (parseFloat(st.paddingLeft)||0) + (parseFloat(st.paddingRight)||0) + (parseFloat(st.borderLeftWidth)||0) + (parseFloat(st.borderRightWidth)||0);
            const innerW = Math.max(0, Math.floor(rect.width - pad));
            const maxW = Math.min(innerW, Math.floor(vvw));
            bar.style.maxWidth = maxW + 'px';
            bar.style.width = '100%';
        }
        if(input){ input.style.maxWidth = '100%'; input.style.width = '100%'; }
    }catch(_){ }
}
// ---- Debug ----
window._appState={startPlayback,pausePlayback,seekTo,seekRelative};
// 鬮?????・?髯?莨夲??・?驛｢譏ｴ?・?郢晢??驛｢譏ｴ?・?邵??: 驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢・??・?・?髴托ｽ??・?・?髫?・?闕ｵ譏ｴ?帝Δ譎｢・?・?驛｢譎丞ｹ?遶??敖・??・?・?鬩搾??髣??湖｣驛｢・??・?・?驛｢譏???・?邵??
window._printAudioState=function(){
    try{
        const st = audioCtx? audioCtx.state: 'noctx';
        const gv = melodyGain? melodyGain.gain.value: null;
        const av = accompGain? accompGain.gain.value: null;
    const mgConn = !!masterGain;
    const compConn = !!compressor;
    const limConn = !!limiter;
    console.log('[audio-state]',{state:st, gv, av, isPlaying, playbackPosition, playbackStartPos, scheduledUntil, voices:{synth:activeVoices.length, sample:activeSampleVoices.length}, chain:{master:mgConn, comp:compConn, lim:limConn, direct:_directRouteOn}});
    }catch(e){ console.warn(e); }
};
// AudioContext 鬯?・??・?・?鬮?・?霑ｹ螟ｲ・?・??・?・?髫???・?・?郢晢??髢?・?隨冗｢・??・??・?・?髯具??郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢謨鳴驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯?・??・?・?鬮?證ｮ鞫?陜滂ｽ?郢晢??郢晢??
let _ctxDiagTimer=null, _ctxDiagLast={t:0, ct:0, pos:0};
window._ctxDiagStart=function(intervalMs=250){
    try{ ensureAudio(); }catch(_){ }
    if(_ctxDiagTimer) return console.warn('ctxDiag already running');
    // 髣????・?・?鬨?蛹・??・?: 髯???・?・?髯?迚呻??蜩?S驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・?隴?・?隰費??髫俶誓??・?髯??趣??謚ｫ?驢搾??・?髢?・??・?・??・?・?髫?蝓手??雎撰??驛｢・?髮区???・?鬯?蟷?・?・?驍ｵ・??・?・?鬨?蛹・??・?髫?・?郢晢??
    let ana=_levelAnalyser; let tmpBuf=null;
    if(!ana){
        try{ ana=audioCtx.createAnalyser(); ana.fftSize=1024; ana.smoothingTimeConstant=0.2; (limiter||compressor||masterGain).connect(ana); tmpBuf=new Float32Array(ana.fftSize); }catch(_){ }
    } else {
        tmpBuf=new Float32Array(ana.fftSize);
    }
    _ctxDiagLast={ t: performance.now(), ct: (audioCtx? audioCtx.currentTime: 0), pos: playbackPosition||0 };
    _ctxDiagTimer=setInterval(()=>{
        try{
            const nowP=performance.now();
            const ct= audioCtx? audioCtx.currentTime: 0;
            const pos= playbackPosition||0;
            const dtP=(nowP-_ctxDiagLast.t)/1000;
            const dCtx= ct - _ctxDiagLast.ct;
            const dPos= pos - _ctxDiagLast.pos;
            let db=null;
            if(ana && tmpBuf){ ana.getFloatTimeDomainData(tmpBuf); let s=0; for(let i=0;i<tmpBuf.length;i++){ const v=tmpBuf[i]; s+=v*v; } const rms=Math.sqrt(s/Math.max(1,tmpBuf.length)); db=20*Math.log10(Math.max(1e-7,rms)); }
            console.log('[ctxDiag]',
                `perf+${dtP.toFixed(3)}s`,
                `ctx+${dCtx.toFixed(3)}s`,
                `pos+${dPos.toFixed(3)}s`,
                `ratio=${(dCtx/dtP).toFixed(2)}`,
                (db!=null? `RMS=${db.toFixed(1)}dB`: 'RMS=na'),
                `state=${audioCtx? audioCtx.state: 'noctx'}`
            );
            _ctxDiagLast={ t: nowP, ct: ct, pos: pos };
        }catch(e){ console.warn('ctxDiag err',e); }
    }, Math.max(50, intervalMs|0));
    console.warn('ctxDiag: START');
};
window._ctxDiagStop=function(){ if(_ctxDiagTimer){ clearInterval(_ctxDiagTimer); _ctxDiagTimer=null; console.warn('ctxDiag: STOP'); } };
// 髣???・つ髴托ｽ??・?・?驍ｵ・??・?・?驍ｵ・?鬩?讎???・?鬩???闕ｵ譏ｶ蜻?驛｢・??・?・?驛｢譎樔ｺゑｾ取刮・?・??・?・?驛｢譎｢・?・?驛｢・?髮区???・?驍ｵ・?陷会ｽ?遯?・? context 驛｢・?陜｣・??・?・??・?・?髯橸??雋???? wake 驍ｵ・?髴域喚髮?驛｢・?郢晢??
window._kickAudio=function(){ try{ ensureAudio(); const t=audioCtx.currentTime+0.001; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='square'; o.frequency.setValueAtTime(1000,t); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.03,t+0.005); g.gain.exponentialRampToValueAtTime(0.0001,t+0.06); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.07); console.warn('kickAudio fired'); }catch(e){ console.warn('kickAudio failed',e); } };

// Convenience aliases (no underscore) for console usage
window.enableLevelMeter = function(on){ return window._enableLevelMeter(on); };
window.ctxDiagStart = function(interval){ return window._ctxDiagStart(interval); };
window.ctxDiagStop = function(){ return window._ctxDiagStop(); };
window.printAudioState = function(){ return window._printAudioState(); };

// 驛｢譎擾??・?郢晢??驛｢・??・?・?驍ｵ・?陟募?湖｣驛｢譏ｴ?・?邵?驢搾??・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎擾??・?遶頑･?諤??・?・?驍ｵ・??・?・?驍ｵ・?雋?∞??閾?・?譎???・?邵??驛｢・??・?・?驛｢・?陞ｳ螢??・?髯?讎贋ｾ帷??蜑ｰ・???・?・?郢晢??闔・??・?・??・?・?髯晢???・?・?髫?蠑ｱ・・?晢??髫?髮?・?・?鬯?・?髣???譌ｺ驛｢・?驗呻??郢晢??驍ｵ・??・?・?鬯?・?陷?・?・ゑｽ?驍ｵ・??・?・?髯??隶守ｿ??・?髫?蟶?・?・?陜滂ｽ?郢晢??郢晢??
try{
    document.addEventListener('visibilitychange', async()=>{
        if(document.hidden){
            stopMic();
        } else {
            try{ if(await canInitMicWithoutPrompt()){ await initMic(false).catch(()=>{}); } }catch(_){ }
        }
    });
}catch(_){ }

// Panic: 髯?闌ｨ・?・?髯句??繩??・?・??・?・?驕ｶ雍????udioContext髯溷桁??・?驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??驕ｶ髮・??譏ｴ?・?鬩搾??陞｢・??・?・??・?・?髯?蛹??・?
window.audioPanic = function(){
    try{ forceStopAllVoices(); }catch(_){ }
    try{ if(schedTimer) clearInterval(schedTimer); schedTimer=null; }catch(_){ }
    try{ if(audioCtx && audioCtx.state==='running'){ /* 鬮???・?・?驍ｵ・?郢晢??郢晢??驛｢譏ｴ?・?邵?? */ ensureKeepAlive(); } }catch(_){ }
    try{ ensureConvolver(); ensureKeepAlive(); }catch(_){ }
    console.warn('audioPanic executed');
};

// 鬨?・??・?・?鬩搾??髣??湖｣驛｢・??・?・?驛｢譏???・?邵?蟶?・?・??・?・?鬩・?・?・?髫?蜑ｰ萓ｭ邵?鬘費??・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?
window.setDirectRoute = function(on){ return window._directRoute(!!on); };

// 髯?螂???・?髫?蠑ｱ・・?・1鬯?・??・?・?驍ｵ・??・?・?驍ｵ・?陷茨??FZ驛｢・?陝ｶ譎｢・?・??・?・?驛｢・?陝ｲ・?隨・郢晢??郢晢??imple鬩搾??霑ｹ螟ｲ・?・??・?・?郢晢??郢晢??
window.playSfzNow = function(midi=60, dur=0.5){ try{ ensureAudio(); const when=audioCtx.currentTime+0.03; return simplePlaySfz(midi, when, dur, masterGain||audioCtx.destination); }catch(_){ return false; } };

// 鬨?・??・?・?髫?證ｦ・?・? destination 驍ｵ・??・?・?髯???・?・?驍ｵ・?陷?荵暦??・?郢晢??陋ｹ・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?髯橸??隰疲?・・?鬮?莉｣・・椽阮・・?郢晢??
window.playSfzNowDirect = function(midi=60, dur=0.5){
    try{
        ensureAudio();
        const when=audioCtx.currentTime+0.03;
        return simplePlaySfz(midi, when, dur, audioCtx.destination);
    }catch(_){ return false; }
};

// 髴托ｽ??・?・?髫?・?闕ｵ譏ｴ?・?鬮?陬懈が?・?・?郢晢??郢・驛｢譎｢・?・?驛｢譏ｴ?・?
window.debugSummary = function(){
    try{
        const map = (instrumentMaps.Piano&&Object.keys(instrumentMaps.Piano).length)? instrumentMaps.Piano : (instrumentMaps.Flute&&Object.keys(instrumentMaps.Flute).length? instrumentMaps.Flute : pianoSampleMap);
        const keys = map? Object.keys(map).length: 0;
        const notes = (currentTracks||[]).reduce((a,t)=> a + ((t?.notes?.length)||0), 0);
        const out = {
            audioState: audioCtx? audioCtx.state: 'noctx',
            SIMPLE_SFZ_MODE,
            tracks: (currentTracks||[]).length,
            notes,
            sampleKeys: keys,
            voices: { synth: activeVoices.length, sample: activeSampleVoices.length },
            scheduledUntil,
            playback: { pos: playbackPosition, startPos: playbackStartPos }
        };
        console.table(out);
        return out;
    }catch(e){ console.warn('debugSummary failed', e); return null; }
};
// 鬨?・??・?・?鬩搾??髣??・・?髯樊ｺ?・?闊瑚??垈證ｦ・?・?鬩搾??陞｢・??・?蟶晢??蛹・??・?驍ｵ・?闔会ｽ??・?迢暦??・?雋?∞??竏ｫ・?・??・?・?驛｢譎???驥・??・?・??・?・?
let _directRouteOn=false;
window._directRoute=function(on=true){
    if(!audioCtx||!masterGain) return;
    try{
        if(on){
            if(_directRouteOn) { console.warn('Direct route: already ON'); return; }
            // 髫??会ｽ?・?髯・陋滂ｽ?郢晢??鬩搾??霑ｹ螟ｲ・?・??・?・?驛｢・?陷・?・?・?・つ髫??会ｽ?・?髯樊ｻ薙§?・??驍ｵ・??・?・?驍ｵ・??・?・?asterGain 驛｢・?陜｣・?陝ｲ・?髫?證ｦ・?・? destination 驍ｵ・??・?・?
            try{ masterGain.disconnect(); }catch(_){ }
            masterGain.connect(audioCtx.destination);
            _directRouteOn=true;
            console.warn('Direct route: ON (masterGain -> destination ONLY)');
        } else {
            if(!_directRouteOn){ console.warn('Direct route: already OFF'); return; }
            // 鬨?・??・?・?鬩搾??髣??会ｽ?螳壽?碑ｬ費???・??驍ｵ・?遶擾??鬩?迹壽??椶・?郢晢??驛｢譏ｶ?螢?笙るΔ譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髫??会ｽ?・?驍ｵ・?郢晢??
            try{ masterGain.disconnect(); }catch(_){ }
            // 髫??会ｽ?・?髯橸??陞｢・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯??髢?・??・?・?霑｢證ｦ・?・?闔ｨ螟ｲ・?・?郢晢??reOutMergeGain 鬩???陝ｲ・??・?蟶晁箔郢晢??郢晢??郢晢??郢晢??
            if(preOutMergeGain){
                try{ masterGain.connect(preOutMergeGain); }catch(_){ }
            }else if(compressor){
                try{ masterGain.connect(compressor); }catch(_){ }
            }
            // 髯滂ｽ??・?・?驍ｵ・??・?・?驍ｵ・?雋?∞??竏ｬ閼り耳諛ｶ・?・??・?・?驛｢・??・?・?驛｢譎???譁絶凾驛｢・??・?・?驛｢譎?樟郢晢??鬯???隱??・?・?陞｢・??・?繧具???・?・?髣???郢晢??
            try{ ensureConvolver(); }catch(_){ }
            _directRouteOn=false;
            console.warn('Direct route: OFF (restored default chain)');
        }
    }catch(e){ console.warn('direct route toggle failed',e); }
};
// 髯???・?・?髯?迚呻??蜴?讓抵??譎??・取刮・?・??・?・?鬩・?・?・?髫?蜑ｰ萓ｭ・守坩・?譏???譏ｴ??郢晢??郢晢??MS郢晢??陝ｲ・?・つ郢?菫・??鬯?・??・?・?髯具??隰費??郢晢??髯?・?雋???陞ｻ蜑ｰ?慕ｹ晢???・?鬘伜ｴ慕ｹ晢???・??鬨?蛹・??・?驍ｵ・?郢晢??
let _levelAnalyser=null, _levelTimer=null, _recentRMS=[];
function _computeRMS(buf){
    let sum=0; for(let i=0;i<buf.length;i++){ const v=buf[i]; sum+=v*v; }
    const rms=Math.sqrt(sum/Math.max(1,buf.length));
    const db = 20*Math.log10(Math.max(1e-7, rms));
    return db;
}
window._enableLevelMeter=function(on=true){
    ensureAudio();
    try{
        if(on){
            if(!_levelAnalyser){
                _levelAnalyser=audioCtx.createAnalyser();
                _levelAnalyser.fftSize=2048; _levelAnalyser.smoothingTimeConstant=0.2;
                // 髯???・?・?髯?迚呻??蜷??・?髯具??郢晢???・?・?陷郁ご・??鬩搾??陞滂ｽ??・?・?髢?・?陝ｲ・?鬩搾??髣??湖｣驛｢・??・?・?驛｢譏???・?邵?蟷・??蠑ｱ・・??蝣?・?・?郢?逎ｯ蜊?し??陋ｹ・??・?迢暦??・?陋ｹ・?遶??? masterGain 驛｢・?郢?閧?・??鬩搾??陞滂ｽ??・?・?郢晢??
                let connected=false;
                try{ if(limiter){ limiter.connect(_levelAnalyser); connected=true; } }catch(_){ }
                try{ if(!connected && compressor){ compressor.connect(_levelAnalyser); connected=true; } }catch(_){ }
                try{ if(!connected && masterGain){ masterGain.connect(_levelAnalyser); connected=true; } }catch(_){ }
            }
            const buf=new Float32Array(_levelAnalyser.fftSize);
            if(_levelTimer) clearInterval(_levelTimer);
            _levelTimer=setInterval(()=>{
                try{
                    _levelAnalyser.getFloatTimeDomainData(buf);
                    const db=_computeRMS(buf);
                    _recentRMS.push({t:performance.now(), db});
                    if(_recentRMS.length>200) _recentRMS.splice(0,_recentRMS.length-200);
                    // 500ms髮惹??・?・?遶頑･?・?蠑ｱ・・・?・?遶丞､?・?螳壽・・?・?驍ｵ・?陷?・??・?・?陋ｹ・?邵?蟶?・?譏???・?・主?晢??・??・?・?髮・?・?・?郢晢??郢晢??
                    if(Math.floor(performance.now()/500)!==Math.floor((performance.now()-100)/500)){
                        console.log('[level]', db.toFixed(1),'dB', 'isPlaying=',isPlaying);
                    }
                }catch(e){ /* ignore */ }
            }, 100);
            console.warn('Level meter: ON');
        }else{
            if(_levelTimer){ clearInterval(_levelTimer); _levelTimer=null; }
            // _levelAnalyser 驍ｵ・??・?・?髫?・?闕ｵ譎｢・??驍ｵ・??・?・?驛｢・?郢??隲橸??髣???隲・騾?驢搾??・??・?・?驍ｵ・?隴会ｽ??・?・?陜捺??・??鬩搾??陞｢・?郢晢??鬨?・??・?・?鬮??薙§郢晢??驍ｵ・??・?・?郢晢??郢晢??
            console.warn('Level meter: OFF');
        }
    }catch(e){ console.warn('level meter failed',e); }
};
window._dumpRecentRMS=function(n=30){
    const arr=_recentRMS.slice(-n).map(x=>({dt:((x.t-(_recentRMS[0]?.t||x.t))/1000).toFixed(2)+'s', db:x.db.toFixed(1)}));
    console.table(arr);
};
// ---- Environment / Debug Helpers ----
function showFileProtocolWarning(){ /* 髣???髴???・?繧会ｽ?・?陷会ｽ?遶企?・?・?郢晢???・?・?陋ｹ・?郢・驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?鬯?・?隶・?・?・??・?・?鬩穂ｼ夲??・?郢晢??郢晢??*/ }
window.playTestTone=function(){ ensureAudio(); const t=audioCtx.currentTime; try{ const osc=audioCtx.createOscillator(); const g=audioCtx.createGain(); osc.type='sine'; osc.frequency.setValueAtTime(440,t); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.4,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+1.2); osc.connect(g); g.connect(masterGain||audioCtx.destination); osc.start(t); osc.stop(t+1.25); console.log('Test tone scheduled'); }catch(e){ console.warn('test tone failed',e); } };
window.showSchedStat=function(){ console.log('scheduledCounter',scheduledCounter,'playbackPosition',playbackPosition.toFixed(3)); };
// ================= ZIP Piano Loader (Skeleton) =================
// Store(髴取ｻゑｽ?・?髯懶???・?・?鬩搾???・?・?) 髯・郢?閾?闊?鬩・?・?・?髫?荳・・?unzip 驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・? (mini pack 鬨?蛹・??・?)
function unzipStoreOnly(u8){
    const files={};
    let p=0; const dv=new DataView(u8.buffer,u8.byteOffset,u8.byteLength);
    function readStr(off,len){ return new TextDecoder().decode(u8.subarray(off,off+len)); }
    while(p+4<=u8.length){
        const sig=dv.getUint32(p,true);
        if(sig===0x04034b50){ // local file header
            if(p+30>u8.length) break;
            const compMethod=dv.getUint16(p+8,true); // 0=store
            const compSize=dv.getUint32(p+18,true);
            const uncompSize=dv.getUint32(p+22,true);
            const nameLen=dv.getUint16(p+26,true);
            const extraLen=dv.getUint16(p+28,true);
            const nameStart=p+30;
            const dataStart=nameStart+nameLen+extraLen;
            if(dataStart+compSize>u8.length){ console.warn('ZIP fallback: data overflow'); break; }
            const name=readStr(nameStart,nameLen);
            if(compMethod!==0){ console.warn('ZIP fallback: 鬯?・?隶抵???・?・??・?・?髯滂ｽ?隲幢??隰費??鬩搾???・?・? method',compMethod,'髯?・?隶朱?披・',name); return null; }
            const data=u8.slice(dataStart,dataStart+compSize); // store 驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?隴擾??郢晢??驍ｵ・??・?・?驍ｵ・??・?・?
            files[name]=data;
            p=dataStart+compSize; // 髫?・??・?・?驍ｵ・??・?・?
            continue;
        }
        if(sig===0x02014b50 || sig===0x06054b50){ // central directory or end
            break; // local 鬯?蟷?・?・?鬩搾??郢???・?・?郢晢??
        }
        // 髣???髢?・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢譎樔ｺらｹ晢??驛｢譎｢・?・? -> 髣????・?・?髫???・?・?
        break;
    }
    return Object.keys(files).length? files:null;
}
async function loadPianoZipFile(f){
    if(!f){ return; }
    setPianoZipStatus('鬮?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?髣????・?・?...');
    let ab; try{ ab=await f.arrayBuffer(); }catch(e){ setPianoZipStatus('鬮?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?髯樊ｻゑｽ?・?髫?・?郢晢??); console.warn(e); return; }
    // 髣懈瑳蜑?・?・?郢晢?? fflate
    let files=null; let usedFallback=false;
    const bufU8=new Uint8Array(ab);
    if(fflate && typeof fflate.unzipSync==='function' && !/髫?蟷?・?・?髴大??・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?§・主??・?譎｢・?・?/.test(fflate.unzipSync.toString())){
        try{ files=fflate.unzipSync(bufU8); }
        catch(e){ console.warn('fflate unzip 髯樊ｻゑｽ?・?髫?・?郢晢?? fallback 鬮?・??・?・?鬮?・?郢晢??,e); }
    }
    if(!files){
        files=unzipStoreOnly(bufU8); usedFallback=true;
    }
    if(!files){ setPianoZipStatus('ZIP髯橸??隴会ｽ?陝ｷ謌?｣・・?・?髫?・?郢晢??); return; }
    // manifest 髫?證ｦ・?・?鬩肴得??・?
    let manifestEntry=null; for(const k in files){ if(/manifest\.json$/i.test(k)){ manifestEntry=k; break; } }
    if(!manifestEntry){ setPianoZipStatus('manifest.json 髣???隶朱?対・); return; }
    try{ const txt=new TextDecoder().decode(files[manifestEntry]); pianoZipManifest=JSON.parse(txt); }catch(e){ setPianoZipStatus('manifest鬮?證ｦ・?・?髫?・?闔牙遜??・??・?・?髫?・?郢晢??); console.warn(e); return; }
    pianoZipFiles=files; setPianoZipStatus('manifest鬮?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?髯橸??陟包???・?・?郢晢??+(usedFallback?' (fallback unzip)':''));
    prepareInitialSampleQueue();
    startProgressiveDecode();
}
function prepareInitialSampleQueue(){
    if(!pianoZipManifest || !pianoZipManifest.files) return;
    // 髣????・?・?髯滂ｽ?郢晢??(manifest.center 驍ｵ・??・?・?驍ｵ・?雋???・? 60) ?・?繧托ｽ?・?6 驍ｵ・??・?・? mf 髯橸???・?・?驛｢・?髮区?樒?髯???迴?・つ郢?菫・??驍ｵ・?闔会ｽ??・?讙趣??・??・?・?髣碑崟鞫??・?・??・?・?驍ｵ・?郢晢??
    const center=pianoZipManifest.center||60; const mfLayer=(pianoZipManifest.layers||[]).includes('mf')? 'mf': (pianoZipManifest.layers? pianoZipManifest.layers[0]: null);
    const essential=[]; const others=[];
    pianoZipManifest.files.forEach(e=>{
        if(e.release) return; // 髯溷?薙＝陞?骰具??・?郢晢??
        if(!e.layer) e.layer=mfLayer;
        const dist=Math.abs((e.m??e.midi??e.note)-center);
        if(e.layer===mfLayer && dist<=6) essential.push(e); else others.push(e);
    });
    essential.sort((a,b)=>Math.abs((a.m??a.midi)-center)-Math.abs((b.m??b.midi)-center));
    pianoZipDecodeQueue=[...essential,...others];
}
function startProgressiveDecode(){ if(pianoZipDecoding) return; pianoZipDecoding=true; decodeNextInQueue(); }
function decodeNextInQueue(){
    if(!pianoZipDecodeQueue.length){ pianoZipDecoding=false; setPianoZipStatus('驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取?・??鬮???・?蜻?讌懆?????・?・?郢晢??); return; }
    if(pianoZipDecodePaused || isPlaying){ return decodeNextLater(); }
    const entry=pianoZipDecodeQueue.shift();
    const file=entry.file; if(!file){ decodeNextLater(); return; }
    const u8=findZipFile(file);
    if(!u8){ decodeNextLater(); return; }
    ensureAudio();
    audioCtx.decodeAudioData(u8.buffer.slice(u8.byteOffset,u8.byteOffset+u8.byteLength),buf=>{
        // 鬨?蜈ｷ・?・?鬯?・??・?・?: midi 髯区?ゑｽ?・?驍ｵ・??・?・? layer 驍ｵ・??・?・?鬮?蜿???髮・??迹壼??郢晢??(鬩・?・?・?髫?荳・・? pianoSampleBuffers 驛｢・?髮区???・?髯具???・?・?鬨?蛹・??・?驍ｵ・?陷?・??・?迢暦??・?郢晢??layer髴取ｻゑｽ?・?鬮?霈?・?
    const midi=entry.m||entry.midi||entry.note;
        if(typeof midi==='number'){
            if(!pianoSampleMap[midi]) pianoSampleMap[midi]={layers:{},release:null,gains:{}};
            if(entry.release){ pianoSampleMap[midi].release=buf; }
            else {
                const layer=entry.layer||'mf';
        pianoSampleMap[midi].layers[layer]={ buffer:buf, root: midi, loop: entry.loop };
                if(typeof entry.gain==='number') pianoSampleMap[midi].gains[layer]=entry.gain;
                // 髣・陷?逎ｯ蜈ｱ: 髯溷?鍋袖隰?繧????隲・?・?・??・?・?鬨?蛹・??・?驍ｵ・??・?・?髣比ｼ夲??・?鬮?・??・?・?驛｢・?郢晢??pianoSampleBuffers 驍ｵ・??・?・?
                pianoSampleBuffers[midi]=buf;
            }
        }
    if(entry.impulse || (pianoZipManifest && pianoZipManifest.impulse===entry.file)){ pianoIRBuffer=buf; ensureConvolver(); }
    // 鬩搾???・?・?鬮?・?郢晢??
    if(typeof midi==='number' && !entry.release){ SAMPLE_USE_STATS[midi]={ lastUse:performance.now(), size:buf.length }; }
        setPianoZipStatus('驛｢譏ｴ?・?邵?諷???譎｢・?・?驛｢譏ｴ?・?'+(Object.keys(pianoSampleBuffers).length)+' / ' + pianoZipManifest.files.length);
        decodeNextLater();
    },err=>{ console.warn('decode髯樊ｻゑｽ?・?髫?・?郢晢??,file,err); decodeNextLater(); });
}
function decodeNextLater(){ setTimeout(decodeNextInQueue, 30); }
function findZipFile(path){ if(!pianoZipFiles) return null; for(const k in pianoZipFiles){ if(k.endsWith(path)) return pianoZipFiles[k]; } return pianoZipFiles[path]||null; }
// UI驛｢・??・?・?驛｢譎??・趣??驛｢譎???・?・?髯應ｼ夲??・?陋滂ｽ??・??
if(pianoZipBtn && pianoZipInput){ pianoZipBtn.onclick=()=>pianoZipInput.click(); }
if(pianoZipInput){ pianoZipInput.onchange=e=>{ const f=e.target.files[0]; if(f) loadPianoZipFile(f); }; }
// SFZ 驛｢譎????青ｰ驛｢譎｢・?・?驛｢謨鳴鬮?・??・?・?鬮?雜｣・?・?
if(sfzDirBtn && sfzDirInput){ sfzDirBtn.onclick=()=>sfzDirInput.click(); }
if(sfzDirInput){ sfzDirInput.onchange=async e=>{
    const files=[...e.target.files]; if(!files.length){ return; }
    setPianoZipStatus(`SFZ鬮?證ｦ・?・?髫?・?髯應ｼ夲??・??・?・?... (髯?闌ｨ・?・?髯?蟲??・?${files.length}髣比ｼ夲??・?)`);
    if(files.length<=2){ console.warn('鬯?蛹・??・?髫?螢?・?・??・??驛｢・?陟募??陞ｺ驛｢譎???譁撰?憺Δ???・?・?驛｢譎｢・?・?髫?・??・?・?驍ｵ・?隴?・??・?・??・?・?鬩????・?・?驍ｵ・??・?・?髯・闔会ｽ?遶企?・?・?郢晢??邵?蝣?・?・?陷?・?・つ郢??郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢謨鳴髯?闌ｨ・?・?髣???髦?蜷??・?鬯?蛹・??・?髫?螢?・?・??・??驛｢・?陟募???・?驍ｵ・?郢晢??遶企?・?・?郢晢??陟?鬮?・??・?・?髫?・??・?・?驍ｵ・?陟募??譌ｺ驛｢・?驗呻??遶擾??驍ｵ・?陷?・?・つ郢晢??);
        if(sfzStatus) sfzStatus.textContent='髯?闌ｨ・?・?髯?迚呻??蜷??・?髯・闔会ｽ?遶企?・?・?陷?・?驍?驍ｵ・??・?・?驍ｵ・?陷?・?・つ郢??郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢謨鳴鬯?蛹・??・?髫?螢?・?髮・・?驍ｵ・??・?・?驍ｵ・?陟募?湖ｨ驛｢・??・?・?驛｢譎｢・?・?驛｢謨鳴驛｢・?陝ｶ譎擾??諷???・?闕ｳ迺??鬮?・?邵?螳夲?????髣???髮榊?・?・?鬮?・?郢晢??髫??会ｽ?・?髯???・?・?驛｢譎????青ｰ驛｢譎｢・?・?驛｢謨鳴驛｢・?陝ｶ譏ｶ?閧?・?・?髦?蜷??蝣?・?・?闕ｳ蟯?蜻?驍ｵ・?髴???・?讓抵??・??・??冢dows驍ｵ・??・?・?驍ｵ・??・?・?Chrome/Edge髫?證ｦ・?・?髯槭???・?驍ｵ・?郢晢??;
    }
    if(sfzStatus) sfzStatus.textContent='鬮?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?髣????・?・?...';
    // 鬯?蛹・??・?髫?螢?・?・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢謨鳴髯??郢晢??郢晢?? .sfz 驛｢・?髮区???・?驍ｵ・??・?・?髯・?・?・?鬮?雜｣・?・?
    const sfzFiles=files.filter(f=>/\.sfz$/i.test(f.name));
    // 髯?・?郢?迺??郢晢??・取ｺ?・?・??・?・?: 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取?螻?惱・??・?・?隲????
    const sampleCandidates=files.filter(f=>/\.(wav|ogg|m4a|mp3)$/i.test(f.name)).length;
    if(window.DEBUG_SAMPLE_NOTE){ console.log('SFZ髯?闌ｨ・?・?髯?迚呻??蜷??ｨ驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?: sfz=', sfzFiles.length, ' samples=', sampleCandidates, ' total=', files.length); }
    if(sfzStatus){ sfzStatus.textContent = `髫??隲幢??郢晢??: 髯?闌ｨ・?・?${files.length}髣比ｼ夲??・? / sfz ${sfzFiles.length}髣比ｼ夲??・? / 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・・ ${sampleCandidates}髣比ｼ夲??・?`; }
    if(sampleCandidates===0){ if(sfzStatus) sfzStatus.textContent += '郢晢??陋ｹ・?邵?遉ｼ・?譎｢・?・?驛｢譎丞ｹ?・・0髣比ｼ夲??・?郢晢??陜檎ｴ?mples驛｢譎????青ｰ驛｢譎｢・?・?驛｢謨鳴驍ｵ・?隴∫???螳夲?????髣???髮榊?・?・?鬮?・??・?蟶晢??蛹・??・?髫?螢?・?・??・??驍ｵ・??・?・?驍ｵ・?闕ｳ蟯?蜻?驍ｵ・?髴???・?讒ｭ?・?郢晢??; }
    if(!sfzFiles.length){ setPianoZipStatus('sfz驍ｵ・?霑ｹ螟ｲ・?・?闕ｵ譏ｶ蜻?驍ｵ・?闕ｵ譎｢・?鬘費??・??・?・?驍ｵ・?陝ｶ蜻?・??'); if(sfzStatus) sfzStatus.textContent='鬮?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?髯樊ｻゑｽ?・?髫?・?郢晢??sfz驍ｵ・??・?・?驍ｵ・?郢晢??'; return; }
    ensureAudio();
    // 驛｢譎???譁撰?憺Δ???・?・?驛｢譎｢・?・?驛｢譎???・?郢晢??驛｢譎?惧?・?・?髢?・?陟咲霜豎?・?・?驛｢譏???・?邵?蟶?・?髮・??・?ile郢晢??陝ｲ・?遶??壽??闕ｵ??讀?髯・驍????・?・??・?・?鬮?遨ゑｽ?讒ｫ?・Δ???・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢・??・?・?
    const fileMap={};
    const fileMapLower=new Map();
    const nameIndexLower=new Map(); // basename(lower) -> File郢晢??騾趣??郤・??鬮?髦??・?陷・??驍ｵ・??・?・?鬯?貊難??鄙ｫ?・?驍ｵ・??・?・?驍ｵ・?陷?・??・?荵・・?郢晢??
    files.forEach(f=>{
        const p=f.webkitRelativePath.replace(/\\/g,'/');
        fileMap[p]=f; fileMap[f.name]=f;
        const pl=p.toLowerCase(); fileMapLower.set(pl, f);
        const base=f.name.toLowerCase();
        if(!nameIndexLower.has(base)) nameIndexLower.set(base, f); else {
            const cur=nameIndexLower.get(base);
            if(Array.isArray(cur)) cur.push(f); else nameIndexLower.set(base, [cur, f]);
        }
    });
    // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取刮・?譏ｴ?・?邵?諷???譎｢・?・?驛｢譎擾??・?邵?蜀暦??譎｢・?・?驛｢譏ｴ?・?邵?蜥擾??譎｢・?・?
    const decodeCache=new Map(); // key: relPath -> AudioBuffer
    // 鬩搾??陷亥沺・?・?髫?・??・?・?鬩堺?・・?
    const loadedInstruments=[];
    // 驛｢譎｢・?・?驛｢・??・?・?鬩搾???・?・?鬮?・?郢晢??
    const stats={ ok:0, fail:0, notFound:0, byExt:{} };

    // 髯?闌ｨ・?・?鬯?・?陞｢・?郢晢??驛｢譎｢・?・?驛｢譏ｴ?・? SFZ驛｢譏ｴ?・?邵?蜀暦??・??・?・?驛｢譎樞?郢晢??regions郢晢??郢晢??region>驛｢譎?§・取ｺ?・?譏ｴ?・?邵?驢搾??・?陋幢??郢晢??驛｢譎｢・?・?驛｢譏ｶ??・??・?・??・?・?驛｢譎｢・?・?髯・?・?・?髯滂ｽ?隲帷???螳夲??螟ｲ・?・?髯???・?・?郢晢??郢晢??
    function parseSfzRegions(sfzText){
        const regions=[]; let cur=null;
        const lines=sfzText.split(/\r?\n/);
        const addRegion=()=>{ if(cur && cur.sample){ regions.push(cur); } cur=null; };
        const globalKVs=Object.create(null);
        let groupKVs=Object.create(null);
        let currentSection='global'; // 'global' | 'group' | 'region' | other
        // sample= 驍ｵ・??・?・?髫?・??・?・?髯滓汚??・?髫?螟ｲ・?・?髯???・?・?: 髫?・??・?・?驍ｵ・??・?・?驍ｵ・?郢晢??鬩????・?・?鬨?蜈ｷ・?・?+key= 驍ｵ・?鬮?・?遯?・?髫?螟ｲ・?・?驛｢・?霑｢諤懶??・?髯????らｫ擾??驍ｵ・??・?・?驛｢・?髮区????・?・?驍ｵ・??・?・?驍ｵ・?陷会ｽ?遯?・?髫?證ｦ・?・?鬨?蛹・??・?郢晢??陜捺?薙＊髯溽???諷戊?驍ｵ・??・?・?鬩????・?・?鬨?蜈ｷ・?・?髯?・??・?・?驍ｵ・??・?・?髯・?・?・?髯滂ｽ?隲幢???・?・?郢晢??
        function extractSampleFromLine(str){
            const m = str.match(/\bsample\s*=\s*/i);
            if(!m) return null;
            const start = str.search(/\bsample\s*=\s*/i) + m[0].length;
            let s = str.slice(start);
            if(!s) return null;
            // 髯溽???諷戊?驍ｵ・?髴???・?讙趣??・??・?・?驍ｵ・?郢晢???・?讙趣??・??・?・?驍ｵ・?隴擾??郢晢??驍ｵ・??・?・?驍ｵ・??・?・?
            if(s[0]==='"' || s[0]==="'"){
                const q=s[0];
                const end=s.indexOf(q,1);
                if(end>0) return s.slice(1,end);
                return s.slice(1).trim();
            }
            // 髫?蟷?・?・?髯溽???諷戊?: 髫?・??・?・?驍ｵ・??・?・? 驍ｵ・?郢晢??鬩????・?・?鬨?蜈ｷ・?・?+髯?髮・・??・?・?郢晢?? 驍ｵ・?郢晢??驍ｵ・??・?・?鬨?・??・?・?髯????らｫ擾??驍ｵ・??・?・?
            const re=/\s+\w+\s*=\s*/g;
            const nxt=re.exec(s);
            const raw = (nxt? s.slice(0, nxt.index): s).trim();
            return raw;
        }
        const parseKVs=(str, target)=>{
            // 鬯?・?陞｢・??・?・??・?・?驍ｵ・??・?・? key=value 驛｢・?陷・?・?・?・つ髫?・??・?・?髫?螟ｲ・?・?髯???・?・?郢晢??闔・??・?・?隲?諷戊?髯・?・?・?髯滂ｽ?隲幢???・?・?郢晢??
            str.replace(/(\w+)=((?:"[^"]*"|'[^']*'|[^\s]+))/g,(_,k,v)=>{ if(v && (v[0]==='"' || v[0]==="'")) v=v.slice(1,-1); target[k]=v; return ''; });
            // sample= 驍ｵ・?隴?・?隰費??髯溽???諷戊?驍ｵ・??・?・?鬩????・?・?鬨?蜈ｷ・?・?驛｢・?髮区?環・?驛｢・?髦?蜷??蝣?・?・?郢晢???・??匁捗?・?・?髯?・?陋ｹ・?郢晢??鬮?・?隲?肩・?・??・?・?
            const ext = extractSampleFromLine(str);
            if(ext && target){ target.sample = ext; }
        };
        for(let raw of lines){
            let line=raw.replace(/\s*\/\/.*$/,'').trim(); // // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎会ｽ?・?陷坂握???・?・?
            if(!line) continue;
            if(line.startsWith('<')){
                // 髫???・?・?驍ｵ・?陷会ｽ??・?讓抵??譎渉・?郢晢??驛｢謨鳴
                if(/<region/i.test(line)){
                    addRegion();
                    // region鬨??難??阮・・?髫?蠑ｱ・・?・ global 驍ｵ・??・?・? group 驍ｵ・??・?・?驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎???・?蟶昴??陷???・?・?
                    cur=Object.assign(Object.create(null), globalKVs, groupKVs);
                    currentSection='region';
                    parseKVs(line, cur);
                } else {
                    // 髯具???・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?鬯?・?陷?・??・?・?闕ｵ譏ｴ?? region驛｢・?陜｣・??・?・??・?・?髯橸??郢晢??
                    addRegion(); cur=null;
                    if(/<group/i.test(line)){
                        currentSection='group'; groupKVs=Object.create(null);
                        parseKVs(line, groupKVs);
                    } else if(/<control/i.test(line)){
                        currentSection='global';
                        parseKVs(line, globalKVs);
                    } else {
                        currentSection='global';
                        parseKVs(line, globalKVs);
                    }
                }
            } else {
                // 驛｢譎渉・?郢晢??驛｢謨鳴驍ｵ・??・?・?驍ｵ・?鬩?・?・つ?・?・?鬩搾??陞溷?・??・?陟募仰?・?・?ample= 驛｢・?髮区?環・?驛｢・?・つ鬮?・?陟募?・・?髫???・?・?驍ｵ・?陷会ｽ??・?譟ｮegion鬯?・?陷?・??・?・?闕ｵ譏ｶ?蝣?・?・??・?・?驍ｵ・??・?・?驍ｵ・?郢晢??
                if(/\bsample\s*=/.test(line)){
                    if(cur && cur.sample){ addRegion(); }
                    if(!cur){
                        // 髴托ｽ??・?・?髯懶???・?・?驍ｵ・?驗ゑ??egion髯樊ｻ薙§邵?? sample= 鬮?・?陟募???鬥?・?蛹・??・?鬯?霈?・? 髫???・?・?鬮?遨ゑｽ?蜷・ion驛｢・?隴牙ヵobal+group驍ｵ・?闕ｵ譎｢・?陋ｾ縺題惱??・?・?驍ｵ・?陷会ｽ?遯?・?鬯?・?陷?・??・?・?郢晢??
                        cur=Object.assign(Object.create(null), globalKVs, groupKVs);
                        currentSection='region';
                    }
                    parseKVs(line, cur);
                } else if(cur){
                    parseKVs(line, cur);
                } else {
                    // region髯樊ｻ薙§郢晢??鬮?・?陟募?・・?驍ｵ・?遶擾??陝ｲ・?鬮?蜿?・?・?邵?譎会ｽ?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驍ｵ・??・?・?髯滂ｽ?隲帷腸・?驍ｵ・??・?・?髫?・??・?・?鬩堺?・・?
                    if(currentSection==='group') parseKVs(line, groupKVs);
                    else parseKVs(line, globalKVs);
                }
            }
        }
        addRegion();
        // 髮・?・?・?鬮?遨ゑｽ?讒ｫ?・
        function noteVal(v){
            if(v==null) return undefined; if(typeof v==='number') return v; const n=parseInt(v); if(!Number.isNaN(n)) return n; const s=String(v).trim(); const m=s.match(/^([A-Ga-g])([#bB]?)(-?\d+)$/); if(!m) return undefined; const step=m[1].toUpperCase(); const base={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[step]; const accCh=m[2]; const acc=accCh==='#'?1:(accCh==='b'||accCh==='B'?-1:0); const oct=parseInt(m[3]); return (oct+1)*12 + base + acc; }
    const out = regions.map(m=>({ sample:m.sample, lokey:(noteVal(m.lokey) ?? noteVal(m.key)), hikey:(noteVal(m.hikey) ?? noteVal(m.key)), lovel:m.lovel?parseInt(m.lovel):0, hivel:m.hivel?parseInt(m.hivel):127, loop_start:m.loop_start?parseInt(m.loop_start):undefined, loop_end:m.loop_end?parseInt(m.loop_end):undefined, trigger:m.trigger||undefined, pitch_keycenter:(noteVal(m.pitch_keycenter) ?? noteVal(m.key)), loop_mode:m.loop_mode||undefined }));
        // default_path 驛｢・?郢晢??regions 驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?驍ｵ・?陷会ｽ?遯?・?髣皮甥???・?・?郢晢??
        if(globalKVs.default_path){
            let dp = String(globalKVs.default_path).replace(/\\/g,'/');
            if(!/\/$/.test(dp)) dp = dp + '/';
            out._defaultPath = dp;
        }
    if(window.DEBUG_SAMPLE_NOTE){ console.log('SFZ regions parsed:', out.length); }
    return out;
    }

    // 髯?・?・撰??FZ驛｢・?髮区???・?鬨??郢晢??
    const totalSfz=sfzFiles.length;
    for(let _i=0; _i<sfzFiles.length; _i++){
        const sfzFile=sfzFiles[_i];
        if(sfzStatus) sfzStatus.textContent=`鬮?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?髣????・?・?... (${_i+1}/${totalSfz})`;
        const sfzText=await sfzFile.text();
        const basePath=sfzFile.webkitRelativePath.replace(/[^\/]*$/,'').replace(/\\/g,'/').replace(/\/$/,'');
    const regions=parseSfzRegions(sfzText);
    const regionCount = regions.length;
        if(!regions.length) continue;
        // 髫???・?・?驍ｵ・?陷会ｽ??・?讓抵??譎???・?郢晢??驛｢譎丞ｹ??・?螳夲??蝣?霍?・?・?郢晢??
        const map={};
        // 驛｢譏ｴ?・?邵?諷???譎｢・?・?驛｢譎?ｴ溯?幢??髫?・??・?・?郢晢??陋ｹ・?邵?蜀暦??譎｢・?・?驛｢譏ｴ?・?邵?蜥擾??譎｢・?・?髣皮甥?・?遯?・?郢晢??郢晢??
        function normJoinResolve(base, rel){
            // 髮・?・?・?鬮?遨ゑｽ?讒ｫ?・ base/rel 驛｢・?陜｣・??・?・?闔牙衷・?迢暦??・?郢晢??./ .. 驛｢・?陞ｳ螟ｲ・?・??・?・?髮手ｶ?・?・?
            const raw=(rel.startsWith('/')? rel.slice(1): (base? base.replace(/\/?$/,'/')+rel: rel))
                .replace(/\\/g,'/').replace(/\/\//g,'/');
            const parts=[]; raw.split('/').forEach(seg=>{
                if(!seg||seg==='.') return; if(seg==='..'){ if(parts.length) parts.pop(); return; } parts.push(seg);
            });
            return parts.join('/');
        }
        function buildCandidates(base, defp, samp){
            const cands=[];
            const dp = defp? String(defp).replace(/\\/g,'/').replace(/^\/+|\/+$/g,'') : '';
            const s = String(samp||'').replace(/\\/g,'/');
            const tryPush=(p)=>{ if(p && !cands.includes(p)) cands.push(p); };
            // 1) base + defp + sample
            tryPush(normJoinResolve(base, (dp? dp+'/' : '') + s));
            // 2) base + sample
            tryPush(normJoinResolve(base, s));
            // 3) base + samples/ + sample郢晢??陋ｹ・??・?閧?・?・?闕ｳ蟯?譌ｺ驛｢・?驕擾??郢晢??鬩励???・?郢晢??郢晢??
            tryPush(normJoinResolve(base, 'samples/'+s));
            // 4) defp 驍ｵ・?郢晢??'samples'驍ｵ・??・?・?驍ｵ・?遶擾???・?・?驕停・陬?Δ??陝ｶ譏ｶ闌?し??闔会ｽ?隨?? variants
            if(dp && !/^samples\//i.test(dp)){
                tryPush(normJoinResolve(base, 'samples/'+dp+'/'+s));
            }
            return cands;
        }
        function resolveFile(rel){
            // 髯区???・・?・?隲幢??郢晢??髫?謔ｶ?・?
            const cand=[];
            const c1=rel; cand.push(c1);
            const c2=rel.replace(/^\.\//,''); if(c2!==c1) cand.push(c2);
            const c3=normJoinResolve('', rel); if(cand.indexOf(c3)<0) cand.push(c3);
            // exact
            for(const c of cand){ if(fileMap[c]) return fileMap[c]; }
            // lower-case
            for(const c of cand){ const f=fileMapLower.get(c.toLowerCase()); if(f) return f; }
            // basename髣???・つ鬮?・??・?・?郢晢??陋ｹ・?・主?・?譏???譏ｴ?・?驛｢・??・?・?髫?蠑ｱ・・?晢??驍ｵ・??・?・?郢晢??郢晢??
            const base=rel.split('/').pop().toLowerCase();
            const hit=nameIndexLower.get(base);
            if(hit && !Array.isArray(hit)) return hit;
            return null;
        }
        async function decodeByPath(relOrList){
            const list = Array.isArray(relOrList)? relOrList : [relOrList];
            // 1驍ｵ・??・?・?驍ｵ・??・?・?髯区???・・?・?隲帷???､驛｢・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?鬮?・?・つ遶擾??陷帝｡・????・?髯・髣??湖ｨ驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?驛｢・?陞ｳ螟ｲ・?・??・?・?驍ｵ・?郢晢??
            function buildExtVariants(p){
                const seen=new Set(); const out=[];
                const m=p.match(/^(.*)\.([A-Za-z0-9]+)$/);
                if(m){
                    const base=m[1]; const ext=m[2].toLowerCase();
                    getAltSampleExts().forEach(e=>{ const q=base+'.'+e; if(!seen.has(q)){ seen.add(q); out.push(q); } });
                    if(!seen.has(p)) out.push(p);
                    return out;
                } else {
                    getAltSampleExts().forEach(e=>{ const q=p+'.'+e; if(!seen.has(q)){ seen.add(q); out.push(q); } });
                    if(!seen.has(p)) out.push(p); return out;
                }
            }
            for(const rel of list){
                const variants=buildExtVariants(rel);
                for(const v of variants){
                    const key=v; if(decodeCache.has(key)) return decodeCache.get(key);
                    const f=resolveFile(v);
                    if(!f){ continue; }
                    let ab; try{ ab=await f.arrayBuffer(); }catch(_){ stats.fail++; continue; }
                    const buf=await new Promise(res=> audioCtx.decodeAudioData(ab, b=>res(b), ()=>res(null)));
                    if(buf){ decodeCache.set(key, buf); stats.ok++; const ext=(f.name.split('.').pop()||'').toLowerCase(); stats.byExt[ext]=(stats.byExt[ext]||0)+1; return buf; }
                    else { stats.fail++; continue; }
                }
                if(window.DEBUG_SAMPLE_NOTE){ console.warn('sample not found/decoded for any ext', rel); }
                stats.notFound++;
            }
            return null;
        }
        // 驛｢譎???譁撰?憺Δ???・?・?驛｢譎｢・?・?髯?・?鬮?・?・ゑｽ?驛｢・?驕ｯ・?IDI驛｢・?陷?驛?・?髯橸??陞｢・?隨・驛｢・?闕ｵ譏ｴ?・?驛｢譎｢・?・?驛｢譏ｴ?・?
        function inferMidiFromFilename(samplePath){
            try{
                const base = String(samplePath||'').split('/')?.pop()||'';
                const name = base.replace(/\.[A-Za-z0-9]+$/,'');
                // 驛｢譏???・?邵?・?驛｢譎｢・?・?驛｢譎｢・?・?1: 鬯?・??・?・?髯?・?郢晢??+ 驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?(C#4, Db3 驍ｵ・??・?・?驍ｵ・??・?・?)
                const m1 = name.match(/(^|[^A-Za-z])([A-Ga-g])([#b]{1,2})?(-?\d)($|[^A-Za-z0-9])/);
                if(m1){
                    const step=m1[2].toUpperCase();
                    const baseIdx={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[step];
                    const accStr=m1[3]||''; let acc=0; if(accStr){ if(/##/.test(accStr)) acc=2; else if(/#/.test(accStr)) acc=1; else if(/bb/.test(accStr)) acc=-2; else if(/b/.test(accStr)) acc=-1; }
                    const oct=parseInt(m1[4]);
                    const midi=(oct+1)*12 + baseIdx + acc; if(midi>=0 && midi<=127) return midi;
                }
                // 驛｢譏???・?邵?・?驛｢譎｢・?・?驛｢譎｢・?・?2: 鬮?・??・?・?驍ｵ・??・?・?鬨?・??・?・?髯?・??・?・? 0..127 郢晢??郢晢??60, _60, -60- 鬩???陝ｲ・??・?蟶晏搦?・?・?髯橸???・?・?郢晢??郢晢??
                const m2 = name.match(/(?:^|[^0-9])(1[01][0-9]|12[0-7]|\d?\d)(?:[^0-9]|$)/);
                if(m2){ const n=parseInt(m2[1]||m2[0]); if(n>=0 && n<=127) return n; }
            }catch(_){ }
            return null;
        }
    let swapCount = 0;
    for(const r of regions){
            // default_path 驛｢・??・?・?驛｢譎???郢晢??驛｢譏ｴ?・?+ 鬮?髦??・?霎溷????惱・??・?・?隲帷???・?髮・?・?・?鬮?遨ゑｽ?讒ｫ?・??證ｦ・?・?髮手ｶ?・?・?
            const defp = (regions && regions._defaultPath)? String(regions._defaultPath): '';
            const candPaths = buildCandidates(basePath, defp, r.sample);
            const buf=await decodeByPath(candPaths);
            if(!buf) continue;
            // WAV驛｢譎｢・?・?驛｢・??・?・?郢晢??陋ｹ・?・取刮・?譎｢・?・?驛｢譎?惧?・?・?郢晢??
            let meta={ sampleRate:0, loopStart:null, loopEnd:null };
            try{
                // 鬮?證ｦ・?・?髫?・?陷・騾?驢搾??・??・?・?髫????髯具??隴擾??遶???蝗?・?・?髮手ｶ?・?・?驍ｵ・??・?・?驍ｵ・?鬮?・?隨??驛｢譎???譁撰?憺Δ???・?・?驛｢譎｢・?・?驛｢・?髮区???・?髯?・?鬮???・?・?郢晢??
                const f=resolveFile(candPaths[0]);
                if(f){ const ab=await f.arrayBuffer(); meta=readWavMeta(ab); }
            }catch(_){ }
            // 驛｢・??・?・?驛｢譎｢・?・?鬩???郢晢??陝ｲ?驍ｵ・??・?・?鬮?・?隲幢???・?・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??: lokey/hikey 髫?蟷?・?・?髫?謔ｶ?・??・?・?陞｢・?陷・??驍ｵ・??・?・? pitch_keycenter驕ｶ髮・・?郢晢??驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?髯?・?鬮?・?・ゑｽ?驛｢・?騾???髢?・?髯橸??陞｢・?・つ郢?莉ｰ?郢晢???・?・??・?・?髫?蠑ｱ・・?晢??髯?闌ｨ・?・?驛｢・?隴?・?陝蟶?・?・?陋ｹ・?・つ郢晢??
            let lo = (r.lokey!=null? r.lokey: undefined);
            let hi = (r.hikey!=null? r.hikey: undefined);
            if(lo==null && hi==null){
                const rootGuess = (r.pitch_keycenter!=null? r.pitch_keycenter: inferMidiFromFilename(r.sample));
                if(rootGuess!=null){ lo=hi=rootGuess; }
            }
            if(lo==null) lo = (hi!=null? hi: 60);
            if(hi==null) hi = lo;
            lo = Math.max(0, Math.min(127, lo));
            hi = Math.max(0, Math.min(127, hi));
            if(hi < lo){ const tmp=lo; lo=hi; hi=tmp; swapCount++; }
            const velLo=r.lovel??0, velHi=r.hivel??127;
            const layer = velHi<=50? 'pp': velLo>=90? 'ff': 'mf';
            const root = (r.pitch_keycenter!=null? r.pitch_keycenter: Math.round((lo+hi)/2));
            for(let m=lo; m<=hi; m++){
                if(!map[m]) map[m]={layers:{},release:null,gains:{}};
                if(r.trigger==='release'){ map[m].release=buf; continue; }
                if(!map[m].layers[layer]){
                    let loopSec;
                    if(r.loop_start!=null && r.loop_end!=null){
                        const sr=(meta.sampleRate||buf.sampleRate);
                        loopSec={ s:r.loop_start/sr, e:r.loop_end/sr };
                    } else if(meta.loopStart!=null && meta.loopEnd!=null){
                        const sr=(meta.sampleRate||buf.sampleRate);
                        loopSec={ s: meta.loopStart/ sr, e: meta.loopEnd/ sr };
                    } else if(r.loop_mode==='loop_continuous'){
                        loopSec={ s: Math.min(0.02, Math.max(0, buf.duration*0.02)), e: Math.max(0.05, buf.duration-0.02) };
                    }
                    map[m].layers[layer]={ buffer:buf, root, loop: undefined, loopSec };
                }
            }
        }
        // 髫??会ｽ?・?髯???・?・?髫?證ｦ・?・?髯橸??陞｢・?遶??壽≧?・?・?髯滓じ?・?
        const dirName=(basePath.split('/')?.pop()||'').toLowerCase();
        const fileName=sfzFile.name.toLowerCase();
        const isFlute = /flute/.test(dirName) || /flute/.test(fileName);
        const isPiano = /piano/.test(dirName) || /piano/.test(fileName);
    const keyCount=Object.keys(map).length; if(window.DEBUG_SAMPLE_NOTE){ console.log('SFZ built map', {file:sfzFile.name, keys:keyCount}); }
    if(window.DEBUG_SAMPLE_NOTE){
        const byExtStr = Object.entries(stats.byExt).map(([k,v])=>`${k}:${v}`).join(',');
        console.log(`[SFZ] ${sfzFile.name} regions=${regionCount} keys=${keyCount} swaps=${swapCount} ok=${stats.ok} fail=${stats.fail} notFound=${stats.notFound} byExt={${byExtStr}}`);
        console.log('SFZ decode summary', {file:sfzFile.name, ok:stats.ok, fail:stats.fail, notFound:stats.notFound, byExt:stats.byExt});
    }
        if(isFlute){ instrumentMaps.Flute=map; loadedInstruments.push('Flute'); }
        if(isPiano){ instrumentMaps.Piano=map; pianoSampleMap=map; loadedInstruments.push('Piano'); }
        if(!isFlute && !isPiano){
            // 髫?謔ｶ?・??・?・?陞｢・?遶企?・?・?郢晢?? Piano驍ｵ・??・?・?驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?
            instrumentMaps.Piano=map; pianoSampleMap=map; loadedInstruments.push('Piano?');
        }
    }
    useSamplePiano=true; pianoSamplesLoaded=true;
    const label = loadedInstruments.length? loadedInstruments.join(', '): 'Unknown';
    const fmt = SELECTED_SAMPLE_PRIMARY? ' [fmt: '+SELECTED_SAMPLE_PRIMARY+']' : '';
    setPianoZipStatus('SFZ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?櫨?・?・?陟包???・?・?郢晢??'+label+')'+fmt); if(sfzStatus) sfzStatus.textContent='髮・鬮???・??訪('+label+')'+fmt;
    // 髯?髮・・?雎ｬ・?鬮?・??・?・?髯?閧?蝮?遶城メ・?螢?・?・?遶???・?・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??郢晢??UI驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??鬯?蛹・??・?髫?螢?・?・?遶頑･?諢?髢?・?闕ｳ闊?・?郢晢??
    autoSelectMelodyTrackIfMonophonic(); autoCenterMelodyTrack();
    // 髫???・?・?驍ｵ・?陷会ｽ??・?讓抵??譎???・?郢晢??驛｢譎丞ｹ??・?螳壽╂髢?・?闕ｳ蜊???・?陷会ｽ?遯?・?髯??鬮?・?邵?蟶?・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?
    scheduleAll(); if(isPlaying){ pausePlayback(); startPlayback(); }
}; }
// ===============================================================
// ZIP驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取?諤呵悋??陷・?? (驛｢譎??・取ｺ?・?・??・?・?驛｢譏ｴ?・?邵??髫?證ｦ・?・?髯橸??陞｢・?郢晢??鬩・?・?・?髫?荳・・? 髯?・?隴?・?陷・??鬨?蜈ｷ・?・?鬯?・??・?・?髫?・??・?・?驍ｵ・??・?・?髯橸???・?・?髯具??郢晢??陝?)
function playFromZipPiano(midi,when,dur,outGain, inst){
    // 髫??会ｽ?・?髯???・?・?髯具??郢晢??陝?: inst='Flute' 驍ｵ・??・?・?髯懶???・?・?髯?・?陋ｹ・?郢晢?? fluteMap 驛｢・?髮区?貞ｴ?恷・??・?・?驍ｵ・?遶丞｣??咎Δ譎????青ｰ驍ｵ・??・?・? piano
    const map = inst==='Flute'? (instrumentMaps.Flute||pianoSampleMap) : (instrumentMaps.Piano||pianoSampleMap);
    if(map && map!==pianoSampleMap){ /* instrument-specific */ }
    const sampleMap = map || pianoSampleMap;
    if(!sampleMap[midi]){
        // 髯溷???・??・?・?郢晢??陝ｲ?驍ｵ・??・?・?髫????鬮?螟ｧ・?・??・?蜥?・?・??・?・?驛｢譎｢・?・?髫?證ｦ・?・?鬩肴得??・?郢晢??闔・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驍ｵ・?闕ｵ譎｢・???・????鬮???・??会ｽ?・?隴取ｧ?・?・?郢晢??郢晢??
        let bestKey=null, bestDist=1e9; const keys=Object.keys(sampleMap);
        for(const k of keys){ const km=parseInt(k); if(!sampleMap[km]) continue; const d=Math.abs(km-(midi)); if(d<bestDist){ bestDist=d; bestKey=km; if(d===0) break; } }
        if(bestKey!=null){ if(window.DEBUG_SAMPLE_NOTE){ console.log('map-miss fallback ->', {req:midi, hit:bestKey, dist:bestDist}); }
            midi=bestKey;
        } else {
            if(window.DEBUG_SAMPLE_NOTE){ console.warn('map-miss no-fallback', {req:midi}); }
            return false;
        }
    }
    const info=sampleMap[midi];
    // 鬮?螟ｧ・?・??・??取?隴?・?陷・??鬨?蜈ｷ・?・?鬯?・??・?・?髫?・??・?・?驛｢・?郢晢??鬯?・?陷?・??・?・?陋ｹ・?陷・??髯具???・?・?驍ｵ・??・?・?鬮?螟ｧ・?・??・??"驍ｵ・??・?・?髫?證ｦ・?・?髯橸??陞滂ｽ??・?・?闔・?郢晢??鬮?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?髴取ｻゑｽ?・?鬯?・?闔牙遜??・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?驛｢・?陝ｲ・?遶企?・?・?郢晢???・?閧?・?・?郢晢???・?・?郢晢??
    try{
        const cutoff = when - (POLY_WINDOW||0.025);
        // 髯?・??・?・?驍ｵ・?郢晢??陝ｷ謌?ｲる?蜴・??・?陋滂ｽ?????驛｢・?陝ｶ譎乗ｱる匚・??・?・?郢晢??騾趣??郢晢??髯具??隲?諛?・?鬯???・?・?驍ｵ・?闕ｵ譎｢・?閾?・?・??・?・?驛｢譏ｴ?・?郢晢??郢晢??郢晢??
        let idx=0; while(idx<RECENT_STARTS.length && RECENT_STARTS[idx] < cutoff) idx++;
        if(idx>0) RECENT_STARTS.splice(0, idx);
    }catch(_){ }
    const nearCount = (()=>{
        try{ const w=POLY_WINDOW||0.025; let c=0; for(let i=0;i<RECENT_STARTS.length;i++){ const t=RECENT_STARTS[i]; if(Math.abs(t-when)<=w) c++; } return c; }catch(_){ return 0; }
    })();
    const conc = 1 + nearCount; // 驍ｵ・?髦?蜷??・?驛｢譎擾??・?郢晢??驛｢譎槭Γ郢晢??鬮???・?・?驛｢・?髮区?環・?驛｢・?・つ
    const strengthBase = (conc/6) + (dur>1?0.4:0) + (sustainPedal?0.25:0);
    const layers=Object.keys(info.layers);
    if(!layers.length) return false;
    let targetLayer='mf';
    if(layers.length===1) targetLayer=layers[0];
    else {
        if(strengthBase<0.4 && layers.includes('pp')) targetLayer='pp';
        else if(strengthBase>1.1 && layers.includes('ff')) targetLayer='ff';
        else if(layers.includes('mf')) targetLayer='mf';
        else targetLayer=layers[0];
    }
    const layerObj=info.layers[targetLayer]; if(!layerObj) return false;
    const buf=layerObj.buffer||layerObj; if(!buf) return false;
    // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?樟?ゑｽ?驛｢・?陝ｲ・?郢晢??髯?雍???竏ｵ・?・?髯晢???・?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎槭??・?・??・?・?髫?・??・?・?
    const root=layerObj.root??midi; const semis=(midi - root); const rate=Math.pow(2, semis/12);
    // 驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵?鬘鯉ｽ?螢?・?・?陞ｳ?: 髴托ｽ??・?・?髯懶???・?・?髫?蠑ｱ・・け??驍ｵ・??・?・?髫??会ｽ?・?鬩????・?・?驍ｵ・??・?・?鬮?蜿?・?・??・?讚∵??・?・?髯?・?陋ｹ・?郢晢??驍ｵ・??・?・? +2ms 髯?閧?・?・?・つ遶丞､?・?鄙ｫ?・?騾趣??隨・??驍ｵ・?郢晢???・?・?郢晢??隰?繧会ｽ?・??・?・?驛｢譎擾??・?郢晢??驛｢譎?樟郢晢??髯?蛹??・?郢晢??when驛｢・?陜｣・??・?・??・?・?髫?謔ｶ?・??・?・?郢晢??
    const slop = 0.002;
    const startAt = (when - audioCtx.currentTime) < slop ? (audioCtx.currentTime + slop) : when;
    // 鬯??鍋??・?・??・?・?鬮?蛹・??・?鬯?・??・?・?髮・?・?・?: 鬨?・??・?・?髯????らｸ?螳夲??・??・?・?鬨??郢晢??
    try{ cleanupSampleVoices(audioCtx.currentTime); sampleVoiceStealIfNeeded(); }catch(_){ }
    const src=audioCtx.createBufferSource(); src.buffer=buf; try{ src.playbackRate.setValueAtTime(rate, startAt);}catch(_){ src.playbackRate.value=rate; }
    // DC/髣???闕ｳ・?雎撰??驛｢譎?樟?主??・?譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?樟郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵?鬘梧割陷?蜴・??・?郢晢??
    const hp=audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=20; hp.Q.value=0.707;
    const g=audioCtx.createGain();
    // gain 髮・?・?・?鬮?遨ゑｽ?讒ｫ?・(dB驕ｶ髮・・??・?・?陞｢・??・?・??・?・?)
    const db = info.gains[targetLayer]||0; const baseGain=Math.pow(10, db/20);
    // 髯樊ｺ?・?繧・?馴??・??・?・?髫?蠑ｱ・・?晢??驛｢譎??堤?晢??驛｢・??・?・?髫?螢?・?・?陞ｳ?: 髯?閧??蜍???驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?郢晢??郢晢??1/sqrt(N)郢晢??郢晢??
    const dynScale = 1/Math.sqrt(Math.max(1, conc));
    const targetAmp = Math.min(0.85, Math.max(0.05, 0.65 * baseGain * dynScale));
    if(g.gain.cancelAndHoldAtTime){ try{ g.gain.cancelAndHoldAtTime(startAt); }catch(_){ } }
    g.gain.setValueAtTime(0.0001,startAt);
    // 驛｢譎???譁絶凾驛｢譎｢・?・?驛｢譎擾??・?邵??驛｢譎｢・?・?髫?蠑ｱ・玖?・?驍ｵ・??・?・?驛｢譎擾??・?郢晢??驛｢譎会ｽ?・?髢?讓抵??・??・?・?髯滂ｽ?隲帷腸・?驍ｵ・??・?・?髯?・??・?・?髯樊ｺ・・?
    const desiredHold = Math.max(0.03, dur); // 驛｢譎擾??・?郢晢??驛｢譎乗ｲ?隰費??髫?螟ｲ・?・?驍ｵ・??・?・?鬯?貊ゑ??・?驍ｵ・?陋ｹ??・?・?陜捺?督蜻?豌｣郢晢??30ms郢晢??郢晢??
    const fadeInDur = Math.max(0.008, Math.min(0.03, desiredHold*0.4));
    try{ g.gain.linearRampToValueAtTime(targetAmp, startAt+fadeInDur); }catch(_){ g.gain.setValueAtTime(targetAmp, startAt+fadeInDur); }
    // 髯??陷?・?陷・??鬯?貊ゑ??・?鬮?・?髢?・??・?・?郢晢??& 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?諛ｶ・?・??・?・?髯滂ｽ?郢晢?? 驛｢譎擾??・?郢晢??驛｢譎?樟郢晢??鬯?貊ゑ??・?驍ｵ・?郢晢??dur 驛｢・?髮区????螟???謫?・?・?郢晢??闔・??・?・?隴?・??・?・??・?・?驍ｵ・??・?・?髯?蟯??譏ｴ?・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・?陜｣・??・?・??・?・?髣???隴趣???・?・?郢晢??
    let loopable=false; let loopConf=null; let playDur;
    const raw = buf.duration / Math.max(0.0001, rate); // 驛｢譎??堤?晢??驛｢譏ｶ?螢?笘?Δ譎???譁石夐辧蜍滂ｽ?螽??讌｢讌懆?・陜ｨ?驍ｵ・??・?・?鬯?????・?驛｢・?陋ｹ・?隲?蜻?譽・・?・?鬯?貊ゑ??・?
    const manifestFiles = (pianoZipManifest && pianoZipManifest.files)? pianoZipManifest.files: [];
    const meta = manifestFiles.find(e=> (e.m===midi||e.midi===midi||e.note===midi) && e.layer===targetLayer);
    const loopMeta = layerObj.loop || meta?.loop;
    if(layerObj.loopSec && typeof layerObj.loopSec.s==='number' && typeof layerObj.loopSec.e==='number' && layerObj.loopSec.e>layerObj.loopSec.s){
        loopable=true; src.loop=true; src.loopStart=layerObj.loopSec.s; src.loopEnd=layerObj.loopSec.e;
    } else if(loopMeta && typeof loopMeta.s==='number' && typeof loopMeta.e==='number' && loopMeta.e>loopMeta.s+1000){
        loopable=true; loopConf=loopMeta; src.loop=true; src.loopStart=loopConf.s / (pianoZipManifest.sampleRate||48000); src.loopEnd=loopConf.e / (pianoZipManifest.sampleRate||48000);
    }
    // desiredHold 驍ｵ・??・?・?髣???驗呻??邵?螳壽??棔繧托ｽ?・??・?・?髮九?迴?遶擾??驍ｵ・?郢??郢晢??驍ｵ・??・?・?髯具??郢晢???・?鬘俶綜隶難??遶擾??驍ｵ・??・?・?驍ｵ・?雋?∞??竏ｫ・?・?遶乗辨・?蜻??慕ｹ晢??遶企?・?譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・?陜｣・??・?・??・?・?髣???隴擾??隨・驛｢・?闕ｵ謨鳴郢晢??
    // 髫??会ｽ?・?髯???・?・?驍ｵ・??・?・?髯滂ｽ?隲帷腸・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・?陝ｶ譎≫裸驛｢・?遶丞｣??阮・・?郢晢??lute驍ｵ・??・?・?髴大??・?・?驍ｵ・??・?・?鬯?貊ゑ??・?驛｢・?郢晢???・?・?郢晢??
    const isFlute = (inst==='Flute');
    const tc = sustainPedal? (isFlute? 0.60: 0.50) : (isFlute? 0.50: 0.35); // setTargetAtTime 驍ｵ・??・?・?髫?蠑ｱ・・・?・?陞｢・?霎?(髯溷桁??・?髯・郢晢??
    const minExtra = sustainPedal? (isFlute? 1.2: 0.9) : (isFlute? 0.7: 0.5); // 髫????髣???隲?・??・?・?陷?蜿???鄙ｫ?・?闔・??・?・??・?・?髯・隴会ｽ??・?・?郢晢??
    // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎芽??隲?蜑ｰ・?貊ゑ??・?驍ｵ・??・?・?髫????髯樊ｻゑｽ?・?鬯?貊ゑ??・?驛｢・?髮区??・?蟷・??・?郢晢??
    if(loopable){
        playDur = desiredHold; // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ?郢晢??note鬯?貊ゑ??・?驍ｵ・??・?・?髯滂ｽ??・?・?髯橸??雋翫???・?陋ｹ・?・取㏍・?譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・?髯具???・?・?鬯?・?髮具???・?・?郢晢??
    } else {
        playDur = Math.min(raw, desiredHold);
    }
    if(!playDur || !isFinite(playDur)) playDur = Math.min(raw, desiredHold);
    if(window.DEBUG_SAMPLE_NOTE){ console.log('zipPlay', {midi,layer:targetLayer,loopable,playDur:playDur.toFixed(3),dur}); }
    // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・??・?・? dur 鬩搾??驕停沖ﾑ?し??闕ｵ譎｢・?閾?・?・?郢?蝓滂ｽ??髫?・??・?・?(鬨?・??・?・?髫?阮・・?)驍ｵ・??・?・?鬩搾???・?・?驛｢・?郢晢??・ゑｽ?驍ｵ・??・?・?髮九?・???・?・??・?・?驍ｵ・?郢晢??
    const fadeStart = startAt + playDur;
    try{ g.gain.setValueAtTime(targetAmp, fadeStart); g.gain.setTargetAtTime(0.0001, fadeStart, tc); }catch(_){ }
    src.connect(hp); hp.connect(g); g.connect(outGain);
    try { src.start(startAt); } catch(_){ src.start(startAt); }
    // setTargetAtTime 驍ｵ・??・?・?髮区誓??・?鬮????讎???驍ｵ・??・?・?0驍ｵ・??・?・?髯?・?闔会ｽ?・ゑｽ?驍ｵ・?郢晢??隨??驛｢・?遶丞仰郢晢???・??驍???陷・??髯橸??陞｢・?霎? + 髫????髣???隲?・??・?・?陷?蜿???? 驍ｵ・??・?・?髯句??繩??・?・??・?・?郢晢??陋ｹ・?遶・驍ｵ・??・?・?髴取ｻゑｽ?・?鬯?・??・?・?郢晢??郢晢??
    let stopAt = fadeStart + Math.max(minExtra, tc*4) + 0.02;
    // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎会ｽ?・?隨乗ｪ趣??・?驍???陷・??驛｢・?郢??・つ遶擾??陷・??驛｢譎?蠕湖暮Δ譎???譁撰?憺?搾??郢?莨夲??・??・?・?驍ｵ・??・?・?鬮???・?・?驍ｵ・?郢晢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?髣???陷?・??・?・?陋ｹ??・?・?郢晢??20ms郢晢??陝ｲ・??・?蟶晏搦?・?・?髯橸???・?・?
    if(!loopable){ stopAt = Math.min(startAt + raw + 0.02, stopAt); }
    try{ src.stop(stopAt); }catch(_){ }
    activeSampleVoices.push({end: stopAt + 0.2, g, src});
    // 驍ｵ・?髦?蜷??・?鬯?・?陷?・??・?・?闕ｵ譎｢・?蟶晏搦陋滂ｽ?????郢晢??闔・??・?・?郢晢??隰?繧会ｽ?・??・?・?髯?・?隴?・?陷・??鬨?蜈ｷ・?・?鬯?・??・?・?髫?證ｦ・?・?髯橸??陞溘ｉ闊樒ｹ晢??郢晢??
    try{
        RECENT_STARTS.push(startAt);
        if(RECENT_STARTS.length>4096){ RECENT_STARTS.splice(0, RECENT_STARTS.length-2048); }
    }catch(_){ }
    if(SAMPLE_USE_STATS[midi]) SAMPLE_USE_STATS[midi].lastUse=performance.now();
    // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・・ (驛｢譎擾??・?郢・驛｢譎｢・?・?OFF && 髫?謔ｶ?・??・?・?陞｢・?遶・驛｢・?郢晢??
    if(info.release && !sustainPedal){
        const rsrc=audioCtx.createBufferSource(); rsrc.buffer=info.release; const rg=audioCtx.createGain(); const rt=startAt+dur+0.005; 
        rg.gain.setValueAtTime(0.0001,rt); 
        try{ rg.gain.linearRampToValueAtTime(0.45,rt+0.008);}catch(_){ rg.gain.setValueAtTime(0.45,rt+0.008);} 
        rg.gain.setTargetAtTime(0,rt+0.25,0.25); 
        rsrc.connect(rg); rg.connect(outGain); 
        rsrc.start(rt); 
        const rStop = rt+Math.min(1.2, info.release.duration+0.4);
        rsrc.stop(rStop);
        // 驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎擾??・?郢晢??驛｢譎擾??・??・?繧区≧?・?・?鬮?謳?・?・?郢晢??闔・??・?・??・?・?髯具???・?・?髯句??繩??・?・??・?・?鬨?蛹・??・?郢晢??郢晢??
        activeSampleVoices.push({end: rStop + 0.2, g: rg, rsrc});
    }
    return true;
}

// ================== Simple SFZ Playback (Isolated path) ==================
// 髫????髯・闕ｵ證ｦ・?・?陋ｹ・?郢晢??: 1 BufferSource -> Gain -> (optional) HPF -> out
// 驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?鬯?蛹・??・?髫?螢??・? vel鬨?・??・?・?髯溷・萓ｭ郢晢??髴取ｻゑｽ?・?鬮??薙§?・?? mf 髯???・?・?髯???迴?・つ遶丞｢・刮・?譎｢・?・?驛｢譎?樟?ゑｽ?驛｢・?陝ｲ・?郢晢??髯?雍???竏ｵ・?・?髯晢???・?・?驍ｵ・??・?・? rate 驍ｵ・??・?・?驍ｵ・?鬯倬?会ｽ?・??・?・?髫?・??・?・?
function simpleSfzMap(){
    // Piano驛｢・?髮区?樒?髯???迴?・つ遶擾??隨乗ｪ趣??・?闔会ｽ??・?讙趣??・??・?・?Flute驍ｵ・?遶丞｣?關ｽ驛｢・?陟暮?会ｽ?繧???貊ゑ??・?驍ｵ・?闔会ｽ??・?讙趣??・??・?・? pianoSampleMap
    if(instrumentMaps.Piano && Object.keys(instrumentMaps.Piano).length) return instrumentMaps.Piano;
    if(instrumentMaps.Flute && Object.keys(instrumentMaps.Flute).length) return instrumentMaps.Flute;
    return pianoSampleMap;
}
function simpleFindNearestKey(map, midi){
    if(map[midi]) return midi;
    let best=null,bd=1e9; for(const k of Object.keys(map)){ const m=parseInt(k); if(!map[m]) continue; const d=Math.abs(midi-m); if(d<bd){ bd=d; best=m; if(d===0) break; } }
    return best;
}
function simplePlaySfz(midi, when, dur, out){
    try{
        const map = simpleSfzMap(); if(!map||!audioCtx) return false;
        let key = (map[midi]? midi: simpleFindNearestKey(map, midi)); if(key==null) return false;
        const info = map[key];
        // 髯橸???・?・?驍ｵ・??・?・? mf髯???・?・?髯?逎ｯ竓??晢??髣皮判縺倡?晢??1驍ｵ・??・?・?
        const layers = Object.keys(info.layers||{}); if(!layers.length) return false;
        const layer = layers.includes('mf')? 'mf': layers[0]; const entry = info.layers[layer];
        const buf = entry.buffer||entry; if(!buf) return false;
        const root = entry.root ?? key; const rate = Math.pow(2, (midi-root)/12);
        const startAt = Math.max(audioCtx.currentTime+0.002, when||audioCtx.currentTime+0.002);
        const g = audioCtx.createGain(); g.gain.setValueAtTime(0.0001, startAt); g.gain.linearRampToValueAtTime(0.6, startAt+0.01);
        const src = audioCtx.createBufferSource(); src.buffer=buf; try{ src.playbackRate.setValueAtTime(rate, startAt);}catch(_){ src.playbackRate.value=rate; }
        // 鬩・?・?・?髫?蜑ｰ萓ｭ郢晢??驛｢譎｢・?・?驛｢譎｢・?・?
        const playHold = Math.max(0.05, dur||0.2);
        const stopAt = startAt + Math.min(buf.duration/Math.max(0.001,rate), playHold+0.5);
        g.gain.setValueAtTime(0.6, stopAt);
        g.gain.setTargetAtTime(0.0001, stopAt, 0.25);
        src.connect(g); g.connect(out||masterGain||audioCtx.destination);
        src.start(startAt); src.stop(stopAt+0.05);
        // 髯滓汚??・?髯具???・?・?髯句??繩??・?・??・?・?驍ｵ・??・?・?驍ｵ・?雋?∞??竏ｫ・?・??・?・?鬮?????・?鬮?謳?・?・?
        activeSampleVoices.push({end: stopAt+0.2, g, src});
        return true;
    }catch(_){ return false; }
}
function scheduleMoreSimple(){
    if(!isPlaying||!audioCtx||!currentTracks.length) return;
    const now=audioCtx.currentTime;
    const gvEl=document.getElementById('guideVolumeSlider');
    const avEl=document.getElementById('accompVolumeSlider');
    const enableMel = gvEl? (parseFloat(gvEl.value)>0.01) : true;
    const enableAcc = avEl? (parseFloat(avEl.value)>0.01) : true;
    const isTrackEnabled=(ti)=>{ const isMel=(ti===melodyTrackIndex); if((isMel && !enableMel) || (!isMel && !enableAcc)) return false; return (currentTracks[ti]?.notes?.length>0); };
    const baseAhead = 0.4; // 驍ｵ・?髴???・?閾?・?・??・?・?鬩墓得??・?驍ｵ・?郢晢??郢晢??鬮?・??・?・?驍ｵ・??・?・?
    let from = isFinite(scheduledUntil)? scheduledUntil: (playbackPosition||0);
    let target = Math.max(from+baseAhead, (playbackPosition||0)+baseAhead);
    let scheduled=0; const limit=80;
    if(window.DEBUG_SIMPLE){ try{ console.log('[sched-simple] win from',from.toFixed(3),'target',target.toFixed(3),'pos', (playbackPosition||0).toFixed(3)); }catch(_){ } }
    for(let ti=0; ti<currentTracks.length && scheduled<limit; ti++){
        if(!isTrackEnabled(ti)) continue;
        const out = (ti===melodyTrackIndex)? (melodyGain||masterGain||audioCtx.destination): (accompGain||masterGain||audioCtx.destination);
        const notes=currentTracks[ti].notes;
        for(const n of notes){ const st=n.time, en=st+n.duration; if(en<=from) continue; if(st>=target) break; let when = (playbackStartTime||audioCtx.currentTime) + (st - (playbackStartPos||0)); if(btLatencyEnabled) when -= btLatencySec; if(when < now - 0.01) when = now + 0.002; if(simplePlaySfz(n.midi, when, n.duration, out)){ scheduled++; scheduledCounter++; if(window.DEBUG_SIMPLE){ try{ console.log('[sched-simple] note', {ti, midi:n.midi, when:(when-audioCtx.currentTime).toFixed(3)}); }catch(_){ } } } if(scheduled>=limit) break; }
    }
    scheduledUntil = target;
    if(window.DEBUG_SIMPLE){ try{ console.log('[sched-simple] scheduled:',scheduled,'scheduledUntil->',target.toFixed(3)); }catch(_){ } }
    // 髣費??鬩?謳?・?・??・?・?驍ｵ・?隶呵??・?・?陞｢・??・?讓抵??・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?0髣比ｼ夲??・?驍ｵ・??・?・?驛｢・?陝ｲ・?・つ遶擾???・?・??・?・?驛｢譎擾??・?郢晢??驛｢譎?樟?城メ・????髯樊ｻゑｽ?・?30鬩穂ｼ・・?遶擾??驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?
    if(scheduled===0){
        let nextT=Infinity;
        for(let ti=0; ti<currentTracks.length; ti++){
            if(!isTrackEnabled(ti)) continue;
            const notes=currentTracks[ti].notes;
            for(const n of notes){ const st=n.time; if(st>from+1e-6){ if(st<nextT) nextT=st; break; } }
        }
        if(isFinite(nextT)){
            const jumpTo = Math.min(nextT, from + 30);
            scheduledUntil = jumpTo;
            if(window.DEBUG_SIMPLE){ try{ console.log('[sched-simple] rest-jump from', from.toFixed(3),'->', jumpTo.toFixed(3)); }catch(_){ } }
        }
    }
}
// LRU 鬯?・?陋ｹ・?陷?? (驛｢譏ｴ?・?邵?諷???譎｢・?・?驛｢譎牙愛霎溷?ゑｽ?・?驕停扱??句?・・?・?鬮?諛?・?驍?髫?蠑ｱ?・?髯?・??・?・?驍ｵ・?郢晢??& 鬯?蛹・??・?鬯?・??・?・?髯懈瑳・?・??・?・??・?・?驛｢・?髮区?抵?朱??・??・?・?)
function maybeRunLru(){ const now=performance.now(); if(now-lastLruCheck < LRU_CHECK_INTERVAL) return; lastLruCheck=now; const keys=Object.keys(pianoSampleMap); if(keys.length < MAX_DECODED_SAMPLES_SOFT) return; const arr=[]; keys.forEach(k=>{ const midi=parseInt(k); const stat=SAMPLE_USE_STATS[midi]; if(!stat) return; const dist=Math.abs(midi- (pianoZipManifest?.center||60)); arr.push({midi,last:stat.lastUse,dist}); }); arr.sort((a,b)=> (a.last-b.last)|| (b.dist-a.dist)); // 髯?・??・?・?驍ｵ・?郢晢??& 鬯?蛹・??・?驍ｵ・?郢晢??隨鞘握諤?郢晢??
    const removeCount=Math.min(10, Math.max(0, keys.length-MAX_DECODED_SAMPLES_SOFT)); for(let i=0;i<removeCount;i++){ const target=arr[i]; const info=pianoSampleMap[target.midi]; if(!info) continue; // 鬮?證ｦ・?・?髫?・??・?・?
        Object.values(info.layers).forEach(buf=>{ /* GC髣比ｼ夲??・?驍ｵ・?郢晢??*/ }); if(info.release){ /* ignore */ }
        delete pianoSampleMap[target.midi]; delete pianoSampleBuffers[target.midi]; delete SAMPLE_USE_STATS[target.midi]; }
}

// ===== Responsive layout helpers: 鬩????・?・?髫?蟷?・?・?髯晢??郢晢??遶頑･???陋ｹ・??・?蜀暦??・?陝ｶ蜷??・?UI驛｢・?陞ｳ螟ｲ・?・??・?・?髫?・??・?・?郢晢??陜捺?ゑｽ?・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髫?螟ゑ??・??・?・??・?・?郢晢??郢晢??陝????椶・?郢晢??驛｢譎｢・?・?鬯?・?鬮?・?遶企?・?・?鬮?竏晢??鬥?・?蛹・??・?郢晢??郢晢??=====
let __resizeTimer = null;
function adjustForFixedBar(){
    try{
        const bar = document.getElementById('mic-permission-bar');
        const top = document.getElementById('top-bar');
        if(!bar || !top) return;
        // 驛｢譎?樟郢晢??驛｢譎丞ｹ?郢晢??驛｢譎｢・?・?髯??郢晢??郢晢??鬯?・?陞｢・??・?・??・?・?驛｢譎???驥・??・?譎｢・?・?驍ｵ・??・?・?驍ｵ・?雋?∞??竏ｫ・?・?郢?蟀驍ｵ・??・?・?驛｢・?陋ｹ・??・??匁割陷?・??・?・??・?・?鬮?・?隲?肩・?・??・?・?驍ｵ・??・?・?髣???陝雜｣・?・?郢晢??
        // 髯滂ｽ??・?・?驍ｵ・??・?・?驍ｵ・?雋?∞??竏ｬ・?螢??・??・?・?隴∵腸・??驍ｵ・?隰疲?捺??驍ｵ・?闕ｳ螂???閧?・?・?郢晢??隨・??驍ｵ・?髫?・?驍丞ｸ?・?・?陋ｹ・??・??
        bar.style.display = 'inline-flex';
        bar.style.flexWrap = 'wrap';
    }catch(_){ /* no-op */ }
}
function clampToViewport(){
    try{
        const ids = ['top-bar','transportBar','markers','controls','timelineScrollBar','chartContainer'];
        for(const id of ids){
            const el = document.getElementById(id);
            if(!el) continue;
            el.style.width = '100%';
            el.style.maxWidth = '100%';
            el.style.overflowX = 'clip';
        }
        // 鬯?貊ゑ??・?驍ｵ・?郢晢??郢晢??驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?髯?・?鬮?・?・主??・?譎??・取辨?・?陝ｲ・?郢晢??髫?螢??・??・?・?隴∵腸・??髯???・?・?髯?蛹??・?
        const labels = ['melodyAudioLabel','accompAudioLabel'];
        for(const id of labels){
            const el = document.getElementById(id);
            if(!el) continue;
            el.style.whiteSpace = 'normal';
            el.style.overflow = 'hidden';
            el.style.textOverflow = 'clip';
            el.style.maxWidth = '100%';
        }
        // 驛｢譎擾??・?邵?蜀暦??譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏???・?郢晢??髣???髦?蜷??骰具??・?郢?闌ｨ・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎?蠕?・?驛｢譎???驥・??・?譎｢・?・?髫?螟ゑ??・??・?・??・?・?
        try{ document.documentElement.style.overflowX = 'hidden'; document.body.style.overflowX = 'hidden'; }catch(_){ }

        // 髯橸??雋企屮・?・??・?・?: 驛｢譎∽??・守､?・?譎｢・?・?驛｢譎???郢晢??驛｢譎槭??・?・?郢晢??驍?鬮?陬懈が?・?・??・?・?驛｢・?陷?闌ｨ・?・?隲幢??郢晢??驍ｵ・?陷会ｽ?・つ遶丞｣?關ｽ驍ｵ・??・?・?髯懶???・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?
        const vw = Math.max(0, window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth || 0);
        const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
        while(walker.nextNode()){
            const el = walker.currentNode;
            if(!(el instanceof HTMLElement)) continue;
            // 驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?髯晢??郢晢??遯?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譏???・??・?・?郢晢???・?蟶晏ｱ・?晢??遶擾??驍ｵ・??・?・?驍ｵ・?郢晢???・?遏ｩ蝗守ｫ擾???・?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?髯・?・?・?鬮?雜｣・?・?
            const sw = el.scrollWidth;
            const cw = el.clientWidth;
            if(sw > cw || sw > vw){
                // 髣懃§蜚ｱ?・?・?郢晢?? canvas 驍ｵ・??・?・?鬮?蛹・??・?髯晢??郢晢??遶頑･?蠏ｩ隴取得??・?陋滂ｽ?隨・驛｢・?闕ｵ譏ｶ陞ｺ驛｢・?郢晢??width:100% 驛｢・?髮区?樒?髯?蛹??・?
                if(el.tagName.toLowerCase() === 'canvas'){
                    el.style.maxWidth = '100%';
                    el.style.width = '100%';
                } else {
                    el.style.maxWidth = '100%';
                    // 髯懈圜・?・?髯橸??陞｢・??・?・?郢晢???・?螳夲???・螢?蜻?髯懶???・?・?髯?・?陋ｹ・?郢晢??髫???・?????・?雋????
                    if(el.style.width && !el.style.width.includes('%')){
                        el.style.width = '100%';
                    }
                }
                el.style.overflowX = 'hidden';
            }
        }
    }catch(_){ /* no-op */ }
}
function adjustResponsiveLayout(){
    adjustForFixedBar();
    clampToViewport();
    fitMainAreaHeight();
}

// 鬨?蛹・??・?鬯?・??・?・?驍ｵ・??・?・?鬯?・?陋滂ｽ??・??驍ｵ・?郢晢??隨・??驍ｵ・??・?・?驍ｵ・?郢晢??遶企豪・?・?陟募?湖馴Δ譎｢・?・?驛｢譎｢・?・?驛｢譎∬??・?・?闕ｵ譏ｴ??驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?郢晢??陷?・?郢晢??鬨??難??蛟･?・?驛｢・??・?・?驛｢譎｢・?・?鬩玲慣・?・?驍ｵ・?鬮?・?遯?・?髯?・?陟托??遶擾??驛｢・?闕ｵ譎｢・?閧?・?・?郢晢??遶企豪・?・?郢晢??
// 驛｢譏ｶ??・・・?譎｢・?・?驛｢譎?樟邵?鬘費??譎｢・?・?驛｢・??・?・?(#chartContainer)驍ｵ・??・?・?鬯?・?陋滂ｽ??・??驛｢・?髮区?∝樺鬨?・?郢晢??遶???・りｫ?諛?・?驍ｵ・?陷会ｽ?遯?・?鬮?・??・?・?髯橸??陞滂ｽ??・?・?陋ｹ・?・守坩・?譎?蠕娯鴬驛｢譎｢・?・?/驛｢・??・?・?驛｢譎?§・取ｨ抵??譏ｴ?・?郢晢??髯・?・?・?鬮?雜｣・?・?郢晢??陝ｲ・?・つ郢晢??
function fitMainAreaHeight(){
    // CSS驍ｵ・??・?・?驛｢譎???驥・?抵??譏ｴ?・?邵?驢搾??・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎?樟邵?蟶?・?・?・?髯?閧??蜍???驍ｵ・??・?・?髫?・?闕ｵ譎｢・?莨・??・?陋滂ｽ??・??驛｢・?髮区?呈ｨ?驛｢・?鬮???・?・?髦?蜷??・?驛｢・?闕ｵ譏ｶ陞ｺ驛｢・?遶丞仰郢?蟀驍ｵ・??・?・?驍ｵ・??・?・?鬯?・?陋滂ｽ??・??驛｢・?陋幢???・?讓抵??・?陋滂ｽ??・?閾?・?・??・?・?驍ｵ・?郢晢??
}

window.addEventListener('load',()=>{
    warnIfInsecureContext();
    resizeCanvas();
    updateMicGateVisual();
    autoCenterMelodyTrack();
    updateTimelineScrollRange();
    drawChart(); /* file:// 鬮?・??・?・?髯?・?驗呻??郢晢??鬮?・??・?・?鬩穂ｼ夲??・?驍ｵ・?陷会ｽ?遶企?・?・?郢晢??*/
    autoLoadSfzInstruments();
    // 髯具??隴惹?橸??骰具??・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎???・?蟶・・??・?・?髫?蟷?・?・?髯晢??郢晢??遶剰ご??譎???譁絶襖驛｢譏ｴ?・?郢晢??
    adjustResponsiveLayout();
    // 驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎???・?・??・?・?髯橸??陞溘?・?・?髯溷供??螽??骰具??・?郢???・?繧会ｽ?・?郢晢???・?・?・つ髯溯??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・?陜｣・??・?・??・?・?髯橸??陞｢・??・??驍ｵ・?陝ｶ蜻?・?荵・・?闔・?郢晢??髯懷干?・?px髯・?・?・?鬩???陷???・?・?郢晢??
    setTimeout(()=>{ try{ resizeCanvas(); updateTimelineScrollRange(); drawChart(); }catch(_){ } }, 0);
    // 驛｢譎擾??・?郢晢??驛｢・??・?・?鬮?・??・?・?驍ｵ・??・?・?鬮?雜｣・?・?驍ｵ・??・?・?髫?蠑ｱ・・?晢??髣???・つ髯具??郢晢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ?郢晢??驍ｵ・?陷会ｽ?遶企?・?・?郢晢??・つ郢?逎ｯ繹?驍ｵ・??・?・? granted 驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?鬮?・?郢晢??驍ｵ・??・?・?鬯?・?陷?・?・ゑｽ?驍ｵ・??・?・?髯具??隴・隰・髯具??隰費??隨・驛｢・?闕ｵ謨鳴郢晢??
    (async()=>{
        try{
            const state = await getMicPermissionState();
            if(state==='granted' && !micAnalyser){ await initMic(false).catch(()=>{}); }
            // granted 髣比ｼ夲??・?髯樊ｻ薙§郢晢??髣???髴???・?繧会ｽ?・?陷会ｽ?遶企?・?・?郢晢???・?・?陋ｹ・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?驛｢・?郢?螂???・?郢晢??隰撰??驍ｵ・?陷会ｽ?遶企?・?・?郢晢???・?・?郢晢??
        }catch(_){ /* 髣???髴???・?繧会ｽ?・?陷会ｽ?遶企?・?・?郢晢??*/ }
    })();
    // 髯?闌ｨ・?・?髯?迚呻??蜷??咎Δ譎?蠕娯鴬驛｢・??・?・?驍ｵ・?隰疲?ゑｽ?・?陝ｲ・??・?蜀暦??・??・?・?驍ｵ・?雋?陜ｨ?驍ｵ・??・?・?鬮?・??・?・?髯??趣???青螳壽呵?守ｿ??・?髫?蟶?・?・?陜滂ｽ?
    try{
        if(navigator.mediaDevices && navigator.mediaDevices.addEventListener){
            navigator.mediaDevices.addEventListener('devicechange', async()=>{
                try{ if(await canInitMicWithoutPrompt()){ await initMic(false).catch(()=>{}); } }catch(_){ }
            });
        }
    }catch(_){ }
    // 驍ｵ・?隰・・・?・??・?・?髴難???・?・?髯?蜿?・?竏晄?るし・?闕ｳ鄙ｫ?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢譎??・趣??驛｢譏ｴ?・?
    try{
        const btn=document.getElementById('clearDotsButton');
        if(btn){ btn.onclick=()=>{ pitchHistory.length=0; drawChart(); }; }
    }catch(_){ }
    // 髯憺屮・?・?鬩慕甥・?闌ｨ・?・??・?・?鬩怜綜邇⑩驍ｵ・??・?・?驛｢・??・?・?驛｢譎??・趣??驛｢譏ｴ?・?
    try{
        if(practiceModeOn && practiceModeOff){
    practiceModeOn.onclick=()=>{
            activateAudioOnce();
            // 鬩搾???・?・?鬯?・?郢晢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕?・?驍ｵ・??・?・?髯滂ｽ?郢晢??隨・鬯?・??・?・?驍ｵ・?陷?・??・?・?陜捺??・?諛?р陷???・?・?郢晢??
            try{ if(editToolbar){ editToolbar.classList.add('hidden'); editToolbar.style.display='none'; } }catch(_){ }
                    // 髫??会ｽ?・?髯・陋滂ｽ?郢晢??驛｢譎｢・?・?驛｢・??・?・?驍ｵ・?陟募??譌ｺ驛｢・?陷?・??・?・??・?・?髯?・?陋ｹ・?郢晢??髣???隴取得??・?陋滂ｽ??・?螳壼?・?晢??隨・
                    const hasAudio = !!(window.melodyOrigBytes||window.accompOrigBytes||melodyBuffer||accompBuffer);
                    const hasDots = !!(pitchHistory && pitchHistory.length>0);
                    if(hasAudio || hasDots){
                        const ok = confirm('髯憺屮・?・?鬩慕甥・?闌ｨ・?・??・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎擾??・?遶????ｧ?・?・?鬮?・?陟暮?会ｽ??驍ｵ・??・?・?驍ｵ・?陷?・?・つ郢?逕ｻ・???闊?・?・?驍ｵ・??・?・?髯??郢晢???・?・??・?・?驛｢・?陞ｳ螟ｲ・?・?陋滂ｽ?????郢晢??闔蛹・??・?隴取得??・?陋??・?・?陝ｲ・??・??驍ｵ・??・?・?驍ｵ・?陷?・?・ゑｽ?郢晢??雎?ワ郢晢??陋ｹ・?邵?蜀暦??譎｢・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎｢・?・?驍ｵ・?陷?・??・?迢暦??・??・?・?髣???隴取得??・?陋滂ｽ?隨?迢暦??・?陞｢・?遶???縺題棔螂・??・?鬲・?夲??・?郢晢??);
                        if(ok){ try{ saveSessionZip(); }catch(_){ } }
                    }
                    // 鬩搾???・?・?鬩怜綜邇⑩驛｢・?陋幢??郢晢??驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??驛｢譎｢・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??驛｢譎｢・?・?驛｢譎?蠕?・?驍ｵ・??・?・?鬩募???・?鬮?・??・?・?驍ｵ・?陷会ｽ?遯?・?鬮?・??・?・?鬩穂ｼ夲??・?
                    if(practiceToolbar){
                        const frg=document.createDocumentFragment();
            if(practicePatternSelect){ practicePatternSelect.style.display=''; frg.appendChild(practicePatternSelect); }
            if(practiceRangeWrap){ practiceRangeWrap.style.display='inline-flex'; frg.appendChild(practiceRangeWrap); }
            if(practiceStartBtn){ practiceStartBtn.style.display=''; frg.appendChild(practiceStartBtn); }
            if(practicePauseBtn){ practicePauseBtn.style.display=''; frg.appendChild(practicePauseBtn); }
            if(practiceStopBtn){ practiceStopBtn.style.display=''; frg.appendChild(practiceStopBtn); }
            if(practiceVolWrap){ practiceVolWrap.style.display='inline-flex'; frg.appendChild(practiceVolWrap); }
                        practiceToolbar.appendChild(frg);
                        practiceToolbar.classList.remove('hidden');
                        practiceToolbar.style.display='flex';
                        if(practiceCloseBtn){ practiceCloseBtn.style.display='none'; }
                        // 驛｢譎?鯵邵?・?驛｢譎｢・?・?鬯???隱??・?・?陞滂ｽ??・?・?騾趣??郤・??鬮?髦??・?闔??・???・?・?驍ｵ・??・?・?驍ｵ・?雋?∞??竏ｬ・?????・?陞ｻ讌｢・????髫???・?・?驛｢譏???闔橸??驛｢譎擾??・?・主??・?・??・?・?髯滓汚??・?驛｢・?鬯・??・?蟶?・?・?髣鯉ｽ??・?・?郢晢??
                        if(practiceCloseBtn){
                            practiceCloseBtn.onclick = ()=>{
                                // 鬯?・?陞｢・??・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎擾??・?遶城メ・??会ｽ?・?驍ｵ・?陷?・?郢晢??驍ｵ・??・?・?髯?・?隶呵??・?・?陝ｲ・?郢晢??髯???・?・?鬨??郢晢???・?螳壽Τ?・?・?驍ｵ・??・?・?
                                if(practiceModeOff && typeof practiceModeOff.onclick==='function'){
                                    practiceModeOff.onclick();
                                } else {
                                    // 驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?: 鬨?・??・?・?髫?證ｦ・?・?髫????髣???隴幢??陷第?抵??・??・?・?髯溷桁??・?髯晢???・?・?
                                    if(isPracticing) stopBasicPractice(true);
                                    if(practiceToolbar){ practiceToolbar.classList.add('hidden'); practiceToolbar.style.display='none'; }
                                    if(practiceTopGroup){
                                        if(practicePatternSelect){ practicePatternSelect.style.display='none'; practiceTopGroup.appendChild(practicePatternSelect); }
                                        if(practiceRangeWrap){ practiceRangeWrap.style.display='none'; practiceTopGroup.appendChild(practiceRangeWrap); }
                                        if(practiceStartBtn){ practiceStartBtn.style.display='none'; practiceTopGroup.appendChild(practiceStartBtn); }
                                        if(practicePauseBtn){ practicePauseBtn.style.display='none'; practiceTopGroup.appendChild(practicePauseBtn); }
                                        if(practiceStopBtn){ practiceStopBtn.style.display='none'; practiceTopGroup.appendChild(practiceStopBtn); }
                                        if(practiceVolWrap){ practiceVolWrap.style.display='none'; practiceTopGroup.appendChild(practiceVolWrap); }
                                    }
                                    practiceMode='off';
                                    try{
                                        if(melodyAudioBtn){ melodyAudioBtn.disabled = false; melodyAudioBtn.title = '驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??鬯?・??・?・?髯橸???・?・?驛｢・?陝ｶ譏ｶ?驛???螢??・?; }
                                        if(accompAudioBtn){ accompAudioBtn.disabled = false; accompAudioBtn.title = '髣費???・?・?髯槭??豐∬??・?髯橸???・?・?驛｢・?陝ｶ譏ｶ?驛???螢??・?; }
                                    }catch(_){ }
                                }
                            };
                        }
                    }
                    practiceModeOff && (practiceModeOff.style.display='');
                    practiceModeOn && (practiceModeOn.style.display='none');
                    practiceMode='basic';
                    // 髯晢???・?・?郢晢??郢晢??郢晢??鬮?・?郢晢??驛｢譏ｴ?・?郢晢??驛｢譎｢・?・?驛｢譏ｶ?螢??暮Δ譎丞ｹ??・?蟶昴???・?・?鬩怜雀?・?騾?驢搾??・??・?・?髫?蜴・??・?髫???・?・?
                    updateGlobalOctButtonsTooltip();
                    // 鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎?????・??・?・?驍ｵ・??・?・?鬯?・??・?・?髯橸???・?・?驛｢譎???譁撰?憺Δ???・?・?驛｢譎｢・?・?鬯?蛹・??・?髫?螢?・?・??・?螳夲??貊ゑ??・?髯?莨夲??・?髯具??陷???・?・?陋ｹ・?郢・驛｢・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?髫?螟ゑ??・??・?・??・?・?郢晢??郢晢??
                    try{
                        if(melodyAudioBtn){ melodyAudioBtn.disabled = true; melodyAudioBtn.title = '鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎?????・??・?・?驍ｵ・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?'; }
                        if(accompAudioBtn){ accompAudioBtn.disabled = true; accompAudioBtn.title = '鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎?????・??・?・?驍ｵ・??・?・?髴取ｻゑｽ?・?髯?莨夲??・?'; }
                    }catch(_){ }
                    // 驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?髴???・?閾?・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎∬??・?・?陋ｹ・?郢晢??驛｢譎｢・?・?驛｢譏ｴ?・?邵?驢搾??・??・?・?鬮?證ｦ・?・?驛｢・?陝ｲ・?遶企?・?・?郢晢??・つ郢???・?・?郢晢???・?・?遶丞｣??驢搾??・?陝ｲ・?・主?・?譎｢・?・?驛｢・??・?・?驍ｵ・?霑ｹ螟ｲ・?・??・?・?鬮?雜｣・?・?郢晢??郢晢??
                    try{ if(isPlaying) pausePlayback(); }catch(_){ }
                    midiGhostNotes=null; drawChart();
            };
            practiceModeOff.onclick=()=>{
                activateAudioOnce();
                if(isPracticing) stopBasicPractice(true);
                // 驛｢譏ｴ?・?郢晢??驛｢譎｢・?・?驛｢譎?蠕?・?驛｢・?陝ｶ譎乗??驍ｵ・?陷会ｽ?隨・??驍ｵ・??・?・?驍ｵ・?遶乗?閠?UI驛｢・?髮区???・?驍ｵ・??・?・?驛｢譎?樟郢晢??驛｢譎丞ｹ?邵?蝣?・?譎｢・?・?驛｢譎｢・?・?驛｢譎丞ｹ?遶頑･?・??会ｽ?・?驍ｵ・?陷会ｽ?遯?・?鬯?・?隶・?・?・??・?・?鬩穂ｼ夲??・?髯具??郢晢??
                if(practiceToolbar){ practiceToolbar.classList.add('hidden'); practiceToolbar.style.display='none'; }
                if(practiceTopGroup){
                    if(practicePatternSelect){ practicePatternSelect.style.display='none'; practiceTopGroup.appendChild(practicePatternSelect); }
                    if(practiceRangeWrap){ practiceRangeWrap.style.display='none'; practiceTopGroup.appendChild(practiceRangeWrap); }
                    if(practiceStartBtn){ practiceStartBtn.style.display='none'; practiceTopGroup.appendChild(practiceStartBtn); }
                    if(practicePauseBtn){ practicePauseBtn.style.display='none'; practiceTopGroup.appendChild(practicePauseBtn); }
                    if(practiceStopBtn){ practiceStopBtn.style.display='none'; practiceTopGroup.appendChild(practiceStopBtn); }
                    if(practiceVolWrap){ practiceVolWrap.style.display='none'; practiceTopGroup.appendChild(practiceVolWrap); }
                }else{
                    // 驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?: 鬮?蛹・??・?驍ｵ・?隰疲??蠕宣辧蜍溷??邵?蝣?・?・?鬮?・?遶企?・?・?郢晢???・?・??・?・?髯?・?陋ｹ・?邵?蝣?・?・?郢?蝓淞蜻?謚??幢??陷第??・?・?隶・?・?・??・?・?鬩穂ｼ夲??・?
                    practicePatternSelect && (practicePatternSelect.style.display='none');
                    practiceRangeWrap && (practiceRangeWrap.style.display='none');
                    practiceStartBtn && (practiceStartBtn.style.display='none');
                    practicePauseBtn && (practicePauseBtn.style.display='none');
                    practiceStopBtn && (practiceStopBtn.style.display='none');
                    practiceVolWrap && (practiceVolWrap.style.display='none');
                }
                practiceModeOff && (practiceModeOff.style.display='none');
                practiceModeOn && (practiceModeOn.style.display='');
                if(practiceCloseBtn){ practiceCloseBtn.style.display='none'; }
                practiceMode='off';
                // 鬮?・??・?・?鬩穂ｼ夲??・?鬨?蛹・??・?驛｢・??・?・?驛｢譎???譁石夐Δ??陋幢??・取㏍・?・??・?・?驛｢譏ｴ?・?郢晢??驍ｵ・?陷会ｽ?・つ遶丞｣??夜Δ譎｢・?・?驛｢譎｢・?・?驛｢譏ｶ?螢??暮Δ譎丞ｹ??・?繧????会ｽ?・?驍ｵ・?郢晢??
                practiceCallDisplayOctShift = 0;
                updateGlobalOctButtonsTooltip();
                // 髴取ｻゑｽ?・?髯?莨夲??・?髯具??陷・??・?・??・?・?鬯?・??・?・?
                try{
                    if(melodyAudioBtn){ melodyAudioBtn.disabled = false; melodyAudioBtn.title = '驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??鬯?・??・?・?髯橸???・?・?驛｢・?陝ｶ譏ｶ?驛???螢??・?; }
                    if(accompAudioBtn){ accompAudioBtn.disabled = false; accompAudioBtn.title = '髣費???・?・?髯槭??豐∬??・?髯橸???・?・?驛｢・?陝ｶ譏ｶ?驛???螢??・?; }
                }catch(_){ }
            };
        }
    if(practiceStartBtn){ practiceStartBtn.onclick=()=>{ activateAudioOnce(); if(practiceMode==='basic'){ if(practicePaused){ resumeBasicPractice(); } else { startBasicPractice(); } } } }
    if(practicePauseBtn){ practicePauseBtn.onclick=()=>{ activateAudioOnce(); if(isPracticing){ pauseBasicPractice(); } } }
    if(practiceStopBtn){
        let _prStopClick=0, _prStopTimer=null;
        practiceStopBtn.onclick=()=>{
            activateAudioOnce();
            _prStopClick++;
            if(_prStopClick===1){
                // 1髯?軸・?雋橸??・?: 鬩搾???・?・?鬩怜雀?・?郢晢??髯句??繩??・?・??・?・?驍ｵ・??・?・?驍ｵ・??・?・?
                if(isPracticing) stopBasicPractice(true);
                // 2髯?軸・?雋橸??・?髯溯?・・?隨・驍ｵ・??・?・?驛｢譎?・?・趣??驛｢譎???・?蟶晢???・?・?髫?蠑ｱ・玖?・?鬮?・??・?・?鬩穂ｼ夲??・?郢晢??陋ｹ・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎?樟?取刮・?・?髮区??・?・?騾???陝ｲ・?郢晢??郢晢??
                try{ practiceStopBtn.title = '驛｢・?郢??遶???髣???・つ髯溯??・?・?髫?螟ｲ・?・?驍ｵ・?陷?・?遶??晢??・?陞｢・??・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎擾??・?遶城メ・??会ｽ?・?驛｢・?驗呻??遶擾??驍ｵ・?郢晢??; }catch(_){ }
                _prStopTimer = setTimeout(()=>{ _prStopClick=0; try{ practiceStopBtn.title=''; }catch(_){ } }, 900);
            } else if(_prStopClick>=2){
                if(_prStopTimer){ clearTimeout(_prStopTimer); _prStopTimer=null; }
                _prStopClick=0;
                // 鬯?・?陞｢・??・?・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎擾??・?遶城メ・??会ｽ?・?驛｢・?郢晢??
                try{
                    if(practiceModeOff && typeof practiceModeOff.onclick==='function'){
                        practiceModeOff.onclick();
                    } else {
                        if(isPracticing) stopBasicPractice(true);
                        if(practiceToolbar){ practiceToolbar.classList.add('hidden'); practiceToolbar.style.display='none'; }
                        if(practiceTopGroup){
                            if(practicePatternSelect){ practicePatternSelect.style.display='none'; practiceTopGroup.appendChild(practicePatternSelect); }
                            if(practiceRangeWrap){ practiceRangeWrap.style.display='none'; practiceTopGroup.appendChild(practiceRangeWrap); }
                            if(practiceStartBtn){ practiceStartBtn.style.display='none'; practiceTopGroup.appendChild(practiceStartBtn); }
                            if(practicePauseBtn){ practicePauseBtn.style.display='none'; practiceTopGroup.appendChild(practicePauseBtn); }
                            if(practiceStopBtn){ practiceStopBtn.style.display='none'; practiceTopGroup.appendChild(practiceStopBtn); }
                            if(practiceVolWrap){ practiceVolWrap.style.display='none'; practiceTopGroup.appendChild(practiceVolWrap); }
                        }
                        practiceMode='off';
                        try{
                            if(melodyAudioBtn){ melodyAudioBtn.disabled = false; melodyAudioBtn.title = '驛｢譎｢・?・?驛｢譎｢・?・?驛｢譏ｴ?・?邵??鬯?・??・?・?髯橸???・?・?驛｢・?陝ｶ譏ｶ?驛???螢??・?; }
                            if(accompAudioBtn){ accompAudioBtn.disabled = false; accompAudioBtn.title = '髣費???・?・?髯槭??豐∬??・?髯橸???・?・?驛｢・?陝ｶ譏ｶ?驛???螢??・?; }
                        }catch(_){ }
                    }
                }catch(_){ }
            }
        };
    }
        if(practiceCallVolEl){ practiceCallVolEl.oninput=()=>{ try{ ensureAudio(); if(practiceCallGain){ const v=Math.max(0, Math.min(1, parseFloat(practiceCallVolEl.value)||0.85)); practiceCallGain.gain.setValueAtTime(v, audioCtx.currentTime); } }catch(_){ } }; }
    }catch(_){ }

    // 驛｢譎｢・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?髫?蠑ｱ?・? 驛｢譏ｴ?・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驍ｵ・?陷会ｽ?遯?・?髫??陷諤懈?郢晢??郢晢??・取ｨ抵??・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譎槭??・?・??・?・?髫?・??・?・?
    window.addEventListener('resize',()=>{
        if(__resizeTimer) clearTimeout(__resizeTimer);
        __resizeTimer = setTimeout(()=>{
            adjustResponsiveLayout();
            resizeCanvas();
            updateTimelineScrollRange();
            drawChart();
            // 髯滂ｽ??・?・?驍ｵ・??・?・?驍ｵ・?雋?∞??竏ｬ諤呵泛雜?・?・?髢?・??・?・?隴会ｽ??・?・?陋ｹ・?郢晢??驛｢譎?蠕娯鴬驛｢・??・?・?UI髯樊ｺ?逕･髯悟､青・??・?・?髯溷供??蠕個蝣?・?・?郢?蝓淞蜻?譽・・?・?髯具??陷???・?・?郢晢??
            fitMainAreaHeight();
        }, 60);
    });
    // 鬮?蛹・??・?鬮?陬懈が?・?・??・?・?驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢・??・?・?髯樊ｺ?逕･陜滂ｽ?郢晢??闔・??・?・??・?・?驛｢譏???・?郢晢??驛｢譎｢・?・?鬯?・?驕擾??陷?・?鬩???闔ｨ螟ｲ・?・?陝ｲ・?遶企豪・?・?郢?螂???・??・?・?髯溯?・・?
    try{
                // 鬩搾???・?・?鬩怜雀?・?・守坩・?譎｢・?・?驛｢譎擾??・?邵?蝣?・?・??・?・?驍ｵ・?郢晢??陷・??驍ｵ・??・?・?驍ｵ・??・?・?驍ｵ・?遶擾???・?・?陷?・??・?・?陋ｹ・?遶???・?・?鬮?・?遶企?・?・?驗呻???・?蟶晢??蛹・??・?驍ｵ・?闔会ｽ??・?迢暦??・?雋?∞??竏ｫ・?譏ｴ?・?郢晢??驛｢譎｢・?・?驛｢譎?蠕?・?驛｢・?陝ｶ譎乗??驍ｵ・?郢晢??
                try{ if(practiceToolbar && practiceMode!=='basic'){ practiceToolbar.classList.add('hidden'); practiceToolbar.style.display='none'; } }catch(_){ }
        const parent = document.getElementById('chartContainer')?.parentElement || document.getElementById('chartContainer');
        if(parent && 'ResizeObserver' in window){
            const ro = new ResizeObserver(()=>{
                if(__resizeTimer) clearTimeout(__resizeTimer);
                __resizeTimer = setTimeout(()=>{ resizeCanvas(); updateTimelineScrollRange(); drawChart(); }, 32);
            });
            ro.observe(parent);
        }
    }catch(_){ }
    // 驛｢譎???・?邵??驛｢・??・?・?髫??陷諤懈?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎擾??・?邵?譎会ｽ?譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??驛｢・??・?・?驛｢譎??・趣??驛｢譏ｴ?・?
    try{
        if(micRenderModeSel){
            // 髫??会ｽ?・?髯橸??陞｢・?・守坩・?譎｢・?・?驛｢譎擾??・??・?譌ｦI驍ｵ・??・?・?驛｢・?郢??雋ょ????謫?・?・?
            try{ micRenderModeSel.value = 'graph'; }catch(_){ }
            micRenderModeSel.addEventListener('change', ()=>{
                const v = micRenderModeSel.value;
                micRenderMode = (v==='dot'||v==='graph')? v : 'line';
                try{ drawChart(); }catch(_){ }
            });
        }
    }catch(_){ }
});
// 髯具??隴・隰・驍ｵ・??・?・?BT鬮?・?隲?肩・?・??・?・?UI驍ｵ・??・?・?髫?證ｦ・?・?髯橸??陞｢・?・つ?・?・?驛｢・?髮区????螟???謫?・?・?郢晢??郢晢??udioContext髫?蟷?・?・?鬨??難??阮・・?髫?蠑ｱ・・?晢??髫??会ｽ?・?髯橸??陞｢・?・つ?・?・?郢晢??郢晢??
(()=>{ 
    const ms=Math.round(estimateOutputLatency()*1000); btLatencySec=ms/1000;
    if(btLatencySlider){ btLatencySlider.value=String(ms); btLatencySlider.disabled = !btLatencyEnabled; }
    if(btLatencyValue){ btLatencyValue.textContent=`${ms} ms`; }
    if(btLatencyToggle){ btLatencyToggle.checked = btLatencyEnabled; }
})();
// 髯具??隴・隰・髯?闌ｨ・?・?鬯?????・?驛｢・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢謨鳴髯?・?髢?・?闕ｳ?
if(resonanceMixSlider){ resonanceMixSlider.value=String(resonanceMix); }

// ---- Auto-load SFZ instruments from ./sfz/Piano and ./sfz/Flute ----
async function autoLoadSfzInstruments(){
    // file:// 驍ｵ・??・?・?髯懶???・?・?髯?・?陋ｹ・?郢晢??鬲・??逕溽?・??驍ｵ・??・?・?驛｢・??・?・?驛｢・??・?・?驛｢譏ｴ?・?郢晢??郢晢??鬩・?・?・??・?・?髯?・?驗呻???・?螳壽・・?・?驍ｵ・?髴域喚?驢搾??・?郢晢???・?・?郢晢??
    if(location.protocol==='file:') return;
    try{
        await loadSfzFromFolder('sfz/Piano', 'Piano');
    }catch(e){ console.warn('Piano SFZ load failed',e); }
    try{
        await loadSfzFromFolder('sfz/Flute', 'Flute');
    }catch(e){ console.warn('Flute SFZ load failed',e); }
}

async function loadSfzFromFolder(baseUrl, instName){
    ensureAudio();
    // 1) 驛｢譎????青ｰ驛｢譎｢・?・?驛｢謨鳴髯??郢晢??郢晢?? .sfz 髯?・?鬮?・??・?螳夲??證ｦ・?・?髮九ｑ??・?: index.sfz or 髯?・?隰疲?・?驛｢譎????青ｰ驛｢譎｢・?・?驛｢謨鳴.sfz 驕ｶ鄙ｫ?・?驍ｵ・??・?・?驍ｵ・?闔会ｽ??・?讙趣??・??・?・?髫????髯具??隴擾??郢晢??.sfz驛｢・?髮区??蠕宣Δ??陷茨???・?・?髢?・??・?・??・?・?髫?蝓主???・?・?郢晢??
    // 驛｢譏ｴ?・?邵??驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟?取㏍・?・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟郢晢??HTTP驍ｵ・??・?・?驍ｵ・?隴擾??郢晢??驍ｵ・??・?・?驍ｵ・??・?・?髯?・?鬮???・?・?陷会ｽ?邵?蝣?・?・?鬮?・?遶企?・?・?郢晢??隨??驛｢・?遶丞仰遶擾???・?・?郢晢??隰??: baseUrl/manifest.txt 驍ｵ・??・?・? .sfz 驍ｵ・??・?・? WAV髯具??驍???髮??趣??・?陜｣・??・?・??・?・?驍ｵ・?闔会ｽ??・??匁捗?・?・?髯?・?陋ｹ・?郢晢??驍ｵ・?隴擾???・?讙趣??・?陷・?・?・??・?・?驍ｵ・?郢晢??・つ郢晢??
    // 驍ｵ・?髦?蜻?・??驍ｵ・??・?・?驍ｵ・??・?・?鬩・?・?・?髫?蜑ｰ萓ｭ遶頑･?閼・・?・?鬮?・??・?・?髯?・?鬮?・??・?螳夲??雜｣・?・?驛｢・?遶丞､?・?迢暦??・?郢晢??
    const candidates=['index.sfz', instName+'.sfz', 'default.sfz'];
    let sfzText=null, sfzPath=null;
    for(const name of candidates){ try{ const r=await fetch(`${baseUrl}/${name}`); if(r.ok){ sfzText=await r.text(); sfzPath=`${baseUrl}/${name}`; break; } }catch(_){}}
    if(!sfzText){
        // 驛｢譎????青ｰ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?: 髯懈圜・?・?髯橸??陞｢・?鬪?蜊???・??・?・?髯樊ｻゑｽ?・?髫?・?陷会ｽ??・??驍ｵ・?雋?∞??陋ｾ蝮??・?・?驛｢・?郢晢???・?・?陋ｹ・?邵?遉ｼ・?譎｢・?・?驛｢譏???蜷??・?驍ｵ・??・?・?驛｢譎｢・?・?驛｢・??・?・?驛｢譎?樟??・?驍ｵ・??・?・?驍ｵ・?郢晢??遶??壼?暮??・?髮??趣??・??・?・?驍ｵ・?鬮?・?遶企?・?・?郢晢???・?・?郢晢??
        throw new Error('sfz not found in '+baseUrl);
    }
    // 鬮?證ｦ・?・?髫?・?髣??・・?髫??会ｽ?・?髯・陋滂ｽ?郢晢?? SFZ 驛｢譏???・?郢晢??驛｢・??・?・?鬩・?・?・?髫?蝓手??雎撰??驛｢・?髮区???・?髯具???・?・?鬨?蛹・??・?
    const basePath=baseUrl; // 鬨?・??・?・?髯・?・?・?髯?・?郢?蟲??・?髯憺屮・?・?髮・郢晢??
    const regions=[];
    function parseNoteNameOrNumber(v){
        if(v==null) return undefined; if(typeof v==='number') return v; const n=parseInt(v); if(!Number.isNaN(n)) return n; const s=String(v).trim(); const m=s.match(/^([A-Ga-g])([#bB]?)(-?\d+)$/); if(!m) return undefined; const step=m[1].toUpperCase(); const base={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[step]; const accCh=m[2]; const acc=accCh==='#'?1:(accCh==='b'||accCh==='B'?-1:0); const oct=parseInt(m[3]); return (oct+1)*12 + base + acc; }
    for(const lineRaw of sfzText.split(/\r?\n/)){
        const line=lineRaw.replace(/\s*\/\/.*$/,'').trim();
        if(!/\bregion\b/.test(line)) continue; const m=Object.create(null);
        line.replace(/(\w+)=((?:"[^"]*"|'[^']*'|[^\s]+))/g,(_,k,v)=>{ if(v && (v[0]==='"' || v[0]==="'")) v=v.slice(1,-1); m[k]=v; return ''; }); if(!m.sample) continue;
        regions.push({ sample:m.sample, lokey:(parseNoteNameOrNumber(m.lokey) ?? parseNoteNameOrNumber(m.key)), hikey:(parseNoteNameOrNumber(m.hikey) ?? parseNoteNameOrNumber(m.key)), lovel:m.lovel?parseInt(m.lovel):0, hivel:m.hivel?parseInt(m.hivel):127, loop_start:m.loop_start?parseInt(m.loop_start):undefined, loop_end:m.loop_end?parseInt(m.loop_end):undefined, trigger:m.trigger||undefined, pitch_keycenter:(parseNoteNameOrNumber(m.pitch_keycenter) ?? parseNoteNameOrNumber(m.key)), loop_mode: m.loop_mode||undefined });
    }
    if(!regions.length) throw new Error('no regions in '+sfzPath);
    // 驛｢・??・?・?驛｢譎｢・?・?驛｢譎丞ｹ?・取?諢?鬮???・?・?郢晢??& 驛｢譏ｴ?・?邵?諷???譎｢・?・?驛｢譏ｴ?・?
    const map={};
    // 鬩・?・?・?髫?荳・・? 驛｢譎???譁撰?憺Δ???・?・?驛｢譎｢・?・?髯?・?鬮?・?・ゑｽ?驛｢・?驕ｯ・?IDI驛｢・?陷?驛?・?髯橸??陞滂ｽ??・?・?郢晢??allback鬨?蛹・??・?郢晢??郢晢??
    function inferMidiFromFilenameSimple(samplePath){
        try{
            const base = String(samplePath||'').split('/')?.pop()||'';
            const name = base.replace(/\.[A-Za-z0-9]+$/,'');
            const m1 = name.match(/(^|[^A-Za-z])([A-Ga-g])([#b]{1,2})?(-?\d)($|[^A-Za-z0-9])/);
            if(m1){
                const step=m1[2].toUpperCase();
                const baseIdx={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[step];
                const accStr=m1[3]||''; let acc=0; if(accStr){ if(/##/.test(accStr)) acc=2; else if(/#/.test(accStr)) acc=1; else if(/bb/.test(accStr)) acc=-2; else if(/b/.test(accStr)) acc=-1; }
                const oct=parseInt(m1[4]); const midi=(oct+1)*12 + baseIdx + acc; if(midi>=0 && midi<=127) return midi;
            }
            const m2 = name.match(/(?:^|[^0-9])(1[01][0-9]|12[0-7]|\d?\d)(?:[^0-9]|$)/);
            if(m2){ const n=parseInt(m2[1]||m2[0]); if(n>=0 && n<=127) return n; }
        }catch(_){ }
        return null;
    }
    // 髫?・??・?・?髯滓汚??・?髯・髣??湖ｨ驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?蠕湖暮Δ???・?・?郢晢??髢?・??・?・??・?・?髫?蟷?・?・?鬮?・??・?・?髯?迚呻??蜷??讌｢?・?隲帷腸・?驍ｵ・?雋???隨鞘握諤?騾趣???・?・?郢晢???・?螳壽割?・?・?鬨?蛹・??・?郢晢??郢晢??
    function urlWithAltExts(path){
        const seen=new Set(); const out=[]; const m=path.match(/^(.*)\.([A-Za-z0-9]+)$/);
        if(m){
            const base=m[1];
            getAltSampleExts().forEach(e=>{ const q=base+'.'+e; if(!seen.has(q)){ seen.add(q); out.push(q); } });
            if(!seen.has(path)) out.push(path); return out;
        }
        getAltSampleExts().forEach(e=>{ const q=path+'.'+e; if(!seen.has(q)){ seen.add(q); out.push(q); } });
        if(!seen.has(path)) out.push(path); return out;
    }
    for(const r of regions){
        // Windows髯具???・?・?髯具??郢晢???・?? -> URL髯具???・?・?髯具??郢晢???・??
        const normalizedSample = String(r.sample||'').replace(/\\/g,'/');
        const urls = urlWithAltExts(`${basePath}/${normalizedSample}`);
    let ab=null; for(const u of urls){ try{ const res=await fetch(u); if(res.ok){ ab=await res.arrayBuffer(); break; } }catch(_){} }
    if(!ab) continue;
    // WAV驛｢譎｢・?・?驛｢・??・?・?
    const meta=readWavMeta(ab);
    const origRate= meta.sampleRate||0;
        const buf=await new Promise(res=> audioCtx.decodeAudioData(ab, b=>res(b), ()=>res(null)));
        if(!buf) continue;
        // 驛｢・??・?・?驛｢譎｢・?・?鬩???郢晢??陝ｲ?驍ｵ・??・?・?鬮?・?隲幢???・?・?郢晢??驛｢・??・?・?驛｢譎｢・?・?驛｢譏ｴ?・?郢晢??
        let lo=r.lokey, hi=r.hikey;
        if(lo==null && hi==null){
            const rootGuess = (r.pitch_keycenter!=null? r.pitch_keycenter: inferMidiFromFilenameSimple(r.sample));
            if(rootGuess!=null){ lo=hi=rootGuess; }
        }
        if(lo==null) lo = (hi!=null? hi: 60);
        if(hi==null) hi = lo;
        lo=Math.max(0, Math.min(127, lo));
        hi=Math.max(0, Math.min(127, hi));
        if(hi<lo){ const t=lo; lo=hi; hi=t; }
        const layer = (r.hivel??127)<=50? 'pp': (r.lovel??0)>=90? 'ff': 'mf';
        const root=(r.pitch_keycenter!=null)? r.pitch_keycenter: Math.round((lo+hi)/2);
        for(let m=lo;m<=hi;m++){
            if(!map[m]) map[m]={layers:{},release:null,gains:{}};
            if(r.trigger==='release'){ map[m].release=buf; continue; }
            if(!map[m].layers[layer]){
                let loopSec;
                if(r.loop_start!=null && r.loop_end!=null){
                    loopSec={ s:(r.loop_start/(origRate||buf.sampleRate)), e:(r.loop_end/(origRate||buf.sampleRate)) };
                } else if(meta.loopStart!=null && meta.loopEnd!=null){
                    const sr=(origRate||buf.sampleRate);
                    loopSec={ s: meta.loopStart/ sr, e: meta.loopEnd/ sr };
                } else if(r.loop_mode==='loop_continuous'){
                    loopSec={ s: Math.min(0.02, Math.max(0, buf.duration*0.02)), e: Math.max(0.05, buf.duration-0.02) };
                }
                map[m].layers[layer]={ buffer:buf, root, loop: undefined, loopSec };
            }
        }
    }
    instrumentMaps[instName]=map;
    // 髫??会ｽ?・?髯橸??陞｢・?郢晢??驛｢・??・?・?驛｢譎擾??・?遶企豪・?・?郢??雋ょ????謫?・?・?郢晢??闔・??・?・?隴?・?陝・?髣・陷?逎ｯ蜈ｱ郢晢??郢晢??
    if(instName==='Piano') pianoSampleMap=map;
    useSamplePiano=true; pianoSamplesLoaded=true; setPianoZipStatus(instName+' SFZ驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎?櫨?・?・?陟包???・?・?郢晢?? + (SELECTED_SAMPLE_PRIMARY? ' [fmt: '+SELECTED_SAMPLE_PRIMARY+']': ''));
    // 髯?・?髢?・?闕ｳ蜊???・??・?・?驍ｵ・?雋?∞??竏ｬ諤咎ｫ?・?邵?蟶?・?・??・?・?驛｢・??・?・?驛｢譎｢・?・?驛｢譎｢・?・?驛｢譎｢・?・?
    scheduleAll(); if(isPlaying){ pausePlayback(); startPlayback(); }
}
// EOF cleanup
