・ｿ/* =====================================================================
 * app.js  鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ髫ｶ蜴・ｽｽ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陞滂ｽｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
 * ===================================================================== */
window.onerror=(m,s,l,c,e)=>{ console.error('JS Error',m,s,l,c,e); /* 鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ*/ };
// ---- State ----
// Audio-based operation: currentTracks is [0]=melody(monophonic), [1]=accomp(reference rendering)
// 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ隰悟･・ｽｽ・ｷ隴取･ｪﾂ?繝ｻ・ｽ繝ｻ・ｽ?: currentTracks 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ [0]=鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?(鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ, [1]=鬯ｮ・｣髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶抵ｽｭ?繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｱ髯晢ｽｶ隰ｨ魑ｴﾂ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let currentMidi=null,currentTracks=[];let melodyTrackIndex=0,accompTrackIndexes=[];
// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・､鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ Part1-4 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ隴ｴ・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ: buffer,duration,notes,鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let melodyParts = Array.from({length:4},()=>({
    buffer:null, duration:0, notes:[],
    origBytes:null, origName:null, origExt:null,
    showNotes:true, playAudio:true
}));
let currentMelodyPart = 0; // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let melodySources = [];     // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?BufferSource鬯ｯ・ｩ驍・ｽｲ隲ｷ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let trackInstrumentAssign = [];
let audioCtx=null,melodyGain=null,accompGain=null,masterGain=null,compressor=null,limiter=null;
let _keepAliveOsc=null,_keepAliveGain=null; // destination鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ繝ｻ・ｽ?雎・屮・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)
let _keepAliveHiOsc=null,_keepAliveHiGain=null; // destination鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髫ｲ蟶帶ｲｺ霑｢・ｭ鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)
let _keepAliveConst=null,_keepAliveConstGain=null; // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髫ｨ蜷ｶ・具ｾ守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ
let audioActivated=false; // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髣厄ｽｴ郢晢ｽｻdioContext鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｷ讌ｪﾂ髯ｷ謇假ｽｽ・ｰ髫ｲ・､郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let micStream=null,micSource=null,micAnalyser=null,micData=null,analysisTimer=null;
// 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｺ・ｽ陜ｮ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let isPitchOnlyMode=false;
// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ deviceId 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let selectedMicDeviceId = null;
let _micDevicesCache = [];
// ---- Modular YIN tracker integration ----
let USE_YIN_TRACKER = true; // set false to fallback to legacy pipeline
let _yinTracker = null;     // instance of window.__PitchModules.YinPitchTracker
let _pitchSmootherMod = null; // instance of window.__PitchModules.PitchSmoother
let _micVoicedRecently=false; // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?
let _micFlatFrames=0;        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ(鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let _micLastReinitAt=0;      // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｶ陞ｳ闌ｨ・ｽ・ｿ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ邵ｺ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ(ms)
let _micSilentFrames=0,_micReinitInFlight=false;
let _initMicInFlight=false, _lastPromptAt=0;
let _userExplicitMicInit=false; // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛沺・｡・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let _firstInteractionArmed=false; // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ魃会ｽｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｨ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隰ｦ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let _insecureWarned=false; // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｧ・ｭ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?: 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ髣・ｽｽ隰ｳ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ髮｣・ｽ・｣髯句ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let _mobileHoldRemain=0, _mobileHoldFreq=0;
let _mobilePitchPushToggle=false;
let _mobileLowDecim=0; // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬆托ｽｨ謚ｵ・ｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let _mobileNoiseDb=-60; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯ｷ謳ｾ・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ(dB)

async function getMicPermissionState(){
    try{
        if(navigator.permissions && navigator.permissions.query){
            const st = await navigator.permissions.query({name:'microphone'});
            return st.state; // 'granted' | 'denied' | 'prompt'
        }
    }catch(_){ }
    return null; // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽafari鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
}

async function canInitMicWithoutPrompt(){
    const st = await getMicPermissionState();
    if(st==='granted') return true;
    // Permissions API 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽull鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    if(st===null && _userExplicitMicInit) return true;
    return false;
}
// 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ魃会ｽｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯橸ｽｳ陞｢・ｼ陋ｻ譎｢・ｿ・ｽ?繝ｻ・ｽ邵ｺ・､・つ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ闔ｨ諛ｶ・ｽ・ｾ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯ｷ謳ｾ・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ・つ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function armFirstInteractionMicPrompt(){
    try{
        if(_firstInteractionArmed) return; _firstInteractionArmed=true;
        const handler = async()=>{
            try{ await initMic(true).catch(()=>{}); }finally{
                try{ window.removeEventListener('pointerdown', handler, true); }catch(_){ }
                try{ window.removeEventListener('keydown', handler, true); }catch(_){ }
                try{ window.removeEventListener('touchstart', handler, true); }catch(_){ }
            }
        };
        window.addEventListener('pointerdown', handler, {capture:true, once:true, passive:true});
        window.addEventListener('keydown', handler, {capture:true, once:true});
        window.addEventListener('touchstart', handler, {capture:true, once:true, passive:true});
    }catch(_){ }
}

// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・｣・ｰ闔会ｽｰ・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ?繝ｻ・ｽ繝ｻ・ｽFF鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function stopMic(){
    try{
        if(analysisTimer){ try{ clearInterval(analysisTimer); }catch(_){ } analysisTimer=null; }
        if(micStream){ try{ micStream.getTracks().forEach(t=>{ try{ t.onended=null; t.onmute=null; t.onunmute=null; }catch(_){ } try{ t.stop(); }catch(_){ } }); }catch(_){ } }
        try{ if(micSource) micSource.disconnect(); }catch(_){ }
        try{ if(micHPF) micHPF.disconnect(); }catch(_){ }
        try{ if(micLPF) micLPF.disconnect(); }catch(_){ }
        micStream=null; micSource=null; micAnalyser=null; micHPF=null; micLPF=null; micData=null;
        try{ setMicStatus('OFF'); }catch(_){ }
    }catch(_){ }
}

// 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽfile:// 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ getUserMedia 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・｣・ｰ闔会ｽｰ・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯懷遜・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function warnIfInsecureContext(){
    try{
        const insecure = (location.protocol==='file:') || (!window.isSecureContext && location.protocol!=='https:');
        if(!insecure || _insecureWarned) return;
        _insecureWarned = true;
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髫ｶﾂ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ・つ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛沺・｡・ｶ鬮ｫ・ｰ驕伜∞・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・｢髫ｲ・､隲橸ｽｺ?繝ｻ・ｽ繝ｻ・ｽ鬯･・ｴ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{ console.warn('Insecure context detected (file:// or non-secure). Microphone may not work due to browser policy.'); }catch(_){ }
    }catch(_){ }
}
let micHPF=null, micLPF=null; // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ莨懶ｽｾ魃会ｽｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髫伜､懶ｽｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髫ｲ蟷・か?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜿冶・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｱ郢ｧ蜿･蟒ｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let playbackStartTime=0,playbackStartPos=0,playbackPosition=0,isPlaying=false,tempoFactor=1.0;
let schedTimer=null; // RAF鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let toleranceCents=20,gateThreshold=-40,analysisRate=120,A4Frequency=440,labelNotation='CDE';
// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｮ鬮ｷ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ髫ｰ魃会ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髫ｨ・ｬ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ..1鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const PITCH_CONF_MIN = 0.45;
const DRAW_CONF_MIN_MOBILE = 0.42; // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛沺・｡・ｶ鬮ｫ・ｰ郢晢ｽｻ: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣螂・ｽｿ・ｽ?邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓幢ｾつ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮｢ﾂ?繝ｻ・ｽ繝ｻ・ｽ隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬯滂ｽｴ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽN鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let USE_PC_PIPELINE_ON_MOBILE = true;
let verticalZoom=2.5,verticalOffset=0,pxPerSec=150,timelineOffsetSec=0,isPanning=false,panStartX=0,panStartOffset=0;
let isAdjustingVOffset=false; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ謇假ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let autoCenterFrozen=false; // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let pitchHistory=[],markers={A:null,B:null,C:null,D:null,E:null,F:null,G:null},stopStage=0;
let micRenderMode='graph'; // 'line' | 'dot' | 'graph'
// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｮ鬮ｷ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let visTimeSnapMs = 180;           // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ螳育櫨隲｢蟷・建郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髫ｨ・ｳ驕擾ｽｩ・守｢托ｽｭ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ桶繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽs鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let visBridgeGapMs = 150;          // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽs鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let visBridgeGapInNoteMs = 300;    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽs鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let visChangeTolSemi = 0.65;       // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｼ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let visEdgePadMs = 160;            // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽs鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let guideLineWidth=4; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ鬮｣螂・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// Live pitch state
let lastMicFreq=0,lastMicMidi=0; const pitchSmoothBuf=[]; const PITCH_SMOOTH_WINDOW=7;
// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮｣螂・ｽｿ・ｽ?繝ｻ・ｽ 鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽViterbi鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髮朱ｯ会ｽｽ・｣?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽf0鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const LIVE_VIT_LAG = 5;           // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ.1鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ.15s鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const LIVE_VIT_MAX = 48;          // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・守｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ髯ゑｽｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ隴ｴ・ｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ髣・ｽｽ髢・ｳ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ
let liveVitFrames = [];           // [{cands:number[], costs:number[], time:number}]
// ---- Diagnostics (lightweight, rate-limited) ----
let __diagEnabled = true; // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・｢髫ｲ・､隲橸ｽｺ?繝ｻ・ｽ繝ｻ・ｽ鬯･・ｴ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ髦ｮ蜷ｮ陞ｺ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ false 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶抵ｽｭ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const __diagMarks = Object.create(null);
function __diagLog(kind, data, rateMs=2000){
    if(!__diagEnabled) return;
    try{
        const now = Date.now();
        const last = __diagMarks[kind] || 0;
        if(now - last < rateMs) return;
        __diagMarks[kind] = now;
        // 鬯ｮ・｣繝ｻ・ｽ?關難ｽｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ kind='c-only-visual'
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髮朱ｯ会ｽｽ・｣鬮ｯ諛・ｽｬ雜｣・ｽ・ｸ?繝ｻ・ｽ繝ｻ・ｽ髯滂ｽ｢隲橸ｽｺ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        console.warn('[Diag]', kind, data);
    }catch(_){ /* ignore diag logging failures */ }
}
// YIN鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮｣螂・ｽｿ・ｽ?繝ｻ・ｽ f/2, f, 2f 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ3鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽiterbi鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ鬆第答?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const YIN_VIT_LAG = 3;            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ5鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ5ms鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ隲幢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const YIN_VIT_MAX = 64;           // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・守｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ髯ゑｽｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ隴ｴ・ｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ髣・ｽｽ髢・ｳ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ
let yinVitFrames = [];
// 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謳ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髣厄ｽｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ驕倥・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・｢髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const PITCH_TIME_OFFSET_SEC = 0.085; // 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｨ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?隲ｷ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function getPitchVisOffsetSec(){
    // 鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｺ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?隲ｷ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｮ鬮ｷ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ荵晢ｽ・繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const extra = btLatencyEnabled? Math.min(0.15, (btLatencySec||0)*0.6) : 0;
    return PITCH_TIME_OFFSET_SEC + extra;
}
// 鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ霑｢證ｦ・ｽ・ｲ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬩墓得・ｽ・ｩ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ髮｣・ｿ・ｽ?繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let _forceGlobalSearch=0;
// 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let showNoteNames=true;
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｩ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ,D,...鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let scorePitchClassOverlay=true; // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛沺・｡・ｶ鬮ｫ・ｰ雎慕霜・ｪ・ｿ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽN鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let scoreSessionId = 0;
let scoreStats = null; // { bins:[{count,sum,sumAbs,inTol,outTol,sharp,flat}], total }
let _pauseAdviceTimer = null; // 鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｩ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let scoreDetailByOct = {}; // { [octaveString]: { [pc]: {in:0,out:0,count:0} } }
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let isCalibrating=false; let _calibRAF=0; let calibPrevPos=0; let calibBasePos=0; let calibMoveStartPerf=0; let calibCountdownText=null; let _calibAbort=false;
// 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let isAssistMode=false; let _assistRAF=0; let _assistAbort=false;

function isAssistActive(){ return !!isAssistMode; }
let calibAnchorActive=false; let calibAnchorTime=0; let calibAnchorMidi=60;

// MIDI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊ゑｽｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｮ鬮ｷ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let midiGhostNotes = null; // [{midi,time,duration,role?}] | null
// 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ・ｩ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ鬯･・ｴ髴趣ｽｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陷闍難ｽｷ譎｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ(鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
// [{midi,time,duration}] 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ隴ｴ・ｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽelody 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let practiceExpectedNotes = null;
let scheduledUntil=0; const SCHEDULE_AHEAD=0.6; // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const MAX_DYNAMIC_LOOKAHEAD=30; // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｷ楪?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let tempoSegments=[]; // 鬯ｯ・ｩ隶主･・ｽｽ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let activeVoices=[]; const MAX_POLYPHONY=48; let noiseBuffer=null; function getNoiseBuffer(){ if(noiseBuffer) return noiseBuffer; if(!audioCtx) return null; const len=Math.floor(audioCtx.sampleRate*0.03); const buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/len,2); } noiseBuffer=buf; return noiseBuffer; }
let scheduledCounter=0;
let useSamplePiano=true; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const PIANO_SAMPLE_MIDIS=[36,40,43,48,52,55,60,64,67,72,76,79];
const pianoSampleBuffers={}; let pianoSamplesLoading=false,pianoSamplesLoaded=false;
// 鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｽ陋ｾ鬆ｼ隶捺慣・ｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const RECENT_STARTS=[]; const POLY_WINDOW=0.025; // 25ms 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
async function loadPianoSamples(){
    // file:// 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陋ｹ竏ｵ貍・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ fetch 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽCORS 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ驕ｯ・ｶ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    if(location.protocol==='file:'){
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ陞｢・ｼ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ ZIP/鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?繝ｻ・ｽ繝ｻ・ｽ隴取ｦｻ遒托ｽｭ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ陟主･・ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        console.warn('file:// 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ郢晢ｽｻ fetch 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ (ZIP / 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?繝ｻ・ｽ繝ｻ・ｽ隴取ｦｻ遒托ｽｭ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)');
        return; // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ(ZIP鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶夲ｽｨ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ)
    }
    if(pianoSamplesLoaded||pianoSamplesLoading||!useSamplePiano) return;
    if(!audioCtx) ensureAudio();
    pianoSamplesLoading=true;
    const root='assets/piano/';
    let errorOnce=false;
    const tasks=PIANO_SAMPLE_MIDIS.map(m=>fetch(root+`m${m}.mp3`).then(r=>{ if(!r.ok) throw 'missing sample '+m; return r.arrayBuffer(); }).then(ab=>new Promise((res,rej)=> audioCtx.decodeAudioData(ab,b=>res({m,b}),e=>rej(e)))).catch(e=>{ if(!errorOnce){ console.warn('sample load error (鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ) ->',e); errorOnce=true; } return null; }));
    const results=await Promise.all(tasks);
    results.forEach(o=>{ if(o) pianoSampleBuffers[o.m]=o.b; });
    const have=Object.keys(pianoSampleBuffers).length;
    pianoSamplesLoaded=have>0; pianoSamplesLoading=false;
    if(!pianoSamplesLoaded){
        console.warn('鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?髯ｷ閧ｴ・ｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｺ髣費ｽｨ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ);
        useSamplePiano=false;
    } else {
        console.log('Piano samples loaded',have,'/'+PIANO_SAMPLE_MIDIS.length);
    }
}
function nearestSampleMidi(m){ let best=PIANO_SAMPLE_MIDIS[0],bd=999; for(const s of PIANO_SAMPLE_MIDIS){ if(!pianoSampleBuffers[s]) continue; const d=Math.abs(s-m); if(d<bd){ bd=d; best=s; } } return best; }
let activeSampleVoices=[]; function cleanupSampleVoices(now){ activeSampleVoices=activeSampleVoices.filter(v=>{ if(v.end<=now){ try{ v.g.disconnect(); }catch(_){ } return false;} return true; }); }
function sampleVoiceStealIfNeeded(){ const limit=Math.max(24, Math.min(64, MAX_POLYPHONY)); if(activeSampleVoices.length<limit) return; activeSampleVoices.sort((a,b)=>a.end-b.end); const v=activeSampleVoices.shift(); try{ if(v && v.g && v.g.gain){ v.g.gain.setTargetAtTime(0, audioCtx.currentTime, 0.02);} }catch(_){ } }
function createSamplePianoVoice(midi,when,dur,outGain){ if(!pianoSamplesLoaded) return false; const base=nearestSampleMidi(midi); const buf=pianoSampleBuffers[base]; if(!buf) return false; cleanupSampleVoices(audioCtx.currentTime); if(activeSampleVoices.length>MAX_POLYPHONY){ activeSampleVoices.sort((a,b)=>a.end-b.end); const v=activeSampleVoices.shift(); try{ v.g.gain.setTargetAtTime(0,audioCtx.currentTime,0.02);}catch(_){ } }
    const src=audioCtx.createBufferSource(); src.buffer=buf; const rate=Math.pow(2,(midi-base)/12); src.playbackRate.setValueAtTime(rate,when);
    const g=audioCtx.createGain(); g.gain.setValueAtTime(0.0001,when); g.gain.exponentialRampToValueAtTime(0.85,when+0.01);
    const raw=buf.duration/rate; const nd=Math.min(dur,10); const playDur=Math.min(raw, nd+0.3); const fadeStart=when+Math.min(nd, raw*0.85); g.gain.setTargetAtTime(0,fadeStart,0.25);
    src.connect(g); g.connect(outGain); src.start(when); src.stop(when+playDur+0.05); activeSampleVoices.push({end:when+playDur+0.4,g}); return true; }
let usePianoSynth=true; // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隰ｨ魑ｴﾂ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ?: false 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ sine 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
function isIOS(){
    try{
        return /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);
    }catch(_){ return false; }
}
// LRU鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ陞｢・ｼ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const SAMPLE_USE_STATS={};
let lastLruCheck=0; // performance.now()
const LRU_CHECK_INTERVAL=5000; // ms
const MAX_DECODED_SAMPLES_SOFT=180; // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ螳育櫨繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ陞溷頃邨｡郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ
// ---- DOM ----
const $=id=>document.getElementById(id);
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: MIDI/MusicXML 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴取得・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
// const fileInput=$('fileInput'),fileSelectBtn=$('fileSelectBtn'),fileNameLabel=$('fileNameLabel');
const chartCanvas=$('chartCanvas');const ctx=chartCanvas?chartCanvas.getContext('2d'):null;
const playBtn=$('playButton'),pauseBtn=$('pauseButton'),stopBtn=$('stopButton');
const rw5=$('rewind5'),rw10=$('rewind10'),fw5=$('forward5'),fw10=$('forward10');
const tolSlider=$('toleranceSlider'),tolVal=$('toleranceValue');
const gateSlider=$('gateSlider'),gateVal=$('gateValue');
const rateSlider=$('rateSlider'),rateVal=$('rateValue');
const labelSel=$('labelNotationSelect');
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const micRenderModeSel=document.getElementById('micRenderModeSelect');
const vZoom=$('verticalZoomSlider'),timeScale=$('timeScaleSlider'),timeScaleVal=$('timeScaleValue');
const vOffsetSliderRight=$('verticalOffsetSliderRight');
    if(vOffsetSliderRight){
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ謇假ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬮ｮ・ｷ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髣比ｼ夲ｽｽ・｣?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬯滂ｽｴ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        vOffsetSliderRight.addEventListener('pointerdown',(e)=>{ isAdjustingVOffset=true; e.stopPropagation(); }, {capture:true});
        vOffsetSliderRight.addEventListener('pointermove',(e)=>{ if(!isAdjustingVOffset) return; e.stopPropagation(); }, {capture:true});
        vOffsetSliderRight.addEventListener('pointerup',(e)=>{ isAdjustingVOffset=false; e.stopPropagation(); }, {capture:true});
        vOffsetSliderRight.addEventListener('pointercancel',(e)=>{ isAdjustingVOffset=false; e.stopPropagation(); }, {capture:true});
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ CSS 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ touch-action 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬯滂ｽｴ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        vOffsetSliderRight.addEventListener('touchstart',(e)=>{ isAdjustingVOffset=true; e.stopPropagation(); }, {capture:true, passive:false});
        vOffsetSliderRight.addEventListener('touchmove',(e)=>{ if(!isAdjustingVOffset) return; e.stopPropagation(); }, {capture:true, passive:false});
        vOffsetSliderRight.addEventListener('touchend',(e)=>{ isAdjustingVOffset=false; e.stopPropagation(); }, {capture:true});
        vOffsetSliderRight.addEventListener('touchcancel',(e)=>{ isAdjustingVOffset=false; e.stopPropagation(); }, {capture:true});
        // 鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const applyVOffset = ()=>{ verticalOffset=parseInt(vOffsetSliderRight.value); syncVerticalOffsetSliders(); drawChart(); };
        vOffsetSliderRight.addEventListener('input', applyVOffset);
        vOffsetSliderRight.addEventListener('change', applyVOffset);
    }
const editToolbar=document.getElementById('editToolbar');
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ UI
const sessionSaveBtn=document.getElementById('sessionSaveBtn');
const sessionLoadBtn=document.getElementById('sessionLoadBtn');
const sessionLoadInput=document.getElementById('sessionLoadInput');
// 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髣厄ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const melodyPlayToggle=document.getElementById('melodyPlayToggle'); // 鬯ｮ・｣郢晢ｽｻ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ髯ｷ闌ｨ・ｽ・ｱ: HTML鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢ｧ蜿･・ｯ讓抵ｽｹ・ｧ郢晢ｽｻ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ

// ========================
// 鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ螳育櫨隲｢蟷・建郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｧ・ｭ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
// ========================
(function(){
    async function getLastModifiedFrom(url){
        // file:// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ CORS/鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽfetch 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{
            const proto = (location && location.protocol || '').toLowerCase();
            if(proto !== 'http:' && proto !== 'https:'){
                return null; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            }
        }catch(_){ /* location鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ*/ }
        try{
            // 1) HEAD 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ Last-Modified 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷供・ｮ・｣髴趣ｽｧ繝ｻ・ｽ?霓｣菫ｶﾎ・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const headRes = await fetch(url, { method:'HEAD', cache:'no-store' });
            const lm = headRes.headers.get('last-modified');
            if(lm){ return new Date(lm); }
        }catch(_){/* 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ */}
        try{
            // 2) GET 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｸ蜿ｯﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽo-store鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｺ蛟ｪ陞ｺ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const res = await fetch(url, { cache:'no-store' });
            const lm = res.headers.get('last-modified');
            if(lm){ return new Date(lm); }
        }catch(_){/* 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ */}
        return null;
    }

    function formatYYMMDDHHMM(d){
        if(!d) return '';
        const yy = String(d.getFullYear()).slice(-2);
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        return `${yy}${mm}${dd}${hh}${mi}`;
    }

    function ensureToastEl(){
        let el = document.getElementById('buildToast');
        if(!el){
            el = document.createElement('div');
            el.id = 'buildToast';
            el.setAttribute('aria-live','polite');
            el.style.position='fixed'; el.style.top='8px'; el.style.right='8px';
            el.style.background='rgba(0,0,0,0.75)'; el.style.color='#e6eaf2';
            el.style.border='1px solid #2b3244'; el.style.padding='6px 10px';
            el.style.borderRadius='8px'; el.style.fontFamily="ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace";
            el.style.fontSize='12px'; el.style.zIndex='3000'; el.style.display='none';
            el.style.pointerEvents='none';
            document.body.appendChild(el);
        }
        return el;
    }

    function showToast(text, durationMs=2000){
        const el = ensureToastEl();
        el.textContent = text;
        el.style.display = 'block';
        el.style.opacity = '1';
        el.style.transition = 'opacity 0.35s ease';
        // 鬯ｮ・ｯ郢晢ｽｻ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髮主叙・ｨ謚ｵ・ｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ､郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜款?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        el.style.top = '8px'; el.style.right = '8px';
        window.setTimeout(()=>{
            try{
                el.style.opacity = '0';
                const onEnd = ()=>{ el.style.display='none'; el.removeEventListener('transitionend', onEnd); };
                el.addEventListener('transitionend', onEnd);
            }catch(_){ el.style.display='none'; }
        }, Math.max(800, durationMs|0));
    }

    async function showBuildStamp(){
        try{
            // app.js 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ邵ｺ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ隶捺慣・ｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髮取腸・ｽ・ｺ鬮ｮ蜿冶・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｩ雋・ｽｽ?繝ｻ・ｽ繝ｻ・ｽ陞滂ｽｧ陋ｻ譎｢・ｿ・ｽ?繝ｻ・ｽ邵ｺ・､・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陷ｿ・ｯ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            let dt = await getLastModifiedFrom('app.js');
            if(!dt){
                // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: styles.css
                dt = await getLastModifiedFrom('styles.css');
            }
            if(!dt){
                // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: document.lastModified鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ隰撰ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ, 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｯ蜈ｷ・ｽ・ｹ驕ｶ謫ｾ・ｽ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                try{ dt = new Date(document.lastModified); }catch(_){ dt = new Date(); }
            }
            const stamp = formatYYMMDDHHMM(dt);
            if(stamp){ showToast(stamp, 2000); }
        }catch(e){
            // 鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ蜀郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ驕倥・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            try{ console.warn('build stamp toast failed:', e); }catch(_){ }
        }
    }

    if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded', showBuildStamp, { once:true });
    }else{
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謳ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬮ｮﾂ髯具ｽｻ隴取ｧｫ讀城辧謇假ｽｽ・ｱ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        showBuildStamp();
    }
})();

// ========================
// 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ隴会ｽｮ・守｢托ｽｭ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ .help-text 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ i 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// ========================
(function(){
    function createTipBubble(){
        let tip = document.getElementById('globalTooltipBubble');
        if(!tip){
            tip = document.createElement('div');
            tip.id = 'globalTooltipBubble';
            tip.className = 'tooltip-bubble';
            tip.style.display = 'none';
            document.body.appendChild(tip);
        }
        return tip;
    }
    function showTip(targetEl, text){
        const tip = createTipBubble();
        tip.textContent = text || '';
        if(!text){ tip.style.display='none'; return; }
        const rect = targetEl.getBoundingClientRect();
        const top = rect.top + window.scrollY - 8; // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螟ｲ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const left = rect.left + window.scrollX + rect.width + 8; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        tip.style.top = top + 'px';
        tip.style.left = left + 'px';
        tip.style.display = 'block';
        // 鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽreflow鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ繝ｻ・ｿ・ｽ?繝ｻ・ｽ
        void tip.offsetHeight; tip.classList.add('show');
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髦｡鬥ｴ・ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        clearTimeout(showTip._to);
        showTip._to = setTimeout(()=>{ hideTip(); }, 3000);
    }
    function hideTip(){
        const tip = document.getElementById('globalTooltipBubble');
        if(!tip) return;
        tip.classList.remove('show');
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｻ髮｣・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ?髯ｷ閧ｴ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        setTimeout(()=>{ if(tip && !tip.classList.contains('show')) tip.style.display='none'; }, 150);
    }
    function attachInfoIcon(labelEl, helpText){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'info-tip';
        btn.textContent = 'i';
        btn.setAttribute('aria-label','鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ);
        btn.addEventListener('mouseenter', ()=> showTip(btn, helpText));
        btn.addEventListener('focus', ()=> showTip(btn, helpText));
        btn.addEventListener('mouseleave', hideTip);
        btn.addEventListener('blur', hideTip);
        btn.addEventListener('click', (e)=>{ e.stopPropagation(); showTip(btn, helpText); }); // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ3鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        labelEl.appendChild(btn);
    }
    function initTooltips(){
        try{
            const groups = document.querySelectorAll('#controls .control-group');
            groups.forEach(g=>{
                const help = g.querySelector('.help-text');
                if(!help) return;
                const text = help.textContent.trim();
                if(!text) return;
                // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ邏具ｽｺ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｺ・ｷ驗ゑｽｰ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣陜難ｽｼ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                let labelEl = g.querySelector('label');
                if(!labelEl){
                    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ蟶ｷ讓・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    labelEl = document.createElement('label');
                    labelEl.textContent = '鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
                    g.insertBefore(labelEl, g.firstChild);
                }
                attachInfoIcon(labelEl, text);
            });
            // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ譴ｧ・ｺ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ隴会ｽｮ・守｢托ｽｭ蜿厄ｽｨ髮∬｢夜ｫｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            document.addEventListener('touchstart', (e)=>{
                const tip = document.getElementById('globalTooltipBubble');
                if(!tip) return;
                if(e.target.closest('.info-tip')) return;
                hideTip();
            }, {passive:true});
            window.addEventListener('scroll', hideTip, {passive:true});
            window.addEventListener('resize', hideTip);
        }catch(e){ console.warn('initTooltips failed', e); }
    }
    if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded', initTooltips, {once:true});
    }else{
        initTooltips();
    }
})();
const accompPlayToggle=document.getElementById('accompPlayToggle'); // 鬯ｮ・｣郢晢ｽｻ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ髯ｷ闌ｨ・ｽ・ｱ: HTML鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢ｧ蜿･・ｯ讓抵ｽｹ・ｧ郢晢ｽｻ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// Bluetooth鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽI鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・｡郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let btLatencyEnabled=false; // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽFF
let btLatencySec=0.08;      // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｼ陋ｻ譎橸ｽｬ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const engineSelect=null; // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｯ讖ｸ・ｽ・ｳ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ鍋ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・｢郢ｧ・ｪ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ
// BT鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽndex.html鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const btLatencyToggle=$('btLatencyToggle');
const btLatencySlider=$('btLatencySlider');
const btLatencyValue=$('btLatencyValue');
const btLatencyCalibBtn=$('btLatencyCalibBtn');
const btCalibStatus=$('btCalibStatus');
const guideVol=$('guideVolumeSlider'),accompVol=$('accompVolumeSlider');
const guideLineWidthSlider=$('guideLineWidthSlider');
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隴幢ｽｱ?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const timelineScroll = document.getElementById('timelineScroll');
// --- 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ? 70% 鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ (鬯ｮ・｣騾ｧ・ｮ騾包ｽ･髯懶ｽｪ?繝ｻ・ｽ繝ｻ・ｽI鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ ---
function enforceTimelineHeight(){
    try{
        const cc=document.getElementById('chartContainer');
        if(!cc) return;
        const vh = window.innerHeight || document.documentElement.clientHeight || 0;
        if(!vh) return;
        const target=Math.round(vh*0.70);
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螢ｺ謇ｱ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const curH = cc.getBoundingClientRect().height||0;
        if(Math.abs(curH-target)>4){
            cc.style.height=cc.style.maxHeight=cc.style.minHeight=target+'px';
        }
    }catch(_){ }
}
window.addEventListener('resize', ()=>enforceTimelineHeight());
window.addEventListener('orientationchange', ()=>setTimeout(enforceTimelineHeight,180));
setTimeout(enforceTimelineHeight,120);
const guideToggle=$('guideToggle'),accompToggle=$('accompToggle');
const pedalToggle=null; // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ蜿厄ｽｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢髢ｧ蛟ｬ・ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const trackToggle=null,trackPanel=null;
const melodySel=null,accompSel=null,trackApply=null;
const trackInstrumentGrid=null;
const micBtn=$('micPermissionBtn');
const micDisconnectBtn=$('micDisconnectBtn');
const pitchOnlyModeBtn=$('pitchOnlyModeBtn');
const markerCfg={A:['markerA_set','markerA_play'],B:['markerB_set','markerB_play'],C:['markerC_set','markerC_play'],D:['markerD_set','markerD_play'],E:['markerE_set','markerE_play'],F:['markerF_set','markerF_play'],G:['markerG_set','markerG_play']};
// 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const showNoteNamesToggle=$('showNoteNamesToggle');
const micLevelBar=$('micLevelBar'),micDbText=$('micDbText');
const micGateLine=$('micGateLine');
const resonanceMixSlider=$('resonanceMixSlider');
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI
const adviceBtn=$('adviceBtn');
// 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲ｷ諷墓ｫｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・ｽｶ諞ｺ・・ｫｭ・ｩ
const practiceModeOn=$('practiceModeOn');
const practiceModeOff=$('practiceModeOff');
const practicePatternSelect=$('practicePatternSelect');
const practicePauseBtn=$('practicePauseBtn');
const practiceStopBtn=$('practiceStopBtn');
const practiceStartBtn=$('practiceStartBtn');
const practiceRangeWrap=$('practiceRangeWrap');
const practiceRootSel=$('practiceRootSel');
const practiceKeyModeSel=$('practiceKeyMode');
const practiceSeventhChk=$('practiceSeventh');
const practiceFromSel=$('practiceFromSel');
const practiceToSel=$('practiceToSel');
const practiceBpmEl=$('practiceBpm');
const practiceVolWrap=$('practiceVolWrap');
const practiceCallVolEl=$('practiceCallVol');
const practiceChordOptsWrap=$('practiceChordOptsWrap');
const practiceSixthChk=$('practiceSixth');
const practiceToolbar=document.getElementById('practiceToolbar');
const practiceCloseBtn=document.getElementById('practiceCloseBtn');
// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｱ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟶壽升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隲・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｼ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬮ｫ・ｰ隴ｴ・ｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const practiceTopGroup = practiceModeOn ? practiceModeOn.parentElement : null;
// --- 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・､鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ---
try{
    if(melodyPartSelect){ melodyPartSelect.value=String(currentMelodyPart); melodyPartSelect.addEventListener('change',()=>{
        const v = parseInt(melodyPartSelect.value)||0; currentMelodyPart = Math.max(0, Math.min(3, v));
        const p = melodyParts[currentMelodyPart]||{};
        if(partNotesToggle) partNotesToggle.checked = !!p.showNotes;
        if(partPlaybackToggle) partPlaybackToggle.checked = !!p.playAudio;
        currentTracks = [{name:`Melody P${currentMelodyPart+1}`, notes: (p.notes||[])}]; melodyTrackIndex = 0; melodyNotesExtracted = true;
        autoCenterFrozen=false; autoCenterMelodyTrack(); drawChart();
    }); }
    if(partNotesToggle){ partNotesToggle.checked = !!(melodyParts[currentMelodyPart]?.showNotes); partNotesToggle.addEventListener('change',()=>{ const p=melodyParts[currentMelodyPart]; if(p) p.showNotes=!!partNotesToggle.checked; drawChart(); }); }
    if(partPlaybackToggle){ partPlaybackToggle.checked = !!(melodyParts[currentMelodyPart]?.playAudio); partPlaybackToggle.addEventListener('change',()=>{ const p=melodyParts[currentMelodyPart]; if(p) p.playAudio=!!partPlaybackToggle.checked; }); }
}catch(_){ }
// ---- 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲ｷ諷墓ｫｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽstate ----
// 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯句ｹ｢・ｽ・ｽI鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ螳育櫨隲｢蟷・建郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/7th/6th鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
try{
    if(practicePatternSelect){
        practicePatternSelect.addEventListener('change', ()=>{
            const v = practicePatternSelect.value;
            const show = (v==='chordPractice' || v==='chordPracticeRandOrder');
            if(practiceChordOptsWrap){ practiceChordOptsWrap.style.display = show? 'inline-flex': 'none'; }
        });
        // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ?
        (function(){ const v=practicePatternSelect.value; const show=(v==='chordPractice' || v==='chordPracticeRandOrder'); if(practiceChordOptsWrap) practiceChordOptsWrap.style.display = show? 'inline-flex':'none'; })();
    }
}catch(_){ }

// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
try{
    if(micBtn){
        micBtn.addEventListener('click', async ()=>{
            try{ activateAudioOnce(); }catch(_){ }
            if(IS_MOBILE){
                try{ _micDevicesCache = await enumerateMicInputs(); }catch(_){ }
                openMicPicker();
            } else {
                // PC鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                _userExplicitMicInit=true;
                await initMic(true);
            }
        });
    }
    if(micDisconnectBtn){ micDisconnectBtn.addEventListener('click', ()=>{ try{ stopMic(); }catch(_){ } }); }
    if(pitchOnlyModeBtn){
        pitchOnlyModeBtn.addEventListener('click', async ()=>{
            try{ activateAudioOnce(); }catch(_){ }
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・＠?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: ON鬯ｩ蛹・ｽｽ・ｶ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽFF鬯ｩ蛹・ｽｽ・ｶ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽN ...
            isPitchOnlyMode = !isPitchOnlyMode;
            // UI鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ?
            try{
                pitchOnlyModeBtn.classList.toggle('active', isPitchOnlyMode);
                pitchOnlyModeBtn.title = isPitchOnlyMode? '鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｺ・ｽ陜ｮ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ : '鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ陷托ｽｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ怜℡鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
            }catch(_){ }
            // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・､隲幢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            try{ if(editToolbar){ editToolbar.classList.add('hidden'); editToolbar.style.display='none'; } }catch(_){ }
            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｺ・ｽ陜ｮ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｩ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・ｽｶ諞ｺ・・ｫｭ・ｩ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣雋ｻ・ｽ・ｨ髫ｲ蟷｢・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ郢晢ｽｻ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?: ON鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ髯ｳﾂ髯橸ｽｳ陞｢・ｽ・つ陷ｻ・ｵ隰泌・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽFF鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ隰ｨ・ｴ鬯ｩ貊ゑｽｽ・ｪ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            if(isPitchOnlyMode){
                // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ緑・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                try{ if(!micAnalyser || !micData){ const ok=await canInitMicWithoutPrompt(); if(ok){ await initMic(false).catch(()=>{}); } } }catch(_){ }
                if(!isPlaying){ startPlayback(); }
            } else {
                // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ鍋ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陝ｶ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ髯ｳﾂ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                if(isPlaying){ pausePlayback(); }
                drawChart();
            }
        });
    }
}catch(_){ }
let practiceMode='off'; // 'off' | 'basic'
let isPracticing=false;
// 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲ｷ諷墓ｫｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・・?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽcall)鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ陞溘ｑ・ｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ鬮ｯ讖ｸ・ｽ・ｺ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let practiceCallDisplayOctShift = 0; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ・つ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驍ｵ・ｺ陷・ｶ?繝ｻ・ｽ繝ｻ・ｽ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let practiceRAF=0;
let practiceStartPerf=0;
let practiceBaseSongTime=0;
let practiceTempoBpm=80;
let practiceLoopTimer=null;
let practicePaused=false;
let practicePauseAt=0; // song time when paused
let practiceCallGain=null; // dedicated gain for call playback
let practiceScheduledNotes=[]; // {when, stopAt, src?, gain?}
let practicePlan=[]; // [{idx,midi,timeSong,duration,role}]
let practiceEndSongTime=0; // absolute song time of practice end
let practiceBaseAudioTime=0; // AudioContext.currentTime corresponding to practiceBaseSongTime
let practiceCallSchedTimer=null; // interval id for rolling scheduler
const PRACTICE_SCHED_AHEAD=0.6; // seconds ahead to schedule call notes
let practiceScheduledSet=new Set(); // keys of scheduled plan items (idx)
let practiceMutedUntil=0; // audio time until which call gain is held at 0 (for pause masking)

// =============================
// UI: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// - 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・＠?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// - 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
// =============================
(function initAutoFitButtons(){
    try{
    const vw = Math.max(320, Math.min(1200, (window.innerWidth||360)));
    const MIN_PX = vw <= 360 ? 7 : 8; // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ7px鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const MAX_ITER = 9; // 鬯ｮ・｣郢晢ｽｻ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ闔ｨ諛ｶ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｵ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ繝ｻ・ｽ?髴・ｽｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛛・ｽｿ・ｽ?繝ｻ・ｽ?
    const FIT_SELECTOR = 'button:not([data-no-autofit="true"])';
        const buttons = Array.from(document.querySelectorAll(FIT_SELECTOR));

        // 1. 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣騾ｧ・ｮ騾包ｽ･?繝ｻ・ｽ繝ｻ・ｽ・つ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        for(const btn of buttons){
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・｡郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            btn.style.overflow = btn.style.overflow || 'hidden';
            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ陋滉ｻｰﾂ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽｳ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ? nowrap 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            if(!btn.style.whiteSpace) btn.style.whiteSpace = 'nowrap';
            if(!btn.style.textOverflow) btn.style.textOverflow = 'ellipsis';
            if(!btn.style.alignItems) btn.style.alignItems = 'center';
            if(!btn.style.justifyContent) btn.style.justifyContent = 'center';
            if(!btn.style.display){
                // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ驍雁ｬ・ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ inline-flex 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ鬮ｦ・ｪ?繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・ｨ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓幢ｾつ闔会ｽｰ・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                btn.style.display = 'inline-flex';
            }
            ensureInnerWrapper(btn);
        }

        function fits(btn, inner){
            // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽmax-content)鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜍滉ｺ芽ｱ主､ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const EPS = 0.5;
            const cs = getComputedStyle(btn);
            const padX = parseFloat(cs.paddingLeft||0) + parseFloat(cs.paddingRight||0) + parseFloat(cs.borderLeftWidth||0) + parseFloat(cs.borderRightWidth||0);
            const padY = parseFloat(cs.paddingTop||0) + parseFloat(cs.paddingBottom||0) + parseFloat(cs.borderTopWidth||0) + parseFloat(cs.borderBottomWidth||0);
            const availW = Math.max(1, btn.clientWidth - padX);
            const availH = Math.max(1, btn.clientHeight - padY);
            // max-content 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ郢晢ｽｻ髯ｷ閧ｴ・ｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
            const prevWidth = inner.style.width;
            inner.style.width = 'max-content';
            const needW = inner.scrollWidth;
            const needH = inner.scrollHeight;
            inner.style.width = prevWidth || '';
            return (needW <= availW + EPS) && (needH <= availH + EPS);
        }

        function ensureInnerWrapper(btn){
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬯滂ｽｴ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ驍雁ｬ・ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣郢晢ｽｻ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ髯ｷ闌ｨ・ｽ・ｱ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(btn.__afInner) return btn.__afInner;
            const inner = document.createElement('span');
            inner.className = '__af-inner';
            inner.style.display = 'inline-flex';
            inner.style.alignItems = 'center';
            inner.style.gap = '6px';
            inner.style.whiteSpace = 'nowrap';
            inner.style.lineHeight = 'inherit';
            inner.style.transformOrigin = 'center center';
            inner.style.willChange = 'transform';
            inner.style.width = '100%';
            inner.style.maxWidth = '100%';
            inner.style.overflow = 'visible';
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ雋牙私・｣・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陷闍難ｽｷ譎｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            while(btn.firstChild){ inner.appendChild(btn.firstChild); }
            btn.appendChild(inner);
            btn.__afInner = inner;
            return inner;
        }

        function fitOne(btn){
            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽisplay:none 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ髫ｨ・ｳ驕擾ｽｩ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const cs = getComputedStyle(btn);
            if(cs.display === 'none' || btn.clientWidth === 0 || btn.clientHeight === 0){
                return; // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?髴・ｽｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽResize鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            }
            const inner = ensureInnerWrapper(btn);
            // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・＠?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ隨翫ｋ・ｬ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const basePx = parseFloat(cs.fontSize) || 12;
            // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟・ｽｼ諛ｶ・ｽ・ｴ隰悟･・ｽｽ・ｭ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ隰撰ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ譴ｧ繩･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛・ｽｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const maxPx = Math.min(basePx, 14);
            let low = MIN_PX, high = Math.max(MIN_PX, Math.min(64, maxPx));

            // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            btn.style.fontSize = high + 'px';
            inner.style.transform = 'scale(1)'; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(fits(btn, inner)) return;

            // 鬯ｮ・｣郢晢ｽｻ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ鬩榊･・ｽｿ・ｽ?邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            let best = MIN_PX;
            for(let i=0;i<MAX_ITER;i++){
                const mid = Math.floor((low + high) / 2);
                btn.style.fontSize = mid + 'px';
                if(fits(btn, inner)){
                    best = mid;
                    low = mid + 1; // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                } else {
                    high = mid - 1; // 鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                }
            }
            btn.style.fontSize = Math.max(MIN_PX, Math.min(best, maxPx)) + 'px';

            // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ闖ｴ・ｩ鬩､・ｴ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?髫ｶ魃会ｽｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陋ｹ竏ｵ貍・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯懶ｽ｣闔会ｽｰ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・｢髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const padX = parseFloat(cs.paddingLeft||0) + parseFloat(cs.paddingRight||0) + parseFloat(cs.borderLeftWidth||0) + parseFloat(cs.borderRightWidth||0);
            const padY = parseFloat(cs.paddingTop||0) + parseFloat(cs.paddingBottom||0) + parseFloat(cs.borderTopWidth||0) + parseFloat(cs.borderBottomWidth||0);
            // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            inner.style.transform = 'scale(1)';
            inner.style.width = 'max-content';
            const availW = Math.max(1, btn.clientWidth - padX);
            const availH = Math.max(1, btn.clientHeight - padY);
            const needW = inner.scrollWidth;
            const needH = inner.scrollHeight;
            const scale = Math.min(1, availW / needW, availH / needH);
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ郢晢ｽｻ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ scale 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
            const inTopBar = btn.closest('#top-bar') != null;
            if(!inTopBar && scale < 1){
                // 鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ證ｦ・ｿ・ｽ?繝ｻ・ｽ髣懊・繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｺ・ｷ驗ゑｽｰ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ郢晢ｽｻ
                inner.style.width = '100%';
                inner.style.transformOrigin = 'left center';
                inner.style.transform = `scale(${Math.max(0.6, scale)})`;
            } else {
                inner.style.width = '100%';
                inner.style.transform = 'scale(1)';
            }
        }

        // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髫伜､懶ｽｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        function fitAll(){
            for(const btn of buttons){
                fitOne(btn);
            }
        }
        fitAll();

        // 2. 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ隴・ｽ｡鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let resizeTimer = 0;
        window.addEventListener('resize', ()=>{
            if(resizeTimer) cancelAnimationFrame(resizeTimer);
            resizeTimer = requestAnimationFrame(()=>{
                fitAll();
                resizeTimer = 0;
            });
        }, { passive: true });

        // 3. 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｺ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬮ｮﾂ繝ｻ・ｽ?郢晢ｽｻ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋顔§謫髯橸ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // ResizeObserver: 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ郢晢ｽｻ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽF鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let roPending=false; const roQueue=new Set();
        const ro = new ResizeObserver(entries => {
            for(const entry of entries){
                const btn = entry.target;
                roQueue.add(btn);
            }
            if(!roPending){
                roPending=true;
                requestAnimationFrame(()=>{
                    try{ roQueue.forEach(el=>fitOne(el)); }finally{ roQueue.clear(); roPending=false; }
                });
            }
        });
    for(const btn of buttons){ ro.observe(btn); }

        // 4. 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢髯滂ｽ｢?繝ｻ・ｽ繝ｻ・ｽM鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髦ｮ蜊搾ｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const mo = new MutationObserver(mutations => {
            let need = false;
            for(const m of mutations){
                if(m.type === 'characterData' || m.type === 'childList'){
                    need = true; break;
                }
            }
            if(need){ requestAnimationFrame(fitAll); }
        });
        for(const btn of buttons){
            mo.observe(btn, { subtree: true, characterData: true, childList: true });
        }

        // 5. 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ騾ｹ・｣・つ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髮朱ｯ会ｽｽ・｣鬮ｯ諛・ｽｬ雜｣・ｽ・ｸ?繝ｻ・ｽ繝ｻ・ｽ髯滂ｽ｢隲橸ｽｺ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const addMo = new MutationObserver(muts => {
            let added = [];
            for(const m of muts){
                m.addedNodes && m.addedNodes.forEach(node=>{
                    if(node.nodeType !== 1) return; // ELEMENT_NODE鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    if(node.matches && node.matches(FIT_SELECTOR)){
                        added.push(node);
                    }
                    // 鬯ｮ・ｯ郢晢ｽｻ鬮｣逧ｮ逕･鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    const found = node.querySelectorAll ? node.querySelectorAll(FIT_SELECTOR) : [];
                    if(found && found.length){ added.push(...found); }
                });
            }
            if(added.length){
                for(const btn of added){
                    // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    btn.style.overflow = btn.style.overflow || 'hidden';
                    if(!btn.style.whiteSpace) btn.style.whiteSpace = 'nowrap';
                    if(!btn.style.alignItems) btn.style.alignItems = 'center';
                    if(!btn.style.justifyContent) btn.style.justifyContent = 'center';
                    if(!btn.style.display) btn.style.display = 'inline-flex';
                    ensureInnerWrapper(btn);
                    ro.observe(btn);
                    mo.observe(btn, { subtree: true, characterData: true, childList: true });
                    fitOne(btn);
                }
            }
        });
        addMo.observe(document.body, { childList: true, subtree: true });
    }catch(e){ console.warn('AutoFitButtons init error', e); }
})();

// =============================
// UI: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ髦ｮ蜊搾ｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ/鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｺ・ｷ驗ゑｽｰ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// - 鬯ｮ・ｯ郢晢ｽｻ鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ summary 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽlabel 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｻ・ｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ1 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢髫ｲ・｢?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// =============================
(function initAutoFitText(){
    try{
        // 鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陞溽浹遒托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｺ・ｷ驗ゑｽｰ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ
        const FIT_TEXT_SELECTOR = [
            '#top-bar label .txt',
            '#transportBar .transport-right > div > span',
            '#controls .controls-section > summary',
            '#controls .control-group > label'
        ].join(',');

        const MIN_PX_BASE = 9; // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｹ陞溯ｲｫﾂ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const vw = Math.max(320, Math.min(1200, (window.innerWidth||360)));
        const MIN_PX = vw <= 360 ? 8 : MIN_PX_BASE;
        const MAX_ITER = 9;
        const els = Array.from(document.querySelectorAll(FIT_TEXT_SELECTOR));

        // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隴ｽ雋ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・｢?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        for(const el of els){
            const cs = getComputedStyle(el);
            if(cs.whiteSpace !== 'nowrap') el.style.whiteSpace = 'nowrap';
            if(cs.overflow !== 'hidden') el.style.overflow = 'hidden';
            if(cs.textOverflow !== 'ellipsis') el.style.textOverflow = 'clip';
            // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛現窶ｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ菫ｶ縺・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(cs.display === 'inline') el.style.display = 'inline-block';
            // 100% 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(!el.style.maxWidth) el.style.maxWidth = '100%';
        }

        function fits(el){
            // 1px 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ隶難ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const EPS = 0.5;
            return (el.scrollWidth <= el.clientWidth + EPS);
        }

        function fitOne(el){
            const cs = getComputedStyle(el);
            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ陷驤ｴ諠ｧ髮手ｶ｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(cs.display === 'none' || el.clientWidth === 0){ return; }
            const basePx = parseFloat(cs.fontSize) || 13;
            let low = MIN_PX, high = Math.max(MIN_PX, Math.min(64, basePx));
            // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            el.style.fontSize = high + 'px';
            if(fits(el)) return;
            let best = MIN_PX;
            for(let i=0;i<MAX_ITER;i++){
                const mid = Math.floor((low + high)/2);
                el.style.fontSize = mid + 'px';
                if(fits(el)){ best = mid; low = mid + 1; }
                else { high = mid - 1; }
            }
            el.style.fontSize = Math.max(MIN_PX, Math.min(best, high)) + 'px';
        }

        function fitAll(){ els.forEach(fitOne); }
        fitAll();

        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let resizeId=0; window.addEventListener('resize',()=>{
            if(resizeId) cancelAnimationFrame(resizeId);
            resizeId = requestAnimationFrame(()=>{ fitAll(); resizeId=0; });
        }, {passive:true});

        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const ro = new ResizeObserver(()=>{ requestAnimationFrame(fitAll); });
        els.forEach(el=>{ ro.observe(el); if(el.parentElement) ro.observe(el.parentElement); });

        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const mo = new MutationObserver(()=>{ requestAnimationFrame(fitAll); });
        els.forEach(el=> mo.observe(el, {characterData:true, childList:true, subtree:true}));

        // 鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・ｫ・つ?髯橸ｽｳ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const addMo = new MutationObserver(muts=>{
            let added=[];
            for(const m of muts){
                m.addedNodes && m.addedNodes.forEach(node=>{
                    if(node.nodeType!==1) return;
                    const q = node.matches && node.matches(FIT_TEXT_SELECTOR) ? [node] : [];
                    const found = node.querySelectorAll ? node.querySelectorAll(FIT_TEXT_SELECTOR) : [];
                    if(q.length) added.push(...q);
                    if(found && found.length) added.push(...found);
                });
            }
            if(added.length){
                for(const el of added){
                    const cs = getComputedStyle(el);
                    if(cs.whiteSpace !== 'nowrap') el.style.whiteSpace = 'nowrap';
                    if(cs.overflow !== 'hidden') el.style.overflow = 'hidden';
                    if(cs.textOverflow !== 'ellipsis') el.style.textOverflow = 'clip';
                    if(cs.display === 'inline') el.style.display = 'inline-block';
                    if(!el.style.maxWidth) el.style.maxWidth = '100%';
                    ro.observe(el); if(el.parentElement) ro.observe(el.parentElement);
                    mo.observe(el, {characterData:true, childList:true, subtree:true});
                    fitOne(el);
                }
            }
        });
        addMo.observe(document.body, {childList:true, subtree:true});
    }catch(e){ console.warn('AutoFitText init error', e); }
})();

function parseNoteNameToMidi(s){
    try{
        if(typeof s==='number') return Math.max(0,Math.min(127, s|0));
        const m=String(s||'').trim().match(/^([A-Ga-g])([#bB]?)(-?\d+)$/);
        if(!m) return 60;
        const step=m[1].toUpperCase(); const base={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[step];
        const acc=m[2]==='#'?1: (m[2]==='b'||m[2]==='B'?-1:0);
        const oct=parseInt(m[3]); return Math.max(0,Math.min(127,(oct+1)*12+base+acc));
    }catch(_){ return 60; }
}

function makePracticePattern(pattern, rootMidi, span){
    const notes=[];
    const push=(m)=>notes.push(m);
    if(pattern==='ascMajor'){
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 0,2,4,5,7,9,11,12 ... 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ蜿厄ｽｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const deg=[0,2,4,5,7,9,11,12];
        for(let i=0;i<span;i++){
            const off = deg[i%deg.length] + 12*Math.floor(i/deg.length);
            push(rootMidi + off);
        }
    } else if(pattern==='descMajor'){
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ: 12,11,9,7,5,4,2,0 ... 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ蜿厄ｽｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const deg=[12,11,9,7,5,4,2,0];
        for(let i=0;i<span;i++){
            const off = deg[i%deg.length] - 12*Math.floor(i/deg.length);
            push(rootMidi + off);
        }
    } else if(pattern==='chromaticAsc'){
        for(let i=0;i<span;i++){ push(rootMidi + i); }
    } else if(pattern==='chromaticDesc'){
        for(let i=span-1;i>=0;i--){ push(rootMidi + i); }
    } else if(pattern==='majorTriadBroken'){
        const third=4, fifth=7; [0,third,fifth].forEach(d=>push(rootMidi+d));
    } else if(pattern==='majorArpAsc'){
        // 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴擾ｽｴ?繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・ｽｶ諛・ｽｫ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽoot+12鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const base=rootMidi+12; const third=4, fifth=7, oct=12; [0,third,fifth,oct].forEach(d=>push(base+d));
    } else if(pattern==='majorArpDesc'){
        // 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴擾ｽｴ?繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・ｽｶ諛・ｽｫ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽoot+12鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const base=rootMidi+12; const third=4, fifth=7; [0,fifth,third,0].forEach(d=>push(base+d));
    } else if(pattern==='chordPractice'){
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮倶ｼ∝ｱｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・ｨ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ startBasicPractice 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴主臆・ｷ譎櫁ｾｧ陷肴ｻゑｽｽ・ｨ?繝ｻ・ｽ繝ｻ・ｽ鬯ｲ蛛・ｽｽ・ｬ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陞滂ｽｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｨ鬲托ｽｴ・つ
        return [];
    } else {
        for(let i=0;i<8;i++) push(rootMidi+i);
    }
    return notes;
}

function parseFromTo(){
    try{ const a=practiceFromSel?.value||'C5'; const b=practiceToSel?.value||'B5';
        let low = parseNoteNameToMidi(a), high = parseNoteNameToMidi(b);
        if(high<low){ const t=low; low=high; high=t; }
        return [low, high];
    }catch(_){ return [parseNoteNameToMidi('C5'), parseNoteNameToMidi('C6')]; }
}

function startBasicPractice(){
    if(isPracticing) return;
    ensureAudio();
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽcall)鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯懃軸辟碑擾ｽｯ髫ｴ謫ｾ・ｽ・ｶ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    practiceCallDisplayOctShift = 12;
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ闔ｨ諛亥℡鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｫ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隰疲ｻゑｽｽ・ｳ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        scoreSessionId++;
        scoreStats = { total:0, bins: Array.from({length:12},()=>({count:0,sum:0,sumAbs:0,inTol:0,outTol:0,sharp:0,flat:0})) };
        scoreDetailByOct = {};
    }catch(_){ scoreStats=null; scoreDetailByOct={}; }
    const bpm = Math.max(40, Math.min(200, parseInt(practiceBpmEl?.value||practiceTempoBpm)));
    practiceTempoBpm=bpm; const beatSec = 60 / bpm; const noteDur = beatSec;
    const rootMidi = parseNoteNameToMidi(practiceRootSel?.value||'C5');
    let keyMode = (practiceKeyModeSel?.value||'major'); // 'major' | 'minor' | 'random'
    const use7th = !!(practiceSeventhChk && practiceSeventhChk.checked);
    const use6th = !!(practiceSixthChk && practiceSixthChk.checked);
    const [low, high] = parseFromTo();
    const span = Math.max(3, Math.min(48, (high - low + 1)));
    const pat = (practicePatternSelect?.value)||'ascMajor';
    // 鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隰ｨ魑ｴﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ・つ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴∵ｻゑｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ闔ｨ諛ｶ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｵ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
    const targetSeconds = 60; const cycleBeats = 8; // 8鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ=2鬯ｮ・ｯ郢晢ｽｻ鬮ｯ・ｷ・つ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const cycles = Math.max(1, Math.floor(targetSeconds / (cycleBeats*beatSec*2))); // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ+鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const sequences=[]; let startDegree=0; // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬯ｯ貊ゑｽｽ・ｭ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ
    for(let c=0;c<cycles;c++){
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜿門擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(pat==='chordPractice' || pat==='chordPracticeRandOrder' || pat==='chordAllMajor' || pat==='chordAllMinor'){
            // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ隴幢ｽｱ髮趣ｽｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ郢晢ｽｻ7th/6th鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ闕ｵ證ｦ・ｽ・ｪ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陝ｶ譁溯ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const keyRootPC = (rootMidi%12+12)%12;
            const namesCDE=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
            // 鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ髮｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽC鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮倶ｼ∝ｱｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隴取得・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            function chordForDegree(deg){
                // deg: 0..6
                const scaleMaj=[0,2,4,5,7,9,11];
                const scaleMin=[0,2,3,5,7,8,10];
                const modeEff = (keyMode==='random') ? (Math.random()<0.5? 'major':'minor') : keyMode;
                const scale = modeEff==='minor'? scaleMin: scaleMaj;
                const rootPc = (keyRootPC + scale[deg]) % 12;
                let third = (modeEff==='minor' && (deg===0||deg===3||deg===4))? 3 : // i, iv, v in natural minor
                             (modeEff==='minor' && (deg===2||deg===5))? 4 :
                             (modeEff==='minor' && deg===6)? 3 :
                             // major key
                             (deg===1||deg===2||deg===5)? 3 : 4; // ii, iii, vi minor triads in major
                let fifth = 7;
                let quality = '';
                // diminished in major: vii?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ; in minor: ii?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ (natural)
                if((modeEff==='major' && deg===6) || (modeEff==='minor' && deg===1)){
                    fifth = 6; quality = 'dim';
                } else if((modeEff==='major' && (deg===1||deg===2||deg===5)) || (modeEff==='minor' && (deg===0||deg===3||deg===4||deg===6))){
                    quality = 'm';
                } else {
                    quality = '';
                }
                // seventh
                let seventh = null; let extLabel='';
                // 7th / 6th 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                if(use7th){
                    let seventhInt = (quality==='dim')? 10 : // diminished triad + m7 => m7b5 label
                                      (quality==='m')? 10 : // minor triad + m7 => m7
                                      (deg===4 && modeEff==='major')? 10 : // V7 in major
                                      (modeEff==='minor' && deg===4)? 10 : // v7 (natural minor)
                                      11; // maj7 default
                    seventh = seventhInt;
                    if(quality==='dim') extLabel = 'm7b5';
                    else if(quality==='m') extLabel = 'm7';
                    else if(seventhInt===10) extLabel = '7';
                    else extLabel = 'maj7';
                } else if(use6th){
                    // 6th: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ6鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽm6鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽim鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣騾ｧ・ｮ騾包ｽ･?繝ｻ・ｽ繝ｻ・ｽ・つ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    if(quality!=='dim'){
                        const sixthInt = 9; // +9 semitones from root
                        seventh = null; // 7th 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ? 6th 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ隶捺慣・ｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                        extLabel = (quality==='m') ? 'm6' : '6';
                        // pcs 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ later 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ sixth 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ・醍ｲ溶th 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??6th鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽpush 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
                    }
                }
                const pcs = [rootPc, (rootPc+third)%12, (rootPc+fifth)%12];
                if(use6th && extLabel.endsWith('6')){ pcs.push((rootPc+9)%12); }
                else if(seventh!=null) pcs.push((rootPc+seventh)%12);
                // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ邏具ｽｺ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                let label = namesCDE[rootPc] + (extLabel|| (quality==='m'? 'm': (quality==='dim'? '?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ': '')));
                if(use7th && quality==='dim') label = namesCDE[rootPc] + 'm7b5';
                return { pcs, label };
            }
                                    let degreeSequences=[];
                                    if(pat==='chordAllMajor' || pat==='chordAllMinor'){
                                            // 12鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髫ｲ・､?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陷證ｦ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ證ｦ・ｿ・ｽ?繝ｻ・ｽ鬮｢・ｰ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ I鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・･鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ i鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽv鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅楢・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?1鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                                            const allPC=[0,1,2,3,4,5,6,7,8,9,10,11];
                                            const startIndex = keyRootPC; // 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                                            const order=[]; for(let i=0;i<12;i++){ order.push(allPC[(startIndex+i)%12]); }
                                            for(const pcRoot of order){
                                                    // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ髣・ｽｽ隰ｳ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｼ陋ｻ譎橸ｽｬ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴擾ｽｴ隨卍鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                                                    const saveRoot = keyRootPC; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                                                    const degSeq = [0,3,4,0]; // I/ i, IV/iv, V/v, I/i
                                                    // chordForDegree 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ keyRootPC 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髮区ｩｸ・ｽ・ｴ繝ｻ・ｽ?隲ｱ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陝ｶ譁溽｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ髮∵峪鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                                                    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ degreeSequences 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ (pcRoot, degSeq) 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・ｬ驕ｶ髮・ｽｸ譎｢・ｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ pcs 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ蟷｢・ｽ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩墓得・ｽ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?? pcRoot 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                                                    degreeSequences.push({ pcRoot, degSeq });
                                            }
                                    } else {
                                            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ雋蛾摩ﾂ・ｬ・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                                            const templates = keyMode==='major'
                                                    ? [
                                                            [0,5,1,4], [0,3,4,0], [2,5,1,4], [0,2,5,1], [5,4,3,2],
                                                            [0,6,5,4], [3,0,4,5], [1,4,0,5], [6,2,5,1], [4,3,2,1]
                                                        ]
                                                    : [
                                                            [0,5,1,4], [0,3,4,0], [2,5,1,4], [0,2,5,1], [5,4,3,2],
                                                            [6,0,5,4], [3,0,4,5], [1,4,0,5], [6,2,5,1], [4,3,2,1]
                                                        ];
                                            degreeSequences.push({ pcRoot: keyRootPC, degSeq: templates[c % templates.length] });
                                    }
            // PC鬯ｩ蛹・ｽｽ・ｶ繝ｻ・ｽ?隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽIDI 鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ隨翫ｋﾎ・繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螟ｲ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｱ繝ｻ・ｽ?隲・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ蟷｢・ｽ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ鍋ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            function nearestMidiFromPc(pc, low, high, ref){
                const center = (typeof ref==='number' && isFinite(ref)) ? ref : ((low+high)/2);
                // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽPC鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽcenter 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                const list=[];
                // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・｢髯ｷ莨夲ｽｽ・ｱ髫ｨ・ｳ郢晢ｽｻ low 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・｣・ｰ?繝ｻ・ｽ繝ｻ・ｽ・つC鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隰悟･・ｽｽ・ｭ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽMIDI
                let first = low + ((pc - (low%12) + 12) % 12);
                for(let m=first; m<=high; m+=12){ list.push(m); }
                if(!list.length){
                    // 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ center 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ蠍ｺ・ｺ諞ｺ諱ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    const base=Math.round(center);
                    for(let k=-8;k<=8;k++){
                        const m=base+12*k; if(m<low-24||m>high+24) continue; if(((m%12)+12)%12===pc) list.push(m);
                    }
                }
                if(!list.length){ return Math.max(low, Math.min(high, Math.round(center))); }
                let best=list[0], bd=1e9; for(const m of list){ const d=Math.abs(m-center); if(d<bd){ bd=d; best=m; } }
                return best;
            }
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・｣・ｰ?繝ｻ・ｽ繝ｻ・ｽ・つC鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荳橸ｽ､謦ｰ・ｽ・ｬ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螢ｺ謇ｱ陷托ｽｲ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ闔ｨ諛ｶ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ鬲・ｼ夲ｽｽ・ｼ隶難ｽ｣・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            function midiAtOrAbove(pc, minM, low, high){
                let m = minM + ((pc - (minM%12) + 12) % 12); // minM鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽPC鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ鬩包ｽｨ陞ｳ・｣邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ+12
                while(m<low) m+=12;
                if(m>high) return null;
                return m;
            }
            function chordForDegreeWithPcRoot(deg, pcRootOverride){
                // chordForDegree 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽpcRootOverride 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const scaleMaj=[0,2,4,5,7,9,11];
                const scaleMin=[0,2,3,5,7,8,10];
                const modeEff = (keyMode==='random') ? (Math.random()<0.5? 'major':'minor') : keyMode;
                const scale = modeEff==='minor'? scaleMin: scaleMaj;
                const rootPc = (pcRootOverride + scale[deg]) % 12;
                // 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ chordForDegree 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                let third = (modeEff==='minor' && (deg===0||deg===3||deg===4))? 3 :
                             (modeEff==='minor' && (deg===2||deg===5))? 4 :
                             (modeEff==='minor' && deg===6)? 3 :
                             (deg===1||deg===2||deg===5)? 3 : 4;
                let fifth = 7; let quality='';
                if((modeEff==='major' && deg===6) || (modeEff==='minor' && deg===1)){ fifth=6; quality='dim'; }
                else if((modeEff==='major' && (deg===1||deg===2||deg===5)) || (modeEff==='minor' && (deg===0||deg===3||deg===4||deg===6))){ quality='m'; }
                let seventh=null, extLabel='';
                if(use7th){
                    let seventhInt = (quality==='dim')? 10 : (quality==='m')? 10 : (deg===4? 10: 11);
                    seventh = seventhInt;
                    if(quality==='dim') extLabel='m7b5'; else if(quality==='m') extLabel='m7'; else if(seventhInt===10) extLabel='7'; else extLabel='maj7';
                } else if(use6th){
                    if(quality!=='dim'){
                        extLabel = (quality==='m')? 'm6' : '6';
                    }
                }
                const pcs=[rootPc,(rootPc+third)%12,(rootPc+fifth)%12];
                if(use6th && extLabel.endsWith('6')){ pcs.push((rootPc+9)%12); }
                else if(seventh!=null) pcs.push((rootPc+seventh)%12);
                let label = namesCDE[rootPc] + (extLabel|| (quality==='m'? 'm': (quality==='dim'? '?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ': '')));
                if(use7th && quality==='dim') label = namesCDE[rootPc] + 'm7b5';
                return { pcs, label };
            }
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?: 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮倶ｼ∝ｱｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            function shuffleInPlace(arr){ for(let i=arr.length-1;i>0;i--){ const j=(Math.random()* (i+1))|0; const t=arr[i]; arr[i]=arr[j]; arr[j]=t; } return arr; }
            for(const entry of degreeSequences){
                const { pcRoot, degSeq } = entry;
                for(const deg of degSeq){
                    const ch = chordForDegreeWithPcRoot(deg, pcRoot);
                // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ陝・ｈ縺檎ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ髫ｰ魃会ｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｲ郢ｧ髮・ｽｵ・ｯ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ闔ｨ諛ｶ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢繝ｻ・ｽ?隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽoot鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ7)鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const center = (low+high)/2;
                const rootM = nearestMidiFromPc(ch.pcs[0], low, high, center);
                const mids=[rootM];
                for(let i=1;i<ch.pcs.length;i++){
                    const m = midiAtOrAbove(ch.pcs[i], mids[mids.length-1]+1, low, high);
                    if(m==null){
                        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ root 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        const altRoot = nearestMidiFromPc(ch.pcs[0], low, high, rootM-12);
                        mids.length=0; mids.push(altRoot);
                        for(let j=1;j<ch.pcs.length;j++){
                            const mm = midiAtOrAbove(ch.pcs[j], mids[mids.length-1]+1, low, high);
                            if(mm==null) break; mids.push(mm);
                        }
                        break;
                    } else {
                        mids.push(m);
                    }
                }
                // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ3鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ5鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                while(mids.length<3){
                    const last = mids[mids.length-1]||rootM; const pc = ch.pcs[Math.min(mids.length, ch.pcs.length-1)];
                    const mm = midiAtOrAbove(pc, last+1, low, high); if(mm==null) break; mids.push(mm);
                }
                let seq = mids.slice(0, use7th? 4: 3); // 7th ON鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                if(pat==='chordPracticeRandOrder'){
                    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ莨懶ｽｾ魃会ｽｼ莨・ｽｩ蜉ｱ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｢郢晢ｽｻ陋ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ菫ｶ・｢・ｧ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髫ｨ蛛・ｽｿ・ｽ?繝ｻ・ｽ・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜿門擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髯ｷﾂ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ魃会ｽｽ・ｳ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜿･謠ｩ隰費ｽｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    seq = shuffleInPlace(seq.slice());
                }
                sequences.push({ type:'call', seq, labelName: ch.label });
                sequences.push({ type:'resp', seq });
                }
            }
        } else if(pat==='scaleUp' || pat==='scaleDown' || pat==='scaleUpDown'){
            // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・ｽｶ諛・ｽｫ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｺ・ｽ繝ｻ・ｽ?鬮ｫ・ｹ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ蜈ｷ・ｽ・ｹ驕ｶ謫ｾ・ｽ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陞滂ｽｧ?繝ｻ・ｽ繝ｻ・ｽ鬯伜･ﾂｰ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽandom鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const scaleMaj=[0,2,4,5,7,9,11,12];
            const scaleMinNat=[0,2,3,5,7,8,10,12];
            const modeEff = (keyMode==='random') ? (Math.random()<0.5? 'major':'minor') : keyMode;
            const scale = (modeEff==='minor')? scaleMinNat: scaleMaj;
            // 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽootMidi鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ馴垳ﾂ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ?
            const tones=[];
            // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜿冶・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ?
            for(let k=0;k>=-8;k--){ for(const d of scale){ const m=rootMidi + d + 12*k; if(m<low) continue; if(m>high) continue; tones.push(m); } }
            // 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ鬯・汚・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ?
            for(let k=1;k<=8;k++){ for(const d of scale){ const m=rootMidi + d + 12*k; if(m<low) continue; if(m>high) continue; tones.push(m); } }
            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
            const uniq = Array.from(new Set(tones)).sort((a,b)=>a-b);
            function mkCallSeq(){
                if(!uniq.length) return [rootMidi];
                if(pat==='scaleUp'){ return uniq.slice(); }
                if(pat==='scaleDown'){ return uniq.slice().reverse(); }
                // 鬯ｮ・ｯ繝ｻ・ｽ?陷ｩ・ｩ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｴ鬮ｯ・ｬ繝ｻ・ｽ?邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ[鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ闔ｨ諛ｶ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ + [鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ驕倥・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ)]
                const up = uniq.slice();
                const dn = uniq.slice(0, -1).reverse();
                return up.concat(dn);
            }
            const callSeq = mkCallSeq();
            sequences.push({type:'call', seq:callSeq});
            sequences.push({type:'resp', seq:callSeq.slice()});
        } else {
            let callSeq = makePracticePattern(pat, rootMidi + startDegree, Math.min(span, cycleBeats));
            // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｰ・ｨ鬲托ｽｴ・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ隴幢ｽｱ髮趣ｽｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ(root+12)鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?鬨ｾ雜｣・ｽ・ｯ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            callSeq = callSeq.map((n, i, arr)=>{
                let v = n;
                const isTopDo = (pat==='ascMajor' && i===arr.length-1 && Math.abs(n - (rootMidi + 12))<=0.001);
                if(!isTopDo){ while(v < low) v += 12; while(v > high) v -= 12; }
                return v;
            });
            sequences.push({type:'call', seq:callSeq});
            const respSeq = callSeq.slice();
            sequences.push({type:'resp', seq:respSeq});
            startDegree = (startDegree+1) % Math.min(span, 12);
        }
    }
    const startSong = (playbackPosition||0) + 1.0;
    const ghost=[]; const now=audioCtx.currentTime; let tCursorSong=startSong; let tCursorAudio=now+0.1;
    practicePlan.length=0; practiceScheduledSet.clear();
    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ郢晢ｽｻ郢晢ｽｻ?鬩募争豎・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬆托ｽｨ・｣・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(!practiceCallGain){ try{ practiceCallGain = audioCtx.createGain(); practiceCallGain.gain.value = Math.max(0, Math.min(1, parseFloat(practiceCallVolEl?.value||'0.85'))); (masterGain||audioCtx.destination)&&practiceCallGain.connect(masterGain||audioCtx.destination); }catch(_){ } }
    let planIdx=0;
    const isScalePat = (pat==='scaleUp' || pat==='scaleDown' || pat==='scaleUpDown');
    for(const block of sequences){
        const isCall = (block.type==='call');
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ邏具ｽｺ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽhordPractice 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ block.labelName 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ隶捺慣・ｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const blockLabels = (isCall && block.labels)? block.labels : [];
        for(let i=0;i<block.seq.length;i++){
            const m=block.seq[i];
            // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・ｨ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽMIDI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯伜∞・ｿ・ｽ?繝ｻ・ｽ5..C6鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜥ｲ蛻､?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            let dispM = m;
            let label = null;
            // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ菫ｶ・｢・ｧ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯橸ｽｳ陞｢・ｽ郢晢ｽｻ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｼ?繝ｻ・ｽ繝ｻ・ｽ隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯伜・ｽｾ・ｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(isCall && block.labelName){ label = { name: block.labelName }; }
            else if(blockLabels && blockLabels.length){ label = blockLabels.find(lb=> Math.abs((lb.at||0) - tCursorSong) < 1e-6); }
            // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・・?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ郢晢ｽｻ郢晢ｽｻ?鬩募争豎・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ2鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髮趣ｽｸ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬮ｮ迢暦ｽｿ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｼ?鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const durLocal = isScalePat ? (isCall ? (beatSec*0.5) : beatSec) : noteDur;
            const stepLocal = durLocal; // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const g = {midi:dispM, time:tCursorSong, duration: durLocal, role: isCall? 'call':'resp'};
            if(label){ g.label = label.name; }
            ghost.push(g);
            practicePlan.push({ idx: planIdx++, midi:m, timeSong:tCursorSong, duration:durLocal, role: isCall? 'call':'resp' });
            tCursorSong += stepLocal; tCursorAudio += stepLocal;
        }
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ1鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        tCursorSong += beatSec*1.0; tCursorAudio += beatSec*1.0;
    }
    midiGhostNotes = ghost; drawChart();
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｲ蛛・ｽｽ・ｬ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(role==='resp')鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜿冶・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ
    try{
        practiceExpectedNotes = ghost.filter(g=> g.role==='resp').map(g=>({midi:g.midi,time:g.time,duration:g.duration||beatSec}));
    }catch(_){ practiceExpectedNotes=null; }
    practiceEndSongTime = ghost.length? Math.max(...ghost.map(n=> n.time + n.duration)) : (startSong + 60);
    practiceBaseSongTime = startSong; practiceBaseAudioTime = now + 0.1;
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謳ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓幢ｾつ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ
    playbackPosition = practiceBaseSongTime;
    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ魃会ｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｲ郢ｧ髮・ｽｳ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽFROM/TO鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
            let gMin=Infinity, gMax=-Infinity;
            for(const n of midiGhostNotes){
                // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ call 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謳ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ陞溽浹雋ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯懶ｽ｣闔会ｽｰ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const mm = (n.role==='call') ? (n.midi + (practiceCallDisplayOctShift|0)) : n.midi;
                if(mm<gMin) gMin=mm; if(mm>gMax) gMax=mm;
            }
            if(isFinite(gMin) && isFinite(gMax)) setVerticalOffsetToRange(gMin, gMax);
        } else {
            setVerticalOffsetToRange(low + (practiceCallDisplayOctShift|0), high + (practiceCallDisplayOctShift|0));
        }
    }catch(_){ }
    startPracticeScheduler();
    isPracticing=true; practicePaused=false;
    const step=()=>{
        if(!isPracticing) return;
        try{
            const songNow = practiceBaseSongTime + ((audioCtx?.currentTime||0) - practiceBaseAudioTime);
            playbackPosition = songNow;
        }catch(_){ }
        drawChart(); practiceRAF = requestAnimationFrame(step);
    };
    if(practiceRAF) cancelAnimationFrame(practiceRAF); practiceRAF=requestAnimationFrame(step);
    const totalDur = (practiceEndSongTime - startSong) + 0.5; if(practiceLoopTimer) clearTimeout(practiceLoopTimer);
    practiceLoopTimer = setTimeout(()=>{ stopBasicPractice(true); openAdvice(); }, Math.ceil(totalDur*1000));
}

function stopBasicPractice(clearGhost){
    isPracticing=false; if(practiceRAF){ try{ cancelAnimationFrame(practiceRAF); }catch(_){ } practiceRAF=0; }
    if(practiceLoopTimer){ clearTimeout(practiceLoopTimer); practiceLoopTimer=null; }
    if(practiceCallSchedTimer){ try{ clearInterval(practiceCallSchedTimer); }catch(_){ } practiceCallSchedTimer=null; }
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        practiceScheduledNotes.forEach(n=>{ try{ if(n.gain){ n.gain.gain.cancelScheduledValues(0); n.gain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.03); } if(n.src){ try{ n.src.stop(); }catch(_){ } } }catch(_){ } });
    }catch(_){ }
    practiceScheduledNotes.length=0;
    practiceScheduledSet && practiceScheduledSet.clear && practiceScheduledSet.clear();
    practicePlan.length=0;
    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    try{ if(pitchHistory && pitchHistory.length){ pitchHistory.length=0; } }catch(_){ }
    if(clearGhost){ midiGhostNotes=null; drawChart(); }
    practiceExpectedNotes = null;
    try{ seekTo(0); }catch(_){ playbackPosition=0; playbackStartPos=0; drawChart(); }
}

// ---- 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲ｷ諷墓ｫｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・・?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ諞ｺ螻ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ? ----
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬆托ｽｨ・｣・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｮ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋顔§謫髯橸ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function schedulePracticeNote(midi, when, dur){
    try{
        ensureAudio();
        if(!practiceCallGain){
            practiceCallGain = audioCtx.createGain();
            practiceCallGain.gain.value = Math.max(0, Math.min(1, parseFloat(practiceCallVolEl?.value||'0.85')));
            try{ (masterGain||audioCtx.destination) && practiceCallGain.connect(masterGain||audioCtx.destination); }catch(_){ practiceCallGain.connect(audioCtx.destination); }
        }
        let at = when;
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ驕ｨ繧托ｽｽ・ｺ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽT鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｫ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ陷驤ｴ諠ｧ髫ｲ・､郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const outLat = btLatencyEnabled ? (btLatencySec||0) : (estimateOutputLatency()||0);
        if(outLat>0) at = at - outLat;
        const ok = simplePlaySfz(midi, at, dur, practiceCallGain);
        if(!ok){
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ髣憺屮・ｽ・ｭ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            const f = 440 * Math.pow(2, (midi-69)/12);
            osc.type='sine'; osc.frequency.setValueAtTime(f, Math.max(audioCtx.currentTime+0.002, at));
            const startAt = Math.max(audioCtx.currentTime+0.002, at);
            const stopAt = startAt + Math.max(0.05, dur||0.2);
            g.gain.setValueAtTime(0.0001, startAt); g.gain.exponentialRampToValueAtTime(0.5, startAt+0.01);
            g.gain.setTargetAtTime(0.0001, stopAt, 0.2);
            osc.connect(g); g.connect(practiceCallGain);
            osc.start(startAt); osc.stop(stopAt+0.05);
        }
        practiceScheduledNotes.push({ when: at, stopAt: at + (dur||0.2) });
    }catch(_){ }
}

function startPracticeScheduler(){
    try{ ensureAudio(); }catch(_){ }
    // clear existing
    if(practiceCallSchedTimer){ try{ clearInterval(practiceCallSchedTimer); }catch(_){ } practiceCallSchedTimer=null; }
    // ensure gain
    try{
        if(!practiceCallGain){
            practiceCallGain = audioCtx.createGain();
            practiceCallGain.gain.value = Math.max(0, Math.min(1, parseFloat(practiceCallVolEl?.value||'0.85')));
            try{ (masterGain||audioCtx.destination) && practiceCallGain.connect(masterGain||audioCtx.destination); }catch(_){ practiceCallGain.connect(audioCtx.destination); }
        }
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髣厄ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴取得・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(practiceMutedUntil>0){ practiceCallGain.gain.setTargetAtTime(Math.max(0, Math.min(1, parseFloat(practiceCallVolEl?.value||'0.85'))), Math.max(audioCtx.currentTime, practiceMutedUntil+0.02), 0.02); }
    }catch(_){ }
    practiceCallSchedTimer = setInterval(()=>{
        try{
            if(!audioCtx) return;
            const songNow = practiceBaseSongTime + (audioCtx.currentTime - practiceBaseAudioTime);
            const songEnd = songNow + PRACTICE_SCHED_AHEAD;
            for(const it of practicePlan){
                if(it.role!=='call') continue;
                if(it.timeSong < songNow - 1e-3 || it.timeSong > songEnd + 1e-3) continue;
                const key = it.idx;
                if(practiceScheduledSet.has(key)) continue;
                const whenAudio = audioCtx.currentTime + Math.max(0.001, (it.timeSong - songNow));
                schedulePracticeNote(it.midi, whenAudio, it.duration);
                practiceScheduledSet.add(key);
            }
        }catch(_){ }
    }, 60);
}

function pauseBasicPractice(){
    if(!isPracticing || practicePaused) return; practicePaused=true; practicePauseAt = playbackPosition;
    if(practiceRAF){ try{ cancelAnimationFrame(practiceRAF); }catch(_){ } practiceRAF=0; }
    if(practiceLoopTimer){ clearTimeout(practiceLoopTimer); practiceLoopTimer=null; }
    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
    try{ practiceScheduledNotes.forEach(n=>{ if(n.stopAt > (audioCtx?.currentTime||0)){ try{ /* cannot unschedule, but gate */ if(practiceCallGain){ practiceCallGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.03); practiceMutedUntil = (audioCtx?.currentTime||0) + 0.05; } }catch(_){ } } }); }catch(_){ }
    if(practiceCallSchedTimer){ try{ clearInterval(practiceCallSchedTimer); }catch(_){ } practiceCallSchedTimer=null; }
}

function resumeBasicPractice(){
    if(!practicePaused) return; ensureAudio();
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ諞ｺ螻ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ?
    practiceBaseSongTime = practicePauseAt;
    practiceBaseAudioTime = audioCtx.currentTime + 0.06;
    // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ鬮｣魃会ｽｿ・ｽ?繝ｻ・ｽ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴取得・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣郢晢ｽｻ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(practiceCallGain){ try{ practiceCallGain.gain.setTargetAtTime(Math.max(0, Math.min(1, parseFloat(practiceCallVolEl?.value||'0.85'))), practiceBaseAudioTime+0.02, 0.02); }catch(_){ } }
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    practiceScheduledSet && practiceScheduledSet.clear && practiceScheduledSet.clear();
    startPracticeScheduler();
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｻ髮｣・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・､陷ｻ・ｵ隰ｳ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｮ・ｮ遶擾ｽｽ?繝ｻ・ｽ繝ｻ・ｽ髣・ｽｽ繝ｻ・ｽ??鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    isPracticing=true; practicePaused=false;
    const step=()=>{
        if(!isPracticing) return;
        try{
            const songNow = practiceBaseSongTime + ((audioCtx?.currentTime||0) - practiceBaseAudioTime);
            playbackPosition = songNow;
        }catch(_){ }
        drawChart(); practiceRAF = requestAnimationFrame(step);
    };
    if(practiceRAF) cancelAnimationFrame(practiceRAF); practiceRAF=requestAnimationFrame(step);
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const remaining = Math.max(0, practiceEndSongTime - practicePauseAt) + 0.5;
    if(practiceLoopTimer) clearTimeout(practiceLoopTimer);
    practiceLoopTimer = setTimeout(()=>{ stopBasicPractice(true); openAdvice(); }, Math.ceil(remaining*1000));
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ諞ｺ螻ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ髫ｰ魃会ｽｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ陷ｿ・･陝・ｽｰ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟶壽升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
            let gMin=Infinity, gMax=-Infinity; for(const n of midiGhostNotes){ if(n.midi<gMin) gMin=n.midi; if(n.midi>gMax) gMax=n.midi; }
            if(isFinite(gMin) && isFinite(gMax)) setVerticalOffsetToRange(gMin, gMax);
        }
    }catch(_){ }
}
const advicePanel=document.getElementById('advicePanel');
const adviceTextEl=document.getElementById('adviceText');
const adviceCloseBtn=$('adviceClose');
const adviceCanvas=/** @type {HTMLCanvasElement|null} */(document.getElementById('adviceCanvas'));
let _adviceCtx = adviceCanvas? adviceCanvas.getContext('2d') : null;
// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽX鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬮ｮ・ｷ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/3鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function getPlayX(width){
    try{
        const w = Math.max(0, width|0);
        // 鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ魃会ｽｽ・｢髯ｷ・ｿ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ33%鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ0px鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        return Math.round(Math.max(60, Math.min(w - 80, w * 0.33)));
    }catch(_){ return 70; }
}
// 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽI鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛現窶ｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const rangeSelectToggle=document.getElementById('rangeSelectToggle');
const clearSelectionBtn=document.getElementById('clearSelectionBtn');
const octDownBtn=document.getElementById('octDownBtn');
const octUpBtn=document.getElementById('octUpBtn');
const applyForwardToggle=document.getElementById('applyForwardToggle');
const undoBtn=document.getElementById('undoBtn');
const redoBtn=document.getElementById('redoBtn');
// 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ髫ｲ・ｱ郢晢ｽｻ髢・ｳ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢ｧ莨夲ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｴ髮｣・ｽ・､髫ｴ蟷｢・ｽ・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const midiRefBtn=document.getElementById('midiRefSelectBtn');
// const midiAlignInfo 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ隨翫ｋ・ｬ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const noteSnapSaveBtn=document.getElementById('noteSnapSaveBtn');
const noteSnapRestoreBtn=document.getElementById('noteSnapRestoreBtn');
let _noteSnapshot=null;
// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽI鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・＠?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let strictOctaveMode=false;
const strictOctaveToggle=null; // UI鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ
const midiRefInput=document.getElementById('midiRefInput');
const midiTrackSelect=document.getElementById('midiTrackSelect');
const midiApplyBtn=document.getElementById('midiApplyBtn');
const midiGenerateBtn=document.getElementById('midiGenerateBtn');
// 鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI
const midiAlignPanel=document.getElementById('midiAlignPanel');
const midiAlignDetStart=document.getElementById('midiAlignDetStart');
const midiAlignRefStart=document.getElementById('midiAlignRefStart');
const midiAlignScale=document.getElementById('midiAlignScale');
const midiAlignFitEnds=document.getElementById('midiAlignFitEnds');
const midiAlignInfo=document.getElementById('midiAlignInfo');

// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?/鬯ｮ・｣髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶抵ｽｭ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽndex.html 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｺID鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const melodyAudioBtn=$('melodyAudioSelectBtn');
const melodyAudioInput=$('melodyAudioInput');
const melodyAudioLabel=$('melodyAudioLabel');
const accompAudioBtn=$('accompAudioSelectBtn');
const accompAudioInput=$('accompAudioInput');
const accompAudioLabel=$('accompAudioLabel');

// Stop鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髫ｶ謚ｵ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ陞ｽ・ｯ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let STOP_TRUSTED_ONLY = true; // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
window.protectStop = function(on=true){ STOP_TRUSTED_ONLY = !!on; console.warn('STOP_TRUSTED_ONLY=', STOP_TRUSTED_ONLY); };
// (ZIP鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛現窶ｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ陋滉ｻｰﾂ? index.html 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const pianoZipInput=document.getElementById('pianoZipInput');
const pianoZipBtn=document.getElementById('pianoZipLoadBtn');
const pianoZipStatus=document.getElementById('pianoZipStatus');
const sfzDirBtn=document.getElementById('sfzDirLoadBtn');
const sfzDirInput=document.getElementById('sfzDirInput');
const sfzStatus=document.getElementById('sfzStatus');
// 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢ｧ蜿･・ｯ讓抵ｽｹ・ｧ郢晢ｽｻ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let pianoZipManifest=null; // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ manifest
let pianoZipFiles=null;    // { filename: Uint8Array }
let pianoZipDecodeQueue=[]; // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶夲ｽｨ鬮ｫ・ｨ鬮ｷ菫ｶ蜊・坿・､?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let pianoZipDecoding=false;
let pianoZipDecodePaused=false; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let pianoIRBuffer=null; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let pianoIRConvolver=null; // ConvolverNode
let resonanceWetGain=null; // IR鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let preOutMergeGain=null; // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let resonanceMix=0.15; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?繝ｻ・ｽ繝ｻ・ｽ隴会ｽｮ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(0..0.6)
let pianoSampleMap={};// key: midi -> { layers:{pp:AudioBuffer,...}, release:AudioBuffer|null, gains:{pp:db,...} }
// 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ蜿厄ｽｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ Piano / Flute 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const instrumentMaps={ Piano:null, Flute:null };

// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髮倶ｼ夲ｽｿ・ｽ?繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let sustainPedal=false; // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽFF

// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ螟懈｡ｷFZ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟・ｽｼ諛ｶ・ｽ・ｴ隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ・ｷ・つ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let SIMPLE_SFZ_MODE=false; // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽFF
window.setSimpleSfzMode=function(on=true){ SIMPLE_SFZ_MODE=!!on; console.warn('SIMPLE_SFZ_MODE=',SIMPLE_SFZ_MODE); };

// ==============================
// UI: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// ==============================
(function wireDevToggles(){
    try{
        // strictOctaveToggle 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ UI鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢ｧ荵晢ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｱ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(noteSnapSaveBtn){
            noteSnapSaveBtn.addEventListener('click', ()=>{
                try{ _noteSnapshot = snapshotNotes(); if(noteSnapRestoreBtn) noteSnapRestoreBtn.disabled = !_noteSnapshot; }catch(_){ _noteSnapshot=null; }
            });
        }
        if(noteSnapRestoreBtn){
            noteSnapRestoreBtn.addEventListener('click', ()=>{
                if(_noteSnapshot){ restoreFromSnap(_noteSnapshot); }
            });
        }
    }catch(e){ console.warn('wireDevToggles failed', e); }
})();

// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ鍋ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶夲ｽｨ鬮ｯ貊ゑｽｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯懶ｽ｣闔会ｽｰ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let PREFERRED_SAMPLE_EXTS = null; // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮倶ｼ∝ｱｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let SELECTED_SAMPLE_PRIMARY = null; // 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・ｨ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｺ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function getAltSampleExts(){
    try{
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(Array.isArray(PREFERRED_SAMPLE_EXTS) && PREFERRED_SAMPLE_EXTS.length){
            SELECTED_SAMPLE_PRIMARY = PREFERRED_SAMPLE_EXTS[0]||null;
            return PREFERRED_SAMPLE_EXTS.slice();
        }
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｧ・ｭ・朱ｦｴﾎ碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const a=document.createElement('audio');
        const support={
            wav: true, // PCM WAV 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            ogg: !!a.canPlayType && (a.canPlayType('audio/ogg; codecs=vorbis')||'').length>0,
            mp3: !!a.canPlayType && (a.canPlayType('audio/mpeg')||'').length>0,
            m4a: !!a.canPlayType && ((a.canPlayType('audio/mp4')||a.canPlayType('audio/aac'))||'').length>0
        };
        // UI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ隨翫ｋﾎ・繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ auto | wav | ogg | mp3 | m4a
        const pref = (typeof formatSelect!=="undefined" && formatSelect && formatSelect.value)? String(formatSelect.value): 'auto';
        const all=['wav','ogg','m4a','mp3'];
        let order=[];
        if(pref && pref!=='auto'){
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隰・・・ｽ・ｼ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(all.includes(pref)) order.push(pref);
        }
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｼ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ wav > ogg > m4a > mp3鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const byPrio=['wav','ogg','m4a','mp3'];
        for(const ext of byPrio){ if(!order.includes(ext) && support[ext]) order.push(ext); }
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ蟷｢・ｽ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        for(const ext of all){ if(!order.includes(ext)) order.push(ext); }
        SELECTED_SAMPLE_PRIMARY = order[0]||null;
        return order;
    }catch(_){ SELECTED_SAMPLE_PRIMARY=null; return ['wav','ogg','m4a','mp3']; }
}

// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(Convolver)鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｱ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function ensureConvolver(){
    if(!audioCtx || !masterGain) return;
    try{
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(!preOutMergeGain){ preOutMergeGain = audioCtx.createGain(); preOutMergeGain.gain.value = 1; }
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ masterGain -> compressor 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕呈汚・ｽ・ｬ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽry 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽpreOutMergeGain 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        try{ masterGain.disconnect(); }catch(_){ }
        try{ masterGain.connect(preOutMergeGain); }catch(_){ }
        // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{ preOutMergeGain.disconnect(); }catch(_){ }
        if(compressor){
            try{ preOutMergeGain.connect(compressor); }catch(_){ }
        }else if(limiter){
            try{ preOutMergeGain.connect(limiter); }catch(_){ }
        }else{
            try{ preOutMergeGain.connect(audioCtx.destination); }catch(_){ }
        }
        // IR 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(pianoIRBuffer){
            if(!pianoIRConvolver) pianoIRConvolver = audioCtx.createConvolver();
            try{ pianoIRConvolver.buffer = pianoIRBuffer; }catch(_){ }
            if(!resonanceWetGain) resonanceWetGain = audioCtx.createGain();
            try{ resonanceWetGain.gain.setValueAtTime(resonanceMix, audioCtx.currentTime); }catch(_){ resonanceWetGain.gain.value = resonanceMix; }
            try{ pianoIRConvolver.disconnect(); }catch(_){ }
            try{ masterGain.connect(pianoIRConvolver); }catch(_){ }
            try{ pianoIRConvolver.connect(resonanceWetGain); }catch(_){ }
            try{ resonanceWetGain.connect(preOutMergeGain); }catch(_){ }
        } else {
            try{ if(pianoIRConvolver) pianoIRConvolver.disconnect(); }catch(_){ }
        }
    }catch(e){ console.warn('ensureConvolver failed', e); }
}

// AudioContext鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ陝・ｻend鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ鬮｣魃会ｽｿ・ｽ?繝ｻ・ｽ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ??

// AudioContext鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ陝・ｻend鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ鬮｣魃会ｽｿ・ｽ?繝ｻ・ｽ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ??
function ensureKeepAlive(){
    if(!audioCtx) return;
    // destination鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ鬩怜遜・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ繝ｻ・ｽ?雎・屮・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(!_keepAliveOsc) try{
        const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
        osc.type='sine'; osc.frequency.setValueAtTime(25, audioCtx.currentTime);
        g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); _keepAliveOsc=osc; _keepAliveGain=g;
    }catch(_){ }
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｵ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髫ｲ蟷・か?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ鬩怜遜・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
    if(!_keepAliveHiOsc) try{
        const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
        osc.type='sine'; osc.frequency.setValueAtTime(12000, audioCtx.currentTime);
        g.gain.setValueAtTime(0.00003, audioCtx.currentTime);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); _keepAliveHiOsc=osc; _keepAliveHiGain=g;
    }catch(_){ }
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髫ｨ蜷ｶ・具ｾ守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ DC 鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ陷證ｦ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽsuspend鬯ｮ・ｯ繝ｻ・ｽ?髴・ｽｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(!_keepAliveConst) try{
        const cs=audioCtx.createConstantSource(); const g=audioCtx.createGain();
        cs.offset.setValueAtTime(0.00001, audioCtx.currentTime);
        g.gain.setValueAtTime(1, audioCtx.currentTime);
        cs.connect(g); g.connect(masterGain||audioCtx.destination);
        cs.start(); _keepAliveConst=cs; _keepAliveConstGain=g;
    }catch(_){ }
}
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・､?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ・ｯ郢晢ｽｻ鬮ｯ・ｬ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ・つ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function tuneCompressor(){ if(!compressor) return; try{ compressor.threshold.value=-28; compressor.knee.value=12; compressor.ratio.value=4.5; compressor.attack.value=0.004; compressor.release.value=0.12; }catch(_){ } }
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?繝ｻ・ｽ繝ｻ・ｽ隴会ｽｮ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ騾ｹ・｣・つ髯ｷ・･陟托ｽｱ隨卍鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function tuneLimiter(){ if(!limiter) return; try{ limiter.threshold.value=-6; limiter.knee.value=1; limiter.ratio.value=20; limiter.attack.value=0.003; limiter.release.value=0.08; }catch(_){ } }
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ荳ｻ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function tuneLimiterStrong(){ if(!limiter) return; try{ limiter.threshold.value=-8; limiter.knee.value=1; limiter.ratio.value=20; limiter.attack.value=0.003; limiter.release.value=0.12; }catch(_){ } }

// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髫ｲ蟶幢ｽ､・ｷ陝ｶ譏ｴ・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｱ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ菫ｶ・｢・ｧ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ諞ｺ螻ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function ensureAudio(){
    try{
        if(!audioCtx){
            const Ctx = window.AudioContext || window.webkitAudioContext;
            audioCtx = new Ctx({ latencyHint: 'interactive' });
        }
        // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ郢晢ｽｻ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(!masterGain) masterGain = audioCtx.createGain();
        if(!melodyGain) melodyGain = audioCtx.createGain();
        if(!accompGain) accompGain = audioCtx.createGain();
        if(!compressor) compressor = audioCtx.createDynamicsCompressor();
        if(!limiter) limiter = audioCtx.createDynamicsCompressor();
        // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        try{ masterGain.gain.setValueAtTime(1, audioCtx.currentTime); }catch(_){ masterGain.gain.value=1; }
        try{ melodyGain.gain.setValueAtTime(1, audioCtx.currentTime); }catch(_){ melodyGain.gain.value=1; }
        try{ accompGain.gain.setValueAtTime(1, audioCtx.currentTime); }catch(_){ accompGain.gain.value=1; }
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｱ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{ melodyGain.disconnect(); }catch(_){ }
        try{ accompGain.disconnect(); }catch(_){ }
        try{ masterGain.disconnect(); }catch(_){ }
        try{ compressor.disconnect(); }catch(_){ }
        try{ limiter.disconnect(); }catch(_){ }
        // melody/accomp -> master -> compressor -> limiter -> destination
        try{ melodyGain.connect(masterGain); }catch(_){ }
        try{ accompGain.connect(masterGain); }catch(_){ }
        try{ masterGain.connect(compressor); }catch(_){ }
        try{ compressor.connect(limiter); }catch(_){ }
        try{ limiter.connect(audioCtx.destination); }catch(_){ }
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        try{ tuneCompressor(); }catch(_){ }
        try{ tuneLimiter(); }catch(_){ }
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ蠍ｺ・ｺ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｱ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽreOutMergeGain鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｮ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{ ensureConvolver(); }catch(_){ }
        // UI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髫ｲ蟶幢ｽ､・ｷ陝ｶ譏ｴ・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{
            if(guideVol){ const v=Math.max(0, Math.min(1, parseFloat(guideVol.value)||1)); melodyGain.gain.setValueAtTime(v, audioCtx.currentTime); }
            if(accompVol){ const v=Math.max(0, Math.min(1, parseFloat(accompVol.value)||1)); accompGain.gain.setValueAtTime(v, audioCtx.currentTime); }
        }catch(_){ }
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶夲ｽｨ鬮ｯ讖ｸ・ｽ・ｻ鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ・つ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(audioActivated){ try{ ensureKeepAlive(); }catch(_){ }
            // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ諞ｺ螻ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ?
            try{ if(audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{}); } }catch(_){ }
        }
        return audioCtx;
    }catch(e){ console.warn('ensureAudio failed', e); return null; }
}
// 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ鬆第答鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function activateAudioOnce(){
    try{
        ensureAudio(); audioActivated=true;
        try{ if(audioCtx && audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{}); } }catch(_){ }
        try{ ensureKeepAlive(); }catch(_){ }
    }catch(_){ }
}

// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ雋牙､懶ｽｦ・ｴ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
async function initMic(allowPrompt=false){
    ensureAudio();
    // ---- 鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬘秘惧?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ髣憺屮・ｽ・ｭ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ ----
    if(typeof window.__micInitInFlight==='undefined') window.__micInitInFlight=false;
    if(typeof window.__lastMicInitAt==='undefined') window.__lastMicInitAt=0;
    const _guardNow = performance.now? performance.now(): Date.now();
    if(window.__micInitInFlight){ return false; }
    if(!allowPrompt && (_guardNow - window.__lastMicInitAt) < 2000){ return false; }
    window.__micInitInFlight = true;
    try{
        if(_initMicInFlight) return false;
        _initMicInFlight = true;
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隶・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｬ・ｯ莨夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ getUserMedia 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髴難ｽ｣陋滂ｽ｡?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let state = await getMicPermissionState();
        const nowMs = (performance.now? performance.now(): Date.now());
        if(!allowPrompt){
            const canProceedSilently = (state==='granted') || (state===null && _userExplicitMicInit);
            if(!canProceedSilently){
                // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｹ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                return false;
            }
        } else {
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ謇假ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｴ髮｣・ｽ・｣髯句ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ邵ｺ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ陋滂ｽｬ?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            _lastPromptAt = nowMs;
        }
        // 鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ? AudioContext 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ・つ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ鬯ｩ蜉ｱ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｽ・｡郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{ if(audioCtx && audioCtx.state==='suspended'){ await audioCtx.resume().catch(()=>{}); } }catch(_){ }
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ throw new Error('getUserMedia not available'); }
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        try{ if(micStream){ micStream.getTracks().forEach(t=>t.stop()); } }catch(_){ }
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷供・ｮ・｣髴趣ｽｧ繝ｻ・ｽ?霓｣菫ｶﾎ・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽOS/鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽVAD/NS/AGC鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const rawAudio = {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false,
            voiceIsolation: false,
            channelCount: { ideal: 1 },
            sampleRate: { ideal: 48000 },
            latency: { ideal: 0 },
            // Chromium鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ鬯・ｯ幃ｴｬ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢ｧ荵晢ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣厄ｽｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            advanced: [
                { googEchoCancellation: false },
                { googExperimentalEchoCancellation: false },
                { googNoiseSuppression: false },
                { googNoiseSuppression2: false },
                { googAutoGainControl: false },
                { googAutoGainControl2: false },
                { googHighpassFilter: false },
                { googAudioMirroring: false }
            ]
        };
        // deviceId鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞溯ｲｫﾂ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ鍋ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陋ｹ竏ｵ貍・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const withDevice = Object.assign({}, rawAudio);
        if(selectedMicDeviceId){
            try{ withDevice.deviceId = { exact: selectedMicDeviceId }; }catch(_){ }
        }
        let stream = null;
        try{
            // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            stream = await navigator.mediaDevices.getUserMedia({ audio: withDevice, video:false });
        }catch(e1){
            // 鬯ｮ・｣郢晢ｽｻ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ髯ｷ闌ｨ・ｽ・ｱ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隶主･・ｽｿ・ｽ?繝ｻ・ｽ髯樊ｻゑｽｽ・｢鬮ｫ・ｹ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            try{ stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:false, noiseSuppression:false, autoGainControl:false }, video:false }); }
            catch(e2){
                // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                stream = await navigator.mediaDevices.getUserMedia({ audio: true, video:false });
            }
        }
        micStream = stream;
        // 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・ｨ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陷･譁懃｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽID鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・｢鬮｣謳ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{
            const tr = (stream.getAudioTracks && stream.getAudioTracks()[0]) || null;
            const st = tr && tr.getSettings ? tr.getSettings() : null;
            if(st && st.deviceId){ selectedMicDeviceId = st.deviceId; }
        }catch(_){ }
        micSource = audioCtx.createMediaStreamSource(stream);
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ莨懶ｽｾ魃会ｽｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髫伜､懶ｽｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        micHPF = audioCtx.createBiquadFilter(); micHPF.type='highpass'; micHPF.frequency.setValueAtTime(70, audioCtx.currentTime);
        micLPF = audioCtx.createBiquadFilter(); micLPF.type='lowpass';
        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髫ｲ蟷・か?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ8鬯ｩ蛹・ｽｽ・ｶ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ699Hz 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{
            const sr = audioCtx.sampleRate || 48000;
            const cutoff = Math.min(14000, Math.max(6000, sr * 0.45)); // 6k鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ4kHz鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            micLPF.frequency.setValueAtTime(cutoff, audioCtx.currentTime);
        }catch(_){ micLPF.frequency.value = 8000; }
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣螂・ｽｿ・ｽ?陋ｹ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｻ・ｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        micAnalyser = audioCtx.createAnalyser();
        micAnalyser.fftSize = 2048;
        micAnalyser.smoothingTimeConstant = 0.0;
        micData = new Float32Array(micAnalyser.fftSize);
        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｱ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ mic -> HPF -> LPF -> analyser 鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽestination 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{ micSource.disconnect(); }catch(_){ }
        micSource.connect(micHPF); micHPF.connect(micLPF); micLPF.connect(micAnalyser);
        // YIN/CMNDF tracker modules (if available)
        try{
            const M = window.__PitchModules;
            if(M){
                _yinTracker = new M.YinPitchTracker({ sampleRate: audioCtx.sampleRate, frameSize: micAnalyser.fftSize, fmin: 55, fmax: 2000, threshold: 0.12 });
                // hop = frame/2 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ髮｣・ｽ・｣髯懈圜・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣鬯・汚・ｽ・ｹ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ讓呈ｨ・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢ｧ荵晢ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟・ｽｿ・ｶ陷托ｽｲ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陋ｹ竏ｵ貍・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ蛟ｬ・ｯ莨夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                try{
                    const sr = audioCtx.sampleRate || 48000;
                    const hop = Math.max(1, Math.floor(micAnalyser.fftSize/2));
                    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 90 鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ110鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣螂・ｽｿ・ｽ?邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ鬪ｰ邇厄ｽ｢螟懷梭?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ120鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const hopRate = Math.max(10, Math.min(IS_MOBILE? 110: 120, Math.round(sr / hop)));
                    analysisRate = Math.max(analysisRate||0, hopRate);
                }catch(_){ }
                // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?髫ｶ魃会ｽｽ・｢?繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣螂・ｽｿ・ｽ?邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ鬪ｰ邇厄ｽ｢螟懷梭?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                _pitchSmootherMod = new M.PitchSmoother(
                    IS_MOBILE
                        ? { windowSize: 7, deadbandCents: 6, riseCents: 30, fallCents: 38 }
                        : { windowSize: 7, deadbandCents: 8, riseCents: 35, fallCents: 45 }
                );
            }
        }catch(_){ /* ignore */ }
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ陞ｽ・ｯ髦｡鬥ｴ・ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? cadence 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(analysisTimer){ try{ clearInterval(analysisTimer); }catch(_){ } analysisTimer=null; }
        analysisTimer = setInterval(analyzePitch, 1000/analysisRate);
        // MIC 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        try{ setMicStatus('ON'); }catch(_){ }
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷供・ｮ・｣髴趣ｽｧ髯ｷ閧ｴ・ｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        try{
            if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices){
                const devs = await navigator.mediaDevices.enumerateDevices();
                _micDevicesCache = devs.filter(d=>d.kind==='audioinput');
                refreshMicPickerList();
            }
        }catch(_){ }
        try{
            const tracks = (micStream.getAudioTracks? micStream.getAudioTracks(): micStream.getTracks());
            tracks.forEach(async t=>{
                if(!t) return;
                // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ菫ｶ縺・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ邵ｺ・､・つ鬮ｫ・ｲ郢晢ｽｻ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                try{ await t.applyConstraints({ echoCancellation:false, noiseSuppression:false, autoGainControl:false, advanced:[{ echoCancellation:false, noiseSuppression:false, autoGainControl:false }] }).catch(()=>{}); }catch(_){ }
                if(!t._onteiBound){
                    t._onteiBound=true;
                    t.onended = ()=>{ try{ setMicStatus('OFF'); }catch(_){} };
                    t.onmute = ()=>{ // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ髣・ｽｽ隰ｳ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髣厄ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        const now=performance.now?performance.now():Date.now();
                        if(now - _micLastReinitAt > 1500){ _micLastReinitAt=now; setTimeout(()=>{ try{ initMic(false).catch(()=>{}); }catch(_){ } }, 50); }
                    };
                    t.onunmute = ()=>{ try{ setMicStatus('ON'); }catch(_){} };
                }
            });
        }catch(_){ }
        _micVoicedRecently=false; _micFlatFrames=0;
        window.__lastMicInitAt = performance.now? performance.now(): Date.now();
        return true;
    }catch(e){ console.warn('initMic failed', e); try{ setMicStatus('OFF'); }catch(_){ } return false; }
    finally{ _initMicInFlight = false; window.__micInitInFlight=false; }
}

// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
async function enumerateMicInputs(){
    try{
        if(!(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices)) return [];
        const list = await navigator.mediaDevices.enumerateDevices();
        return list.filter(d=>d.kind==='audioinput');
    }catch(_){ return []; }
}

// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・｢郢ｧ・ｪ
function openMicPicker(){
    try{
        let ov = document.getElementById('micPickerOverlay');
        if(!ov){
            ov = document.createElement('div'); ov.id='micPickerOverlay';
            ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:5000;';
            const card = document.createElement('div'); card.id='micPickerCard';
            card.style.cssText='min-width:260px;max-width:92vw;background:#222;color:#eee;border:1px solid #4e8cff;border-radius:8px;padding:14px;font-family:sans-serif;box-shadow:0 8px 28px rgba(0,0,0,0.4);';
            card.innerHTML = `
                <div style="font-size:16px;font-weight:600;margin-bottom:8px;">鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/div>
                <div id="micPickerInfo" style="font-size:12px;opacity:0.85;margin-bottom:8px;">鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢髯ｷ・ｿ闔ｨ螟ｲ・ｽ・ｾ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ怜℡?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ/div>
                <select id="micDeviceSelect" style="width:100%;margin-bottom:10px;padding:6px;border-radius:4px;border:1px solid #555;background:#111;color:#eee"></select>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button id="micPickerPermBtn" style="padding:6px 10px;border:1px solid #777;background:#333;color:#eee;border-radius:4px">鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ怜℡?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ</button>
                    <button id="micPickerStartBtn" style="padding:6px 10px;border:1px solid #4e8cff;background:#2a4d8f;color:#fff;border-radius:4px">鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ/button>
                    <button id="micPickerCancelBtn" style="padding:6px 10px;border:1px solid #777;background:#444;color:#eee;border-radius:4px">鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ</button>
                </div>`;
            ov.appendChild(card); document.body.appendChild(ov);
            // events
            card.querySelector('#micPickerCancelBtn').onclick = ()=> closeMicPicker();
            card.querySelector('#micPickerPermBtn').onclick = async()=>{
                _userExplicitMicInit=true; await initMic(true);
                const list = await enumerateMicInputs(); _micDevicesCache = list; refreshMicPickerList();
            };
            card.querySelector('#micPickerStartBtn').onclick = async()=>{
                const sel = card.querySelector('#micDeviceSelect'); const val = sel && sel.value;
                selectedMicDeviceId = (val && val!=='default') ? val : null;
                _userExplicitMicInit=true; await initMic(true); closeMicPicker();
            };
        }
        refreshMicPickerList(); ov.style.display='flex';
    }catch(e){ console.warn('openMicPicker failed',e); }
}
function refreshMicPickerList(){
    const ov = document.getElementById('micPickerOverlay');
    const sel = ov && ov.querySelector('#micDeviceSelect');
    const info = ov && ov.querySelector('#micPickerInfo');
    const startBtn = ov && ov.querySelector('#micPickerStartBtn');
    if(!sel || !info || !startBtn) return;
    sel.innerHTML='';
    const list = _micDevicesCache||[]; const hasList = Array.isArray(list) && list.length>0;
    if(!hasList){
        const opt=document.createElement('option'); opt.value='default'; opt.textContent='(鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謳ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)'; sel.appendChild(opt);
        info.textContent='鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ怜℡?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ; startBtn.disabled=false; return;
    }
    const mk=(id,label)=>{ const o=document.createElement('option'); o.value=id||'default'; o.textContent=label||id||'default'; return o; };
    sel.appendChild(mk('default','(鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ'));
    list.forEach((d,i)=>{ sel.appendChild(mk(d.deviceId, (d.label&&d.label.trim())?d.label:(`鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ${i+1}`))); });
    sel.value = selectedMicDeviceId || 'default';
    info.textContent='鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｰ・ｨ鬲托ｽｴ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ; startBtn.disabled=false;
}
function closeMicPicker(){ const ov=document.getElementById('micPickerOverlay'); if(ov) ov.style.display='none'; }


// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣隲幄ご陲夜匚謇假ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function estimateOutputLatency(){
    let est=0;
    try{
        if(audioCtx){
            if(typeof audioCtx.outputLatency==='number') est+=audioCtx.outputLatency||0;
            if(typeof audioCtx.baseLatency==='number') est+=audioCtx.baseLatency||0;
        }
    }catch(_){ }
    if(!est || !isFinite(est) || est<0.005){
        // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ陷雁しﾂ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?鬯ｯ蛟ｬ・ｯ莨夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: iOS 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
        est = isIOS()? 0.12 : 0.08;
    }
    return Math.max(0.03, Math.min(0.3, est));
}

// ---- 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ ----
async function runLatencyCalibration(){
    try{
        ensureAudio();
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛沺・｡・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(!micAnalyser){
            await initMic(false).catch(()=>{});
        }
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隴ｴ・ｧ雎主､ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｵ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(isPlaying){ try{ pausePlayback(); }catch(_){ } }
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?4鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ閧ｴ蜃ｵ隲､雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ・ｴ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const startLeadSec = 0.0; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・皮ｹ晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ0鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ髢ｾ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ螟ｲ・ｽ・ｿ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const spacingSec = 0.9;   // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｵ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ郢晢ｽｻ髯滓汚・ｽ・ｱ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const noteDurSec = 0.45;  // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ?
    const count = 4;
        const baseMidi = 60; // C4 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const startSong = (playbackPosition||0) + 0.8; // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟・ｽｿ・ｶ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const ghost=[]; const targetTimes=[];
        for(let i=0;i<count;i++){
            ghost.push({midi:baseMidi, time:startSong + i*spacingSec, duration:noteDurSec, role:'calib'});
        }
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・皮ｹ晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢ｧ莨夲ｽｽ・ｫ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴取得・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ魃会ｽｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ隶難ｽ｣・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    _calibAbort = false; // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        isCalibrating = true;
        midiGhostNotes = ghost; calibPrevPos = playbackPosition; calibBasePos = startSong;
        calibAnchorActive = true; calibAnchorTime = ghost[0].time; calibAnchorMidi = ghost[0].midi; drawChart();
        // 3,2,1 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬮ｮ・ｷ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ髫ｰ魃会ｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｲ郢ｧ鬆堕・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    calibCountdownText='3'; drawChart(); setTimeout(()=>drawChart(), 0); if(btCalibStatus) btCalibStatus.textContent='鬯ｮ・ｮ郢晢ｽｻ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 3';
    await new Promise(r=>setTimeout(r,600)); calibCountdownText='2'; drawChart(); setTimeout(()=>drawChart(), 0); if(btCalibStatus) btCalibStatus.textContent='鬯ｮ・ｮ郢晢ｽｻ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 2';
    await new Promise(r=>setTimeout(r,600)); calibCountdownText='1'; drawChart(); setTimeout(()=>drawChart(), 0); if(btCalibStatus) btCalibStatus.textContent='鬯ｮ・ｮ郢晢ｽｻ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 1';
    await new Promise(r=>setTimeout(r,500)); calibCountdownText=null; drawChart(); if(btCalibStatus) btCalibStatus.textContent='鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
        // 鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ髣憺屮・ｽ・ｭ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ繝ｻ・ｿ・ｽ?髮趣ｽｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隲・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ陷托ｽｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ timelineOffsetSec 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ郢晢ｽｻ髣憺屮・ｽ・ｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ遶企ｷｹ・ｫ・ｴ陜捺ｻ楢乢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・＠?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ髢ｾ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ魃会ｽｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｱ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｻ楢乢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｯ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽstartPerf鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        calibMoveStartPerf = performance.now()/1000;
        calibPrevPos = playbackPosition;
        const animate = ()=>{
            if(!isCalibrating || _calibAbort) return;
            try{
                const nowP = performance.now()/1000;
                const dt = Math.max(0, nowP - calibMoveStartPerf);
                // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｨ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｵ蠍ｺ・ｺ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜴・ｽｽ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｶ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・｣・ｰ闔会ｽｰ・つ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ? 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?? playbackPosition 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｰ・ｨ鬲托ｽｴ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
                playbackPosition = calibPrevPos + dt; // 1x 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                drawChart();
                _calibRAF = requestAnimationFrame(animate);
            }catch(_){ _calibRAF = requestAnimationFrame(animate); }
        };
        if(_calibRAF) cancelAnimationFrame(_calibRAF); _calibRAF = requestAnimationFrame(animate);
        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊ゑｽｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髦ｮ蜊搾ｽｧ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ魃会ｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｲ郢ｧ髮・ｽｳ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ陷托ｽｲ鬮ｫ・ｲ陝ｶ蟶ｷ讓・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const t0 = (audioCtx?.currentTime||0) + startLeadSec + 0.02;
        for(let i=0;i<count;i++){ const when = t0 + i*spacingSec; targetTimes.push(when); }
        const sr = audioCtx.sampleRate||48000; const win=2048; const tmp=new Float32Array(win);
        const onsetTimes=[];
        const deadline = t0 + count*spacingSec + 1.2; // AudioContext 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const wallDeadline = (performance.now()/1000) + (count*spacingSec + 2.0); // 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ蜴・ｽｽ・ｧ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ郢晢ｽｻ
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let lastDb=-120; const threshUp=8; // dB 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ鬩怜遜・ｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ・つ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        while(true){
            if(_calibAbort) break;
            const nowCtx = (audioCtx?.currentTime)||0;
            const nowPerf = performance.now()/1000;
            if(nowCtx >= deadline || nowPerf >= wallDeadline) break;
            if(!micAnalyser){ await new Promise(r=>setTimeout(r,10)); continue; }
            micAnalyser.getFloatTimeDomainData(tmp);
            // 鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽMS->dB
            let rms=0; for(let i=0;i<tmp.length;i++){ rms+=tmp[i]*tmp[i]; } rms=Math.sqrt(rms/tmp.length); const db=20*Math.log10(Math.max(1e-9,rms));
            // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(db - lastDb > threshUp && db>-50){
                // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ雋牙私・ｽ・ｨ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?隲ｷ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ・つ鬩墓慣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ陋帶・・ｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                const srLoc = (audioCtx?.sampleRate)||48000;
                const frameCenter = ((micAnalyser?.fftSize)||2048) / (2*srLoc); // 鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ1ms@48k
                const pollJitter = 0.005; // 5ms 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const onset = Math.max(0, audioCtx.currentTime - frameCenter - pollJitter);
                onsetTimes.push(onset);
            }
            lastDb = db*0.8 + lastDb*0.2; // 鬯ｮ・ｯ郢晢ｽｻ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            await new Promise(r=>setTimeout(r, 10));
        }
        if(_calibAbort){
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ陋ｹ竏晉横鬯ｮ・｣騾ｧ・ｮ騾包ｽ･?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            try{ if(_calibRAF) cancelAnimationFrame(_calibRAF); }catch(_){ }
            _calibRAF = 0; isCalibrating=false; calibAnchorActive=false; midiGhostNotes=null; drawChart();
            if(btCalibStatus) btCalibStatus.textContent='鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?';
            try{ seekTo(0); }catch(_){ playbackPosition=0; playbackStartPos=0; drawChart(); }
            return;
        }
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｹ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ? onset 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ謇假ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
        const deltas=[];
        for(const tt of targetTimes){
            let best=null,bd=1e9; for(const ot of onsetTimes){ const d=Math.abs(ot-tt); if(d<bd){ bd=d; best=ot; } }
            if(best!=null) deltas.push(best-tt);
        }
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ繝ｻ・ｿ・ｽ?髮趣ｽｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ髦ｮ蜻ｻ・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊ゑｽｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    isCalibrating=false; if(_calibRAF){ try{ cancelAnimationFrame(_calibRAF); }catch(_){ } _calibRAF=0; }
    calibAnchorActive=false;
    midiGhostNotes = null; drawChart(); // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(deltas.length>=4){
            // 鬯ｮ・ｯ隶灘･・ｽｽ・ｻ髦ｮ蜊搾ｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｹ陞｢・ｼ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            deltas.sort((a,b)=>a-b); const med=deltas[Math.floor(deltas.length/2)];
            // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ ~ 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽms鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｵ蠍ｺ・ｺ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?隲ｷ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
            const srLoc = (audioCtx?.sampleRate)||48000;
            const frameCenter = ((micAnalyser?.fftSize)||2048) / (2*srLoc);
            const detectBias = 0.015; // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ15ms)
            const inputBiasSec = frameCenter + 0.005 + detectBias; // 鬯ｩ蛹・ｽｽ・ｶ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ21ms + 5ms + 15ms = ~41ms @48k
            const medOut = Math.max(0, med - inputBiasSec);
            const ms=Math.round(Math.max(0, Math.min(0.5, medOut))*1000);
            const oldMs = Math.round((btLatencySec||0)*1000);
            btLatencySec = ms/1000;
            btLatencyEnabled = true;
            if(btLatencyToggle) btLatencyToggle.checked=true;
            if(btLatencySlider){ btLatencySlider.value=String(ms); btLatencySlider.disabled=false; }
            if(btLatencyValue) btLatencyValue.textContent = `${ms} ms`;
            if(btCalibStatus) btCalibStatus.textContent = `鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔・･雎撰ｽｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ${ms} ms鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陝ｶ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣郢晢ｽｻ;
            try{
                // 鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔・･雎撰ｽｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ・つ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛沺・｡・ｶ鬮ｫ・ｰ雎慕霜・ｪ・ｿ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛛・ｽｿ・ｽ?繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                setTimeout(()=>{ try{ alert(`鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?隲ｷ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔・･雎撰ｽｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽｳ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?:\n\n鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?隲ｷ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ${ms} ms\n(鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣比ｼ夲ｽｽ・｣?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ ${oldMs} ms)`); }catch(_){ } }, 0);
            }catch(_){ }
            // UI鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯ｷ螂・ｽ｣・ｰ?髯ｷ閧ｴ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢髫ｲ・､陷･雜｣・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｱ髯晢ｽｶ隰ｨ魑ｴﾂ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔・･雎撰ｽｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            drawChart();
        }else{
            if(btCalibStatus) btCalibStatus.textContent = '鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ闔ｨ諛ｶ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
            try{ setTimeout(()=>{ try{ alert('鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?隲ｷ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽn\n鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ・つ髫ｲ・､隲橸ｽｺ?繝ｻ・ｽ繝ｻ・ｽ鬯･・ｴ髴趣ｽｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ); }catch(_){ } }, 0); }catch(_){ }
            // 鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽI鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴主・遘・ｬｲ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        }
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{ seekTo(0); }catch(_){ playbackPosition=0; playbackStartPos=0; drawChart(); }
    }catch(e){
        console.warn('calibration failed',e);
        if(btCalibStatus) btCalibStatus.textContent='鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ';
    } finally {
        // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ驍ｵ・ｺ鬯伜∞・ｽ・ｿ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ髯懈圜・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        try{ if(_calibRAF) cancelAnimationFrame(_calibRAF); }catch(_){ }
        _calibRAF = 0;
        if(isCalibrating || midiGhostNotes){
            isCalibrating=false; calibAnchorActive=false; midiGhostNotes=null;
            drawChart();
        }
    }
}

// ---- 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ陷證ｦ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣鬯・汚・ｽ・ｹ陋ｹ竏晄溜郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隲・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ----
async function runLatencyAssist(){
    try{
        ensureAudio();
        if(!micAnalyser){ await initMic(false).catch(()=>{}); }
        if(isPlaying){ try{ pausePlayback(); }catch(_){ } }
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ蜿厄ｽｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?
        _assistAbort = false; isAssistMode = true; isCalibrating = true; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・皮ｹ晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ? calibrating 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ・ｯ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ・つ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const baseMidi = 60; // C4
        const spacingSec = 0.8; // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ・ｯ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const noteDurSec = 0.45;
        const startSong = (playbackPosition||0) + 0.8;
        midiGhostNotes = [];
        calibPrevPos = playbackPosition; calibBasePos = startSong;
        calibAnchorActive = true; calibAnchorTime = startSong; calibAnchorMidi = baseMidi;
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・皮ｹ晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        calibCountdownText='3'; drawChart(); setTimeout(()=>drawChart(), 0); if(btCalibStatus) btCalibStatus.textContent='鬯ｮ・ｮ郢晢ｽｻ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 3';
        await new Promise(r=>setTimeout(r,600)); calibCountdownText='2'; drawChart(); setTimeout(()=>drawChart(), 0); if(btCalibStatus) btCalibStatus.textContent='鬯ｮ・ｮ郢晢ｽｻ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 2';
        await new Promise(r=>setTimeout(r,600)); calibCountdownText='1'; drawChart(); setTimeout(()=>drawChart(), 0); if(btCalibStatus) btCalibStatus.textContent='鬯ｮ・ｮ郢晢ｽｻ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 1';
    await new Promise(r=>setTimeout(r,500)); calibCountdownText=null; drawChart(); if(btCalibStatus) btCalibStatus.textContent='鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｷ讌ｪﾂ髯ｷ謇假ｽｽ・ｰ髫ｲ・､郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    btLatencyEnabled = true; if(btLatencyToggle){ btLatencyToggle.checked = true; }
    if(btLatencySlider){ btLatencySlider.disabled = false; }
    // 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ? calibrating 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    isCalibrating = false;
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ陞ｽ・ｯ髦｡鬥ｴ・ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    if(!analysisTimer){ analysisTimer = setInterval(analyzePitch, 1000/analysisRate); }
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    pitchHistory = []; scoreSessionId++;
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ繝ｻ・ｿ・ｽ?髮趣ｽｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        calibMoveStartPerf = performance.now()/1000; calibPrevPos = playbackPosition;
        const animate = ()=>{
            if(!isAssistMode || _assistAbort) return;
            try{
                const nowP = performance.now()/1000; const dt = Math.max(0, nowP - calibMoveStartPerf);
                playbackPosition = calibPrevPos + dt; // 1x鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ蠍ｺ・ｺ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ陋滂ｽｬ?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const tNow = playbackPosition;
                const wantAhead = 8; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ驛｢譎｢・ｽ・｡?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ
                let lastTime = (midiGhostNotes.length? (midiGhostNotes[midiGhostNotes.length-1].time + midiGhostNotes[midiGhostNotes.length-1].duration) : startSong - spacingSec);
                // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髫ｲ蟷・か?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ髮｣・ｽ・｣髯句ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                const keepAfter = tNow - 5;
                if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                    while(midiGhostNotes.length && (midiGhostNotes[0].time + midiGhostNotes[0].duration) < keepAfter){ midiGhostNotes.shift(); }
                }
                // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
                while(true){
                    const futureCount = midiGhostNotes.filter(n=> n.time >= tNow - 0.1).length;
                    if(futureCount >= wantAhead) break;
                    const nextStart = (midiGhostNotes.length? (midiGhostNotes[midiGhostNotes.length-1].time + spacingSec) : (startSong));
                    midiGhostNotes.push({midi:baseMidi, time: nextStart, duration: noteDurSec, role:'calib'});
                }
                drawChart();
                _assistRAF = requestAnimationFrame(animate);
            }catch(_){ _assistRAF = requestAnimationFrame(animate); }
        };
        if(_assistRAF) cancelAnimationFrame(_assistRAF); _assistRAF = requestAnimationFrame(animate);
    }catch(e){
        console.warn('assist start failed', e);
        // 鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{ if(_assistRAF) cancelAnimationFrame(_assistRAF); }catch(_){ }
        _assistRAF=0; isAssistMode=false; isCalibrating=false; calibAnchorActive=false; midiGhostNotes=null; drawChart();
        if(btCalibStatus) btCalibStatus.textContent='鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ髫ｰ魃会ｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｲ郢ｧ髮・ｽｵ・ｯ髫ｴ謫ｾ・ｽ・ｶ?髫ｶ魃会ｽｽ・｢髫ｴ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?';
    }
}

function stopLatencyAssist(){
    try{ _assistAbort = true; if(_assistRAF){ cancelAnimationFrame(_assistRAF); } }catch(_){ }
    _assistRAF = 0; isAssistMode=false; isCalibrating=false; calibAnchorActive=false; midiGhostNotes=null; drawChart();
    if(btCalibStatus) btCalibStatus.textContent='鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
}
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯・汚・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴取得・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽndex.html鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ

// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・守｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ陋ｹ螟仙ｯ・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ騾ｹ・｣・つ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ maxMs 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 0 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function findZeroCrossOffsetSec(buf, maxMs){
    try{
        const sr = buf.sampleRate||48000;
        const chL = buf.numberOfChannels>0? buf.getChannelData(0): null;
        const chR = buf.numberOfChannels>1? buf.getChannelData(1): null;
        if(!chL) return 0;
        const maxS = Math.min(chL.length, Math.floor(sr * (maxMs||0.005)));
        // 1) 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・つ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｼ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let prev = (chL[0] + (chR? chR[0]: 0)) * (chR? 0.5: 1);
        for(let i=1;i<maxS;i++){
            const cur = (chL[i] + (chR? chR[i]: 0)) * (chR? 0.5: 1);
            if((prev<=0 && cur>0) || (prev>=0 && cur<0)){
                // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const frac = Math.abs(cur - prev) > 1e-12 ? (Math.abs(prev) / Math.abs(cur - prev)) : 0;
                const pos = (i-1) + frac; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜀ｶ・ｾ・ｨ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                return pos / sr;
            }
            prev = cur;
        }
        // 2) 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ・ｷ・つ髯ｷ莨夲ｽｽ・ｱ髫ｨ・ｳ驕擾ｽｩ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let bestI=0; let bestAbs=1e9;
        for(let i=0;i<maxS;i++){
            const vL = Math.abs(chL[i]); const vR = chR? Math.abs(chR[i]) : vL; const v = (vL + vR) * (chR? 0.5: 1);
            if(v<bestAbs){ bestAbs=v; bestI=i; if(v<1e-5) break; }
        }
        return bestI / sr;
    }catch(_){ return 0; }
}

// WAV鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽampleRate 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ smpl 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function readWavMeta(arrayBuffer){
    // RIFF/WAVE 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ "fmt " 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ "smpl" 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・｣・ｫpleRate 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ髫ｲ・､?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??
    const dv=new DataView(arrayBuffer);
    function readStr(off,len){ let s=''; for(let i=0;i<len;i++){ s+=String.fromCharCode(dv.getUint8(off+i)); } return s; }
    let meta={ sampleRate:0, loopStart:null, loopEnd:null };
    try{
        if(readStr(0,4)!=='RIFF' || readStr(8,4)!=='WAVE') return meta;
        let p=12; // chunk start
        const len=dv.byteLength;
        while(p+8<=len){
            const id=readStr(p,4); const size=dv.getUint32(p+4,true); const body=p+8; const next=body+size + (size%2);
            if(id==='fmt '){
                if(size>=16){ meta.sampleRate = dv.getUint32(body+4,true); }
            } else if(id==='smpl'){
                // https://sites.google.com/site/musicgapi/technical-documents/wav-file-format#smpl
                if(size>=36){
                    const numLoops = dv.getUint32(body+28,true);
                    let lpOff = body+36;
                    for(let i=0;i<numLoops;i++){
                        if(lpOff+24>len) break;
                        const start = dv.getUint32(lpOff+8,true);
                        const end   = dv.getUint32(lpOff+12,true);
                        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                        meta.loopStart = start; meta.loopEnd = end; break;
                    }
                }
            }
            p = next;
        }
    }catch(_){ }
    return meta;
}
// ---- Audio file loader (melody/accompaniment) ----
let melodyBuffer=null, accompBuffer=null;
let melodySource=null, accompSource=null;
let melodyDuration=0, accompDuration=0;
let melodyNotesExtracted=false;
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ
let melodyOrigBytes=null, melodyOrigName=null, melodyOrigExt=null;
let accompOrigBytes=null, accompOrigName=null, accompOrigExt=null;

async function decodeAudioFile(file){
    ensureAudio();
    const ab=await file.arrayBuffer();
    return await new Promise((res,rej)=> audioCtx.decodeAudioData(ab, b=>res(b), e=>rej(e)));
}

function stopAllSources(){
    try{ if(melodySource){ melodySource.stop(); melodySource.disconnect(); } }catch(_){ }
    try{ if(accompSource){ accompSource.stop(); accompSource.disconnect(); } }catch(_){ }
    try{ melodySources.forEach(s=>{ try{s.stop(0);}catch(_){ } try{s.disconnect();}catch(_){ } }); }catch(_){ }
    melodySources=[];
    melodySource=null; accompSource=null;
}

function createAndStartSource(buf, when, offset, destGain){
    const src=audioCtx.createBufferSource(); src.buffer=buf; src.connect(destGain);
    try{ src.start(when, Math.max(0, offset)); }catch(_){ src.start(); }
    return src;
}

// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ驕倥・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髫ｲ・､?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｫ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(NACF) + 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髯ｷ謳ｾ・ｽ・ｳ鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ + 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ2鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ) + 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ + 鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
async function extractMelodyNotesFromBuffer(buf){
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｼ夲ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const overlay=document.getElementById('analyzingOverlay');
    if(overlay){ overlay.classList.remove('hidden'); }
    const sr = buf.sampleRate;
    const ch0 = buf.getChannelData(0);
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ霑ｪ貊ゑｽｽ・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const ch1 = buf.numberOfChannels>1 ? buf.getChannelData(1) : null;
    const mono = new Float32Array(ch0.length);
    for(let i=0;i<mono.length;i++) mono[i] = ch0[i] * (ch1? 0.5: 1) + (ch1? ch1[i]*0.5 : 0);
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽy[n]=x[n]-a*x[n-1]
    try{
        const a = 0.97;
        let prev = 0;
        for(let i=0;i<mono.length;i++){
            const x = mono[i];
            mono[i] = x - a*prev;
            prev = x;
        }
    }catch(_){ }

    // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄肩・ｽ・ｺ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｩ陜難ｽｼ陞ｳ・ｦ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ邏具ｽｺ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ11.025kHz鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ､郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ雎主､ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const targetSR = 11025;
    const dsFactor = Math.max(1, Math.floor(sr/targetSR));
    const srd = sr / dsFactor; // 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・ｨ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ螟懈｡ｷR
    const dsLen = Math.floor(mono.length / dsFactor);
    const ds = new Float32Array(dsLen);
    // 鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ髣憺屮・ｽ・ｭ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ菫ｶ・｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    for(let i=0, j=0; i<dsLen; i++, j+=dsFactor){
        let sum=0; let cnt=0; for(let k=0;k<dsFactor && (j+k)<mono.length; k++){ sum+=mono[j+k]; cnt++; }
        ds[i] = sum/Math.max(1,cnt);
    }

    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ?髯ｷ閧ｴ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・ｪ?髫ｶ魃会ｽｽ・｢繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const fmin = 65;   // Hz
    const fmax = 1200; // Hz
    const desiredRate = Math.max(28, Math.min(60, (analysisRate||20)+25)); // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ60fps鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ ~90ms 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ1024,2048]鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ2鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const targetWinSec = 0.09; const targetW = Math.floor(srd*targetWinSec);
    const pow2 = (x)=> 1<<Math.round(Math.log2(Math.max(1,x)));
    const W = Math.max(1024, Math.min(2048, pow2(targetW)));
    const H = Math.max(1, Math.floor(srd/Math.max(28, desiredRate))); // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽps鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const tauMin = Math.max(2, Math.floor(srd / fmax));
    const tauMax = Math.max(tauMin+2, Math.min(Math.floor(srd / fmin), Math.floor(W*0.9)));
    // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽann鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const hann = new Float32Array(W);
    for(let n=0;n<W;n++) hann[n] = 0.5*(1-Math.cos(2*Math.PI*n/(W-1)));

    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ魃会ｽｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｼ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ2鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?髴・ｽｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const SEMI_NARROW = Math.pow(2, 2/12); // 鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ2鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    let prevFreq = 0; let prevTau = 0;

    // YIN (CMND) 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮｢ﾂ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隲・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?郢晢ｽ｡?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ
    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ frameArr 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽYinPitchTracker 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣懃§・ｸ・ｷ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｻu 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ conf 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??
    const yinTrackerOffline = (function(){
        try{
            const M = (window && window.__PitchModules) ? window.__PitchModules : null;
            if(M && M.YinPitchTracker){
                const yt = new M.YinPitchTracker({ sampleRate: srd, frameSize: W, fmin, fmax, threshold: 0.15 });
                return yt;
            }
        }catch(_){ }
        return null;
    })();
    function yinBestTauCMND(frameArr){
        try{
            if(yinTrackerOffline){
                const r = yinTrackerOffline.process(frameArr);
                // process 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ {freq, tau, conf}
                if(r && r.tau && isFinite(r.tau)){
                    return { tau: r.tau, conf: Math.max(0, Math.min(1, r.conf||0)) };
                }
                return { tau: -1, conf: 0 };
            }
        }catch(_){ }
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        return { tau: -1, conf: 0 };
    }

    // Goertzel: 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髫ｶ髮｣・ｿ・ｽ?繝ｻ・ｽ霑｢・ｭ鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽFT鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    function goertzelPower(frameArr, sr, freq){
        if(!(freq>0) || freq>=sr*0.5) return 0;
        const w = 2*Math.PI*freq/sr;
        const c = Math.cos(w);
        const coeff = 2*c;
        let s0=0, s1=0, s2=0;
        for(let n=0;n<frameArr.length;n++){
            s0 = frameArr[n] + coeff*s1 - s2;
            s2 = s1; s1 = s0;
        }
        const power = s1*s1 + s2*s2 - coeff*s1*s2; // magnitude^2
        return Math.max(0, power);
    }
    // SHS: f0 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ1..K)鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    function shsScore(frameArr, sr, f0, K){
        if(!(f0>0)) return 0;
        const maxH = Math.max(1, K|0);
        let sum=0; let used=0;
        for(let k=1;k<=maxH;k++){
            const fk = f0*k; if(fk>=sr*0.5) break;
            const p = goertzelPower(frameArr, sr, fk);
            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 1/k鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            sum += (p>0? Math.sqrt(p): 0) * (1/k);
            used++;
        }
        return used? sum/used : 0;
    }

    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ-> 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const freqs = [];
    const octHints = []; // true: 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽau0/2 or tau0*2鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陷托ｽｰ邵ｺ雋ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｺ
    const amps = [];
    const frame = new Float32Array(W);
    const NACF_BASE = 0.28; // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽMS鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯ｷ謳ｾ・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const NACF_HOLD   = 1;    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ
    let voicedHold = 0;
    let yieldCounter=0;
    const candFreqsPerFrame=[]; // Viterbi鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ繝ｻ・ｽ?雎・屮・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const candCostsPerFrame=[]; // Viterbi鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ譎｢・ｽ・ｶ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ.5鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? f/2 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽf 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛛・ｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let preferLowerOct=false; let calLowSum=0, calCurSum=0, calFrames=0; const CAL_FRAMES=Math.max(8, Math.min(64, Math.round(1.5*srd/H)));
    for(let i=0;i+W<=ds.length; i+=H){
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ + DC鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ + 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隰ｦ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let mean=0; for(let k=0;k<W;k++){ mean+=ds[i+k]; }
        mean/=W;
        let energy=0; for(let k=0;k<W;k++){ const v=(ds[i+k]-mean)*hann[k]; frame[k]=v; energy+=v*v; }
        const rms=Math.sqrt(energy/W);
        if(rms<1e-4){
            // 鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ鬮｣魃会ｽｿ・ｽ?繝ｻ・ｽ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ? Viterbi 鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ蟷｢・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣厄ｽｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            freqs.push(0); octHints.push(false); amps.push(rms);
            candFreqsPerFrame.push([0]);
            candCostsPerFrame.push([0.05]); // 鬯ｮ・ｮ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ陷證ｦ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            if((++yieldCounter % 200)===0){ await new Promise(r=>setTimeout(r,0)); }
            continue;
        }

        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隰・・・ｽ・ｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髮九ｑ・ｿ・ｽ?0鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｷ讌ｪﾂ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・､郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ1鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let searchRanges;
        if(prevFreq>0){
            const tau0 = srd/prevFreq;
            const pad=2;
            const mkRange=(center,type)=>{
                if(!(center>tauMin && center<tauMax)) return null;
                const mn=Math.max(tauMin, Math.floor(center/SEMI_NARROW) - pad);
                const mx=Math.min(tauMax, Math.ceil(center*SEMI_NARROW) + pad);
                if(mx>mn) return {min:mn, max:mx, type};
                return null;
            };
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｮ・ｮ遶乗劼・ｽ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｮ・ｮ遶乗劼・ｽ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ驕ｯ・ｶ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣騾ｧ・ｮ騾包ｽ･?繝ｻ・ｽ繝ｻ・ｽ・つ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            searchRanges = [
                mkRange(tau0, 'local'),
                mkRange(tau0*0.5, 'oct0_5'),
                mkRange(tau0*2, 'oct2')
            ].filter(Boolean);
        } else {
            searchRanges = [{min:tauMin, max:tauMax, type:'local'}];
        }

        // 鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｫ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: R(?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/sqrt(E0*E?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    let bestTau=-1, bestR=-1, bestType='local';
    let bestScore=-1; // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隰・ｹ晢ｼ・ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        // E0鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髫ｨ蜊債鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ雋ｻ・ｽ・ｺ郢ｧ謇假ｽｽ・ｾ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯伜ｪ遲・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ遨ゑｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｻ鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽｮ隴幢ｽｱ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｧ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ螟ｲ・ｽ・ｱ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬮ｮ迢暦ｽｿ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽtep=2鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ驕ｯ・ｶ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
        const coarseStep=2;
        for(const rng of searchRanges){
            const bias = (rng.type==='local')? 1.0 : 0.94; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ鬆第答郢晢ｽｻ邵ｺ・､・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?髫ｶ魃会ｽｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?
            for(let tau=rng.min; tau<=rng.max; tau+=coarseStep){
                let r=0, e0=0, e1=0;
                const N=W-tau;
                for(let n=0;n<N;n++){
                    const a=frame[n];
                    const b=frame[n+tau];
                    r += a*b; e0 += a*a; e1 += b*b;
                }
                const den = Math.sqrt(e0*e1) + 1e-12;
                const nacf = r/den;
                const score = nacf * bias;
                if(score>bestScore){ bestScore=score; bestR=nacf; bestTau=tau; bestType=rng.type; }
            }
        }
        // 鬯ｯ・ｩ陜難ｽｼ?繝ｻ・ｽ繝ｻ・ｽ驕呈汚・ｽ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔・･雎撰ｽｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ驍丞・・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ3 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬯ｮ・ｯ隰疲ｻゑｽｽ・､郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋顔§謫髯橸ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(bestTau>0){
            const t0=Math.max(tauMin, bestTau-3), t1=Math.min(tauMax, bestTau+3);
            for(let tau=t0; tau<=t1; tau++){
                let r=0,e0=0,e1=0; const N=W-tau;
                for(let n=0;n<N;n++){ const a=frame[n], b=frame[n+tau]; r+=a*b; e0+=a*a; e1+=b*b; }
                const den=Math.sqrt(e0*e1)+1e-12; const nacf=r/den; if(nacf>bestR){ bestR=nacf; bestTau=tau; }
            }
        }

        // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髯ｷ謳ｾ・ｽ・ｳ鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・ｨ髯区ｻゑｽｽ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let estTau=bestTau;
        if(bestTau>tauMin && bestTau<tauMax){
            // f(tau-1), f(tau), f(tau+1)
            const fAt = (t)=>{
                let r=0,e0=0,e1=0; const N=W-t;
                for(let n=0;n<N;n++){ const a=frame[n]; const b=frame[n+t]; r+=a*b; e0+=a*a; e1+=b*b; }
                return r/(Math.sqrt(e0*e1)+1e-12);
            };
            const ym1=fAt(bestTau-1), y0=bestR, yp1=fAt(bestTau+1);
            const denom = (ym1 - 2*y0 + yp1);
            if(Math.abs(denom)>1e-9){
                const delta = 0.5*(ym1 - yp1)/denom; // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｨ・ｳ驕擾ｽｩ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ1..+1鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                if(Math.abs(delta)<=1) estTau = bestTau + delta;
            }
        }

        const estR = bestR;
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯ｷ謳ｾ・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let nacfThresh = NACF_BASE;
        if(rms<0.008){
            nacfThresh = 0.34;
        } else if(rms>0.06){
            nacfThresh = 0.24;
        } else {
            // 0.008..0.06 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯晢ｽｶ隴擾ｽｴ?繝ｻ・ｽ?鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ.34鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ.24鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const t=(rms-0.008)/(0.06-0.008);
            nacfThresh = 0.34*(1-t) + 0.24*t;
        }
        let freq = (estR>=nacfThresh && estTau>0)? (srd/estTau) : 0;
        if(freq>0){ voicedHold = NACF_HOLD; }
        else if(voicedHold>0){ voicedHold--; freq = (prevFreq>0? prevFreq: 0); } // 鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬮ｮ荳ｻ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ苓風鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const fOK = (freq>0 && isFinite(freq))? freq: 0;
        freqs.push(fOK);
        octHints.push(bestType!=='local');
        amps.push(rms);
        if(fOK>0) { prevFreq=fOK; prevTau=estTau; } else { /* 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ隴ｴ・ｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ*/ }
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ譎｢・ｽ・ｶ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: f 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ f/2 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽSHS鬯ｮ・ｮ隰・ｹ晢ｼ・ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(calFrames<CAL_FRAMES){
            const fC=fOK; if(fC>0){
                // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隰ｦ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ frame 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ遶擾ｽｵ郢晢ｽｻ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                const shF = shsScore(frame, srd, fC, 8);
                const shL = shsScore(frame, srd, fC*0.5, 8);
                calCurSum += shF; calLowSum += shL; calFrames++;
            }
        }

        // 鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ・ｴ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽACF + 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ+ YIN + 鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const cFreqs=[]; const cCosts=[];
        if(fOK>0){
            const tauBase = Math.max(tauMin, Math.min(tauMax, estTau));
            const bRound=Math.round(tauBase);
            const tauCand = [];
            const pushTau=(t)=>{ const ti=Math.round(t); if(ti>=tauMin && ti<=tauMax) tauCand.push(ti); };
            pushTau(bRound); pushTau(bRound-1); pushTau(bRound+1);
            pushTau(tauBase/2); pushTau(tauBase*2);
            // 鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ蟷｢・ｽ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ NACF 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ SHS 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｨ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ陋滉ｻｰﾂ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｫ繝ｻ・ｽ?郢晢ｽｻ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ
            const tmpCand=[]; // {f, nacf, shs, isOct, shsNorm}
            for(const t of tauCand){
                let r=0,e0=0,e1=0; const N=W-t;
                for(let n=0;n<N;n++){ const a=frame[n], b=frame[n+t]; r+=a*b; e0+=a*a; e1+=b*b; }
                const den=Math.sqrt(e0*e1)+1e-12; const nacf=Math.max(0, Math.min(1, r/den));
                const f = srd/Math.max(1, t);
                const shs = shsScore(frame, srd, f, 8);
                const isOct = (Math.abs(t - Math.round(tauBase/2))<=1) || (Math.abs(t - Math.round(tauBase*2))<=1);
                tmpCand.push({f, nacf, shs, isOct, shsNorm:0});
            }
            // SHS 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｫ繝ｻ・ｽ?郢晢ｽｻ
            let maxShs=0; for(const c of tmpCand) if(c.shs>maxShs) maxShs=c.shs;
            const a=0.75, b=0.25; // NACF鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const tmpCost=new Array(tmpCand.length).fill(0);
            for(let i=0;i<tmpCand.length;i++){
                const ci=tmpCand[i]; ci.shsNorm = maxShs>0? (ci.shs/maxShs) : 0;
                let cost = a*(1-ci.nacf) + b*(1-ci.shsNorm);
                if(ci.isOct) cost += 0.06;
                tmpCost[i]=cost;
            }
            // f 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 2f 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｮ隰・ｹ晢ｼ・ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽower鬯ｩ蛹・ｽｽ・ｶ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽpper/2 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽower鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬩募∞・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隴ｴ・ｧ雎主､ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽupper 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ迚吝ｷｻer鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            for(let i=0;i<tmpCand.length;i++){
                for(let j=0;j<tmpCand.length;j++){
                    if(i===j) continue;
                    const fi=tmpCand[i].f, fj=tmpCand[j].f;
                    // i 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽupper, j 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽlower 鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ蟷｢・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ?髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髫ｨ蜷ｶ・具ｾ守｢托ｽｭ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?
                    if(fi>fj){
                        const rel = Math.abs(fi - 2*fj) / Math.max(1,fi);
                        const tol = preferLowerOct? 0.03 : 0.025;
                        if(rel<tol){
                            const confLower = 0.5*(tmpCand[j].nacf + tmpCand[j].shsNorm);
                            const confUpper = 0.5*(tmpCand[i].nacf + tmpCand[i].shsNorm);
                            const gap = preferLowerOct? 0.2 : 0.15;
                            const penalty = preferLowerOct? 0.32 : 0.25;
                            const reward = preferLowerOct? 0.03 : 0.02;
                            if(confLower >= confUpper - gap){ tmpCost[i]+=penalty; tmpCost[j]=Math.max(0, tmpCost[j]-reward); }
                        }
                    }
                }
            }
            for(let i=0;i<tmpCand.length;i++){ cFreqs.push(tmpCand[i].f); cCosts.push(tmpCost[i]); }
            // YIN 鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const yb = yinBestTauCMND(frame);
            if(yb && yb.tau && isFinite(yb.tau)){
                const fy = srd/Math.max(1, yb.tau);
                // YIN鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩募私・ｽ・ｰS鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｫ繝ｻ・ｽ?郢晢ｽｻ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const yShsRaw = shsScore(frame, srd, fy, 8);
                const yShs = (maxShs>0)? Math.max(0, Math.min(1, yShsRaw/maxShs)) : 0;
                const yNacf = Math.max(0, Math.min(1, yb.conf));
                const cy = a*(1 - yNacf) + b*(1 - yShs);
                cFreqs.push(fy); cCosts.push(cy);
            }
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 2f 鬯ｩ蛹・ｽｽ・ｶ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽf 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陋ｹ竏ｵ貍・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(2f)鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ(f)鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            for(let i=0;i<cFreqs.length;i++){
                for(let j=0;j<cFreqs.length;j++){
                    if(i===j) continue; const fi=cFreqs[i], fj=cFreqs[j];
                    if(fi>fj){ const rel=Math.abs(fi - 2*fj)/Math.max(1,fi); if(rel<0.03){ cCosts[i]+=0.12; cCosts[j]=Math.max(0, cCosts[j]-0.02); } }
                }
            }
        }
        // 鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿厄ｽｨ雋ｻ・ｽ・ｺ郢ｧ謇假ｽｽ・ｾ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬮ｮﾂ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const uCost = rms<0.002? 0.05 : (rms<0.01? 0.18 : 0.35);
        cFreqs.push(0); cCosts.push(uCost);
        candFreqsPerFrame.push(cFreqs);
        candCostsPerFrame.push(cCosts);
        // 200鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｵ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ郢ｽ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if((++yieldCounter % 200)===0){ await new Promise(r=>setTimeout(r,0)); }
    }

    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔・･雎撰ｽｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    if(calFrames>=8 && calLowSum > calCurSum*1.18){ preferLowerOct=true; }

    // Viterbi 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?
    const M=candFreqsPerFrame.length; const dp=new Array(M); const prv=new Array(M);
    for(let i=0;i<M;i++){ dp[i]=new Array(candFreqsPerFrame[i].length).fill(Infinity); prv[i]=new Array(candFreqsPerFrame[i].length).fill(-1); }
    for(let j=0;j<dp[0].length;j++){ dp[0][j]=candCostsPerFrame[0][j]; }
    const beta=0.12; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｨ鬮ｯ讖ｸ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ・つ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const octPenalty=1.25; // ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    for(let i=1;i<M;i++){
        const cf=candFreqsPerFrame[i], cc=candCostsPerFrame[i];
        for(let j=0;j<cf.length;j++){
            const f2=cf[j]; let best=Infinity, bestp=-1;
            for(let k=0;k<candFreqsPerFrame[i-1].length;k++){
                const f1=candFreqsPerFrame[i-1][k];
                let trans=0;
                if(f1===0 || f2===0){
                    // 鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｯ菫ｶ・ｳ魃会ｽｽ・､?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ髫ｶﾂ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷会ｽｱ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽMS鬯ｮ・｣隲幄ご陲夜匚謇假ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯伜・ｽｾ・ｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const aPrev = (amps[i-1]||0), aCur=(amps[i]||0);
                    const aMax = Math.max(aPrev, aCur);
                    const aMin = Math.min(aPrev, aCur);
                    if(aMax<0.008){ trans=0.08; }
                    else if(aMin<0.006){ trans=0.14; }
                    else { trans=0.28; }
                }
                else{
                    const dSemi = Math.abs(12*Math.log2(f2/f1));
                    const nearOct = Math.min(Math.abs(dSemi-12), Math.abs(dSemi-24));
                    trans = beta*dSemi + (nearOct<0.7? octPenalty: 0);
                    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ驍丞・・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ6鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?
                    if(dSemi<=6) trans -= 0.03; else if(dSemi<12) trans += 0.03;
                }
                const cost = dp[i-1][k] + cc[j] + trans;
                if(cost<best){ best=cost; bestp=k; }
            }
            dp[i][j]=best; prv[i][j]=bestp;
        }
    }
    // 鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    let last=0; { let minv=Infinity; for(let j=0;j<dp[M-1].length;j++){ if(dp[M-1][j]<minv){ minv=dp[M-1][j]; last=j; } } }
    const vF=new Array(M).fill(0); for(let i=M-1;i>=0;i--){ vF[i]=candFreqsPerFrame[i][last]; last=prv[i][last]>=0? prv[i][last]: 0; }
    let ftrack = vF;
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・｢髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    (function(){
        const L=ftrack.length; if(L<3) return;
        const midis=new Array(L).fill(null);
        for(let i=0;i<L;i++){ const f=ftrack[i]; midis[i]=(f>0&&isFinite(f))? 69+12*Math.log2(f/A4Frequency) : null; }
        const base=new Array(L).fill(null);
        const win=2; // 5鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        for(let i=0;i<L;i++){
            const vals=[]; for(let k=-win;k<=win;k++){ const j=i+k; if(j>=0&&j<L){ const m=midis[j]; if(m!=null) vals.push(m); } }
            if(vals.length){ vals.sort((a,b)=>a-b); base[i]=vals[(vals.length-1)>>1]; }
        }
    const maxRun=4; // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・｢髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ16鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let s=0; while(s<L){
            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ9鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            while(s<L){ const b=base[s]; const m=midis[s]; if(b!=null&&m!=null&&Math.abs(m-b)>=9) break; s++; }
            if(s>=L) break; let e=s; while(e<L){ const b=base[e]; const m=midis[e]; if(!(b!=null&&m!=null&&Math.abs(m-b)>=9)) break; e++; }
            const runLen=e-s; if(runLen>1 && runLen<=maxRun){
                // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                const ref = base[s>0? s-1: (e<L? e: s)];
                if(ref!=null){
                    for(let i=s;i<e;i++){
                        if(midis[i]==null) continue; let mi=midis[i];
                        while(mi - ref > 6) mi -= 12; while(ref - mi > 6) mi += 12; midis[i]=mi;
                    }
                }
            }
            s=e+1;
        }
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ?
        for(let i=0;i<L;i++){ const m=midis[i]; if(m!=null){ ftrack[i]=A4Frequency*Math.pow(2,(m-69)/12); } }
    })();

    // SHS 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ/2 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽf 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟・ｽｼ諛ｶ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    (function(){
        const L=ftrack.length; if(L<4) return;
        const winMs = preferLowerOct? 300 : 260;
        const winFrames=Math.max(4, Math.min(28, Math.round((winMs/1000)*srd/H)));
        const threshRatio = preferLowerOct? 1.15 : 1.25; // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ陋ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ諛・ｽｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const minRun = preferLowerOct? 4 : 5; // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const indicesDown=new Array(L).fill(false);
        let lowSum=0, curSum=0; const bufFrame=new Float32Array(W);
        const getFrame=(idx)=>{
            const start = idx*H; if(start+W>ds.length) return null;
            // DC鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ + 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            let mean=0; for(let k=0;k<W;k++){ mean+=ds[start+k]; }
            mean/=W; let e=0; for(let k=0;k<W;k++){ const v=(ds[start+k]-mean)*hann[k]; bufFrame[k]=v; e+=v*v; }
            return Math.sqrt(e/W);
        };
        const shsAt=(idx, f)=>{ if(!(f>0)&&isFinite(f)) return 0; const rms=getFrame(idx); if(!rms || rms<1e-5) return 0; return shsScore(bufFrame, srd, f, 8); };
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ驛｢譎｢・ｽ・｡?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ陞ｽ・ｯ隴・ｽ｡鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｴ隰悟･・ｽｽ・ｭ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        for(let i=0;i<Math.min(L,winFrames);i++){ const f=ftrack[i]; if(f>0){ curSum += shsAt(i, f); if(f*0.5>0) lowSum += shsAt(i, f*0.5); } }
        let run=0; const mark=(i)=>{ indicesDown[i]=true; };
        for(let i=0;i<L;i++){
            // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(curSum>0 && lowSum > curSum*threshRatio){ run++; if(run>=minRun) mark(i); } else { run=0; }
            // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const outIdx=i; const inIdx=i+winFrames; // out=鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ in=鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(outIdx<L){ const f=ftrack[outIdx]; if(f>0){ const sCur=shsAt(outIdx,f); const sLow=shsAt(outIdx,f*0.5); curSum-=sCur; lowSum-=sLow; } }
            if(inIdx<L){ const f=ftrack[inIdx]; if(f>0){ const sCur=shsAt(inIdx,f); const sLow=shsAt(inIdx,f*0.5); curSum+=sCur; lowSum+=sLow; } }
        }
        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・｢髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｺ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let s=0; while(s<L){ while(s<L && !indicesDown[s]) s++; if(s>=L) break; let e=s; while(e<L && indicesDown[e]) e++; if(e-s>=minRun){ for(let i=s;i<e;i++){ ftrack[i]/=2; } } s=e; }
    })();

    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ鬆第答?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･髫ｨ・ｳ驕擾ｽｩ・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ驍丞・・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ怜･・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟・ｽｿ・ｶ遶企ｷｹ・ｫ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ7鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    (function(){
        const L=ftrack.length; if(L<3) return;
        const midi = new Array(L).fill(null);
        for(let i=0;i<L;i++){ const f=ftrack[i]; midi[i]=(f>0&&isFinite(f))? 69+12*Math.log2(f/A4Frequency) : null; }
        const base=new Array(L).fill(null);
        const win = Math.max(6, Math.min(14, Math.round((0.22*srd)/H))); // ~220ms 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闕ｳ・ｻ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const getMed=(arr)=>{ const v=arr.slice().sort((a,b)=>a-b); const n=v.length; return n? v[(n-1)>>1]: null; };
        for(let i=0;i<L;i++){
            const vals=[]; for(let k=-win;k<=win;k++){ const j=i+k; if(j>=0&&j<L){ const m=midi[j]; if(m!=null) vals.push(m); } }
            base[i]=vals.length? getMed(vals): null;
        }
        for(let i=0;i<L;i++){
            if(midi[i]==null || base[i]==null) continue; let m=midi[i], b=base[i];
            while(m - b > 7.0) m-=12; while(b - m > 7.0) m+=12; midi[i]=m;
        }
        for(let i=0;i<L;i++){ const m=midi[i]; if(m!=null){ ftrack[i]=A4Frequency*Math.pow(2,(m-69)/12); } }
    })();

    // 鬯ｮ・｣驕呈汚・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽMA鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ鬆第答鬮ｯ譎｢・｣・ｰ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隴ｽ雋ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    (function(){
        const L=ftrack.length; if(L<3) return;
        let mRef=null; const alpha=0.12; // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋顔§謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const allowJump=8.5; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴取得・ｽ・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        for(let i=0;i<L;i++){
            const f=ftrack[i]; if(!(f>0)&&isFinite(f)) continue;
            let m = 69+12*Math.log2(f/A4Frequency);
            if(mRef==null){ mRef=m; continue; }
            // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ mRef 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩包ｽｶ陜灘ｼｱﾎ馴寰蜿厄ｽｨ謚ｵ・ｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            while(m - mRef > 6) m -= 12; while(mRef - m > 6) m += 12;
            // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螢ｺ謇ｱ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            if(Math.abs(m - mRef) > allowJump){ if(m > mRef) m -= 12; else m += 12; }
            // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ?
            ftrack[i] = A4Frequency*Math.pow(2,(m-69)/12);
            // EMA 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ騾ｹ・｣・つ髯ｷ謇假ｽｽ・ｰ髫ｶﾂ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            mRef = (1-alpha)*mRef + alpha*m;
        }
    })();

    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽiterbi: 鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?5鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ隴ｴ・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    (function(){
        const L=ftrack.length; if(L<5) return;
        const midi=new Array(L).fill(null);
        for(let i=0;i<L;i++){ const f=ftrack[i]; midi[i]=(f>0&&isFinite(f))? 69+12*Math.log2(f/A4Frequency) : null; }
        const out=midi.slice();
        for(let i=2;i<L-2;i++){
            if(midi[i]==null) continue;
            const win=[]; for(let k=-2;k<=2;k++){ const v=midi[i+k]; if(v!=null) win.push(v); }
            if(win.length<3) continue;
            win.sort((a,b)=>a-b);
            const med = win[(win.length-1)>>1];
            if(Math.abs(med - midi[i]) <= 1.2){ out[i]=med; }
        }
        for(let i=0;i<L;i++){ const m=out[i]; if(m!=null){ ftrack[i]=A4Frequency*Math.pow(2,(m-69)/12); } }
    })();

    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闕ｵ蜉ｱ窶ｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const notes=[];
    const idxToTime = (idx)=> idx*H/srd;
    const MIN_NOTE_SEC = 0.07; // 64鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ郢晢ｽｻ髣憺屮・ｽ・ｭ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陋滂ｽｬ・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髯滓得・ｽ・ｩ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｻ・ｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ0ms鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const HOLD_FRAMES = 2;     // 2鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕呈汚・ｽ・ｿ陞｢・ｼ鬮ｮﾂ繝ｻ・ｽ?郢晢ｽｻ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let curMidi=null, curStart=0; let changeStreak=0; let lastMidiRounded=null;
    for(let i=0;i<ftrack.length;i++){
        const f=ftrack[i]; const t=idxToTime(i);
        if(f<=0){
            // 鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(curMidi!=null){ const dur=t-curStart; if(dur>0){ notes.push({midi:curMidi, time:curStart, duration:dur}); } curMidi=null; }
            changeStreak=0; lastMidiRounded=null; continue;
        }
        // MIDI鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ驍丞・・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ6鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let midiFloat=69+12*Math.log2(f/A4Frequency);
        if(curMidi!=null){
            while(midiFloat - curMidi > 6) midiFloat -= 12;
            while(curMidi - midiFloat > 6) midiFloat += 12;
        }
        const rounded = Math.round(midiFloat);
        if(curMidi==null){
            curMidi=rounded; curStart=t; changeStreak=0; lastMidiRounded=rounded;
        } else {
            if(rounded!==curMidi){
                if(lastMidiRounded===rounded){ changeStreak++; } else { changeStreak=1; lastMidiRounded=rounded; }
                if(changeStreak>=HOLD_FRAMES){
                    // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const dur=t-curStart; if(dur>0){ notes.push({midi:curMidi, time:curStart, duration:dur}); }
                    curMidi=rounded; curStart=t; changeStreak=0;
                }
            } else {
                changeStreak=0; lastMidiRounded=rounded;
            }
        }
    }
    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(curMidi!=null){ const endT = idxToTime(ftrack.length); const dur=endT-curStart; if(dur>0){ notes.push({midi:curMidi, time:curStart, duration:dur}); } }

    // 鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・ｨ髯区ｻゑｽｽ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｶ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓幢ｾつ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ陞ｳ・｣邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?遶包ｽｧ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ陝・ｈ縺檎ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const merged=[];
    for(const n of notes){
        if(!merged.length){ merged.push(n); continue; }
        const prev=merged[merged.length-1];
        if(n.midi===prev.midi && (n.time - (prev.time+prev.duration))<0.02){
            // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣逧ｮ逕･髯ｦ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
            prev.duration = (n.time + n.duration) - prev.time;
        } else if(n.duration<MIN_NOTE_SEC && Math.abs(n.midi - prev.midi)<=1 && (n.time - (prev.time+prev.duration))<0.03){
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ陋帶・・ｿ・ｽ?繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            prev.duration = (n.time + n.duration) - prev.time;
        } else {
            merged.push(n);
        }
    }

    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ-鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ-A鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const cleaned=[];
    for(let i=0;i<merged.length;i++){
        if(i>0 && i<merged.length-1){
            const a=merged[i-1], b=merged[i], c=merged[i+1];
            const gapAB = b.time - (a.time + a.duration);
            const gapBC = c.time - (b.time + b.duration);
            if(b.duration < Math.min(0.06, MIN_NOTE_SEC) && a.midi===c.midi && Math.abs(b.midi - a.midi) <= 1 && gapAB < 0.03 && gapBC < 0.03){
                // a 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽc 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?隲ｷ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ? 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ c 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                a.duration = (c.time + c.duration) - a.time;
                i++; // c 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                continue; // b 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            }
        }
        cleaned.push(merged[i]);
    }

    // ---- 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ鬆第答?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ關灘ｹ・ｽｭ・ｯ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ----
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷供・ｮ・｣・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つIDI鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ鬯・汚・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ6鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏晢ｽｱ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・ｨ髯区ｻゑｽｽ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ雎撰ｽｺ鬯ｲ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ1.8 or <0.55鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const clampMidiMin=36, clampMidiMax=127;
    const timeToIdx=(t)=> Math.max(0, Math.min(ftrack.length-1, Math.round(t*srd/H)));
    const safeMidi=(m)=> Math.max(clampMidiMin, Math.min(clampMidiMax, m));
    const med = (arr)=>{ const v=arr.slice().sort((a,b)=>a-b); const L=v.length; if(!L) return 0; return (L%2)? v[(L-1)>>1] : 0.5*(v[L/2-1]+v[L/2]); };
    const noteMedFreq=[]; const noteMedMidi=[];
    for(const n of cleaned){
        const i0=timeToIdx(n.time), i1=timeToIdx(n.time+n.duration);
        const vals=[]; for(let i=i0;i<=i1;i++){ const f=ftrack[i]; if(f>0&&isFinite(f)) vals.push(f); }
        const mf = vals.length? med(vals): (A4Frequency*Math.pow(2,(n.midi-69)/12));
        noteMedFreq.push(mf);
        noteMedMidi.push(69+12*Math.log2(mf/A4Frequency));
    }
    // ---- 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽHS鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ/2, f, 2f 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｾ驍ｵ・ｺ鬯･・ｴ隲､・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽHS鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ---
    (function(){
        const bufFrame=new Float32Array(W);
        const buildFrame=(fi)=>{
            const start=fi*H; if(start+W>ds.length) return null;
            let mean=0; for(let k=0;k<W;k++){ mean+=ds[start+k]; }
            mean/=W; let e=0; for(let k=0;k<W;k++){ const v=(ds[start+k]-mean)*hann[k]; bufFrame[k]=v; e+=v*v; }
            return Math.sqrt(e/W);
        };
        const shsAt=(fi, f0)=>{ if(!(f0>0)&&isFinite(f0)) return 0; const rms = buildFrame(fi); if(!rms || rms<1e-5) return 0; return shsScore(bufFrame, srd, f0, 8); };
        for(let ni=0; ni<cleaned.length; ni++){
            const m0 = noteMedMidi[ni]; const f0 = noteMedFreq[ni]; if(!(f0>0)&&isFinite(f0)) continue;
            const i0=timeToIdx(cleaned[ni].time), i1=timeToIdx(cleaned[ni].time+cleaned[ni].duration);
            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ髮｣・ｽ・｣髯句ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣陜難ｽｼ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            let sHalf=0, sBase=0, sDouble=0; const step=Math.max(1, Math.floor((i1-i0+1)/24));
            for(let fi=i0; fi<=i1; fi+=step){ sBase += shsAt(fi, f0); sHalf += shsAt(fi, f0*0.5); sDouble += shsAt(fi, f0*2); }
            const best = (sHalf>=sBase && sHalf>=sDouble)? -12 : ((sDouble>=sBase && sDouble>=sHalf)? +12 : 0);
            if(best!==0){ noteMedMidi[ni] = m0 + best; }
        }
    })();

    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽitch class鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・｣鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    (function(){
        const hist=new Array(12).fill(0);
        for(const m of noteMedMidi){ if(isFinite(m)){ const pc=((Math.round(m)%12)+12)%12; hist[pc]++; } }
        const order=[...hist.keys()].sort((a,b)=>hist[b]-hist[a]);
        const topPCs=order.slice(0,3);
        // 鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ{floor, round, ceil} 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ-cand| - bias 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｷ讌ｪﾂ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髮朱ｯ会ｽｽ・｣鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??
        function pickWithBias(m){
            const cands=[Math.floor(m), Math.round(m), Math.ceil(m)];
            let best=cands[0], bestScore=1e9;
            for(const c of cands){
                const pc=((c%12)+12)%12;
                let bias=0; // 鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                if(pc===topPCs[0]) bias=0.10; else if(pc===topPCs[1]) bias=0.06; else if(pc===topPCs[2]) bias=0.03;
                const score=Math.abs(m - c) - bias;
                if(score<bestScore){ bestScore=score; best=c; }
            }
            return best;
        }
        for(let i=0;i<noteMedMidi.length;i++){ noteMedMidi[i]=pickWithBias(noteMedMidi[i]); }
    })();
    const outM=[]; for(let i=0;i<cleaned.length;i++){ outM.push(Math.round(noteMedMidi[i])); }
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽDP鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽｳ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    if(strictOctaveMode && outM.length>=2){
        // 鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｨ・ｬ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽK 鬯ｩ蛹・ｽｽ・ｶ髣包ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ{-24, -12, 0, +12, +24}
        const Kcands=[-24,-12,0,12,24];
        const N=outM.length; const M=Kcands.length;
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ雎撰ｽｺ鬯ｲ閧ｴ諷｣?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｶ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ驕ｯ・ｶ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ雎撰ｽｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ+ ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ遨ゑｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const dp=new Array(N); const prv=new Array(N);
        for(let i=0;i<N;i++){ dp[i]=new Array(M).fill(Infinity); prv[i]=new Array(M).fill(-1); }
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ霑ｴ・ｾ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const ratios=new Array(N).fill(1);
        for(let i=1;i<N;i++){
            const r = (noteMedFreq[i-1]>0 && noteMedFreq[i]>0)? (noteMedFreq[i]/noteMedFreq[i-1]) : 1;
            ratios[i] = r;
        }
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        function localCost(i, kIdx){
            const K = Kcands[kIdx];
            // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽf/2 or 2f鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ鬮｣諛ｶ・ｽ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ馴寰蜿厄ｽｨ謚ｵ・ｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｰ・ｨ鬲托ｽｴ・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ0鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            // noteMedFreq[i] 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ證ｦ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬩､・ｴ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ K鬯ｩ蛹・ｽｽ・ｶ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ0 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            let cost = 0;
            if(K!==0) cost += 0.12; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷会ｽｱ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            return cost;
        }
        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        function transCost(i, kFrom, kTo){
            const K1=Kcands[kFrom], K2=Kcands[kTo];
            const m1=outM[i-1]+K1, m2=outM[i]+K2;
            const dSemi = Math.abs(m2 - m1);
            // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ雎撰ｽｺ鬯ｲ閧ｴ諷｣?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
            const r = ratios[i]; const allowOct = (r>1.8 || r<0.55);
            let cost = 0.10 * dSemi; // 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ雎撰ｽｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            // ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽallowOct 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const nearOct = Math.min(Math.abs(dSemi-12), Math.abs(dSemi-24));
            if(nearOct<0.6){ cost += allowOct? 0.05 : 1.1; }
            // 鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            if(dSemi<=6) cost -= 0.03;
            return cost;
        }
        // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        for(let k=0;k<M;k++){ dp[0][k] = localCost(0,k); prv[0][k]=-1; }
        // 鬯ｮ・ｮ陋ｹ・ｺ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        for(let i=1;i<N;i++){
            for(let k2=0;k2<M;k2++){
                let best=Infinity, bestp=-1; const lc=localCost(i,k2);
                for(let k1=0;k1<M;k1++){
                    const tc=transCost(i,k1,k2);
                    const c = dp[i-1][k1] + lc + tc;
                    if(c<best){ best=c; bestp=k1; }
                }
                dp[i][k2]=best; prv[i][k2]=bestp;
            }
        }
        // 鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        let last=0; { let minv=Infinity; for(let k=0;k<M;k++){ if(dp[N-1][k]<minv){ minv=dp[N-1][k]; last=k; } } }
        const Ksel=new Array(N).fill(0);
        for(let i=N-1;i>=0;i--){ Ksel[i]=Kcands[last]; last = (prv[i][last]>=0)? prv[i][last] : 0; }
        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        for(let i=0;i<N;i++){ outM[i] = safeMidi(outM[i] + Ksel[i]); }
    } else {
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯憺屮・ｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隰ｦ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢・つ鬯ｮ・ｮ・つ鬯ｮ・ｯ隰疲ｻゑｽｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        for(let i=1;i<outM.length;i++){
            const r = noteMedFreq[i-1]>0? (noteMedFreq[i]/noteMedFreq[i-1]) : 1;
            const allowOct = (r>1.8 || r<0.55);
            if(!allowOct){
                // ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ6 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・｢?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                while(outM[i] - outM[i-1] > 6) outM[i]-=12;
                while(outM[i-1] - outM[i] > 6) outM[i]+=12;
            }
            outM[i]=safeMidi(outM[i]);
        }
    }
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・｣髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｵ諤懈溜驕ｶ荳橸ｽ､遏ｳ遒托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣比ｼ夲ｽｽ・ｰ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｿ・ｽ?鬯ｯ貊ゑｽｽ・ｭ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蝣ｺ・ｸ讖ｸ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    (function(){
        if(cleaned.length<=1) return;
        const PHRASE_GAP_SEC = 0.26; // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?
        const phrases=[]; let sIdx=0;
        for(let i=1;i<cleaned.length;i++){
            const prev=cleaned[i-1]; const cur=cleaned[i];
            const gap = cur.time - (prev.time + prev.duration);
            if(gap >= PHRASE_GAP_SEC){ phrases.push({s:sIdx, e:i-1}); sIdx=i; }
        }
        phrases.push({s:sIdx, e:cleaned.length-1});
        if(phrases.length<=1) return;
        const medInt=(arr)=>{ const v=arr.slice().sort((a,b)=>a-b); const n=v.length; return n? v[(n-1)>>1] : 0; };
        const Kcands=[-24,-12,0,12,24];
        const p0=phrases[0]; let prevAnchor=medInt(outM.slice(p0.s,p0.e+1)); let prevLast=outM[p0.e];
        for(let pi=1; pi<phrases.length; pi++){
            const ph=phrases[pi]; const seg=outM.slice(ph.s, ph.e+1); if(!seg.length) continue;
            const mFirst=seg[0]; const mMed=medInt(seg);
            let bestK=0, bestCost=1e9;
            for(const K of Kcands){
                const d1=Math.abs((mFirst+K) - prevLast);
                const d2=Math.abs((mMed+K) - prevAnchor);
                const cost=1.2*d1 + 1.0*d2; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                if(cost<bestCost){ bestCost=cost; bestK=K; }
            }
            if(bestK!==0){ for(let i=ph.s;i<=ph.e;i++){ outM[i]=safeMidi(outM[i]+bestK); } }
            prevAnchor=medInt(outM.slice(ph.s, ph.e+1)); prevLast=outM[ph.e];
        }
    })();
    for(let i=0;i<cleaned.length;i++){ cleaned[i].midi = outM[i]; }
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜍溪酪隰・ｽｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const finalNotes=[]; for(const n of cleaned){ if(!finalNotes.length){ finalNotes.push(n); continue; } const p=finalNotes[finalNotes.length-1]; if(n.midi===p.midi && n.time <= p.time+p.duration+0.03){ p.duration = Math.max(p.duration, (n.time+n.duration) - p.time); } else { finalNotes.push(n); } }

    currentTracks=[{name:'Melody', notes: finalNotes}];
    melodyTrackIndex=0; accompTrackIndexes=[]; melodyNotesExtracted=true;
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷会ｽｱ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｫ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隰疲ｻゑｽｽ・ｳ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    autoCenterFrozen = false;
    autoCenterMelodyTrack();
    drawChart();
    if(overlay){ overlay.classList.add('hidden'); }
}

// 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隰・・・ｽ・｣郢晢ｽｻ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陷･譁懃｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ / 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髮狗甥謌溯怎・ｵ髫ｲ・､?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
window.dumpFirstNotes=function(track=0,count=20){ if(!currentTracks[track]){ console.log('no track',track); return; } const arr=currentTracks[track].notes.slice(0,count).map(n=>({midi:n.midi,time:n.time,dur:n.duration,_t:n._timeSec,_d:n._durSec,ticks:n.ticks,durTicks:n.durationTicks})); console.table(arr); };
window.toggleSynth=function(flag){ usePianoSynth=flag; console.log('usePianoSynth=',usePianoSynth); };
window.toggleSamplePiano=function(flag){ useSamplePiano=flag; console.log('useSamplePiano=',useSamplePiano); if(useSamplePiano) loadPianoSamples(); };
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢髫ｲ・､?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ鬩怜遜・ｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ (鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)
// 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・＠?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ陷驤ｴ諠ｧ髫ｲ・､郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
window.ENABLE_FALLBACK_TONE = false;
function ensureAtLeastOneTestTone(){
    if(!audioCtx) return;
    if(scheduledCounter>0) return;
    if(!window.ENABLE_FALLBACK_TONE) return; // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        const osc=audioCtx.createOscillator();
        const g=audioCtx.createGain();
        osc.type='sine';
        osc.frequency.value=440;
        g.gain.setValueAtTime(0.001,audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.3,audioCtx.currentTime+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.6);
        osc.connect(g);
        g.connect(masterGain||audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime+0.62);
        console.warn('Fallback test tone scheduled (no notes were queued).');
    }catch(e){ console.warn('Fallback tone failed',e); }
}
function midiToFreq(m){ return A4Frequency*Math.pow(2,(m-69)/12); }
function seekTo(sec){
    sec=Math.max(0,Math.min(sec,getSongDuration()));
    playbackPosition=sec; playbackStartPos=sec;
    scheduleAll();
    if(isPlaying){ resyncAfterSeek('seekTo'); } else { drawChart(); }
}
function seekRelative(d){ seekTo(playbackPosition+d); }
function getSongDuration(){
    // NaN鬯ｮ・ｮ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ陷證ｦ・ｽ・｢遶乗剌・ｯ・ｰ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let max=0; let any=false;
    try{
        (currentTracks||[]).forEach(t=>{
            const notes=(t&&t.notes)||[]; if(!notes.length) return;
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞溯ｲｫﾂ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ髫ｲ・､?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            for(const n of notes){
                const st=Number(n?.time); const du=Number(n?.duration);
                if(isFinite(st) && isFinite(du)){
                    any=true; const end=st+du; if(end>max) max=end;
                }
            }
        });
        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・守｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・､鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(melodyBuffer){ max=Math.max(max, melodyBuffer.duration||0); any=true; }
        try{
            if(Array.isArray(melodyParts)){
                for(const p of melodyParts){ if(p && p.buffer){ max=Math.max(max, p.buffer.duration||0); any=true; } }
            }
        }catch(_){ }
        if(accompBuffer){ max=Math.max(max, accompBuffer.duration||0); any=true; }
    }catch(_){ }
    return any? max: 0;
}
// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陷･譁懃｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髦ｮ蜊搾ｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
try{
    if(navigator.mediaDevices && navigator.mediaDevices.addEventListener){
        navigator.mediaDevices.addEventListener('devicechange', ()=>{
            try{ canInitMicWithoutPrompt().then(ok=>{ if(ok){ initMic(false).catch(()=>{}); } }); }catch(_){ }
        });
    }
}catch(_){ }
// ---- Pan ----
if(chartCanvas){ chartCanvas.onmousedown=e=>{ isPanning=true; panStartX=e.clientX; panStartOffset=timelineOffsetSec; }; }
window.onmousemove=e=>{ if(isPanning && !isAdjustingVOffset){ const dx=e.clientX-panStartX; timelineOffsetSec=panStartOffset-dx/pxPerSec; drawChart(); }};
window.onmouseup=()=>{ if(isPanning){ applyPanCommit(); isPanning=false; }};
function applyPanCommit(){
    if(timelineOffsetSec===0) return;
    playbackPosition+=timelineOffsetSec; if(playbackPosition<0) playbackPosition=0;
    playbackStartPos=playbackPosition; timelineOffsetSec=0; scheduleAll();
    if(isPlaying){
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ雜｣・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髴難ｽ｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋贋ｼ夲ｽｽ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ+ 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｶ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬩募争豎・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        pausePlayback(); startPlayback();
        try{ if(typeof resyncAfterSeek==='function') resyncAfterSeek('pan-commit'); }catch(_){ }
    } else {
        drawChart();
    }
}
// 鬯ｮ・ｮ隴幢ｽｱ?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
function updateTimelineScrollRange(){
    if(!timelineScroll) return;
    const dur = getSongDuration();
    const viewSec = (chartCanvas && chartCanvas.width)? (chartCanvas.width/pxPerSec) : 0;
    const max = Math.max(0, dur - viewSec);
    timelineScroll.min = '0';
    timelineScroll.max = String(max.toFixed(2));
    timelineScroll.step = '0.01';
    const playXS = (chartCanvas && chartCanvas.width)? getPlayX(chartCanvas.width) : 70;
    const left = Math.max(0, Math.min(max, (playbackPosition + timelineOffsetSec) - (playXS/pxPerSec)));
    timelineScroll.value = String(left.toFixed(2));
}
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
timelineScroll && (timelineScroll.oninput = () => {
    const x = parseFloat(timelineScroll.value)||0;
    const playXS = (chartCanvas && chartCanvas.width)? getPlayX(chartCanvas.width) : 70;
    const playXSec = playXS/pxPerSec; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ(鬯ｯ・ｩ陷肴ｷ楪?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const newEff = x + playXSec; // eff = playbackPosition + timelineOffsetSec
    const delta = newEff - (playbackPosition + timelineOffsetSec);
    timelineOffsetSec += delta;
    drawChart();
    if(isPlaying) resyncAfterSeek('scrollbar');
});
// ---- Markers ----
Object.keys(markerCfg).forEach(k=>{ const [s,p]=markerCfg[k]; const sb=$(s),pb=$(p); if(sb) sb.onclick=()=> markers[k]=playbackPosition; if(pb) pb.onclick=()=>{ if(markers[k]!=null) seekTo(markers[k]); }; });
// ---- Pitch ----
function analyzePitch(){
    const nowMs = (typeof performance!=='undefined' && performance.now)? performance.now() : Date.now();
    try{ if(audioCtx && audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{}); } }catch(_){ }
    if(!micAnalyser||!micData) return;
    try{ micAnalyser.getFloatTimeDomainData(micData); }catch(_){ return; }
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ髴取ｻゑｽｽ・ｶMS鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    let rms=0; for(let i=0;i<micData.length;i++) rms+=micData[i]*micData[i]; rms=Math.sqrt(rms/Math.max(1,micData.length));
    const db=20*Math.log10(Math.max(1e-9,rms));
    if(micLevelBar){ const norm=Math.min(1,Math.max(0,(db+60)/60)); micLevelBar.style.width=(norm*100)+'%'; }
    if(micDbText){ micDbText.textContent=db.toFixed(1)+' dB'; }
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋企屮・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｧ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ鬯･・ｴ・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let gateDbEff = gateThreshold;
    if(IS_MOBILE && !IS_MOBILE_PCPIPE){
        try{
            const alpha = 0.02; // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽEMA鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜍溪酪隰・ｽｱ髴難ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?鬯ｯ蛟ｬ・ｯ莨夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽdB鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ雋牙私・ｽ・ｨ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ+3dB鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛δｧ陷ｿ蜻ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髫ｶ髮｣・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(db <= _mobileNoiseDb + 3){
                _mobileNoiseDb = (1-alpha)*_mobileNoiseDb + alpha*db;
            }
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｨ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ鬮｣魃会ｽｿ・ｽ?繝ｻ・ｽ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隲・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ騾ｹ・｣・つ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ80dB鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ20dB鬯ｯ・ｩ陟・屮・ｽ・ｧ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ螟ｲ・ｽ・ｱ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(!Number.isFinite(_mobileNoiseDb)) _mobileNoiseDb = -60;
            _mobileNoiseDb = Math.max(-80, Math.min(-20, _mobileNoiseDb));
            const margin = 8; // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ+8dB 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            gateDbEff = Math.max(gateThreshold, _mobileNoiseDb + margin);
        }catch(_){ gateDbEff = gateThreshold; }
    }
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?髴・ｽｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ?/鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ髢ｾ・･?繝ｻ・ｽ繝ｻ・ｽ陷驤ｴ諠ｧ髫ｲ・､郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        if(db < -55){ _micSilentFrames++; } else { _micSilentFrames=0; }
        const thresholdFrames = Math.max(analysisRate*2, 60); // 鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｷ楪?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(_micSilentFrames>thresholdFrames && !_micReinitInFlight){
            _micReinitInFlight=true; _micSilentFrames=0;
            setTimeout(async()=>{ try{ await initMic(false).catch(()=>{}); }finally{ _micReinitInFlight=false; } }, 0);
        }
    }catch(_){ }
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髮朱ｯ会ｽｽ・｣鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ鬩包ｽｨ陞ｳ・｣邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ髦｡鬥ｴ・ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ・つ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(typeof analyzePitch._gateOpen==='undefined') analyzePitch._gateOpen=false;
    if(typeof analyzePitch._gateOpenedAt==='undefined') analyzePitch._gateOpenedAt=0;
    let gateToUse = gateDbEff;
    if(IS_MOBILE && !IS_MOBILE_PCPIPE){ if(analyzePitch._gateOpen){ gateToUse = gateDbEff - 3; } }
    if(db<gateToUse) {
        // 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｻ・ｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陞ｳ闌ｨ・ｽ・ｿ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｶ陞ｳ闌ｨ・ｽ・ｿ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ髮｣・ｽ・ｻ驕擾ｽｩ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢鬮｢・ｼ郢ｧ螂・ｽ｣・ｰ郢晢ｽｻ・ゑｽｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
        let flat=true; for(let i=0;i<micData.length;i++){ if(micData[i]!==0){ flat=false; break; } }
        if(flat){
            _micFlatFrames++;
            const now=performance.now?performance.now():Date.now();
            if(_micFlatFrames>30 && now - _micLastReinitAt > 1500){ // 鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ.6鬯ｯ・ｩ陷肴ｷ楪?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                _micLastReinitAt=now; _micFlatFrames=0; setTimeout(()=>{ try{ initMic(false).catch(()=>{}); }catch(_){ } }, 0);
            }
        } else { _micFlatFrames=0; }
        analyzePitch._gateOpen=false;
        return;
    }
    if(!analyzePitch._gateOpen){
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣騾搾ｽｲ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜款?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        analyzePitch._gateOpenedAt = nowMs;
    }
    analyzePitch._gateOpen=true;
    const onsetActive = (IS_MOBILE && !IS_MOBILE_PCPIPE) && (nowMs - (analyzePitch._gateOpenedAt||0) <= 180);

    // --- New YIN pipeline (optional) ---
    try{
        if(USE_YIN_TRACKER && _yinTracker && micData){
            const r = _yinTracker.process(micData);
            let rawFreq = (r && r.freq) || 0;
            let rawConf = (r && r.conf) || 0;
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?: 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・｢髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const confMin = (IS_MOBILE && !IS_MOBILE_PCPIPE) ? Math.max(0.50, PITCH_CONF_MIN) : PITCH_CONF_MIN;
            // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽHS鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ f/2, f, 2f 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｨ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽawFreq>0 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(rawFreq>0){
                // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ驍丞・・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ3oct=36鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                if(typeof analyzePitch._lastAcceptedFreqDisp==='undefined') analyzePitch._lastAcceptedFreqDisp=0;
                if(typeof analyzePitch._lastAcceptedRawHist==='undefined') analyzePitch._lastAcceptedRawHist=0;
                if(typeof analyzePitch._extremeFramesDisp==='undefined') analyzePitch._extremeFramesDisp=0;
                if(typeof analyzePitch._extremeFramesHist==='undefined') analyzePitch._extremeFramesHist=0;
                const isExtremeJump = (fNew, fRef)=>{
                    try{ if(!(fNew>0 && fRef>0)) return false; const dSemi=Math.abs(12*Math.log2(fNew/fRef)); return dSemi>=36; }catch(_){ return false; }
                };
                try{
                    const sr = audioCtx? audioCtx.sampleRate: 44100;
                    // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ micData 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬯滂ｽｴ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ getFloatTimeDomainData 鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const frame = micData;
                    function goertzelPower(arr, sr, f){ if(!(f>0) || f>=sr*0.5) return 0; const w=2*Math.PI*f/sr; const c=Math.cos(w); const coeff=2*c; let s0=0,s1=0,s2=0; for(let n=0;n<arr.length;n++){ s0 = arr[n] + coeff*s1 - s2; s2=s1; s1=s0; } return Math.max(0, s1*s1 + s2*s2 - coeff*s1*s2); }
                    function shsScore(arr, sr, f0, K){ if(!(f0>0)) return 0; const kMax=Math.max(1, K|0); let sum=0, used=0; for(let k=1;k<=kMax;k++){ const fk=f0*k; if(fk>=sr*0.5) break; const p=goertzelPower(arr, sr, fk); sum += (p>0? Math.sqrt(p):0) * (1/k); used++; } return used? sum/used: 0; }
                    const base = rawFreq; const half=base*0.5; const dbl=base*2;
                    let sBase = shsScore(frame, sr, base, 5);
                    let sHalf = shsScore(frame, sr, half, 5);
                    let sDbl  = shsScore(frame, sr, Math.min(dbl, sr*0.49), 5);
                    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽIDI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ郢晢ｽｻ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｺ・ｽ陜ｮ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    if(IS_MOBILE && !IS_MOBILE_PCPIPE){
                        try{
                            let guideMidiAtPlayhead = null;
                            const tRef = playbackPosition - getPitchVisOffsetSec();
                            if(!isPitchOnlyMode){
                                const tr=currentTracks[melodyTrackIndex];
                                if(tr&&tr.notes&&tr.notes.length){ const nn=tr.notes.find(n=> tRef>=n.time && tRef<=n.time+n.duration) || tr.notes.find(n=> n.time>tRef) || tr.notes[tr.notes.length-1]; if(nn) guideMidiAtPlayhead = nn.midi|0; }
                            }
                            if(guideMidiAtPlayhead==null && Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                                const g = midiGhostNotes.find(n=> tRef>=n.time && tRef<=n.time+n.duration) || null; if(g) guideMidiAtPlayhead = g.midi|0;
                            }
                            if(guideMidiAtPlayhead!=null){
                                const mGuide = guideMidiAtPlayhead;
                                function octaveBias(f, score){ if(!(f>0) || score<=0) return score; const m = 69+12*Math.log2(f/ A4Frequency); let mAdj=m; while(mAdj - mGuide > 6) mAdj -= 12; while(mGuide - mAdj > 6) mAdj += 12; const d=Math.abs(mAdj - mGuide); const w = 1 + Math.max(0, 0.15 * Math.max(0, (6 - d))/6); return score * w; }
                                sHalf = octaveBias(half, sHalf);
                                sBase = octaveBias(base, sBase);
                                sDbl  = octaveBias(dbl,  sDbl);
                            }
                        }catch(_){ }
                    }
                    // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    let wHalf=0.92, wBase=1.00, wDbl=1.03; // PC鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ郢晢ｽｻ髣憺屮・ｽ・ｭ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    if(onsetActive){ wHalf*=0.8; wDbl*=0.95; } // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽf/2鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ?
                    if(lastMicFreq>0){
                        const dSemi = Math.abs(12*Math.log2(base/lastMicFreq));
                        if(dSemi<=3){ wBase*=1.05; wDbl*=0.98; }
                    }
                    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ f/2 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽhalf 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
                    const mBase = 69+12*Math.log2(base/ A4Frequency);
                    if(mBase>=80){ wHalf*=0.85; wDbl*=1.05; }
                    let rHalf = sHalf*wHalf, rBase=sBase*wBase, rDbl=sDbl*wDbl;
                    let pick=base, bestS=sBase;
                    if(half>30 && rHalf>rBase && rHalf>rDbl){ pick=half; bestS=sHalf; }
                    if(rDbl>bestS && rDbl>rHalf){ pick=dbl; bestS=sDbl; }
                    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯句ｹ｢・ｽ・ｵ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟶壽升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ鬪ｰ邇厄ｽ｢蜴・ｽｿ・ｽ?繝ｻ・ｽ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    if(pick===half){
                        const alt=Math.max(rBase,rDbl);
                        const th = onsetActive? 1.25 : 1.10; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟・ｽｿ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                        if(rHalf < alt*th){ pick=(rDbl>=rBase? dbl: base); bestS=(rDbl>=rBase? sDbl: sBase); }
                    }
                    // rawFreq 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ鬮｣螂・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ隱ｿ鬮ｴ諛・ｽｱ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const second = (pick===base)? Math.max(sHalf, sDbl) : (pick===half? Math.max(sBase, sDbl): Math.max(sBase, sHalf));
                    const shsRel = bestS>0? Math.min(1, bestS / Math.max(1e-9, second*1.05)) : 0;
                    rawFreq = pick; rawConf = Math.max(rawConf, 0.35*rawConf + 0.65*Math.min(1, shsRel));

                    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽalf, base, dbl鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髮寂・譏㏄erbi鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ・つ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｢郢晢ｽｻ陜ｮ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣逧ｮ逕･鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    if(IS_MOBILE && !IS_MOBILE_PCPIPE) try{
                        const cands = [];
                        const costs = [];
                        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ + 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?
                        function pushCand(f, score){ if(!(f>0)) return; cands.push(f); const inv = 1/Math.max(1e-9, score); let pen=0; if(lastMicFreq>0){ const dSemi=Math.abs(12*Math.log2(f/lastMicFreq)); pen = 0.06*dSemi + (Math.min(Math.abs(dSemi-12),Math.abs(dSemi-24))<0.7? 0.35: 0); } costs.push(inv+pen); }
                        pushCand(half, Math.max(1e-9, rHalf));
                        pushCand(base, Math.max(1e-9, rBase));
                        pushCand(dbl,  Math.max(1e-9, rDbl));
                        yinVitFrames.push({ cands, costs, time: playbackPosition });
                        if(yinVitFrames.length>YIN_VIT_MAX) yinVitFrames.shift();
                        const runVit=(frames, lag)=>{
                            const N=frames.length; if(N===0) return null; const out=N-1-Math.max(0,lag|0); if(out<0) return null;
                            const dp=frames.map(f=>new Array(f.cands.length).fill(Infinity));
                            const pv=frames.map(f=>new Array(f.cands.length).fill(-1));
                            for(let j=0;j<frames[0].cands.length;j++){ dp[0][j]=frames[0].costs[j]; }
                            const baseBeta=0.08, baseOct=1.15; // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                            const beta=baseBeta, octPenalty = onsetActive? 1.50 : baseOct; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                            for(let i=1;i<N;i++){
                                const a=frames[i-1], b=frames[i];
                                for(let j=0;j<b.cands.length;j++){
                                    const f2=b.cands[j]; const lc=b.costs[j]; let best=Infinity,bk=-1;
                                    for(let k=0;k<a.cands.length;k++){
                                        const f1=a.cands[k]; let trans=0; if(f1===0||f2===0) trans=0.18; else { const d= Math.abs(12*Math.log2(f2/f1)); const nearOct=Math.min(Math.abs(d-12),Math.abs(d-24)); trans = beta*d + (nearOct<0.6? octPenalty: 0); if(d<=2.5) trans -= 0.03; }
                                        const cost=dp[i-1][k]+lc+trans; if(cost<best){ best=cost; bk=k; }
                                    }
                                    dp[i][j]=best; pv[i][j]=bk;
                                }
                            }
                            let lastJ=0; { let mv=Infinity; const last=dp[N-1]; for(let j=0;j<last.length;j++){ if(last[j]<mv){ mv=last[j]; lastJ=j; } } }
                            const path=new Array(N).fill(0); path[N-1]=lastJ; for(let i=N-1;i>0;i--){ const k=pv[i][path[i]]; path[i-1]=(k>=0? k: 0); }
                            const j=path[out]; return { idx: out, freq: frames[out].cands[j], time: frames[out].time };
                        };
                        const vit = runVit(yinVitFrames, YIN_VIT_LAG);
                        if(vit && vit.freq>0){ rawFreq = vit.freq; }
                    }catch(_){ }
                }catch(_){ /* ignore SHS fallback */ }
            }
            if(rawFreq>0){
                // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｯ髫ｰ魃会ｽｿ・ｽ?繝ｻ・ｽ驍ｯ諞ｺ蝙ｳ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ隴ｴ・ｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｶ鬮ｯ讖ｸ・ｽ・ｺ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const liveMin = (IS_MOBILE && !IS_MOBILE_PCPIPE) ? Math.max(0.38, Math.min(confMin, 0.50)) : confMin; // PC鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽPC鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ
                if(rawConf >= confMin){
                    const sm = _pitchSmootherMod? _pitchSmootherMod.push(rawFreq, rawConf): rawFreq;
                    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｮ・ｮ驍・私・ｽ・ｴ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋顔§謫髯橸ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謇区ｭ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ・つ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    let acceptDisp = true;
                    if(IS_MOBILE){
                        const ref = lastMicFreq>0? lastMicFreq : (analyzePitch._lastAcceptedFreqDisp||0);
                        if(isExtremeJump(sm, ref)){
                            analyzePitch._extremeFramesDisp = (analyzePitch._extremeFramesDisp|0)+1;
                            if(analyzePitch._extremeFramesDisp < 2){ acceptDisp=false; }
                        } else { analyzePitch._extremeFramesDisp=0; }
                    }
                    if(acceptDisp){
                        lastMicFreq = sm; _mobileHoldRemain = (IS_MOBILE && !IS_MOBILE_PCPIPE)? (onsetActive? 2: 1) : 0; _mobileHoldFreq = sm;
                        analyzePitch._lastAcceptedFreqDisp = lastMicFreq;
                        lastMicMidi = 69 + 12*Math.log2(Math.max(1e-9,lastMicFreq)/A4Frequency);
                    } else {
                        // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｶ鬮ｯ讖ｸ・ｽ・ｺ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                        if((IS_MOBILE && !IS_MOBILE_PCPIPE) && _mobileHoldRemain>0 && _mobileHoldFreq>0){
                            _mobileHoldRemain--; lastMicFreq=_mobileHoldFreq; lastMicMidi = 69 + 12*Math.log2(lastMicFreq/A4Frequency);
                        }
                    }
                }else if(IS_MOBILE){
                    // 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｻ隰趣ｽｺ諛ｶ・ｿ・ｽ?繝ｻ・ｽ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    if(rawConf >= liveMin){
                        const sm = _pitchSmootherMod? _pitchSmootherMod.push(rawFreq, rawConf): rawFreq;
                        let acceptDisp = true;
                        const ref = lastMicFreq>0? lastMicFreq : (analyzePitch._lastAcceptedFreqDisp||0);
                        if(IS_MOBILE && isExtremeJump(sm, ref)){
                            analyzePitch._extremeFramesDisp = (analyzePitch._extremeFramesDisp|0)+1;
                            if(analyzePitch._extremeFramesDisp < 2){ acceptDisp=false; }
                        } else { analyzePitch._extremeFramesDisp=0; }
                        if(acceptDisp){
                            lastMicFreq = sm; _mobileHoldRemain = ((IS_MOBILE && !IS_MOBILE_PCPIPE) && onsetActive? 1: 0); _mobileHoldFreq = sm;
                            analyzePitch._lastAcceptedFreqDisp = lastMicFreq;
                            lastMicMidi = 69 + 12*Math.log2(Math.max(1e-9,lastMicFreq)/A4Frequency);
                        }
                    }
                    // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ2 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ隴ｴ・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ螂・ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    if(_mobileHoldRemain>0 && _mobileHoldFreq>0){
                        _mobileHoldRemain--; lastMicFreq=_mobileHoldFreq; lastMicMidi = 69 + 12*Math.log2(lastMicFreq/A4Frequency);
                    }
                }
                if(!isCalibrating && rawConf >= confMin){
                    const vOff = getPitchVisOffsetSec();
                    const recTime = playbackPosition - vOff;
                    // 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢ｧ莨夲ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ繝ｻ・ｽ?雎・屮・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隰ｨ魑ｴﾂ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ
                    let acceptHist = true;
                    if(IS_MOBILE){
                        const refH = analyzePitch._lastAcceptedRawHist||0;
                        if(isExtremeJump(rawFreq, refH)){
                            analyzePitch._extremeFramesHist = (analyzePitch._extremeFramesHist|0)+1;
                            if(analyzePitch._extremeFramesHist < 2){ acceptHist=false; }
                        } else { analyzePitch._extremeFramesHist=0; }
                    }
                    if(!IS_MOBILE || IS_MOBILE_PCPIPE || true){
                        if(acceptHist){
                            // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                            if(!(rawFreq>0) || !Number.isFinite(rawFreq) || rawFreq>12000){
                                __diagLog('hist-push-invalid', {rawFreq, rawConf, recTime, vOff, A4:A4Frequency});
                            }
                            pitchHistory.push({ time: recTime, visOff: vOff, freq: rawFreq, conf: rawConf, sid: scoreSessionId });
                            analyzePitch._lastAcceptedRawHist = rawFreq;
                            if(pitchHistory.length>2000) pitchHistory.shift();
                            if(IS_MOBILE) _mobileLowDecim = 0;
                        }
                    }
                } else if(!isCalibrating && (IS_MOBILE && !IS_MOBILE_PCPIPE)){
                    // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽliveMin 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢髫ｶﾂ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ髮｣・ｽ・｣髯句ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const liveMin = Math.max(0.38, Math.min(confMin, 0.50));
                    if(rawConf >= liveMin){
                        const vOff = getPitchVisOffsetSec();
                        const recTime = playbackPosition - vOff;
                        // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ髮｣・ｽ・｣髯句ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ3鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ1鬯ｮ・ｯ繝ｻ・ｽ?髴・ｽｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                        _mobileLowDecim = ((_mobileLowDecim|0) + 1);
                        if((_mobileLowDecim % 3)===0){
                            // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                            let acceptHistL = true;
                            const refH = analyzePitch._lastAcceptedRawHist||0;
                            if(isExtremeJump(rawFreq, refH)){
                                analyzePitch._extremeFramesHist = (analyzePitch._extremeFramesHist|0)+1;
                                if(analyzePitch._extremeFramesHist < 2){ acceptHistL=false; }
                            } else { analyzePitch._extremeFramesHist=0; }
                            if(acceptHistL){
                                if(!(rawFreq>0) || !Number.isFinite(rawFreq) || rawFreq>12000){
                                    __diagLog('hist-push-invalid-low', {rawFreq, rawConf, recTime, vOff, A4:A4Frequency});
                                }
                                pitchHistory.push({ time: recTime, visOff: vOff, freq: rawFreq, conf: rawConf, sid: scoreSessionId });
                                analyzePitch._lastAcceptedRawHist = rawFreq;
                                if(pitchHistory.length>2000) pitchHistory.shift();
                            }
                        }
                    }
                }
            }
            if(!isPlaying) drawChart();
            return; // YIN鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?・つ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陷托ｽｰ邵ｺ雋ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓幢ｾつ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        }
    }catch(_){ /* fallback blocked intentionally to keep pipeline clean */ }

    const srLive = audioCtx? audioCtx.sampleRate: 44100;
    const W = micAnalyser.fftSize; // 2048 鬯ｯ・ｩ陟・屮・ｽ・ｧ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ螟ｲ・ｽ・ｱ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    // Hann 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const hann=new Float32Array(W); for(let n=0;n<W;n++) hann[n]=0.5*(1-Math.cos(2*Math.PI*n/(W-1)));
    // DC 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ + 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隰ｦ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let mean=0; for(let i=0;i<W;i++) mean+=micData[i]; mean/=W; const frame=new Float32Array(W);
    for(let i=0;i<W;i++){ frame[i]=(micData[i]-mean)*hann[i]; }
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ5..1200Hz 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ隲幢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ lastMicFreq 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・＠?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴擾ｽｴ?繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ鬩怜遜・ｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・｣鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ8鬯ｩ蛹・ｽｽ・ｶ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ.7kHz, E8鬯ｩ蛹・ｽｽ・ｶ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ.2kHz鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ陟厄ｽｷmaxLive鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ驛｢譎｢・ｽ・ｱ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const fmaxLive = 6000; // Hz鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽSR48k鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ Nyquist=24k 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const tauMin = Math.max(2, Math.floor(srLive/Math.min(fmaxLive, srLive*0.49)));
    const tauMax = Math.max(tauMin+2, Math.min(Math.floor(srLive/65), Math.floor(W*0.9)));
    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ驍丞・・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ2鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ6鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓幢ｾつ闔会ｽｰ・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ隱ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
    // 鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽbestR鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ陞ｳ・｣邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ6鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ髫ｴ魃会ｽｽ・ｺ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
    let SEMI_NARROW = Math.pow(2, 6/12);
    let localTauMin=tauMin, localTauMax=tauMax;
    if(_forceGlobalSearch>0){
        _forceGlobalSearch = Math.max(0, _forceGlobalSearch-1); // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ髣・ｽｽ隰ｳ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?關難ｽｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    } else if(lastMicFreq>0){
        const tau0=srLive/lastMicFreq; localTauMin=Math.max(tauMin, Math.floor(tau0/SEMI_NARROW)); localTauMax=Math.min(tauMax, Math.ceil(tau0*SEMI_NARROW));
        const pad=2; localTauMin=Math.max(tauMin, localTauMin-pad); localTauMax=Math.min(tauMax, localTauMax+pad);
    }
    // 鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣逍ｲ・ｩ・ｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｻ? 鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    // NACF 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let bestTau=-1, bestR=-1;
    // 鬯ｮ・ｯ郢晢ｽｻ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽau鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髫ｲ蟶帶ｲｺ霑｢・ｭ鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｵ諤懃・髯溷供・ｮ・｣・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const coarseStep = (localTauMin <= 32 ? 1 : 2);
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?: 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜難ｽｼ?繝ｻ・ｽ繝ｻ・ｽ驕呈汚・ｽ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    function coarseSearch(tMin, tMax){
        let bTau=-1, bR=-1;
        for(let tau=tMin; tau<=tMax; tau+=coarseStep){
            let r=0,e0=0,e1=0; const N=W-tau;
            for(let n=0;n<N;n++){ const a=frame[n], b=frame[n+tau]; r+=a*b; e0+=a*a; e1+=b*b; }
            const den=Math.sqrt(e0*e1)+1e-12; const nacf=r/den; if(nacf>bR){ bR=nacf; bTau=tau; }
        }
        return {bTau,bR};
    }
    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    ({bTau:bestTau, bR:bestR} = coarseSearch(localTauMin, localTauMax));
    // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｶ隴幢ｽｱ陞ｳ・ｦ髯溷供・ｮ・｣髴趣ｽｧ髯ｷ閧ｴ・ｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ髫ｲ・､?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?繝ｻ・ｽ繝ｻ・ｽ・つ髯橸ｽｳ陞｢・ｽ・つ陷･雜｣・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬩墓得・ｽ・ｩ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髴托ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ鬮｣諛ｶ・ｽ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const REACQUIRE_R_THRESH = 0.20;
    if(bestR < REACQUIRE_R_THRESH){
        const resAll = coarseSearch(tauMin, tauMax);
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄肩・ｽ・ｺ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔・･雎撰ｽｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(resAll.bR > bestR + 0.02){ bestTau = resAll.bTau; bestR = resAll.bR; }
    }
    // 鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隶主･・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?繝ｻ・ｽ繝ｻ・ｽ・つ髯橸ｽｳ陞｢・ｽ・つ陷･雜｣・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ陞ｳ螟ｲ・ｽ・ｷ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｽ・ｫ?髫ｶ魃会ｽｽ・｢髮手ｶ｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(bestTau===localTauMin || bestTau===localTauMax){
        const res = coarseSearch(tauMin, tauMax);
        if(res.bR > bestR + 1e-6){ bestTau = res.bTau; bestR = res.bR; }
    }
    if(bestTau>0){
        // bestR鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ髮｣・ｽ・｣髯句ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ怜･・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ9鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ4鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(bestR>0){
            const narrow = Math.pow(2, 4/12), wide = Math.pow(2, 9/12);
            const t = Math.max(0, Math.min(1, (bestR-0.2)/(0.8-0.2))); // R=0.2鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ, R=0.8鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const target = wide * Math.pow(narrow/wide, t); // R鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽwide, R鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽnarrow
            if(Math.abs(target - SEMI_NARROW) > 1e-6 && lastMicFreq>0){
                SEMI_NARROW = target;
                let lMin=tauMin, lMax=tauMax;
                const tau0=srLive/lastMicFreq; lMin=Math.max(tauMin, Math.floor(tau0/SEMI_NARROW)); lMax=Math.min(tauMax, Math.ceil(tau0*SEMI_NARROW));
                const pad=2; lMin=Math.max(tauMin, lMin-pad); lMax=Math.min(tauMax, lMax+pad);
                const resLoc = coarseSearch(lMin, lMax);
                if(resLoc.bR > bestR + 1e-6){ bestTau = resLoc.bTau; bestR = resLoc.bR; }
            }
        }
        const t0=Math.max(localTauMin, bestTau-2), t1=Math.min(localTauMax, bestTau+2);
        for(let tau=t0; tau<=t1; tau++){ let r=0,e0=0,e1=0; const N=W-tau; for(let n=0;n<N;n++){ const a=frame[n], b=frame[n+tau]; r+=a*b; e0+=a*a; e1+=b*b; } const den=Math.sqrt(e0*e1)+1e-12; const nacf=r/den; if(nacf>bestR){ bestR=nacf; bestTau=tau; } }
    }
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髯ｷ謳ｾ・ｽ・ｳ鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    let estTau=bestTau; if(bestTau>Math.max(tauMin, localTauMin) && bestTau<Math.min(tauMax, localTauMax)){
        const fAt=(t)=>{ let r=0,e0=0,e1=0; const N=W-t; for(let n=0;n<N;n++){ const a=frame[n], b=frame[n+t]; r+=a*b; e0+=a*a; e1+=b*b; } return r/(Math.sqrt(e0*e1)+1e-12); };
        const ym1=fAt(bestTau-1), y0=bestR, yp1=fAt(bestTau+1); const denom=(ym1-2*y0+yp1); if(Math.abs(denom)>1e-9){ const delta=0.5*(ym1-yp1)/denom; if(Math.abs(delta)<=1) estTau=bestTau+delta; }
    }
    const NACF_THRESH=0.28; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ驍ｵ・ｺ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
    let freq=(bestR>=NACF_THRESH && estTau>0)? (srLive/estTau) : 0;
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ霑｢證ｦ・ｽ・ｲ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽSHS鬯ｯ・ｩ陜難ｽｼ陞ｳ・ｦ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬩墓得・ｽ・ｩ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    function shsReacquire(frameArr, sr){
    const fMin=80, fMax=fmaxLive; const bins=128; let bestF=0, bestS=0; const scores=new Float32Array(bins);
        for(let i=0;i<bins;i++){
            const r=i/(bins-1); const f = fMin * Math.pow(fMax/fMin, r);
            const s = shsScore(frameArr, sr, f, 5);
            scores[i]=s; if(s>bestS){ bestS=s; bestF=f; }
        }
        const arr=Array.from(scores).sort((a,b)=>a-b); const med=arr[Math.floor(arr.length/2)]||0; if(bestS>Math.max(1e-9, med*2)) return bestF; return 0;
    }
    if(_forceGlobalSearch>0){
        const fRe = shsReacquire(frame, srLive);
        if(fRe>0) freq=fRe;
    }
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽHS鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ f/2, f, 2f 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｮ雜｣・ｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    function goertzelPower(frameArr, sr, f){
        if(!(f>0) || f>=sr*0.5) return 0; const w=2*Math.PI*f/sr; const c=Math.cos(w); const coeff=2*c; let s0=0,s1=0,s2=0; for(let n=0;n<frameArr.length;n++){ s0 = frameArr[n] + coeff*s1 - s2; s2=s1; s1=s0; } return Math.max(0, s1*s1 + s2*s2 - coeff*s1*s2);
    }
    function shsScore(frameArr, sr, f0, K){ if(!(f0>0)) return 0; const kMax=Math.max(1, K|0); let sum=0, used=0; for(let k=1;k<=kMax;k++){ const fk=f0*k; if(fk>=sr*0.5) break; const p=goertzelPower(frameArr, sr, fk); sum += (p>0? Math.sqrt(p):0) * (1/k); used++; } return used? sum/used: 0; }
    let conf=0.0;
    // --- 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ闍難ｽｶ・ｨiterbi鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽreq鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ莨懶ｽｾ魃会ｽｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｲ蛛・ｽｽ・ｬ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ---
    // cFreqs, cCosts 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謳ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ陷驤ｴ諠ｧ髫ｶﾂ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?繝ｻ・ｽ??髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ髴趣ｽｧ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・｣・ｰ闔会ｽｰ・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螟ｲ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ鬯ｮ・ｮ隶主･・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        if(Array.isArray(cFreqs) && Array.isArray(cCosts) && cFreqs.length===cCosts.length){
            const idx = Array.from({length:cFreqs.length}, (_,i)=>i).sort((a,b)=> cCosts[a]-cCosts[b]);
            const keep = Math.min(5, idx.length);
            const selCands = new Array(keep);
            const selCosts = new Array(keep);
            for(let ii=0; ii<keep; ii++){ selCands[ii]=cFreqs[idx[ii]]; selCosts[ii]=cCosts[idx[ii]]; }
            liveVitFrames.push({ cands: selCands, costs: selCosts, time: playbackPosition });
            if(liveVitFrames.length > LIVE_VIT_MAX) liveVitFrames.shift();
            // 鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽViterbi鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隴ｴ・ｧ・趣ｽ､?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const vit = (function runLiveViterbi(frames, lag){
                try{
                    const N = frames.length; if(N===0) return null;
                    const outIndex = N - 1 - Math.max(0, lag|0);
                    if(outIndex < 0) return null; // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｲ陝ｶ蟷｢・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ陞ｳ・｣邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    // DP鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮倶ｼ∝ｱｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    const dp = frames.map(f => new Array(f.cands.length).fill(Infinity));
                    const pv = frames.map(f => new Array(f.cands.length).fill(-1));
                    // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const f0 = frames[0]; for(let j=0;j<f0.cands.length;j++){ dp[0][j] = f0.costs[j]; }
                    const baseBeta = 0.10; const baseOct = 1.25;
                    const beta = onsetActive? baseBeta : baseBeta;
                    const octPenalty = onsetActive? 1.45 : baseOct;
                    for(let i=1;i<N;i++){
                        const fi = frames[i]; const fi_1 = frames[i-1];
                        for(let j=0;j<fi.cands.length;j++){
                            const f2 = fi.cands[j]; const lc = fi.costs[j];
                            let best=Infinity, bestk=-1;
                            for(let k=0;k<fi_1.cands.length;k++){
                                const f1 = fi_1.cands[k];
                                let trans=0;
                                if(f1===0 || f2===0){ trans = 0.26; }
                                else {
                                    const dSemi = Math.abs(12*Math.log2(f2/f1));
                                    const nearOct = Math.min(Math.abs(dSemi-12), Math.abs(dSemi-24));
                                    trans = beta*dSemi + (nearOct<0.7? octPenalty: 0);
                                    if(dSemi<=3) trans -= 0.04; else if(dSemi<12) trans += 0.03;
                                }
                                const cost = dp[i-1][k] + lc + trans;
                                if(cost<best){ best=cost; bestk=k; }
                            }
                            dp[i][j]=best; pv[i][j]=bestk;
                        }
                    }
                    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ鬩怜遜・ｽ・ｫ郢晢ｽｻ郢晢ｽｻ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    let lastJ=0; { let minv=Infinity; const last=dp[N-1]; for(let j=0;j<last.length;j++){ if(last[j]<minv){ minv=last[j]; lastJ=j; } } }
                    const pathIdx = new Array(N).fill(0); pathIdx[N-1]=lastJ; for(let i=N-1;i>0;i--){ const k=pv[i][pathIdx[i]]; pathIdx[i-1] = (k>=0? k: 0); }
                    const selJ = pathIdx[outIndex];
                    return { idx: outIndex, freq: frames[outIndex].cands[selJ], time: frames[outIndex].time };
                }catch(_){ return null; }
            })(liveVitFrames, LIVE_VIT_LAG);
            if(vit && vit.freq>0){ freq = vit.freq; var __vitTimeOverride = vit.time; }
        }
    }catch(_){ }

    if(freq>0){
        const base = freq; const half=base*0.5; const dbl=base*2;
        const sBase = shsScore(frame, srLive, base, 5);
        const sHalf = shsScore(frame, srLive, half, 5);
        const sDbl  = shsScore(frame, srLive, Math.min(dbl, srLive*0.49), 5);
    // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ驕ｯ・ｶ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｧ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ/2鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｧ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽf鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ陝・ｈ蜊・ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・｢?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ､郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣騾ｧ・ｮ騾包ｽ･?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
    let wHalf=0.88, wBase=1.00, wDbl=1.12;
        // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ郢晢ｽｻ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｮ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螟ｲ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｱ繝ｻ・ｽ?隲・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ蟷｢・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ??+鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ鬯ｩ蛹・ｽｽ・ｶ鬯ｮ・ｮ遶乗劼・ｽ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螟ｲ・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｱ繝ｻ・ｽ?隲・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ蟷｢・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ??+鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・ｫ・つ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ陋ｹ螟ｲ・ｿ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let trend=0; try{
            if(pitchSmoothBuf.length>=4){
                const a=pitchSmoothBuf[pitchSmoothBuf.length-4];
                const b=pitchSmoothBuf[pitchSmoothBuf.length-1];
                trend = Math.max(-1, Math.min(1, Math.sign(b-a)));
            }
        }catch(_){ }
        const trendBoost = 1 + 0.05*trend;    // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ1.05, 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ0.95鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽIDI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ驍丞・・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ6鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・つ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ6鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        function contMul(m){
            try{
                if(!(lastMicMidi>0)) return 1.0;
                let mm=m; const exp=lastMicMidi;
                while(mm-exp>6) mm-=12; while(exp-mm>6) mm+=12;
                const d=Math.abs(mm-exp);
                if(d<=3) return 1.05; // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ陝・ｈ縺檎ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                if(d<=6) return 1.00; // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                return 0.85;           // 1鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮｢ﾂ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隲・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?
            }catch(_){ return 1.0; }
        }
        const mHalf = 69+12*Math.log2(Math.max(1e-9,half)/A4Frequency);
        const mBase = 69+12*Math.log2(Math.max(1e-9,base)/A4Frequency);
        const mDbl  = 69+12*Math.log2(Math.max(1e-9,dbl)/A4Frequency);
        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ驕ｯ・ｶ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｧ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ/2鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陷托ｽｰ邵ｺ雋ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ郢晢ｽｻ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽf 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(mBase>=80){ // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽG#5 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            wHalf *= 0.85; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟・ｽｼ諛ｶ・ｿ・ｽ?繝ｻ・ｽ鬮｣繝ｻ繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ隨翫ｋ蝙磯寞・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            wDbl  *= 1.05;
        }

        let rHalf = sHalf * wHalf * (trend<0? 1.04:1.00) * contMul(mHalf); // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ遶乗劼・ｽ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        let rBase = sBase * wBase * contMul(mBase);
        let rDbl  = sDbl  * wDbl  * (trend>0? trendBoost:1.00) * contMul(mDbl); // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ2f鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ

        let pick=base, bestS=sBase, bestRW=rBase;
        if(half>30 && rHalf>bestRW){ pick=half; bestS=sHalf; bestRW=rHalf; }
        if(rDbl>bestRW){ pick=dbl; bestS=sDbl; bestRW=rDbl; }
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? pick 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽhalf 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｵ蠍ｺ・ｺ・｢?繝ｻ・ｽ繝ｻ・ｽ鬩､・ｴ陷画汚・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隴ｴ・ｧ雎主､ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽase/dbl鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・つ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(trend>0 && pick===half){
            const alt = Math.max(rBase, rDbl);
            if(rHalf < alt * 1.12){ // 12%鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯句ｹ｢・ｽ・ｵ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                if(rDbl>=rBase){ pick=dbl; bestS=sDbl; bestRW=rDbl; }
                else { pick=base; bestS=sBase; bestRW=rBase; }
            }
        }
        // SHS鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ? confidence 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ鬮｣螂・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隰・ｹ晢ｼ・ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const second = (pick===base)? Math.max(sHalf, sDbl) : (pick===half? Math.max(sBase, sDbl): Math.max(sBase, sHalf));
        const shsRel = bestS>0? Math.min(1, bestS / Math.max(1e-9, second*1.05)) : 0; // 1.05鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯ｷ閧ｴ・ｷ讌ｪﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
        conf = Math.max(0, Math.min(1, 0.65*bestR + 0.35*shsRel));
        freq = pick;
    }
    if(freq<=0){ if(_forceGlobalSearch<=0 && lastMicFreq>0) freq=lastMicFreq; }
    if(freq>0){
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謇具ｽｴ蜈ｷ・ｽ・ｾ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ+ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ + 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ + 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        pitchSmoothBuf.push(freq); if(pitchSmoothBuf.length>PITCH_SMOOTH_WINDOW) pitchSmoothBuf.shift();
        const avg = pitchSmoothBuf.reduce((a,b)=>a+b,0)/pitchSmoothBuf.length;
        const med = [...pitchSmoothBuf].sort((a,b)=>a-b)[Math.floor(pitchSmoothBuf.length/2)];
        // 鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬮ｮ・ｷ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const fused = 0.6*med + 0.4*avg;
        // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ繝ｻ・ｽ?郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        function lerp(a,b,t){ return a + (b-a)*Math.max(0,Math.min(1,t)); }
    const DEAD_CENTS = lerp(10, 3, conf);           // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜴・ｽｽ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ, 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｮ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let   MAX_STEP_CENTS = lerp(15, 45, conf);      // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜴・ｽｽ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜴・ｽｽ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ鬪ｰ邇厄ｽ｢蜴・ｽｿ・ｽ?繝ｻ・ｽ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUP鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const cents = (lastMicFreq>0)? 1200*Math.log2(fused/lastMicFreq) : 0;
        let smoothed = (lastMicFreq>0 && Math.abs(cents)<DEAD_CENTS)? lastMicFreq : fused;
        // 1鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ陋滂ｽｬ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(lastMicFreq>0){
            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隴ｴ・ｧ雎主､ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ髣・ｽｽ隰ｳ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const absC = Math.abs(cents);
            if(conf>0.7 && absC>100){
                // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ2鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋企屮・ｿ・ｽ?繝ｻ・ｽ髣憺屮・ｽ・ｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ怜℡?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                MAX_STEP_CENTS = Math.max(MAX_STEP_CENTS, Math.min(200, absC*1.2));
            }
            const maxStep = lastMicFreq * Math.pow(2, MAX_STEP_CENTS/1200) - lastMicFreq;
            const diff = smoothed - lastMicFreq;
            if(Math.abs(diff) > Math.abs(maxStep)) smoothed = lastMicFreq + Math.sign(diff)*Math.abs(maxStep);
        }
        // 鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢ｧ莨夲ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ隰撰ｽｺ?繝ｻ・ｽ繝ｻ・ｽ驕擾ｽｩ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・つ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟶壽升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ鬆第答郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶夲ｽｨ鬯ｩ謳ｾ・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ驍丞・・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ6鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        lastMicFreq = smoothed;
        let liveMidi = 69 + 12*Math.log2(Math.max(1e-9,lastMicFreq)/A4Frequency);
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶夲ｽｨ鬯ｩ謳ｾ・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ隴幢ｽｱ髮趣ｽｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ陷證ｦ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｱ郢晢ｽｻ陜ｨ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ陝・ｈ縺檎ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ驕倥・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴取得・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        lastMicMidi = liveMidi;
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｧ・ｭ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    let dCentsForDot = null; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髮手ｶ｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ驍丞・・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ600c鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜥ｲ蛻､?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let pcForDot = null;     // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 0..11鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ=0鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{
            // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 1) 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? 2) 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            let nn=null;
            const tr=currentTracks[melodyTrackIndex];
            const t = ((typeof __vitTimeOverride==='number')? __vitTimeOverride: playbackPosition) - getPitchVisOffsetSec(); // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ邵ｺ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const T_TOL = 0.12; // 120ms 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊ゑｽｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｮ鬮ｷ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蝓ｼ・｡遒托ｽｷ譎｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬮ｫ・ｴ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(tr && tr.notes && tr.notes.length){
                // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                nn = tr.notes.find(n=> t>=n.time && t<=n.time+n.duration);
                if(!nn){
                    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷供・ｮ・｣髴趣ｽｧ髯ｷ閧ｴ・ｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜍溪酪隰・ｽｱ?繝ｻ・ｽ?陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髮主叙・ｨ謚ｵ・ｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    let prev=null, next=null;
                    for(const n of tr.notes){ if(n.time<=t) prev=n; if(n.time>t){ next=n; break; } }
                    let best=null, bd=1e9;
                    if(prev){ const d=Math.min(Math.abs(t-prev.time), Math.abs((prev.time+prev.duration)-t)); if(d<bd){ bd=d; best=prev; } }
                    if(next){ const d=Math.min(Math.abs(t-next.time), Math.abs((next.time+next.duration)-t)); if(d<bd){ bd=d; best=next; } }
                    if(best && bd<=T_TOL) nn=best;
                    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    if(!nn) nn = next || tr.notes[tr.notes.length-1];
                }
            }
            if(!nn && Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ驍丞・・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽduration鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ郢晢ｽｻ120ms鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                let best=null, bd=1e9;
                for(const g of midiGhostNotes){
                    const dCenter = Math.abs(t - (g.time + (g.duration||0)/2));
                    const score = dCenter / Math.max(0.001, g.duration||0.4);
                    if(score < bd){ bd=score; best=g; }
                }
                if(best){
                    const dEdge = Math.min(Math.abs(t-best.time), Math.abs((best.time+(best.duration||0))-t));
                    if(dEdge<=T_TOL || (t>=best.time && t<=best.time+(best.duration||0))) nn = { midi: best.midi, time: best.time, duration: best.duration };
                }
            }
            if(!nn && isPracticing && Array.isArray(practiceExpectedNotes) && practiceExpectedNotes.length){
                // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･陷ｿ蝠城ｴｬ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・・・ｽ?髣・ｽｽ?繝ｻ・ｽ繝ｻ・ｽ隰ｦ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                let best=null, bd=1e9;
                for(const g of practiceExpectedNotes){
                    const mid = g.time + (g.duration||0)/2;
                    const d = Math.abs(t - mid);
                    if(d<bd){ bd=d; best=g; }
                }
                if(best){
                    const dEdge = Math.min(Math.abs(t-best.time), Math.abs((best.time+(best.duration||0))-t));
                    if(dEdge<=T_TOL || (t>=best.time && t<=best.time+(best.duration||0))) nn = { midi: best.midi, time: best.time, duration: best.duration };
                }
            }
            if(nn){
                    // nn.midi 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ魃会ｽｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ郢晢ｽｻ ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ2鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ鬆第答郢晢ｽｻ邵ｺ・､・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽliveMidi 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    let best=nn.midi, bestD=1e9;
                    for(let k=-2;k<=2;k++){
                        const cand=nn.midi + 12*k;
                        const d=Math.abs(cand - liveMidi);
                        if(d<bestD){ bestD=d; best=cand; }
                    }
                    const fTar = midiToFreq(best);
                    let centErr = 1200*Math.log2(Math.max(1e-9,lastMicFreq)/Math.max(1e-9,fTar));
                    centErr = wrapToPm600(centErr);
                    dCentsForDot = centErr;
                    pcForDot = ((nn.midi%12)+12)%12;
                    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    try{
                        if((isPlaying || isPracticing) && scoreStats && Number.isFinite(centErr)){
                            const bin = scoreStats.bins[pcForDot];
                            bin.count++;
                            scoreStats.total++;
                            bin.sum += centErr;
                            bin.sumAbs += Math.abs(centErr);
                            const tol = toleranceCents||0;
                            if(Math.abs(centErr) <= tol) bin.inTol++; else bin.outTol++;
                            const bias = 5; // 5c 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                            if(centErr >= bias) bin.sharp++;
                            else if(centErr <= -bias) bin.flat++;
                        }
                    }catch(_){ }
            }
        }catch(_){ /* fall back to liveMidi */ }
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｩ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｧ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        try{
            if((isPlaying || isPracticing) && dCentsForDot!=null && pcForDot!=null){
                const tol = toleranceCents||0; const ok = Math.abs(dCentsForDot) <= tol;
                const mForOct = (69 + 12*Math.log2(Math.max(1e-9,lastMicFreq)/A4Frequency));
                const oct = Math.floor(mForOct/12) - 1; const key = String(oct);
                if(!scoreDetailByOct[key]) scoreDetailByOct[key] = {};
                const cell = (scoreDetailByOct[key][pcForDot] ||= {in:0,out:0,count:0});
                cell.count++; if(ok) cell.in++; else cell.out++;
            }
        }catch(_){ }
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謳ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ郢晢ｽｻ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ驕堤ｬｬ・ｭ讌｢讀ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ邵ｺ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(!isCalibrating){
            const vOff = getPitchVisOffsetSec();
            const recTime = ((typeof __vitTimeOverride==='number')? __vitTimeOverride: playbackPosition) - vOff;
            if(!(lastMicFreq>0) || !Number.isFinite(lastMicFreq) || lastMicFreq>12000){
                __diagLog('live-push-invalid', {lastMicFreq, conf, recTime, vOff, A4:A4Frequency});
            }
            pitchHistory.push({ time: recTime, visOff: vOff, freq: lastMicFreq, conf, sid: scoreSessionId });
            if(pitchHistory.length>2000) pitchHistory.shift();
        }
    }
        if(!isPlaying) drawChart();
}
function zeroCrossFreq(buf,sr){
    let crossings=0; let lastSign=buf[0]>0; for(let i=1;i<buf.length;i++){ const s=buf[i]>0; if(s!==lastSign){ crossings++; lastSign=s; } }
    const freq = (crossings/2)*(sr/buf.length); return freq||-1;
}
function autoCorrelate(buf,sr){ const S=buf.length; let rms=0; for(let i=0;i<S;i++) rms+=buf[i]*buf[i]; rms=Math.sqrt(rms/S); if(rms<0.01) return -1; const end=S/2; let best=0,bestV=0; for(let lag=20;lag<end;lag++){ let sum=0; for(let i=0;i<end;i++) sum+=buf[i]*buf[i+lag]; if(sum>bestV){ bestV=sum; best=lag; } } return best? sr/best:-1; }
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ600c 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ郢晢ｽｻ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ騾ｹ・｣・つ髯ｷ・･陷ｿ蝠城ｴｬ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩包ｽｶ闕ｳ讓呈ｨ・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function wrapToPm600(cents){
    const x = ((cents + 600) % 1200 + 1200) % 1200 - 600;
    return x;
}
// ---- Draw ----
function loop(){
    updatePlaybackPositionHybrid();
    const now = performance.now();
    const dt = now - _lastFrameTime; _lastFrameTime = now; _frameAccum += dt; _frameCnt++;
    // ===== Drift (Audio vs Perf) 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ =====
    // audioCtx.currentTime 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ performance.now 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ play 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴擾ｽｴ?繝ｻ・ｽ?鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｿ・ｽ?鬯ｯ貊ゑｽｽ・ｭ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｹ陞｢・ｽ郢晢ｽｻ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｻ髣包ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隰ｨ魑ｴﾂ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽor鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽor鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟・ｽｼ諛ｶ・ｽ・ｴ隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲ｷ諷墓ｫｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(audioCtx && isPlaying){
        try{
            const nowPerfSec = now/1000;
            const ctxDt = Math.max(0, audioCtx.currentTime - playbackStartTime);
            const perfDt = Math.max(0, nowPerfSec - playbackStartPerf);
            const driftMs = (perfDt - ctxDt)*1000; // 鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: perf 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(!window.__driftStats){
                window.__driftStats = { samples:0, avg:0, max:0, last:0, updated:0 };
            }
            const ds = window.__driftStats;
            ds.samples++;
            // online average
            ds.avg += (driftMs - ds.avg)/ds.samples;
            if(Math.abs(driftMs) > Math.abs(ds.max)) ds.max = driftMs;
            ds.last = driftMs;
            if(!ds.updated || (now - ds.updated) > 500){
                // 500ms 鬯ｮ・ｮ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ?
                const el = document.getElementById('driftOverlay');
                if(el){
                    el.textContent = `Drift(avg:${ds.avg.toFixed(1)}ms max:${ds.max.toFixed(1)}ms last:${ds.last.toFixed(1)}ms mode:${FORCE_PERF_CLOCK?'PERF':'AUTO'} state:${_driftForceState}`;
                }
                ds.updated = now;
            }
            // ==== 鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ(1s 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 1 鬯ｮ・ｯ繝ｻ・ｽ?髴・ｽｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ) ====
            if(now - _lastDriftDecisionAt > 1000){
                _lastDriftDecisionAt = now;
                if(FORCE_PERF_CLOCK){
                    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｻ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    if(ds.samples>DRIFT_FORCE_SAMPLES && Math.abs(ds.avg) < DRIFT_FORCE_HYST_MS){
                        FORCE_PERF_CLOCK=false; _driftForceState='idle';
                        try{ console.warn('[drift] FORCE_PERF_CLOCK OFF (avg', ds.avg.toFixed(1),'ms)'); }catch(_){ }
                    } else {
                        _driftForceState='forcing';
                    }
                } else {
                    if(ds.samples>DRIFT_FORCE_SAMPLES && Math.abs(ds.avg) > DRIFT_FORCE_AVG_MS){
                        // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ armed 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｼ陋ｻ譎櫁ｾｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        if(_driftForceState!=='armed'){
                            _driftForceState='armed';
                        } else {
                            FORCE_PERF_CLOCK=true; _driftForceState='forcing';
                            try{ console.warn('[drift] FORCE_PERF_CLOCK ON (avg', ds.avg.toFixed(1),'ms)'); }catch(_){ }
                        }
                    } else {
                        _driftForceState='idle';
                    }
                }
            }
        }catch(_){ }
    }
    let doDraw = true;
    if(IS_MOBILE){
        // 60fps 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ ( ~28-40fps 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ)
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ驕ｯ・ｶ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ陷托ｽｲ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(dt < 14){ doDraw = false; }
    }
    if(doDraw){
        drawChart();
        if(IS_MOBILE){
            _frameSkipToggle = !_frameSkipToggle;
            if(!_frameSkipToggle){ setSelectionByPlayhead(); }
        } else {
            setSelectionByPlayhead();
        }
    }
    if(now - _lastPerfLog > 2000){
        try{ const avg = (_frameAccum/_frameCnt).toFixed(1); console.debug('[perf] avgFrame(ms)=',avg,' pos=',playbackPosition.toFixed(3)); }catch(_){ }
        _frameAccum=0; _frameCnt=0; _lastPerfLog=now;
    }
    if(isPlaying) requestAnimationFrame(loop);
}
// LRU 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髫ｨ蜷ｶ・具ｾ守｢托ｽｭ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? (鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ髮∬｢・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ)
setInterval(()=>{ maybeRunLru(); },5000);
// 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let noteRectsGlobal=[]; // fallback in case earlier declaration fails
function drawChart(){
    if(!chartCanvas||!ctx) return;
    // 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣比ｼ夲ｽｽ・｣?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｮ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ canvas.width/height 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ隴幢ｽｱ?繝ｻ・ｽ繝ｻ・ｽ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    let w=chartCanvas.width; let h=chartCanvas.height;
    if(!w || !h){
        // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? 0 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        try{ resizeCanvas(); }catch(_){ }
        // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 0 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ鬪ｰ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ蜿厄ｽｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・守｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ・ｩ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｹ郢晢ｽｻ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        w = chartCanvas.width; h = chartCanvas.height;
        if(!w){
            const vw = Math.max(0, window.innerWidth||document.documentElement.clientWidth||0);
            const fallbackW = Math.max(320, Math.floor(vw*0.6)||0, 640);
            w = fallbackW;
            chartCanvas.width = w;
            chartCanvas.style.width = w + 'px';
        }
        if(!h){
            let ph = 0;
            try{ const p = chartCanvas.parentElement; ph = p? Math.floor(p.clientHeight || p.getBoundingClientRect().height || 0) : 0; }catch(_){ ph=0; }
            const fallbackH = ph>0? ph: 360;
            h = fallbackH;
            chartCanvas.height = h;
            chartCanvas.style.height = h + 'px';
        }
    }
    ctx.clearRect(0,0,w,h);
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｮ鬮ｷ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・つ陷ｻ・ｵ隰ｳ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷会ｽｱ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const curOff = getPitchVisOffsetSec();
    const total=verticalZoom*12; const min=36; const maxDisplay=132; const vmin=min+Math.round((maxDisplay-min-total)*(verticalOffset/100)); const vmax=vmin+total; const pxSemi=h/total; const playX=getPlayX(w); const eff=playbackPosition+timelineOffsetSec;
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ霑ｺ・ｰ・つ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ=鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ=鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    for(let m=vmin;m<=vmax;m++){
        const y=h-(m-vmin+1)*pxSemi;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(w,y);
        const pc = ((m%12)+12)%12;
        const isC = pc===0; // C鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const isNatural = (pc===0||pc===2||pc===4||pc===5||pc===7||pc===9||pc===11);
        // C鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ郢晢ｽｻ・つ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髴托ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ鬮｣諛ｶ・ｽ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ髦ｮ蜊搾ｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｯ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        ctx.strokeStyle = isC ? '#ffffff' : (isNatural ? '#8c8c8c' : '#3a3a3a');
        ctx.lineWidth = isC ? 2 : 1;
        ctx.stroke();
    }
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髫ｲ蟷・か?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ隶難ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ 2鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｿ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ x = playX + ((t-eff)*pxPerSec/tempoFactor) 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｿ・ｽ?繝ｻ・ｽ・つ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const visMarginSec = 2.0;
    const visStart=eff - (playX/pxPerSec)*tempoFactor - visMarginSec;
    const visEnd  =eff + ((w-playX)/pxPerSec)*tempoFactor + visMarginSec;

    // 鬯ｮ・｣騾ｧ・ｮ陋ｻ・､驍ｵ・ｺ陋滂ｽ｡?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ隰撰ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣螂・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ髦ｮ蜊搾ｽｧ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? showNotes=true鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        if(Array.isArray(melodyParts) && !isPitchOnlyMode){
            for(let i=0;i<melodyParts.length;i++){
                if(i===currentMelodyPart) continue;
                const p = melodyParts[i];
                if(!p || !p.showNotes) continue;
                const notes = Array.isArray(p.notes)? p.notes: [];
                if(!notes.length) continue;
                ctx.save();
                ctx.lineWidth = Math.max(1, Math.floor(guideLineWidth*0.6));
                // 鬯ｮ・ｮ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                ctx.strokeStyle = 'rgba(180, 190, 210, 0.45)';
                for(const n of notes){
                    if(!n) continue;
                    if(n.time>visEnd) break;
                    if(n.time+n.duration<visStart) continue;
                    const x1=playX+(n.time-eff)*pxPerSec/tempoFactor;
                    const x2=playX+((n.time+n.duration)-eff)*pxPerSec/tempoFactor;
                    if(x2<0||x1>w) continue;
                    const y=h-(n.midi-vmin+1)*pxSemi;
                    ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y); ctx.stroke();
                }
                ctx.restore();
            }
        }
    }catch(_){ }

    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ+ 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ鍋ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ遶包ｽｧ鬮ｯ諞ｺ螻ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(!isCalibrating && currentTracks[melodyTrackIndex] && !isPitchOnlyMode){
        ctx.lineWidth=guideLineWidth; ctx.strokeStyle='#4e8cff';
        const notes=currentTracks[melodyTrackIndex].notes;
    
        noteRectsGlobal.length=0;
        const t = playbackPosition;
        let playheadIdx = -1;
        for(let i=0;i<notes.length;i++){
            const n=notes[i];
            if(n.time<=t && t<=n.time+n.duration){ playheadIdx = i; break; }
        }
        for(let i=0;i<notes.length;i++){
            const n=notes[i];
            if(n.time>visEnd) break;
            if(n.time+n.duration<visStart) continue;
            const x1=playX+(n.time-eff)*pxPerSec/tempoFactor;
            const x2=playX+((n.time+n.duration)-eff)*pxPerSec/tempoFactor;
            if(x2<0||x1>w) continue;
            const y=h-(n.midi-vmin+1)*pxSemi;
            const sel=window._selection||{type:'none'};
            const isSingleSel = (sel.type==='single' && sel.index!=null && notes[sel.index]===n);
            const isRangeSel  = (sel.type==='range' && sel.startSec!=null && sel.endSec!=null && !(n.time>sel.endSec || (n.time+n.duration)<sel.startSec));
            if(isSingleSel){
                // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ・つ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                ctx.save();
                ctx.fillStyle='rgba(255,255,80,0.38)';
                const barH = Math.min(12, pxSemi*1.0);
                ctx.fillRect(x1, y-barH/2, x2-x1, barH);
                ctx.strokeStyle='#ffe600'; ctx.lineWidth=Math.max(guideLineWidth,3.2);
                ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y); ctx.stroke();
                ctx.restore();
            } else if(isRangeSel){
                // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ鬮｣魃会ｽｿ・ｽ?繝ｻ・ｽ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｮ鬮ｷ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                ctx.save();
                ctx.fillStyle='rgba(120, 220, 255, 0.18)';
                const barH = Math.min(10, pxSemi*0.9);
                ctx.fillRect(x1, y-barH/2, x2-x1, barH);
                ctx.strokeStyle='#6fe0ff'; ctx.lineWidth=Math.max(guideLineWidth,2.0);
                ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y); ctx.stroke();
                ctx.restore();
            } else {
                ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y); ctx.stroke();
            }
            // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ霑ｺ・ｰ・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ toleranceCents 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ譎｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隶主･・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?髫ｶ魃会ｽｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ
            const dy = (toleranceCents/100) * pxSemi; // cents -> semitone -> px
            if(dy>0.2){
                ctx.save();
                ctx.lineWidth = 1;
                ctx.strokeStyle = '#ffffff';
                // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                ctx.beginPath(); ctx.moveTo(x1, y - dy); ctx.lineTo(x2, y - dy); ctx.stroke();
                // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                ctx.beginPath(); ctx.moveTo(x1, y + dy); ctx.lineTo(x2, y + dy); ctx.stroke();
                ctx.restore();
            }
            noteRectsGlobal.push({x1,x2,y,idx:notes.indexOf(n)});
            if(showNoteNames){ ctx.font='10px sans-serif'; ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='middle'; const lab=noteLabel(n.midi); ctx.fillText(lab,(x1+x2)/2,y-8); }
        }
    }
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・・?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ邵ｺ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽt鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽMIDI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷供・ｮ・｣髴趣ｽｧ繝ｻ・ｽ?霓｣菫ｶﾎ・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽesp鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟶壽升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    function ghostMidiAt(t){
        try{
            if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                // resp鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｼ陋ｻ譎｢・ｿ・ｽ?繝ｻ・ｽ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ鬩榊･・ｽｿ・ｽ?邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                let cand=null;
                for(const n of midiGhostNotes){
                    if(n && (n.role==='resp') && t>=n.time && t<=n.time+n.duration){ cand=n; break; }
                }
                if(!cand){
                    for(const n of midiGhostNotes){
                        if(n && t>=n.time && t<=n.time+n.duration){ cand=n; break; }
                    }
                }
                if(cand) return cand.midi|0;
            }
        }catch(_){ }
        return null;
    }
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ鬲・ｼ夲ｽｽ・ｼ郢晢ｽｻ・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ蜀郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ髯ｦ・ｷ鬩募∞・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ鬆題ｪ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    function isCallAt(t){
        try{
            if(!isPracticing) return false;
            if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                for(const n of midiGhostNotes){
                    if(n && n.role==='call' && t>=n.time && t<=n.time+n.duration){ return true; }
                }
            }
        }catch(_){ }
        return false;
    }
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽIDI鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｺ・ｽ陜ｮ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let guideMidiAtPlayhead = null;
    if(!isPitchOnlyMode){
        try{
            const tr=currentTracks[melodyTrackIndex];
            const tRef = playbackPosition - getPitchVisOffsetSec();
            if(tr&&tr.notes&&tr.notes.length){
                const nn=tr.notes.find(n=> tRef>=n.time && tRef<=n.time+n.duration) || tr.notes.find(n=> n.time>tRef) || tr.notes[tr.notes.length-1];
                if(nn) guideMidiAtPlayhead = nn.midi|0;
            } else {
                // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const gM = ghostMidiAt(tRef);
                if(gM!=null) guideMidiAtPlayhead = gM;
            }
        }catch(_){ }
    }
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢ｧ螂・ｽｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let _assistSegments = null;
    if(isAssistActive()){
    const LAG_MS = Math.round((getPitchVisOffsetSec())*1000);
        const lag = LAG_MS/1000;
        const effStart = eff - (playX/pxPerSec)*tempoFactor - 1;
        const effEnd   = eff + ((w-playX)/pxPerSec)*tempoFactor + 1;
        const drawUntil = (playbackPosition - lag);
        const pts=[];
        for(const p of pitchHistory){
            const t = p.time + ((p.visOff!=null)? (p.visOff - curOff) : 0);
            if(!(t>=effStart && t<=effEnd)) continue; if(t>drawUntil) continue;
            if(typeof p.conf==='number' && p.conf < PITCH_CONF_MIN) continue;
            if(isCallAt(t)) continue;
            pts.push({t});
        }
        pts.sort((a,b)=>a.t-b.t);
        if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
            const TOL = 0.15; // 150ms
            const segs=[];
            for(const p of pts){
                let best=null, bd=1e9;
                for(const g of midiGhostNotes){ const c=g.time+(g.duration||0)/2; const d=Math.abs(p.t - c); if(d<bd){ bd=d; best=g; } }
                if(!best) continue;
                const dEdge = Math.min(Math.abs(p.t-best.time), Math.abs((best.time+(best.duration||0))-p.t));
                if(Math.min(bd, dEdge) > TOL) continue;
                const y = h - (best.midi - vmin + 1) * pxSemi - 3; // -3px 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
                const x1 = playX + ((p.t - 0.06 - eff) * pxPerSec / tempoFactor);
                const x2 = playX + ((p.t + 0.06 - eff) * pxPerSec / tempoFactor);
                if(x2<0 || x1>w) continue;
                segs.push({x1,x2,y});
            }
            if(segs.length) _assistSegments = segs;
        }
    }

    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣騾ｧ・ｮ騾包ｽ･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ魃会ｽｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    let allowDrawPitch = (isPitchOnlyMode || isPlaying);
    // 鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｫ・ｴ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ魃会ｽｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽC/鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(!allowDrawPitch){
        try{
            // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髣比ｼ夲ｽｽ・｣?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ0.5 鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ隲幢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ魃会ｽｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const tNow = playbackPosition - getPitchVisOffsetSec();
            const drawConfMin = IS_MOBILE ? DRAW_CONF_MIN_MOBILE : PITCH_CONF_MIN;
            for(let i=pitchHistory.length-1;i>=0;i--){ const p=pitchHistory[i]; if((tNow - p.time) > 0.5) break; if((p.conf==null) || (p.conf >= drawConfMin)){ allowDrawPitch = true; break; } }
        }catch(_){ }
    }
    if(!isCalibrating && pitchHistory.length && !isAssistActive() && allowDrawPitch){
    const LAG_MS = Math.round((getPitchVisOffsetSec())*1000); // 鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ莨懶ｽ､諛ｷ讀幃垈螟ｲ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ荵晢ｽ・繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜀ｶ・ｾ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣鬯・汚・ｽ・ｹ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髮朱ｯ会ｽｽ・｣鬮ｯ諞ｺ雎ｪ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣逧ｮ逕･鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢ｧ螂・ｽｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const CHANGE_TOL_SEMI = 0.5;      // 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｼ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const lag = LAG_MS/1000;
        const bridgeGap = Math.max(0.001, (1/Math.max(1,(analysisRate||20))) * 1.5);
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｻ隰趣ｽｺ諞ｺ蛹夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ髮｣・ｽ・｣髯句ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ魃会ｽｽ・｢髫ｲ・､郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const visStart = eff - (playX/pxPerSec)*tempoFactor - 1;
        const visEnd = eff + ((w-playX)/pxPerSec)*tempoFactor + 1;
        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟶壽桶・趣ｽ､?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ
        const drawUntil = (playbackPosition - lag);

    // 1) 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ魃会ｽｽ・｢髫ｲ・､郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽMIDI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽdCents鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const pts = [];
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髫ｨ・ｬ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const WIN = 0;
        for(let i=0;i<pitchHistory.length;i++){
            const p = pitchHistory[i];
            // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髦ｮ蜊搾ｽｧ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ諞ｺ螻ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷会ｽｱ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const t = p.time + ((p.visOff!=null)? (p.visOff - curOff) : 0);
            if(!(t>=visStart && t<=visEnd)) continue;
            if(t > drawUntil) continue;   // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛛・ｽｿ・ｽ?繝ｻ・ｽ髯ｷ閧ｴ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮｣蛹・ｽｽ・ｳ髴托ｽｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const drawConfMin = IS_MOBILE ? DRAW_CONF_MIN_MOBILE : PITCH_CONF_MIN;
            if(typeof p.conf==='number' && p.conf < drawConfMin) continue; // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            if(isCallAt(t)) continue;     // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽMIDI: 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陷托ｽｰ邵ｺ雋ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴取得・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ繝ｻ・ｽ?雎・屮・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｾ郢晢ｽｻ郢ｧ螂・ｽｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            let midi;
            let dCents = (p.dCents!=null && Number.isFinite(p.dCents))? p.dCents : null;
            midi = (69+12*Math.log2(Math.max(1e-9,p.freq)/A4Frequency));
            if(!(midi>=vmin && midi<=vmax)) continue;
            pts.push({t, midi, dCents, conf:(typeof p.conf==='number'? p.conf: 0.7), freq:p.freq});
        }
        if(pts.length){
            // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ郢晢ｽｻ1鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ C鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隶主･・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            try{
                const classes = new Map();
                for(const p of pts){
                    const pc = ((Math.round(p.midi)%12)+12)%12;
                    classes.set(pc, (classes.get(pc)||0)+1);
                }
                if(classes.size===1){
                    const onlyPc=[...classes.keys()][0];
                    __diagLog('c-only-visual', {
                        pc: onlyPc,
                        count: pts.length,
                        A4: A4Frequency,
                        visRange: {vmin, vmax},
                        states: {isCalibrating, practicing:isPracticing, assist:isAssistActive()},
                        micRenderMode
                    }, 4000);
                }
            }catch(_){ }
            // pitchHistory 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ繝ｻ・ｽ?遶包ｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・｣・ｰ闔会ｽｰ・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽpts 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ蛟ｬ・ｯ莨夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髫ｶ謚ｵ・ｽ・ｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ郢晢ｽｻ雎主､ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯晢ｽｶ隴擾ｽｴ隨卍?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(micRenderMode==='dot'){
                // 鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隰ｨ魑ｴﾂ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                ctx.save();
                for(const p of pts){
                    const y = h - (p.midi - vmin + 1) * pxSemi;
                    const x = playX + ((p.t - eff) * pxPerSec / tempoFactor);
                    if(x<0 || x>w) continue;
                    ctx.beginPath();
                    ctx.arc(x, y, 2.5, 0, Math.PI*2);
                    ctx.fillStyle = 'rgba(255,80,80,0.9)';
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 1.2;
                    ctx.fill(); ctx.stroke();
                }
                ctx.restore();
            } else if(micRenderMode==='graph'){
                // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ陜ｮ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ髮趣ｽｸ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ髦ｮ蜊搾ｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜍溪酪隰・ｽｱ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ陝・ｈ蜊・・・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                const CHANGE_TOL_SEMI = 0.5;      // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                const bridgeGap = Math.max(0.02, (1/Math.max(1,(analysisRate||20))) * 1.8);
                // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬆托ｽｨ・｣邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髫ｶ蜴・ｽｽ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ驕擾ｽｩ陞ｳ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ: 3鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謇具ｽｴ蜈ｷ・ｽ・ｾ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ[1,2,1]/4 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽｳ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                (function smoothDisplayPoints(){
                    if(pts.length<3) return;
                    const sm = new Array(pts.length);
                    for(let i=0;i<pts.length;i++){
                        if(i===0 || i===pts.length-1){ sm[i] = { ...pts[i] }; }
                        else {
                            const m = (pts[i-1].midi + 2*pts[i].midi + pts[i+1].midi)/4;
                            sm[i] = { ...pts[i], midi: m };
                        }
                    }
                    for(let i=0;i<pts.length;i++){ pts[i].midi = sm[i].midi; }
                })();
                // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｿ・ｽ?隰ｳ・ｨ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const segs=[]; // {pts:[{x,y,t,midi,inTol,conf}]}
                let cur=null; let last=null;
                for(const p of pts){
                    const x = playX + ((p.t - eff) * pxPerSec / tempoFactor);
                    const y = h - (p.midi - vmin + 1) * pxSemi;
                    const inTol = (p.dCents!=null)? (Math.abs(p.dCents) <= (toleranceCents||0)) : false;
                    if(x<0 || x>w){ last=p; continue; }
                    const voiced = (p.conf==null? true: p.conf>=0.3);
                    if(!voiced){ last=p; continue; }
                    const isCont = last? ((p.t - last.t) <= bridgeGap && Math.abs(p.midi - last.midi) <= CHANGE_TOL_SEMI) : false;
                    if(!cur || !isCont){
                        if(cur && cur.pts.length>=2) segs.push(cur);
                        cur = { pts:[{x,y,t:p.t,midi:p.midi,inTol,conf:p.conf}] };
                    } else {
                        cur.pts.push({x,y,t:p.t,midi:p.midi,inTol,conf:p.conf});
                    }
                    last=p;
                }
                if(cur && cur.pts.length>=2) segs.push(cur);
                // 鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ驕擾ｽｩ陞ｳ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｸ蜿ｯﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                function drawSmoothedPolyline(ctx, points){
                    if(!points || points.length<2) return;
                    ctx.beginPath();
                    if(points.length===2){
                        ctx.moveTo(points[0].x, points[0].y);
                        ctx.lineTo(points[1].x, points[1].y);
                        ctx.stroke();
                        return;
                    }
                    ctx.moveTo(points[0].x, points[0].y);
                    for(let i=1;i<points.length-1;i++){
                        const xc=(points[i].x + points[i+1].x)/2;
                        const yc=(points[i].y + points[i+1].y)/2;
                        ctx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);
                    }
                    ctx.lineTo(points[points.length-1].x, points[points.length-1].y);
                    ctx.stroke();
                }
                function splitRuns(points, predicate){
                    const runs=[]; let run=[];
                    for(const pt of points){
                        if(predicate(pt)){
                            run.push(pt);
                        } else {
                            if(run.length>=2) runs.push(run);
                            run=[];
                        }
                    }
                    if(run.length>=2) runs.push(run);
                    return runs;
                }
                // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜍溪酪隰・ｽｱ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ髮趣ｽｸ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ
                ctx.save();
                ctx.lineWidth = 2.0;
                // 鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ霑ｺ・ｰ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ・ｽ雎ｬ・ｹ髯樊ｻ・ｮｦ?繝ｻ・ｽ繝ｻ・ｽ隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                ctx.strokeStyle = 'rgba(255,120,120,0.9)';
                for(const s of segs){
                    const runs = splitRuns(s.pts, (pt)=>!pt.inTol);
                    for(const r of runs){ drawSmoothedPolyline(ctx, r); }
                }
                // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ遶包ｽｧ鬮ｯ諞ｺ螻ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                ctx.strokeStyle = 'rgba(24,200,70,0.98)';
                for(const s of segs){
                    const runs = splitRuns(s.pts, (pt)=>pt.inTol);
                    for(const r of runs){ drawSmoothedPolyline(ctx, r); }
                }
                ctx.restore();
            } else {
                // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬯滂ｽｴ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
                // 2) 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                let run=null; // {t0, t1, sumMidi, sumW, lastT, baseKey, inTol, outTol, confSum, cnt, samples:[]}
                const flushRun=(r)=>{
                if(!r) return;
                const mAvg = r.sumMidi / Math.max(1e-6, r.sumW);
                const y = h - (mAvg - vmin + 1) * pxSemi;
                const x1 = playX + ((r.t0 - eff) * pxPerSec / tempoFactor);
                const x2 = playX + ((r.t1 - eff) * pxPerSec / tempoFactor);
                if(x2<0 || x1>w) return;
                // 鬮ｮ雜｣・ｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?: 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ0%鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴擾ｽｴ?繝ｻ・ｽ?鬮ｫ・ｰ郢晢ｽｻ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const tol = toleranceCents||0;
                const okRatio = (r.inTol + r.outTol) > 0 ? (r.inTol/(r.inTol + r.outTol)) : 0;
                const alpha = Math.max(0.35, Math.min(1, 0.45 + 0.55*(r.confSum/Math.max(1,r.cnt)) ));
                if(okRatio >= 0.5){
                    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謳ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ+ 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ+ 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?髫ｶ魃会ｽｽ・｢髯ｷ・ｿ髯具ｽｾ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const yOff = y - 3; // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ郢晢ｽｻ 3px
                    ctx.save();
                    // 鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢晢ｽｻ隴壽ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    ctx.lineWidth = 6;
                    ctx.strokeStyle = `rgba(255,255,255,${alpha*0.95})`;
                    ctx.beginPath(); ctx.moveTo(x1, yOff); ctx.lineTo(x2, yOff); ctx.stroke();
                    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = `rgba(24,200,70,${alpha})`;
                    ctx.beginPath(); ctx.moveTo(x1, yOff); ctx.lineTo(x2, yOff); ctx.stroke();
                    ctx.restore();
                } else {
                    ctx.save();
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = `rgba(255,64,64,${alpha})`;
                    ctx.beginPath(); ctx.moveTo(x1, y); ctx.lineTo(x2, y); ctx.stroke();
                    ctx.restore();
                }

                // 鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｱ髯晢ｽｶ隰ｨ魑ｴﾂ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                try{
                    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ.3s鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const dur = (r.t1 - r.t0);
                    if(dur >= 0.3 && r.samples && r.samples.length >= 5){
                        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ魃会ｽｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ陷托ｽｲ鬮ｫ・ｲ陝ｶ蟶ｷ讓・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                        const mids = r.samples.map(s=> s.midi);
                        const times = r.samples.map(s=> s.t);
                        const med = mids.slice().sort((a,b)=>a-b)[Math.floor(mids.length/2)];
                        const cents = mids.map(m=> (m - med)*100);
                        // 1鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隶主･・ｽｿ・ｽ?繝ｻ・ｽ髯懶ｽｮ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謇具ｽｴ蜈ｷ・ｽ・ｾ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        const win = Math.max(1, Math.floor(Math.min(7, Math.max(3, Math.round(r.samples.length*0.12)))));
                        const detr = cents.map((v,i)=>{
                            let s=0,c=0; for(let k=-win;k<=win;k++){ const j=i+k; if(j>=0&&j<cents.length){ s+=cents[j]; c++; } }
                            const ma = s/Math.max(1,c); return v - ma;
                        });
                        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｬ郢晢ｽｻ髫ｨ・ｳ郢晢ｽｻ・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ雜｣・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ郢晢ｽｻ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽHz鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        let zc=0; for(let i=1;i<detr.length;i++){ if((detr[i-1]<=0 && detr[i]>0) || (detr[i-1]>=0 && detr[i]<0)) zc++; }
                        const fs = Math.max(1e-6, r.cnt / Math.max(1e-6, dur)); // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ/鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｿ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣鬯・汚・ｽ・ｹ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｧ・ｭ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        const estHz = (zc/2) / Math.max(1e-6, dur); // 鬯ｯ・ｩ陜難ｽｼ?繝ｻ・ｽ繝ｻ・ｽ驕呈汚・ｽ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽeak-to-peak鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ遶乗劼・ｽ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        const minV = Math.min(...detr), maxV=Math.max(...detr);
                        const amp = (maxV - minV)/2; // cents
                        const vibOK = (estHz>=3.5 && estHz<=8.5 && amp>=20);
                        if(vibOK){
                            // 鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                            const ampPx = Math.min(6, Math.max(3, (amp/100)*pxSemi*0.9)); // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?繝ｻ・ｽ繝ｻ・ｽ陞溽浹遒托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ繝ｻ・ｽ?鬲・ｸ幃倹x鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ譎｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ.9鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                            const yWave = y - 8; // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                            const fHz = estHz;
                            // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                            const step = Math.max(2, Math.floor((x2-x1)/48));
                            ctx.save();
                            ctx.lineWidth = 2;
                            ctx.strokeStyle = 'rgba(120,200,255,0.9)';
                            ctx.beginPath();
                            const totalPx = x2 - x1;
                            const twoPiF = 2*Math.PI*fHz;
                            for(let i=0;i<=Math.max(1, Math.floor(totalPx/step)); i++){
                                const px = x1 + i*step;
                                if(px<x1 || px> x2) continue;
                                const tt = r.t0 + ( (px - x1) / (x2 - x1) ) * dur; // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                                const phase = twoPiF * (tt - r.t0);
                                const yy = yWave - ampPx * Math.sin(phase);
                                if(i===0) ctx.moveTo(px, yy); else ctx.lineTo(px, yy);
                            }
                            ctx.stroke();
                            ctx.restore();
                        }
                    }
                }catch(_){ }
            };
            // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ陞溽浹雋ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ蟇よｲ夜勳・ｸ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?繝ｻ・ｽ繝ｻ・ｽ陞溽浹遒托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const DRIFT_SPLIT_SEMI = 0.18; // 鬯ｩ蛹・ｽｽ・ｶ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ18 cents
            const DRIFT_MIN_DUR = 0.25;    // 0.25s 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ陋滂ｽｩ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｾ髯懶ｽｨ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｨ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            for(const p of pts){
                    const key = Math.round(p.midi); // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ郢晢ｽｻ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const w = 0.5 + 0.5*p.conf;
                    if(!run){
                        run = { t0:p.t, t1:p.t, sumMidi:p.midi*w, sumW:w, lastT:p.t, baseKey:key, inTol:0, outTol:0, confSum:p.conf, cnt:1, samples:[{t:p.t, midi:p.midi}] };
                        if(p.dCents!=null){ (Math.abs(p.dCents) <= (toleranceCents||0)) ? run.inTol++ : run.outTol++; }
                        continue;
                    }
                    const gap = p.t - run.lastT;
                    const lastMidiInRun = run.samples[run.samples.length-1]?.midi ?? (run.sumMidi/Math.max(1e-6,run.sumW));
                    const mAvgCur = run.sumMidi/Math.max(1e-6,run.sumW);
                    const deltaToKey = Math.abs(p.midi - run.baseKey);
                    const deltaToLast = Math.abs(p.midi - lastMidiInRun);
                    const deltaToAvg  = Math.abs(p.midi - mAvgCur);
                    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ・ｩ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣比ｼ夲ｽｽ・｣?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謇具ｽｴ蜈ｷ・ｽ・ｾ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜍滂ｽｸ譎｢・ｿ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩墓得・ｽ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｽ・ｫ髯樊ｻゑｽｽ・｢鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const continuous = (gap <= bridgeGap) && ( (deltaToLast <= CHANGE_TOL_SEMI*1.2) || (deltaToAvg <= CHANGE_TOL_SEMI) || (deltaToKey <= CHANGE_TOL_SEMI*0.9) );
                    if(continuous){
                        // 鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ陞溯・・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜍溪酪隰・ｽｱ?繝ｻ・ｽ?陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        const durRun = (run.lastT - run.t0);
                        if(durRun >= DRIFT_MIN_DUR && Math.abs(p.midi - mAvgCur) > DRIFT_SPLIT_SEMI){
                            // 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ run 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ? run 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ魃会ｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｲ郢ｧ莨夲ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                            __diagLog('line-split-drift', {dur:durRun, drift:Math.abs(p.midi - mAvgCur), tol:DRIFT_SPLIT_SEMI}, 4000);
                            flushRun(run);
                            run = { t0:p.t, t1:p.t, sumMidi:p.midi*w, sumW:w, lastT:p.t, baseKey:key, inTol:0, outTol:0, confSum:p.conf, cnt:1, samples:[{t:p.t, midi:p.midi}] };
                            if(p.dCents!=null){ (Math.abs(p.dCents) <= (toleranceCents||0)) ? run.inTol++ : run.outTol++; }
                        } else {
                            run.t1 = p.t; run.lastT = p.t;
                            run.sumMidi += p.midi*w; run.sumW += w;
                            run.confSum += p.conf; run.cnt++;
                            run.samples.push({t:p.t, midi:p.midi});
                            if(p.dCents!=null){ (Math.abs(p.dCents) <= (toleranceCents||0)) ? run.inTol++ : run.outTol++; }
                        }
                    } else {
                        // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽrun鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ閧ｴ・ｻ髮｣・ｽ・ｲ遶擾ｽｬ雎ｼ・､髫ｰ魃会ｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｲ郢ｧ莨夲ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        flushRun(run);
                        run = { t0:p.t, t1:p.t, sumMidi:p.midi*w, sumW:w, lastT:p.t, baseKey:key, inTol:0, outTol:0, confSum:p.conf, cnt:1, samples:[{t:p.t, midi:p.midi}] };
                        if(p.dCents!=null){ (Math.abs(p.dCents) <= (toleranceCents||0)) ? run.inTol++ : run.outTol++; }
                    }
                }
                flushRun(run);
            }
        }
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ闕ｵ證ｦ・ｽ・ｪ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬆托ｽｨ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ
    }
    // 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽIDI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蟇よ・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ闌ｨ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ荵晢ｽ郁攬・ｩ髫ｨ蜷ｶ・願ｮ梧・豢・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓幢ｾつ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴取得・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲ｷ諷墓ｫｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｧ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬆托ｽｨ・｣・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴取得・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ PC/鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬆托ｽｨ・｣・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴取得・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    if(Array.isArray(midiGhostNotes) && midiGhostNotes.length && (!isPitchOnlyMode || isPracticing)){
    const visStart=eff - (playX/pxPerSec)*tempoFactor - 1; const visEnd=eff + ((w-playX)/pxPerSec)*tempoFactor + 1;
        ctx.save();
        ctx.lineWidth = Math.max(2, guideLineWidth);
    for(const n of midiGhostNotes){
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            if(n.role==='resp' || n.role==='calib'){
                ctx.strokeStyle = '#4e8cff';
                ctx.setLineDash([]);
            }else if(n.role==='call'){
                ctx.strokeStyle = 'rgba(255,80,80,0.9)';
                ctx.setLineDash([6,4]);
            }else{
                // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽIDI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                ctx.strokeStyle = 'rgba(255,80,80,0.9)';
                ctx.setLineDash([6,4]);
            }
            const st=n.time, en=n.time+n.duration;
            if(en<visStart || st>visEnd) continue;
            const x1=playX+(st-eff)*pxPerSec/tempoFactor;
            const x2=playX+((en)-eff)*pxPerSec/tempoFactor;
            if(x2<0 || x1>w) continue;
            // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｶ鬮ｯ讖ｸ・ｽ・ｺ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ陞溘ｑ・ｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ荵晢ｽ郁攬・ｩ髫ｨ蜷ｶ・願ｮ梧・豢・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ call/resp/calib 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const dispMidi = (practiceMode==='basic' && (n.role==='call' || n.role==='resp' || n.role==='calib'))
                ? (n.midi + (practiceCallDisplayOctShift|0))
                : n.midi;
            const y=h-(dispMidi-vmin+1)*pxSemi;
            ctx.beginPath();
            ctx.moveTo(x1,y);
            ctx.lineTo(x2,y);
            ctx.stroke();
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ: 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶夲ｽｨ鬯ｯ・ｪ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ螂・ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛δｧ陷ｿ蜻ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴取得・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽall/resp 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ謨鳴郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(n.role==='call' || n.role==='resp'){
                try{
                    const lbl = noteLabel(Math.round(dispMidi));
                    ctx.save();
                    ctx.font='12px sans-serif';
                    ctx.textAlign='center'; ctx.textBaseline='bottom';
                    const textX = (x1+x2)/2, textY = y-6;
                    const tw=ctx.measureText(lbl).width;
                    ctx.fillStyle='rgba(0,0,0,0.6)';
                    ctx.fillRect(textX - tw/2 - 4, textY-16, tw+8, 14);
                    ctx.fillStyle = (n.role==='call')? '#ffd27d' : '#d6f0ff';
                    ctx.fillText(lbl, textX, textY-2);
                    ctx.restore();
                }catch(_){ }
            }
            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽesp鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶夲ｽｨ鬯ｯ・ｩ雋・ｽｽ?繝ｻ・ｽ繝ｻ・ｽ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蛹ｺ・･・ｪ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(n.role==='resp'){
                const dy = (toleranceCents/100) * pxSemi;
                if(dy>0.2){
                    ctx.save();
                    ctx.setLineDash([]);
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = '#ffffff';
                    // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    ctx.beginPath(); ctx.moveTo(x1, y - dy); ctx.lineTo(x2, y - dy); ctx.stroke();
                    // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    ctx.beginPath(); ctx.moveTo(x1, y + dy); ctx.lineTo(x2, y + dy); ctx.stroke();
                    ctx.restore();
                }
            }
        }
        ctx.restore();
    }
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ霑ｺ・ｰ・つ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・｢髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｸ橸ｽｯ・ｰ鬮ｯ・ｷ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUP鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲ｷ諷墓ｫｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｧ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬆托ｽｨ・｣・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
    if(_assistSegments && _assistSegments.length && (!isPitchOnlyMode || (IS_MOBILE && isPracticing))){
        ctx.save();
        for(const s of _assistSegments){
            // 鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢晢ｽｻ隴壽ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            ctx.lineWidth = 5;
            ctx.strokeStyle = 'rgba(255,255,255,0.9)';
            ctx.beginPath(); ctx.moveTo(s.x1, s.y); ctx.lineTo(s.x2, s.y); ctx.stroke();
            // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            ctx.lineWidth = 3;
            ctx.strokeStyle = 'rgba(24,200,70,0.95)';
            ctx.beginPath(); ctx.moveTo(s.x1, s.y); ctx.lineTo(s.x2, s.y); ctx.stroke();
        }
        ctx.restore();
    }
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ (鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｶ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(!isCalibrating && lastMicFreq>0){
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? or 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陋ｹ竏ｵ貍・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髮主叙・ｨ謚ｵ・ｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ繝ｻ・ｽ?雎・屮・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽMIDI鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽastMicFreq鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let midi = 69 + 12*Math.log2(lastMicFreq/A4Frequency);
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽIDI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴取得・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽMIDI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const canShowLive = (function(){
            try{
                // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ雋・ｽｽ?繝ｻ・ｽ繝ｻ・ｽ陞滂ｽｧ陋ｻ譎｢・ｿ・ｽ?繝ｻ・ｽ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ邵ｺ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ魃会ｽｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const tRef = playbackPosition - getPitchVisOffsetSec();
                const drawConfMin = IS_MOBILE ? DRAW_CONF_MIN_MOBILE : PITCH_CONF_MIN;
                for(let i=pitchHistory.length-1;i>=0;i--){ const p=pitchHistory[i]; if((tRef - p.time) > 0.25) break; if(Math.abs(p.time - tRef) <= 0.12){ return (p.conf==null) || (p.conf >= drawConfMin); } }
            }catch(_){ }
            return true; // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        })();
        if(canShowLive && midi>=vmin && midi<=vmax){
            const y=h-(midi-vmin+1)*pxSemi;
            // 鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ譴ｧ・ｺ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            ctx.beginPath(); ctx.arc(playX,y,8,0,Math.PI*2); ctx.fillStyle='rgba(255,80,80,0.9)'; ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.fill(); ctx.stroke();
            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const label=noteLabel(Math.round(midi));
            ctx.font='12px sans-serif'; ctx.textAlign='left'; ctx.textBaseline='middle';
            const tx=playX+12; const ty=y;
            ctx.fillStyle='rgba(0,0,0,0.6)'; const pad=4; const tw=ctx.measureText(label).width; ctx.fillRect(tx-2,ty-10,tw+pad+2,16);
            ctx.fillStyle='#ffe'; ctx.fillText(label,tx,ty);
            // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髴難ｽ｣陋滂ｽ｡陷・ｽｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髮手ｶ｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｺ・ｽ陜ｮ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            try{
                if(!isPitchOnlyMode){
                const tr=currentTracks[melodyTrackIndex];
                if(tr && tr.notes && tr.notes.length){
                    const t=playbackPosition; const nn=tr.notes.find(n=> t>=n.time && t<=n.time+n.duration) || tr.notes.find(n=> n.time>t) || tr.notes[tr.notes.length-1];
                    if(nn){
                        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髴難ｽ｣關捺汚・ｽ・ｿIDI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        let mTar = nn.midi; let mLive = Math.round(midi);
                        while(mLive - mTar > 6) mTar += 12; while(mTar - mLive > 6) mTar -= 12;
                        const fTar = midiToFreq(mTar);
                        const dCents = 1200*Math.log2(Math.max(1e-9,lastMicFreq)/Math.max(1e-9,fTar));
                        const centsTxt = (dCents>=0? '+':'') + Math.round(dCents) + 'c';
                        const within = Math.abs(dCents) <= (toleranceCents||0);
                        const cx = tx + tw + 10;
                        const cy = ty;
                        const ctW = ctx.measureText(centsTxt).width + 8;
                        ctx.fillStyle = 'rgba(0,0,0,0.6)';
                        ctx.fillRect(cx-2, cy-10, ctW+2, 16);
                        ctx.fillStyle = within? '#aef0ae' : '#ffd6a6';
                        ctx.fillText(centsTxt, cx+2, cy);
                    }
                }
                }
            }catch(_){ }
        }

        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽC/鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{
            // noteLabel() 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ labelNotation 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ?髫ｰ迹夲ｽｴ蜈ｷ・ｽ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ CDE/鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
            const liveRoundMidi = Math.round(midi);
            const liveLabel = noteLabel(liveRoundMidi);
            // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｺ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・＠?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ4.5%鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ荵怜煙?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ8px鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const fontPx = Math.max(12, Math.min(18, Math.floor(h*0.045)));
            ctx.save();
            ctx.font = `bold ${fontPx}px sans-serif`;
            ctx.textAlign = 'left'; ctx.textBaseline = 'top';
            const padX = 10, padY = 6;
            const x0 = 8, y0 = 8; // 鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ鬮ｷ・ｫ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const tw = ctx.measureText(liveLabel).width;
            const boxW = Math.floor(tw + padX*2);
            const boxH = Math.floor(fontPx + padY*2);
            // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｼ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髯ｷ莨夲ｽｽ・ｱ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            ctx.fillStyle = 'rgba(0,0,0,0.55)';
            ctx.fillRect(x0, y0, boxW, boxH);
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            ctx.fillStyle = '#fff';
            ctx.fillText(liveLabel, x0 + padX, y0 + padY);
            ctx.restore();
        }catch(_){ }
    }
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・皮ｹ晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｴ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(isCalibrating && calibCountdownText){
        ctx.save();
        ctx.globalAlpha = 1;
        const msg = String(calibCountdownText);
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髴難ｽ｣陋滂ｽ｡陷・ｽｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let anchorX = null, anchorY = null;
        try{
            if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                const visStart=eff - (playX/pxPerSec)*tempoFactor - 1;
                const visEnd  =eff + ((w-playX)/pxPerSec)*tempoFactor + 1;
                for(const n of midiGhostNotes){
                    const st=n.time, en=st+n.duration;
                    if(en<visStart || st>visEnd) continue;
                    const x1=playX+(st-eff)*pxPerSec/tempoFactor;
                    const x2=playX+((en)-eff)*pxPerSec/tempoFactor;
                    const y=h-(n.midi-vmin+1)*pxSemi;
                    anchorX = Math.max(40, Math.min(w-40, (x1+x2)/2));
                    anchorY = Math.max(40, Math.min(h-40, y - 36));
                    break;
                }
            }
        }catch(_){ }
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｯ髫ｴ莨夲ｽｽ・ｮ髯懶ｽｮ隴幢ｽｱ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(anchorX==null || anchorY==null){
            if(calibAnchorActive){
                try{
                    const xRaw = playX + ((calibAnchorTime - eff) * pxPerSec/tempoFactor);
                    const yRaw = h - ((calibAnchorMidi - vmin + 1) * pxSemi);
                    anchorX = Math.max(40, Math.min(w-40, xRaw));
                    anchorY = (yRaw>=40 && yRaw<=h-40)? Math.round(yRaw - 36) : Math.floor(h*0.35);
                }catch(_){ }
            }
            if(anchorX==null || anchorY==null){ anchorX=Math.floor(w*0.5); anchorY=Math.floor(h*0.35); }
        }
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const fontPx = Math.floor(h*0.22);
        ctx.font = `bold ${fontPx}px sans-serif`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        const padX=18, padY=10; const metrics = ctx.measureText(msg);
        const textW = Math.max(metrics.width, fontPx*0.6);
        const boxW = Math.floor(textW + padX*2); const boxH = Math.floor(fontPx + padY*2);
        const bx = Math.floor(anchorX - boxW/2); const by = Math.floor(anchorY - boxH/2);
        ctx.fillStyle='rgba(0,0,0,0.55)';
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・､隲幢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ驕倥・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const r=12; ctx.beginPath();
        ctx.moveTo(bx+r,by); ctx.lineTo(bx+boxW-r,by); ctx.quadraticCurveTo(bx+boxW,by,bx+boxW,by+r);
        ctx.lineTo(bx+boxW,by+boxH-r); ctx.quadraticCurveTo(bx+boxW,by+boxH,bx+boxW-r,by+boxH);
        ctx.lineTo(bx+r,by+boxH); ctx.quadraticCurveTo(bx,by+boxH,bx,by+boxH-r);
        ctx.lineTo(bx,by+r); ctx.quadraticCurveTo(bx,by,bx+r,by); ctx.closePath(); ctx.fill();
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ霑ｺ・ｰ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ驕倥・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ驕倥・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        ctx.shadowColor='rgba(255,40,40,0.9)'; ctx.shadowBlur=12; ctx.lineWidth=8; ctx.strokeStyle='rgba(0,0,0,0.8)'; ctx.fillStyle='#fff';
        ctx.strokeText(msg, anchorX, anchorY+2);
        ctx.fillText(msg, anchorX, anchorY+2);
        ctx.shadowBlur=0;
        ctx.restore();
    }
    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・辨・ｳ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶夲ｽｨ鬯ｯ・ｪ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ螂・ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・皮ｹ晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        if(isPracticing && Array.isArray(midiGhostNotes) && midiGhostNotes.length){
            // 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ邵ｺ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ髯樊ｻゑｽｽ・｢鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽcall 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const now = playbackPosition + timelineOffsetSec;
            let curLabel = null;
            for(const n of midiGhostNotes){
                if(n.role!=='call' || !n.label) continue;
                const st=n.time, en=n.time+n.duration;
                if(now>=st && now<=en){ curLabel=n.label; break; }
            }
            if(curLabel){
                ctx.save();
                // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ驕ｶ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ繝ｻ・ｿ・ｽ???郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｰ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const W=w, H=h; const anchorX = Math.floor(W*0.5); const anchorY = Math.floor(H*0.18);
                const fontPx = Math.max(20, Math.floor(h*0.08));
                ctx.font = `bold ${fontPx}px sans-serif`;
                ctx.textAlign='center'; ctx.textBaseline='middle';
                const txt = String(curLabel);
                const padX=14, padY=8; const metrics = ctx.measureText(txt);
                const textW = metrics.width; const boxW = Math.floor(textW + padX*2), boxH=Math.floor(fontPx + padY*2);
                const bx = Math.floor(anchorX - boxW/2), by=Math.floor(anchorY - boxH/2);
                ctx.fillStyle='rgba(0,0,0,0.55)';
                const r=10; ctx.beginPath();
                ctx.moveTo(bx+r,by); ctx.lineTo(bx+boxW-r,by); ctx.quadraticCurveTo(bx+boxW,by,bx+boxW,by+r);
                ctx.lineTo(bx+boxW,by+boxH-r); ctx.quadraticCurveTo(bx+boxW,by+boxH,bx+boxW-r,by+boxH);
                ctx.lineTo(bx+r,by+boxH); ctx.quadraticCurveTo(bx,by+boxH,bx,by+boxH-r);
                ctx.lineTo(bx,by+r); ctx.quadraticCurveTo(bx,by,bx+r,by); ctx.closePath(); ctx.fill();
                ctx.fillStyle='#ffd27d'; ctx.strokeStyle='rgba(0,0,0,0.85)'; ctx.lineWidth=4;
                ctx.strokeText(txt, anchorX, anchorY+1);
                ctx.fillText(txt, anchorX, anchorY+1);
                ctx.restore();
            }
        }
    }catch(_){ }
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎・・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        ctx.save();
        const labels = Object.keys(markers||{});
        for(const k of labels){
            const t = markers[k];
            if(typeof t!=="number") continue;
            const x=playX+((t-eff)*pxPerSec/tempoFactor);
            if(x<0||x>w) continue; // 鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ闌ｨ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ髦ｮ蜊搾ｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ陋滂ｽｩ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ鬮｣諛ｶ・ｽ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ驍ｵ・ｺ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ
            ctx.strokeStyle = '#0ff';
            ctx.fillStyle = '#0ff';
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x-5, 10); ctx.lineTo(x+5, 10); ctx.closePath(); ctx.fill();
            ctx.beginPath(); ctx.moveTo(x, 10); ctx.lineTo(x, Math.min(24,h)); ctx.stroke();
            ctx.fillStyle='#cff'; ctx.font='11px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillText(k, x, 26);
        }
        ctx.restore();
    }catch(_){ }
    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｺ・ｽ陜ｮ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        if(isPitchOnlyMode){
            const pad = 10;
            const label = '鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｺ・ｽ陜ｮ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ;
            ctx.save();
            ctx.font = 'bold 13px sans-serif';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'top';
            const tw = ctx.measureText(label).width;
            const boxW = Math.ceil(tw + 12);
            const boxH = 22;
            const x = (chartCanvas?.width||0) - pad - boxW;
            const y = pad;
            // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｼ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髯ｷ莨夲ｽｽ・ｱ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・､隲幢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            ctx.fillStyle = 'rgba(0,0,0,0.55)';
            const r = 8; ctx.beginPath();
            ctx.moveTo(x+r, y); ctx.lineTo(x+boxW-r, y); ctx.quadraticCurveTo(x+boxW, y, x+boxW, y+r);
            ctx.lineTo(x+boxW, y+boxH-r); ctx.quadraticCurveTo(x+boxW, y+boxH, x+boxW-r, y+boxH);
            ctx.lineTo(x+r, y+boxH); ctx.quadraticCurveTo(x, y+boxH, x, y+boxH-r);
            ctx.lineTo(x, y+r); ctx.quadraticCurveTo(x, y, x+r, y); ctx.closePath(); ctx.fill();
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            ctx.fillStyle = '#fff';
            ctx.fillText(label, x + boxW - 6, y + Math.floor((boxH-13)/2));
            ctx.restore();
        }
    }catch(_){ }
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｸ蜿ｯﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ闖ｫ・ｶ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    ctx.strokeStyle='#ffffff'; ctx.beginPath(); ctx.moveTo(playX+0.5,0); ctx.lineTo(playX+0.5,h); ctx.stroke();
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    updateTimelineScrollRange();
}

// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ繝ｻ・ｽ?郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ鍋ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ螳育櫨隲｢蟷・建郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function setSelectionByPlayhead(){
    try{
        if(!editToolbar || editToolbar.classList.contains('hidden')) return; // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶夲ｽｨ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes||!tr.notes.length) return;
        const sel=window._selection||{type:'none'};
        // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謇具ｽｴ蜈ｷ・ｽ・ｾ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(sel.type==='range') return;
        const t = playbackPosition; // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｷ楪?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・つ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ闕ｵ證ｦ・ｽ・ｪ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ髫ｰ魃会ｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｲ郢ｧ莨夲ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｨ鬮ｯ讖ｸ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髮朱ｯ会ｽｽ・｣鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        let idx=-1;
        for(let i=0;i<tr.notes.length;i++){ const n=tr.notes[i]; if(t>=n.time && t<=n.time+n.duration){ idx=i; break; } }
        if(idx<0){
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            let bestIdx=-1, bestDist=1e9;
            for(let i=0;i<tr.notes.length;i++){
                const n=tr.notes[i];
                const d = (t < n.time)? (n.time - t) : (t - (n.time+n.duration));
                if(d < bestDist){ bestDist=d; bestIdx=i; }
            }
            idx = bestIdx;
        }
        if(idx>=0){ setSingleSelection(idx,{audition:false}); }
    }catch(_){ }
}
// 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髮狗甥謌溯怎・ｵ髫ｲ・､?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
window._selection = { type:'none', index:null, startSec:null, endSec:null };
let _rangePending = null; // {startIdx, startTime}
function setSingleSelection(idx, opts){
    const audition = (opts && opts.audition===false)? false: true;
    window._selection = { type:'single', index:idx, startSec:null, endSec:null };
    if(audition){
        try{
            const tr=currentTracks[melodyTrackIndex];
            if(tr&&tr.notes&&tr.notes[idx]){
                ensureAudio();
                const m=Math.max(36,Math.min(127,tr.notes[idx].midi));
                const d=Math.min(tr.notes[idx].duration||0.4, 0.6);
                // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬲・ｼ夲ｽｽ・ｼ郢晢ｽｻ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                if(!practiceCallGain && audioCtx){ practiceCallGain = audioCtx.createGain(); practiceCallGain.gain.value=0.9; try{ (masterGain||audioCtx.destination) && practiceCallGain.connect(masterGain||audioCtx.destination); }catch(_){ practiceCallGain.connect(audioCtx.destination); } }
                const ok = simplePlaySfz(m, (audioCtx?audioCtx.currentTime:0)+0.02, d, practiceCallGain||masterGain||audioCtx?.destination);
                if(!ok && audioCtx){
                    try{ const osc=audioCtx.createOscillator(); const g=audioCtx.createGain(); osc.frequency.value=440*Math.pow(2,(m-69)/12); g.gain.setValueAtTime(0,audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.9,audioCtx.currentTime+0.01); g.gain.linearRampToValueAtTime(0,audioCtx.currentTime+d); osc.connect(g); g.connect(practiceCallGain||masterGain||audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+d+0.02); }catch(_){ }
                }
            }
        }catch(_){ }
    }
    drawChart();
}
function setRangeSelection(aSec,bSec){ const s=Math.min(aSec,bSec), e=Math.max(aSec,bSec); window._selection = { type:'range', index:null, startSec:s, endSec:e }; drawChart(); }
function clearSelection(){ window._selection = { type:'none', index:null, startSec:null, endSec:null }; drawChart(); }
function viewToTime(x,eff,playX){ return (x - playX) / pxPerSec * tempoFactor + eff; }
function hitTestNote(x,y){ const tol=6; const rects=noteRectsGlobal||[]; for(let i=0;i<rects.length;i++){ const r=rects[i]; if(x>=r.x1 && x<=r.x2 && Math.abs(y-r.y)<=tol) return r.idx; } return null; }
// 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?
let draggingRange=false, dragStartX=0;
if(chartCanvas){
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?鬮｣雋ｻ・ｽ・ｨ髫ｲ蟷・か?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隶主･・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ髫ｨ・ｳ驕擾ｽｩ・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴擾ｽｴ?繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・｡郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隴ｴ・ｧ雎主､ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let swipeYActive=false, swipeStartY=0, swipePointerId=null;
    let swipeStartRelSemi=0, swipeAllowRangeSemi=0, swipePxPerSemi=1, swipeH=1;
    chartCanvas.addEventListener('pointerdown',(e)=>{
        if(isAdjustingVOffset) return; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ謇假ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ髮｣・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const total = verticalZoom*12; // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const min=36, max=132; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?關難ｽｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const allowRange = Math.max(0, (max-min-total)); // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        swipeAllowRangeSemi = allowRange;
        swipeH = chartCanvas.height||1;
        swipePxPerSemi = (swipeH>0 && total>0)? (swipeH/total) : 1; // px / semi
        const relSemi = (verticalOffset/100) * allowRange; // 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        swipeStartRelSemi = relSemi;
        swipeYActive=true; swipeStartY=e.clientY; swipePointerId=e.pointerId; try{ chartCanvas.setPointerCapture(e.pointerId); }catch(_){ }
    });
    chartCanvas.addEventListener('pointermove',(e)=>{
        if(isAdjustingVOffset) return; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ謇假ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(!swipeYActive) return; if(swipePointerId!=null && e.pointerId!==swipePointerId) return; const dy = e.clientY - swipeStartY;
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ髮｣・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽy > 0: 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? 鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?鬨ｾ雜｣・ｽ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・｡郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ髯溷私・ｽ・ｳlSemi 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｽ・ｷ?髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const deltaSemi = dy / (swipePxPerSemi||1);
        const newRelSemi = Math.max(0, Math.min(swipeAllowRangeSemi, swipeStartRelSemi + deltaSemi));
        verticalOffset = (swipeAllowRangeSemi>0)? Math.max(0, Math.min(100, Math.round((newRelSemi / swipeAllowRangeSemi)*100))) : 0;
        try{ if(typeof syncVerticalOffsetSliders==='function') syncVerticalOffsetSliders(); }catch(_){ }
        drawChart();
    });
    chartCanvas.addEventListener('pointerup',()=>{ swipeYActive=false; swipePointerId=null; });
    chartCanvas.addEventListener('pointercancel',()=>{ swipeYActive=false; swipePointerId=null; });
    chartCanvas.addEventListener('mousedown',(e)=>{
        if(isAdjustingVOffset) return; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ謇假ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const rect=chartCanvas.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top;
        if(_rangePending){
            // 2鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋贋ｼ夲ｽｽ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｨ・ｳ驕擾ｽｩ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｲ蛛・ｽｽ・ｬ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        }
    const idx=hitTestNote(x,y); if(idx!=null){ setSingleSelection(idx,{audition:true}); }
    });
    chartCanvas.addEventListener('mousemove',(e)=>{
        if(!draggingRange) return; const rect=chartCanvas.getBoundingClientRect(); const x=e.clientX-rect.left; const eff=playbackPosition+timelineOffsetSec; const playX=(chartCanvas&&chartCanvas.width)? getPlayX(chartCanvas.width):70; setRangeSelection(viewToTime(dragStartX,eff,playX), viewToTime(x,eff,playX));
    });
    chartCanvas.addEventListener('mouseup',()=>{ draggingRange=false; });
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    chartCanvas.addEventListener('touchstart',(e)=>{
        if(isAdjustingVOffset) return; // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ謇假ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const t=e.touches[0]; if(!t) return;
        const total = verticalZoom*12; const min=36, max=132; const allowRange=Math.max(0,(max-min-total));
        swipeAllowRangeSemi=allowRange; swipeH=chartCanvas.height||1; swipePxPerSemi=(swipeH>0 && total>0)? (swipeH/total):1; swipeStartRelSemi=(verticalOffset/100)*allowRange; swipeStartY=t.clientY;
    },{passive:true});
    chartCanvas.addEventListener('touchmove',(e)=>{
        const t=e.touches[0]; if(!t) return;
        const dy = t.clientY - (swipeStartY||t.clientY);
        const deltaSemi = dy / (swipePxPerSemi||1);
        const newRelSemi = Math.max(0, Math.min(swipeAllowRangeSemi, swipeStartRelSemi + deltaSemi));
        verticalOffset = (swipeAllowRangeSemi>0)? Math.max(0, Math.min(100, Math.round((newRelSemi / swipeAllowRangeSemi)*100))) : 0;
        try{ if(typeof syncVerticalOffsetSliders==='function') syncVerticalOffsetSliders(); }catch(_){ }
        drawChart();
        e.preventDefault();
    },{passive:false});
    chartCanvas.addEventListener('touchend',()=>{ draggingRange=false; swipeStartY=0; });
}
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ驍丞・・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function applyOctaveShift(delta){
    const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes||!tr.notes.length) return;
    const notes=tr.notes; const clamp=(m)=> Math.max(36,Math.min(127,m));
    const sel=window._selection;
    if(sel.type==='single' && sel.index!=null){
        const idx=sel.index;
        const applyForward = !!(applyForwardToggle && applyForwardToggle.checked);
        const endIdx = applyForward? findPhraseEndIndex(idx): idx;
        for(let i=idx;i<=endIdx;i++){ notes[i].midi = clamp(notes[i].midi + delta); }
        setSingleSelection(idx);
    } else if(sel.type==='range' && sel.startSec!=null && sel.endSec!=null){
        for(let i=0;i<notes.length;i++){
            const st=notes[i].time, en=st+notes[i].duration;
            if(!(en<sel.startSec || st>sel.endSec)){
                notes[i].midi = clamp(notes[i].midi + delta);
            }
        }
    }
    autoCenterMelodyTrack();
    drawChart();
}
function applySemitoneShift(delta){
    autoCenterFrozen = true; // 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ隶難ｽ｣郢晢ｽｻ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes||!tr.notes.length) return;
    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ・ｩ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢ｧ莨夲ｽｽ・ｫ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・､陷ｻ・ｵ隰泌・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ陷證ｦ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ郢晢ｽｻ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        if(editToolbar && !editToolbar.classList.contains('hidden')){
            const selNow = window._selection || {type:'none'};
            if(selNow.type !== 'range'){ setSelectionByPlayhead(); }
        }
    }catch(_){ }
    const notes=tr.notes; const clamp=(m)=> Math.max(36,Math.min(127,m)); const sel=window._selection;
    if(sel.type==='single' && sel.index!=null){
        const idx=sel.index; const applyForward = !!(applyForwardToggle && applyForwardToggle.checked);
        const endIdx = applyForward? findPhraseEndIndex(idx): idx;
        for(let i=idx;i<=endIdx;i++){ notes[i].midi = clamp(notes[i].midi + delta); }
        if(!applyForward){ try{ ensureAudio(); const m=clamp(notes[endIdx].midi); const d=Math.min(notes[endIdx].duration||0.4,0.6); simplePlaySfz(m,(audioCtx?audioCtx.currentTime:0)+0.02,d,masterGain||audioCtx?.destination); }catch(_){ } }
        setSingleSelection(idx,{audition:false});
    } else if(sel.type==='range' && sel.startSec!=null && sel.endSec!=null){
        for(let i=0;i<notes.length;i++){ const st=notes[i].time,en=st+notes[i].duration; if(!(en<sel.startSec || st>sel.endSec)){ notes[i].midi = clamp(notes[i].midi + delta); } }
    }
    autoCenterMelodyTrack();
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    scheduleAll(); if(isPlaying){ pausePlayback(); startPlayback(); } else { drawChart(); }
}
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ螳育櫨隲｢蟷・椏?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽhift鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・ｫ・つ?髯橸ｽｳ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
window.addEventListener('keydown',(e)=>{ if(e.key==='ArrowUp' || e.key==='ArrowDown'){ const delta=(e.key==='ArrowUp')? +12 : -12; if(window._selection.type==='single' && window._selection.index!=null && e.shiftKey){ const prev=applyForwardToggle? applyForwardToggle.checked: false; if(applyForwardToggle) applyForwardToggle.checked=true; applyOctaveShift(delta); if(applyForwardToggle) applyForwardToggle.checked=prev; } else { applyOctaveShift(delta); } e.preventDefault(); } });
window.addEventListener('keydown',(e)=>{ if(e.key==='ArrowUp' || e.key==='ArrowDown'){ const delta=(e.key==='ArrowUp')? +12 : -12; if(window._selection.type==='single' && window._selection.index!=null && e.shiftKey){ const prev=applyForwardToggle? applyForwardToggle.checked: false; if(applyForwardToggle) applyForwardToggle.checked=true; applyOctaveShift(delta); if(applyForwardToggle) applyForwardToggle.checked=prev; } else { applyOctaveShift(delta); } e.preventDefault(); } else if(e.key==='[' || e.key===']'){ const d=(e.key===']')? +1 : -1; applySemitoneShift(d); e.preventDefault(); } });
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽON/OFF: O 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
window.addEventListener('keydown',(e)=>{ if(e.key==='o' || e.key==='O'){ scorePitchClassOverlay = !scorePitchClassOverlay; drawChart(); } });
// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・つ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
if(clearSelectionBtn){ clearSelectionBtn.onclick=()=> clearSelection(); }
if(octDownBtn){ octDownBtn.onclick=()=> applyOctaveShift(-12); }
if(octUpBtn){ octUpBtn.onclick=()=> applyOctaveShift(+12); }

// 鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ驕ｯ・ｶ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ菫ｶ・｢・ｧ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const globalOctUpBtn = document.getElementById('globalOctUpBtn');
const globalOctDownBtn = document.getElementById('globalOctDownBtn');
function shiftAllMelodyNotes(delta){
    try{
        const tr = currentTracks[melodyTrackIndex];
        if(!tr || !Array.isArray(tr.notes) || !tr.notes.length) return;
        const clamp = (m)=> Math.max(36, Math.min(127, m));
        for(let i=0;i<tr.notes.length;i++){
            tr.notes[i].midi = clamp((tr.notes[i].midi|0) + delta);
        }
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ貊ゑｽｽ・ｪ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ・つ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髫ｶ謚ｵ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ隶捺慣・ｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟶壽升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        autoCenterFrozen = true;
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｱ髯晢ｽｶ隰ｨ魑ｴﾂ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        scheduleAll(); if(isPlaying){ pausePlayback(); startPlayback(); } else { drawChart(); }
    }catch(_){ }
}
function updateGlobalOctButtonsTooltip(){
    try{
        const up = document.getElementById('globalOctUpBtn');
        const dn = document.getElementById('globalOctDownBtn');
        if(!up || !dn) return;
        if(practiceMode==='basic'){
            up.title = '鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲ｷ諷墓ｫｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・・?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?+12鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
            dn.title = '鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲ｷ諷墓ｫｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・・?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?-12鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
        } else {
            up.title = '鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?+12鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
            dn.title = '鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?-12鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
        }
    }catch(_){ }
}
if(globalOctUpBtn){
    globalOctUpBtn.onclick = ()=>{
        if(practiceMode==='basic'){
            practiceCallDisplayOctShift = (practiceCallDisplayOctShift|0) + 12;
            // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蝓ｼ・｡遒托ｽｷ譎｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟶壽升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            try{
                if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                    let gMin=Infinity, gMax=-Infinity;
                    for(const n of midiGhostNotes){ const mm=(n.role==='call')? (n.midi + (practiceCallDisplayOctShift|0)) : n.midi; if(mm<gMin) gMin=mm; if(mm>gMax) gMax=mm; }
                    if(isFinite(gMin) && isFinite(gMax)) setVerticalOffsetToRange(gMin, gMax);
                }
            }catch(_){ }
            drawChart();
        } else {
            shiftAllMelodyNotes(+12);
        }
        updateGlobalOctButtonsTooltip();
    };
}
if(globalOctDownBtn){
    globalOctDownBtn.onclick = ()=>{
        if(practiceMode==='basic'){
            practiceCallDisplayOctShift = (practiceCallDisplayOctShift|0) - 12;
            try{
                if(Array.isArray(midiGhostNotes) && midiGhostNotes.length){
                    let gMin=Infinity, gMax=-Infinity;
                    for(const n of midiGhostNotes){ const mm=(n.role==='call')? (n.midi + (practiceCallDisplayOctShift|0)) : n.midi; if(mm<gMin) gMin=mm; if(mm>gMax) gMax=mm; }
                    if(isFinite(gMin) && isFinite(gMax)) setVerticalOffsetToRange(gMin, gMax);
                }
            }catch(_){ }
            drawChart();
        } else {
            shiftAllMelodyNotes(-12);
        }
        updateGlobalOctButtonsTooltip();
    };
}
// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const semiDownBtn=document.getElementById('semiDownBtn');
const semiUpBtn=document.getElementById('semiUpBtn');
if(semiDownBtn){ semiDownBtn.onclick=()=> applySemitoneShift(-1); }
if(semiUpBtn){ semiUpBtn.onclick=()=> applySemitoneShift(+1); }
// 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ show/hide 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
if(editModeToggle){
    editModeToggle.onclick=()=>{
        if(!editToolbar) return;
        if(editToolbar.classList.contains('hidden')){
            editToolbar.classList.remove('hidden');
            editToolbar.style.display='flex';
            // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・､?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髫ｲ・､?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ蠍ｺ・ｺ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            setSelectionByPlayhead();
        } else {
            editToolbar.classList.add('hidden');
            editToolbar.style.display='none';
        }
    };
}

// Undo/Redo 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?
const undoStack=[]; const redoStack=[]; const MAX_HISTORY=100;
function snapshotNotes(){ try{ const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes) return null; return tr.notes.map(n=>({midi:n.midi,time:n.time,duration:n.duration})); }catch(_){ return null; } }
function pushHistory(){ const snap=snapshotNotes(); if(!snap) return; undoStack.push(snap); if(undoStack.length>MAX_HISTORY) undoStack.shift(); redoStack.length=0; }
function restoreFromSnap(snap){ try{ const tr=currentTracks[melodyTrackIndex]; if(!tr) return; tr.notes = snap.map(n=>({midi:n.midi,time:n.time,duration:n.duration})); autoCenterMelodyTrack(); drawChart(); }catch(_){ }}
function doUndo(){ if(!undoStack.length) return; const current=snapshotNotes(); const prev=undoStack.pop(); if(current) redoStack.push(current); restoreFromSnap(prev); }
function doRedo(){ if(!redoStack.length) return; const current=snapshotNotes(); const next=redoStack.pop(); if(current) undoStack.push(current); restoreFromSnap(next); }
if(undoBtn){ undoBtn.onclick=()=> doUndo(); }
if(redoBtn){ redoBtn.onclick=()=> doRedo(); }
// 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?2鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function splitCurrentNoteAtPlayhead(){
    try{
        const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes||!tr.notes.length) return;
        const t=playbackPosition; const notes=tr.notes;
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        let idx=-1; for(let i=0;i<notes.length;i++){ const n=notes[i]; if(t>n.time && t<n.time+n.duration){ idx=i; break; } }
        if(idx<0) return; const n=notes[idx];
        const rel = t - n.time; const remain = n.duration - rel; const MIN_DUR=0.05; // 50ms 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ郢晢ｽｻ邵ｺ・､・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・､・ｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(rel<MIN_DUR || remain<MIN_DUR) return; // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        pushHistory();
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ遶包ｽｧ鬮ｫ・ｶ隴幢ｽｱ?繝ｻ・ｽ繝ｻ・ｽ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        n.duration = rel;
        const newNote = { midi:n.midi, time:t, duration:remain };
        notes.splice(idx+1,0,newNote);
        // 鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ time 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?髯晢ｽｶ隴擾ｽｴ?繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬯滂ｽｴ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ time=t 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽOK鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        setSingleSelection(idx+1,{audition:false});
        scheduleAll(); drawChart();
    }catch(_){ }
}
const splitBtn=document.getElementById('splitNoteBtn'); if(splitBtn){ splitBtn.onclick=()=>{ splitCurrentNoteAtPlayhead(); }; }
// Ctrl+Z / Ctrl+Y
window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ doUndo(); e.preventDefault(); } else if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='y'){ doRedo(); e.preventDefault(); } });

// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｯ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ髯橸ｽｳ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const _applyOctaveShiftOrig = applyOctaveShift;
applyOctaveShift = function(delta){ pushHistory(); _applyOctaveShiftOrig(delta); };
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｯ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const _applySemitoneShiftOrig = applySemitoneShift;
applySemitoneShift = function(delta){ pushHistory(); _applySemitoneShiftOrig(delta); };
function snapshotNotes(){ try{ const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes) return null; const notesSnap=tr.notes.map(n=>({midi:n.midi,time:n.time,duration:n.duration})); const marks={}; Object.keys(markers||{}).forEach(k=>{ const v=markers[k]; if(typeof v==='number') marks[k]=v; }); return {notes:notesSnap, markers:marks}; }catch(_){ return null; } }
function restoreFromSnap(snap){ try{ const tr=currentTracks[melodyTrackIndex]; if(!tr) return; if(Array.isArray(snap)){ tr.notes = snap.map(n=>({midi:n.midi,time:n.time,duration:n.duration})); } else if(snap && Array.isArray(snap.notes)){ tr.notes = snap.notes.map(n=>({midi:n.midi,time:n.time,duration:n.duration})); if(snap.markers){ Object.keys(snap.markers).forEach(k=>{ const v=snap.markers[k]; if(typeof v==='number') markers[k]=v; }); } } autoCenterMelodyTrack(); drawChart(); }catch(_){ }}

// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽocalStorage鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function getSongKey(){ try{ const n=(melodyAudioLabel&&melodyAudioLabel.textContent)||'unknown'; const d=Math.round((melodyBuffer&&melodyBuffer.duration)||0); return 'corr:'+n+':'+d; }catch(_){ return 'corr:unknown'; } }
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ

// MIDI鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
if(midiRefBtn && midiRefInput){ midiRefBtn.onclick=()=> midiRefInput.click(); }
let _midiTracksCache=null; // [{notes:[{midi,st,en}], index}]
let _midiAlign={ detIdx:0, refIdx:0, scale:1.0 };
if(midiRefInput){ midiRefInput.onchange=async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
        const arr=await f.arrayBuffer();
        const parsed = parseMidiAllTracks(new Uint8Array(arr)); // [{notes:[{midi,st,en}], index}]
    if(!parsed || !parsed.length){ console.warn('MIDI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髫ｲ・｢?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?'); return; }
        _midiTracksCache = parsed;
        if(parsed.length===1){
            // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ・つ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ陞ｳ・｣邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ闌ｨ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴取得・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const refNotesSec = normalizeMidiToSeconds(parsed[0].notes);
            let mapped = applyAlignMapping(refNotesSec);
            mapped = Array.isArray(mapped)? mapped.slice().sort((a,b)=>a.time-b.time): [];
            midiGhostNotes = mapped;
            drawChart();
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ郢晢ｽｻ髫ｲ・｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓幢ｾつ闔会ｽｰ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｱ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ閧ｴ蠕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            if(midiTrackSelect){ midiTrackSelect.style.display='none'; }
            if(midiApplyBtn){ midiApplyBtn.style.display='inline-block'; }
            if(midiGenerateBtn){ midiGenerateBtn.style.display='inline-block'; }
            buildAlignDropdowns(refNotesSec);
            if(midiAlignPanel) midiAlignPanel.style.display='flex';
        } else {
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・｢郢ｧ・ｪ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            if(midiTrackSelect){
                midiTrackSelect.innerHTML='';
                parsed.forEach((tr, i)=>{
                    const opt=document.createElement('option');
                    opt.value=String(i);
                    opt.textContent=`MIDI Track ${i+1} (${tr.notes.length} notes)`;
                    midiTrackSelect.appendChild(opt);
                });
                midiTrackSelect.selectedIndex=0;
                midiTrackSelect.style.display='inline-block';
                // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                midiTrackSelect.onchange=()=>{
                    try{
                        const idx = midiTrackSelect.selectedIndex||0;
                        const refNotesSec = normalizeMidiToSeconds(_midiTracksCache[idx].notes);
                        let mapped = applyAlignMapping(refNotesSec);
                        mapped = Array.isArray(mapped)? mapped.slice().sort((a,b)=>a.time-b.time): [];
                        midiGhostNotes = mapped;
                        drawChart();
                    }catch(_){ }
                };
            }
            if(midiApplyBtn){ midiApplyBtn.style.display='inline-block'; }
            if(midiGenerateBtn){ midiGenerateBtn.style.display='inline-block'; }
            const refNotesSec = normalizeMidiToSeconds(parsed[0].notes);
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ闌ｨ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            let mapped0 = applyAlignMapping(refNotesSec);
            mapped0 = Array.isArray(mapped0)? mapped0.slice().sort((a,b)=>a.time-b.time): [];
            midiGhostNotes = mapped0;
            drawChart();
            buildAlignDropdowns(refNotesSec);
            if(midiAlignPanel) midiAlignPanel.style.display='flex';
        }
    }catch(err){ console.warn('MIDI鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ', err); }
}; }
if(midiApplyBtn){ midiApplyBtn.onclick=()=>{
    if(!_midiTracksCache || !_midiTracksCache.length) return;
    const idx = Math.max(0, Math.min(_midiTracksCache.length-1, (midiTrackSelect && midiTrackSelect.selectedIndex) || 0));
    const refNotesRaw = normalizeMidiNotesForAlign(_midiTracksCache[idx].notes);
    const refNotes = applyAlignMapping(refNotesRaw);
    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蟇よ・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ闌ｨ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ
    midiGhostNotes = null;
    pushHistory(); alignOctaveToReferenceDP(refNotes);
    drawChart();
}; }
// MIDI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
if(midiGenerateBtn){ midiGenerateBtn.onclick=()=>{
    if(!_midiTracksCache || !_midiTracksCache.length){ console.warn('鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽIDI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?'); return; }
    const idx = Math.max(0, Math.min(_midiTracksCache.length-1, (midiTrackSelect && midiTrackSelect.selectedIndex) || 0));
    const ref = _midiTracksCache[idx];
    // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?
    const notesRaw = normalizeMidiToSeconds(ref.notes);
    const notes = applyAlignMapping(notesRaw);
    if(!Array.isArray(notes) || !notes.length){ console.warn('MIDI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｫ・ｴ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隰ｨ魑ｴﾂ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?'); return; }
    // 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷会ｽｱ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    pushHistory();
    currentTracks[melodyTrackIndex] = { notes: notes.map(n=>({ midi:n.midi, time:n.time, duration:n.duration })) };
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷会ｽｱ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｫ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隰疲ｻゑｽｽ・ｳ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    autoCenterFrozen = false;
    autoCenterMelodyTrack();
    // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蟇よ・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ闌ｨ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ
    midiGhostNotes = null;
    drawChart();
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｽ・｡郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
}; }

function normalizeMidiNotesForAlign(trackNotes){
    // [{midi, st, en}] -> [{midi, time, duration}] 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽtick鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
    if(!Array.isArray(trackNotes) || !trackNotes.length) return [];
    const minT = Math.min(...trackNotes.map(n=>n.st));
    return trackNotes.map(n=>({ midi:n.midi, time:(n.st-minT), duration:(n.en-n.st) }));
}

// 鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: UI鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謳ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ蟷｢・ｽ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴取得・ｿ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function buildAlignDropdowns(refNotes){
    try{
        if(!midiAlignDetStart || !midiAlignRefStart) return;
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣逧ｮ逕･繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const det = (currentTracks[melodyTrackIndex]?.notes)||[];
        const detOpts = det.map((n,i)=>({ i, label:`#${i+1} ${noteLabel(n.midi)} @${n.time.toFixed(2)}s` }));
        midiAlignDetStart.innerHTML='';
        detOpts.slice(0,200).forEach(o=>{ const opt=document.createElement('option'); opt.value=String(o.i); opt.textContent=o.label; midiAlignDetStart.appendChild(opt); });
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽIDI鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const refOpts = refNotes.map((n,i)=>({ i, label:`#${i+1} ${noteLabel(n.midi)} t${n.time}` }));
        midiAlignRefStart.innerHTML='';
        refOpts.slice(0,200).forEach(o=>{ const opt=document.createElement('option'); opt.value=String(o.i); opt.textContent=o.label; midiAlignRefStart.appendChild(opt); });
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        midiAlignDetStart.value='0'; midiAlignRefStart.value='0';
        _midiAlign={ detIdx:0, refIdx:0, scale:1.0 };
        if(midiAlignScale) midiAlignScale.value='1.0';
        updateAlignInfo();
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const onAlignChanged = ()=>{
            updateAlignInfo();
            // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ隰撰ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣螂・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ菫ｶ・｢・ｧ・つ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            try{
                const idx = (midiTrackSelect && midiTrackSelect.style.display!=='none')? (midiTrackSelect.selectedIndex||0) : 0;
                const src = (_midiTracksCache && _midiTracksCache.length)? _midiTracksCache[Math.max(0,Math.min(idx,_midiTracksCache.length-1))]: null;
                const base = src? normalizeMidiToSeconds(src.notes): refNotes;
                let mapped = applyAlignMapping(base);
                mapped = Array.isArray(mapped)? mapped.slice().sort((a,b)=>a.time-b.time): [];
                midiGhostNotes = mapped;
                drawChart();
            }catch(_){ }
        };
        midiAlignDetStart.onchange=()=>{ _midiAlign.detIdx=parseInt(midiAlignDetStart.value)||0; onAlignChanged(); };
        midiAlignRefStart.onchange=()=>{ _midiAlign.refIdx=parseInt(midiAlignRefStart.value)||0; onAlignChanged(); };
        if(midiAlignScale){ midiAlignScale.oninput=()=>{ _midiAlign.scale=parseFloat(midiAlignScale.value)||1.0; onAlignChanged(); }; }
        if(midiAlignFitEnds){
            midiAlignFitEnds.onclick=()=>{
                try{
                    // 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髣比ｼ夲ｽｽ・｣?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ髯ｦ・ｷ繝ｻ・ｽ?繝ｻ・ｽ?隲ｱ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽMIDI鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ隨翫ｋ・ｬ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const idx = (midiTrackSelect && midiTrackSelect.style.display!=='none')? (midiTrackSelect.selectedIndex||0) : 0;
                    const src = (_midiTracksCache && _midiTracksCache.length)? _midiTracksCache[Math.max(0,Math.min(idx,_midiTracksCache.length-1))]: null;
                    if(!src) return;
                    const ref = normalizeMidiToSeconds(src.notes);
                    if(!ref.length) return;
                    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const det = (currentTracks[melodyTrackIndex]?.notes)||[];
                    if(!det.length) return;
                    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    const detT0 = det[0].time;
                    const detT1 = det[det.length-1].time + det[det.length-1].duration;
                    const refT0 = ref[0].time;
                    const refT1 = ref[ref.length-1].time + ref[ref.length-1].duration;
                    const detSpan = Math.max(1e-6, detT1 - detT0);
                    const refSpan = Math.max(1e-6, refT1 - refT0);
                    // 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣騾ｧ・ｮ騾包ｽ･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ applyAlignMapping 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ detIdx/refIdx 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ蜈ｷ・ｽ・ｻ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髫ｶ謚ｵ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ0鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ鬮ｦ・ｪ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ縺､ﾂ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜴・ｽｽ・ｵ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ荵晢ｽ・繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    _midiAlign.detIdx = 0;
                    _midiAlign.refIdx = 0;
                    const scale = detSpan / refSpan;
                    _midiAlign.scale = scale;
                    if(midiAlignScale){ midiAlignScale.value = String(scale.toFixed(3)); }
                    onAlignChanged();
                }catch(_){ }
            };
        }
    }catch(e){ console.warn('buildAlignDropdowns failed', e); }
}
function updateAlignInfo(){
    try{
    if(!midiAlignInfo) return;
    midiAlignInfo.textContent = `det#${_midiAlign.detIdx+1} 鬯ｩ蛹・ｽｽ・ｶ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽref#${_midiAlign.refIdx+1}, scale ${_midiAlign.scale.toFixed(3)}`;
    }catch(_){ }
}
// 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: refNotes/time鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ蜉ｱ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽef鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｮ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｻ郢晄坩・ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ髮√＠・つ鬩包ｽｶ闕ｵ邇ｲ・･髮｣・ｾ縺､ﾂ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ閧ｴ蠕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽscale鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
function applyAlignMapping(refNotes){
    try{
        if(!Array.isArray(refNotes)||!refNotes.length) return refNotes;
        const det = (currentTracks[melodyTrackIndex]?.notes)||[];
        const di = Math.max(0, Math.min(det.length-1, _midiAlign.detIdx|0));
        const ri = Math.max(0, Math.min(refNotes.length-1, _midiAlign.refIdx|0));
        const scale = (typeof _midiAlign.scale==='number' && isFinite(_midiAlign.scale) && _midiAlign.scale>0)? _midiAlign.scale: 1.0;
        const detT0 = det[di]? det[di].time: 0;
        const refT0 = refNotes[ri]? refNotes[ri].time: 0;
        return refNotes.map(n=>({
            midi: n.midi,
            time: detT0 + (n.time - refT0) * scale,
            duration: (n.duration||0) * scale
        }));
    }catch(_){ return refNotes; }
}

// MIDI tick 鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｷ楪?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ・ｴ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ00ms/鬯ｮ・ｯ隲帶潔ﾂ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ郢晢ｽｻ髣憺屮・ｽ・ｭ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ or 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function normalizeMidiToSeconds(trackNotes){
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?髫ｶ魃会ｽｽ・｢繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ隴幢ｽｱ髮趣ｽｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ魃会ｽｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・つ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟶壽升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(!Array.isArray(trackNotes) || !trackNotes.length) return [];
    const stMin = Math.min(...trackNotes.map(n=>n.st));
    const stMax = Math.max(...trackNotes.map(n=>n.en));
    const tickSpan = Math.max(1, stMax - stMin);
    const audioSpan = (melodyBuffer?.duration) || (accompBuffer?.duration) || 60; // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ60鬯ｯ・ｩ陷肴ｷ楪?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const scale = audioSpan / tickSpan;
    return trackNotes.map(n=>({ midi:n.midi, time:(n.st-stMin)*scale, duration:(n.en-n.st)*scale }));
}

// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽMIDI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｵ證ｦ・ｿ・ｽ?繝ｻ・ｽ髯ｷ迚呻ｽｸ譎｢・ｽ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ髯ｳﾂ髫ｰ螟ｲ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function alignOctaveToReferenceDP(ref){
    try{
        const tr=currentTracks[melodyTrackIndex]; if(!tr||!tr.notes||!tr.notes.length) return;
        const notes=tr.notes;
        const N=Math.min(ref.length, notes.length); if(N<=0) return;
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髮手ｶ｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ m+12k, k in {-2,-1,0,1,2}
        const K=[-2,-1,0,1,2];
        const C=new Array(N); // costs
        const P=new Array(N); // backpointers
        const LAMBDA_JUMP=3.0;   // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蜴・ｽｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷会ｽｱ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const LAMBDA_DIFF=0.8;   // ref鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ??
        const LAMBDA_OCT=0.6;    // ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷会ｽｱ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        for(let i=0;i<N;i++){
            C[i]=new Array(K.length).fill(Infinity);
            P[i]=new Array(K.length).fill(-1);
            const refM=ref[i].midi;
            for(let a=0;a<K.length;a++){
                const m0 = notes[i].midi + K[a]*12;
                const d = Math.abs(m0 - refM);
                const octAbs = Math.abs(K[a]);
                const obs = LAMBDA_DIFF * d + LAMBDA_OCT * octAbs; // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                if(i===0){ C[i][a]=obs; continue; }
                // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                let best=Infinity, bestA=-1;
                for(let b=0;b<K.length;b++){
                    const trans = LAMBDA_JUMP * Math.abs(K[a]-K[b]);
                    const val = C[i-1][b] + obs + trans;
                    if(val<best){ best=val; bestA=b; }
                }
                C[i][a]=best; P[i][a]=bestA;
            }
        }
        // 鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｮ雜｣・ｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ郢晢ｽｻ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        let lastA=0, lastCost=Infinity;
        for(let a=0;a<K.length;a++){ if(C[N-1][a]<lastCost){ lastCost=C[N-1][a]; lastA=a; } }
        for(let i=N-1;i>=0;i--){
            const k=K[lastA];
            notes[i].midi = notes[i].midi + k*12;
            lastA = (i>0? P[i][lastA]: -1);
            if(lastA<0 && i>0){ // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                let best=0, cost=Infinity; for(let a=0;a<K.length;a++){ if(C[i-1][a]<cost){ cost=C[i-1][a]; best=a; } } lastA=best;
            }
        }
    }catch(_){ /* ignore */ }
}

// 鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽIDI鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｬ・ｯ莨夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻ・ｽ｡蛟･ﾂｰ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽype0/1鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽNoteOn/Off鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ魃会ｽｽ・｢髫ｲ・､郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
function parseMidiAllTracks(u8){
    try{
        const dv=new DataView(u8.buffer,u8.byteOffset,u8.byteLength);
        let p=0; function readStr(len){ let s=''; for(let i=0;i<len;i++) s+=String.fromCharCode(dv.getUint8(p++)); return s; }
        function readU32(){ const v=dv.getUint32(p); p+=4; return v; }
        function readU16(){ const v=dv.getUint16(p); p+=2; return v; }
        if(readStr(4)!=='MThd') return [];
        const hdrLen=readU32(); const format=readU16(); const ntr=readU16(); const division=readU16(); p = 8+6; // skip to after header
        const tracks=[];
        for(let t=0;t<ntr;t++){
            const id=readStr(4); const len=readU32(); if(id!=='MTrk'){ p+=len; continue; }
            const end=p+len; let curTime=0; let runningStatus=0; const events=[];
            function readVar(){ let v=0; while(true){ const b=dv.getUint8(p++); v=(v<<7)|(b&0x7F); if(!(b&0x80)) break; } return v; }
            while(p<end){ const dt=readVar(); curTime+=dt; let st=dv.getUint8(p++); if(st<0x80){ p--; st=runningStatus; } else { runningStatus=st; }
                if((st&0xF0)===0x90 || (st&0xF0)===0x80){ const note=dv.getUint8(p++); const vel=dv.getUint8(p++); events.push({t:curTime, type:(st&0xF0), note, vel}); }
                else if(st===0xFF){ const meta=dv.getUint8(p++); const len=readVar(); p+=len; }
                else { const hi=st&0xF0; const cons = (hi===0xC0||hi===0xD0)? 1: 2; p+=cons; }
            }
            const onMap=new Map(); const notes=[];
            events.forEach(ev=>{
                if(ev.type===0x90 && ev.vel>0){ onMap.set(ev.note, ev.t); }
                else if((ev.type===0x80) || (ev.type===0x90 && ev.vel===0)){ const st=onMap.get(ev.note); if(st!=null){ notes.push({midi:ev.note, st, en:ev.t}); onMap.delete(ev.note); } }
            });
            tracks.push({ index:t, notes });
        }
        return tracks.filter(tr=> tr.notes && tr.notes.length>0).sort((a,b)=> b.notes.length - a.notes.length);
    }catch(_){ return []; }
}

// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽAPI: 鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽIDI鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽype0/1, 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ荳ｻ・｢阮呻ｼ昴・・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?繝ｻ・ｽ繝ｻ・ｽ隴会ｽｮ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ髯溯ｶ｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ隴幢ｽｱ髮趣ｽｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function parseMidiMelody(u8){
    // 鬯ｮ・｣隲幄ご陲夜匚謇假ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮倶ｼ∝ｱｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｹ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陞ｻ謦ｰ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽMIDI鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ諛・ｽｬ雜｣・ｽ・ｸ?繝ｻ・ｽ繝ｻ・ｽ髯滂ｽ｢隲橸ｽｺ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｸ蜿ｯﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽoteOn/Off鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隶主･・ｽｽ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ髮｣・ｿ・ｽ?繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const dv=new DataView(u8.buffer,u8.byteOffset,u8.byteLength);
        let p=0; function readStr(len){ let s=''; for(let i=0;i<len;i++) s+=String.fromCharCode(dv.getUint8(p++)); return s; }
        function readU32(){ const v=dv.getUint32(p); p+=4; return v; }
        function readU16(){ const v=dv.getUint16(p); p+=2; return v; }
        if(readStr(4)!=='MThd') return [];
        const hdrLen=readU32(); const format=readU16(); const ntr=readU16(); const division=readU16(); p = 8+6; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const tracks=[];
        for(let t=0;t<ntr;t++){
            const id=readStr(4); const len=readU32(); if(id!=='MTrk'){ p+=len; continue; }
            const end=p+len; let curTime=0; let runningStatus=0; const events=[];
            function readVar(){ let v=0; while(true){ const b=dv.getUint8(p++); v=(v<<7)|(b&0x7F); if(!(b&0x80)) break; } return v; }
            while(p<end){ const dt=readVar(); curTime+=dt; let st=dv.getUint8(p++); if(st<0x80){ p--; st=runningStatus; } else { runningStatus=st; }
                if((st&0xF0)===0x90 || (st&0xF0)===0x80){ const note=dv.getUint8(p++); const vel=dv.getUint8(p++); events.push({t:curTime, type:(st&0xF0), note, vel}); }
                else if(st===0xFF){ const meta=dv.getUint8(p++); const len=readVar(); p+=len; }
                else { // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎暮ｯ会ｽｽ・ｳ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊ゑｽｿ・ｽ?繝ｻ・ｽ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    const hi=st&0xF0; const cons = (hi===0xC0||hi===0xD0)? 1: 2; p+=cons; }
            }
            // NoteOn/Off 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ
            const onMap=new Map(); const notes=[];
            events.forEach(ev=>{
                if(ev.type===0x90 && ev.vel>0){ onMap.set(ev.note, ev.t); }
                else if((ev.type===0x80) || (ev.type===0x90 && ev.vel===0)){ const st=onMap.get(ev.note); if(st!=null){ notes.push({midi:ev.note, st, en:ev.t}); onMap.delete(ev.note); } }
            });
            tracks.push({notes});
        }
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ蜿厄ｽｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        tracks.sort((a,b)=> (b.notes.length)-(a.notes.length));
        const picked=(tracks[0]?.notes)||[]; if(!picked.length) return [];
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｫ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽivision鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 480ticks/鬯ｮ・ｯ隲帶潔ﾂ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蛹・ｽｽ・ｶ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ120bpm鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ隲帑ｼ夲ｽｽ・ｺ髯具ｽｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ鬮ｦ・ｪ?繝ｻ・ｽ?髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｮ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隰・ｹ晢ｼ・ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ閧ｴ蠕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽMIDI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ陷托ｽｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const minT=Math.min(...picked.map(n=>n.st));
        const res=picked.map(n=>({ midi:n.midi, time:(n.st-minT), duration:(n.en-n.st) }));
        return res;
    }catch(_){ return []; }
}

// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽMIDI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ隱ｿ鬮ｴ諛・ｽｱ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜴・ｽｽ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ12鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function alignOctaveToReference(ref){ return alignOctaveToReferenceDP(ref); }
function noteLabel(midi){
    const namesCDE=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const namesDo=['鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ,'鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ','鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ','鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ#','鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ,'鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ,'鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ','鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ','鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ#','鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ','鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ#','鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ'];
    const names = labelNotation==='鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ? namesDo : namesCDE; const o=Math.floor(midi/12)-1; return names[midi%12]+o; }
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｷ楪?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螟ｲ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽtime/duration 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function buildTimesFromTicks(){ /* no-op: MIDI鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ */ }

// ---- 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ ----
function noteName(pc){
    const namesCDE=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const namesDo=['鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ,'鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ','鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ','鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ#','鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ,'鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ,'鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ','鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ','鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ#','鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ','鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ#','鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ'];
    const arr = labelNotation==='鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ? namesDo : namesCDE;
    return arr[((pc%12)+12)%12];
}
function buildAdviceText(){
    if(!scoreStats || scoreStats.total<5) return '鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陝・ｑ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・｢鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
    const hi=[], lo=[], stable=[], unstable=[];
    for(let pc=0; pc<12; pc++){
        const b=scoreStats.bins[pc]; if(!b||b.count<3) continue;
        const avg=b.sum/b.count; const avgAbs=b.sumAbs/b.count; const tolRate=(b.inTol/Math.max(1,b.count));
        if(avg>=5 && b.sharp > b.flat) hi.push({pc, avg});
        if(avg<=-5 && b.flat > b.sharp) lo.push({pc, avg});
        if(avgAbs<=6 && tolRate>=0.75) stable.push({pc, tolRate});
        if(avgAbs>=12 && tolRate<0.6) unstable.push({pc, avgAbs});
    }
    hi.sort((a,b)=> Math.abs(b.avg)-Math.abs(a.avg));
    lo.sort((a,b)=> Math.abs(b.avg)-Math.abs(a.avg));
    stable.sort((a,b)=> b.tolRate-a.tolRate);
    unstable.sort((a,b)=> b.avgAbs-a.avgAbs);
    const fmtList=(arr, prop, suffix='')=> arr.slice(0,6).map(o=> `${noteName(o.pc)}${suffix}`).join(' ');
    const totalIn = scoreStats.bins.reduce((s,b)=> s + (b?.inTol||0), 0);
    const totalCnt = scoreStats.bins.reduce((s,b)=> s + (b?.count||0), 0);
    const hitRate = totalCnt? (totalIn/totalCnt*100) : 0;
    const lines=[];
    if(hi.length) lines.push(`鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?: ${fmtList(hi,'avg')}`);
    if(lo.length) lines.push(`鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?: ${fmtList(lo,'avg')}`);
    if(unstable.length) lines.push(`鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ ${fmtList(unstable,'avgAbs')}`);
    if(stable.length) lines.push(`鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ ${fmtList(stable,'tolRate')}`);
    lines.push(`鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ ${hitRate.toFixed(1)}%`);
    if(hi.length||lo.length||unstable.length){
        lines.push('鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｼ陋ｻ譎｢・ｿ・ｽ?繝ｻ・ｽ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ遶擾ｽｽ?繝ｻ・ｽ繝ｻ・ｽ髢ｾ・･?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ髮｣・ｽ・ｻ驕擾ｽｩ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｴ・ｴ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ/ 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ莨懌・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜴・ｽｽ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ鬮ｦ・｡鬯･・ｴ髦ｯ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢髫ｲ・､?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ陷托ｽｰ邵ｺ雋ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ);
    } else {
        lines.push('鬮ｮ雜｣・ｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶抵ｽｭ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隰疲ｻゑｽｽ・ｱ遶擾ｽｬ陷ｿ闃ｽ譯咏ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ陋滉ｻｰﾂ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隰ｨ魑ｴﾂ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ);
    }
    return lines.join('\n');
}
function drawAdviceBars(){ /* 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛沺・｡・ｶ鬮ｫ・ｰ雎慕霜・ｪ・ｿ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ*/ if(_adviceCtx&&adviceCanvas){ try{ _adviceCtx.clearRect(0,0,adviceCanvas.width, adviceCanvas.height); }catch(_){ } } }
function openAdvice(){ if(advicePanel) advicePanel.style.display='block'; if(adviceTextEl) adviceTextEl.textContent = buildAdviceText(); /* 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ闌ｨ・ｽ・ｾ繝ｻ・ｽ?髢ｼ繧雁ｵｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ隴幢ｽｱ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ */ }
function closeAdvice(){ if(advicePanel) advicePanel.style.display='none'; }
if(adviceBtn){ adviceBtn.onclick = ()=> openAdvice(); }
if(adviceCloseBtn){ adviceCloseBtn.onclick = ()=> closeAdvice(); }

// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｸ蜿ｯﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隲・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ髫ｴ莨夲ｽｽ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕伜∞・ｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
(function(){
    try{
        const micHelpBtn = document.getElementById('micHelpBtn');
        const micHelpPanel = document.getElementById('micHelpPanel');
        const micHelpClose = document.getElementById('micHelpClose');
        if(!micHelpPanel) return; // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        function openMicHelp(){ micHelpPanel.style.display='block'; }
        function closeMicHelp(){ micHelpPanel.style.display='none'; }
        if(micHelpBtn){
            micHelpBtn.addEventListener('click', (e)=>{
                e.stopPropagation();
                const isOpen = micHelpPanel.style.display !== 'none' && micHelpPanel.style.display !== '';
                if(isOpen) closeMicHelp(); else openMicHelp();
            });
        }
        if(micHelpClose){
            micHelpClose.addEventListener('click', (e)=>{ e.stopPropagation(); closeMicHelp(); });
        }
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ髦ｮ蜊搾ｽｧ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ雋ｻ・ｽ・ｺ郢ｧ謇假ｽｽ・ｾ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ驕倥・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ鬮｣魃会ｽｿ・ｽ?繝ｻ・ｽ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        document.addEventListener('click', (e)=>{
            try{
                if(!micHelpPanel || micHelpPanel.style.display==='none') return;
                const t = e.target;
                if(t instanceof Node){
                    if(micHelpPanel.contains(t)) return; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    if(micHelpBtn && micHelpBtn.contains && micHelpBtn.contains(t)) return; // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                }
                closeMicHelp();
            }catch(_){ /* ignore */ }
        });
        // Esc 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeMicHelp(); } });
    }catch(e){ console.warn('micHelp wiring failed', e); }
})();

// 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髮狗甥謌溯崕・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿厄ｽｸ蜿ｯﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隲・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ髫ｴ莨夲ｽｽ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕伜∞・ｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?/Esc鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
(function(){
    try{
        const helpBtn = document.getElementById('globalHelpBtn');
        const panel = document.getElementById('globalHelpPanel');
        const closeBtn = document.getElementById('globalHelpClose');
        if(!panel) return;
        function openHelp(){ panel.style.display='block'; }
        function closeHelp(){ panel.style.display='none'; }
        if(helpBtn){
            helpBtn.addEventListener('click', (e)=>{
                e.stopPropagation();
                const isOpen = panel.style.display !== 'none' && panel.style.display !== '';
                if(isOpen) closeHelp(); else openHelp();
            });
        }
        if(closeBtn){ closeBtn.addEventListener('click', (e)=>{ e.stopPropagation(); closeHelp(); }); }
        document.addEventListener('click', (e)=>{
            if(!panel || panel.style.display==='none') return;
            const t = e.target;
            if(t instanceof Node){
                if(panel.contains(t)) return;
                if(helpBtn && helpBtn.contains && helpBtn.contains(t)) return;
            }
            closeHelp();
        });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeHelp(); } });
    }catch(e){ console.warn('globalHelp wiring failed', e); }
})();

// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?繝ｻ・ｽ繝ｻ・ｽ隴会ｽｮ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｬ・ｯ莨夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ蜿厄ｽｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陋ｹ竏ｵ貍・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ蜿厄ｽｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ髮｣・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function findMonophonicTracks(){
    const res=[];
    currentTracks.forEach((tr,idx)=>{
        const notes=(tr.notes||[]).slice().sort((a,b)=>a.time-b.time);
        if(!notes.length) return;
        let ok=true; let lastEnd=-Infinity;
        for(const n of notes){ if(n.time < lastEnd - 1e-6){ ok=false; break; } lastEnd = Math.max(lastEnd, n.time + n.duration); }
        if(ok) res.push({idx, count: notes.length});
    });
    res.sort((a,b)=> b.count - a.count);
    return res.map(o=>o.idx);
}

function autoSelectMelodyTrackIfMonophonic(){
    const monos=findMonophonicTracks();
    if(monos.length){
        melodyTrackIndex=monos[0];
        populateTrackSelectors();
    }
}

// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ隰撰ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣螂・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蠅難ｽｺ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function populateTrackSelectors(){
    try{
        const tracks = Array.isArray(currentTracks)? currentTracks: [];
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(melodySel){
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            while(melodySel.firstChild) melodySel.removeChild(melodySel.firstChild);
            tracks.forEach((t, i)=>{
                const opt=document.createElement('option');
                const count = (t && Array.isArray(t.notes))? t.notes.length: 0;
                opt.value=String(i);
                opt.textContent = `Track ${i+1} (${count} notes)`;
                if(i===melodyTrackIndex) opt.selected=true;
                melodySel.appendChild(opt);
            });
            // 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｮ・ｯ隶灘･・ｽｽ・ｻ髦ｮ蜊搾ｽｧ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const idx = Math.max(0, Math.min(melodyTrackIndex, Math.max(0, tracks.length-1)));
            melodySel.value = String(idx);
        }
        // 鬯ｮ・｣髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶抵ｽｭ?繝ｻ・ｽ?鬮｢・ｾ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ隰撰ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣螂・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟・ｽｿ・ｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬆托ｽｨ・｣邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(accompSel){
            while(accompSel.firstChild) accompSel.removeChild(accompSel.firstChild);
            const opt=document.createElement('option');
            opt.value='auto';
            const accompCount = tracks.reduce((a, t, i)=> a + ((i===melodyTrackIndex)? 0: ((t?.notes?.length)||0)), 0);
            opt.textContent = `Auto (melody鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髫ｶ謚ｵ・ｽ・ｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?, total ${accompCount} notes)`;
            accompSel.appendChild(opt);
            accompSel.disabled = true; // 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?I鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        }
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮｣逧ｮ逕･髯ｦ・ｷ髫ｶ髮｣・ｽ・ｪ鬯ｮ・ｯ雋・ｽｷ郢晢ｽｻ髣憺屮・ｽ・ｭ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ髣憺屮・ｽ・ｭ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ髦ｮ蜻ｻ・ｼ莨・ｽｫ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // trackInstrumentGrid 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髫ｲ蟶幢ｽ､・ｷ陝ｶ譏ｴ・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴主・遘・ｬｲ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    }catch(e){ console.warn('populateTrackSelectors failed', e); }
}

// fflate 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ遶乗刋・ｨ・ｺ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ髦ｮ蜻ｻ・ｼ莨・ｽｫ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
async function loadFflateDynamic(){
    function isStub(){
        try{
            if(typeof fflate==='undefined') return true;
            if(typeof fflate.unzipSync!=='function') return true;
            const s=String(fflate.unzipSync);
            if(/鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陞滂ｽｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷会ｽｱ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?/.test(s)) return true;
        }catch(_){ return true; }
        return false;
    }
    if(!isStub()) return true;
    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ assets/libs 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｳ・ｻ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    await new Promise((res)=>{
        const s=document.createElement('script'); s.src='assets/libs/fflate.min.js'; s.async=true; s.onload=()=>res(true); s.onerror=()=>res(false); document.head.appendChild(s);
    });
    if(!isStub()) return true;
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?隴幢ｽｭN鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    await new Promise((res)=>{
        const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.min.js'; s.async=true; s.onload=()=>res(true); s.onerror=()=>res(false); document.head.appendChild(s);
    });
    return !isStub();
}
// ---- Playback core (missing helpers) ----
function startPlayback(){
    if(isPlaying) return;
    ensureAudio(); tuneCompressor();
    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬮ｯ・ｷ闔・･雎撰ｽｺ驍ｵ・ｺ陞滓・遒托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ螳育櫨隲｢蟷・建郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ or 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｺ・ｽ陜ｮ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｷ譎｢・ｽ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const practiceMode = (function(){
        let hasAny=false;
        try{ if(melodyBuffer) hasAny=true; if(accompBuffer) hasAny=true; if(Array.isArray(melodyParts)){ for(const p of melodyParts){ if(p&&p.buffer){ hasAny=true; break; } } } }catch(_){ }
        // isPitchOnlyMode 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽtrue 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(isPitchOnlyMode) return true;
        return !hasAny;
    })();
    try{ if(audioCtx.state!=='running'){ audioCtx.resume().catch(()=>{}); } }catch(_){ }
    isPlaying=true;
    const START_LAT=0.02; const startLead = 0; // btLatencySec 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ scheduleMore 鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ鬮ｦ・ｪ?繝ｻ・ｽ?髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    playbackStartTime=audioCtx.currentTime + START_LAT + startLead;
    playbackStartPerf=performance.now()/1000 + START_LAT + startLead;
    playbackStartPos=playbackPosition;
    stopAllSources();
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ陞滓腸・ｽ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{ if(window.__driftStats){ window.__driftStats.samples=0; window.__driftStats.avg=0; window.__driftStats.max=0; window.__driftStats.last=0; const el=document.getElementById('driftOverlay'); if(el) el.textContent='Drift(start)'; }
        const el=document.getElementById('driftOverlay'); if(el){ el.textContent+=''; }
    }catch(_){ }
    if(!practiceMode){
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・､鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｫ・ｴ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        try{ melodySources.forEach(s=>{ try{s.stop(0);}catch(_){}}); }catch(_){ } melodySources=[];
        if(Array.isArray(melodyParts)){
            for(let i=0;i<melodyParts.length;i++){
                const p = melodyParts[i];
                if(!p || !p.buffer) continue;
                if(!p.playAudio) continue;
                const s = createAndStartSource(p.buffer, playbackStartTime, playbackPosition, melodyGain||masterGain||audioCtx.destination);
                if(s) melodySources.push(s);
            }
        } else if(melodyBuffer){
            // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ・つ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ
            melodySource=createAndStartSource(melodyBuffer, playbackStartTime, playbackPosition, melodyGain||masterGain||audioCtx.destination);
        }
        if(accompBuffer){ accompSource=createAndStartSource(accompBuffer, playbackStartTime, playbackPosition, accompGain||masterGain||audioCtx.destination); }
    } else {
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ髯ｳﾂ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ granted 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?髫ｶ魃会ｽｽ・｢繝ｻ・ｽ?隰悟･・ｽｽ・ｭ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(!micAnalyser || !micData){ try{ canInitMicWithoutPrompt().then(ok=>{ if(ok) initMic(false).catch(()=>{}); }); }catch(_){ } }
    }
    if(analysisTimer){ clearInterval(analysisTimer); analysisTimer=null; }
    analysisTimer=setInterval(analyzePitch, 1000/analysisRate);
    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ・ｺ・ｽ陜ｮ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ陷證ｦ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣比ｼ夲ｽｽ・ｰ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ・｢髮｣・ｽ・ｹ陋ｹ竏晄溜郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    requestAnimationFrame(loop);
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        scoreSessionId++;
        scoreStats = { total:0, bins: Array.from({length:12},()=>({count:0,sum:0,sumAbs:0,inTol:0,outTol:0,sharp:0,flat:0})) };
    }catch(_){ scoreStats=null; }
    // 鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰・玄・ｭ鬥ｴ・ｬ螟ｲ・ｽ・ｨ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ魃会ｽｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    if(_pauseAdviceTimer){ try{ clearTimeout(_pauseAdviceTimer); }catch(_){} _pauseAdviceTimer=null; }
    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
}
function pausePlayback(){
    isPlaying=false;
    try{ console.warn('[pausePlayback] called at pos=', (playbackPosition||0).toFixed(3)); }catch(_){ }
    try{ if(schedTimer) clearInterval(schedTimer); schedTimer=null; }catch(_){ }
    stopAllSources();
    forceStopAllVoices();
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?髴・ｽｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・ｪ?髫ｶ魃会ｽｽ・｢髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ驛｢譎｢・ｽ・｡?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    scheduleAll();
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰・玄・ｭ鬥ｴ・ｬ螟ｲ・ｽ・ｨ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(_pauseAdviceTimer){ try{ clearTimeout(_pauseAdviceTimer); }catch(_){} _pauseAdviceTimer=null; }
}

// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ/鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ郢晢ｽｻ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
function forceStopAllVoices(){
    try{
        const now=audioCtx? audioCtx.currentTime: 0;
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        activeSampleVoices.forEach(v=>{
            try{ if(v.g && v.g.gain){ v.g.gain.cancelScheduledValues(now); v.g.gain.setValueAtTime(0.0001, now); } }catch(_){ }
            try{ if(v.src && v.src.stop) v.src.stop(0); }catch(_){}
            try{ if(v.rsrc && v.rsrc.stop) v.rsrc.stop(0); }catch(_){}
            try{ if(v.g && v.g.disconnect) v.g.disconnect(); }catch(_){}
        });
        activeSampleVoices=[];
    }catch(_){ }
    try{
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        activeVoices.forEach(v=>{ try{ v.nodes.forEach(n=>{ try{ if(n.stop) n.stop(0); }catch(_){ } try{ if(n.disconnect) n.disconnect(); }catch(_){ } }); }catch(_){ } });
        activeVoices=[];
    }catch(_){ }
}
function updatePlaybackPosition(){ if(!isPlaying||!audioCtx) return; const dt=Math.max(0, audioCtx.currentTime - playbackStartTime); playbackPosition = playbackStartPos + dt; }

// ---- Playback position hybrid clock ----
// AudioContext.currentTime 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｻ雜｣・ｿ・ｽ???郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ諤懃・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛δｧ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ螂・ｽｽ・･陞滓・雋ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陋ｹ竏ｵ貍・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螢ｼ・ｭ邏ormance.now() 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let playbackStartPerf=0; // 鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｿ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽerformance.now/1000鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
const IS_MOBILE = /Android|iPhone|iPad|iPod|Mobile|Tablet/i.test(navigator.userAgent||'');
const IS_MOBILE_PCPIPE = IS_MOBILE && USE_PC_PIPELINE_ON_MOBILE;
let _lastFrameTime=performance.now();
let _frameAccum=0, _frameCnt=0, _lastPerfLog=performance.now();
let _frameSkipToggle=false;
// === Drift 鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ ===
// 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ陞溷・竕ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? AudioContext.currentTime 鬯ｮ・｣隲幄ご陲夜匚謇假ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ? performance.now() 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
// 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ loop() 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? driftStats 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髮区ｩｸ・ｽ・ｴ繝ｻ・ｽ?隲ｱ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ雜｣・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髴難ｽ｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let FORCE_PERF_CLOCK=false; // true 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽperfDt 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let _driftForceState='idle'; // 'idle' | 'armed' | 'forcing'
const DRIFT_FORCE_AVG_MS=150;      // 鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ髮｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const DRIFT_FORCE_SAMPLES=60;      // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const DRIFT_FORCE_HYST_MS=90;      // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ郢晢ｽｻ邵ｺ・､・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let _lastDriftDecisionAt=0;
// ==== 鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蝣ｺ・ｸ讖ｸ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ隶難ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ (鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ) 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯ｷ謳ｾ・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ (鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ) 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ ====
// 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ謨鳴郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ隴幢ｽｱ髮趣ｽｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ:
// 1) noteGridCanvas, dynamicCanvas 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ2鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｽ陋ｾ鬆ｼ隶難ｽ｣陜ｮ・ｿ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ? chartContainer 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?
// 2) 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ
// 3) 鬯ｮ・ｮ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ dynamicCanvas 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
// 4) 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ CPU/GPU 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ jank 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽrue 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣郢晢ｽｻ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｫ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隰疲ｻゑｽｽ・ｳ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let USE_STATIC_LAYER_OPT=false;
function updatePlaybackPositionHybrid(){
    if(!isPlaying||!audioCtx) return;
    try{
        const nowPerf = performance.now()/1000;
        const ctxDt = Math.max(0, audioCtx.currentTime - playbackStartTime);
        const perfDt = Math.max(0, nowPerf - playbackStartPerf);
        let usePerf=false;
        if(FORCE_PERF_CLOCK){
            // 鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ drift 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩埼｡費ｽｾ蟒登rmance 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            playbackPosition = playbackStartPos + perfDt;
            return;
        }
        if(perfDt>0.15){
            const ratio = ctxDt / (perfDt||1e-6);
            usePerf = IS_MOBILE? (ratio < 0.5) : (ratio < 0.6);
        }
        let dt = ctxDt;
        if(!usePerf){
            if(perfDt - ctxDt > 0.04){ // 40ms 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隶主･・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ髮｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋企屮・ｿ・ｽ?繝ｻ・ｽ?髯区ｻ会ｽｻ・ｰ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                dt = ctxDt + (perfDt-ctxDt)*0.10;
            }
        } else {
            dt = perfDt;
        }
        playbackPosition = playbackStartPos + dt;
    }catch(_){
        const dt=Math.max(0, audioCtx.currentTime - playbackStartTime);
        playbackPosition = playbackStartPos + dt;
    }
}
function scheduleMore(){
    if(SIMPLE_SFZ_MODE){ return scheduleMoreSimple(); }
    if(!isPlaying||!audioCtx) return;
    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(!melodyBuffer && !accompBuffer) return;
    const now=audioCtx.currentTime;
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｫ・ｴ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髫伜､懶ｽｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・ｨ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髫ｨ蜷ｶ・具ｾ守｢托ｽｭ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋企屮・ｿ・ｽ?繝ｻ・ｽ髣憺屮・ｽ・ｭ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・＠?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣雋ｻ・ｽ・ｨ驕ｶ荳橸ｽ､螂・ｽｽ・｣郢晢ｽｻ
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ>~0.01鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴取得・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const gvEl=document.getElementById('guideVolumeSlider');
    const avEl=document.getElementById('accompVolumeSlider');
    const enableMel = gvEl? (parseFloat(gvEl.value)>0.01) : true;
    const enableAcc = avEl? (parseFloat(avEl.value)>0.01) : true;
    const isTrackEnabled = (ti)=>{
        const isMel = (ti===melodyTrackIndex);
        if((isMel && !enableMel) || (!isMel && !enableAcc)) return false;
        const assign = trackInstrumentAssign[ti]|| (isMel? 'Flute': 'Piano');
        return assign!=='none' && (currentTracks[ti]?.notes?.length>0);
    };
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｸ蜿ｯﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const findNextNoteTime = (after)=>{
        let t=Infinity;
        for(let ti=0; ti<currentTracks.length; ti++){
            if(!isTrackEnabled(ti)) continue;
            const notes=currentTracks[ti].notes;
            for(const n of notes){
                const st=n.time; if(st>after+1e-6){ if(st<t) t=st; break; }
            }
        }
        return isFinite(t)? t: null;
    };

    // from/target 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ雋・ｽｯ繝ｻ・ｽ?髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    let from = isFinite(scheduledUntil)? scheduledUntil: (playbackPosition||0);
    const baseAhead = SCHEDULE_AHEAD; // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ驛｢譎｢・ｽ・｡?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ

    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ?髴・ｽｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ髮趣ｽｸ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let loops=0; const MAX_LOOPS=3; let scheduledTotal=0; const MAX_NODES_PER_CALL=120;
    while(loops<MAX_LOOPS){
        loops++;
        const basePos = Math.max(isFinite(scheduledUntil)? scheduledUntil: 0, playbackPosition||0);
        const songDur = getSongDuration();
        let target = Math.min(isFinite(songDur)? songDur: (basePos+baseAhead), basePos + baseAhead);
        if(!(isFinite(target))) target = basePos + baseAhead;
        if(target<=from+1e-6){ target = from + baseAhead; }
        if(window.DEBUG_SCHED){ try{ console.log('[sched] win',loops,'from',from.toFixed(3),'base',basePos.toFixed(3),'target',target.toFixed(3),'pos', (playbackPosition||0).toFixed(3)); }catch(_){ } }

        let scheduledCount=0; let hardLimitHit=false;
        for(let ti=0; ti<currentTracks.length && !hardLimitHit; ti++){
            if(!isTrackEnabled(ti)) continue;
            const isMel = (ti===melodyTrackIndex);
            const assign = trackInstrumentAssign[ti]|| (isMel? 'Flute': 'Piano');
            const out = isMel? (melodyGain||masterGain||audioCtx.destination): (accompGain||masterGain||audioCtx.destination);
            const notes=currentTracks[ti].notes;
            for(const n of notes){
                const st=n.time, en=st+n.duration;
                if(en<=from) continue; if(st>=target) break;
                // 鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ荵晢ｽ育ｹ晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髮手ｶ｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ when 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                let when = (isFinite(playbackStartTime)? playbackStartTime: audioCtx.currentTime) + ((isFinite(st)&&isFinite(playbackStartPos))? (st - playbackStartPos): 0);
                if(btLatencyEnabled){ when -= btLatencySec; }
                if(when < now - 0.01){ when = now + 0.002; }

                let ok=false;
                if(useSamplePiano && (instrumentMaps[assign] || pianoSampleMap) && (Object.keys(instrumentMaps[assign]||pianoSampleMap).length)){
                    ok = playFromZipPiano(n.midi, when, n.duration, out, assign);
                    if(window.DEBUG_SAMPLE_NOTE && ok){ try{ console.log('scheduled sample', {inst:assign, midi:n.midi, when: (when-audioCtx.currentTime).toFixed(3)}); }catch(_){ } }
                }
                if(!ok){ ok = !!createPianoVoice(n.midi, when, n.duration, out); }
                if(ok){ scheduledCounter++; scheduledCount++; scheduledTotal++; }

                if(scheduledTotal >= MAX_NODES_PER_CALL){ hardLimitHit=true; break; }
            }
        }

        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣皮甥髮?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        scheduledUntil = target;
        if(window.DEBUG_SCHED){ try{ console.log('[sched] scheduled:', scheduledCount, 'accum:', scheduledTotal, 'scheduledUntil->', (scheduledUntil||0).toFixed(3)); }catch(_){ } }

        // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ1鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣厄ｽｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ蠍ｺ・ｺ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ from 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隲・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ騾ｹ・｣・つ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ30鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｿ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(scheduledCount===0 && !hardLimitHit){
            const nextT = findNextNoteTime(from);
            if(nextT!=null){
                const jumpTo = Math.min(nextT, from + (MAX_DYNAMIC_LOOKAHEAD||30));
                if(window.DEBUG_SCHED){ try{ console.log('[sched] no-notes; jump from', from.toFixed(3), '->', jumpTo.toFixed(3)); }catch(_){ } }
                from = jumpTo;
                continue; // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・つ陷ｻ・ｵ雎募ｹ・ｱ・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            }
        }

        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・｡鬯･・ｴ陋ｻ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(hardLimitHit || scheduledTotal >= MAX_NODES_PER_CALL) break;
        if(scheduledCount===0) break;
    }
}
function autoCenterMelodyTrack(){
    if(autoCenterFrozen) return; // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｼ夲ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 2.5鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ鬆第答鬮ｯ譎｢・｣・ｰ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ鬩滂ｽｪ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ・つ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隰疲ｻゑｽｽ・､郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯晢ｽｶ隴惹ｹ怜･・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
    return;
}
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽIDI鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ? [low, high] 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驍ｵ・ｺ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
function setVerticalOffsetToRange(low, high){
    if(!Number.isFinite(low) || !Number.isFinite(high)) return;
    const total=verticalZoom*12; // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const min=36, max=132; // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?
    const allowRange=Math.max(0, (max-min-total));
    const span = Math.max(1, (high - low + 1));
    const desiredCenter = (low + high) / 2;
    const clampedCenter = Math.max(min + total/2, Math.min(max - total/2, desiredCenter));
    const desiredVmin = Math.round(clampedCenter - total/2);
    const rel = Math.max(0, Math.min(allowRange, desiredVmin - min));
    verticalOffset = Math.round((rel / Math.max(1, allowRange)) * 100);
    try{ if(typeof syncVerticalOffsetSliders==='function') syncVerticalOffsetSliders(); }catch(_){ }
}
// 鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ?關難ｽｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
window.resetAutoCenter = function(){ autoCenterFrozen=false; autoCenterMelodyTrack(); drawChart(); };
function scheduleAll(){ scheduledUntil=playbackPosition; }

// ==================== MIDI Functions ====================
// MIDI parser: Extract all tracks with note events
function parseMidiAllTracks(u8){
    try{
        const dv=new DataView(u8.buffer,u8.byteOffset,u8.byteLength);
        let p=0;
        function readStr(len){ let s=''; for(let i=0;i<len;i++) s+=String.fromCharCode(dv.getUint8(p++)); return s; }
        function readU32(){ const v=dv.getUint32(p); p+=4; return v; }
        function readU16(){ const v=dv.getUint16(p); p+=2; return v; }
        if(readStr(4)!=='MThd') return [];
        const hdrLen=readU32(); const format=readU16(); const ntr=readU16(); const division=readU16();
        p = 8+6; // skip to after header
        const tracks=[];
        for(let t=0;t<ntr;t++){
            const id=readStr(4); const len=readU32();
            if(id!=='MTrk'){ p+=len; continue; }
            const end=p+len; let curTime=0; let runningStatus=0; const events=[];
            function readVar(){ let v=0; while(true){ const b=dv.getUint8(p++); v=(v<<7)|(b&0x7F); if(!(b&0x80)) break; } return v; }
            while(p<end){
                const dt=readVar(); curTime+=dt;
                let st=dv.getUint8(p++);
                if(st<0x80){ p--; st=runningStatus; } else { runningStatus=st; }
                if((st&0xF0)===0x90 || (st&0xF0)===0x80){
                    const note=dv.getUint8(p++); const vel=dv.getUint8(p++);
                    events.push({t:curTime, type:(st&0xF0), note, vel});
                }
                else if(st===0xFF){ const meta=dv.getUint8(p++); const len=readVar(); p+=len; }
                else { const hi=st&0xF0; const cons = (hi===0xC0||hi===0xD0)? 1: 2; p+=cons; }
            }
            const onMap=new Map(); const notes=[];
            events.forEach(ev=>{
                if(ev.type===0x90 && ev.vel>0){ onMap.set(ev.note, ev.t); }
                else if((ev.type===0x80) || (ev.type===0x90 && ev.vel===0)){
                    const st=onMap.get(ev.note);
                    if(st!=null){ notes.push({midi:ev.note, st, en:ev.t}); onMap.delete(ev.note); }
                }
            });
            tracks.push({ index:t, notes });
        }
        return tracks.filter(tr=> tr.notes && tr.notes.length>0).sort((a,b)=> b.notes.length - a.notes.length);
    }catch(_){ return []; }
}

// Convert MIDI track notes to app format with octave shift
function convertMidiTrackToNotes(midiNotes, octaveShiftSemitones){
    if(!midiNotes || !Array.isArray(midiNotes)) return [];
    // Assuming 480ppq, 120BPM -> 1 tick = 1.04ms approx
    const tickToSec = (tick)=> tick / 480.0 * 0.5;
    const notes = midiNotes.map(n=>{
        const midi = n.midi + octaveShiftSemitones;
        const time = tickToSec(n.st);
        const duration = tickToSec(n.en - n.st);
        return {midi, time, duration};
    }).filter(n=> n.midi>=0 && n.midi<=127).sort((a,b)=> a.time - b.time);
    return notes;
}

// Show MIDI track selection dialog
function showMidiTrackDialog(parsedTracks, partObj, fileName){
    return new Promise((resolve, reject)=>{
        const dialog = document.getElementById('midiTrackDialog');
        const overlay = document.getElementById('midiTrackDialogOverlay');
        const trackSelect = document.getElementById('midiTrackSelect');
        const octaveShift = document.getElementById('midiOctaveShift');
        const octaveShiftVal = document.getElementById('midiOctaveShiftVal');
        const okBtn = document.getElementById('midiTrackOkBtn');
        const cancelBtn = document.getElementById('midiTrackCancelBtn');
        if(!dialog || !overlay || !trackSelect || !octaveShift || !okBtn || !cancelBtn){
            reject(new Error('Dialog elements not found')); return;
        }
        
        // Populate track options
        trackSelect.innerHTML='';
        parsedTracks.forEach((tr, i)=>{
            const opt=document.createElement('option');
            opt.value=String(i);
            opt.textContent=`Track ${i+1} (${tr.notes.length} notes)`;
            trackSelect.appendChild(opt);
        });
        trackSelect.selectedIndex=0;
        octaveShift.value='0';
        if(octaveShiftVal) octaveShiftVal.textContent='0';
        
        // Octave shift slider update
        const updateOctaveLabel = ()=>{
            if(octaveShiftVal) octaveShiftVal.textContent = octaveShift.value;
        };
        octaveShift.addEventListener('input', updateOctaveLabel);
        
        // Show dialog
        dialog.style.display='block';
        overlay.style.display='block';
        
        // OK button handler
        const handleOk = async ()=>{
            try{
                const selectedIdx = parseInt(trackSelect.value, 10);
                const octaveShiftSemitones = parseInt(octaveShift.value, 10);
                const selectedTrack = parsedTracks[selectedIdx];
                if(!selectedTrack){ reject(new Error('Invalid track selection')); return; }
                
                // Convert MIDI notes to app format
                const notes = convertMidiTrackToNotes(selectedTrack.notes, octaveShiftSemitones);
                partObj.notes = notes;
                partObj.duration = notes.length>0 ? Math.max(...notes.map(n=>n.time+n.duration)) : 0;
                partObj.buffer = null; // No audio buffer for MIDI
                
                // Reset state
                autoCenterFrozen = false;
                autoCenterMelodyTrack();
                try{ if(isAssistActive()) stopLatencyAssist(); }catch(_){ }
                try{ if(isCalibrating){ _calibAbort=true; isCalibrating=false; } }catch(_){ }
                midiGhostNotes = null; calibCountdownText=null; calibAnchorActive=false;
                
                // Update currentTracks
                currentTracks=[{name:`Melody P${currentMelodyPart+1}`, notes:(partObj.notes||[])}];
                melodyTrackIndex=0;
                melodyNotesExtracted=true;
                
                // Disable pitch-only mode
                try{
                    if(isPitchOnlyMode){
                        isPitchOnlyMode = false;
                        const btn = document.getElementById('pitchOnlyModeBtn');
                        if(btn){
                            btn.classList.toggle('active', false);
                            btn.title = 'Pitch-only mode';
                        }
                    }
                }catch(_){ }
                
                // Reset playback
                if(isPlaying){ try{ pausePlayback(); }catch(_){ } }
                stopStage = 0;
                timelineOffsetSec = 0;
                scheduledUntil = 0;
                playbackPosition = 0;
                playbackStartPos = 0;
                
                // Update UI
                try{ if(typeof resizeCanvas==='function') resizeCanvas(); }catch(_){ }
                scheduleAll();
                updateTimelineScrollRange();
                drawChart();
                try{ if(btCalibStatus) btCalibStatus.textContent='Not calibrated'; }catch(_){ }
                
                dialog.style.display='none';
                overlay.style.display='none';
                octaveShift.removeEventListener('input', updateOctaveLabel);
                okBtn.removeEventListener('click', handleOk);
                cancelBtn.removeEventListener('click', handleCancel);
                resolve();
            }catch(err){
                console.warn('MIDI track dialog error:', err);
                dialog.style.display='none';
                overlay.style.display='none';
                octaveShift.removeEventListener('input', updateOctaveLabel);
                okBtn.removeEventListener('click', handleOk);
                cancelBtn.removeEventListener('click', handleCancel);
                reject(err);
            }
        };
        
        // Cancel button handler
        const handleCancel = ()=>{
            dialog.style.display='none';
            overlay.style.display='none';
            octaveShift.removeEventListener('input', updateOctaveLabel);
            okBtn.removeEventListener('click', handleOk);
            cancelBtn.removeEventListener('click', handleCancel);
            reject(new Error('User cancelled'));
        };
        
        okBtn.addEventListener('click', handleOk);
        cancelBtn.addEventListener('click', handleCancel);
    });
}

// ---- UI ----
// 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ UI
if(melodyAudioBtn && melodyAudioInput){ melodyAudioBtn.onclick=()=>{ if(melodyAudioBtn.disabled) return; melodyAudioInput.click(); }; }
if(melodyAudioInput){ melodyAudioInput.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; if(melodyAudioLabel){ melodyAudioLabel.textContent=f.name; melodyAudioLabel.title=f.name; } const overlay=document.getElementById('analyzingOverlay'); try{ if(overlay){ overlay.classList.remove('hidden'); } const ab=await f.arrayBuffer(); const srcU8=new Uint8Array(ab);
    const P = melodyParts[currentMelodyPart];
    P.origBytes=new Uint8Array(srcU8.length); P.origBytes.set(srcU8);
    P.origName=f.name; P.origExt=(f.name.split('.').pop()||'bin').toLowerCase(); if(!audioCtx) ensureAudio();
    // Check if MIDI file (.mid, .midi)
    if(P.origExt==='mid' || P.origExt==='midi'){
        if(overlay){ overlay.classList.add('hidden'); }
        const parsed = parseMidiAllTracks(srcU8);
        if(!parsed || !parsed.length){ console.warn('Could not extract tracks from MIDI'); return; }
        // Show track selection dialog
        await showMidiTrackDialog(parsed, P, f.name);
        return;
    }
    // Audio file processing
    P.buffer=await new Promise((res,rej)=> audioCtx.decodeAudioData(ab, b=>res(b), e=>rej(e)));
    P.duration=P.buffer.duration||0; await extractMelodyNotesFromBuffer(P.buffer);
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔・･雎撰ｽｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ currentTracks[0] 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・､鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ notes 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ
    try{ P.notes = (currentTracks && currentTracks[0] && Array.isArray(currentTracks[0].notes))? currentTracks[0].notes.slice() : []; }catch(_){ P.notes = []; }
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    autoCenterFrozen = false;
    autoCenterMelodyTrack();
    // --- 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ ---
    try{ if(isAssistActive()) stopLatencyAssist(); }catch(_){ }
    try{ if(isCalibrating){ _calibAbort=true; isCalibrating=false; } }catch(_){ }
    midiGhostNotes = null; calibCountdownText=null; calibAnchorActive=false;
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴擾ｽｴ?繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ?
    currentTracks=[{name:`Melody P${currentMelodyPart+1}`, notes:(P.notes||[])}]; melodyTrackIndex=0; melodyNotesExtracted=true;
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬆托ｽｨ・｣・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｷ讌ｪﾂ髯ｷ謇假ｽｽ・ｰ髫ｲ・､郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        if(isPitchOnlyMode){
            isPitchOnlyMode = false;
            const btn = document.getElementById('pitchOnlyModeBtn');
            if(btn){
                btn.classList.toggle('active', false);
                btn.title = '鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ陷托ｽｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ怜℡鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
            }
        }
    }catch(_){ }
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(isPlaying){ try{ pausePlayback(); }catch(_){ } }
    stopStage = 0;
    timelineOffsetSec = 0;
    scheduledUntil = 0;
    playbackPosition = 0;
    playbackStartPos = 0;
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬮ｮ・ｷ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｷ讌ｪﾂ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ??
    try{ if(typeof resizeCanvas==='function') resizeCanvas(); }catch(_){ }
    scheduleAll();
    updateTimelineScrollRange();
    drawChart();
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{ if(btCalibStatus) btCalibStatus.textContent='鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ; }catch(_){ }
    }catch(err){ console.warn('鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ', err); } finally { if(overlay){ overlay.classList.add('hidden'); } } }; }
if(accompAudioBtn && accompAudioInput){ accompAudioBtn.onclick=()=>{ if(accompAudioBtn.disabled) return; accompAudioInput.click(); }; }
if(accompAudioInput){ accompAudioInput.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; if(accompAudioLabel){ accompAudioLabel.textContent=f.name; accompAudioLabel.title=f.name; } try{ const ab=await f.arrayBuffer(); const srcU8=new Uint8Array(ab); accompOrigBytes=new Uint8Array(srcU8.length); accompOrigBytes.set(srcU8); accompOrigName=f.name; accompOrigExt=(f.name.split('.').pop()||'bin').toLowerCase(); if(!audioCtx) ensureAudio(); accompBuffer=await new Promise((res,rej)=> audioCtx.decodeAudioData(ab, b=>res(b), e=>rej(e))); accompDuration=accompBuffer.duration||0; }catch(err){ console.warn('鬯ｮ・｣髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶抵ｽｭ?繝ｻ・ｽ?髮守ｵｶ謠｡?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ', err); } }; }

// ================= 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ =================
function textEncodeUtf8(str){ try{ return new TextEncoder().encode(str); }catch(_){ // IE/鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const u8=new Uint8Array(str.length); for(let i=0;i<str.length;i++) u8[i]=str.charCodeAt(i)&255; return u8; }
}
function textDecodeUtf8(u8){ try{ return new TextDecoder().decode(u8); }catch(_){ let s=''; for(let i=0;i<u8.length;i++) s+=String.fromCharCode(u8[i]); return s; } }

function buildSessionJson(){
    const tr=currentTracks[melodyTrackIndex];
    const notes=(tr&&tr.notes)? tr.notes.map(n=>({midi:n.midi,time:n.time,duration:n.duration})) : [];
    const dots=pitchHistory.map(p=>({time:p.time,freq:p.freq,conf:p.conf}));
    const meta={
        app:"pitch-trainer",
        ver:"1",
        a4:A4Frequency,
        toleranceCents,
        tempoFactor,
        guideLineWidth,
        verticalZoom, verticalOffset,
        pxPerSec, timelineOffsetSec,
        labelNotation,
        btLatencyEnabled, btLatencySec,
        guideVolume: (guideVol? parseFloat(guideVol.value): (melodyGain? melodyGain.gain.value: 0.8)),
        accompVolume: (accompVol? parseFloat(accompVol.value): (accompGain? accompGain.gain.value: 0.8)),
        markers
    };
    const audio={
        melody: melodyOrigBytes? {name:melodyOrigName||'melody', ext:melodyOrigExt||'bin'} : null,
        accomp: accompOrigBytes? {name:accompOrigName||'accomp', ext:accompOrigExt||'bin'} : null
    };
    return {meta, notes, dots, audio};
}

function suggestSessionFileName(){
    const base=(melodyOrigName||melodyAudioLabel?.textContent||'session').replace(/\.[^.]+$/,'');
    return base+".session.zip";
}

function makeZipStoreOnly(files){
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ Store-only ZIP 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ: 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｶ隴幢ｽｱ陞ｳ・ｦ鬩包ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const chunks=[]; let offset=0; const enc=textEncodeUtf8;
    function pushU32LE(arr,v){ arr.push(v&255,(v>>8)&255,(v>>16)&255,(v>>24)&255); }
    function pushU16LE(arr,v){ arr.push(v&255,(v>>8)&255); }
    function dosTime(){ const d=new Date(); const t=((d.getHours())<<11)|((d.getMinutes())<<5)|((d.getSeconds()/2)|0); const da=(((d.getFullYear()-1980)<<9)|((d.getMonth()+1)<<5)|(d.getDate())); return {t,da}; }
    const {t,da}=dosTime();
    files.forEach(f=>{
        const nameU8=enc(f.name);
        const localHeader=[0x50,0x4b,0x03,0x04, 20,0, 0,0, 0,0, 0,0, 0,0, 0,0];
        // 鬯ｯ・ｩ陷会ｽｱ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽversion/extract needed etc 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const crc=0; const compSize=f.data.length; const unCompSize=f.data.length;
        localHeader.push(0,0, 0,0); // mod time/date 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷供ﾂ莉ｰﾂ?
        pushU16LE(localHeader,nameU8.length); pushU16LE(localHeader,0); // extra=0
        const hdrU8=new Uint8Array(localHeader);
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ邵ｺ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        hdrU8[10]=t&255; hdrU8[11]=(t>>8)&255; hdrU8[12]=da&255; hdrU8[13]=(da>>8)&255;
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/CRC
        hdrU8[14]=crc&255; hdrU8[15]=(crc>>8)&255; hdrU8[16]=(crc>>16)&255; hdrU8[17]=(crc>>24)&255;
        hdrU8[18]=compSize&255; hdrU8[19]=(compSize>>8)&255; hdrU8[20]=(compSize>>16)&255; hdrU8[21]=(compSize>>24)&255;
        hdrU8[22]=unCompSize&255; hdrU8[23]=(unCompSize>>8)&255; hdrU8[24]=(unCompSize>>16)&255; hdrU8[25]=(unCompSize>>24)&255;
        chunks.push(hdrU8); chunks.push(nameU8); chunks.push(f.data);
        offset += hdrU8.length + nameU8.length + f.data.length;
    });
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let total=0; chunks.forEach(c=> total+=c.length); const out=new Uint8Array(total); let p=0; chunks.forEach(c=>{ out.set(c,p); p+=c.length; });
    return out;
}

async function saveSessionZip(){
    try{
        const sess=buildSessionJson();
        const files=[];
        // session.json
        files.push({name:'session.json', data: textEncodeUtf8(JSON.stringify(sess))});
    if(melodyOrigBytes){ files.push({name: `${melodyOrigName||('melody.'+(melodyOrigExt||'bin'))}`, data: melodyOrigBytes}); }
    if(accompOrigBytes){ files.push({name: `${accompOrigName||('accomp.'+(accompOrigExt||'bin'))}`, data: accompOrigBytes}); }
        let zipU8=null;
        if(window.fflate && typeof fflate.zipSync==='function'){
            const m={}; files.forEach(f=> m[f.name]=f.data );
            zipU8=fflate.zipSync(m, { level: 0 }); // 鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(Store)鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        }else{
            zipU8=makeZipStoreOnly(files);
        }
        const blob=new Blob([zipU8], {type:'application/zip'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=suggestSessionFileName(); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 10000);
    }catch(err){ console.warn('鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｴ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ', err); }
}

async function loadSessionZipFromBytes(u8){
    let files=null; let usedFallback=false;
    try{
        if(window.fflate && typeof fflate.unzipSync==='function' && !/鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陞滂ｽｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/.test(String(fflate.unzipSync))){
            files=fflate.unzipSync(u8);
        }else{
            files=unzipStoreOnly(u8);
            usedFallback=true;
        }
    }catch(e){ console.warn('unzip鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ,e); files=unzipStoreOnly(u8); usedFallback=true; }
    if(!files){ throw new Error('ZIP鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ); }
    const sessEntry=files['session.json'] || files['./session.json'] || (function(){ for(const k in files){ if(k.endsWith('session.json')) return files[k]; } return null; })();
    if(!sessEntry) throw new Error('session.json 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?');
    let sess; try{ sess=JSON.parse(textDecodeUtf8(sessEntry)); }catch(e){ throw new Error('session.json 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣逧ｮ逕･鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ); }
    // 鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        A4Frequency=sess.meta?.a4||A4Frequency; toleranceCents=sess.meta?.toleranceCents??toleranceCents; tempoFactor=sess.meta?.tempoFactor??tempoFactor; guideLineWidth=sess.meta?.guideLineWidth??guideLineWidth; verticalZoom=sess.meta?.verticalZoom??verticalZoom; verticalOffset=sess.meta?.verticalOffset??verticalOffset; pxPerSec=sess.meta?.pxPerSec??pxPerSec; timelineOffsetSec=sess.meta?.timelineOffsetSec??timelineOffsetSec; labelNotation=sess.meta?.labelNotation||labelNotation; btLatencyEnabled=!!sess.meta?.btLatencyEnabled; btLatencySec=sess.meta?.btLatencySec??btLatencySec; if(sess.meta?.markers) markers=sess.meta.markers; 
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const gv = sess.meta?.guideVolume; const av = sess.meta?.accompVolume;
        if(typeof gv==='number' && guideVol){ guideVol.value=String(gv); }
        if(typeof av==='number' && accompVol){ accompVol.value=String(av); }
    }catch(_){ }
    // 鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    currentTracks=[{name:'Melody', notes: (sess.notes||[]).map(n=>({midi:n.midi,time:n.time,duration:n.duration}))}]; melodyTrackIndex=0; melodyNotesExtracted=true;
    // 鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    pitchHistory=(sess.dots||[]).map(d=>({time:d.time,freq:d.freq,conf:d.conf}));
    // 鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髫ｲ蟶幢ｽ､・ｷ陝ｶ譏ｴ・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    melodyBuffer=null; accompBuffer=null; melodyDuration=0; accompDuration=0;
    melodyOrigBytes=null; accompOrigBytes=null; melodyOrigName=null; accompOrigName=null; melodyOrigExt=null; accompOrigExt=null;
    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ session.json 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ audio.name 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬆托ｽｨ・｣陋ｹ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ鬩榊･・ｽｿ・ｽ?邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const melNameHint = sess.audio?.melody?.name || null;
    const accNameHint = sess.audio?.accomp?.name || null;
    const melBin = melNameHint? findFileByNames(files,[melNameHint]) : findFileByNames(files,['melody.wav','melody.mp3','melody.m4a','melody.aac','melody.bin']);
    const accBin = accNameHint? findFileByNames(files,[accNameHint]) : findFileByNames(files,['accomp.wav','accomp.mp3','accomp.m4a','accomp.aac','accomp.bin']);
    const overlay=document.getElementById('analyzingOverlay'); if(overlay){ overlay.classList.remove('hidden'); }
    try{
        ensureAudio();
        if(melBin){
            // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ
            melodyOrigBytes=new Uint8Array(melBin.bytes.length); melodyOrigBytes.set(melBin.bytes);
            melodyOrigName=melBin.name; melodyOrigExt=detectExtFromName(melBin.name);
            const ab = melBin.bytes.buffer.slice(melBin.bytes.byteOffset, melBin.bytes.byteOffset + melBin.bytes.byteLength);
            const buf=await new Promise((res,rej)=> audioCtx.decodeAudioData(ab, b=>res(b), e=>rej(e)));
            melodyBuffer=buf; melodyDuration=buf.duration||0;
        }
        if(accBin){
            accompOrigBytes=new Uint8Array(accBin.bytes.length); accompOrigBytes.set(accBin.bytes);
            accompOrigName=accBin.name; accompOrigExt=detectExtFromName(accBin.name);
            const ab = accBin.bytes.buffer.slice(accBin.bytes.byteOffset, accBin.bytes.byteOffset + accBin.bytes.byteLength);
            const buf=await new Promise((res,rej)=> audioCtx.decodeAudioData(ab, b=>res(b), e=>rej(e)));
            accompBuffer=buf; accompDuration=buf.duration||0;
        }
    }catch(err){ console.warn('鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ,err); }
    finally{ if(overlay){ overlay.classList.add('hidden'); } }
    // UI 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ?
    if(melodyAudioLabel){ melodyAudioLabel.textContent=melodyOrigName||'(zip鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?)'; melodyAudioLabel.title=melodyAudioLabel.textContent; }
    if(accompAudioLabel){ accompAudioLabel.textContent=accompOrigName||'(zip鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶抵ｽｭ?繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ'; accompAudioLabel.title=accompAudioLabel.textContent; }
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ鬯・ｯ帶ｵｮ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ?
    try{
    // A4 UI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(tolSlider&&tolVal){ tolSlider.value=String(toleranceCents); tolVal.textContent=String(toleranceCents); }
        if(vZoom) vZoom.value=String(verticalZoom);
        if(timeScale&&timeScaleVal){ timeScale.value=String(pxPerSec); timeScaleVal.textContent=String(pxPerSec); }
        if(guideVol && melodyGain){ const v=parseFloat(guideVol.value); if(isFinite(v)) melodyGain.gain.value=v; }
        if(accompVol && accompGain){ const v=parseFloat(accompVol.value); if(isFinite(v)) accompGain.gain.value=v; }
        if(btLatencyToggle){ btLatencyToggle.checked = !!btLatencyEnabled; }
        if(btLatencySlider){ const ms=Math.round((btLatencySec||0)*1000); btLatencySlider.value=String(ms); if(btLatencyValue) btLatencyValue.textContent=`${ms} ms`; btLatencySlider.disabled = !btLatencyEnabled; }
    }catch(_){ }
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    autoCenterFrozen = false;
    autoCenterMelodyTrack();
    drawChart();
}

function findFileByNames(files, candidates){
    for(const k in files){
        const low=k.toLowerCase();
        for(const c of candidates){
            if(low.endsWith(c)){
                const u8=files[k];
                return { name: k, bytes: (u8 instanceof Uint8Array)? u8 : new Uint8Array(u8) };
            }
        }
    }
    return null;
}
function detectExtFromName(name){ const m=name.match(/\.([a-z0-9]+)$/i); return m? m[1].toLowerCase(): 'bin'; }

// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
if(sessionSaveBtn){ sessionSaveBtn.onclick=()=>{ if(!melodyOrigBytes && !accompOrigBytes){ const ok = confirm('鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?'); if(!ok) return; } saveSessionZip(); }; }
if(sessionLoadBtn && sessionLoadInput){ sessionLoadBtn.onclick=()=> sessionLoadInput.click(); sessionLoadInput.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ const ab=await f.arrayBuffer(); await loadSessionZipFromBytes(new Uint8Array(ab)); }catch(err){ console.warn('鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ', err); } }; }
playBtn && (playBtn.onclick=()=>{ 
    if(!isPlaying) startPlayback(); 
    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽasic鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｵ蠍ｺ・ｺ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{ if(practiceMode==='basic' && !isPracticing){ startBasicPractice(); } }catch(_){ }
});
if(pauseBtn){
    pauseBtn.onclick=null;
    pauseBtn.addEventListener('keydown', (e)=>{ e.preventDefault(); e.stopPropagation(); });
    pauseBtn.addEventListener('keyup', (e)=>{ e.preventDefault(); e.stopPropagation(); });
    pauseBtn.addEventListener('pointerup', (ev)=>{
        if(!ev || ev.isTrusted!==true) return;
        pausePlayback();
    });
}
// stop 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ pointer 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・｣騾ｧ・ｮ騾包ｽ･?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜉ｱ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ click 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ陷驤ｴ諠ｧ髫ｲ・､郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
if(stopBtn){
    stopBtn.onclick=null;
    stopBtn.addEventListener('keydown', (e)=>{ e.preventDefault(); e.stopPropagation(); });
    stopBtn.addEventListener('keyup', (e)=>{ e.preventDefault(); e.stopPropagation(); });
    stopBtn.addEventListener('pointerdown', (ev)=>{
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(STOP_TRUSTED_ONLY && (!ev || ev.isTrusted!==true)){
            try{ console.warn('stop ignored (untrusted trigger: pointerdown)'); }catch(_){ }
            return;
        }
        stopBtn.dataset._armed='1';
    });
    stopBtn.addEventListener('pointerup', (ev)=>{
        if(stopBtn.dataset._armed!=='1') return;
        stopBtn.dataset._armed='0';
        if(STOP_TRUSTED_ONLY && (!ev || ev.isTrusted!==true)){
            try{ console.warn('stop ignored (untrusted trigger: pointerup)'); }catch(_){ }
            return;
        }
        // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ隰ｨ・ｴ鬯ｩ貊ゑｽｽ・ｪ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(isPracticing){ try{ stopBasicPractice(true); }catch(_){ } }
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬮ｮﾂ髯具ｽｻ隴取ｫ・ｽｾ・ｧ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        if(isCalibrating){ _calibAbort = true; }
        if(isAssistActive()){ stopLatencyAssist(); }
        if(isPlaying){
            pausePlayback();
            stopStage=1;
        } else if(stopStage===1){
            playbackPosition=0; playbackStartPos=0; stopStage=0;
            scheduleAll(); // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ驛｢譎｢・ｽ・｡?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            drawChart();
        }
    });
}
rw5 && (rw5.onclick=()=>seekRelative(-5)); rw10 && (rw10.onclick=()=>seekRelative(-10)); fw5 && (fw5.onclick=()=>seekRelative(5)); fw10 && (fw10.onclick=()=>seekRelative(10));
tolSlider && (tolSlider.oninput=()=>{ toleranceCents=parseInt(tolSlider.value); tolVal.textContent=toleranceCents; drawChart(); }); tolVal && (tolVal.textContent=toleranceCents);
gateSlider && (gateSlider.oninput=()=>{ gateThreshold=parseInt(gateSlider.value); gateVal.textContent=gateThreshold; updateMicGateVisual(); }); gateVal && (gateVal.textContent=gateThreshold);
rateSlider && (rateSlider.oninput=()=>{
    let v=parseInt(rateSlider.value);
    // hop=frame/2 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髫ｨ・ｬ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽIN鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        const sr = (audioCtx && audioCtx.sampleRate) ? audioCtx.sampleRate : 48000;
        const W = (micAnalyser && micAnalyser.fftSize) ? micAnalyser.fftSize : 2048;
        const hopRate = Math.max(10, Math.min(120, Math.round(sr / Math.max(1, Math.floor(W/2)))));
        v = Math.max(v, hopRate);
    }catch(_){ }
    analysisRate=v; rateVal.textContent=analysisRate;
    if(analysisTimer){ clearInterval(analysisTimer); analysisTimer=setInterval(analyzePitch,1000/analysisRate);} 
}); rateVal && (rateVal.textContent=analysisRate);
// A4/鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ鬆第答鬯ｩ蝓ｼ・｡遒托ｽｷ譎｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢ｧ蜿･・ｯ讓抵ｽｹ・ｧ郢晢ｽｻ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
labelSel && (labelSel.onchange=()=>{ labelNotation=labelSel.value; });
vZoom && (vZoom.oninput=()=>{ verticalZoom=parseFloat(vZoom.value); drawChart(); });
timeScale && (timeScale.oninput=()=>{ pxPerSec=parseInt(timeScale.value); if(timeScaleVal) timeScaleVal.textContent=pxPerSec; drawChart(); });
guideVol && (guideVol.oninput=()=>{ if(!melodyGain) return; const v=parseFloat(guideVol.value); melodyGain.gain.value = (isFinite(v)? v: (melodyGain.gain.value||0.8)); });
accompVol && (accompVol.oninput=()=>{ if(!accompGain) return; const v=parseFloat(accompVol.value); accompGain.gain.value = (isFinite(v)? v: (accompGain.gain.value||0.8)); });
guideLineWidthSlider && (guideLineWidthSlider.oninput=()=>{ guideLineWidth=parseInt(guideLineWidthSlider.value)||4; drawChart(); });
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢髢ｧ蛟ｬ・ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陷闍難ｽｷ譎｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ

// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｮ鬮ｷ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
const _visTimeSnapMsEl = document.getElementById('visTimeSnapMs');
const _visTimeSnapMsVal = document.getElementById('visTimeSnapMsVal');
if(_visTimeSnapMsEl){
    _visTimeSnapMsEl.oninput=()=>{ visTimeSnapMs = parseInt(_visTimeSnapMsEl.value)||180; if(_visTimeSnapMsVal) _visTimeSnapMsVal.textContent=String(visTimeSnapMs); drawChart(); };
    if(_visTimeSnapMsVal) _visTimeSnapMsVal.textContent=String(visTimeSnapMs);
}
const _visBridgeGapMsEl = document.getElementById('visBridgeGapMs');
const _visBridgeGapMsVal = document.getElementById('visBridgeGapMsVal');
if(_visBridgeGapMsEl){
    _visBridgeGapMsEl.oninput=()=>{ visBridgeGapMs = parseInt(_visBridgeGapMsEl.value)||150; if(_visBridgeGapMsVal) _visBridgeGapMsVal.textContent=String(visBridgeGapMs); drawChart(); };
    if(_visBridgeGapMsVal) _visBridgeGapMsVal.textContent=String(visBridgeGapMs);
}
const _visBridgeGapInNoteMsEl = document.getElementById('visBridgeGapInNoteMs');
const _visBridgeGapInNoteMsVal = document.getElementById('visBridgeGapInNoteMsVal');
if(_visBridgeGapInNoteMsEl){
    _visBridgeGapInNoteMsEl.oninput=()=>{ visBridgeGapInNoteMs = parseInt(_visBridgeGapInNoteMsEl.value)||300; if(_visBridgeGapInNoteMsVal) _visBridgeGapInNoteMsVal.textContent=String(visBridgeGapInNoteMs); drawChart(); };
    if(_visBridgeGapInNoteMsVal) _visBridgeGapInNoteMsVal.textContent=String(visBridgeGapInNoteMs);
}
const _visChangeTolSemiEl = document.getElementById('visChangeTolSemi');
const _visChangeTolSemiVal = document.getElementById('visChangeTolSemiVal');
if(_visChangeTolSemiEl){
    _visChangeTolSemiEl.oninput=()=>{ visChangeTolSemi = parseFloat(_visChangeTolSemiEl.value)||0.65; if(_visChangeTolSemiVal) _visChangeTolSemiVal.textContent=String(visChangeTolSemi); drawChart(); };
    if(_visChangeTolSemiVal) _visChangeTolSemiVal.textContent=String(visChangeTolSemi);
}
const _visEdgePadMsEl = document.getElementById('visEdgePadMs');
const _visEdgePadMsVal = document.getElementById('visEdgePadMsVal');
if(_visEdgePadMsEl){
    _visEdgePadMsEl.oninput=()=>{ visEdgePadMs = parseInt(_visEdgePadMsEl.value)||160; if(_visEdgePadMsVal) _visEdgePadMsVal.textContent=String(visEdgePadMs); drawChart(); };
    if(_visEdgePadMsVal) _visEdgePadMsVal.textContent=String(visEdgePadMs);
}

micBtn && (micBtn.onclick=async()=>{
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ? AudioContext 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｫ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隰疲ｻゑｽｽ・ｳ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ諞ｺ螻ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ?
    _userExplicitMicInit=true;
    try{ activateAudioOnce(); }catch(_){ }
    try{ if(audioCtx && audioCtx.state==='suspended'){ await audioCtx.resume().catch(()=>{}); } }catch(_){ }
    try{ setMicStatus('ON?'); }catch(_){ }
    await initMic(true); // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ蟷｢・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    if(!analysisTimer) analysisTimer=setInterval(analyzePitch,1000/analysisRate);
    if(!isPlaying) drawChart();
});
if(micDisconnectBtn){ micDisconnectBtn.onclick=()=>{ stopMic(); }; }
showNoteNamesToggle && (showNoteNamesToggle.onchange=()=>{ showNoteNames=showNoteNamesToggle.checked; drawChart(); });
function syncVerticalOffsetSliders(){ try{ if(vOffsetSliderRight) vOffsetSliderRight.value=String(verticalOffset); }catch(_){ } }
// 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髣懶ｽｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ DOM 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謳ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ､郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髫ｨ蜷ｶ・具ｾ守｢托ｽｭ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴取得・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ謨鳴郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣郢晢ｽｻ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ髯ｷ闌ｨ・ｽ・ｱ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// if(melodyPlayToggle){ melodyPlayToggle.onchange=()=>{ ... } }
// if(accompPlayToggle){ accompPlayToggle.onchange=()=>{ ... } }
// BT鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
if(btLatencyToggle){ btLatencyToggle.onchange=()=>{ btLatencyEnabled=btLatencyToggle.checked; if(btLatencySlider) btLatencySlider.disabled = !btLatencyEnabled; }; }
if(btLatencySlider){ btLatencySlider.oninput=()=>{ const ms=parseInt(btLatencySlider.value)||0; btLatencySec=Math.max(0, Math.min(500, ms))/1000; if(btLatencyValue) btLatencyValue.textContent=`${ms} ms`; drawChart(); }; }
if(btLatencyCalibBtn){ btLatencyCalibBtn.onclick=()=>{
    const ok = confirm('鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽn\n鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ\n1) 3鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓幢ｾつ闔会ｽｰ・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ・ｯ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｬ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩墓慣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽn2) 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ・つ髫ｲ・､隲橸ｽｺ?繝ｻ・ｽ繝ｻ・ｽ鬯･・ｴ髴趣ｽｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・屮・ｽ・ｨ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髦ｮ蜊搾ｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ髯ｷ螂・ｽｿ・ｽ?繝ｻ・ｽ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髣厄ｽｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽn3) 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜍溪酪雎仙､懷尢陞滓・讀幃垈螟ｲ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ遶乗刋・ｨ・ｺ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・｢?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯ｷ螂・ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髣厄ｽｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽn4) 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ);
    if(!ok) return;
    runLatencyAssist();
}; }
// 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ驕倥・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
function setMicStatus(text){
    let el=document.getElementById('micStatusBadge');
    if(!el){ el=document.createElement('div'); el.id='micStatusBadge'; el.style.cssText='position:absolute;top:8px;right:8px;padding:4px 8px;font-size:12px;background:#222;border:1px solid #4e8cff;color:#4e8cff;border-radius:4px;z-index:2000;font-family:sans-serif;'; document.body.appendChild(el);} 
    el.textContent='MIC '+text;
    if(text==='ON'){ el.style.background='#143'; el.style.color='#4eff9d'; el.style.borderColor='#4eff9d'; }
}
function updateMicGateVisual(){ if(!micGateLine) return; // gateThreshold dB 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ0..1 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｫ繝ｻ・ｽ?郢晢ｽｻ(-60..0)
  const norm=Math.min(1,Math.max(0,(gateThreshold+60)/60)); micGateLine.style.left=(norm*100)+'%'; }
// Canvas 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function resizeCanvas(){
    if(!chartCanvas) return;
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髮区ｩｸ・ｽ・ｴ繝ｻ・ｽ?隲ｱ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隰ｨ魑ｴﾂ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髴難ｽ｣陋滂ｽｩ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const parent=chartCanvas.parentElement; if(parent){
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ闌ｨ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隴惹ｸ橸ｽｯ・ｰ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽcontent鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ諤懈ｬｾ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const vvw = (window.visualViewport && window.visualViewport.width) ? window.visualViewport.width : (window.innerWidth || document.documentElement.clientWidth || parent.clientWidth || 0);
        // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽadding/border鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬩募∞・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const parentRect = parent.getBoundingClientRect();
        const style = getComputedStyle(parent);
        const padL = parseFloat(style.paddingLeft)||0, padR = parseFloat(style.paddingRight)||0;
        const borL = parseFloat(style.borderLeftWidth)||0, borR = parseFloat(style.borderRightWidth)||0;
        const inner = Math.max(0, Math.floor(parentRect.width - padL - padR - borL - borR));
        // 鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･髫ｨ・ｳ郢晢ｽｻ・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ髯橸ｽｻ繝ｻ・ｽ?隲・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        let leftW = 0, rightW = 0;
        try{
            const rightPanel = document.getElementById('rightVerticalPanel');
            if(rightPanel){ const w = Math.ceil(rightPanel.getBoundingClientRect().width)||0; rightW = w; }
        }catch(_){ /* ignore */ }
    const sideTotal = Math.max(0, /*leftW +*/ rightW);
        const innerAfterSides = Math.max(0, inner - sideTotal);
        const vvwAfterSides = Math.max(0, Math.floor(vvw) - sideTotal);
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｳ髫ｶ蜴・ｽｽ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 0px 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
        let avail = Math.max(120, innerAfterSides, vvwAfterSides);
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬮ｮ・ｷ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽCSS鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ鬯・汚・ｿ・ｽ?繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ證ｦ・ｿ・ｽ?繝ｻ・ｽ髣懊・繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｻ・ｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴取得・ｽ・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
        chartCanvas.width = avail; // flex 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ螟ｧ・｣・ｼ鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        chartCanvas.style.width = avail + 'px';
        chartCanvas.height=parent.clientHeight; // container 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
    } else {
        chartCanvas.width=chartCanvas.clientWidth;
        chartCanvas.height=chartCanvas.clientHeight;
    }
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        const bar = document.getElementById('timelineScrollBar');
        const input = document.getElementById('timelineScroll');
        if(bar){
            const vvw = (window.visualViewport && window.visualViewport.width) ? window.visualViewport.width : (window.innerWidth || document.documentElement.clientWidth || 0);
            const parent = bar.parentElement || document.body;
            const rect = parent.getBoundingClientRect();
            const st = getComputedStyle(parent);
            const pad = (parseFloat(st.paddingLeft)||0) + (parseFloat(st.paddingRight)||0) + (parseFloat(st.borderLeftWidth)||0) + (parseFloat(st.borderRightWidth)||0);
            const innerW = Math.max(0, Math.floor(rect.width - pad));
            const maxW = Math.min(innerW, Math.floor(vvw));
            bar.style.maxWidth = maxW + 'px';
            bar.style.width = '100%';
        }
        if(input){ input.style.maxWidth = '100%'; input.style.width = '100%'; }
    }catch(_){ }
}
// ---- Debug ----
window._appState={startPlayback,pausePlayback,seekTo,seekRelative};
// 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?: 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?繝ｻ・ｽ繝ｻ・ｽ陝ｶ譁溽｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隰ｨ魑ｴﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ雋牙私・ｽ・｣鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?
window._printAudioState=function(){
    try{
        const st = audioCtx? audioCtx.state: 'noctx';
        const gv = melodyGain? melodyGain.gain.value: null;
        const av = accompGain? accompGain.gain.value: null;
    const mgConn = !!masterGain;
    const compConn = !!compressor;
    const limConn = !!limiter;
    console.log('[audio-state]',{state:st, gv, av, isPlaying, playbackPosition, playbackStartPos, scheduledUntil, voices:{synth:activeVoices.length, sample:activeSampleVoices.length}, chain:{master:mgConn, comp:compConn, lim:limConn, direct:_directRouteOn}});
    }catch(e){ console.warn(e); }
};
// AudioContext 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ陷證ｦ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｮ鬮ｷ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let _ctxDiagTimer=null, _ctxDiagLast={t:0, ct:0, pos:0};
window._ctxDiagStart=function(intervalMs=250){
    try{ ensureAudio(); }catch(_){ }
    if(_ctxDiagTimer) return console.warn('ctxDiag already running');
    // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｩ?繝ｻ・ｽ繝ｻ・ｽS鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ闖ｫ・ｶ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｽ・ｫ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳辟・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜿冶・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let ana=_levelAnalyser; let tmpBuf=null;
    if(!ana){
        try{ ana=audioCtx.createAnalyser(); ana.fftSize=1024; ana.smoothingTimeConstant=0.2; (limiter||compressor||masterGain).connect(ana); tmpBuf=new Float32Array(ana.fftSize); }catch(_){ }
    } else {
        tmpBuf=new Float32Array(ana.fftSize);
    }
    _ctxDiagLast={ t: performance.now(), ct: (audioCtx? audioCtx.currentTime: 0), pos: playbackPosition||0 };
    _ctxDiagTimer=setInterval(()=>{
        try{
            const nowP=performance.now();
            const ct= audioCtx? audioCtx.currentTime: 0;
            const pos= playbackPosition||0;
            const dtP=(nowP-_ctxDiagLast.t)/1000;
            const dCtx= ct - _ctxDiagLast.ct;
            const dPos= pos - _ctxDiagLast.pos;
            let db=null;
            if(ana && tmpBuf){ ana.getFloatTimeDomainData(tmpBuf); let s=0; for(let i=0;i<tmpBuf.length;i++){ const v=tmpBuf[i]; s+=v*v; } const rms=Math.sqrt(s/Math.max(1,tmpBuf.length)); db=20*Math.log10(Math.max(1e-7,rms)); }
            console.log('[ctxDiag]',
                `perf+${dtP.toFixed(3)}s`,
                `ctx+${dCtx.toFixed(3)}s`,
                `pos+${dPos.toFixed(3)}s`,
                `ratio=${(dCtx/dtP).toFixed(2)}`,
                (db!=null? `RMS=${db.toFixed(1)}dB`: 'RMS=na'),
                `state=${audioCtx? audioCtx.state: 'noctx'}`
            );
            _ctxDiagLast={ t: nowP, ct: ct, pos: pos };
        }catch(e){ console.warn('ctxDiag err',e); }
    }, Math.max(50, intervalMs|0));
    console.warn('ctxDiag: START');
};
window._ctxDiagStop=function(){ if(_ctxDiagTimer){ clearInterval(_ctxDiagTimer); _ctxDiagTimer=null; console.warn('ctxDiag: STOP'); } };
// 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ雜｣・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ雋ｻ・ｽ・ｺ郢ｧ謇假ｽｽ・ｾ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ context 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?? wake 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
window._kickAudio=function(){ try{ ensureAudio(); const t=audioCtx.currentTime+0.001; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='square'; o.frequency.setValueAtTime(1000,t); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.03,t+0.005); g.gain.exponentialRampToValueAtTime(0.0001,t+0.06); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.07); console.warn('kickAudio fired'); }catch(e){ console.warn('kickAudio failed',e); } };

// Convenience aliases (no underscore) for console usage
window.enableLevelMeter = function(on){ return window._enableLevelMeter(on); };
window.ctxDiagStart = function(interval){ return window._ctxDiagStart(interval); };
window.ctxDiagStop = function(){ return window._ctxDiagStop(); };
window.printAudioState = function(){ return window._printAudioState(); };

// 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ雋牙私・ｽ・｣鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・､?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謇具ｽｴ蜈ｷ・ｽ・ｾ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ魃会ｽｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｶ陞ｳ闌ｨ・ｽ・ｿ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
try{
    document.addEventListener('visibilitychange', async()=>{
        if(document.hidden){
            stopMic();
        } else {
            try{ if(await canInitMicWithoutPrompt()){ await initMic(false).catch(()=>{}); } }catch(_){ }
        }
    });
}catch(_){ }

// Panic: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?udioContext鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｶ鬯ｮ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
window.audioPanic = function(){
    try{ forceStopAllVoices(); }catch(_){ }
    try{ if(schedTimer) clearInterval(schedTimer); schedTimer=null; }catch(_){ }
    try{ if(audioCtx && audioCtx.state==='running'){ /* 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? */ ensureKeepAlive(); } }catch(_){ }
    try{ ensureConvolver(); ensureKeepAlive(); }catch(_){ }
    console.warn('audioPanic executed');
};

// 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ雋牙私・ｽ・｣鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ髣憺屮・ｽ・ｭ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
window.setDirectRoute = function(on){ return window._directRoute(!!on); };

// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ1鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽFZ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽimple鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
window.playSfzNow = function(midi=60, dur=0.5){ try{ ensureAudio(); const when=audioCtx.currentTime+0.03; return simplePlaySfz(midi, when, dur, masterGain||audioCtx.destination); }catch(_){ return false; } };

// 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ destination 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髣比ｼ夲ｽｽ・｣郢晢ｽｻ郢晢ｽｻ隶・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
window.playSfzNowDirect = function(midi=60, dur=0.5){
    try{
        ensureAudio();
        const when=audioCtx.currentTime+0.03;
        return simplePlaySfz(midi, when, dur, audioCtx.destination);
    }catch(_){ return false; }
};

// 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛現窶ｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
window.debugSummary = function(){
    try{
        const map = (instrumentMaps.Piano&&Object.keys(instrumentMaps.Piano).length)? instrumentMaps.Piano : (instrumentMaps.Flute&&Object.keys(instrumentMaps.Flute).length? instrumentMaps.Flute : pianoSampleMap);
        const keys = map? Object.keys(map).length: 0;
        const notes = (currentTracks||[]).reduce((a,t)=> a + ((t?.notes?.length)||0), 0);
        const out = {
            audioState: audioCtx? audioCtx.state: 'noctx',
            SIMPLE_SFZ_MODE,
            tracks: (currentTracks||[]).length,
            notes,
            sampleKeys: keys,
            voices: { synth: activeVoices.length, sample: activeSampleVoices.length },
            scheduledUntil,
            playback: { pos: playbackPosition, startPos: playbackStartPos }
        };
        console.table(out);
        return out;
    }catch(e){ console.warn('debugSummary failed', e); return null; }
};
// 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣鬘秘惧?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陜咎メ・ｭ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
let _directRouteOn=false;
window._directRoute=function(on=true){
    if(!audioCtx||!masterGain) return;
    try{
        if(on){
            if(_directRouteOn) { console.warn('Direct route: already ON'); return; }
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ髦ｮ蜊搾ｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽasterGain 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ destination 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            try{ masterGain.disconnect(); }catch(_){ }
            masterGain.connect(audioCtx.destination);
            _directRouteOn=true;
            console.warn('Direct route: ON (masterGain -> destination ONLY)');
        } else {
            if(!_directRouteOn){ console.warn('Direct route: already OFF'); return; }
            // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕呈汚・ｽ・ｬ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｹ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隶・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髫ｨ蜷ｶ・具ｾ守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            try{ masterGain.disconnect(); }catch(_){ }
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・｢髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽreOutMergeGain 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴寂悪・ｮ遘佩碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            if(preOutMergeGain){
                try{ masterGain.connect(preOutMergeGain); }catch(_){ }
            }else if(compressor){
                try{ masterGain.connect(compressor); }catch(_){ }
            }
            // 鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ鬮｢・ｼ郢ｧ鬘伉・ｳ髫ｲ蟷｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ陷・ｽｾ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｱ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            try{ ensureConvolver(); }catch(_){ }
            _directRouteOn=false;
            console.warn('Direct route: OFF (restored default chain)');
        }
    }catch(e){ console.warn('direct route toggle failed',e); }
};
// 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ髣憺屮・ｽ・ｭ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽMS鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣厄ｽｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｻ髯ｷ謇假ｽｽ・ｰ繝ｻ・ｽ?隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟・ｽｼ諛ｶ・ｽ・ｴ隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
let _levelAnalyser=null, _levelTimer=null, _recentRMS=[];
function _computeRMS(buf){
    let sum=0; for(let i=0;i<buf.length;i++){ const v=buf[i]; sum+=v*v; }
    const rms=Math.sqrt(sum/Math.max(1,buf.length));
    const db = 20*Math.log10(Math.max(1e-7, rms));
    return db;
}
window._enableLevelMeter=function(on=true){
    ensureAudio();
    try{
        if(on){
            if(!_levelAnalyser){
                _levelAnalyser=audioCtx.createAnalyser();
                _levelAnalyser.fftSize=2048; _levelAnalyser.smoothingTimeConstant=0.2;
                // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ鬩帚・・・ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ雋牙私・ｽ・｣鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ髯ｷ螂・ｽｿ・ｽ?繝ｻ・ｽ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ masterGain 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                let connected=false;
                try{ if(limiter){ limiter.connect(_levelAnalyser); connected=true; } }catch(_){ }
                try{ if(!connected && compressor){ compressor.connect(_levelAnalyser); connected=true; } }catch(_){ }
                try{ if(!connected && masterGain){ masterGain.connect(_levelAnalyser); connected=true; } }catch(_){ }
            }
            const buf=new Float32Array(_levelAnalyser.fftSize);
            if(_levelTimer) clearInterval(_levelTimer);
            _levelTimer=setInterval(()=>{
                try{
                    _levelAnalyser.getFloatTimeDomainData(buf);
                    const db=_computeRMS(buf);
                    _recentRMS.push({t:performance.now(), db});
                    if(_recentRMS.length>200) _recentRMS.splice(0,_recentRMS.length-200);
                    // 500ms鬯ｮ・ｮ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・つ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    if(Math.floor(performance.now()/500)!==Math.floor((performance.now()-100)/500)){
                        console.log('[level]', db.toFixed(1),'dB', 'isPlaying=',isPlaying);
                    }
                }catch(e){ /* ignore */ }
            }, 100);
            console.warn('Level meter: ON');
        }else{
            if(_levelTimer){ clearInterval(_levelTimer); _levelTimer=null; }
            // _levelAnalyser 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｫ・ｲ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ郢晢ｽｻ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髦ｮ蜊搾ｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            console.warn('Level meter: OFF');
        }
    }catch(e){ console.warn('level meter failed',e); }
};
window._dumpRecentRMS=function(n=30){
    const arr=_recentRMS.slice(-n).map(x=>({dt:((x.t-(_recentRMS[0]?.t||x.t))/1000).toFixed(2)+'s', db:x.db.toFixed(1)}));
    console.table(arr);
};
// ---- Environment / Debug Helpers ----
function showFileProtocolWarning(){ /* 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ*/ }
window.playTestTone=function(){ ensureAudio(); const t=audioCtx.currentTime; try{ const osc=audioCtx.createOscillator(); const g=audioCtx.createGain(); osc.type='sine'; osc.frequency.setValueAtTime(440,t); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.4,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+1.2); osc.connect(g); g.connect(masterGain||audioCtx.destination); osc.start(t); osc.stop(t+1.25); console.log('Test tone scheduled'); }catch(e){ console.warn('test tone failed',e); } };
window.showSchedStat=function(){ console.log('scheduledCounter',scheduledCounter,'playbackPosition',playbackPosition.toFixed(3)); };
// ================= ZIP Piano Loader (Skeleton) =================
// Store(鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ) 鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬮｣螂・ｽｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽunzip 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ (mini pack 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)
function unzipStoreOnly(u8){
    const files={};
    let p=0; const dv=new DataView(u8.buffer,u8.byteOffset,u8.byteLength);
    function readStr(off,len){ return new TextDecoder().decode(u8.subarray(off,off+len)); }
    while(p+4<=u8.length){
        const sig=dv.getUint32(p,true);
        if(sig===0x04034b50){ // local file header
            if(p+30>u8.length) break;
            const compMethod=dv.getUint16(p+8,true); // 0=store
            const compSize=dv.getUint32(p+18,true);
            const uncompSize=dv.getUint32(p+22,true);
            const nameLen=dv.getUint16(p+26,true);
            const extraLen=dv.getUint16(p+28,true);
            const nameStart=p+30;
            const dataStart=nameStart+nameLen+extraLen;
            if(dataStart+compSize>u8.length){ console.warn('ZIP fallback: data overflow'); break; }
            const name=readStr(nameStart,nameLen);
            if(compMethod!==0){ console.warn('ZIP fallback: 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ method',compMethod,'鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ隴幢ｽｱ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｫ郢晢ｽｻ',name); return null; }
            const data=u8.slice(dataStart,dataStart+compSize); // store 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            files[name]=data;
            p=dataStart+compSize; // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            continue;
        }
        if(sig===0x02014b50 || sig===0x06054b50){ // central directory or end
            break; // local 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        }
        // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ雋ｻ・ｽ・ｺ郢ｧ莨夲ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ -> 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        break;
    }
    return Object.keys(files).length? files:null;
}
async function loadPianoZipFile(f){
    if(!f){ return; }
    setPianoZipStatus('鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ...');
    let ab; try{ ab=await f.arrayBuffer(); }catch(e){ setPianoZipStatus('鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ); console.warn(e); return; }
    // 鬯ｮ・｣隲幄ご陲夜匚謇假ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ fflate
    let files=null; let usedFallback=false;
    const bufU8=new Uint8Array(ab);
    if(fflate && typeof fflate.unzipSync==='function' && !/鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陞滂ｽｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/.test(fflate.unzipSync.toString())){
        try{ files=fflate.unzipSync(bufU8); }
        catch(e){ console.warn('fflate unzip 鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ fallback 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ,e); }
    }
    if(!files){
        files=unzipStoreOnly(bufU8); usedFallback=true;
    }
    if(!files){ setPianoZipStatus('ZIP鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ髫ｰ魃会ｽｿ・ｽ?繝ｻ・ｽ繝ｻ・｣郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ); return; }
    // manifest 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    let manifestEntry=null; for(const k in files){ if(/manifest\.json$/i.test(k)){ manifestEntry=k; break; } }
    if(!manifestEntry){ setPianoZipStatus('manifest.json 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ隴幢ｽｱ?繝ｻ・ｽ繝ｻ・ｽ陝・ｽｾ郢晢ｽｻ); return; }
    try{ const txt=new TextDecoder().decode(files[manifestEntry]); pianoZipManifest=JSON.parse(txt); }catch(e){ setPianoZipStatus('manifest鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣逧ｮ逕･鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ); console.warn(e); return; }
    pianoZipFiles=files; setPianoZipStatus('manifest鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ+(usedFallback?' (fallback unzip)':''));
    prepareInitialSampleQueue();
    startProgressiveDecode();
}
function prepareInitialSampleQueue(){
    if(!pianoZipManifest || !pianoZipManifest.files) return;
    // 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ(manifest.center 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 60) ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ6 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ mf 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ隶捺慣・ｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣厄ｽｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣驕貞､ｧ・ｴ貊・､ｨ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const center=pianoZipManifest.center||60; const mfLayer=(pianoZipManifest.layers||[]).includes('mf')? 'mf': (pianoZipManifest.layers? pianoZipManifest.layers[0]: null);
    const essential=[]; const others=[];
    pianoZipManifest.files.forEach(e=>{
        if(e.release) return; // 鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ髦ｮ蜻ｻ・ｼ譎櫁ｾｨ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(!e.layer) e.layer=mfLayer;
        const dist=Math.abs((e.m??e.midi??e.note)-center);
        if(e.layer===mfLayer && dist<=6) essential.push(e); else others.push(e);
    });
    essential.sort((a,b)=>Math.abs((a.m??a.midi)-center)-Math.abs((b.m??b.midi)-center));
    pianoZipDecodeQueue=[...essential,...others];
}
function startProgressiveDecode(){ if(pianoZipDecoding) return; pianoZipDecoding=true; decodeNextInQueue(); }
function decodeNextInQueue(){
    if(!pianoZipDecodeQueue.length){ pianoZipDecoding=false; setPianoZipStatus('鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ譴ｧ繩･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ); return; }
    if(pianoZipDecodePaused || isPlaying){ return decodeNextLater(); }
    const entry=pianoZipDecodeQueue.shift();
    const file=entry.file; if(!file){ decodeNextLater(); return; }
    const u8=findZipFile(file);
    if(!u8){ decodeNextLater(); return; }
    ensureAudio();
    audioCtx.decodeAudioData(u8.buffer.slice(u8.byteOffset,u8.byteOffset+u8.byteLength),buf=>{
        // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: midi 鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ layer 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｹ陞｢・ｼ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ(鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ pianoSampleBuffers 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽlayer鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const midi=entry.m||entry.midi||entry.note;
        if(typeof midi==='number'){
            if(!pianoSampleMap[midi]) pianoSampleMap[midi]={layers:{},release:null,gains:{}};
            if(entry.release){ pianoSampleMap[midi].release=buf; }
            else {
                const layer=entry.layer||'mf';
        pianoSampleMap[midi].layers[layer]={ buffer:buf, root: midi, loop: entry.loop };
                if(typeof entry.gain==='number') pianoSampleMap[midi].gains[layer]=entry.gain;
                // 鬯ｮ・｣郢晢ｽｻ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ髯ｷ闌ｨ・ｽ・ｱ: 鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ鬪ｰ邇厄ｽ｢螟懷梭?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽpianoSampleBuffers 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                pianoSampleBuffers[midi]=buf;
            }
        }
    if(entry.impulse || (pianoZipManifest && pianoZipManifest.impulse===entry.file)){ pianoIRBuffer=buf; ensureConvolver(); }
    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(typeof midi==='number' && !entry.release){ SAMPLE_USE_STATS[midi]={ lastUse:performance.now(), size:buf.length }; }
        setPianoZipStatus('鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ'+(Object.keys(pianoSampleBuffers).length)+' / ' + pianoZipManifest.files.length);
        decodeNextLater();
    },err=>{ console.warn('decode鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ,file,err); decodeNextLater(); });
}
function decodeNextLater(){ setTimeout(decodeNextInQueue, 30); }
function findZipFile(path){ if(!pianoZipFiles) return null; for(const k in pianoZipFiles){ if(k.endsWith(path)) return pianoZipFiles[k]; } return pianoZipFiles[path]||null; }
// UI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｼ夲ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
if(pianoZipBtn && pianoZipInput){ pianoZipBtn.onclick=()=>pianoZipInput.click(); }
if(pianoZipInput){ pianoZipInput.onchange=e=>{ const f=e.target.files[0]; if(f) loadPianoZipFile(f); }; }
// SFZ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
if(sfzDirBtn && sfzDirInput){ sfzDirBtn.onclick=()=>sfzDirInput.click(); }
if(sfzDirInput){ sfzDirInput.onchange=async e=>{
    const files=[...e.target.files]; if(!files.length){ return; }
    setPianoZipStatus(`SFZ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲帑ｼ夲ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ... (鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ${files.length}鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)`);
    if(files.length<=2){ console.warn('鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊ゑｽｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ魃会ｽｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ);
        if(sfzStatus) sfzStatus.textContent='鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ雋牙私・ｽ・ｨ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髴托ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隶主･・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陷・｢dows鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽChrome/Edge鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶抵ｽｭ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ;
    }
    if(sfzStatus) sfzStatus.textContent='鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ...';
    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ .sfz 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const sfzFiles=files.filter(f=>/\.sfz$/i.test(f.name));
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髴托ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ髯橸ｽｻ繝ｻ・ｽ?隲・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?繝ｻ・ｽ???
    const sampleCandidates=files.filter(f=>/\.(wav|ogg|m4a|mp3)$/i.test(f.name)).length;
    if(window.DEBUG_SAMPLE_NOTE){ console.log('SFZ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｨ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: sfz=', sfzFiles.length, ' samples=', sampleCandidates, ' total=', files.length); }
    if(sfzStatus){ sfzStatus.textContent = `鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ${files.length}鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ / sfz ${sfzFiles.length}鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ / 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ ${sampleCandidates}鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ`; }
    if(sampleCandidates===0){ if(sfzStatus) sfzStatus.textContent += '鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ0鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｪ雜｣・ｽ・ｴ?繝ｻ・ｽ繝ｻ・ｽmples鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｫ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隶主･・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｭ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ; }
    if(!sfzFiles.length){ setPianoZipStatus('sfz鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?'); if(sfzStatus) sfzStatus.textContent='鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽsfz鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ'; return; }
    ensureAudio();
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隲・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ隱ｿ鬮ｴ諛・ｽｱ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽile鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髫ｶﾂ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｫ繝ｻ・ｽ?郢晢ｽｻ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const fileMap={};
    const fileMapLower=new Map();
    const nameIndexLower=new Map(); // basename(lower) -> File鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ､郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮倶ｼ∝ｱｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    files.forEach(f=>{
        const p=f.webkitRelativePath.replace(/\\/g,'/');
        fileMap[p]=f; fileMap[f.name]=f;
        const pl=p.toLowerCase(); fileMapLower.set(pl, f);
        const base=f.name.toLowerCase();
        if(!nameIndexLower.has(base)) nameIndexLower.set(base, f); else {
            const cur=nameIndexLower.get(base);
            if(Array.isArray(cur)) cur.push(f); else nameIndexLower.set(base, [cur, f]);
        }
    });
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const decodeCache=new Map(); // key: relPath -> AudioBuffer
    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔・･雎撰ｽｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const loadedInstruments=[];
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const stats={ ok:0, fail:0, notFound:0, byExt:{} };

    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ SFZ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｨ讖ｸ・ｿ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽregions鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽregion>鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    function parseSfzRegions(sfzText){
        const regions=[]; let cur=null;
        const lines=sfzText.split(/\r?\n/);
        const addRegion=()=>{ if(cur && cur.sample){ regions.push(cur); } cur=null; };
        const globalKVs=Object.create(null);
        let groupKVs=Object.create(null);
        let currentSection='global'; // 'global' | 'group' | 'region' | other
        // sample= 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ+key= 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・｢髫ｲ・､隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢ｧ莨夲ｽｽ・ｫ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ髦ｮ蜻ｻ・ｼ莨・ｽｫ・ｯ雋・ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?髫ｲ・ｷ隰悟･・ｽｿ・ｽ?繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        function extractSampleFromLine(str){
            const m = str.match(/\bsample\s*=\s*/i);
            if(!m) return null;
            const start = str.search(/\bsample\s*=\s*/i) + m[0].length;
            let s = str.slice(start);
            if(!s) return null;
            // 鬯ｮ・ｯ雋・ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?髫ｲ・ｷ隰悟･・ｽｿ・ｽ?繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            if(s[0]==='"' || s[0]==="'"){
                const q=s[0];
                const end=s.indexOf(q,1);
                if(end>0) return s.slice(1,end);
                return s.slice(1).trim();
            }
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?髫ｲ・ｷ隰悟･・ｽｿ・ｽ?繝ｻ・ｽ: 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ+鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢ｧ莨夲ｽｽ・ｫ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const re=/\s+\w+\s*=\s*/g;
            const nxt=re.exec(s);
            const raw = (nxt? s.slice(0, nxt.index): s).trim();
            return raw;
        }
        const parseKVs=(str, target)=>{
            // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ key=value 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ隰悟･・ｽｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            str.replace(/(\w+)=((?:"[^"]*"|'[^']*'|[^\s]+))/g,(_,k,v)=>{ if(v && (v[0]==='"' || v[0]==="'")) v=v.slice(1,-1); target[k]=v; return ''; });
            // sample= 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?髫ｲ・ｷ隰悟･・ｽｿ・ｽ?繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ霑ｺ・ｰ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陋ｹ竏ｵ貍・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const ext = extractSampleFromLine(str);
            if(ext && target){ target.sample = ext; }
        };
        for(let raw of lines){
            let line=raw.replace(/\s*\/\/.*$/,'').trim(); // // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ陜ｮ繧亥合繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            if(!line) continue;
            if(line.startsWith('<')){
                // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ蜿厄ｽｸ蜿ｯﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ
                if(/<region/i.test(line)){
                    addRegion();
                    // region鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ global 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ group 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴擾ｽｴ?繝ｻ・ｽ?鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    cur=Object.assign(Object.create(null), globalKVs, groupKVs);
                    currentSection='region';
                    parseKVs(line, cur);
                } else {
                    // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?繝ｻ・ｽ繝ｻ・ｽ・つ? region鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    addRegion(); cur=null;
                    if(/<group/i.test(line)){
                        currentSection='group'; groupKVs=Object.create(null);
                        parseKVs(line, groupKVs);
                    } else if(/<control/i.test(line)){
                        currentSection='global';
                        parseKVs(line, globalKVs);
                    } else {
                        currentSection='global';
                        parseKVs(line, globalKVs);
                    }
                }
            } else {
                // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｸ蜿ｯﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓幢ｾつ闔会ｽｰ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽample= 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ霑ｺ・ｰ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ貊ゑｽｽ・ｮegion鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ?髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                if(/\bsample\s*=/.test(line)){
                    if(cur && cur.sample){ addRegion(); }
                    if(!cur){
                        // 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜉ｱ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽegion鬯ｮ・ｯ隶灘･・ｽｽ・ｻ髦ｮ蜊搾ｽｧ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ? sample= 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ闌ｨ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ郢晢ｽｻion鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ霑壼生ﾎｨobal+group鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｾ驍ｵ・ｺ鬯俶｢ｧﾎ､繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        cur=Object.assign(Object.create(null), globalKVs, groupKVs);
                        currentSection='region';
                    }
                    parseKVs(line, cur);
                } else if(cur){
                    parseKVs(line, cur);
                } else {
                    // region鬯ｮ・ｯ隶灘･・ｽｽ・ｻ髦ｮ蜊搾ｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陜｣・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    if(currentSection==='group') parseKVs(line, groupKVs);
                    else parseKVs(line, globalKVs);
                }
            }
        }
        addRegion();
        // 鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｫ繝ｻ・ｽ?郢晢ｽｻ
        function noteVal(v){
            if(v==null) return undefined; if(typeof v==='number') return v; const n=parseInt(v); if(!Number.isNaN(n)) return n; const s=String(v).trim(); const m=s.match(/^([A-Ga-g])([#bB]?)(-?\d+)$/); if(!m) return undefined; const step=m[1].toUpperCase(); const base={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[step]; const accCh=m[2]; const acc=accCh==='#'?1:(accCh==='b'||accCh==='B'?-1:0); const oct=parseInt(m[3]); return (oct+1)*12 + base + acc; }
    const out = regions.map(m=>({ sample:m.sample, lokey:(noteVal(m.lokey) ?? noteVal(m.key)), hikey:(noteVal(m.hikey) ?? noteVal(m.key)), lovel:m.lovel?parseInt(m.lovel):0, hivel:m.hivel?parseInt(m.hivel):127, loop_start:m.loop_start?parseInt(m.loop_start):undefined, loop_end:m.loop_end?parseInt(m.loop_end):undefined, trigger:m.trigger||undefined, pitch_keycenter:(noteVal(m.pitch_keycenter) ?? noteVal(m.key)), loop_mode:m.loop_mode||undefined }));
        // default_path 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽregions 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣騾ｧ・ｮ騾包ｽ･?繝ｻ・ｽ繝ｻ・ｽ・つ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        if(globalKVs.default_path){
            let dp = String(globalKVs.default_path).replace(/\\/g,'/');
            if(!/\/$/.test(dp)) dp = dp + '/';
            out._defaultPath = dp;
        }
    if(window.DEBUG_SAMPLE_NOTE){ console.log('SFZ regions parsed:', out.length); }
    return out;
    }

    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ隰ｦ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽFZ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const totalSfz=sfzFiles.length;
    for(let _i=0; _i<sfzFiles.length; _i++){
        const sfzFile=sfzFiles[_i];
        if(sfzStatus) sfzStatus.textContent=`鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ... (${_i+1}/${totalSfz})`;
        const sfzText=await sfzFile.text();
        const basePath=sfzFile.webkitRelativePath.replace(/[^\/]*$/,'').replace(/\\/g,'/').replace(/\/$/,'');
    const regions=parseSfzRegions(sfzText);
    const regionCount = regions.length;
        if(!regions.length) continue;
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謳ｾ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        const map={};
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｴ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣騾ｧ・ｮ騾包ｽ･?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        function normJoinResolve(base, rel){
            // 鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｫ繝ｻ・ｽ?郢晢ｽｻ base/rel 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣逧ｮ逕･髯ｦ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ./ .. 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隰・・・ｽ・ｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const raw=(rel.startsWith('/')? rel.slice(1): (base? base.replace(/\/?$/,'/')+rel: rel))
                .replace(/\\/g,'/').replace(/\/\//g,'/');
            const parts=[]; raw.split('/').forEach(seg=>{
                if(!seg||seg==='.') return; if(seg==='..'){ if(parts.length) parts.pop(); return; } parts.push(seg);
            });
            return parts.join('/');
        }
        function buildCandidates(base, defp, samp){
            const cands=[];
            const dp = defp? String(defp).replace(/\\/g,'/').replace(/^\/+|\/+$/g,'') : '';
            const s = String(samp||'').replace(/\\/g,'/');
            const tryPush=(p)=>{ if(p && !cands.includes(p)) cands.push(p); };
            // 1) base + defp + sample
            tryPush(normJoinResolve(base, (dp? dp+'/' : '') + s));
            // 2) base + sample
            tryPush(normJoinResolve(base, s));
            // 3) base + samples/ + sample鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ魃会ｽｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷会ｽｱ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            tryPush(normJoinResolve(base, 'samples/'+s));
            // 4) defp 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ'samples'鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜍溪酪郢晢ｽｻ鬮ｯ・ｬ繝ｻ・ｽ?・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ鬮｣魃会ｽｿ・ｽ?繝ｻ・ｽ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ? variants
            if(dp && !/^samples\//i.test(dp)){
                tryPush(normJoinResolve(base, 'samples/'+dp+'/'+s));
            }
            return cands;
        }
        function resolveFile(rel){
            // 鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const cand=[];
            const c1=rel; cand.push(c1);
            const c2=rel.replace(/^\.\//,''); if(c2!==c1) cand.push(c2);
            const c3=normJoinResolve('', rel); if(cand.indexOf(c3)<0) cand.push(c3);
            // exact
            for(const c of cand){ if(fileMap[c]) return fileMap[c]; }
            // lower-case
            for(const c of cand){ const f=fileMapLower.get(c.toLowerCase()); if(f) return f; }
            // basename鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ・つ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            const base=rel.split('/').pop().toLowerCase();
            const hit=nameIndexLower.get(base);
            if(hit && !Array.isArray(hit)) return hit;
            return null;
        }
        async function decodeByPath(relOrList){
            const list = Array.isArray(relOrList)? relOrList : [relOrList];
            // 1鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・､鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ陝ｶ譎｢・ｽ・｡郢晢ｽｻ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ雋牙私・ｽ・ｨ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            function buildExtVariants(p){
                const seen=new Set(); const out=[];
                const m=p.match(/^(.*)\.([A-Za-z0-9]+)$/);
                if(m){
                    const base=m[1]; const ext=m[2].toLowerCase();
                    getAltSampleExts().forEach(e=>{ const q=base+'.'+e; if(!seen.has(q)){ seen.add(q); out.push(q); } });
                    if(!seen.has(p)) out.push(p);
                    return out;
                } else {
                    getAltSampleExts().forEach(e=>{ const q=p+'.'+e; if(!seen.has(q)){ seen.add(q); out.push(q); } });
                    if(!seen.has(p)) out.push(p); return out;
                }
            }
            for(const rel of list){
                const variants=buildExtVariants(rel);
                for(const v of variants){
                    const key=v; if(decodeCache.has(key)) return decodeCache.get(key);
                    const f=resolveFile(v);
                    if(!f){ continue; }
                    let ab; try{ ab=await f.arrayBuffer(); }catch(_){ stats.fail++; continue; }
                    const buf=await new Promise(res=> audioCtx.decodeAudioData(ab, b=>res(b), ()=>res(null)));
                    if(buf){ decodeCache.set(key, buf); stats.ok++; const ext=(f.name.split('.').pop()||'').toLowerCase(); stats.byExt[ext]=(stats.byExt[ext]||0)+1; return buf; }
                    else { stats.fail++; continue; }
                }
                if(window.DEBUG_SAMPLE_NOTE){ console.warn('sample not found/decoded for any ext', rel); }
                stats.notFound++;
            }
            return null;
        }
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽIDI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        function inferMidiFromFilename(samplePath){
            try{
                const base = String(samplePath||'').split('/')?.pop()||'';
                const name = base.replace(/\.[A-Za-z0-9]+$/,'');
                // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ1: 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ+ 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(C#4, Db3 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)
                const m1 = name.match(/(^|[^A-Za-z])([A-Ga-g])([#b]{1,2})?(-?\d)($|[^A-Za-z0-9])/);
                if(m1){
                    const step=m1[2].toUpperCase();
                    const baseIdx={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[step];
                    const accStr=m1[3]||''; let acc=0; if(accStr){ if(/##/.test(accStr)) acc=2; else if(/#/.test(accStr)) acc=1; else if(/bb/.test(accStr)) acc=-2; else if(/b/.test(accStr)) acc=-1; }
                    const oct=parseInt(m1[4]);
                    const midi=(oct+1)*12 + baseIdx + acc; if(midi>=0 && midi<=127) return midi;
                }
                // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ2: 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 0..127 鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ60, _60, -60- 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ怜℡?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const m2 = name.match(/(?:^|[^0-9])(1[01][0-9]|12[0-7]|\d?\d)(?:[^0-9]|$)/);
                if(m2){ const n=parseInt(m2[1]||m2[0]); if(n>=0 && n<=127) return n; }
            }catch(_){ }
            return null;
        }
    let swapCount = 0;
    for(const r of regions){
            // default_path 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ+ 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ蜿厄ｽｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隲・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｫ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隰・・・ｽ・ｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const defp = (regions && regions._defaultPath)? String(regions._defaultPath): '';
            const candPaths = buildCandidates(basePath, defp, r.sample);
            const buf=await decodeByPath(candPaths);
            if(!buf) continue;
            // WAV鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隲・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            let meta={ sampleRate:0, loopStart:null, loopEnd:null };
            try{
                // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯懈圜・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ隰・・・ｽ・ｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                const f=resolveFile(candPaths[0]);
                if(f){ const ab=await f.arrayBuffer(); meta=readWavMeta(ab); }
            }catch(_){ }
            // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ: lokey/hikey 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ pitch_keycenter鬯ｩ蛹・ｽｽ・ｶ鬯ｮ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣比ｼ夲ｽｽ・ｰ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            let lo = (r.lokey!=null? r.lokey: undefined);
            let hi = (r.hikey!=null? r.hikey: undefined);
            if(lo==null && hi==null){
                const rootGuess = (r.pitch_keycenter!=null? r.pitch_keycenter: inferMidiFromFilename(r.sample));
                if(rootGuess!=null){ lo=hi=rootGuess; }
            }
            if(lo==null) lo = (hi!=null? hi: 60);
            if(hi==null) hi = lo;
            lo = Math.max(0, Math.min(127, lo));
            hi = Math.max(0, Math.min(127, hi));
            if(hi < lo){ const tmp=lo; lo=hi; hi=tmp; swapCount++; }
            const velLo=r.lovel??0, velHi=r.hivel??127;
            const layer = velHi<=50? 'pp': velLo>=90? 'ff': 'mf';
            const root = (r.pitch_keycenter!=null? r.pitch_keycenter: Math.round((lo+hi)/2));
            for(let m=lo; m<=hi; m++){
                if(!map[m]) map[m]={layers:{},release:null,gains:{}};
                if(r.trigger==='release'){ map[m].release=buf; continue; }
                if(!map[m].layers[layer]){
                    let loopSec;
                    if(r.loop_start!=null && r.loop_end!=null){
                        const sr=(meta.sampleRate||buf.sampleRate);
                        loopSec={ s:r.loop_start/sr, e:r.loop_end/sr };
                    } else if(meta.loopStart!=null && meta.loopEnd!=null){
                        const sr=(meta.sampleRate||buf.sampleRate);
                        loopSec={ s: meta.loopStart/ sr, e: meta.loopEnd/ sr };
                    } else if(r.loop_mode==='loop_continuous'){
                        loopSec={ s: Math.min(0.02, Math.max(0, buf.duration*0.02)), e: Math.max(0.05, buf.duration-0.02) };
                    }
                    map[m].layers[layer]={ buffer:buf, root, loop: undefined, loopSec };
                }
            }
        }
        // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ陞｢・ｽ遶包ｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋願侭ﾂｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const dirName=(basePath.split('/')?.pop()||'').toLowerCase();
        const fileName=sfzFile.name.toLowerCase();
        const isFlute = /flute/.test(dirName) || /flute/.test(fileName);
        const isPiano = /piano/.test(dirName) || /piano/.test(fileName);
    const keyCount=Object.keys(map).length; if(window.DEBUG_SAMPLE_NOTE){ console.log('SFZ built map', {file:sfzFile.name, keys:keyCount}); }
    if(window.DEBUG_SAMPLE_NOTE){
        const byExtStr = Object.entries(stats.byExt).map(([k,v])=>`${k}:${v}`).join(',');
        console.log(`[SFZ] ${sfzFile.name} regions=${regionCount} keys=${keyCount} swaps=${swapCount} ok=${stats.ok} fail=${stats.fail} notFound=${stats.notFound} byExt={${byExtStr}}`);
        console.log('SFZ decode summary', {file:sfzFile.name, ok:stats.ok, fail:stats.fail, notFound:stats.notFound, byExt:stats.byExt});
    }
        if(isFlute){ instrumentMaps.Flute=map; loadedInstruments.push('Flute'); }
        if(isPiano){ instrumentMaps.Piano=map; pianoSampleMap=map; loadedInstruments.push('Piano'); }
        if(!isFlute && !isPiano){
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ Piano鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            instrumentMaps.Piano=map; pianoSampleMap=map; loadedInstruments.push('Piano?');
        }
    }
    useSamplePiano=true; pianoSamplesLoaded=true;
    const label = loadedInstruments.length? loadedInstruments.join(', '): 'Unknown';
    const fmt = SELECTED_SAMPLE_PRIMARY? ' [fmt: '+SELECTED_SAMPLE_PRIMARY+']' : '';
    setPianoZipStatus('SFZ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶夲ｽｨ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ'+label+')'+fmt); if(sfzStatus) sfzStatus.textContent='鬯ｮ・ｮ郢晢ｽｻ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髫ｪ・ｪ('+label+')'+fmt;
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ鍋ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・｢?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ鬮｣螂・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    autoSelectMelodyTrackIfMonophonic(); autoCenterMelodyTrack();
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ隨翫ｋ・ｫ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯ｷ螂・ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    scheduleAll(); if(isPlaying){ pausePlayback(); startPlayback(); }
}; }
// ===============================================================
// ZIP鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ髫ｲ・､陷ｻ・ｵ隰泌・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ (鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ?)
function playFromZipPiano(midi,when,dur,outGain, inst){
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ?: inst='Flute' 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ fluteMap 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ髮区ｩｸ・ｽ・ｴ繝ｻ・ｽ?隲ｱ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陷･譁懃｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ piano
    const map = inst==='Flute'? (instrumentMaps.Flute||pianoSampleMap) : (instrumentMaps.Piano||pianoSampleMap);
    if(map && map!==pianoSampleMap){ /* instrument-specific */ }
    const sampleMap = map || pianoSampleMap;
    if(!sampleMap[midi]){
        // 鬯ｮ・ｯ雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ髢ｧ・ｴ陟墓圜・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ蜴・ｽｽ・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let bestKey=null, bestDist=1e9; const keys=Object.keys(sampleMap);
        for(const k of keys){ const km=parseInt(k); if(!sampleMap[km]) continue; const d=Math.abs(km-(midi)); if(d<bestDist){ bestDist=d; bestKey=km; if(d===0) break; } }
        if(bestKey!=null){ if(window.DEBUG_SAMPLE_NOTE){ console.log('map-miss fallback ->', {req:midi, hit:bestKey, dist:bestDist}); }
            midi=bestKey;
        } else {
            if(window.DEBUG_SAMPLE_NOTE){ console.warn('map-miss no-fallback', {req:midi}); }
            return false;
        }
    }
    const info=sampleMap[midi];
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?"鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣逧ｮ逕･鬩墓・・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        const cutoff = when - (POLY_WINDOW||0.025);
        // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｷ髫ｰ魃会ｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｲ郢ｧ蜈ｷ・ｿ・ｽ?髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｱ郢ｧ蜿･蟒ｺ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let idx=0; while(idx<RECENT_STARTS.length && RECENT_STARTS[idx] < cutoff) idx++;
        if(idx>0) RECENT_STARTS.splice(0, idx);
    }catch(_){ }
    const nearCount = (()=>{
        try{ const w=POLY_WINDOW||0.025; let c=0; for(let i=0;i<RECENT_STARTS.length;i++){ const t=RECENT_STARTS[i]; if(Math.abs(t-when)<=w) c++; } return c; }catch(_){ return 0; }
    })();
    const conc = 1 + nearCount; // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｧ・ｭ・朱ｦｴﾎ碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ霑ｺ・ｰ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ
    const strengthBase = (conc/6) + (dur>1?0.4:0) + (sustainPedal?0.25:0);
    const layers=Object.keys(info.layers);
    if(!layers.length) return false;
    let targetLayer='mf';
    if(layers.length===1) targetLayer=layers[0];
    else {
        if(strengthBase<0.4 && layers.includes('pp')) targetLayer='pp';
        else if(strengthBase>1.1 && layers.includes('ff')) targetLayer='ff';
        else if(layers.includes('mf')) targetLayer='mf';
        else targetLayer=layers[0];
    }
    const layerObj=info.layers[targetLayer]; if(!layerObj) return false;
    const buf=layerObj.buffer||layerObj; if(!buf) return false;
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｧ・ｭ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const root=layerObj.root??midi; const semis=(midi - root); const rate=Math.pow(2, semis/12);
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｬ・ｯ莨夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ?: 鬯ｮ・ｴ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ邵ｺ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ螢ｺ謇ｱ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ +2ms 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽwhen鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const slop = 0.002;
    const startAt = (when - audioCtx.currentTime) < slop ? (audioCtx.currentTime + slop) : when;
    // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬪ｰ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢ｧ莨夲ｽｽ・ｸ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{ cleanupSampleVoices(audioCtx.currentTime); sampleVoiceStealIfNeeded(); }catch(_){ }
    const src=audioCtx.createBufferSource(); src.buffer=buf; try{ src.playbackRate.setValueAtTime(rate, startAt);}catch(_){ src.playbackRate.value=rate; }
    // DC/鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜿冶・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ菫ｶ・｢・ｧ陷托ｽｲ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const hp=audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=20; hp.Q.value=0.707;
    const g=audioCtx.createGain();
    // gain 鬯ｮ・ｮ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｨ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謚ｵ・ｽ・ｫ繝ｻ・ｽ?郢晢ｽｻ(dB鬯ｩ蛹・ｽｽ・ｶ鬯ｮ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)
    const db = info.gains[targetLayer]||0; const baseGain=Math.pow(10, db/20);
    // 鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯･・ｴ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ?: 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯ｷ謳ｾ・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ1/sqrt(N)鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const dynScale = 1/Math.sqrt(Math.max(1, conc));
    const targetAmp = Math.min(0.85, Math.max(0.05, 0.65 * baseGain * dynScale));
    if(g.gain.cancelAndHoldAtTime){ try{ g.gain.cancelAndHoldAtTime(startAt); }catch(_){ } }
    g.gain.setValueAtTime(0.0001,startAt);
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ陷・ｽｾ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const desiredHold = Math.max(0.03, dur); // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｹ證ｦ・ｽ・ｲ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ騾ｹ・｣・つ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髮朱ｯ会ｽｽ・｣鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ30ms鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const fadeInDur = Math.max(0.008, Math.min(0.03, desiredHold*0.4));
    try{ g.gain.linearRampToValueAtTime(targetAmp, startAt+fadeInDur); }catch(_){ g.gain.setValueAtTime(targetAmp, startAt+fadeInDur); }
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ& 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・つ髫ｲ蟷｢・ｽ・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽdur 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let loopable=false; let loopConf=null; let playDur;
    const raw = buf.duration / Math.max(0.0001, rate); // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陜｣・､?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髫ｨ蛛・ｽｿ・ｽ?繝ｻ・ｽ・守｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ陞溷頃・ｾ・ｧ髯ｷ閧ｴ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢髫ｶ譴ｧ繩･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ鬮ｯ諛ｶ・ｽ・ｨ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const manifestFiles = (pianoZipManifest && pianoZipManifest.files)? pianoZipManifest.files: [];
    const meta = manifestFiles.find(e=> (e.m===midi||e.midi===midi||e.note===midi) && e.layer===targetLayer);
    const loopMeta = layerObj.loop || meta?.loop;
    if(layerObj.loopSec && typeof layerObj.loopSec.s==='number' && typeof layerObj.loopSec.e==='number' && layerObj.loopSec.e>layerObj.loopSec.s){
        loopable=true; src.loop=true; src.loopStart=layerObj.loopSec.s; src.loopEnd=layerObj.loopSec.e;
    } else if(loopMeta && typeof loopMeta.s==='number' && typeof loopMeta.e==='number' && loopMeta.e>loopMeta.s+1000){
        loopable=true; loopConf=loopMeta; src.loop=true; src.loopStart=loopConf.s / (pianoZipManifest.sampleRate||48000); src.loopEnd=loopConf.e / (pianoZipManifest.sampleRate||48000);
    }
    // desiredHold 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隴ｽ逧ｮ・ｹ・ｧ隰・∞・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟・ｽｿ・ｶ驍ｯ諞ｺ蝙ｳ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ闍難ｽｾ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隲ｷ蛹・ｽｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｰ・ｨ鬲托ｽｴ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ蟇よｲ夜勳・ｸ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽlute鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陞滂ｽｧ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const isFlute = (inst==='Flute');
    const tc = sustainPedal? (isFlute? 0.60: 0.50) : (isFlute? 0.50: 0.35); // setTargetAtTime 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ(鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const minExtra = sustainPedal? (isFlute? 1.2: 0.9) : (isFlute? 0.7: 0.5); // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謇区ｭ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(loopable){
        playDur = desiredHold; // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽnote鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ迢暦ｽｿ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    } else {
        playDur = Math.min(raw, desiredHold);
    }
    if(!playDur || !isFinite(playDur)) playDur = Math.min(raw, desiredHold);
    if(window.DEBUG_SAMPLE_NOTE){ console.log('zipPlay', {midi,layer:targetLayer,loopable,playDur:playDur.toFixed(3),dur}); }
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ dur 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜍溪酪雎仙私・ｾ謇假ｽｿ・ｽ?繝ｻ・ｽ邵ｺ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const fadeStart = startAt + playDur;
    try{ g.gain.setValueAtTime(targetAmp, fadeStart); g.gain.setTargetAtTime(0.0001, fadeStart, tc); }catch(_){ }
    src.connect(hp); hp.connect(g); g.connect(outGain);
    try { src.start(startAt); } catch(_){ src.start(startAt); }
    // setTargetAtTime 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ髫ｱ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?髫ｶ雜｣・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ0鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・｣・ｰ闔会ｽｰ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ + 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ? 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    let stopAt = fadeStart + Math.max(minExtra, tc*4) + 0.02;
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ闕ｵ證ｦ・ｽ・ｪ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・守｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ?繝ｻ・ｽ繝ｻ・ｽ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ20ms鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ怜℡?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    if(!loopable){ stopAt = Math.min(startAt + raw + 0.02, stopAt); }
    try{ src.stop(stopAt); }catch(_){ }
    activeSampleVoices.push({end: stopAt + 0.2, g, src});
    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴惹ｹ怜℡鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ闌ｨ・ｽ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｽ陋ｾ鬆ｼ隶捺慣・ｽ・ｹ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        RECENT_STARTS.push(startAt);
        if(RECENT_STARTS.length>4096){ RECENT_STARTS.splice(0, RECENT_STARTS.length-2048); }
    }catch(_){ }
    if(SAMPLE_USE_STATS[midi]) SAMPLE_USE_STATS[midi].lastUse=performance.now();
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ (鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽOFF && 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ雋ｻ・ｽ・ｶ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(info.release && !sustainPedal){
        const rsrc=audioCtx.createBufferSource(); rsrc.buffer=info.release; const rg=audioCtx.createGain(); const rt=startAt+dur+0.005; 
        rg.gain.setValueAtTime(0.0001,rt); 
        try{ rg.gain.linearRampToValueAtTime(0.45,rt+0.008);}catch(_){ rg.gain.setValueAtTime(0.45,rt+0.008);} 
        rg.gain.setTargetAtTime(0,rt+0.25,0.25); 
        rsrc.connect(rg); rg.connect(outGain); 
        rsrc.start(rt); 
        const rStop = rt+Math.min(1.2, info.release.duration+0.4);
        rsrc.stop(rStop);
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ陋ｹ・ｺ遶包ｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        activeSampleVoices.push({end: rStop + 0.2, g: rg, rsrc});
    }
    return true;
}

// ================== Simple SFZ Playback (Isolated path) ==================
// 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ郢晢ｽｻ鬮｣蛹・ｽｽ・ｵ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ: 1 BufferSource -> Gain -> (optional) HPF -> out
// 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ vel鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ郢晢ｽｻ髣憺屮・ｽ・ｭ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髦ｮ蜊搾ｽｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ? mf 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｢郢晢ｽｻ陋ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ rate 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ陋滂ｽｬ?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
function simpleSfzMap(){
    // Piano鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ隶捺慣・ｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髴托ｽｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ闕ｵ證ｦ・ｽ・ｪ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽFlute鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ鬮｣諛ｶ・ｽ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ pianoSampleMap
    if(instrumentMaps.Piano && Object.keys(instrumentMaps.Piano).length) return instrumentMaps.Piano;
    if(instrumentMaps.Flute && Object.keys(instrumentMaps.Flute).length) return instrumentMaps.Flute;
    return pianoSampleMap;
}
function simpleFindNearestKey(map, midi){
    if(map[midi]) return midi;
    let best=null,bd=1e9; for(const k of Object.keys(map)){ const m=parseInt(k); if(!map[m]) continue; const d=Math.abs(midi-m); if(d<bd){ bd=d; best=m; if(d===0) break; } }
    return best;
}
function simplePlaySfz(midi, when, dur, out){
    try{
        const map = simpleSfzMap(); if(!map||!audioCtx) return false;
        let key = (map[midi]? midi: simpleFindNearestKey(map, midi)); if(key==null) return false;
        const info = map[key];
        // 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ mf鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ驕ｶ髮｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣騾ｧ・ｮ陋ｻ・､驍ｵ・ｺ陋滂ｽ｡?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ1鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const layers = Object.keys(info.layers||{}); if(!layers.length) return false;
        const layer = layers.includes('mf')? 'mf': layers[0]; const entry = info.layers[layer];
        const buf = entry.buffer||entry; if(!buf) return false;
        const root = entry.root ?? key; const rate = Math.pow(2, (midi-root)/12);
        const startAt = Math.max(audioCtx.currentTime+0.002, when||audioCtx.currentTime+0.002);
        const g = audioCtx.createGain(); g.gain.setValueAtTime(0.0001, startAt); g.gain.linearRampToValueAtTime(0.6, startAt+0.01);
        const src = audioCtx.createBufferSource(); src.buffer=buf; try{ src.playbackRate.setValueAtTime(rate, startAt);}catch(_){ src.playbackRate.value=rate; }
        // 鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ髣憺屮・ｽ・ｭ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const playHold = Math.max(0.05, dur||0.2);
        const stopAt = startAt + Math.min(buf.duration/Math.max(0.001,rate), playHold+0.5);
        g.gain.setValueAtTime(0.6, stopAt);
        g.gain.setTargetAtTime(0.0001, stopAt, 0.25);
        src.connect(g); g.connect(out||masterGain||audioCtx.destination);
        src.start(startAt); src.stop(stopAt+0.05);
        // 鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        activeSampleVoices.push({end: stopAt+0.2, g, src});
        return true;
    }catch(_){ return false; }
}
function scheduleMoreSimple(){
    if(!isPlaying||!audioCtx||!currentTracks.length) return;
    const now=audioCtx.currentTime;
    const gvEl=document.getElementById('guideVolumeSlider');
    const avEl=document.getElementById('accompVolumeSlider');
    const enableMel = gvEl? (parseFloat(gvEl.value)>0.01) : true;
    const enableAcc = avEl? (parseFloat(avEl.value)>0.01) : true;
    const isTrackEnabled=(ti)=>{ const isMel=(ti===melodyTrackIndex); if((isMel && !enableMel) || (!isMel && !enableAcc)) return false; return (currentTracks[ti]?.notes?.length>0); };
    const baseAhead = 0.4; // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陟・§・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    let from = isFinite(scheduledUntil)? scheduledUntil: (playbackPosition||0);
    let target = Math.max(from+baseAhead, (playbackPosition||0)+baseAhead);
    let scheduled=0; const limit=80;
    if(window.DEBUG_SIMPLE){ try{ console.log('[sched-simple] win from',from.toFixed(3),'target',target.toFixed(3),'pos', (playbackPosition||0).toFixed(3)); }catch(_){ } }
    for(let ti=0; ti<currentTracks.length && scheduled<limit; ti++){
        if(!isTrackEnabled(ti)) continue;
        const out = (ti===melodyTrackIndex)? (melodyGain||masterGain||audioCtx.destination): (accompGain||masterGain||audioCtx.destination);
        const notes=currentTracks[ti].notes;
        for(const n of notes){ const st=n.time, en=st+n.duration; if(en<=from) continue; if(st>=target) break; let when = (playbackStartTime||audioCtx.currentTime) + (st - (playbackStartPos||0)); if(btLatencyEnabled) when -= btLatencySec; if(when < now - 0.01) when = now + 0.002; if(simplePlaySfz(n.midi, when, n.duration, out)){ scheduled++; scheduledCounter++; if(window.DEBUG_SIMPLE){ try{ console.log('[sched-simple] note', {ti, midi:n.midi, when:(when-audioCtx.currentTime).toFixed(3)}); }catch(_){ } } } if(scheduled>=limit) break; }
    }
    scheduledUntil = target;
    if(window.DEBUG_SIMPLE){ try{ console.log('[sched-simple] scheduled:',scheduled,'scheduledUntil->',target.toFixed(3)); }catch(_){ } }
    // 鬯ｮ・｣髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｳ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｻ・ｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ0鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ陜灘ｼｱﾎ鍋ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ30鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    if(scheduled===0){
        let nextT=Infinity;
        for(let ti=0; ti<currentTracks.length; ti++){
            if(!isTrackEnabled(ti)) continue;
            const notes=currentTracks[ti].notes;
            for(const n of notes){ const st=n.time; if(st>from+1e-6){ if(st<nextT) nextT=st; break; } }
        }
        if(isFinite(nextT)){
            const jumpTo = Math.min(nextT, from + 30);
            scheduledUntil = jumpTo;
            if(window.DEBUG_SIMPLE){ try{ console.log('[sched-simple] rest-jump from', from.toFixed(3),'->', jumpTo.toFixed(3)); }catch(_){ } }
        }
    }
}
// LRU 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ? (鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ螳育櫨隲｢蟷・・雋・ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蜍溪酪隰・ｽｱ?繝ｻ・ｽ?陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ& 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幄ご陲也ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ隴幢ｽｱ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ)
function maybeRunLru(){ const now=performance.now(); if(now-lastLruCheck < LRU_CHECK_INTERVAL) return; lastLruCheck=now; const keys=Object.keys(pianoSampleMap); if(keys.length < MAX_DECODED_SAMPLES_SOFT) return; const arr=[]; keys.forEach(k=>{ const midi=parseInt(k); const stat=SAMPLE_USE_STATS[midi]; if(!stat) return; const dist=Math.abs(midi- (pianoZipManifest?.center||60)); arr.push({midi,last:stat.lastUse,dist}); }); arr.sort((a,b)=> (a.last-b.last)|| (b.dist-a.dist)); // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ& 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ鬮ｷ菫ｶ蜊・坿・､?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const removeCount=Math.min(10, Math.max(0, keys.length-MAX_DECODED_SAMPLES_SOFT)); for(let i=0;i<removeCount;i++){ const target=arr[i]; const info=pianoSampleMap[target.midi]; if(!info) continue; // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        Object.values(info.layers).forEach(buf=>{ /* GC鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ*/ }); if(info.release){ /* ignore */ }
        delete pianoSampleMap[target.midi]; delete pianoSampleBuffers[target.midi]; delete SAMPLE_USE_STATS[target.midi]; }
}

// ===== Responsive layout helpers: 鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?隶・ｶ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜款?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ=====
let __resizeTimer = null;
function adjustForFixedBar(){
    try{
        const bar = document.getElementById('mic-permission-bar');
        const top = document.getElementById('top-bar');
        if(!bar || !top) return;
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯敖・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陋ｹ竏晉横鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・｣・ｰ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        // 鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｵ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ隰撰ｽｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蝣ｺ・ｸ讖ｸ・ｽ・ｸ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
        bar.style.display = 'inline-flex';
        bar.style.flexWrap = 'wrap';
    }catch(_){ /* no-op */ }
}
function clampToViewport(){
    try{
        const ids = ['top-bar','transportBar','markers','controls','timelineScrollBar','chartContainer'];
        for(const id of ids){
            const el = document.getElementById(id);
            if(!el) continue;
            el.style.width = '100%';
            el.style.maxWidth = '100%';
            el.style.overflowX = 'clip';
        }
        // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ陷ｿ蜀ｶ・ｾ・ｨ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ遶擾ｽｵ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const labels = ['melodyAudioLabel','accompAudioLabel'];
        for(const id of labels){
            const el = document.getElementById(id);
            if(!el) continue;
            el.style.whiteSpace = 'normal';
            el.style.overflow = 'hidden';
            el.style.textOverflow = 'clip';
            el.style.maxWidth = '100%';
        }
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        try{ document.documentElement.style.overflowX = 'hidden'; document.body.style.overflowX = 'hidden'; }catch(_){ }

        // 鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蛟ｶ・ｼ竏晢ｽｱ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ闌ｨ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｧ・ｭ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛現窶ｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ鬮｣諛ｶ・ｽ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
        const vw = Math.max(0, window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth || 0);
        const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
        while(walker.nextNode()){
            const el = walker.currentNode;
            if(!(el instanceof HTMLElement)) continue;
            // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴取得・ｽ・ｱ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩墓得・ｽ・ｩ髯懈懶ｽｮ闌ｨ・ｽ・ｫ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            const sw = el.scrollWidth;
            const cw = el.clientWidth;
            if(sw > cw || sw > vw){
                // 鬯ｮ・｣隲嶄ｴ・ｧ髯ｷ螟ｲ・ｽ・ｱ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ canvas 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ髯滓得・ｽ・ｩ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽwidth:100% 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ隶捺慣・ｿ・ｽ?繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                if(el.tagName.toLowerCase() === 'canvas'){
                    el.style.maxWidth = '100%';
                    el.style.width = '100%';
                } else {
                    el.style.maxWidth = '100%';
                    // 鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ・つ?繝ｻ・ｽ繝ｻ・ｽ??
                    if(el.style.width && !el.style.width.includes('%')){
                        el.style.width = '100%';
                    }
                }
                el.style.overflowX = 'hidden';
            }
        }
    }catch(_){ /* no-op */ }
}
function adjustResponsiveLayout(){
    adjustForFixedBar();
    clampToViewport();
    fitMainAreaHeight();
}

// 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ雋牙､懶ｽｦ・ｴ・守｢托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯区ｻゑｽｽ・･?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驍・ｽｲ隲ｷ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊捺ｱ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
// 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?繝ｻ・ｽ?郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・＠?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ蛟ｩ・ｲ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ(#chartContainer)鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ遶乗刋・ｨ・ｺ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ螂・ｽｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ/鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ・ゑｽｧ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
function fitMainAreaHeight(){
    // CSS鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・･郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・＠?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ繝ｻ・ｽ?郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｧ?繝ｻ・ｽ繝ｻ・ｽ?髯ｷ謳ｾ・ｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ陷ｻ闌ｨ・ｽ・ｨ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｴ謫ｾ・ｽ・ｶ鬮ｯ讖ｸ・ｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・｣・ｰ闔会ｽｰ・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯敖・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ謐ｺ諷｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
}

window.addEventListener('load',()=>{
    warnIfInsecureContext();
    resizeCanvas();
    updateMicGateVisual();
    autoCenterMelodyTrack();
    updateTimelineScrollRange();
    drawChart(); /* file:// 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ*/
    autoLoadSfzInstruments();
    // 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隲・ｹ?繝ｻ・ｽ繝ｻ・ｽ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陷托ｽｰ邵ｺ雋ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ・ｵ・ｶ髫伜､懶ｽｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    adjustResponsiveLayout();
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｺ蛛・ｽｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｪ・ｰ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｵ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｷ陝ｷ・ｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽpx鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    setTimeout(()=>{ try{ resizeCanvas(); updateTimelineScrollRange(); drawChart(); }catch(_){ } }, 0);
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ驛｢・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ granted 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｵ髫ｰ・ｨ鬲托ｽｴ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    (async()=>{
        try{
            const state = await getMicPermissionState();
            if(state==='granted' && !micAnalyser){ await initMic(false).catch(()=>{}); }
            // granted 鬯ｮ・｣雎郁ｲｻ・ｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ髦ｮ蜊搾ｽｧ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ隰ｦ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        }catch(_){ /* 鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ*/ }
    })();
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陷･譁懃｢托ｽｭ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・ｨ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ髯ｳﾂ髯橸ｽｳ陞｢・ｽ・つ陷ｻ・ｵ?繝ｻ・ｽ繝ｻ・ｽ陞ｳ闌ｨ・ｽ・ｿ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        if(navigator.mediaDevices && navigator.mediaDevices.addEventListener){
            navigator.mediaDevices.addEventListener('devicechange', async()=>{
                try{ if(await canInitMicWithoutPrompt()){ await initMic(false).catch(()=>{}); } }catch(_){ }
            });
        }
    }catch(_){ }
    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ郢晢ｽｻ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｿ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ荵怜・?繝ｻ・ｽ繝ｻ・ｽ郢ｧ荵晢ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        const btn=document.getElementById('clearDotsButton');
        if(btn){ btn.onclick=()=>{ pitchHistory.length=0; drawChart(); }; }
    }catch(_){ }
    // 鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲ｷ諷墓ｫｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・ｽｶ諞ｺ・・ｫｭ・ｩ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        if(practiceModeOn && practiceModeOff){
    practiceModeOn.onclick=()=>{
            activateAudioOnce();
            // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛育袖?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ蟷｢・ｿ・ｽ?繝ｻ・ｽ・堕鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            try{ if(editToolbar){ editToolbar.classList.add('hidden'); editToolbar.style.display='none'; } }catch(_){ }
                    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ萓・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ魃会ｽｽ・ｺ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｼ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ
                    const hasAudio = !!(window.melodyOrigBytes||window.accompOrigBytes||melodyBuffer||accompBuffer);
                    const hasDots = !!(pitchHistory && pitchHistory.length>0);
                    if(hasAudio || hasDots){
                        const ok = confirm('鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲ｷ諷墓ｫｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｧ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貊灘擠?繝ｻ・ｽ繝ｻ・ｽ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・ｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮｣螂・ｽｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｳ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｯ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯ｷﾂ隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陷ｿ髢・ｾ證ｦ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驍ｵ・ｺ鬯俶｢ｧ・｣遒第｡咏ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ);
                        if(ok){ try{ saveSessionZip(); }catch(_){ } }
                    }
                    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諛・ｽｶ諞ｺ・・ｫｭ・ｩ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ陷肴ｻゑｽｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    if(practiceToolbar){
                        const frg=document.createDocumentFragment();
            if(practicePatternSelect){ practicePatternSelect.style.display=''; frg.appendChild(practicePatternSelect); }
            if(practiceRangeWrap){ practiceRangeWrap.style.display='inline-flex'; frg.appendChild(practiceRangeWrap); }
            if(practiceStartBtn){ practiceStartBtn.style.display=''; frg.appendChild(practiceStartBtn); }
            if(practicePauseBtn){ practicePauseBtn.style.display=''; frg.appendChild(practicePauseBtn); }
            if(practiceStopBtn){ practiceStopBtn.style.display=''; frg.appendChild(practiceStopBtn); }
            if(practiceVolWrap){ practiceVolWrap.style.display='inline-flex'; frg.appendChild(practiceVolWrap); }
                        practiceToolbar.appendChild(frg);
                        practiceToolbar.classList.remove('hidden');
                        practiceToolbar.style.display='flex';
                        if(practiceCloseBtn){ practiceCloseBtn.style.display='none'; }
                        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ鬲・ｽｵ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｱ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ､郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・ｻ髫ｶ魃会ｽｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣逍ｲ・ｩ・ｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣鬲・ｼ夲ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                        if(practiceCloseBtn){
                            practiceCloseBtn.onclick = ()=>{
                                // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ鍋ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ陷ｻ・ｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・趣ｽ､?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                                if(practiceModeOff && typeof practiceModeOff.onclick==='function'){
                                    practiceModeOff.onclick();
                                } else {
                                    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髫ｨ・ｬ?繝ｻ・ｽ繝ｻ・ｽ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ隴ｯ繝ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                                    if(isPracticing) stopBasicPractice(true);
                                    if(practiceToolbar){ practiceToolbar.classList.add('hidden'); practiceToolbar.style.display='none'; }
                                    if(practiceTopGroup){
                                        if(practicePatternSelect){ practicePatternSelect.style.display='none'; practiceTopGroup.appendChild(practicePatternSelect); }
                                        if(practiceRangeWrap){ practiceRangeWrap.style.display='none'; practiceTopGroup.appendChild(practiceRangeWrap); }
                                        if(practiceStartBtn){ practiceStartBtn.style.display='none'; practiceTopGroup.appendChild(practiceStartBtn); }
                                        if(practicePauseBtn){ practicePauseBtn.style.display='none'; practiceTopGroup.appendChild(practicePauseBtn); }
                                        if(practiceStopBtn){ practiceStopBtn.style.display='none'; practiceTopGroup.appendChild(practiceStopBtn); }
                                        if(practiceVolWrap){ practiceVolWrap.style.display='none'; practiceTopGroup.appendChild(practiceVolWrap); }
                                    }
                                    practiceMode='off';
                                    try{
                                        if(melodyAudioBtn){ melodyAudioBtn.disabled = false; melodyAudioBtn.title = '鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ; }
                                        if(accompAudioBtn){ accompAudioBtn.disabled = false; accompAudioBtn.title = '鬯ｮ・｣髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶抵ｽｭ?繝ｻ・ｽ?髮守ｵｶ謠｡?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ; }
                                    }catch(_){ }
                                }
                            };
                        }
                    }
                    practiceModeOff && (practiceModeOff.style.display='');
                    practiceModeOn && (practiceModeOn.style.display='none');
                    practiceMode='basic';
                    // 鬯ｮ・ｯ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ隴会ｽｮ・守｢托ｽｭ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴擾ｽｴ?繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｴ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    updateGlobalOctButtonsTooltip();
                    // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髮狗ｿｫ・・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢郢晢ｽｻ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｺ假ｽ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    try{
                        if(melodyAudioBtn){ melodyAudioBtn.disabled = true; melodyAudioBtn.title = '鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ'; }
                        if(accompAudioBtn){ accompAudioBtn.disabled = true; accompAudioBtn.title = '鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ'; }
                    }catch(_){ }
                    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｾ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蟇よ升繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ闕ｳ・ｻ・つ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｴ謇假ｽｽ・ｹ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                    try{ if(isPlaying) pausePlayback(); }catch(_){ }
                    midiGhostNotes=null; drawChart();
            };
            practiceModeOff.onclick=()=>{
                activateAudioOnce();
                if(isPracticing) stopBasicPractice(true);
                // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ諠ｹ・ｹ證ｦ・ｿ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｵ證ｦ・ｿ・ｽ?繝ｻ・ｽ鬮｢・ｰ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                if(practiceToolbar){ practiceToolbar.classList.add('hidden'); practiceToolbar.style.display='none'; }
                if(practiceTopGroup){
                    if(practicePatternSelect){ practicePatternSelect.style.display='none'; practiceTopGroup.appendChild(practicePatternSelect); }
                    if(practiceRangeWrap){ practiceRangeWrap.style.display='none'; practiceTopGroup.appendChild(practiceRangeWrap); }
                    if(practiceStartBtn){ practiceStartBtn.style.display='none'; practiceTopGroup.appendChild(practiceStartBtn); }
                    if(practicePauseBtn){ practicePauseBtn.style.display='none'; practiceTopGroup.appendChild(practicePauseBtn); }
                    if(practiceStopBtn){ practiceStopBtn.style.display='none'; practiceTopGroup.appendChild(practiceStopBtn); }
                    if(practiceVolWrap){ practiceVolWrap.style.display='none'; practiceTopGroup.appendChild(practiceVolWrap); }
                }else{
                    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷供・ｮ・｣髴趣ｽｧ髯ｷ閧ｴ・ｺ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｷ讌ｪﾂ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髫ｨ・ｬ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｶ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                    practicePatternSelect && (practicePatternSelect.style.display='none');
                    practiceRangeWrap && (practiceRangeWrap.style.display='none');
                    practiceStartBtn && (practiceStartBtn.style.display='none');
                    practicePauseBtn && (practicePauseBtn.style.display='none');
                    practiceStopBtn && (practiceStopBtn.style.display='none');
                    practiceVolWrap && (practiceVolWrap.style.display='none');
                }
                practiceModeOff && (practiceModeOff.style.display='none');
                practiceModeOn && (practiceModeOn.style.display='');
                if(practiceCloseBtn){ practiceCloseBtn.style.display='none'; }
                practiceMode='off';
                // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｫ豬ｹ陞溽浹雋ｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜿･・ｹ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩包ｽｶ闕ｳ讖ｸ・ｽ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ陞滓・遒托ｽｭ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｶ?髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ隴会ｽｮ・守｢托ｽｭ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｧ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                practiceCallDisplayOctShift = 0;
                updateGlobalOctButtonsTooltip();
                // 鬯ｮ・ｴ陷ｿ蜴・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髣費ｽｨ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                try{
                    if(melodyAudioBtn){ melodyAudioBtn.disabled = false; melodyAudioBtn.title = '鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ; }
                    if(accompAudioBtn){ accompAudioBtn.disabled = false; accompAudioBtn.title = '鬯ｮ・｣髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶抵ｽｭ?繝ｻ・ｽ?髮守ｵｶ謠｡?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ; }
                }catch(_){ }
            };
        }
    if(practiceStartBtn){ practiceStartBtn.onclick=()=>{ activateAudioOnce(); if(practiceMode==='basic'){ if(practicePaused){ resumeBasicPractice(); } else { startBasicPractice(); } } } }
    if(practicePauseBtn){ practicePauseBtn.onclick=()=>{ activateAudioOnce(); if(isPracticing){ pauseBasicPractice(); } } }
    if(practiceStopBtn){
        let _prStopClick=0, _prStopTimer=null;
        practiceStopBtn.onclick=()=>{
            activateAudioOnce();
            _prStopClick++;
            if(_prStopClick===1){
                // 1鬯ｮ・ｯ繝ｻ・ｽ?髴・ｽｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蛹ｺ・ｩ・ｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷ｿ・･?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驛｢・ｩ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
                if(isPracticing) stopBasicPractice(true);
                // 2鬯ｮ・ｯ繝ｻ・ｽ?髴・ｽｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蛹ｺ・ｩ・ｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ驍・私・ｿ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ驕ｨ繧托ｽｽ・ｼ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ陷ｿ髢譌ｭ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                try{ practiceStopBtn.title = '鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ鍋ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ; }catch(_){ }
                _prStopTimer = setTimeout(()=>{ _prStopClick=0; try{ practiceStopBtn.title=''; }catch(_){ } }, 900);
            } else if(_prStopClick>=2){
                if(_prStopTimer){ clearTimeout(_prStopTimer); _prStopTimer=null; }
                _prStopClick=0;
                // 鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ陜灘ｼｱﾎ鍋ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                try{
                    if(practiceModeOff && typeof practiceModeOff.onclick==='function'){
                        practiceModeOff.onclick();
                    } else {
                        if(isPracticing) stopBasicPractice(true);
                        if(practiceToolbar){ practiceToolbar.classList.add('hidden'); practiceToolbar.style.display='none'; }
                        if(practiceTopGroup){
                            if(practicePatternSelect){ practicePatternSelect.style.display='none'; practiceTopGroup.appendChild(practicePatternSelect); }
                            if(practiceRangeWrap){ practiceRangeWrap.style.display='none'; practiceTopGroup.appendChild(practiceRangeWrap); }
                            if(practiceStartBtn){ practiceStartBtn.style.display='none'; practiceTopGroup.appendChild(practiceStartBtn); }
                            if(practicePauseBtn){ practicePauseBtn.style.display='none'; practiceTopGroup.appendChild(practicePauseBtn); }
                            if(practiceStopBtn){ practiceStopBtn.style.display='none'; practiceTopGroup.appendChild(practiceStopBtn); }
                            if(practiceVolWrap){ practiceVolWrap.style.display='none'; practiceTopGroup.appendChild(practiceVolWrap); }
                        }
                        practiceMode='off';
                        try{
                            if(melodyAudioBtn){ melodyAudioBtn.disabled = false; melodyAudioBtn.title = '鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ; }
                            if(accompAudioBtn){ accompAudioBtn.disabled = false; accompAudioBtn.title = '鬯ｮ・｣髮具ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶抵ｽｭ?繝ｻ・ｽ?髮守ｵｶ謠｡?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ謫ｾ・ｽ・ｶ?鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ; }
                        }catch(_){ }
                    }
                }catch(_){ }
            }
        };
    }
        if(practiceCallVolEl){ practiceCallVolEl.oninput=()=>{ try{ ensureAudio(); if(practiceCallGain){ const v=Math.max(0, Math.min(1, parseFloat(practiceCallVolEl.value)||0.85)); practiceCallGain.gain.setValueAtTime(v, audioCtx.currentTime); } }catch(_){ } }; }
    }catch(_){ }

    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｽ・ｨ隰夲ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿厄ｽｧ・ｭ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    window.addEventListener('resize',()=>{
        if(__resizeTimer) clearTimeout(__resizeTimer);
        __resizeTimer = setTimeout(()=>{
            adjustResponsiveLayout();
            resizeCanvas();
            updateTimelineScrollRange();
            drawChart();
            // 鬯ｮ・ｯ雋翫ｑ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ髫ｲ・､陷ｻ・ｵ雎募ｹ・ｱ・繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷供・ｨ・ｯ鬲假ｽｬ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬯ｮ・ｯ隰疲ｻゑｽｽ・､鬮ｱ髯ｳﾂ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｷ關灘ｹ｢・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷供ﾂ莉ｰﾂ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳・ｷ讌ｪﾂ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ??郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
            fitMainAreaHeight();
        }, 60);
    });
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｬ隲帛現窶ｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｺ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蛹・ｽｽ・･鬮ｯ諛茨ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蠅灘ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・ｽ・ｨ髯樊ｻゑｽｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯槭ｑ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋・ｽｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    try{
                // 鬯ｯ・ｩ隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ隲､諞ｺ螳・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｫ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷桁・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｶ髫ｴ諠ｹ・ｹ證ｦ・ｿ・ｽ??鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
                try{ if(practiceToolbar && practiceMode!=='basic'){ practiceToolbar.classList.add('hidden'); practiceToolbar.style.display='none'; } }catch(_){ }
        const parent = document.getElementById('chartContainer')?.parentElement || document.getElementById('chartContainer');
        if(parent && 'ResizeObserver' in window){
            const ro = new ResizeObserver(()=>{
                if(__resizeTimer) clearTimeout(__resizeTimer);
                __resizeTimer = setTimeout(()=>{ resizeCanvas(); updateTimelineScrollRange(); drawChart(); }, 32);
            });
            ro.observe(parent);
        }
    }catch(_){ }
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ?鬮ｯ・ｷ・つ髫ｲ・､隲幄肩・ｿ・ｽ?繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ諠ｹ・ｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ郢晢ｽｻ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    try{
        if(micRenderModeSel){
            // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陞ｳ莠･謫郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ魃会ｽｽ・ｦI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ荵晢ｽ・繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
            try{ micRenderModeSel.value = 'graph'; }catch(_){ }
            micRenderModeSel.addEventListener('change', ()=>{
                const v = micRenderModeSel.value;
                micRenderMode = (v==='dot'||v==='graph')? v : 'line';
                try{ drawChart(); }catch(_){ }
            });
        }
    }catch(_){ }
});
// 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽBT鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ繝ｻ・ｽ?髢ｧ・ｩ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽUI鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯樊ｻゑｽｿ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽudioContext鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｦ・ｮ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯滓汚・ｽ・ｱ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
(()=>{ 
    const ms=Math.round(estimateOutputLatency()*1000); btLatencySec=ms/1000;
    if(btLatencySlider){ btLatencySlider.value=String(ms); btLatencySlider.disabled = !btLatencyEnabled; }
    if(btLatencyValue){ btLatencyValue.textContent=`${ms} ms`; }
    if(btLatencyToggle){ btLatencyToggle.checked = btLatencyEnabled; }
})();
// 鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ郢晢ｽｻ鬮ｫ・ｰ郢晢ｽｻ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ鬮｣魃会ｽｽ・ｨ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｯ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ?
if(resonanceMixSlider){ resonanceMixSlider.value=String(resonanceMix); }

// ---- Auto-load SFZ instruments from ./sfz/Piano and ./sfz/Flute ----
async function autoLoadSfzInstruments(){
    // file:// 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲幢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｲ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ蠅難ｽｺ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ諤憺●?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ・つ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｴ陜捺ｺｷ郢ｭ?鬯ｩ・｢隰ｳ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(location.protocol==='file:') return;
    try{
        await loadSfzFromFolder('sfz/Piano', 'Piano');
    }catch(e){ console.warn('Piano SFZ load failed',e); }
    try{
        await loadSfzFromFolder('sfz/Flute', 'Flute');
    }catch(e){ console.warn('Flute SFZ load failed',e); }
}

async function loadSfzFromFolder(baseUrl, instName){
    ensureAudio();
    // 1) 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ .sfz 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ闕ｵ譎｢・ｽ謇假ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: index.sfz or 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ騾搾ｽｲ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ・つ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｰ・ｨ鬲托ｽｴ・つ.sfz 鬯ｩ蛹・ｽｽ・ｶ鬩怜遜・ｽ・ｫ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ.sfz鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯溷供・ｮ・｣・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ髣鯉ｽｨ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯懆ｬ趣ｽｸ・ｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ陷ｿ謔ｶ貂夂ｹ晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻ・碑ｭ趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽHTTP鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・｣・ｰ闔会ｽｰ・つ鬩包ｽｶ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｰ?繝ｻ・ｽ繝ｻ・ｽ?: baseUrl/manifest.txt 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ .sfz 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ WAV鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣豈費ｽｼ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?陋ｹ竏ｵ貍・郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ隰ｫ・ｾ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｶ蜻ｵ・ｶ・｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ邵ｺ・､・つ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    // 鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｦ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ謇假ｽｽ・ｰ髣憺屮・ｽ・ｭ鬩包ｽｶ鬯・汚・ｽ・･?繝ｻ・ｽ繝ｻ・ｽ鬮｢・ｼ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞滂ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ諛ｶ・ｽ・｣郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闕ｳ讖ｸ・ｽ・､?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髴托ｽ｢隴会ｽｦ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const candidates=['index.sfz', instName+'.sfz', 'default.sfz'];
    let sfzText=null, sfzPath=null;
    for(const name of candidates){ try{ const r=await fetch(`${baseUrl}/${name}`); if(r.ok){ sfzText=await r.text(); sfzPath=`${baseUrl}/${name}`; break; } }catch(_){}}
    if(!sfzText){
        // 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?鬮ｱ謚ｵ・ｽ・ｰ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ: 鬯ｮ・ｯ隲帑ｺ･諠ｧ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｪ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ螂・ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶灘･・ｽｽ・ｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｾ髯懶ｽｮ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ蜈ｷ・ｽ・ｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ鬩穂ｼ夲ｽｽ・ｼ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶捺ｻゑｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ陞｢・ｼ?繝ｻ・ｽ繝ｻ・ｽ隴会ｽｮ?繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ繝ｻ・ｿ・ｽ?繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        throw new Error('sfz not found in '+baseUrl);
    }
    // 鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ莨夲ｽｽ・ｦ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬮ｯ蛹ｺ・ｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ SFZ 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯懈瑳辟・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜿冶・?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ陋ｹ・ｺ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const basePath=baseUrl; // 鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｲ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隲橸ｽｺ陞ｻ・ｮ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｮ郢晢ｽｻ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    const regions=[];
    function parseNoteNameOrNumber(v){
        if(v==null) return undefined; if(typeof v==='number') return v; const n=parseInt(v); if(!Number.isNaN(n)) return n; const s=String(v).trim(); const m=s.match(/^([A-Ga-g])([#bB]?)(-?\d+)$/); if(!m) return undefined; const step=m[1].toUpperCase(); const base={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[step]; const accCh=m[2]; const acc=accCh==='#'?1:(accCh==='b'||accCh==='B'?-1:0); const oct=parseInt(m[3]); return (oct+1)*12 + base + acc; }
    for(const lineRaw of sfzText.split(/\r?\n/)){
        const line=lineRaw.replace(/\s*\/\/.*$/,'').trim();
        if(!/\bregion\b/.test(line)) continue; const m=Object.create(null);
        line.replace(/(\w+)=((?:"[^"]*"|'[^']*'|[^\s]+))/g,(_,k,v)=>{ if(v && (v[0]==='"' || v[0]==="'")) v=v.slice(1,-1); m[k]=v; return ''; }); if(!m.sample) continue;
        regions.push({ sample:m.sample, lokey:(parseNoteNameOrNumber(m.lokey) ?? parseNoteNameOrNumber(m.key)), hikey:(parseNoteNameOrNumber(m.hikey) ?? parseNoteNameOrNumber(m.key)), lovel:m.lovel?parseInt(m.lovel):0, hivel:m.hivel?parseInt(m.hivel):127, loop_start:m.loop_start?parseInt(m.loop_start):undefined, loop_end:m.loop_end?parseInt(m.loop_end):undefined, trigger:m.trigger||undefined, pitch_keycenter:(parseNoteNameOrNumber(m.pitch_keycenter) ?? parseNoteNameOrNumber(m.key)), loop_mode: m.loop_mode||undefined });
    }
    if(!regions.length) throw new Error('no regions in '+sfzPath);
    // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ諠ｹ・ｸ讖ｸ・ｽ・ｹ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ陷ｿ蜴・ｽｿ・ｽ?繝ｻ・ｽ髫ｲ・｢?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ・つ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ& 鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髫ｲ・ｷ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const map={};
    // 鬯ｯ・ｩ郢晢ｽｻ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髣包ｽｳ郢晢ｽｻ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ 鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｴ竏ｵ閻ｸ?繝ｻ・ｽ繝ｻ・ｽ隲橸ｽｺ・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ郢ｧ謇假ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蛹・ｽｽ・ｯ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽIDI鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｿ・ｽ?繝ｻ・ｽ・つ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讓奇ｽｻ繧托ｽｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽallback鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    function inferMidiFromFilenameSimple(samplePath){
        try{
            const base = String(samplePath||'').split('/')?.pop()||'';
            const name = base.replace(/\.[A-Za-z0-9]+$/,'');
            const m1 = name.match(/(^|[^A-Za-z])([A-Ga-g])([#b]{1,2})?(-?\d)($|[^A-Za-z0-9])/);
            if(m1){
                const step=m1[2].toUpperCase();
                const baseIdx={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[step];
                const accStr=m1[3]||''; let acc=0; if(accStr){ if(/##/.test(accStr)) acc=2; else if(/#/.test(accStr)) acc=1; else if(/bb/.test(accStr)) acc=-2; else if(/b/.test(accStr)) acc=-1; }
                const oct=parseInt(m1[4]); const midi=(oct+1)*12 + baseIdx + acc; if(midi>=0 && midi<=127) return midi;
            }
            const m2 = name.match(/(?:^|[^0-9])(1[01][0-9]|12[0-7]|\d?\d)(?:[^0-9]|$)/);
            if(m2){ const n=parseInt(m2[1]||m2[0]); if(n>=0 && n<=127) return n; }
        }catch(_){ }
        return null;
    }
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ雋頑瑳・ｱ螟ｲ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ郢晢ｽｻ鬯ｮ・｣繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ雋牙私・ｽ・ｨ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ髯溷｢難ｽｹ蛹∝擠・手ｲｻ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｷ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ髴大｣ｼ驕・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髯ｷ・ｷ?繝ｻ・ｽ繝ｻ・ｽ?髫ｶ魃会ｽｽ・｢?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｶ・ｷ髢ｻ・ｸ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｨ鬮ｷ菫ｶ蜊・坿・､?繝ｻ・ｽ繝ｻ・ｽ鬯ｨ・ｾ髮懶ｽ｣?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ髯橸ｽｳ陞｢・ｽ陷托ｽｲ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｨ?繝ｻ・ｽ繝ｻ・ｽ髯具ｽｹ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    function urlWithAltExts(path){
        const seen=new Set(); const out=[]; const m=path.match(/^(.*)\.([A-Za-z0-9]+)$/);
        if(m){
            const base=m[1];
            getAltSampleExts().forEach(e=>{ const q=base+'.'+e; if(!seen.has(q)){ seen.add(q); out.push(q); } });
            if(!seen.has(path)) out.push(path); return out;
        }
        getAltSampleExts().forEach(e=>{ const q=path+'.'+e; if(!seen.has(q)){ seen.add(q); out.push(q); } });
        if(!seen.has(path)) out.push(path); return out;
    }
    for(const r of regions){
        // Windows鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ? -> URL鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ陷茨ｽｷ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?
        const normalizedSample = String(r.sample||'').replace(/\\/g,'/');
        const urls = urlWithAltExts(`${basePath}/${normalizedSample}`);
    let ab=null; for(const u of urls){ try{ const res=await fetch(u); if(res.ok){ ab=await res.arrayBuffer(); break; } }catch(_){} }
    if(!ab) continue;
    // WAV鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    const meta=readWavMeta(ab);
    const origRate= meta.sampleRate||0;
        const buf=await new Promise(res=> audioCtx.decodeAudioData(ab, b=>res(b), ()=>res(null)));
        if(!buf) continue;
        // 鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｩ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ譎｢・ｽ・ｲ?鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｯ・ｮ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｲ陝ｷ・｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ謫ｾ・ｽ・ｴ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
        let lo=r.lokey, hi=r.hikey;
        if(lo==null && hi==null){
            const rootGuess = (r.pitch_keycenter!=null? r.pitch_keycenter: inferMidiFromFilenameSimple(r.sample));
            if(rootGuess!=null){ lo=hi=rootGuess; }
        }
        if(lo==null) lo = (hi!=null? hi: 60);
        if(hi==null) hi = lo;
        lo=Math.max(0, Math.min(127, lo));
        hi=Math.max(0, Math.min(127, hi));
        if(hi<lo){ const t=lo; lo=hi; hi=t; }
        const layer = (r.hivel??127)<=50? 'pp': (r.lovel??0)>=90? 'ff': 'mf';
        const root=(r.pitch_keycenter!=null)? r.pitch_keycenter: Math.round((lo+hi)/2);
        for(let m=lo;m<=hi;m++){
            if(!map[m]) map[m]={layers:{},release:null,gains:{}};
            if(r.trigger==='release'){ map[m].release=buf; continue; }
            if(!map[m].layers[layer]){
                let loopSec;
                if(r.loop_start!=null && r.loop_end!=null){
                    loopSec={ s:(r.loop_start/(origRate||buf.sampleRate)), e:(r.loop_end/(origRate||buf.sampleRate)) };
                } else if(meta.loopStart!=null && meta.loopEnd!=null){
                    const sr=(origRate||buf.sampleRate);
                    loopSec={ s: meta.loopStart/ sr, e: meta.loopEnd/ sr };
                } else if(r.loop_mode==='loop_continuous'){
                    loopSec={ s: Math.min(0.02, Math.max(0, buf.duration*0.02)), e: Math.max(0.05, buf.duration-0.02) };
                }
                map[m].layers[layer]={ buffer:buf, root, loop: undefined, loopSec };
            }
        }
    }
    instrumentMaps[instName]=map;
    // 鬯ｮ・ｫ?繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ?闔ｨ螟ｲ・ｽ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・ｯ隶厄ｽｸ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ讖ｸ・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ蜿門ｾ・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩包ｽｶ闔ｨ竏ｬ・ｱ・ｪ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?鬮ｮ荵晢ｽ・繝ｻ・ｽ繝ｻ・ｽ繝ｻ・ｽ??繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ髫ｰ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬮｣雋ｻ・｣・ｰ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｫ・ｴ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ謨鳴郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｣郢晢ｽｻ鬮ｯ・ｷ?繝ｻ・ｽ繝ｻ・ｽ鬨ｾ雜｣・ｽ・ｯ髯ｷ闌ｨ・ｽ・ｱ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ
    if(instName==='Piano') pianoSampleMap=map;
    useSamplePiano=true; pianoSamplesLoaded=true; setPianoZipStatus(instName+' SFZ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｿ・ｽ?繝ｻ・ｽ隶夲ｽｨ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｯ貅ｷ譯・繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩幢ｽ｢隴趣ｽ｢?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ + (SELECTED_SAMPLE_PRIMARY? ' [fmt: '+SELECTED_SAMPLE_PRIMARY+']': ''));
    // 鬯ｮ・ｯ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｮ・｢?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮｣蛹・ｽｽ・ｳ髯ｷ螂・ｽｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ謳ｾ・ｽ・ｵ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬮ｮ蜈ｷ・ｿ・ｽ?繝ｻ・ｽ遶乗ｩｸ・ｿ・ｽ?繝ｻ・ｽ?繝ｻ・ｽ繝ｻ・ｽ驕ｶ謫ｾ・ｽ・ｬ髫ｲ・､陷･雜｣・ｽ・ｫ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬩搾ｽｵ?繝ｻ・ｽ繝ｻ・ｽ髯晢ｽｶ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ?郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ鬯ｩ蟷｢・ｽ・｢髫ｴ雜｣・ｽ・｢郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ郢晢ｽｻ?繝ｻ・ｽ繝ｻ・ｽ
    scheduleAll(); if(isPlaying){ pausePlayback(); startPlayback(); }
}
// EOF cleanup
