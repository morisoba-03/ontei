var St=Object.defineProperty;var Rt=(M,_,V)=>_ in M?St(M,_,{enumerable:!0,configurable:!0,writable:!0,value:V}):M[_]=V;var g=(M,_,V)=>Rt(M,typeof _!="symbol"?_+"":_,V);(function(){"use strict";function M(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}function _(o){if(this.size=o|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=o<<1;for(var t=new Array(this.size*2),e=0;e<t.length;e+=2){const c=Math.PI*e/this.size;t[e]=Math.cos(c),t[e+1]=-Math.sin(c)}this.table=t;for(var s=0,r=1;this.size>r;r<<=1)s++;this._width=s%2===0?s-1:s,this._bitrev=new Array(1<<this._width);for(var n=0;n<this._bitrev.length;n++){this._bitrev[n]=0;for(var i=0;i<this._width;i+=2){var a=this._width-i-2;this._bitrev[n]|=(n>>>i&3)<<a}}this._out=null,this._data=null,this._inv=0}var V=_;_.prototype.fromComplexArray=function(t,e){for(var s=e||new Array(t.length>>>1),r=0;r<t.length;r+=2)s[r>>>1]=t[r];return s},_.prototype.createComplexArray=function(){const t=new Array(this._csize);for(var e=0;e<t.length;e++)t[e]=0;return t},_.prototype.toComplexArray=function(t,e){for(var s=e||this.createComplexArray(),r=0;r<s.length;r+=2)s[r]=t[r>>>1],s[r+1]=0;return s},_.prototype.completeSpectrum=function(t){for(var e=this._csize,s=e>>>1,r=2;r<s;r+=2)t[e-r]=t[r],t[e-r+1]=-t[r+1]},_.prototype.transform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=0,this._transform4(),this._out=null,this._data=null},_.prototype.realTransform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=0,this._realTransform4(),this._out=null,this._data=null},_.prototype.inverseTransform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=1,this._transform4();for(var s=0;s<t.length;s++)t[s]/=this.size;this._out=null,this._data=null},_.prototype._transform4=function(){var t=this._out,e=this._csize,s=this._width,r=1<<s,n=e/r<<1,i,a,c=this._bitrev;if(n===4)for(i=0,a=0;i<e;i+=n,a++){const u=c[a];this._singleTransform2(i,u,r)}else for(i=0,a=0;i<e;i+=n,a++){const u=c[a];this._singleTransform4(i,u,r)}var h=this._inv?-1:1,l=this.table;for(r>>=2;r>=2;r>>=2){n=e/r<<1;var f=n>>>2;for(i=0;i<e;i+=n)for(var m=i+f,b=i,v=0;b<m;b+=2,v+=r){const u=b,d=u+f,p=d+f,y=p+f,w=t[u],T=t[u+1],A=t[d],F=t[d+1],B=t[p],I=t[p+1],x=t[y],z=t[y+1],S=w,R=T,C=l[v],E=h*l[v+1],q=A*C-F*E,D=A*E+F*C,J=l[2*v],L=h*l[2*v+1],Q=B*J-I*L,U=B*L+I*J,W=l[3*v],X=h*l[3*v+1],Y=x*W-z*X,Z=x*X+z*W,j=S+Q,N=R+U,P=S-Q,k=R-U,O=q+Y,$=D+Z,K=h*(q-Y),tt=h*(D-Z),rt=j+O,et=N+$,st=j-O,nt=N-$,it=P+tt,ot=k-K,at=P-tt,ct=k+K;t[u]=rt,t[u+1]=et,t[d]=it,t[d+1]=ot,t[p]=st,t[p+1]=nt,t[y]=at,t[y+1]=ct}}},_.prototype._singleTransform2=function(t,e,s){const r=this._out,n=this._data,i=n[e],a=n[e+1],c=n[e+s],h=n[e+s+1],l=i+c,f=a+h,m=i-c,b=a-h;r[t]=l,r[t+1]=f,r[t+2]=m,r[t+3]=b},_.prototype._singleTransform4=function(t,e,s){const r=this._out,n=this._data,i=this._inv?-1:1,a=s*2,c=s*3,h=n[e],l=n[e+1],f=n[e+s],m=n[e+s+1],b=n[e+a],v=n[e+a+1],u=n[e+c],d=n[e+c+1],p=h+b,y=l+v,w=h-b,T=l-v,A=f+u,F=m+d,B=i*(f-u),I=i*(m-d),x=p+A,z=y+F,S=w+I,R=T-B,C=p-A,E=y-F,q=w-I,D=T+B;r[t]=x,r[t+1]=z,r[t+2]=S,r[t+3]=R,r[t+4]=C,r[t+5]=E,r[t+6]=q,r[t+7]=D},_.prototype._realTransform4=function(){var t=this._out,e=this._csize,s=this._width,r=1<<s,n=e/r<<1,i,a,c=this._bitrev;if(n===4)for(i=0,a=0;i<e;i+=n,a++){const ht=c[a];this._singleRealTransform2(i,ht>>>1,r>>>1)}else for(i=0,a=0;i<e;i+=n,a++){const ht=c[a];this._singleRealTransform4(i,ht>>>1,r>>>1)}var h=this._inv?-1:1,l=this.table;for(r>>=2;r>=2;r>>=2){n=e/r<<1;var f=n>>>1,m=f>>>1,b=m>>>1;for(i=0;i<e;i+=n)for(var v=0,u=0;v<=b;v+=2,u+=r){var d=i+v,p=d+m,y=p+m,w=y+m,T=t[d],A=t[d+1],F=t[p],B=t[p+1],I=t[y],x=t[y+1],z=t[w],S=t[w+1],R=T,C=A,E=l[u],q=h*l[u+1],D=F*E-B*q,J=F*q+B*E,L=l[2*u],Q=h*l[2*u+1],U=I*L-x*Q,W=I*Q+x*L,X=l[3*u],Y=h*l[3*u+1],Z=z*X-S*Y,j=z*Y+S*X,N=R+U,P=C+W,k=R-U,O=C-W,$=D+Z,K=J+j,tt=h*(D-Z),rt=h*(J-j),et=N+$,st=P+K,nt=k+rt,it=O-tt;if(t[d]=et,t[d+1]=st,t[p]=nt,t[p+1]=it,v===0){var ot=N-$,at=P-K;t[y]=ot,t[y+1]=at;continue}if(v!==b){var ct=k,bt=-O,yt=N,Ft=-P,wt=-h*rt,At=-h*tt,Tt=-h*K,Bt=-h*$,It=ct+wt,Mt=bt+At,xt=yt+Bt,zt=Ft-Tt,ut=i+m-v,_t=i+f-v;t[ut]=It,t[ut+1]=Mt,t[_t]=xt,t[_t+1]=zt}}}},_.prototype._singleRealTransform2=function(t,e,s){const r=this._out,n=this._data,i=n[e],a=n[e+s],c=i+a,h=i-a;r[t]=c,r[t+1]=0,r[t+2]=h,r[t+3]=0},_.prototype._singleRealTransform4=function(t,e,s){const r=this._out,n=this._data,i=this._inv?-1:1,a=s*2,c=s*3,h=n[e],l=n[e+s],f=n[e+a],m=n[e+c],b=h+f,v=h-f,u=l+m,d=i*(l-m),p=b+u,y=v,w=-d,T=b-u,A=v,F=d;r[t]=p,r[t+1]=0,r[t+2]=y,r[t+3]=w,r[t+4]=T,r[t+5]=0,r[t+6]=A,r[t+7]=F};var vt=M(V);class G{constructor(t,e){g(this,"_inputLength");g(this,"_fft");g(this,"_bufferSupplier");g(this,"_paddedInputBuffer");g(this,"_transformBuffer");g(this,"_inverseBuffer");if(t<1)throw new Error("Input length must be at least one");this._inputLength=t,this._fft=new vt(pt(2*t)),this._bufferSupplier=e,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(t){return new G(t,e=>new Float32Array(e))}static forFloat64Array(t){return new G(t,e=>new Float64Array(e))}static forNumberArray(t){return new G(t,e=>Array(e))}get inputLength(){return this._inputLength}autocorrelate(t,e=this._bufferSupplier(t.length)){if(t.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${t.length}`);for(let r=0;r<t.length;r++)this._paddedInputBuffer[r]=t[r];for(let r=t.length;r<this._paddedInputBuffer.length;r++)this._paddedInputBuffer[r]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const s=this._transformBuffer;for(let r=0;r<s.length;r+=2)s[r]=s[r]*s[r]+s[r+1]*s[r+1],s[r+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let r=0;r<t.length;r++)e[r]=this._inverseBuffer[2*r];return e}}function mt(o){const t=[];let e=!1,s=-1/0,r=-1;for(let n=1;n<o.length-1;n++)o[n-1]<=0&&o[n]>0?(e=!0,r=n,s=o[n]):o[n-1]>0&&o[n]<=0?(e=!1,r!==-1&&t.push(r)):e&&o[n]>s&&(s=o[n],r=n);return t}function dt(o,t){const[e,s,r]=[o-1,o,o+1],[n,i,a]=[t[e],t[s],t[r]],c=n/2-i+a/2,h=-(n/2)*(s+r)+i*(e+r)-a/2*(e+s),l=n*s*r/2-i*e*r+a*e*s/2,f=-h/(2*c),m=c*f*f+h*f+l;return[f,m]}class H{constructor(t,e){g(this,"_autocorrelator");g(this,"_nsdfBuffer");g(this,"_clarityThreshold",.9);g(this,"_minVolumeAbsolute",0);g(this,"_maxInputAmplitude",1);this._autocorrelator=new G(t,e),this._nsdfBuffer=e(t)}static forFloat32Array(t){return new H(t,e=>new Float32Array(e))}static forFloat64Array(t){return new H(t,e=>new Float64Array(e))}static forNumberArray(t){return new H(t,e=>Array(e))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(t){if(!Number.isFinite(t)||t<=0||t>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=t}set minVolumeAbsolute(t){if(!Number.isFinite(t)||t<0||t>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=t}set minVolumeDecibels(t){if(!Number.isFinite(t)||t>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(t/10)}set maxInputAmplitude(t){if(!Number.isFinite(t)||t<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=t}findPitch(t,e){if(this._belowMinimumVolume(t))return[0,0];this._nsdf(t);const s=mt(this._nsdfBuffer);if(s.length===0)return[0,0];const r=Math.max(...s.map(c=>this._nsdfBuffer[c])),n=s.find(c=>this._nsdfBuffer[c]>=this._clarityThreshold*r),[i,a]=dt(n,this._nsdfBuffer);return[e/i,Math.min(a,1)]}_belowMinimumVolume(t){if(this._minVolumeAbsolute===0)return!1;let e=0;for(let s=0;s<t.length;s++)e+=t[s]**2;return Math.sqrt(e/t.length)<this._minVolumeAbsolute}_nsdf(t){this._autocorrelator.autocorrelate(t,this._nsdfBuffer);let e=2*this._nsdfBuffer[0],s;for(s=0;s<this._nsdfBuffer.length&&e>0;s++)this._nsdfBuffer[s]=2*this._nsdfBuffer[s]/e,e-=t[s]**2+t[t.length-s-1]**2;for(;s<this._nsdfBuffer.length;s++)this._nsdfBuffer[s]=0}}function pt(o){return o--,o|=o>>1,o|=o>>2,o|=o>>4,o|=o>>8,o|=o>>16,o++,o}class gt{constructor(){g(this,"detector",null);g(this,"inputLength",0);g(this,"lastStableFreq",0);g(this,"consecutiveSilence",0)}reset(){this.lastStableFreq=0,this.consecutiveSilence=0}analyze(t,e,s={viterbi:!0}){(!this.detector||this.inputLength!==t.length)&&(this.inputLength=t.length,this.detector=H.forFloat32Array(this.inputLength),this.detector.minVolumeDecibels=-60);let r=0;for(let l=0;l<t.length;l++)r+=t[l]*t[l];r=Math.sqrt(r/t.length);const n=s.minRms??.01;if(r<n)return this.consecutiveSilence++,this.consecutiveSilence>5&&(this.lastStableFreq=0),{freq:0,conf:0};this.consecutiveSilence=0;const[i,a]=this.detector.findPitch(t,e);if(a<.5||i<60||i>4200)return{freq:0,conf:0};let c=i,h=a;if(s.guideFreq&&s.guideFreq>0){const l=s.guideFreq,f=12*Math.log2(c/l),m=Math.abs(f);Math.abs(m-12)<2&&h<.98&&(f>0?c/=2:c*=2,h=Math.min(1,h*1.2))}if(this.lastStableFreq>0){const l=12*Math.log2(c/this.lastStableFreq);Math.abs(l)<1?c=this.lastStableFreq*(1-.5)+c*.5:Math.abs(Math.abs(l)-12)<1&&h<.9&&(c=this.lastStableFreq)}return this.lastStableFreq=c,{freq:c,conf:h}}}const lt=new gt;let ft=44100;self.onmessage=o=>{const{type:t,payload:e}=o.data;if(t==="init")ft=e.sampleRate;else if(t==="process"){const{buffer:s,guideFreq:r}=e,n=lt.analyze(s,ft,{viterbi:!0,guideFreq:r});self.postMessage({type:"result",payload:n})}else t==="reset"&&lt.reset()}})();
